
<!DOCTYPE html>
<html lang="zh-CN">
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
<meta HTTP-EQUIV="pragma" CONTENT="no-cache"> 
<meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate"> 
<meta HTTP-EQUIV="expires" CONTENT="0"> 
<title>Nettyæƒå¨æŒ‡å—(ä¸€) | LIKECAT</title>	

<link rel="stylesheet" href="https://q456qq520.github.io/styles/main.css">
<script type="text/javascript">
function getCSS()
{
        datetoday = new Date();
        timenow=datetoday.getTime();
        datetoday.setTime(timenow);
        thehour = datetoday.getHours();

        if (thehour<07)

            display = "https://q456qq520.github.io/media/css/night.css";

       else if (thehour>18)

            display = "https://q456qq520.github.io/media/css/night.css";   

        else if (thehour>07)
           
            display = "https://q456qq520.github.io/media/css/day.css";

        else if (thehour<18)

            display = "https://q456qq520.github.io/media/css/day.css";
      

var css = '<';
        css+='link rel="stylesheet" href='+display+' \/';
        css+='>';
        document.write(css);
}
</script>
<link href="https://fonts.googleapis.com/css?family=Dancing+Script|Noto+Sans+SC:300|Montserrat&display=swap" rel="stylesheet">
<link href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css" rel="stylesheet" />
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<script type='text/javascript' src='https://q456qq520.github.io/media/scripts/script.js'></script>
<link href="https://cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet" />
  <script src="https://cdn.bootcss.com/wow/1.1.2/wow.min.js"></script>
  <script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script>wow=new WOW({boxClass:'wow',animateClass:'animated',offset:0,mobile:true,live:true});wow.init();</script>

<script type="text/javascript">
window.onload=getCSS();
</script>


 	
</head>
<body class="post-template-default single single-post postid-70 single-format-standard">
    <div id="wrapper">
        
			
		<header id="header" class="site-header" 
		
		>
			<div class="site-branding">
									<h1 class="site-title"><a href="https://q456qq520.github.io" rel="home">LIKECAT</a></h1>
										
					<h2 class="site-description">ä¸€æ¡å°å’¸é±¼</h2>
										
							</div>
			<nav id="nav-wrapper">
				<div class="container">
					<div class="nav-toggle">
						<div class="bars">
							<div class="bar"></div>
							<div class="bar"></div>
							<div class="bar"></div>
						</div>
					</div>
					<div class="clear"></div>
					<ul id="" class="dove">
		 
     			
<li>
	 
	<a  href="/"> é¦–é¡µ</a></li>
	
    
     			
<li>
	 
	<a  href="/archives"> å½’æ¡£</a></li>
	
    
     			
<li>
	 
	<a  href="/tags"> æ ‡ç­¾</a></li>
	
    
     			
<li>
	 
	<a  href="/post/about"> å…³äº</a></li>
	
    
     			
<li>
	 
	<a  href="/post/yuan-xing-mo-shi"> è®¾è®¡æ¨¡å¼</a></li>
	
    
     			
<li>
	 
	<a  href="/fenbushi"> åˆ†å¸ƒå¼</a></li>
	
    

</ul>
</li>		
		
</ul>				</div>
			</nav>
						<div class="jingge">


    

    

    

    

    

    

    

    

    

    

    

    
        </header>

		<div id="content" class="container">
			<div class="row">
	<div class="col-md-8 site-main">
				
<article id="post-70" class="post-70 post type-post status-publish format-standard hentry category-5 tag-10 tag-9 tag-11">

	
	                      
		<div class="entry-content">
			<h1 class="wow swing entry-title">Nettyæƒå¨æŒ‡å—(ä¸€)</h1>
<div class="entry-meta">
<div class="wow bounce">
	<i class="iconfont icon-rili"> <time class="lately-a" datetime="2022-10-13 10:01:23" itemprop="datePublished" pubdate="">2022-10-13</time></i>
	          </div>
			
</span>
													 
		</div>
                  
			<div class="wow slideInLeft entry-summary song">
				<h2 id="1-javaçš„ioæ¼”è¿›ä¹‹è·¯">1. Javaçš„IOæ¼”è¿›ä¹‹è·¯</h2>
<!-- more -->
<h3 id="11-io">1.1 I/O</h3>
<h4 id="111-linuxç½‘ç»œioæ¨¡å‹">1.1.1 LINUXç½‘ç»œI/Oæ¨¡å‹</h4>
<p>Linuxçš„å†…æ ¸å°†æ‰€æœ‰å¤–éƒ¨è®¾å¤‡éƒ½çœ‹ä½œä¸€ä¸ªæ–‡ä»¶æ¥æ“ä½œï¼Œå¯¹ä¸€ä¸ªæ–‡ä»¶å¯¹è¯»å†™æ“ä½œä¼šè°ƒç”¨å†…æ ¸æä¾›å¥½çš„ç³»ç»Ÿå‘½ä»¤ï¼Œè¿”å›ä¸€ä¸ªfile descriotorï¼ˆfdï¼Œæ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚è€Œå¯¹ä¸€ä¸ªsocketçš„è¯»å†™ä¹Ÿä¼šæœ‰ç›¸åº”çš„æè¿°ç¬¦ï¼Œç§°ä¸ºsocketfdï¼Œæè¿°ç¬¦å°±æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå®ƒæŒ‡å‘å†…æ ¸ä¸­çš„ä¸€ä¸ªç»“æ„ä½“ï¼ˆæ–‡ä»¶è·¯å¾„ï¼Œæ•°æ®å»ç­‰ä¸€äº›å±æ€§ï¼‰ã€‚</p>
<p>UNIXä¸­ï¼ŒI/Oæ¨¡å‹ç§ç±»æœ‰å¦‚ä¸‹ï¼š</p>
<ol>
<li>é˜»å¡I/Oæ¨¡å‹ï¼šä¸ºæœ€å¸¸ç”¨çš„ioæ¨¡å‹ï¼Œç¼ºçœæƒ…å†µä¸‹æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½æ˜¯é˜»å¡çš„ã€‚<br>
ä»¥å¥—æ¥å­—æ¥å£ä¸ºä¾‹ï¼šåœ¨è¿›ç¨‹ç©ºé—´ä¸­è°ƒç”¨Recvfrom,å…¶ç³»ç»Ÿè°ƒç”¨ç›´åˆ°æ•°æ®åŒ…åˆ°è¾¾ä¸”è¢«å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹çš„ç¼“å†²åŒºä¸­æˆ–è€…å‘ç”Ÿé”™è¯¯æ—¶æ‰è¿”å›ï¼Œåœ¨æ­¤æœŸé—´ä¸€ç›´ä¼šç­‰å¾…ï¼Œè¿›ç¨‹åœ¨ä»è°ƒç”¨recvfromå¼€å§‹åˆ°å®ƒè¿”å›åˆ°æ•´æ®µæ—¶é—´å†…éƒ½æ˜¯è¢«é˜»å¡åˆ°ï¼Œå› æ­¤è¢«ç§°ä¸ºé˜»å¡I/Oæ¨¡å‹ã€‚</li>
</ol>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1665627501192.png" alt="" loading="lazy"></figure>
<ol start="2">
<li>éé˜»å¡I/Oæ¨¡å‹ï¼šrecvfromä»åº”ç”¨å±‚åˆ°å†…æ ¸åˆ°æ—¶å€™ï¼Œå¦‚æœè¯¥ç¼“å†²åŒºæ²¡æœ‰æ•°æ®åˆ°è¯ï¼Œå°±ç›´æ¥è¿”å›ä¸€ä¸ªEWOULDBLOCKé”™è¯¯ï¼Œä¸€èˆ¬éƒ½æ˜¯å¯¹éé˜»å¡I/Oæ¨¡å‹è¿›è¡Œè½®è¯¢æ£€æŸ¥è¿™ä¸ªçŠ¶æ€ï¼Œçœ‹å†…æ ¸æ˜¯ä¸æ˜¯æœ‰æ•°æ®åˆ°æ¥ã€‚</li>
</ol>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1665627510514.png" alt="" loading="lazy"></figure>
<ol start="3">
<li>I/Oå¤ç”¨æ¨¡å‹ï¼šLinuxæä¾›select/pollï¼Œè¿›ç¨‹é€šè¿‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªfdä¼ é€’ç»™selectæˆ–pollç³»ç»Ÿè°ƒç”¨ï¼Œé˜»å¡åœ¨selectæ“ä½œä¸Šï¼Œè¿™æ˜¯select/pollå¯ä»¥å¸®æˆ‘ä»¬ä¾¦æµ‹å¤šä¸ªfdæ˜¯å¦å¤„äºå°±ç»ªçŠ¶æ€ã€‚select/pollä¸Šé¡ºåºæ‰«æfdæ˜¯å¦å°±ç»ªï¼Œè€Œä¸”æ”¯æŒç­‰fdæ•°é‡æœ‰é™ï¼Œå› æ­¤å®ƒçš„ä½¿ç”¨å—åˆ°äº†ä¸€äº›åˆ¶çº¦ã€‚Linuxè¿˜æä¾›äº†ä¸€ä¸ªepollç³»ç»Ÿè°ƒç”¨ï¼Œepollä½¿ç”¨åŸºäºäº‹ä»¶é©±åŠ¨æ–¹å¼ä»£æ›¿é¡ºåºæ‰«æï¼Œæ€§èƒ½æ›´é«˜ã€‚å½“æœ‰fdå°±ç»ªæ—¶ï¼Œç«‹å³å›è°ƒå‡½æ•°rollbockã€‚</li>
</ol>
<figure data-type="image" tabindex="3"><img src="https://q456qq520.github.io/post-images/1665628231352.png" alt="" loading="lazy"></figure>
<ol start="4">
<li>ä¿¡å·é©±åŠ¨I/Oæ¨¡å‹ï¼šé¦–å…ˆå¼€å¯å¥—æ¥å£ä¿¡å·é©±åŠ¨I/OåŠŸèƒ½ï¼Œå¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨sigactionæ‰§è¡Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ã€‚å½“æ•°æ®å‡†å¤‡å°±ç»ªæ—¶ï¼Œå°±ä¸ºè¯¥è¿›ç¨‹ç”Ÿäº§ä¸€ä¸ªSIGIOä¿¡å·ï¼Œé€šè¿‡ä¿¡å·å›è°ƒé€šçŸ¥åº”ç”¨ç¨‹åºè°ƒç”¨recvfromæ¥è¯»å–æ•°æ®ï¼Œå¹¶é€šçŸ¥ä¸»å¾ªç¯å‡½æ•°å¤„ç†æ•°æ®ã€‚</li>
</ol>
<figure data-type="image" tabindex="4"><img src="https://q456qq520.github.io/post-images/1665628476732.png" alt="" loading="lazy"></figure>
<ol start="5">
<li>å¼‚æ­¥I/Oï¼šå‘ŠçŸ¥å†…æ ¸å¯åŠ¨æŸä¸ªæ“ä½œï¼Œå¹¶è®©å†…æ ¸åœ¨æ•´ä¸ªæ“ä½œå®Œæˆåï¼ˆåŒ…æ‹¬å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°ç”¨æˆ·ç›´æ¥åˆ°ç¼“å†²åŒºï¼‰é€šçŸ¥æˆ‘ä»¬ã€‚<br>
è¿™ç§æ¨¡å‹ä¸ä¿¡å·é©±åŠ¨æ¨¡å‹åˆ°ä¸»è¦åŒºåˆ«æ˜¯ï¼šä¿¡å·é©±åŠ¨I/Oç”±å†…æ ¸é€šçŸ¥æˆ‘ä»¬ä½•æ—¶å¼€å§‹ä¸‹ä¸€ä¸ªI/Oæ“ä½œï¼›å¼‚æ­¥I/Oæ¨¡å‹ç”±å†…æ ¸é€šçŸ¥æˆ‘ä»¬I/Oæ“ä½œä½•æ—¶å·²ç»å®Œæˆã€‚</li>
</ol>
<figure data-type="image" tabindex="5"><img src="https://q456qq520.github.io/post-images/1665628659332.png" alt="" loading="lazy"></figure>
<h4 id="112-ioå¤šè·¯å¤ç”¨æŠ€æœ¯">1.1.2 I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯</h4>
<p>åœ¨I/Oç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œå½“éœ€è¦å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯æ¥å…¥è¯·æ±‚æ—¶ï¼Œå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æˆ–è€…I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯å¤„ç†ã€‚</p>
<p>I/Oå¤šè·¯å¤ç”¨é€šè¿‡æŠŠå¤šä¸ªI/Oçš„é˜»å¡å¤ç”¨åˆ°åŒä¸€ä¸ªselectåˆ°é˜»å¡ä¸Šï¼Œä»è€Œå¯ä»¥åœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ã€‚I/Oå¤šè·¯å¤ç”¨æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯ç³»ç»Ÿå¼€é”€å°ï¼Œç³»ç»Ÿä¸éœ€è¦åˆ›å»ºæ–°çš„é¢å¤–è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œä¹Ÿä¸éœ€è¦ç»´æŠ¤è¿™äº›è¿›ç¨‹å’Œçº¿ç¨‹çš„è¿è¡Œï¼Œé™ä½ç³»ç»Ÿçš„ç»´æŠ¤å·¥ä½œé‡ï¼ŒèŠ‚çœäº†ç³»ç»Ÿèµ„æºï¼ŒI/Oå¤šè·¯å¤ç”¨ä¸»è¦åº”ç”¨åœºæ™¯ä¸ºï¼š</p>
<pre><code>- æœåŠ¡å™¨éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªå¤„äºç›‘å¬çŠ¶æ€æˆ–è€…å¤šä¸ªè¿æ¥çŠ¶æ€çš„å¥—æ¥å­—ã€‚
- æœåŠ¡å™¨éœ€è¦åŒæ—¶å¤„ç†å¤šç§ç½‘ç»œåè®®çš„å¥—æ¥å­—ã€‚
</code></pre>
<p>ç›®å‰æ”¯æŒI/Oå¤šè·¯å¤ç”¨çš„ç³»ç»Ÿè°ƒç”¨æœ‰<strong>selectã€pselectã€pollã€epoll</strong>ã€‚</p>
<p>å…¶ä¸­epollä¸ºselectçš„æ›¿ä»£ï¼Œç›¸è¾ƒäºselectï¼Œepollåšäº†å¾ˆå¤šæ”¹è¿›ï¼Œå¦‚ä¸‹ï¼š</p>
<ol>
<li>æ”¯æŒä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„socketæè¿°ç¬¦ä¸å—é™åˆ¶ï¼ˆä»…å—é™ä¸æ“ä½œç³»ç»Ÿçš„æœ€å¤§æ–‡ä»¶å¥æŸ„æ•°ï¼‰ã€‚</li>
<li>I/Oæ•ˆç‡ä¸ä¼šéšç€FDæ ‘æœ¨çš„å¢åŠ è€Œçº¿æ€§ä¸‹é™ã€‚</li>
<li>ä½¿ç”¨mmapåŠ é€Ÿå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ã€‚</li>
<li>epollçš„apiæ›´åŠ ç®€å•</li>
</ol>
<h2 id="2-nio">2. NIO</h2>
<h3 id="21-ä¼ ç»Ÿçš„bioç¼–ç¨‹">2.1 ä¼ ç»Ÿçš„BIOç¼–ç¨‹</h3>
<p>ç½‘ç»œç¼–ç¨‹çš„åŸºæœ¬æ¨¡å‹æ˜¯Client/Serveræ¨¡å‹ï¼Œä¹Ÿå°±è¡Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è¿›è¡Œç›¸äº’é€šä¿¡ï¼Œå…¶ä¸­æœåŠ¡ç«¯æä¾›ä½ç½®ä¿¡æ¯ï¼ˆip&amp;portï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¿æ¥æ“ä½œå‘æœåŠ¡ç«¯ç›‘å¬çš„åœ°å€å‘èµ·è¿æ¥è¯·æ±‚ï¼Œé€šè¿‡3æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼ŒåŒæ–¹å°±å¯ä»¥é€šè¿‡ç½‘ç»œå¥—æ¥å­—ï¼ˆsocketï¼‰è¿›è¡Œé€šä¿¡ã€‚</p>
<h4 id="211-bioé€šä¿¡æ¨¡å‹">2.1.1 BIOé€šä¿¡æ¨¡å‹</h4>
<p>BIOé€šä¿¡çš„æœåŠ¡ç«¯é€šå¸¸ç”±ä¸€ä¸ªç‹¬ç«‹çš„Acceptorçº¿ç¨‹è´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå®ƒæ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ä¹‹åä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹è¿›è¡Œé“¾è·¯å¤„ç†ï¼Œå¤„ç†å®Œæˆåé€šè¿‡è¾“å‡ºæµè¿”å›åº”ç­”ç»™å®¢æˆ·ç«¯ï¼Œçº¿ç¨‹é”€æ¯ã€‚</p>
<p>è¯¥æ¨¡å‹æœ€å¤§çš„é—®é¢˜æ˜¯ç¼ºä¹å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›ï¼Œå½“å®¢æˆ·ç«¯å¹¶å‘è®¿é—®é‡å¢åŠ åï¼ŒæœåŠ¡ç«¯çš„çº¿ç¨‹ä¸ªæ•°å’Œå®¢æˆ·ç«¯å¹¶å‘è®¿é—®æ•°å‘ˆç°1:1çš„æ­£æ¯”å…³ç³»ï¼Œå¯¼è‡´ç³»ç»Ÿçš„æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚</p>
<h3 id="22-ä¼ªå¼‚æ­¥ioç¼–ç¨‹">2.2 ä¼ªå¼‚æ­¥I/Oç¼–ç¨‹</h3>
<p>ä¸ºäº†è§£å†³åŒæ­¥é˜»å¡I/Oä¸­ä¸€ä¸ªé“¾è·¯ä¸€ä¸ªçº¿ç¨‹çš„é—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªçº¿ç¨‹æ± æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—æ¥å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ¥å…¥ï¼Œå½¢æˆå®¢æˆ·ç«¯æ•°Mï¼šçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°Nçš„æ¯”ä¾‹å…³ç³»ï¼Œå…¶ä¸­Må¯ä»¥è¿œè¿œå¤§äºNã€‚é€šè¿‡çº¿ç¨‹æ± å¯ä»¥çµæ´»çš„è°ƒé…çº¿ç¨‹èµ„æºï¼Œè®¾ç½®çº¿ç¨‹çš„æœ€å¤§å€¼ï¼Œé˜²æ­¢çº¿ç¨‹è€—å°½ã€‚</p>
<h4 id="221-ä¼ªå¼‚æ­¥ioæ¨¡å‹å›¾">2.2.1 ä¼ªå¼‚æ­¥I/Oæ¨¡å‹å›¾</h4>
<p>å½“æœ‰æ–°çš„å®¢æˆ·ç«¯æ¥å…¥æ—¶ï¼Œå°†å®¢æˆ·ç«¯çš„socketå°è£…ç§°ä¸€ä¸ªTaskæŠ•é€’åˆ°åç«¯åˆ°çº¿ç¨‹æ± ä¸­è¿›è¡Œå¤„ç†ã€‚å› ä¸ºçº¿ç¨‹æ± åˆ°èµ„æºå ç”¨æ˜¯å¯æ§çš„ï¼Œæ— è®ºå¤šå°‘ä¸ªå®¢æˆ·ç«¯å¹¶å‘è®¿é—®ä»¬éƒ½ä¸ä¼šå¯¼è‡´èµ„æºçš„è€—å°½å’Œå®•æœºã€‚</p>
<p>ä½†æ˜¯åœ¨åŒæ­¥I/Oä¸­ï¼Œå¯¹å½“å¯¹Socketå¯¹è¾“å…¥æµè¿›è¡Œè¯»å–æ“ä½œçš„æ—¶å€™ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ä¸‹å»ï¼Œç›´åˆ°å‘ç”Ÿå¦‚ä¸‹ä¸‰ç§äº‹æƒ…ï¼š</p>
<ul>
<li>1.æœ‰æ•°æ®å¯è¯»</li>
<li>2.å¯ç”¨æ•°æ®å·²ç»è¯»å–å®Œæ¯•</li>
<li>3.å‘ç”Ÿå¼‚å¸¸</li>
</ul>
<p>è¿™æ„å‘³ç€å½“å¯¹æ–¹å‘é€è¯·æ±‚æˆ–è€…åº”ç­”æ¶ˆæ¯æ¯”è¾ƒç¼“æ…¢ï¼Œæˆ–è€…ç½‘ç»œä¼ è¾“è¾ƒæ…¢æ—¶ï¼Œè¯»å–è¾“å…¥æµä¸€æ–¹å½“é€šä¿¡çº¿ç¨‹å°†è¢«é•¿æ—¶é—´é˜»å¡ï¼Œè€Œä¸”åœ¨æ­¤æœŸé—´ï¼Œå…¶ä»–æ¥å…¥æ¶ˆæ¯åªèƒ½åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚</p>
<h4 id="222-åŒæ­¥ioçš„é—®é¢˜">2.2.2 åŒæ­¥I/Oçš„é—®é¢˜</h4>
<ol>
<li>æœåŠ¡å™¨å¤„ç†ç¼“æ…¢ï¼Œè¿”å›åº”ç­”æ¶ˆæ¯è€—æ—¶ä¹Ÿç›¸åº”å˜æ…¢ã€‚</li>
<li>é‡‡ç”¨ä¼ªå¼‚æ­¥I/Oçš„çº¿ç¨‹æ­£åœ¨è¯»å–æ•…éšœæœåŠ¡èŠ‚ç‚¹çš„å“åº”ï¼Œç”±äºè¯»å–è¾“å…¥æµæ˜¯é˜»å¡çš„ï¼Œé‚£è¯¥çº¿ç¨‹ä¹ŸåŒæ­¥é˜»å¡ã€‚</li>
<li>åŠ å…¥æ‰€æœ‰çš„å¯ç”¨çº¿ç¨‹éƒ½è¢«æ•…éšœæœåŠ¡å™¨é˜»å¡ï¼Œé‚£åç»­æ‰€æœ‰çš„I/Oæ¶ˆæ¯éƒ½å°†åœ¨é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚</li>
<li>ç”±äºçº¿ç¨‹æ± é‡‡ç”¨é˜»å¡é˜Ÿåˆ—å®ç°ï¼Œå½“é˜Ÿåˆ—ç§¯æ»¡ä»¥åï¼Œåç»­å…¥é˜Ÿåˆ—çš„æ“ä½œå°†è¢«é˜»å¡ã€‚</li>
<li>ç”±äºåªæœ‰ä¸€ä¸ªAccptorçº¿ç¨‹æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå®ƒè¢«é˜»å¡åœ¨çº¿ç¨‹æ± çš„åŒæ­¥é˜»å¡é˜Ÿåˆ—ä¹‹åï¼Œæ–°çš„å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯å°†è¢«æ‹’ç»ï¼Œå®¢æˆ·ç«¯ä¼šå‘ç”Ÿå¤§é‡çš„è¿æ¥è¶…æ—¶ã€‚</li>
<li>ç”±äºå‡ ä¹æ‰€æœ‰çš„è¿æ¥éƒ½è¶…æ—¶ï¼Œè°ƒç”¨è€…ä¼šè®¤ä¸ºç³»ç»Ÿå·²ç»å´©æºƒï¼Œæ— æ³•æ¥å—æ–°çš„æ¶ˆæ¯ã€‚</li>
</ol>
<p>è¿™å‡ ä¹æ˜¯ä¸€ä¸ªé“¾å¼çš„çº§è”æ•…éšœï¼Œé‚£è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯NIOã€‚</p>
<h3 id="23-nionon-block-ioç¼–ç¨‹">2.3 NIOï¼ˆNon-block I/Oï¼‰ç¼–ç¨‹</h3>
<h4 id="231-nioç±»åº“ç®€ä»‹">2.3.1 NIOç±»åº“ç®€ä»‹</h4>
<p>é¦–å…ˆä»‹ç»ä¸€ä¸‹NIOçš„ä¸€äº›æ¦‚å¿µä¸åŠŸèƒ½ï¼š</p>
<p><strong>1. ç¼“å†²åŒºBuffer</strong></p>
<p>Bufferæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåŒ…å«ä¸€äº›è¦å†™å…¥æˆ–è€…è¦è¯»å‡ºçš„æ•°æ®ã€‚åœ¨é¢å‘æµçš„I/Oä¸­ï¼Œå¯ä»¥å°†æ•°æ®ç›´æ¥å†™å…¥æˆ–è€…å°†æ•°æ®ç›´æ¥è¯»åˆ°Streamå¯¹è±¡ä¸­ã€‚</p>
<p>åœ¨NIOåº“ä¸­ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯ç”¨ç¼“å†²åŒºå¤„ç†çš„ã€‚åœ¨è¯»å–æ•°æ®æ—¶æ˜¯ç›´æ¥æ¸ é“ç¼“å†²åŒºä¸­çš„ï¼›åœ¨å†™å…¥æ•°æ®æ—¶ä¹Ÿæ˜¯å†™å…¥åˆ°ç¼“å†²åŒºä¸­ã€‚</p>
<p>ç¼“å†²åŒºå®è´¨ä¸Šä¼¼ä¸€ä¸ªæ•°ç»„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„-ByteBufferï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ç§ç±»çš„æ•°ç»„ã€‚ä½†æ˜¯ä¸€ä¸ªç¼“å†²åŒºä¸åŠæ‚¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç¼“å†²åŒºæä¾›äº†å¯¹æ•°æ®å¯¹ç»“æ„åŒ–è®¿é—®ä»¥åŠç»´æŠ¤è¯»å†™ä½ç½®ï¼ˆlimitï¼‰ç­‰ä¿¡æ¯ã€‚</p>
<p>æœ€å¸¸ç”¨å¯¹ç¼“å†²åŒºæ˜¯BtyeBufferï¼Œä¸‹é¢æ˜¯Javaæä¾›å¯¹æ ¹æ®æ•°æ®ç±»å‹åŒºåˆ†çš„ç¼“å†²åŒºï¼š</p>
<ul>
<li>ByteBufferï¼šå­—èŠ‚ç¼“å†²åŒº</li>
<li>CharBufferï¼šå­—ç¬¦ç¼“å†²åŒº</li>
<li>ShortBufferï¼šçŸ­æ•´å‹ç¼“å†²åŒº</li>
<li>IntBufferï¼šæ•´å½¢ç¼“å†²åŒº</li>
<li>LongBufferï¼šé•¿æ•´å½¢ç¼“å†²åŒº</li>
<li>FloatBufferï¼šæµ®ç‚¹å‹ç¼“å†²åŒº</li>
<li>DoubleBufferï¼šåŒç²¾åº¦æµ®ç‚¹å‹ç¼“å†²åŒº</li>
</ul>
<p>æ¯ä¸€ä¸ªBufferç±»éƒ½æ˜¯Bufferæ¥å£çš„ä¸€ä¸ªå­å®ä¾‹ï¼Œé™¤ByteBufferå¤–æ¯ä¸€ä¸ªBufferç±»éƒ½æœ‰å®Œå…¨ä¸€æ ·çš„æ“ä½œï¼Œåªæ˜¯æ‰€å¤„ç†çš„æ•°æ®ç±»å‹ä¸ä¸€æ ·ã€‚å› ä¸ºå¤§å¤šæ•°æ ‡å‡†I/Oæ“ä½œéƒ½ä½¿ç”¨BtyeBufferï¼Œæ‰€ä»¥å®ƒå…·æœ‰ä¸€èˆ¬ç¼“å†²åŒºçš„æ“ä½œä¹‹å¤–è¿˜æä¾›äº†ä¸€äº›ç‰¹æœ‰çš„æ“ä½œï¼Œä»¥æ–¹ä¾¿ç½‘ç»œè¯»å†™ã€‚</p>
<p><strong>2. é€šé“ Channel</strong></p>
<p>Channelæ˜¯ä¸€ä¸ªé€šé“ï¼Œç½‘ç»œæ•°æ®é€šè¿‡Channelè¯»å–å’Œå†™å…¥ã€‚é€šé“ä¸æµçš„ä¸åŒä¹‹å¤„åœ¨äºé€šé“æ˜¯åŒå‘çš„ï¼Œæµåªæ˜¯åœ¨ä¸€ä¸ªæ–¹å‘ä¸Šç§»åŠ¨ï¼Œè€Œé€šè¿‡å¯ä»¥ç”¨äºè¯»ã€å†™æˆ–è€…äºŒè€…åŒæ—¶è¿›è¡Œã€‚</p>
<p>å› ä¸ºChannelæ˜¯å…¨åŒå·¥çš„ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ¯”æµæ›´å¥½åœ°æ˜ å°„åº•å±‚æ“ä½œç³»ç»Ÿçš„APIã€‚</p>
<p><strong>3. å¤šè·¯å¤ç”¨å™¨ Selector</strong></p>
<p>å¤šè·¯å¤ç”¨å™¨æä¾›é€‰æ‹©å·²ç»å°±ç»ªçš„ä»»åŠ¡çš„èƒ½åŠ›ï¼Œç®€å•æ¥è¯´å°±æ˜¯Selectorä¼šä¸æ–­åœ°è½®è¯¢æ³¨å†Œåœ¨å…¶ä¸Šçš„Channelï¼Œå¦‚æœæŸä¸ªChannelä¸Šé¢å‘ç”Ÿè¯»æˆ–è€…å†™äº‹ä»¶ï¼Œè¿™ä¸ªChannelå°±å¤„äºå°±ç»ªçŠ¶æ€ï¼Œä¼šè¢«Selectorè½®è¯¢å‡ºæ¥ï¼Œç„¶åé€šè¿‡SelectionKeyå¯ä»¥è·å–å°±ç»ªChannelçš„é›†åˆï¼Œè¿›è¡Œåç»­çš„I/Oæ“ä½œã€‚</p>
<p>ä¸€ä¸ªå¤šè·¯å¤ç”¨å™¨Selectorå¯ä»¥åŒæ—¶è½®è¯¢å¤šä¸ªChannelï¼Œè€Œä¸”å› ä¸ºJdkä½¿ç”¨çš„æ˜¯epollï¼ˆï¼‰ä»£æ›¿selectï¼Œå¹¶æ²¡æœ‰æœ€å¤§è¿æ¥å¥æŸ„çš„é™åˆ¶ã€‚</p>
<h4 id="232-nioæœåŠ¡ç«¯">2.3.2 NIOæœåŠ¡ç«¯</h4>
<figure data-type="image" tabindex="6"><img src="https://q456qq520.github.io/post-images/1665650232697.png" alt="NIOæœåŠ¡ç«¯æ—¶åºå›¾" loading="lazy"></figure>
<p>Step 1ï¼šæ‰“å¼€ServerSocketChannelï¼Œç”¨äºç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå®ƒæ˜¯æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥çš„çˆ¶ç®¡é“ã€‚<br>
Step 2ï¼šç»‘å®šç›‘å¬ç«¯å£ï¼Œè®¾ç½®è¿æ¥ä¸ºéé˜»å¡æ¨¡å¼ã€‚<br>
Step 3ï¼šåˆ›å»ºReactorçº¿ç¨‹ï¼Œåˆ›å»ºå¤šè·¯å¤ç”¨å™¨å¹¶å¯åŠ¨çº¿ç¨‹ã€‚<br>
Step 4ï¼šå°†ServerSocketChannelæ³¨å†Œåˆ°Reactorçº¿ç¨‹çš„å¤šè·¯å¤ç”¨å™¨Selectorä¸Šï¼Œæ£€æŸ¥ACCEPTäº‹ä»¶ã€‚<br>
Step 5ï¼šå¤šè·¯å¤ç”¨å™¨åœ¨çº¿ç¨‹runæ–¹æ³•çš„æ— é™å¾ªç¯ä½“å†…è½®è¯¢å‡†å¤‡å°±ç»ªçš„key<br>
Step 6ï¼šå¤šè·¯å¤ç”¨å™¨ç›‘å¬åˆ°æœ‰æ–°åˆ°å®¢æˆ·ç«¯æ¥å…¥ï¼Œå¤„ç†æ–°åˆ°æ¥å…¥è¯·æ±‚ï¼Œå®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå»ºç«‹ç‰©ç†é“¾è·¯ã€‚<br>
Step 7ï¼šè®¾ç½®å®¢æˆ·ç«¯é“¾è·¯ä¸ºéé˜»å¡æ¨¡å¼<br>
Step 8ï¼šå°†æ–°æ¥å…¥åˆ°åº“æŠ¤çŸ­æ³¨å†Œåˆ°Reactorçº¿ç¨‹åˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œç›‘å¬è¯»æ“ä½œï¼Œè¯»å–å®¢æˆ·ç«¯å‘é€åˆ°ç½‘ç»œæ¶ˆæ¯ã€‚<br>
Step 9ï¼šå¼‚æ­¥è¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯åˆ°ç¼“å†²åŒºã€‚<br>
Step 10ï¼šå¯¹ByteBufferè¿›è¡Œç¼–è§£ç ï¼Œå¦‚æœæœ‰åŠåŒ…æ¶ˆæ¯æŒ‡é’ˆresetï¼Œç»§ç»­è¯»å–åç»­å¯¹è±¹çº¹ï¼Œå°†è§£ç æˆåŠŸå¯¹æ¶ˆæ¯å°è£…æˆtaskï¼ŒæŠ•é€’åˆ°ä¸šåŠ¡çº¿ç¨‹æ± ä¸­è¿›è¡Œä¸šåŠ¡é€»è¾‘ã€‚<br>
Step 11ï¼šå°†POJOå¯¹è±¡encodeæˆByteBufferï¼Œè°ƒç”¨SocketChannelåˆ°å¼‚æ­¥writeæ¥å£ï¼Œå°†æ¶ˆæ¯å¼‚æ­¥å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>âš ï¸æ³¨æ„ï¼šå¦‚æœå‘é€åŒºTcpç¼“å†²åŒºæ»¡ï¼Œä¼šå¯¼è‡´å†™åŠåŒ…ï¼Œæ­¤æ—¶éœ€è¦æ³¨å†Œç›‘å¬å†™æ“ä½œä½ï¼Œå¾ªç¯å†™ç›´åˆ°æ•´åŒ…æ¶ˆæ¯å†™å…¥ç¼“å†²åŒºã€‚</p>
<h4 id="233-nioå®¢æˆ·ç«¯">2.3.3 NIOå®¢æˆ·ç«¯</h4>
<figure data-type="image" tabindex="7"><img src="https://q456qq520.github.io/post-images/1665655179085.png" alt="NIOå®¢æˆ·ç«¯" loading="lazy"></figure>
<p>Step 1ï¼šæ‰“å¼€ServerSocketChannelï¼Œç»‘å®šå®¢æˆ·ç«¯æœ¬åœ°åœ°å€ã€‚<br>
Step 2ï¼šè®¾ç½®SocketChannelä¸ºéé˜»å¡æ¨¡å¼ï¼ŒåŒæ—¶è®¾ç½®å®¢æˆ·ç«¯è¿æ¥çš„Tcpå‚æ•°ã€‚<br>
Step 3ï¼šå¼‚æ­¥è¿æ¥æœåŠ¡ç«¯ã€‚<br>
Step 4ï¼šåˆ¤æ–­æ˜¯å¦è¿æ¥æˆåŠŸï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥æ³¨å†Œè¯»çŠ¶æ€åˆ°å¤šè·¯å¤ç”¨å™¨ä¸­ã€‚<br>
Step 5ï¼šå‘Reactorçº¿ç¨‹çš„å¤šè·¯å¤ç”¨å™¨æ³¨å†ŒOP_CONNECTçŠ¶æ€ä½ï¼Œç›‘å¬æœåŠ¡ç«¯çš„TCP ACkåº”ç­”ã€‚<br>
Step 6ï¼šåˆ›å»ºReactorçº¿ç¨‹ï¼Œåˆ›å»ºå¤šè·¯å¤ç”¨å™¨å¹¶å¯åŠ¨çº¿ç¨‹ã€‚<br>
Step 7ï¼šå¤šè·¯å¤ç”¨å™¨åœ¨çº¿ç¨‹runæ–¹æ³•çš„æ— é™å¾ªç¯ä½“å†…è½®è¯¢å‡†å¤‡å°±ç»ªçš„keyã€‚<br>
Step 8ï¼šæ¥æ”¶connectäº‹ä»¶è¿›è¡Œå¤„ç†ã€‚<br>
Step 9ï¼šåˆ¤æ–­è¿æ¥ç»“æœï¼Œå¦‚æœæˆåŠŸæ³¨å†Œè¯»æ—¶é—´åˆ°å¤šè·¯å¤ç”¨å™¨ã€‚<br>
Step 10ï¼šæ³¨å†Œè¯»äº‹ä»¶åˆ°å¤šè·¯å¤ç”¨å™¨ã€‚<br>
Step 11ï¼šå¼‚æ­¥è¯»å®¢æˆ·ç«¯è¯·æ±‚åˆ°ç¼“å†²åŒºã€‚<br>
Step 10ï¼šå¯¹ByteBufferè¿›è¡Œç¼–è§£ç ï¼Œå¦‚æœæœ‰åŠåŒ…æ¶ˆæ¯æŒ‡é’ˆresetï¼Œç»§ç»­è¯»å–åç»­å¯¹è±¹çº¹ï¼Œå°†è§£ç æˆåŠŸå¯¹æ¶ˆæ¯å°è£…æˆtaskï¼ŒæŠ•é€’åˆ°ä¸šåŠ¡çº¿ç¨‹æ± ä¸­è¿›è¡Œä¸šåŠ¡é€»è¾‘ã€‚<br>
Step 11ï¼šå°†POJOå¯¹è±¡encodeæˆByteBufferï¼Œè°ƒç”¨SocketChannelåˆ°å¼‚æ­¥writeæ¥å£ï¼Œå°†æ¶ˆæ¯å¼‚æ­¥å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æ€»ç»“ï¼š<br>
1ï¼‰å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œå¯ä»¥é€šè¿‡å¤šè·¯å¤ç”¨å™¨æ³¨å†ŒOP_CONNECTç­‰å¸¦åç»­ç»“æœï¼Œä¸éœ€è¦åƒä¹‹å‰ä¸€æ ·è¢«åŒæ­¥é˜»å¡ã€‚<br>
2ï¼‰SocketChannelçš„è¯»å†™æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœæ²¡æœ‰å¯è¯»å†™çš„æ•°æ®å®ƒä¸ä¼šåŒæ­¥ç­‰å¾…ï¼Œç›´æ¥è¿”å›ã€‚è¿™æ ·I/Oé€šä¿¡çº¿ç¨‹å°±å¯ä»¥å¤„ç†å…¶ä»–çš„é“¾è·¯æ— éœ€åŒæ­¥ç­‰å¾…ã€‚<br>
3ï¼‰çº¿ç¨‹æ¨¡å‹çš„ä¼˜åŒ–ï¼šæ²¡æœ‰è¿æ¥å¥æŸ„æ•°</p>
<h3 id="24-aioæ–°å¼‚æ­¥éé˜»å¡ioç¼–ç¨‹">2.4 AIOï¼ˆæ–°å¼‚æ­¥éé˜»å¡IOï¼‰ç¼–ç¨‹</h3>
<p>AIOä¸ºUNIXç½‘ç»œç¼–ç¨‹ä¸­çš„äº‹ä»¶é©±åŠ¨I/Oï¼Œå®ƒä¸éœ€è¦å¤šè·¯å¤ç”¨å™¨å¯¹æ³¨å†Œå¯¹é€šé“è¿›è¡Œè½®è¯¢æ“ä½œå³å¯å®ç°å¼‚æ­¥è¯»å†™ï¼Œä»è€Œç®€åŒ–NIOå¯¹ç¼–ç¨‹æ¨¡å‹ã€‚</p>
<h3 id="25-4ç§ioçš„å¯¹æ¯”">2.5 4ç§I/Oçš„å¯¹æ¯”</h3>
<h4 id="251-ä¸åŒioæ¨¡å‹å¯¹æ¯”">2.5.1 ä¸åŒI/Oæ¨¡å‹å¯¹æ¯”</h4>
<table>
<thead>
<tr>
<th>-</th>
<th style="text-align:center">åŒæ­¥é˜»å¡I/Oï¼ˆBIOï¼‰</th>
<th style="text-align:right">ä¼ªå¼‚æ­¥I/O</th>
<th style="text-align:right">éé˜»å¡I/Oï¼ˆNIOï¼‰</th>
<th style="text-align:right">å¼‚æ­¥I/Oï¼ˆAIOï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®¢æˆ·ç«¯ä¸ªæ•°ï¼šI/Oçº¿ç¨‹</td>
<td style="text-align:center">1:1</td>
<td style="text-align:right">Mï¼šN</td>
<td style="text-align:right">Mï¼š1</td>
<td style="text-align:right">Mï¼š0ï¼ˆä¸éœ€è¦å¯åŠ¨é¢å¤–çš„I/Oçº¿ç¨‹ï¼Œè¢«åŠ¨å›è°ƒï¼‰</td>
</tr>
<tr>
<td>I/Oç±»å‹</td>
<td style="text-align:center">é˜»å¡I/O</td>
<td style="text-align:right">é˜»å¡I/O</td>
<td style="text-align:right">éé˜»å¡I/O</td>
<td style="text-align:right">éé˜»å¡I/O</td>
</tr>
<tr>
<td>I/Oç±»å‹ï¼ˆåŒæ­¥ï¼‰</td>
<td style="text-align:center">åŒæ­¥I/O</td>
<td style="text-align:right">åŒæ­¥I/O</td>
<td style="text-align:right">åŒæ­¥I/Oï¼ˆI/Oå¤šè·¯å¤ç”¨ï¼‰</td>
<td style="text-align:right">å¼‚æ­¥I/O</td>
</tr>
<tr>
<td>å¯é æ€§</td>
<td style="text-align:center">éå¸¸å·®</td>
<td style="text-align:right">å·®</td>
<td style="text-align:right">é«˜</td>
<td style="text-align:right">é«˜</td>
</tr>
<tr>
<td>ååé‡</td>
<td style="text-align:center">ä½</td>
<td style="text-align:right">ä¸­</td>
<td style="text-align:right">é«˜</td>
<td style="text-align:right">é«˜</td>
</tr>
</tbody>
</table>
<h2 id="3-nettyå…¥é—¨">3 Nettyå…¥é—¨</h2>
<h3 id="31-nettyæœåŠ¡ç«¯å¼€å‘">3.1 NettyæœåŠ¡ç«¯å¼€å‘</h3>
<p>ğŸ ä¾‹å­ï¼š</p>
<blockquote>
<p>æœåŠ¡ç«¯</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;

/**
 * æœåŠ¡ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:21
 */
public class TimeServer {

    public void bind(int port){
        //é…ç½®æœåŠ¡ç«¯nioçº¿ç¨‹ç»„,å¤„ç†ç½‘ç»œäº‹ä»¶
        EventLoopGroup boosGroup = new NioEventLoopGroup();//ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();//ç”¨äºè¿›è¡ŒSocketChannelç½‘ç»œè¯»å†™

        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 1024)
                    .childHandler(new ChildChannelHandler());

            //ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            //ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
            //é€€å‡º
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            boosGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    private class ChildChannelHandler extends ChannelInitializer&lt;SocketChannel&gt; {

        @Override
        protected void initChannel(SocketChannel socketChannel) throws Exception {
            socketChannel.pipeline().addLast(new TimeServerHandler());
        }
    }

    public static void main(String[] args) {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new TimeServer().bind(port);
    }
}
</code></pre>
<blockquote>
<p>æœåŠ¡ç«¯å…·ä½“æ“ä½œç±»</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerAdapter;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

import java.io.UnsupportedEncodingException;
import java.util.Date;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class TimeServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
        ByteBuf byteBuf = (ByteBuf) msg;

        byte[] req = new byte[byteBuf.readableBytes()];
        byteBuf.readBytes(req);

        String body = new String(req, &quot;UTF-8&quot;);
        System.out.println(&quot;The time server receive order :&quot; + body);

        String currentTime = &quot;QUERY TIME ORDER&quot;.equalsIgnoreCase(body) ? new Date(System.currentTimeMillis()).toString() : &quot;BAD ORDER&quot;;
        ByteBuf resp = Unpooled.copiedBuffer(currentTime.getBytes());

        //ä¸ºäº†æ•ˆç‡ï¼Œwriteå¹¶ä¸ç›´æ¥å°†æ¶ˆæ¯å†™å…¥åˆ°SocketChannelä¸­ï¼Œè°ƒç”¨writeæ–¹æ³•åªæ˜¯æŠŠå¾…å‘é€çš„æ¶ˆæ¯
        //æ”¾åˆ°å‘é€ç¼“å†²æ•°ç»„ä¸­ï¼Œå†è°ƒç”¨flushå‘é€
        ctx.write(resp);
        System.out.println(&quot;å†™å…¥å®Œæˆ&quot;);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        //å°†æ¶ˆæ¯å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å†™åˆ°SocketChannelä¸­å‘é€ç»™å¯¹æ–¹
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}
</code></pre>
<h3 id="32-nettyå®¢æˆ·ç«¯å¼€å‘">3.2 Nettyå®¢æˆ·ç«¯å¼€å‘</h3>
<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;

/**
 * å®¢æˆ·ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:06
 */
public class TimeClient {

    public void connect(int port ,String host) throws Exception {

        //é…ç½®nioçº¿ç¨‹ç»„
        EventLoopGroup group = new NioEventLoopGroup();

        try{
            Bootstrap b = new Bootstrap();
            b.group(group).channel(NioSocketChannel.class)
                    .option(ChannelOption.TCP_NODELAY, true)
                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            socketChannel.pipeline().addLast(new TimeClientHandler());
                        }
                    });

            //å‘èµ·å¼‚æ­¥è¿æ¥æ“ä½œ
            ChannelFuture f = b.connect(host, port).sync();
            //ç­‰å¾…å®¢æˆ·ç«¯é“¾è·¯å…³é—­
            f.channel().closeFuture().sync();
            //ä¼˜é›…é€€å‡ºï¼Œé‡Šæ”¾NIOçº¿ç¨‹ç»„
        }finally {
            group.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new TimeClient().connect(port,&quot;127.0.0.1&quot;);
    }
}
</code></pre>
<blockquote>
<p>å®¢æˆ·ç«¯å…·ä½“æ“ä½œç±»</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;


/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:09
 */
public class TimeClientHandler extends ChannelInboundHandlerAdapter {

    private final ByteBuf firstMessage;

    public TimeClientHandler() {
        byte[] req = &quot;QUERY TIME ORDER&quot;.getBytes();
        firstMessage = Unpooled.buffer(req.length);
        firstMessage.writeBytes(req);
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        ctx.writeAndFlush(firstMessage);
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception{
        ByteBuf byteBuf = (ByteBuf) msg;

        byte[] req = new byte[byteBuf.readableBytes()];
        byteBuf.readBytes(req);

        String body = new String(req, &quot;UTF-8&quot;);
        System.out.println(&quot;Now is :&quot; + body);

    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        System.out.println(&quot;é‡Šæ”¾èµ„æº&quot;);
        ctx.close();
    }
}
</code></pre>
<p>å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹TCPé“¾è·¯æˆåŠŸåï¼ŒNettyç«¯NIOçº¿ç¨‹ä¼šè°ƒç”¨channelActiveæ–¹æ³•ï¼Œå‘é€æŸ¥è¯¢æ—¶é—´ç«¯æŒ‡ä»¤ç»™æœåŠ¡ç«¯ï¼Œè°ƒç”¨writeAndFlushæ–¹æ³•å°†è¯·æ±‚æ¶ˆæ¯å‘é€ç»™æœåŠ¡ç«¯ã€‚</p>
<p>å½“æœåŠ¡ç«¯è¿”å›åº”ç­”æ¶ˆæ¯æ—¶ï¼ŒchannelReadæ–¹æ³•è¢«è°ƒç”¨ã€‚</p>
<h3 id="33-è¿è¡Œ">3.3 è¿è¡Œ</h3>
<blockquote>
<p>æ‰§è¡Œç»“æœ -&gt; æœåŠ¡ç«¯</p>
</blockquote>
<pre><code class="language-java">The time server receive order :QUERY TIME ORDER
å†™å…¥å®Œæˆ
</code></pre>
<blockquote>
<p>æ‰§è¡Œç»“æœ -&gt; å®¢æˆ·ç«¯</p>
</blockquote>
<pre><code class="language-java">Now is :Mon Oct 17 11:25:40 CST 2022
</code></pre>
<h2 id="4-tcpç²˜åŒ…æ‹†åŒ…é—®é¢˜">4 TCPç²˜åŒ…/æ‹†åŒ…é—®é¢˜</h2>
<h3 id="41-tcpç²˜åŒ…æ‹†åŒ…">4.1 TCPç²˜åŒ…/æ‹†åŒ…</h3>
<p>TCPæ˜¯ä¸ªâ€œæµâ€˜åè®®ï¼Œæ‰€è°“æµï¼Œå°±æ˜¯æ²¡æœ‰ç•Œé™çš„ä¸€ä¸²æ•°æ®ã€‚ä¸€ä¸ªå®Œæ•´çš„åŒ…å¯èƒ½ä¼šè¢«TCPæ‹†åˆ†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ï¼Œä¹Ÿæœ‰å¯èƒ½æŠŠå¤šä¸ªå°çš„åŒ…å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€ã€‚</p>
<h4 id="411-tcpç²˜åŒ…æ‹†åŒ…é—®é¢˜è¯´æ˜">4.1.1 TCPç²˜åŒ…/æ‹†åŒ…é—®é¢˜è¯´æ˜</h4>
<figure data-type="image" tabindex="8"><img src="https://q456qq520.github.io/post-images/1665978556282.png" alt="TCPç²˜åŒ…/æ‹†åŒ…" loading="lazy"></figure>
<p>TCPç²˜åŒ…/æ‹†åŒ…å…·ä½“åˆ†æå¦‚ä¸Šå›¾ï¼Œå‡è®¾å®¢æˆ·ç«¯åˆ†åˆ«å‘é€äº†2ä¸ªæ•°æ®åŒ…D1å’ŒD2ç»™æœåŠ¡ç«¯ï¼Œç”±äºæœåŠ¡ç«¯ä¸€æ¬¡è¯»å–åˆ°åˆ°å­—èŠ‚æ•°æ˜¯ä¸ç¡®å®šçš„ï¼Œæ•…å¯èƒ½å­˜åœ¨ä»¥ä¸‹4ç§æƒ…å†µã€‚</p>
<ol>
<li>æœåŠ¡ç«¯åˆ†2æ­¤è¯»å–åˆ°äº†2ä¸ªç‹¬ç«‹çš„æ•°æ®åŒ…ï¼Œåˆ†åˆ«æ˜¯D1å’ŒD2ï¼Œæ²¡æœ‰ç²˜åŒ…ï¼Œæ‹†åŒ…ã€‚</li>
<li>æœåŠ¡ç‚¹ä¸€æ¬¡æ¥æ”¶åˆ°äº†2ä¸ªæ•°æ®åŒ…ï¼ŒD1å’ŒD2ç²˜åˆåœ¨ä¸€èµ·ï¼Œè¢«ç§°ä¸ºTCPç²˜åŒ…ã€‚</li>
<li>æœåŠ¡ç‚¹åˆ†2æ¬¡è¯»å–åˆ°äº†2ä¸ªæ•°æ®åŒ…ï¼Œä¸€æ¬¡è¯»å–åˆ°äº†å®Œæ•´çš„D1å’ŒD2åŒ…çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼Œç¬¬äºŒæ¬¡è¯»å–åˆ°äº†D2åŒ…åˆ°å‰©ä½™å†…å®¹ï¼Œè¢«ç§°ä¸ºTCPæ‹†åŒ…ã€‚</li>
<li>æœåŠ¡ç«¯åˆ†2æ¬¡è¯»å–é“ç†2ä¸ªæ•°æ®åŒ…ï¼Œç¬¬ä¸€æ¬¡è¯»å–åˆ°äº†D1åŒ…çš„éƒ¨åˆ†å†…å®¹D1-1ï¼Œç¬¬äºŒæ¬¡è¯»å–åˆ°äº†D1åŒ…çš„å‰©ä½™å†…å®¹D1-2å’ŒD2åŒ…çš„æ•´åŒ…ã€‚</li>
</ol>
<p>å¦‚æœæ­¤æ—¶æœåŠ¡ç«¯TCPæ¥å—æ»‘çª—éå¸¸å°ï¼Œè€Œæ•°æ®åŒ…D1å’ŒD2æ¯”è¾ƒå¤§ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‘ç”Ÿç¬¬äº”ç§å¯èƒ½ï¼Œå³æœåŠ¡ç«¯åˆ†å¤šæ¬¡æ¬¡æ‰èƒ½å°†D1å’ŒD2åŒ…æ¥æ”¶å®Œå…¨ï¼ŒæœŸé—´å‘é€å¤šæ¬¡æ‹†åŒ…ã€‚</p>
<h4 id="412-tcpç²˜åŒ…æ‹†åŒ…å‘ç”Ÿçš„åŸå› ">4.1.2 TCPç²˜åŒ…/æ‹†åŒ…å‘ç”Ÿçš„åŸå› </h4>
<ol>
<li>åº”ç”¨ç¨‹åºwriteå†™å…¥çš„å­—èŠ‚å¤§å°å¤§äºå¥—æ¥å£å‘é€ç¼“å†²åŒºå¤§å°</li>
<li>è¿›è¡ŒMSSå¤§å°çš„TCPåˆ†æ®µ</li>
<li>ä»¥å¤ªç½‘å¸§çš„payloadå¤§äºMTUè¿›è¡ŒIPåˆ†ç‰‡</li>
</ol>
<h4 id="413-ç²˜åŒ…é—®é¢˜çš„è§£å†³ç­–ç•¥">4.1.3 ç²˜åŒ…é—®é¢˜çš„è§£å†³ç­–ç•¥</h4>
<p>TCPæ— æ³•ç†è§£ä¸Šå±‚ä¸šåŠ¡é€»è¾‘ï¼Œåªèƒ½é€šè¿‡ä¸Šå±‚åº”ç”¨åè®®æ ˆè®¾è®¡æ¥è§£å†³ï¼Œå¦‚ä¸‹ï¼š</p>
<ol>
<li>æ¶ˆæ¯å®šé•¿</li>
<li>åœ¨åŒ…å°¾å¢åŠ å›è½¦æ¢è¡Œç¬¦è¿›è¡Œåˆ†å‰²</li>
<li>å°†æ¶ˆæ¯åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯å¤´ä¸­åŒ…å«è¡¨ç¤ºæ¶ˆæ¯æ€»é•¿åº¦çš„å­—æ®µ</li>
<li>æ›´å¯Œåœ¨çš„åº”ç”¨å±‚åè®®</li>
</ol>
<p>æ¥ä¸‹æ¥çœ‹Nettyå¦‚æœè§£å†³TCPç²˜åŒ…/æ‹†åŒ…é—®é¢˜</p>
<h3 id="42-æœªè€ƒè™‘tcpç²˜åŒ…æ¡ˆä¾‹">4.2 æœªè€ƒè™‘TCPç²˜åŒ…æ¡ˆä¾‹</h3>
<h4 id="421-timeserveræ”¹é€ ">4.2.1 TimeServeræ”¹é€ </h4>
<p>æˆ‘ä»¬ç”¨ä¸Šé¢çš„ä¾‹å­å¤åˆ»ä¸€ä¸‹ç²˜åŒ…åœºæ™¯ã€‚</p>
<blockquote>
<p>TimeServerHandleræ”¹é€ </p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

import java.util.Date;

/**
 * ç²˜åŒ…
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class TimeServerApHandler extends ChannelInboundHandlerAdapter {

    private int counter;

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
        ByteBuf byteBuf = (ByteBuf) msg;

        byte[] req = new byte[byteBuf.readableBytes()];
        byteBuf.readBytes(req);

        String body = new String(req, &quot;UTF-8&quot;).substring(0,req.length - System.getProperty(&quot;line.separator&quot;).length());
        //æ¯è¯»åˆ°ä¸€æ¡æ¶ˆæ¯åå°±è®°ä¸€æ¬¡æ•°ï¼Œç„¶åå‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
        //æŒ‰ç…§è®¾è®¡ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ€»æ•°åº”è¯¥äºå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯æ€»æ•°ç›¸åŒ
        System.out.println(&quot;The time server receive order :&quot; + body + &quot;; the counter is : &quot; + ++counter);

        String currentTime = &quot;QUERY TIME ORDER&quot;.equalsIgnoreCase(body) ? new Date(System.currentTimeMillis()).toString() : &quot;BAD ORDER&quot;;

        currentTime = currentTime + System.getProperty(&quot;line.separator&quot;);
        ByteBuf resp = Unpooled.copiedBuffer(currentTime.getBytes());

        //ä¸ºäº†æ•ˆç‡ï¼Œwriteå¹¶ä¸ç›´æ¥å°†æ¶ˆæ¯å†™å…¥åˆ°SocketChannelä¸­ï¼Œè°ƒç”¨writeæ–¹æ³•åªæ˜¯æŠŠå¾…å‘é€çš„æ¶ˆæ¯
        //æ”¾åˆ°å‘é€ç¼“å†²æ•°ç»„ä¸­ï¼Œå†è°ƒç”¨flushå‘é€
        ctx.write(resp);
        System.out.println(&quot;å†™å…¥å®Œæˆ&quot;);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        //å°†æ¶ˆæ¯å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å†™åˆ°SocketChannelä¸­å‘é€ç»™å¯¹æ–¹
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}
</code></pre>
<h4 id="422-timeclienthandleræ”¹é€ ">4.2.2 TimeClientHandleræ”¹é€ </h4>
<blockquote>
<p>TimeClientHandleræ”¹é€ </p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;


/**
 * å®¢æˆ·ç«¯ç²˜åŒ…
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:09
 */
public class TimeClientApHandler extends ChannelInboundHandlerAdapter {

//    private final ByteBuf firstMessage;
    private int counter;
    private byte[] req;

    public TimeClientApHandler() {
       req = ( &quot;QUERY TIME ORDER&quot; + System.getProperty(&quot;line.separator&quot;) ).getBytes();
//        firstMessage = Unpooled.buffer(req.length);
//        firstMessage.writeBytes(req);
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx){
        ByteBuf message = null;
        for (int i = 0; i &lt; 100; i++) {
            message = Unpooled.buffer(req.length);
            message.writeBytes(req);
            ctx.writeAndFlush(message);
        }
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception{
        ByteBuf byteBuf = (ByteBuf) msg;

        byte[] req = new byte[byteBuf.readableBytes()];
        byteBuf.readBytes(req);

        String body = new String(req, &quot;UTF-8&quot;);
        System.out.println(&quot;Now is :&quot; + body + &quot;; the counter is :&quot; + ++counter);

    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        System.out.println(&quot;é‡Šæ”¾èµ„æº&quot;);
        ctx.close();
    }
}
</code></pre>
<h4 id="423-è¿è¡Œ">4.2.3 è¿è¡Œ</h4>
<blockquote>
<p>æ‰§è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">QUERY TIME ORDER; the counter is : 18

Now is :BAD ORDER
; the counter is :1
</code></pre>
<p>æœåŠ¡ç«¯è¿è¡Œç»“æœè¡¨æ˜ä»–æ²¡æœ‰æ¥æ”¶åˆ°100æ¡æ¶ˆæ¯ï¼Œè¯´æ˜å‘ç”Ÿäº†TCPç²˜åŒ…ã€‚</p>
<p>å®¢æˆ·ç«¯åº”è¯¥æ¥æ”¶åˆ°100æ¡å½“å‰æ—¶é—´åˆ°æ¶ˆæ¯ï¼Œä½†å®é™…ä¸Šåªæ¥æ”¶åˆ°äº†1æ¡ï¼Œè¯´æ˜æœåŠ¡ç«¯è¿”å›åº”ç­”æ¶ˆæ¯ä¹Ÿå‘ç”Ÿäº†ç²˜åŒ…ã€‚</p>
<p>å½“TCPç²˜åŒ…æ—¶ï¼Œæˆ‘ä»¬åˆ°ç¨‹åºå°±ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<h3 id="43-åˆ©ç”¨linebasedframedecoderè§£å†³tcpç²˜åŒ…é—®é¢˜">4.3 åˆ©ç”¨LineBasedFrameDecoderè§£å†³TCPç²˜åŒ…é—®é¢˜</h3>
<h4 id="431-æ”¯æŒtcpç²˜åŒ…çš„timeserver">4.3.1 æ”¯æŒTCPç²˜åŒ…çš„TimeServer</h4>
<p>Nettyé»˜è®¤æä¾›äº†å¤šç§ç¼–è§£ç å™¨ç”¨äºå¤„ç†åŠåŒ…é—®é¢˜ã€‚</p>
<blockquote>
<p>TimeServer</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.LineBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * æœåŠ¡ç«¯ï¼ˆæ”¯æŒç²˜åŒ…ï¼‰
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:21
 */
public class TimeApServer {

    public void bind(int port){
        //é…ç½®æœåŠ¡ç«¯nioçº¿ç¨‹ç»„,å¤„ç†ç½‘ç»œäº‹ä»¶
        EventLoopGroup boosGroup = new NioEventLoopGroup();//ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();//ç”¨äºè¿›è¡ŒSocketChannelç½‘ç»œè¯»å†™

        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 1024)
                    .childHandler(new ChildChannelHandler());

            //ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            //ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
            //é€€å‡º
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            boosGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    private class ChildChannelHandler extends ChannelInitializer&lt;SocketChannel&gt; {

        @Override
        protected void initChannel(SocketChannel socketChannel) throws Exception {
            socketChannel.pipeline().addLast(new LineBasedFrameDecoder(1024));
            socketChannel.pipeline().addLast(new StringDecoder());
            socketChannel.pipeline().addLast(new TimeServerApHandler());
        }
    }

    public static void main(String[] args) {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new TimeApServer().bind(port);
    }
}

</code></pre>
<blockquote>
<p>TimeServerApHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

import java.util.Date;

/**
 * ç²˜åŒ…
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class TimeServerApHandler extends ChannelInboundHandlerAdapter {

    private int counter;

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
        String body = (String) msg;
        //æ¯è¯»åˆ°ä¸€æ¡æ¶ˆæ¯åå°±è®°ä¸€æ¬¡æ•°ï¼Œç„¶åå‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
        //æŒ‰ç…§è®¾è®¡ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ€»æ•°åº”è¯¥äºå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯æ€»æ•°ç›¸åŒ
        System.out.println(&quot;The time server receive order :&quot; + body + &quot;; the counter is : &quot; + ++counter);

        String currentTime = &quot;QUERY TIME ORDER&quot;.equalsIgnoreCase(body) ? new Date(System.currentTimeMillis()).toString() : &quot;BAD ORDER&quot;;

        currentTime = currentTime + System.getProperty(&quot;line.separator&quot;);
        ByteBuf resp = Unpooled.copiedBuffer(currentTime.getBytes());

        //ä¸ºäº†æ•ˆç‡ï¼Œwriteå¹¶ä¸ç›´æ¥å°†æ¶ˆæ¯å†™å…¥åˆ°SocketChannelä¸­ï¼Œè°ƒç”¨writeæ–¹æ³•åªæ˜¯æŠŠå¾…å‘é€çš„æ¶ˆæ¯
        //æ”¾åˆ°å‘é€ç¼“å†²æ•°ç»„ä¸­ï¼Œå†è°ƒç”¨flushå‘é€
        ctx.write(resp);
        System.out.println(&quot;å†™å…¥å®Œæˆ&quot;);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        //å°†æ¶ˆæ¯å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å†™åˆ°SocketChannelä¸­å‘é€ç»™å¯¹æ–¹
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}

</code></pre>
<h4 id="432-æ”¯æŒtcpç²˜åŒ…çš„tcpclient">4.3.2 æ”¯æŒTCPç²˜åŒ…çš„TcpClient</h4>
<blockquote>
<p>TimeApClient</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.LineBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * ç²˜åŒ…å®¢æˆ·ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:06
 */
public class TimeApClient {

    public void connect(int port ,String host) throws Exception {

        //é…ç½®nioçº¿ç¨‹ç»„
        EventLoopGroup group = new NioEventLoopGroup();

        try{
            Bootstrap b = new Bootstrap();
            b.group(group).channel(NioSocketChannel.class)
                    .option(ChannelOption.TCP_NODELAY, true)
                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            socketChannel.pipeline().addLast(new LineBasedFrameDecoder(1024));
                            socketChannel.pipeline().addLast(new StringDecoder());
                            socketChannel.pipeline().addLast(new TimeClientApHandler());
                        }
                    });

            //å‘èµ·å¼‚æ­¥è¿æ¥æ“ä½œ
            ChannelFuture f = b.connect(host, port).sync();
            //ç­‰å¾…å®¢æˆ·ç«¯é“¾è·¯å…³é—­
            f.channel().closeFuture().sync();
            //ä¼˜é›…é€€å‡ºï¼Œé‡Šæ”¾NIOçº¿ç¨‹ç»„
        }finally {
            group.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new TimeApClient().connect(port,&quot;127.0.0.1&quot;);
    }
}

</code></pre>
<blockquote>
<p>TimeClientApHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;


/**
 * å®¢æˆ·ç«¯ç²˜åŒ…
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:09
 */
public class TimeClientApHandler extends ChannelInboundHandlerAdapter {

//    private final ByteBuf firstMessage;
    private int counter;
    private byte[] req;

    public TimeClientApHandler() {
       req = ( &quot;QUERY TIME ORDER&quot; + System.getProperty(&quot;line.separator&quot;) ).getBytes();
//        firstMessage = Unpooled.buffer(req.length);
//        firstMessage.writeBytes(req);
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx){
        ByteBuf message = null;
        for (int i = 0; i &lt; 100; i++) {
            message = Unpooled.buffer(req.length);
            message.writeBytes(req);
            ctx.writeAndFlush(message);
        }
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception{
        String body = (String) msg;
        System.out.println(&quot;Now is :&quot; + body + &quot;; the counter is :&quot; + ++counter);

    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        System.out.println(&quot;é‡Šæ”¾èµ„æº&quot;);
        ctx.close();
    }
}

</code></pre>
<h4 id="433-è¿è¡Œ">4.3.3 è¿è¡Œ</h4>
<blockquote>
<p>æœåŠ¡ç«¯</p>
</blockquote>
<pre><code class="language-java">The time server receive order :QUERY TIME ORDER; the counter is : 100
å†™å…¥å®Œæˆ
</code></pre>
<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<pre><code class="language-java">Now is :Mon Oct 17 15:41:57 CST 2022; the counter is :98
Now is :Mon Oct 17 15:41:57 CST 2022; the counter is :99
Now is :Mon Oct 17 15:41:57 CST 2022; the counter is :100
</code></pre>
<h4 id="434-linebasedframedecoder-å’Œ-stringdecoderåŸç†åˆ†æ">4.3.4 LineBasedFrameDecoder å’Œ StringDecoderåŸç†åˆ†æ</h4>
<p>LineBasedFrameDecoderçš„å·¥ä½œåŸç†æ˜¯å®ƒä¸€æ¬¡éå†ByteBufçš„å¯è¯»å­—èŠ‚ï¼Œåˆ¤æ–­çœ‹æ˜¯å¦æœ‰\næˆ–è€…\r\nï¼Œå¦‚æœæœ‰å°±ä»¥æ¬¡ä½ç½®ä¸ºç»“æŸä½ç½®ï¼Œä»å¯è¯»ç´¢å¼•åˆ°ç»“æŸä½ç½®åŒºé—´çš„å­—èŠ‚å°±ç»„æˆäº†ä¸€è¡Œã€‚</p>
<p>å®ƒæ˜¯ä»¥æ¢è¡Œç¬¦ä¸ºç»“æŸæ ‡å¿—çš„è§£ç å™¨ï¼Œæ”¯æŒæºå¸¦ç»“æŸç¬¦æˆ–è€…ä¸æºå¸¦ç»“æŸç¬¦2ç§è§£ç æ–¹å¼ï¼ŒåŒæ—¶æ”¯æŒé…ç½®ä½†è¡Œæœ€å¤§é•¿åº¦ã€‚å¦‚æœè¿ç»­è¯»å–åˆ°æœ€å¤§é•¿åº¦åä»ç„¶æ²¡æœ‰å‡ºç°æ¢è¡Œç¬¦ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>StringDecoderçš„åŠŸèƒ½éå¸¸ç®€å•ï¼Œå°±æ˜¯å°†æ¥æ”¶åˆ°åˆ°å¯¹è±¡è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œç„¶åç»§ç»­è°ƒç”¨åç»­åˆ°Handlerã€‚</p>
<h2 id="5-åˆ†éš”ç¬¦å’Œå®šé•¿è§£ç å™¨åˆ°åº”ç”¨">5 åˆ†éš”ç¬¦å’Œå®šé•¿è§£ç å™¨åˆ°åº”ç”¨</h2>
<p>TCPä»¥æµçš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¸Šå±‚çš„åº”ç”¨åè®®ä¸ºäº†å¯¹æ¶ˆæ¯è¿›è¡ŒåŒºåˆ†ï¼Œä¸€èˆ¬é‡‡ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p>
<ol>
<li>æ¶ˆæ¯é•¿åº¦å›ºå®šï¼Œç´¯è®¡è¯»å–åˆ°é•¿åº¦æ€»å’Œä¸ºå®šé•¿LENçš„æŠ¥æ–‡åï¼Œå°±è®¤ä¸ºè¯»å–åˆ°äº†ä¸€ä¸ªå®Œæ•´åˆ°æ¶ˆæ¯ï¼Œç„¶åå°†è®¡æ•°å™¨ç½®ä½ï¼Œé‡æ–°å¼€å§‹è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®æŠ¥ã€‚</li>
<li>å°†å›è½¦æ¢è¡Œç¬¦ä½œä¸ºæ¶ˆæ¯ç»“æŸç¬¦</li>
<li>å°†ç‰¹æ®Šåˆ°åˆ†éš”ç¬¦ä½œä¸ºæ¶ˆæ¯åˆ°ç»“æŸæ ‡å¿—</li>
<li>é€šè¿‡åœ¨æ¶ˆæ¯å¤´ä¸­å®šä¹‰é•¿åº¦å­—æ®µæ¥è¡¨ç¤ºæ¶ˆæ¯åˆ°æ€»é•¿åº¦</li>
</ol>
<p>Nettyå¯¹ä¸Šé¢4ç§åšäº†ç»Ÿä¸€æŠ½è±¡ï¼Œæä¾›äº†4ç§è§£ç å™¨æ¥è§£å†³å¯¹åº”å¯¹é—®é¢˜ã€‚ä¸Šè¿°ä½¿ç”¨LineBasedFrameDecoder å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œè¿˜æœ‰<strong>DelimiterBasedFrameDecoder</strong>ç”¨äºè‡ªåŠ¨å®Œæˆä»¥åˆ†éš”ç¬¦åšç»“æŸæ ‡å¿—å¯¹è§£ç ï¼Œ<strong>FixedLengthFrameDecoder</strong>ç”¨äºè‡ªåŠ¨å®Œæˆå¯¹å®šé•¿æ¶ˆæ¯å¯¹è§£ç ã€‚</p>
<h3 id="51-delimiterbasedframedecoderåº”ç”¨å¼€å‘">5.1 DelimiterBasedFrameDecoderåº”ç”¨å¼€å‘</h3>
<p>ğŸ ä¾‹å­ï¼šæœ¬ä¾‹å°†ä»¥$_ä½œä¸ºåˆ†éš”ç¬¦</p>
<h4 id="511-delimiterbasedframedecoderæœåŠ¡ç«¯å¼€å‘">5.1.1 DelimiterBasedFrameDecoderæœåŠ¡ç«¯å¼€å‘</h4>
<blockquote>
<p>EchoServer</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.echo;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.DelimiterBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * ECHOæœåŠ¡ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:21
 */
public class EchoServer {

    public void bind(int port){
        //é…ç½®æœåŠ¡ç«¯nioçº¿ç¨‹ç»„,å¤„ç†ç½‘ç»œäº‹ä»¶
        EventLoopGroup boosGroup = new NioEventLoopGroup();//ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();//ç”¨äºè¿›è¡ŒSocketChannelç½‘ç»œè¯»å†™

        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 1024)
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel channel) throws Exception {
                            ByteBuf delimiter = Unpooled.copiedBuffer(&quot;$_&quot;.getBytes());
                            //å•ä½“æ¶ˆæ¯æœ€å¤§é•¿åº¦1024ï¼Œå½“è¾¾åˆ°è¯¥é•¿åº¦åä»ç„¶æ²¡æœ‰æŸ¥æ‰¾åˆ°åˆ†éš”ç¬¦å°±æŠ›å‡ºå¼‚å¸¸
                            channel.pipeline().addLast(new DelimiterBasedFrameDecoder(1024, delimiter));
                            channel.pipeline().addLast(new StringDecoder());//å°†ByteBufè§£ç æˆå­—ç¬¦ä¸²å¯¹è±¡
                            channel.pipeline().addLast(new EchoServerHandler());//æ¥æ”¶æ¶ˆæ¯
                        }
                    });

            //ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            //ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
            //é€€å‡º
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            boosGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new EchoServer().bind(port);
    }
}

</code></pre>
<blockquote>
<p>EchoServerHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.echo;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

import java.util.Date;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class EchoServerHandler extends ChannelInboundHandlerAdapter {
    private int counter = 0;

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
        String body = (String) msg;
        System.out.println(&quot;This is&quot; + ++counter + &quot;The time server receive client :&quot; + body);

        body += &quot;$_&quot;;
        ByteBuf echo = Unpooled.copiedBuffer(body.getBytes());
        ctx.write(echo);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}

</code></pre>
<h4 id="512-delimiterbasedframedecoderå®¢æˆ·ç«¯å¼€å‘">5.1.2 DelimiterBasedFrameDecoderå®¢æˆ·ç«¯å¼€å‘</h4>
<blockquote>
<p>EchoClient</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.echo;

import io.netty.bootstrap.Bootstrap;
import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.DelimiterBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * ECHOå®¢æˆ·ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:06
 */
public class EchoClient {

    public void connect(int port ,String host) throws Exception {

        //é…ç½®nioçº¿ç¨‹ç»„
        EventLoopGroup group = new NioEventLoopGroup();

        try{
            Bootstrap b = new Bootstrap();
            b.group(group).channel(NioSocketChannel.class)
                    .option(ChannelOption.TCP_NODELAY, true)
                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            ByteBuf delimiter = Unpooled.copiedBuffer(&quot;$_&quot;.getBytes());
                            //å•ä½“æ¶ˆæ¯æœ€å¤§é•¿åº¦1024ï¼Œå½“è¾¾åˆ°è¯¥é•¿åº¦åä»ç„¶æ²¡æœ‰æŸ¥æ‰¾åˆ°åˆ†éš”ç¬¦å°±æŠ›å‡ºå¼‚å¸¸
                            socketChannel.pipeline().addLast(new DelimiterBasedFrameDecoder(1024, delimiter));
                            socketChannel.pipeline().addLast(new StringDecoder());//å°†ByteBufè§£ç æˆå­—ç¬¦ä¸²å¯¹è±¡
                            socketChannel.pipeline().addLast(new EchoClientHandler());//æ¥æ”¶æ¶ˆæ¯
                        }
                    });

            //å‘èµ·å¼‚æ­¥è¿æ¥æ“ä½œ
            ChannelFuture f = b.connect(host, port).sync();
            //ç­‰å¾…å®¢æˆ·ç«¯é“¾è·¯å…³é—­
            f.channel().closeFuture().sync();
            //ä¼˜é›…é€€å‡ºï¼Œé‡Šæ”¾NIOçº¿ç¨‹ç»„
        }finally {
            group.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new EchoClient().connect(port,&quot;127.0.0.1&quot;);
    }
}
</code></pre>
<blockquote>
<p>EchoClientHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.echo;

import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;


/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:09
 */
public class EchoClientHandler extends ChannelInboundHandlerAdapter {

    private int counter;
    static final String ECHO_REQ = &quot;Hi LIKECAT,Welcome to my home.$_&quot;;

    public EchoClientHandler() {
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx){
        for (int i = 0; i &lt; 10; i++) {
            ctx.writeAndFlush(Unpooled.copiedBuffer(ECHO_REQ.getBytes()));
        }
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg){
        System.out.println(&quot;This is&quot; + ++counter + &quot;The times  receive server : [&quot; + msg + &quot;]&quot;);

    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        ctx.close();
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        ctx.flush();
    }
}
</code></pre>
<h4 id="513-delimiterbasedframedecoderè¿è¡Œ">5.1.3 DelimiterBasedFrameDecoderè¿è¡Œ</h4>
<blockquote>
<p>æ‰§è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">This is1The time server receive client :Hi LIKECAT,Welcome to my home.
This is2The time server receive client :Hi LIKECAT,Welcome to my home.
This is3The time server receive client :Hi LIKECAT,Welcome to my home.
This is4The time server receive client :Hi LIKECAT,Welcome to my home.
This is5The time server receive client :Hi LIKECAT,Welcome to my home.
This is6The time server receive client :Hi LIKECAT,Welcome to my home.
This is7The time server receive client :Hi LIKECAT,Welcome to my home.
This is8The time server receive client :Hi LIKECAT,Welcome to my home.
This is9The time server receive client :Hi LIKECAT,Welcome to my home.
This is10The time server receive client :Hi LIKECAT,Welcome to my home.

</code></pre>
<p>å¦‚æœæ²¡æœ‰ä½¿ç”¨DelimiterBasedFrameDecoderåˆ™ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼Œå› ä¸ºæœåŠ¡ç«¯ä¸€æ¬¡è¯»å–äº†å®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œå¯¼è‡´TCPç²˜åŒ…æ‹†åŒ…é—®é¢˜çš„å‡ºç°ã€‚</p>
<blockquote>
<p>æ‰§è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">This is1The time server receive client :Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_
</code></pre>
<h3 id="52-fixedlengthframedecoderåº”ç”¨å¼€å‘">5.2 FixedLengthFrameDecoderåº”ç”¨å¼€å‘</h3>
<p>FixedLengthFrameDecoderæ˜¯å›ºå®šé•¿åº¦è§£ç å™¨ã€‚æ— è®ºä¸€æ¬¡æ¥æ”¶åˆ°å¤šå°‘æ•°æ®åŒ…ï¼Œå®ƒéƒ½ä¼šæŒ‰ç…§æ„é€ å‡½æ•°ä¸­è®¾ç½®éƒ½å›ºå®šé•¿åº¦è¿›è¡Œè§£ç ï¼Œå¦‚æœæ˜¯åŠåŒ…æ¶ˆæ¯ï¼Œåˆ™ä¼šç¼“å­˜åŠåŒ…æ¶ˆæ¯å¹¶ç­‰å¾…ä¸‹ä¸ªåŒ…åˆ°è¾¾åè¿›è¡Œæ‹¼åŒ…ï¼ŒçŸ¥é“è¯»å–ä¸€ä¸ªå®Œæ•´çš„åŒ…ã€‚</p>
<h4 id="521-fixedlengthframedecoderæœåŠ¡ç«¯å¼€å‘">5.2.1 FixedLengthFrameDecoderæœåŠ¡ç«¯å¼€å‘</h4>
<p>åœ¨æœåŠ¡ç«¯ä¸­æ–°å¢FixedLengthFrameDecoderï¼Œé•¿åº¦è®¾ç½®ä¸º20ã€‚</p>
<blockquote>
<p>FixedServer</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.fixed;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.FixedLengthFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * å®šé•¿è§£ç æœåŠ¡ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:21
 */
public class FixedServer {

    public void bind(int port){
        //é…ç½®æœåŠ¡ç«¯nioçº¿ç¨‹ç»„,å¤„ç†ç½‘ç»œäº‹ä»¶
        EventLoopGroup boosGroup = new NioEventLoopGroup();//ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();//ç”¨äºè¿›è¡ŒSocketChannelç½‘ç»œè¯»å†™

        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 100)
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel channel) throws Exception {
                            channel.pipeline().addLast(new FixedLengthFrameDecoder(20));
                            channel.pipeline().addLast(new StringDecoder());//å°†ByteBufè§£ç æˆå­—ç¬¦ä¸²å¯¹è±¡
                            channel.pipeline().addLast(new FixedServerHandler());//æ¥æ”¶æ¶ˆæ¯
                        }
                    });

            //ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            //ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
            //é€€å‡º
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            boosGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new FixedServer().bind(port);
    }
}
</code></pre>
<blockquote>
<p>FixedServerHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.fixed;

import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class FixedServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
//        String body = (String) msg;
        System.out.println(&quot;The receive client :&quot; + msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}
</code></pre>
<h4 id="522-fixedlengthframedecoderè¿è¡Œ">5.2.2 FixedLengthFrameDecoderè¿è¡Œ</h4>
<p>è¿™æ¬¡æˆ‘ä»¬é€šè¿‡å‘½ä»¤çš„å½¢å¼è¿è¡Œï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œå³å¯äºæœåŠ¡ç«¯é€šä¿¡ï¼š</p>
<pre><code class="language-mysql">telnet localhost 8080
</code></pre>

							</div>
	<div class="wow bounceInDown vt-post-tags">
 
				<a href="https://q456qq520.github.io/tag/IRAxS4EyL/" rel="tag">netty</a>	
				 
					</div>						
<nav class="navigation3 post-navigation3" role="navigation">
		
		<div class="nav-links3">
      
		<div class="wow bounceInLeft nav-previous3"><a href="https://q456qq520.github.io/post/netty-quan-wei-zhi-nan-er/" rel="prev"> Nettyæƒå¨æŒ‡å—(äºŒ)</a></div>
		 
		 
		<div class="wow bounceInRight nav-next3"><a href="https://q456qq520.github.io/post/guan-cha-zhe-mo-shi/" rel="next"> è§‚å¯Ÿè€…æ¨¡å¼</a></div>
		
		</div>
	</nav>
	<div class="wow rollIn author-info" style="visibility: visible; animation-name: rollIn;">
	<div class="author-avatar pull-left"><img src="https://q456qq520.github.io/images/avatar.png" ></div>
 
	<div class="author-description"><div class="author-title"><div class="author-link" rel="author">LIKECAT</div></div>


	<p class="author-bio">ä¸€æ¡å°å’¸é±¼</p></div></div>
	
		</div>
		
 
		
</article>

<div id="marlin_lite_about_widget-2" class="wow bounceInUp widget marlin_lite_about_widget" data-wow-delay="0.1s">
		
        
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '1e61bc4630cf7e3c0b8e',
    clientSecret: 'd1728142222f511a472443c6e499356387ab3b96',
    repo: 'q456qq520.github.io',
    owner: 'q456qq520',
    admin: ['q456qq520'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          
          
        
		<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://q456qq520.github.io/media/scripts/Valine.min.js'></script>

<div class="comment"></div>
<script>
        new Valine({
            // AV å¯¹è±¡æ¥è‡ªä¸Šé¢å¼•å…¥av-min.js(è€å¸æœºä»¬ä¸è¦å¼€è½¦â³â™¡ã‚›æ‰å¿ƒäº†è€é“)
            av: AV, 
            el: '.comment',
            lang: 'zh-cn',
            
            
      emoticon_list: ["å.png","å–·è¡€.png","ç‹‚æ±—.png","ä¸è¯´è¯.png","æ±—.png","åç­‰.png","çŒ®èŠ±.png","ä¸é«˜å…´.png","ä¸­åˆ€.png","å®³ç¾.png","çš±çœ‰.png","å°çœ¼ç›.png","ä¸­æŒ‡.png","å°´å°¬.png","ç…ä½ .png","æƒ³ä¸€æƒ³.png","ä¸­æª.png","å¾—æ„.png","è‚¿åŒ….png","æ‰‡è€³å…‰.png","äº²äº².png","æƒŠå–œ.png","è„¸çº¢.png","æ— æ‰€è°“.png","ä¾¿ä¾¿.png","æ„¤æ€’.png","èœ¡çƒ›.png","çŒ®é»„ç“œ.png","å†…ä¼¤.png","æŠ•é™.png","è§‚å¯Ÿ.png","çœ‹ä¸è§.png","å‡»æŒ.png","æŠ é¼».png","é‚ªæ¶.png","çœ‹çƒ­é—¹.png","å£æ°´.png","æŠ½çƒŸ.png","é”çœ‰.png","è£…å¤§æ¬¾.png","åèˆŒ.png","æ— å¥ˆ.png","é•¿è‰.png","èµä¸€ä¸ª.png","å‘²ç‰™.png","æ— è¯­.png","é˜´æš—.png","ä¸å‡ºæ‰€æ–™.png","å’½æ°”.png","æœŸå¾….png","é«˜å…´.png","åè¡€å€’åœ°.png","å“­æ³£.png","æ¬¢å‘¼.png","é»‘çº¿.png","å–œæè€Œæ³£.png","å–·æ°´.png","æ·±æ€.png","é¼“æŒ.png","æš—åœ°è§‚å¯Ÿ.png"],
     	
      	
          
        });
    </script> 


   
  
 

		</div>

			</div>
			


<div class="tocc col l3 hide-on-med-and-down">
	
        <div class="toc-widget">
			
            <div class="toc-title"></div>
			
            <div id="toc-content">
			
			
			</div>
        </div>
    </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.5.0/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '.entry-summary',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('.entry-summary').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>										 

 
       


			</div>
		</div>

		
		 	<footer id="colophon" class="site-footer">

			<div class="container">
	
				<div class="copyright">Powered by <a href="https://blog.csdn.net/weixin_42652031" target="_blank">ä¸€æ¡å°å’¸é±¼</a><br>Theme:   <a href="https://github.com/alterfang/gridea-theme-pan" target="_blank" title="Pan"><span>Pan</span></a>. Powered by <a href="https://gridea.dev/" target="_blank" title="Gridea"><span>Gridea</span></a></div>		
			</div>
		
		</footer>

</div>

<script src="https://cdn.bootcss.com/fitvids/1.2.0/jquery.fitvids.min.js"></script>
<script type='text/javascript' src='https://q456qq520.github.io/media/scripts/marlin-scripts.js'></script>
 <script src="//tokinx.github.io/lately/lately.min.js"></script>
  <script>jQuery(document).ready(function(){$.lately({'target':'.lately-a,.lately-b,.lately-c'})});</script>
  <style type="text/css">a.back_to_top {
    text-decoration: none;
    position: fixed;
    bottom: 40px;
    right: 30px;
    background: #f0f0f0;
    height: 40px;
    width: 40px;
    border-radius: 50%;
    line-height: 36px;
    font-size: 18px;
    text-align: center;
    transition-duration: .5s;
    transition-propety: background-color;
    display: none;
}

a.back_to_top span {
    color: #888;
}

a.back_to_top:hover {
    cursor: pointer;
    background: #dfdfdf;
}

a.back_to_top:hover span {
    color: #555;
}

@media print, screen and (max-width: 580px) {
    .back_to_top {
        display: none !important;
    }
}



</style><a id="back_to_top" href="#" class="back_to_top"><span><i class="iconfont icon-xiangshang"></i></span>
</a>


<script>$(document).ready((function(_this) {
  return function() {
    var bt;
    bt = $('#back_to_top');
    if ($(document).width() > 480) {
      $(window).scroll(function() {
        var st;
        st = $(window).scrollTop();
        if (st > 30) {
          return bt.css('display', 'block');
        } else {
          return bt.css('display', 'none');
        }
      });
      return bt.click(function() {
        $('body,html').animate({
          scrollTop: 0
        }, 800);
        return false;
      });
    }
  };
})(this));
</script>

		<script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $('.navigation:eq(0)').remove();
                $("").attr("rel" , "external");
                $("a[rel='external'],a[rel='external nofollow']").attr("target","_blank");
                $("a.vi").attr("rel" , "");
                $.viewImage({
                    'target'  : 'img',
                    'exclude' : '.vsmile-icons img,.gallery img',
                    'delay'   : 300
                });
                $.lately({
                    'target' : '.commentmetadata a,.infos time,.post-list time'
                });
                prettyPrint();
                
                $('ul.links li a').each(function(){
                    if($(this).parent().find('.bg').length==0){
                        $(this).parent().append('<!---<div class="bg" style="background-image:url(https://c3.glgoo.top/s2/favicons?domain='+$(this).attr("href")+')"></div>--->')
                    }
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>

</body>
</html>
