<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://q456qq520.github.io</id>
    <title>LIKECAT</title>
    <updated>2022-10-20T01:42:13.079Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://q456qq520.github.io"/>
    <link rel="self" href="https://q456qq520.github.io/atom.xml"/>
    <subtitle>ä¸€æ¡å°å’¸é±¼</subtitle>
    <logo>https://q456qq520.github.io/images/avatar.png</logo>
    <icon>https://q456qq520.github.io/favicon.ico</icon>
    <rights>All rights reserved 2022, LIKECAT</rights>
    <entry>
        <title type="html"><![CDATA[Nettyæƒå¨æŒ‡å—(äºŒ)]]></title>
        <id>https://q456qq520.github.io/post/netty-quan-wei-zhi-nan-er/</id>
        <link href="https://q456qq520.github.io/post/netty-quan-wei-zhi-nan-er/">
        </link>
        <updated>2022-10-19T03:18:46.000Z</updated>
        <summary type="html"><![CDATA[<h2 id="6-ç¼–è§£ç æŠ€æœ¯">6 ç¼–è§£ç æŠ€æœ¯</h2>
<p>åœ¨Nettyçš„NIOç½‘ç»œå¼€å‘ä¸­ï¼Œå½“è¿›è¡Œè¿œç¨‹è·¨è¿›ç¨‹æœåŠ¡è°ƒç”¨æ—¶ï¼Œéœ€è¦æŠŠè¢«ä¼ è¾“å½“javaå¯¹è±¡ç¼–ç ä¸ºå­—èŠ‚æ•°ç»„æˆ–è€…ByteBufferå¯¹è±¡ï¼Œè€Œå½“è¿œç¨‹æœåŠ¡è¯»å–åˆ°BtyeBufferå¯¹è±¡æˆ–è€…å­—èŠ‚æ•°ç»„æ—¶ï¼Œéœ€è¦å°†å…¶è§£ç ä¸ºå‘é€æ—¶çš„javaå¯¹è±¡ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<h2 id="6-ç¼–è§£ç æŠ€æœ¯">6 ç¼–è§£ç æŠ€æœ¯</h2>
<p>åœ¨Nettyçš„NIOç½‘ç»œå¼€å‘ä¸­ï¼Œå½“è¿›è¡Œè¿œç¨‹è·¨è¿›ç¨‹æœåŠ¡è°ƒç”¨æ—¶ï¼Œéœ€è¦æŠŠè¢«ä¼ è¾“å½“javaå¯¹è±¡ç¼–ç ä¸ºå­—èŠ‚æ•°ç»„æˆ–è€…ByteBufferå¯¹è±¡ï¼Œè€Œå½“è¿œç¨‹æœåŠ¡è¯»å–åˆ°BtyeBufferå¯¹è±¡æˆ–è€…å­—èŠ‚æ•°ç»„æ—¶ï¼Œéœ€è¦å°†å…¶è§£ç ä¸ºå‘é€æ—¶çš„javaå¯¹è±¡ã€‚</p>
<!-- more -->
<h3 id="61-javaåºåˆ—åŒ–çš„ç¼ºç‚¹">6.1 Javaåºåˆ—åŒ–çš„ç¼ºç‚¹</h3>
<ol>
<li>æ— æ³•è·¨è¯­è¨€</li>
<li>åºåˆ—åŒ–åçš„ç æµå¤ªå¤§</li>
<li>åºåˆ—åŒ–æ€§èƒ½å¤ªä½</li>
</ol>
<h3 id="62-ä¸»æµç¼–è§£ç æ¡†æ¶">6.2 ä¸»æµç¼–è§£ç æ¡†æ¶</h3>
<ol>
<li>Protobuf</li>
<li>Thrift</li>
</ol>
<h2 id="7-messagepackç¼–è§£ç ">7 MessagePackç¼–è§£ç </h2>
<h3 id="71-messagepackä¼˜ç‚¹">7.1 MessagePackä¼˜ç‚¹</h3>
<ol>
<li>ç¼–è§£ç é«˜æ•ˆ</li>
<li>åºåˆ—åŒ–åç æµå°</li>
<li>è·¨è¯­è¨€</li>
</ol>
<h3 id="72-messagepack-ç¼–è§£ç å™¨å¼€å‘">7.2 MessagePack ç¼–è§£ç å™¨å¼€å‘</h3>
<h4 id="721-messagepackç¼–ç å™¨å¼€å‘">7.2.1 MessagePackç¼–ç å™¨å¼€å‘</h4>
<blockquote>
<p>MessagePack ç¼–ç å™¨</p>
</blockquote>
<pre><code class="language-java">/**
 * MessagePack ç¼–ç å™¨
 * @author likecat
 * @version 1.0
 * @date 2022/10/19 11:47
 */
public class MsgpackEncoder extends MessageToByteEncoder&lt;Object&gt; {
    @Override
    protected void encode(ChannelHandlerContext channelHandlerContext, Object o, ByteBuf byteBuf) throws Exception {

        MessagePack msgpack = new MessagePack();
        byte[] raw = msgpack.write(o);
        byteBuf.writeBytes(raw);
    }
}
</code></pre>
<h4 id="722-messagepackè§£ç å™¨å¼€å‘">7.2.2 MessagePackè§£ç å™¨å¼€å‘</h4>
<blockquote>
<p>MessagePack è§£ç å™¨</p>
</blockquote>
<pre><code class="language-java">/**
 * MessagePack è§£ç å™¨
 * @author likecat
 * @version 1.0
 * @date 2022/10/19 11:52
 */
public class MsgpackDecoder extends MessageToMessageDecoder&lt;ByteBuf&gt; {
    @Override
    protected void decode(ChannelHandlerContext channelHandlerContext, ByteBuf byteBuf, List&lt;Object&gt; list) throws Exception {

        //é¦–å…ˆä»æ•°æ®åŒ…bytebufä¸­è·å–éœ€è¦è§£ç çš„å­—èŠ‚æ•°ç»„ï¼Œç„¶åç”¨MessagePackçš„readæ–¹æ³•å°†å…¶ååºåˆ—åŒ–ä¸ºobjectå¯¹è±¡
        final byte[] array;
        final int length = byteBuf.readableBytes();
        array = new byte[length];

        byteBuf.getBytes(byteBuf.readerIndex(), array, 0, length);
        MessagePack messagePack = new MessagePack();

        list.add(messagePack.read(array));
    }
}
</code></pre>
<h4 id="723-è¿è¡Œ">7.2.3 è¿è¡Œ</h4>
<blockquote>
<p>æœåŠ¡ç«¯ -ã€‹EchoMsgServer</p>
</blockquote>
<pre><code class="language-java">public class EchoMsgServer {
    public void bind(int port) throws Exception {
        // é…ç½®æœåŠ¡ç«¯çš„NIOçº¿ç¨‹ç»„
        // æœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥
        NioEventLoopGroup bossGroup = new NioEventLoopGroup();
        // è¿›è¡ŒSocketChannelçš„ç½‘ç»œè¯»å†™
        NioEventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 100)
                    .handler(new LoggingHandler(LogLevel.INFO))
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {

                        @Override
                        protected void initChannel(SocketChannel ch) throws Exception {
                            ch.pipeline().addLast(&quot;frameDecoder&quot;,new LengthFieldBasedFrameDecoder(65535, 0, 2,0,2));
                            // æ·»åŠ msgpackçš„ç¼–ç å’Œè§£ç å™¨
                            ch.pipeline().addLast(&quot;msgpack decoder&quot;,new MsgpackDecoder());
                            ch.pipeline().addLast(&quot;frameEncoder&quot;,new LengthFieldPrepender(2));
                            ch.pipeline().addLast(&quot;msgpack encoder&quot;,new MsgpackEncoder());
                            // æ·»åŠ è‡ªå®šä¹‰çš„å¤„ç†å™¨
                            ch.pipeline().addLast(new EchoMsgServerHandler());

                        }
                    });

            // ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            // ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
        }catch(Exception e){
            e.printStackTrace();
        } finally {
            // ä¼˜é›…é€€å‡ºï¼Œé‡Šæ”¾çº¿ç¨‹æ± èµ„æº
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;
        if(args!=null &amp;&amp; args.length &gt; 0){
            try{
                port = Integer.valueOf(args[0]);
            }catch(NumberFormatException e){
                // é‡‡ç”¨é»˜è®¤å€¼
            }
        }
        new EchoMsgServer().bind(port);
    }
}
</code></pre>
<blockquote>
<p>æœåŠ¡ç«¯ -ã€‹EchoMsgServerHandler</p>
</blockquote>
<pre><code class="language-java">public class EchoMsgServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws UnsupportedEncodingException {
        System.out.println(&quot;server receive the msgpack message :&quot;+msg);
        ctx.writeAndFlush(msg);
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        // Close the connection when an exception is raised.
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<blockquote>
<p>å®¢æˆ·ç«¯ -ã€‹EchoMsgClient</p>
</blockquote>
<pre><code class="language-java">public class EchoMsgClient {

    private final String host;
    private final int port;
    private final int sendNumber;

    public EchoMsgClient(String host, int port, int sendNumber) {
        this.host = host;
        this.port = port;
        this.sendNumber = sendNumber;
    }

    public void run() throws Exception {

        //é…ç½®nioçº¿ç¨‹ç»„
        EventLoopGroup group = new NioEventLoopGroup();

        try{
            Bootstrap b = new Bootstrap();
            b.group(group).channel(NioSocketChannel.class)
                    .option(ChannelOption.TCP_NODELAY, true)
                    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS,3000)
                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            //ä¸ºäº†å¤„ç†åŠåŒ…æ¶ˆæ¯ï¼Œæ·»åŠ å¦‚ä¸‹ä¸¤ä¸ª Netty å†…ç½®çš„ç¼–è§£ç å™¨
                            //LengthFieldPrependerï¼šå‰ç½®é•¿åº¦åŸŸç¼–ç å™¨â€”â€”æ”¾åœ¨MsgpackEncoderç¼–ç å™¨å‰é¢
                            //LengthFieldBasedFrameDecoderï¼šé•¿åº¦åŸŸè§£ç å™¨â€”â€”æ”¾åœ¨MsgpackDecoderè§£ç å™¨å‰é¢
                            socketChannel.pipeline().addLast(&quot;frameDecoder&quot;,new LengthFieldBasedFrameDecoder(65535, 0, 2,0,2));
                            // æ·»åŠ msgpackçš„ç¼–ç å’Œè§£ç å™¨
                            socketChannel.pipeline().addLast(&quot;msgpack decoder&quot;,new MsgpackDecoder());
                            socketChannel.pipeline().addLast(&quot;frameEncoder&quot;,new LengthFieldPrepender(2));
                            socketChannel.pipeline().addLast(&quot;msgpack encoder&quot;,new MsgpackEncoder());
                            socketChannel.pipeline().addLast(new EchoMsgClientHandler(sendNumber));//æ¥æ”¶æ¶ˆæ¯
                        }
                    });

            //å‘èµ·å¼‚æ­¥è¿æ¥æ“ä½œ
            ChannelFuture f = b.connect(host, port).sync();
            //ç­‰å¾…å®¢æˆ·ç«¯é“¾è·¯å…³é—­
            f.channel().closeFuture().sync();
            //ä¼˜é›…é€€å‡ºï¼Œé‡Šæ”¾NIOçº¿ç¨‹ç»„
        }finally {
            group.shutdownGracefully();
        }


    }

    public static void main(String[] args) throws Exception {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }
        new EchoMsgClient(&quot;127.0.0.1&quot;,port,10).run();
    }
}
</code></pre>
<blockquote>
<p>å®¢æˆ·ç«¯ -ã€‹EchoMsgClientHandler</p>
</blockquote>
<pre><code class="language-java">public class EchoMsgClientHandler extends ChannelInboundHandlerAdapter {
    private final int sendNumber;

    public EchoMsgClientHandler(int sendNumber) {
        this.sendNumber = sendNumber;
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx){
        UserInfo[] infos = UserInfo();
        for (UserInfo in:infos ) {
            ctx.writeAndFlush(in);
        }
        ctx.writeAndFlush(&quot;æˆ‘æ˜¯æ™®é€šçš„å­—ç¬¦ä¸²æ¶ˆæ¯&quot; + Thread.currentThread().getName());
    }

    private UserInfo [] UserInfo(){
        UserInfo[] userInfos = new UserInfo[sendNumber];
        UserInfo userInfo = null;
        for (int i = 0; i &lt; sendNumber; i++) {
            userInfo = new UserInfo();
            userInfo.setAge(i);
            userInfo.setUserName(&quot;ABCDEFG ----&gt;&quot; + i);
            userInfos[i] = userInfo;
        }
        return userInfos;
    }
    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg){
        System.out.println(&quot;Client receive the msgpack message: [&quot; + msg + &quot;]&quot;);
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        ctx.close();
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        ctx.flush();
    }
}
</code></pre>
<h2 id="8-httpå¤šåè®®å¼€å‘å’Œåº”ç”¨">8 HTTPå¤šåè®®å¼€å‘å’Œåº”ç”¨</h2>
<h3 id="81-netty-httpæœåŠ¡ç«¯å…¥é—¨å¼€å‘">8.1 Netty HTTPæœåŠ¡ç«¯å…¥é—¨å¼€å‘</h3>
<p>åŸºäºNIO TCPåè®®æ ˆå¼€å‘çš„HTTPåè®®æ ˆä¹Ÿæ˜¯å¼‚æ­¥éé˜»å¡çš„ã€‚</p>
<blockquote>
<p>æ–‡ä»¶æœåŠ¡å™¨å¯åŠ¨ç±»</p>
</blockquote>
<pre><code class="language-java">public class HttpFileServer {

    private static final String DEFAULT_URL = &quot;/src/main/java/com/likecat/netty/&quot;;

    public void run(final int port, final String url) throws Exception {
        EventLoopGroup bossGroup = new NioEventLoopGroup();
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel ch) throws Exception {
                            // æ·»åŠ è¯·æ±‚æ¶ˆæ¯è§£ç å™¨
                            ch.pipeline().addLast(&quot;http-decoder&quot;, new HttpRequestDecoder());
                            //HttpObjectAggregatorçš„ä½œç”¨ å°†å¤šä¸ªæ¶ˆæ¯è½¬æ¢ä¸ºå•ä¸€çš„FullHttpRequestæˆ–è€…FullHttpResponse
                            ch.pipeline().addLast(&quot;http-aggregator&quot;, new HttpObjectAggregator(65536));
                            // æ·»åŠ å“åº”è§£ç å™¨
                            ch.pipeline().addLast(&quot;http-encoder&quot;, new HttpResponseEncoder());
                            // æ”¯æŒå¼‚æ­¥å‘é€å¤§çš„ç æµ(å¤§çš„æ–‡ä»¶ä¼ è¾“),ä½†ä¸å ç”¨è¿‡å¤šçš„å†…å­˜ï¼Œé˜²æ­¢javaå†…å­˜æº¢å‡º
                            ch.pipeline().addLast(&quot;http-chunked&quot;, new ChunkedWriteHandler());
                            // æ·»åŠ è‡ªå®šä¹‰handler å¤„ç†æ–‡ä»¶æœåŠ¡å™¨ä¸šåŠ¡é€»è¾‘
                            ch.pipeline().addLast(&quot;fileServerHandler&quot;, new HttpFileServerHandler(url));
                        }
                    });
            ChannelFuture future = b.bind(&quot;127.0.0.1&quot;, port).sync();
            System.out.println(&quot;HTTPæ–‡ä»¶ç›®å½•æœåŠ¡å™¨å¯åŠ¨ï¼Œç½‘å€æ˜¯ : &quot; + &quot;http://127.0.0.1:&quot; + port + url);
            future.channel().closeFuture().sync();
        } finally {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;
        if (args.length &gt; 0) {
            try {
                port = Integer.parseInt(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }
        String url = DEFAULT_URL;
        if (args.length &gt; 1)
            url = args[1];
        new HttpFileServer().run(port, url);
    }
}
</code></pre>
<blockquote>
<p>æ–‡ä»¶æœåŠ¡å™¨å¤„ç†ç±»</p>
</blockquote>
<pre><code class="language-java">public class HttpFileServerHandler extends SimpleChannelInboundHandler&lt;FullHttpRequest&gt; {

    private final String url;

    public HttpFileServerHandler(String url) {
        this.url = url;
    }

    @Override
    public void messageReceived(ChannelHandlerContext ctx, FullHttpRequest request) throws Exception {
        // è§£ç å¤±è´¥ 400
        if (!request.getDecoderResult().isSuccess()) {
            sendError(ctx, BAD_REQUEST);
            return;
        }
        // åªæ”¯æŒgetæ–¹æ³•
        if (request.getMethod() != GET) {
            sendError(ctx, METHOD_NOT_ALLOWED);
            return;
        }
        //
        final String uri = request.getUri();
        // å¤„ç†Uriåœ°å€
        final String path = sanitizeUri(uri);

        if (path == null) {
            sendError(ctx, FORBIDDEN);
            return;
        }
        File file = new File(path);
        // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–ä¸å¯è®¿é—®
        if (file.isHidden() || !file.exists()) {
            sendError(ctx, NOT_FOUND);
            return;
        }
        // å¦‚æœè¯·æ±‚æ˜¯æ–‡ä»¶å¤¹
        if (file.isDirectory()) {
            // è¯·æ±‚ä»¥ '/'ç»“å°¾ï¼Œåˆ—å‡ºè¯¥æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰å†…å®¹
            if (uri.endsWith(&quot;/&quot;)) {
                sendListing(ctx, file);
            } else {
                // å¦åˆ™è‡ªåŠ¨è¡¥å…¨'/' ç„¶åå†é‡å®šå‘è®¿é—®
                sendRedirect(ctx, uri + '/');
            }
            return;
        }

        if (!file.isFile()) {
            sendError(ctx, FORBIDDEN);
            return;
        }
        RandomAccessFile randomAccessFile = null;
        try {
            randomAccessFile = new RandomAccessFile(file, &quot;r&quot;);// ä»¥åªè¯»çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶
        } catch (FileNotFoundException fnfe) {
            sendError(ctx, NOT_FOUND);
            return;
        }
        long fileLength = randomAccessFile.length();
        // åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„Httpå“åº”
        HttpResponse response = new DefaultHttpResponse(HTTP_1_1, OK);
        // è®¾ç½®å“åº”æ–‡ä»¶å¤§å°
        setContentLength(response, fileLength);
        // è®¾ç½® content Type
        setContentTypeHeader(response, file);
        // è®¾ç½® keep alive
        if (isKeepAlive(request)) {
            response.headers().set(CONNECTION, HttpHeaders.Values.KEEP_ALIVE);
        }
        ctx.write(response);
        ChannelFuture sendFileFuture;
        //é€šè¿‡Nettyçš„ChunkedFileå¯¹è±¡ç›´æ¥å°†æ–‡ä»¶å†™å…¥å‘é€åˆ°ç¼“å†²åŒºä¸­
        sendFileFuture = ctx.write(new ChunkedFile(randomAccessFile, 0, fileLength, 8192), ctx.newProgressivePromise());
        sendFileFuture.addListener(new ChannelProgressiveFutureListener() {
            @Override
            public void operationProgressed(ChannelProgressiveFuture future, long progress, long total) {
                if (total &lt; 0) { // total unknown
                    System.err.println(&quot;Transfer progress: &quot; + progress);
                } else {
                    System.err.println(&quot;Transfer progress: &quot; + progress + &quot; / &quot; + total);
                }
            }

            @Override
            public void operationComplete(ChannelProgressiveFuture future) throws Exception {
                System.out.println(&quot;Transfer complete.&quot;);
            }
        });
        ChannelFuture lastContentFuture = ctx.writeAndFlush(LastHttpContent.EMPTY_LAST_CONTENT);
        //å¦‚æœä¸æ”¯æŒkeep-Aliveï¼ŒæœåŠ¡å™¨ç«¯ä¸»åŠ¨å…³é—­è¯·æ±‚
        if (!isKeepAlive(request)) {
            lastContentFuture.addListener(ChannelFutureListener.CLOSE);
        }
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
        cause.printStackTrace();
        if (ctx.channel().isActive()) {
            sendError(ctx, INTERNAL_SERVER_ERROR);
        }
    }

    private static final Pattern INSECURE_URI = Pattern.compile(&quot;.*[&lt;&gt;&amp;\&quot;].*&quot;);

    /**
     * æ ¼å¼åŒ–uriå¹¶ä¸”è·å–è·¯å¾„
     * @param uri
     * @return
     */
    private String sanitizeUri(String uri) {
        try {
            uri = URLDecoder.decode(uri, &quot;UTF-8&quot;);
        } catch (UnsupportedEncodingException e) {
            try {
                uri = URLDecoder.decode(uri, &quot;ISO-8859-1&quot;);
            } catch (UnsupportedEncodingException e1) {
                throw new Error();
            }
        }
        if (!uri.startsWith(url)) {
            return null;
        }
        if (!uri.startsWith(&quot;/&quot;)) {
            return null;
        }
        uri = uri.replace('/', File.separatorChar);
        if (uri.contains(File.separator + '.') || uri.contains('.' + File.separator) || uri.startsWith(&quot;.&quot;)
                || uri.endsWith(&quot;.&quot;) || INSECURE_URI.matcher(uri).matches()) {
            return null;
        }
        return System.getProperty(&quot;user.dir&quot;) + File.separator + uri;
    }

    private static final Pattern ALLOWED_FILE_NAME = Pattern.compile(&quot;[A-Za-z0-9][-_A-Za-z0-9\\.]*&quot;);

    private static void sendListing(ChannelHandlerContext ctx, File dir) {
        FullHttpResponse response = new DefaultFullHttpResponse(HTTP_1_1, OK);
        response.headers().set(CONTENT_TYPE, &quot;text/html; charset=UTF-8&quot;);
        StringBuilder buf = new StringBuilder();
        String dirPath = dir.getPath();
        buf.append(&quot;&lt;!DOCTYPE html&gt;\r\n&quot;);
        buf.append(&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;&quot;);
        buf.append(dirPath);
        buf.append(&quot; ç›®å½•ï¼š&quot;);
        buf.append(&quot;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\r\n&quot;);
        buf.append(&quot;&lt;h3&gt;&quot;);
        buf.append(dirPath).append(&quot; ç›®å½•ï¼š&quot;);
        buf.append(&quot;&lt;/h3&gt;\r\n&quot;);
        buf.append(&quot;&lt;ul&gt;&quot;);
        buf.append(&quot;&lt;li&gt;é“¾æ¥ï¼š&lt;a href=\&quot;../\&quot;&gt;..&lt;/a&gt;&lt;/li&gt;\r\n&quot;);
        for (File f : dir.listFiles()) {
            if (f.isHidden() || !f.canRead()) {
                continue;
            }
            String name = f.getName();
            if (!ALLOWED_FILE_NAME.matcher(name).matches()) {
                continue;
            }
            buf.append(&quot;&lt;li&gt;é“¾æ¥ï¼š&lt;a href=\&quot;&quot;);
            buf.append(name);
            buf.append(&quot;\&quot;&gt;&quot;);
            buf.append(name);
            buf.append(&quot;&lt;/a&gt;&lt;/li&gt;\r\n&quot;);
        }
        buf.append(&quot;&lt;/ul&gt;&lt;/body&gt;&lt;/html&gt;\r\n&quot;);
        ByteBuf buffer = Unpooled.copiedBuffer(buf, CharsetUtil.UTF_8);
        response.content().writeBytes(buffer);
        buffer.release();
        ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);
    }

    private static void sendRedirect(ChannelHandlerContext ctx, String newUri) {
        FullHttpResponse response = new DefaultFullHttpResponse(HTTP_1_1, FOUND);
        response.headers().set(LOCATION, newUri);
        ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);
    }

    private static void sendError(ChannelHandlerContext ctx, HttpResponseStatus status) {
        FullHttpResponse response = new DefaultFullHttpResponse(HTTP_1_1, status,
                Unpooled.copiedBuffer(&quot;Failure: &quot; + status.toString() + &quot;\r\n&quot;, CharsetUtil.UTF_8));
        response.headers().set(CONTENT_TYPE, &quot;text/plain; charset=UTF-8&quot;);
        ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);
    }

    private static void setContentTypeHeader(HttpResponse response, File file) {
        MimetypesFileTypeMap mimeTypesMap = new MimetypesFileTypeMap();
        response.headers().set(CONTENT_TYPE, mimeTypesMap.getContentType(file.getPath()));
    }
}
</code></pre>
<h3 id="82-netty-http-xml-åè®®æ ˆå¼€å‘">8.2 Netty HTTP + XML åè®®æ ˆå¼€å‘</h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Nettyæƒå¨æŒ‡å—(ä¸€)]]></title>
        <id>https://q456qq520.github.io/post/netty-quan-wei-zhi-nan-yi/</id>
        <link href="https://q456qq520.github.io/post/netty-quan-wei-zhi-nan-yi/">
        </link>
        <updated>2022-10-13T02:01:23.000Z</updated>
        <summary type="html"><![CDATA[<h2 id="1-javaçš„ioæ¼”è¿›ä¹‹è·¯">1. Javaçš„IOæ¼”è¿›ä¹‹è·¯</h2>
]]></summary>
        <content type="html"><![CDATA[<h2 id="1-javaçš„ioæ¼”è¿›ä¹‹è·¯">1. Javaçš„IOæ¼”è¿›ä¹‹è·¯</h2>
<!-- more -->
<h3 id="11-io">1.1 I/O</h3>
<h4 id="111-linuxç½‘ç»œioæ¨¡å‹">1.1.1 LINUXç½‘ç»œI/Oæ¨¡å‹</h4>
<p>Linuxçš„å†…æ ¸å°†æ‰€æœ‰å¤–éƒ¨è®¾å¤‡éƒ½çœ‹ä½œä¸€ä¸ªæ–‡ä»¶æ¥æ“ä½œï¼Œå¯¹ä¸€ä¸ªæ–‡ä»¶å¯¹è¯»å†™æ“ä½œä¼šè°ƒç”¨å†…æ ¸æä¾›å¥½çš„ç³»ç»Ÿå‘½ä»¤ï¼Œè¿”å›ä¸€ä¸ªfile descriotorï¼ˆfdï¼Œæ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚è€Œå¯¹ä¸€ä¸ªsocketçš„è¯»å†™ä¹Ÿä¼šæœ‰ç›¸åº”çš„æè¿°ç¬¦ï¼Œç§°ä¸ºsocketfdï¼Œæè¿°ç¬¦å°±æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå®ƒæŒ‡å‘å†…æ ¸ä¸­çš„ä¸€ä¸ªç»“æ„ä½“ï¼ˆæ–‡ä»¶è·¯å¾„ï¼Œæ•°æ®å»ç­‰ä¸€äº›å±æ€§ï¼‰ã€‚</p>
<p>UNIXä¸­ï¼ŒI/Oæ¨¡å‹ç§ç±»æœ‰å¦‚ä¸‹ï¼š</p>
<ol>
<li>é˜»å¡I/Oæ¨¡å‹ï¼šä¸ºæœ€å¸¸ç”¨çš„ioæ¨¡å‹ï¼Œç¼ºçœæƒ…å†µä¸‹æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½æ˜¯é˜»å¡çš„ã€‚<br>
ä»¥å¥—æ¥å­—æ¥å£ä¸ºä¾‹ï¼šåœ¨è¿›ç¨‹ç©ºé—´ä¸­è°ƒç”¨Recvfrom,å…¶ç³»ç»Ÿè°ƒç”¨ç›´åˆ°æ•°æ®åŒ…åˆ°è¾¾ä¸”è¢«å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹çš„ç¼“å†²åŒºä¸­æˆ–è€…å‘ç”Ÿé”™è¯¯æ—¶æ‰è¿”å›ï¼Œåœ¨æ­¤æœŸé—´ä¸€ç›´ä¼šç­‰å¾…ï¼Œè¿›ç¨‹åœ¨ä»è°ƒç”¨recvfromå¼€å§‹åˆ°å®ƒè¿”å›åˆ°æ•´æ®µæ—¶é—´å†…éƒ½æ˜¯è¢«é˜»å¡åˆ°ï¼Œå› æ­¤è¢«ç§°ä¸ºé˜»å¡I/Oæ¨¡å‹ã€‚</li>
</ol>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1665627501192.png" alt="" loading="lazy"></figure>
<ol start="2">
<li>éé˜»å¡I/Oæ¨¡å‹ï¼šrecvfromä»åº”ç”¨å±‚åˆ°å†…æ ¸åˆ°æ—¶å€™ï¼Œå¦‚æœè¯¥ç¼“å†²åŒºæ²¡æœ‰æ•°æ®åˆ°è¯ï¼Œå°±ç›´æ¥è¿”å›ä¸€ä¸ªEWOULDBLOCKé”™è¯¯ï¼Œä¸€èˆ¬éƒ½æ˜¯å¯¹éé˜»å¡I/Oæ¨¡å‹è¿›è¡Œè½®è¯¢æ£€æŸ¥è¿™ä¸ªçŠ¶æ€ï¼Œçœ‹å†…æ ¸æ˜¯ä¸æ˜¯æœ‰æ•°æ®åˆ°æ¥ã€‚</li>
</ol>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1665627510514.png" alt="" loading="lazy"></figure>
<ol start="3">
<li>I/Oå¤ç”¨æ¨¡å‹ï¼šLinuxæä¾›select/pollï¼Œè¿›ç¨‹é€šè¿‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªfdä¼ é€’ç»™selectæˆ–pollç³»ç»Ÿè°ƒç”¨ï¼Œé˜»å¡åœ¨selectæ“ä½œä¸Šï¼Œè¿™æ˜¯select/pollå¯ä»¥å¸®æˆ‘ä»¬ä¾¦æµ‹å¤šä¸ªfdæ˜¯å¦å¤„äºå°±ç»ªçŠ¶æ€ã€‚select/pollä¸Šé¡ºåºæ‰«æfdæ˜¯å¦å°±ç»ªï¼Œè€Œä¸”æ”¯æŒç­‰fdæ•°é‡æœ‰é™ï¼Œå› æ­¤å®ƒçš„ä½¿ç”¨å—åˆ°äº†ä¸€äº›åˆ¶çº¦ã€‚Linuxè¿˜æä¾›äº†ä¸€ä¸ªepollç³»ç»Ÿè°ƒç”¨ï¼Œepollä½¿ç”¨åŸºäºäº‹ä»¶é©±åŠ¨æ–¹å¼ä»£æ›¿é¡ºåºæ‰«æï¼Œæ€§èƒ½æ›´é«˜ã€‚å½“æœ‰fdå°±ç»ªæ—¶ï¼Œç«‹å³å›è°ƒå‡½æ•°rollbockã€‚</li>
</ol>
<figure data-type="image" tabindex="3"><img src="https://q456qq520.github.io/post-images/1665628231352.png" alt="" loading="lazy"></figure>
<ol start="4">
<li>ä¿¡å·é©±åŠ¨I/Oæ¨¡å‹ï¼šé¦–å…ˆå¼€å¯å¥—æ¥å£ä¿¡å·é©±åŠ¨I/OåŠŸèƒ½ï¼Œå¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨sigactionæ‰§è¡Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ã€‚å½“æ•°æ®å‡†å¤‡å°±ç»ªæ—¶ï¼Œå°±ä¸ºè¯¥è¿›ç¨‹ç”Ÿäº§ä¸€ä¸ªSIGIOä¿¡å·ï¼Œé€šè¿‡ä¿¡å·å›è°ƒé€šçŸ¥åº”ç”¨ç¨‹åºè°ƒç”¨recvfromæ¥è¯»å–æ•°æ®ï¼Œå¹¶é€šçŸ¥ä¸»å¾ªç¯å‡½æ•°å¤„ç†æ•°æ®ã€‚</li>
</ol>
<figure data-type="image" tabindex="4"><img src="https://q456qq520.github.io/post-images/1665628476732.png" alt="" loading="lazy"></figure>
<ol start="5">
<li>å¼‚æ­¥I/Oï¼šå‘ŠçŸ¥å†…æ ¸å¯åŠ¨æŸä¸ªæ“ä½œï¼Œå¹¶è®©å†…æ ¸åœ¨æ•´ä¸ªæ“ä½œå®Œæˆåï¼ˆåŒ…æ‹¬å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°ç”¨æˆ·ç›´æ¥åˆ°ç¼“å†²åŒºï¼‰é€šçŸ¥æˆ‘ä»¬ã€‚<br>
è¿™ç§æ¨¡å‹ä¸ä¿¡å·é©±åŠ¨æ¨¡å‹åˆ°ä¸»è¦åŒºåˆ«æ˜¯ï¼šä¿¡å·é©±åŠ¨I/Oç”±å†…æ ¸é€šçŸ¥æˆ‘ä»¬ä½•æ—¶å¼€å§‹ä¸‹ä¸€ä¸ªI/Oæ“ä½œï¼›å¼‚æ­¥I/Oæ¨¡å‹ç”±å†…æ ¸é€šçŸ¥æˆ‘ä»¬I/Oæ“ä½œä½•æ—¶å·²ç»å®Œæˆã€‚</li>
</ol>
<figure data-type="image" tabindex="5"><img src="https://q456qq520.github.io/post-images/1665628659332.png" alt="" loading="lazy"></figure>
<h4 id="112-ioå¤šè·¯å¤ç”¨æŠ€æœ¯">1.1.2 I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯</h4>
<p>åœ¨I/Oç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œå½“éœ€è¦å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯æ¥å…¥è¯·æ±‚æ—¶ï¼Œå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æˆ–è€…I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯å¤„ç†ã€‚</p>
<p>I/Oå¤šè·¯å¤ç”¨é€šè¿‡æŠŠå¤šä¸ªI/Oçš„é˜»å¡å¤ç”¨åˆ°åŒä¸€ä¸ªselectåˆ°é˜»å¡ä¸Šï¼Œä»è€Œå¯ä»¥åœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ã€‚I/Oå¤šè·¯å¤ç”¨æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯ç³»ç»Ÿå¼€é”€å°ï¼Œç³»ç»Ÿä¸éœ€è¦åˆ›å»ºæ–°çš„é¢å¤–è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œä¹Ÿä¸éœ€è¦ç»´æŠ¤è¿™äº›è¿›ç¨‹å’Œçº¿ç¨‹çš„è¿è¡Œï¼Œé™ä½ç³»ç»Ÿçš„ç»´æŠ¤å·¥ä½œé‡ï¼ŒèŠ‚çœäº†ç³»ç»Ÿèµ„æºï¼ŒI/Oå¤šè·¯å¤ç”¨ä¸»è¦åº”ç”¨åœºæ™¯ä¸ºï¼š</p>
<pre><code>- æœåŠ¡å™¨éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªå¤„äºç›‘å¬çŠ¶æ€æˆ–è€…å¤šä¸ªè¿æ¥çŠ¶æ€çš„å¥—æ¥å­—ã€‚
- æœåŠ¡å™¨éœ€è¦åŒæ—¶å¤„ç†å¤šç§ç½‘ç»œåè®®çš„å¥—æ¥å­—ã€‚
</code></pre>
<p>ç›®å‰æ”¯æŒI/Oå¤šè·¯å¤ç”¨çš„ç³»ç»Ÿè°ƒç”¨æœ‰<strong>selectã€pselectã€pollã€epoll</strong>ã€‚</p>
<p>å…¶ä¸­epollä¸ºselectçš„æ›¿ä»£ï¼Œç›¸è¾ƒäºselectï¼Œepollåšäº†å¾ˆå¤šæ”¹è¿›ï¼Œå¦‚ä¸‹ï¼š</p>
<ol>
<li>æ”¯æŒä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„socketæè¿°ç¬¦ä¸å—é™åˆ¶ï¼ˆä»…å—é™ä¸æ“ä½œç³»ç»Ÿçš„æœ€å¤§æ–‡ä»¶å¥æŸ„æ•°ï¼‰ã€‚</li>
<li>I/Oæ•ˆç‡ä¸ä¼šéšç€FDæ ‘æœ¨çš„å¢åŠ è€Œçº¿æ€§ä¸‹é™ã€‚</li>
<li>ä½¿ç”¨mmapåŠ é€Ÿå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ã€‚</li>
<li>epollçš„apiæ›´åŠ ç®€å•</li>
</ol>
<h2 id="2-nio">2. NIO</h2>
<h3 id="21-ä¼ ç»Ÿçš„bioç¼–ç¨‹">2.1 ä¼ ç»Ÿçš„BIOç¼–ç¨‹</h3>
<p>ç½‘ç»œç¼–ç¨‹çš„åŸºæœ¬æ¨¡å‹æ˜¯Client/Serveræ¨¡å‹ï¼Œä¹Ÿå°±è¡Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è¿›è¡Œç›¸äº’é€šä¿¡ï¼Œå…¶ä¸­æœåŠ¡ç«¯æä¾›ä½ç½®ä¿¡æ¯ï¼ˆip&amp;portï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¿æ¥æ“ä½œå‘æœåŠ¡ç«¯ç›‘å¬çš„åœ°å€å‘èµ·è¿æ¥è¯·æ±‚ï¼Œé€šè¿‡3æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼ŒåŒæ–¹å°±å¯ä»¥é€šè¿‡ç½‘ç»œå¥—æ¥å­—ï¼ˆsocketï¼‰è¿›è¡Œé€šä¿¡ã€‚</p>
<h4 id="211-bioé€šä¿¡æ¨¡å‹">2.1.1 BIOé€šä¿¡æ¨¡å‹</h4>
<p>BIOé€šä¿¡çš„æœåŠ¡ç«¯é€šå¸¸ç”±ä¸€ä¸ªç‹¬ç«‹çš„Acceptorçº¿ç¨‹è´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå®ƒæ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ä¹‹åä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹è¿›è¡Œé“¾è·¯å¤„ç†ï¼Œå¤„ç†å®Œæˆåé€šè¿‡è¾“å‡ºæµè¿”å›åº”ç­”ç»™å®¢æˆ·ç«¯ï¼Œçº¿ç¨‹é”€æ¯ã€‚</p>
<p>è¯¥æ¨¡å‹æœ€å¤§çš„é—®é¢˜æ˜¯ç¼ºä¹å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›ï¼Œå½“å®¢æˆ·ç«¯å¹¶å‘è®¿é—®é‡å¢åŠ åï¼ŒæœåŠ¡ç«¯çš„çº¿ç¨‹ä¸ªæ•°å’Œå®¢æˆ·ç«¯å¹¶å‘è®¿é—®æ•°å‘ˆç°1:1çš„æ­£æ¯”å…³ç³»ï¼Œå¯¼è‡´ç³»ç»Ÿçš„æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚</p>
<h3 id="22-ä¼ªå¼‚æ­¥ioç¼–ç¨‹">2.2 ä¼ªå¼‚æ­¥I/Oç¼–ç¨‹</h3>
<p>ä¸ºäº†è§£å†³åŒæ­¥é˜»å¡I/Oä¸­ä¸€ä¸ªé“¾è·¯ä¸€ä¸ªçº¿ç¨‹çš„é—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªçº¿ç¨‹æ± æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—æ¥å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ¥å…¥ï¼Œå½¢æˆå®¢æˆ·ç«¯æ•°Mï¼šçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°Nçš„æ¯”ä¾‹å…³ç³»ï¼Œå…¶ä¸­Må¯ä»¥è¿œè¿œå¤§äºNã€‚é€šè¿‡çº¿ç¨‹æ± å¯ä»¥çµæ´»çš„è°ƒé…çº¿ç¨‹èµ„æºï¼Œè®¾ç½®çº¿ç¨‹çš„æœ€å¤§å€¼ï¼Œé˜²æ­¢çº¿ç¨‹è€—å°½ã€‚</p>
<h4 id="221-ä¼ªå¼‚æ­¥ioæ¨¡å‹å›¾">2.2.1 ä¼ªå¼‚æ­¥I/Oæ¨¡å‹å›¾</h4>
<p>å½“æœ‰æ–°çš„å®¢æˆ·ç«¯æ¥å…¥æ—¶ï¼Œå°†å®¢æˆ·ç«¯çš„socketå°è£…ç§°ä¸€ä¸ªTaskæŠ•é€’åˆ°åç«¯åˆ°çº¿ç¨‹æ± ä¸­è¿›è¡Œå¤„ç†ã€‚å› ä¸ºçº¿ç¨‹æ± åˆ°èµ„æºå ç”¨æ˜¯å¯æ§çš„ï¼Œæ— è®ºå¤šå°‘ä¸ªå®¢æˆ·ç«¯å¹¶å‘è®¿é—®ä»¬éƒ½ä¸ä¼šå¯¼è‡´èµ„æºçš„è€—å°½å’Œå®•æœºã€‚</p>
<p>ä½†æ˜¯åœ¨åŒæ­¥I/Oä¸­ï¼Œå¯¹å½“å¯¹Socketå¯¹è¾“å…¥æµè¿›è¡Œè¯»å–æ“ä½œçš„æ—¶å€™ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ä¸‹å»ï¼Œç›´åˆ°å‘ç”Ÿå¦‚ä¸‹ä¸‰ç§äº‹æƒ…ï¼š</p>
<ul>
<li>1.æœ‰æ•°æ®å¯è¯»</li>
<li>2.å¯ç”¨æ•°æ®å·²ç»è¯»å–å®Œæ¯•</li>
<li>3.å‘ç”Ÿå¼‚å¸¸</li>
</ul>
<p>è¿™æ„å‘³ç€å½“å¯¹æ–¹å‘é€è¯·æ±‚æˆ–è€…åº”ç­”æ¶ˆæ¯æ¯”è¾ƒç¼“æ…¢ï¼Œæˆ–è€…ç½‘ç»œä¼ è¾“è¾ƒæ…¢æ—¶ï¼Œè¯»å–è¾“å…¥æµä¸€æ–¹å½“é€šä¿¡çº¿ç¨‹å°†è¢«é•¿æ—¶é—´é˜»å¡ï¼Œè€Œä¸”åœ¨æ­¤æœŸé—´ï¼Œå…¶ä»–æ¥å…¥æ¶ˆæ¯åªèƒ½åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚</p>
<h4 id="222-åŒæ­¥ioçš„é—®é¢˜">2.2.2 åŒæ­¥I/Oçš„é—®é¢˜</h4>
<ol>
<li>æœåŠ¡å™¨å¤„ç†ç¼“æ…¢ï¼Œè¿”å›åº”ç­”æ¶ˆæ¯è€—æ—¶ä¹Ÿç›¸åº”å˜æ…¢ã€‚</li>
<li>é‡‡ç”¨ä¼ªå¼‚æ­¥I/Oçš„çº¿ç¨‹æ­£åœ¨è¯»å–æ•…éšœæœåŠ¡èŠ‚ç‚¹çš„å“åº”ï¼Œç”±äºè¯»å–è¾“å…¥æµæ˜¯é˜»å¡çš„ï¼Œé‚£è¯¥çº¿ç¨‹ä¹ŸåŒæ­¥é˜»å¡ã€‚</li>
<li>åŠ å…¥æ‰€æœ‰çš„å¯ç”¨çº¿ç¨‹éƒ½è¢«æ•…éšœæœåŠ¡å™¨é˜»å¡ï¼Œé‚£åç»­æ‰€æœ‰çš„I/Oæ¶ˆæ¯éƒ½å°†åœ¨é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚</li>
<li>ç”±äºçº¿ç¨‹æ± é‡‡ç”¨é˜»å¡é˜Ÿåˆ—å®ç°ï¼Œå½“é˜Ÿåˆ—ç§¯æ»¡ä»¥åï¼Œåç»­å…¥é˜Ÿåˆ—çš„æ“ä½œå°†è¢«é˜»å¡ã€‚</li>
<li>ç”±äºåªæœ‰ä¸€ä¸ªAccptorçº¿ç¨‹æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå®ƒè¢«é˜»å¡åœ¨çº¿ç¨‹æ± çš„åŒæ­¥é˜»å¡é˜Ÿåˆ—ä¹‹åï¼Œæ–°çš„å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯å°†è¢«æ‹’ç»ï¼Œå®¢æˆ·ç«¯ä¼šå‘ç”Ÿå¤§é‡çš„è¿æ¥è¶…æ—¶ã€‚</li>
<li>ç”±äºå‡ ä¹æ‰€æœ‰çš„è¿æ¥éƒ½è¶…æ—¶ï¼Œè°ƒç”¨è€…ä¼šè®¤ä¸ºç³»ç»Ÿå·²ç»å´©æºƒï¼Œæ— æ³•æ¥å—æ–°çš„æ¶ˆæ¯ã€‚</li>
</ol>
<p>è¿™å‡ ä¹æ˜¯ä¸€ä¸ªé“¾å¼çš„çº§è”æ•…éšœï¼Œé‚£è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯NIOã€‚</p>
<h3 id="23-nionon-block-ioç¼–ç¨‹">2.3 NIOï¼ˆNon-block I/Oï¼‰ç¼–ç¨‹</h3>
<h4 id="231-nioç±»åº“ç®€ä»‹">2.3.1 NIOç±»åº“ç®€ä»‹</h4>
<p>é¦–å…ˆä»‹ç»ä¸€ä¸‹NIOçš„ä¸€äº›æ¦‚å¿µä¸åŠŸèƒ½ï¼š</p>
<p><strong>1. ç¼“å†²åŒºBuffer</strong></p>
<p>Bufferæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåŒ…å«ä¸€äº›è¦å†™å…¥æˆ–è€…è¦è¯»å‡ºçš„æ•°æ®ã€‚åœ¨é¢å‘æµçš„I/Oä¸­ï¼Œå¯ä»¥å°†æ•°æ®ç›´æ¥å†™å…¥æˆ–è€…å°†æ•°æ®ç›´æ¥è¯»åˆ°Streamå¯¹è±¡ä¸­ã€‚</p>
<p>åœ¨NIOåº“ä¸­ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯ç”¨ç¼“å†²åŒºå¤„ç†çš„ã€‚åœ¨è¯»å–æ•°æ®æ—¶æ˜¯ç›´æ¥æ¸ é“ç¼“å†²åŒºä¸­çš„ï¼›åœ¨å†™å…¥æ•°æ®æ—¶ä¹Ÿæ˜¯å†™å…¥åˆ°ç¼“å†²åŒºä¸­ã€‚</p>
<p>ç¼“å†²åŒºå®è´¨ä¸Šä¼¼ä¸€ä¸ªæ•°ç»„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„-ByteBufferï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ç§ç±»çš„æ•°ç»„ã€‚ä½†æ˜¯ä¸€ä¸ªç¼“å†²åŒºä¸åŠæ‚¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç¼“å†²åŒºæä¾›äº†å¯¹æ•°æ®å¯¹ç»“æ„åŒ–è®¿é—®ä»¥åŠç»´æŠ¤è¯»å†™ä½ç½®ï¼ˆlimitï¼‰ç­‰ä¿¡æ¯ã€‚</p>
<p>æœ€å¸¸ç”¨å¯¹ç¼“å†²åŒºæ˜¯BtyeBufferï¼Œä¸‹é¢æ˜¯Javaæä¾›å¯¹æ ¹æ®æ•°æ®ç±»å‹åŒºåˆ†çš„ç¼“å†²åŒºï¼š</p>
<ul>
<li>ByteBufferï¼šå­—èŠ‚ç¼“å†²åŒº</li>
<li>CharBufferï¼šå­—ç¬¦ç¼“å†²åŒº</li>
<li>ShortBufferï¼šçŸ­æ•´å‹ç¼“å†²åŒº</li>
<li>IntBufferï¼šæ•´å½¢ç¼“å†²åŒº</li>
<li>LongBufferï¼šé•¿æ•´å½¢ç¼“å†²åŒº</li>
<li>FloatBufferï¼šæµ®ç‚¹å‹ç¼“å†²åŒº</li>
<li>DoubleBufferï¼šåŒç²¾åº¦æµ®ç‚¹å‹ç¼“å†²åŒº</li>
</ul>
<p>æ¯ä¸€ä¸ªBufferç±»éƒ½æ˜¯Bufferæ¥å£çš„ä¸€ä¸ªå­å®ä¾‹ï¼Œé™¤ByteBufferå¤–æ¯ä¸€ä¸ªBufferç±»éƒ½æœ‰å®Œå…¨ä¸€æ ·çš„æ“ä½œï¼Œåªæ˜¯æ‰€å¤„ç†çš„æ•°æ®ç±»å‹ä¸ä¸€æ ·ã€‚å› ä¸ºå¤§å¤šæ•°æ ‡å‡†I/Oæ“ä½œéƒ½ä½¿ç”¨BtyeBufferï¼Œæ‰€ä»¥å®ƒå…·æœ‰ä¸€èˆ¬ç¼“å†²åŒºçš„æ“ä½œä¹‹å¤–è¿˜æä¾›äº†ä¸€äº›ç‰¹æœ‰çš„æ“ä½œï¼Œä»¥æ–¹ä¾¿ç½‘ç»œè¯»å†™ã€‚</p>
<p><strong>2. é€šé“ Channel</strong></p>
<p>Channelæ˜¯ä¸€ä¸ªé€šé“ï¼Œç½‘ç»œæ•°æ®é€šè¿‡Channelè¯»å–å’Œå†™å…¥ã€‚é€šé“ä¸æµçš„ä¸åŒä¹‹å¤„åœ¨äºé€šé“æ˜¯åŒå‘çš„ï¼Œæµåªæ˜¯åœ¨ä¸€ä¸ªæ–¹å‘ä¸Šç§»åŠ¨ï¼Œè€Œé€šè¿‡å¯ä»¥ç”¨äºè¯»ã€å†™æˆ–è€…äºŒè€…åŒæ—¶è¿›è¡Œã€‚</p>
<p>å› ä¸ºChannelæ˜¯å…¨åŒå·¥çš„ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ¯”æµæ›´å¥½åœ°æ˜ å°„åº•å±‚æ“ä½œç³»ç»Ÿçš„APIã€‚</p>
<p><strong>3. å¤šè·¯å¤ç”¨å™¨ Selector</strong></p>
<p>å¤šè·¯å¤ç”¨å™¨æä¾›é€‰æ‹©å·²ç»å°±ç»ªçš„ä»»åŠ¡çš„èƒ½åŠ›ï¼Œç®€å•æ¥è¯´å°±æ˜¯Selectorä¼šä¸æ–­åœ°è½®è¯¢æ³¨å†Œåœ¨å…¶ä¸Šçš„Channelï¼Œå¦‚æœæŸä¸ªChannelä¸Šé¢å‘ç”Ÿè¯»æˆ–è€…å†™äº‹ä»¶ï¼Œè¿™ä¸ªChannelå°±å¤„äºå°±ç»ªçŠ¶æ€ï¼Œä¼šè¢«Selectorè½®è¯¢å‡ºæ¥ï¼Œç„¶åé€šè¿‡SelectionKeyå¯ä»¥è·å–å°±ç»ªChannelçš„é›†åˆï¼Œè¿›è¡Œåç»­çš„I/Oæ“ä½œã€‚</p>
<p>ä¸€ä¸ªå¤šè·¯å¤ç”¨å™¨Selectorå¯ä»¥åŒæ—¶è½®è¯¢å¤šä¸ªChannelï¼Œè€Œä¸”å› ä¸ºJdkä½¿ç”¨çš„æ˜¯epollï¼ˆï¼‰ä»£æ›¿selectï¼Œå¹¶æ²¡æœ‰æœ€å¤§è¿æ¥å¥æŸ„çš„é™åˆ¶ã€‚</p>
<h4 id="232-nioæœåŠ¡ç«¯">2.3.2 NIOæœåŠ¡ç«¯</h4>
<figure data-type="image" tabindex="6"><img src="https://q456qq520.github.io/post-images/1665650232697.png" alt="NIOæœåŠ¡ç«¯æ—¶åºå›¾" loading="lazy"></figure>
<p>Step 1ï¼šæ‰“å¼€ServerSocketChannelï¼Œç”¨äºç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå®ƒæ˜¯æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥çš„çˆ¶ç®¡é“ã€‚<br>
Step 2ï¼šç»‘å®šç›‘å¬ç«¯å£ï¼Œè®¾ç½®è¿æ¥ä¸ºéé˜»å¡æ¨¡å¼ã€‚<br>
Step 3ï¼šåˆ›å»ºReactorçº¿ç¨‹ï¼Œåˆ›å»ºå¤šè·¯å¤ç”¨å™¨å¹¶å¯åŠ¨çº¿ç¨‹ã€‚<br>
Step 4ï¼šå°†ServerSocketChannelæ³¨å†Œåˆ°Reactorçº¿ç¨‹çš„å¤šè·¯å¤ç”¨å™¨Selectorä¸Šï¼Œæ£€æŸ¥ACCEPTäº‹ä»¶ã€‚<br>
Step 5ï¼šå¤šè·¯å¤ç”¨å™¨åœ¨çº¿ç¨‹runæ–¹æ³•çš„æ— é™å¾ªç¯ä½“å†…è½®è¯¢å‡†å¤‡å°±ç»ªçš„key<br>
Step 6ï¼šå¤šè·¯å¤ç”¨å™¨ç›‘å¬åˆ°æœ‰æ–°åˆ°å®¢æˆ·ç«¯æ¥å…¥ï¼Œå¤„ç†æ–°åˆ°æ¥å…¥è¯·æ±‚ï¼Œå®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå»ºç«‹ç‰©ç†é“¾è·¯ã€‚<br>
Step 7ï¼šè®¾ç½®å®¢æˆ·ç«¯é“¾è·¯ä¸ºéé˜»å¡æ¨¡å¼<br>
Step 8ï¼šå°†æ–°æ¥å…¥åˆ°åº“æŠ¤çŸ­æ³¨å†Œåˆ°Reactorçº¿ç¨‹åˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œç›‘å¬è¯»æ“ä½œï¼Œè¯»å–å®¢æˆ·ç«¯å‘é€åˆ°ç½‘ç»œæ¶ˆæ¯ã€‚<br>
Step 9ï¼šå¼‚æ­¥è¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯åˆ°ç¼“å†²åŒºã€‚<br>
Step 10ï¼šå¯¹ByteBufferè¿›è¡Œç¼–è§£ç ï¼Œå¦‚æœæœ‰åŠåŒ…æ¶ˆæ¯æŒ‡é’ˆresetï¼Œç»§ç»­è¯»å–åç»­å¯¹è±¹çº¹ï¼Œå°†è§£ç æˆåŠŸå¯¹æ¶ˆæ¯å°è£…æˆtaskï¼ŒæŠ•é€’åˆ°ä¸šåŠ¡çº¿ç¨‹æ± ä¸­è¿›è¡Œä¸šåŠ¡é€»è¾‘ã€‚<br>
Step 11ï¼šå°†POJOå¯¹è±¡encodeæˆByteBufferï¼Œè°ƒç”¨SocketChannelåˆ°å¼‚æ­¥writeæ¥å£ï¼Œå°†æ¶ˆæ¯å¼‚æ­¥å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>âš ï¸æ³¨æ„ï¼šå¦‚æœå‘é€åŒºTcpç¼“å†²åŒºæ»¡ï¼Œä¼šå¯¼è‡´å†™åŠåŒ…ï¼Œæ­¤æ—¶éœ€è¦æ³¨å†Œç›‘å¬å†™æ“ä½œä½ï¼Œå¾ªç¯å†™ç›´åˆ°æ•´åŒ…æ¶ˆæ¯å†™å…¥ç¼“å†²åŒºã€‚</p>
<h4 id="233-nioå®¢æˆ·ç«¯">2.3.3 NIOå®¢æˆ·ç«¯</h4>
<figure data-type="image" tabindex="7"><img src="https://q456qq520.github.io/post-images/1665655179085.png" alt="NIOå®¢æˆ·ç«¯" loading="lazy"></figure>
<p>Step 1ï¼šæ‰“å¼€ServerSocketChannelï¼Œç»‘å®šå®¢æˆ·ç«¯æœ¬åœ°åœ°å€ã€‚<br>
Step 2ï¼šè®¾ç½®SocketChannelä¸ºéé˜»å¡æ¨¡å¼ï¼ŒåŒæ—¶è®¾ç½®å®¢æˆ·ç«¯è¿æ¥çš„Tcpå‚æ•°ã€‚<br>
Step 3ï¼šå¼‚æ­¥è¿æ¥æœåŠ¡ç«¯ã€‚<br>
Step 4ï¼šåˆ¤æ–­æ˜¯å¦è¿æ¥æˆåŠŸï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥æ³¨å†Œè¯»çŠ¶æ€åˆ°å¤šè·¯å¤ç”¨å™¨ä¸­ã€‚<br>
Step 5ï¼šå‘Reactorçº¿ç¨‹çš„å¤šè·¯å¤ç”¨å™¨æ³¨å†ŒOP_CONNECTçŠ¶æ€ä½ï¼Œç›‘å¬æœåŠ¡ç«¯çš„TCP ACkåº”ç­”ã€‚<br>
Step 6ï¼šåˆ›å»ºReactorçº¿ç¨‹ï¼Œåˆ›å»ºå¤šè·¯å¤ç”¨å™¨å¹¶å¯åŠ¨çº¿ç¨‹ã€‚<br>
Step 7ï¼šå¤šè·¯å¤ç”¨å™¨åœ¨çº¿ç¨‹runæ–¹æ³•çš„æ— é™å¾ªç¯ä½“å†…è½®è¯¢å‡†å¤‡å°±ç»ªçš„keyã€‚<br>
Step 8ï¼šæ¥æ”¶connectäº‹ä»¶è¿›è¡Œå¤„ç†ã€‚<br>
Step 9ï¼šåˆ¤æ–­è¿æ¥ç»“æœï¼Œå¦‚æœæˆåŠŸæ³¨å†Œè¯»æ—¶é—´åˆ°å¤šè·¯å¤ç”¨å™¨ã€‚<br>
Step 10ï¼šæ³¨å†Œè¯»äº‹ä»¶åˆ°å¤šè·¯å¤ç”¨å™¨ã€‚<br>
Step 11ï¼šå¼‚æ­¥è¯»å®¢æˆ·ç«¯è¯·æ±‚åˆ°ç¼“å†²åŒºã€‚<br>
Step 10ï¼šå¯¹ByteBufferè¿›è¡Œç¼–è§£ç ï¼Œå¦‚æœæœ‰åŠåŒ…æ¶ˆæ¯æŒ‡é’ˆresetï¼Œç»§ç»­è¯»å–åç»­å¯¹è±¹çº¹ï¼Œå°†è§£ç æˆåŠŸå¯¹æ¶ˆæ¯å°è£…æˆtaskï¼ŒæŠ•é€’åˆ°ä¸šåŠ¡çº¿ç¨‹æ± ä¸­è¿›è¡Œä¸šåŠ¡é€»è¾‘ã€‚<br>
Step 11ï¼šå°†POJOå¯¹è±¡encodeæˆByteBufferï¼Œè°ƒç”¨SocketChannelåˆ°å¼‚æ­¥writeæ¥å£ï¼Œå°†æ¶ˆæ¯å¼‚æ­¥å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æ€»ç»“ï¼š<br>
1ï¼‰å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œå¯ä»¥é€šè¿‡å¤šè·¯å¤ç”¨å™¨æ³¨å†ŒOP_CONNECTç­‰å¸¦åç»­ç»“æœï¼Œä¸éœ€è¦åƒä¹‹å‰ä¸€æ ·è¢«åŒæ­¥é˜»å¡ã€‚<br>
2ï¼‰SocketChannelçš„è¯»å†™æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœæ²¡æœ‰å¯è¯»å†™çš„æ•°æ®å®ƒä¸ä¼šåŒæ­¥ç­‰å¾…ï¼Œç›´æ¥è¿”å›ã€‚è¿™æ ·I/Oé€šä¿¡çº¿ç¨‹å°±å¯ä»¥å¤„ç†å…¶ä»–çš„é“¾è·¯æ— éœ€åŒæ­¥ç­‰å¾…ã€‚<br>
3ï¼‰çº¿ç¨‹æ¨¡å‹çš„ä¼˜åŒ–ï¼šæ²¡æœ‰è¿æ¥å¥æŸ„æ•°</p>
<h3 id="24-aioæ–°å¼‚æ­¥éé˜»å¡ioç¼–ç¨‹">2.4 AIOï¼ˆæ–°å¼‚æ­¥éé˜»å¡IOï¼‰ç¼–ç¨‹</h3>
<p>AIOä¸ºUNIXç½‘ç»œç¼–ç¨‹ä¸­çš„äº‹ä»¶é©±åŠ¨I/Oï¼Œå®ƒä¸éœ€è¦å¤šè·¯å¤ç”¨å™¨å¯¹æ³¨å†Œå¯¹é€šé“è¿›è¡Œè½®è¯¢æ“ä½œå³å¯å®ç°å¼‚æ­¥è¯»å†™ï¼Œä»è€Œç®€åŒ–NIOå¯¹ç¼–ç¨‹æ¨¡å‹ã€‚</p>
<h3 id="25-4ç§ioçš„å¯¹æ¯”">2.5 4ç§I/Oçš„å¯¹æ¯”</h3>
<h4 id="251-ä¸åŒioæ¨¡å‹å¯¹æ¯”">2.5.1 ä¸åŒI/Oæ¨¡å‹å¯¹æ¯”</h4>
<table>
<thead>
<tr>
<th>-</th>
<th style="text-align:center">åŒæ­¥é˜»å¡I/Oï¼ˆBIOï¼‰</th>
<th style="text-align:right">ä¼ªå¼‚æ­¥I/O</th>
<th style="text-align:right">éé˜»å¡I/Oï¼ˆNIOï¼‰</th>
<th style="text-align:right">å¼‚æ­¥I/Oï¼ˆAIOï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®¢æˆ·ç«¯ä¸ªæ•°ï¼šI/Oçº¿ç¨‹</td>
<td style="text-align:center">1:1</td>
<td style="text-align:right">Mï¼šN</td>
<td style="text-align:right">Mï¼š1</td>
<td style="text-align:right">Mï¼š0ï¼ˆä¸éœ€è¦å¯åŠ¨é¢å¤–çš„I/Oçº¿ç¨‹ï¼Œè¢«åŠ¨å›è°ƒï¼‰</td>
</tr>
<tr>
<td>I/Oç±»å‹</td>
<td style="text-align:center">é˜»å¡I/O</td>
<td style="text-align:right">é˜»å¡I/O</td>
<td style="text-align:right">éé˜»å¡I/O</td>
<td style="text-align:right">éé˜»å¡I/O</td>
</tr>
<tr>
<td>I/Oç±»å‹ï¼ˆåŒæ­¥ï¼‰</td>
<td style="text-align:center">åŒæ­¥I/O</td>
<td style="text-align:right">åŒæ­¥I/O</td>
<td style="text-align:right">åŒæ­¥I/Oï¼ˆI/Oå¤šè·¯å¤ç”¨ï¼‰</td>
<td style="text-align:right">å¼‚æ­¥I/O</td>
</tr>
<tr>
<td>å¯é æ€§</td>
<td style="text-align:center">éå¸¸å·®</td>
<td style="text-align:right">å·®</td>
<td style="text-align:right">é«˜</td>
<td style="text-align:right">é«˜</td>
</tr>
<tr>
<td>ååé‡</td>
<td style="text-align:center">ä½</td>
<td style="text-align:right">ä¸­</td>
<td style="text-align:right">é«˜</td>
<td style="text-align:right">é«˜</td>
</tr>
</tbody>
</table>
<h2 id="3-nettyå…¥é—¨">3 Nettyå…¥é—¨</h2>
<h3 id="31-nettyæœåŠ¡ç«¯å¼€å‘">3.1 NettyæœåŠ¡ç«¯å¼€å‘</h3>
<p>ğŸ ä¾‹å­ï¼š</p>
<blockquote>
<p>æœåŠ¡ç«¯</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;

/**
 * æœåŠ¡ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:21
 */
public class TimeServer {

    public void bind(int port){
        //é…ç½®æœåŠ¡ç«¯nioçº¿ç¨‹ç»„,å¤„ç†ç½‘ç»œäº‹ä»¶
        EventLoopGroup boosGroup = new NioEventLoopGroup();//ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();//ç”¨äºè¿›è¡ŒSocketChannelç½‘ç»œè¯»å†™

        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 1024)
                    .childHandler(new ChildChannelHandler());

            //ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            //ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
            //é€€å‡º
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            boosGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    private class ChildChannelHandler extends ChannelInitializer&lt;SocketChannel&gt; {

        @Override
        protected void initChannel(SocketChannel socketChannel) throws Exception {
            socketChannel.pipeline().addLast(new TimeServerHandler());
        }
    }

    public static void main(String[] args) {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new TimeServer().bind(port);
    }
}
</code></pre>
<blockquote>
<p>æœåŠ¡ç«¯å…·ä½“æ“ä½œç±»</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerAdapter;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

import java.io.UnsupportedEncodingException;
import java.util.Date;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class TimeServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
        ByteBuf byteBuf = (ByteBuf) msg;

        byte[] req = new byte[byteBuf.readableBytes()];
        byteBuf.readBytes(req);

        String body = new String(req, &quot;UTF-8&quot;);
        System.out.println(&quot;The time server receive order :&quot; + body);

        String currentTime = &quot;QUERY TIME ORDER&quot;.equalsIgnoreCase(body) ? new Date(System.currentTimeMillis()).toString() : &quot;BAD ORDER&quot;;
        ByteBuf resp = Unpooled.copiedBuffer(currentTime.getBytes());

        //ä¸ºäº†æ•ˆç‡ï¼Œwriteå¹¶ä¸ç›´æ¥å°†æ¶ˆæ¯å†™å…¥åˆ°SocketChannelä¸­ï¼Œè°ƒç”¨writeæ–¹æ³•åªæ˜¯æŠŠå¾…å‘é€çš„æ¶ˆæ¯
        //æ”¾åˆ°å‘é€ç¼“å†²æ•°ç»„ä¸­ï¼Œå†è°ƒç”¨flushå‘é€
        ctx.write(resp);
        System.out.println(&quot;å†™å…¥å®Œæˆ&quot;);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        //å°†æ¶ˆæ¯å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å†™åˆ°SocketChannelä¸­å‘é€ç»™å¯¹æ–¹
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}
</code></pre>
<h3 id="32-nettyå®¢æˆ·ç«¯å¼€å‘">3.2 Nettyå®¢æˆ·ç«¯å¼€å‘</h3>
<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;

/**
 * å®¢æˆ·ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:06
 */
public class TimeClient {

    public void connect(int port ,String host) throws Exception {

        //é…ç½®nioçº¿ç¨‹ç»„
        EventLoopGroup group = new NioEventLoopGroup();

        try{
            Bootstrap b = new Bootstrap();
            b.group(group).channel(NioSocketChannel.class)
                    .option(ChannelOption.TCP_NODELAY, true)
                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            socketChannel.pipeline().addLast(new TimeClientHandler());
                        }
                    });

            //å‘èµ·å¼‚æ­¥è¿æ¥æ“ä½œ
            ChannelFuture f = b.connect(host, port).sync();
            //ç­‰å¾…å®¢æˆ·ç«¯é“¾è·¯å…³é—­
            f.channel().closeFuture().sync();
            //ä¼˜é›…é€€å‡ºï¼Œé‡Šæ”¾NIOçº¿ç¨‹ç»„
        }finally {
            group.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new TimeClient().connect(port,&quot;127.0.0.1&quot;);
    }
}
</code></pre>
<blockquote>
<p>å®¢æˆ·ç«¯å…·ä½“æ“ä½œç±»</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;


/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:09
 */
public class TimeClientHandler extends ChannelInboundHandlerAdapter {

    private final ByteBuf firstMessage;

    public TimeClientHandler() {
        byte[] req = &quot;QUERY TIME ORDER&quot;.getBytes();
        firstMessage = Unpooled.buffer(req.length);
        firstMessage.writeBytes(req);
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        ctx.writeAndFlush(firstMessage);
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception{
        ByteBuf byteBuf = (ByteBuf) msg;

        byte[] req = new byte[byteBuf.readableBytes()];
        byteBuf.readBytes(req);

        String body = new String(req, &quot;UTF-8&quot;);
        System.out.println(&quot;Now is :&quot; + body);

    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        System.out.println(&quot;é‡Šæ”¾èµ„æº&quot;);
        ctx.close();
    }
}
</code></pre>
<p>å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹TCPé“¾è·¯æˆåŠŸåï¼ŒNettyç«¯NIOçº¿ç¨‹ä¼šè°ƒç”¨channelActiveæ–¹æ³•ï¼Œå‘é€æŸ¥è¯¢æ—¶é—´ç«¯æŒ‡ä»¤ç»™æœåŠ¡ç«¯ï¼Œè°ƒç”¨writeAndFlushæ–¹æ³•å°†è¯·æ±‚æ¶ˆæ¯å‘é€ç»™æœåŠ¡ç«¯ã€‚</p>
<p>å½“æœåŠ¡ç«¯è¿”å›åº”ç­”æ¶ˆæ¯æ—¶ï¼ŒchannelReadæ–¹æ³•è¢«è°ƒç”¨ã€‚</p>
<h3 id="33-è¿è¡Œ">3.3 è¿è¡Œ</h3>
<blockquote>
<p>æ‰§è¡Œç»“æœ -&gt; æœåŠ¡ç«¯</p>
</blockquote>
<pre><code class="language-java">The time server receive order :QUERY TIME ORDER
å†™å…¥å®Œæˆ
</code></pre>
<blockquote>
<p>æ‰§è¡Œç»“æœ -&gt; å®¢æˆ·ç«¯</p>
</blockquote>
<pre><code class="language-java">Now is :Mon Oct 17 11:25:40 CST 2022
</code></pre>
<h2 id="4-tcpç²˜åŒ…æ‹†åŒ…é—®é¢˜">4 TCPç²˜åŒ…/æ‹†åŒ…é—®é¢˜</h2>
<h3 id="41-tcpç²˜åŒ…æ‹†åŒ…">4.1 TCPç²˜åŒ…/æ‹†åŒ…</h3>
<p>TCPæ˜¯ä¸ªâ€œæµâ€˜åè®®ï¼Œæ‰€è°“æµï¼Œå°±æ˜¯æ²¡æœ‰ç•Œé™çš„ä¸€ä¸²æ•°æ®ã€‚ä¸€ä¸ªå®Œæ•´çš„åŒ…å¯èƒ½ä¼šè¢«TCPæ‹†åˆ†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ï¼Œä¹Ÿæœ‰å¯èƒ½æŠŠå¤šä¸ªå°çš„åŒ…å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€ã€‚</p>
<h4 id="411-tcpç²˜åŒ…æ‹†åŒ…é—®é¢˜è¯´æ˜">4.1.1 TCPç²˜åŒ…/æ‹†åŒ…é—®é¢˜è¯´æ˜</h4>
<figure data-type="image" tabindex="8"><img src="https://q456qq520.github.io/post-images/1665978556282.png" alt="TCPç²˜åŒ…/æ‹†åŒ…" loading="lazy"></figure>
<p>TCPç²˜åŒ…/æ‹†åŒ…å…·ä½“åˆ†æå¦‚ä¸Šå›¾ï¼Œå‡è®¾å®¢æˆ·ç«¯åˆ†åˆ«å‘é€äº†2ä¸ªæ•°æ®åŒ…D1å’ŒD2ç»™æœåŠ¡ç«¯ï¼Œç”±äºæœåŠ¡ç«¯ä¸€æ¬¡è¯»å–åˆ°åˆ°å­—èŠ‚æ•°æ˜¯ä¸ç¡®å®šçš„ï¼Œæ•…å¯èƒ½å­˜åœ¨ä»¥ä¸‹4ç§æƒ…å†µã€‚</p>
<ol>
<li>æœåŠ¡ç«¯åˆ†2æ­¤è¯»å–åˆ°äº†2ä¸ªç‹¬ç«‹çš„æ•°æ®åŒ…ï¼Œåˆ†åˆ«æ˜¯D1å’ŒD2ï¼Œæ²¡æœ‰ç²˜åŒ…ï¼Œæ‹†åŒ…ã€‚</li>
<li>æœåŠ¡ç‚¹ä¸€æ¬¡æ¥æ”¶åˆ°äº†2ä¸ªæ•°æ®åŒ…ï¼ŒD1å’ŒD2ç²˜åˆåœ¨ä¸€èµ·ï¼Œè¢«ç§°ä¸ºTCPç²˜åŒ…ã€‚</li>
<li>æœåŠ¡ç‚¹åˆ†2æ¬¡è¯»å–åˆ°äº†2ä¸ªæ•°æ®åŒ…ï¼Œä¸€æ¬¡è¯»å–åˆ°äº†å®Œæ•´çš„D1å’ŒD2åŒ…çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼Œç¬¬äºŒæ¬¡è¯»å–åˆ°äº†D2åŒ…åˆ°å‰©ä½™å†…å®¹ï¼Œè¢«ç§°ä¸ºTCPæ‹†åŒ…ã€‚</li>
<li>æœåŠ¡ç«¯åˆ†2æ¬¡è¯»å–é“ç†2ä¸ªæ•°æ®åŒ…ï¼Œç¬¬ä¸€æ¬¡è¯»å–åˆ°äº†D1åŒ…çš„éƒ¨åˆ†å†…å®¹D1-1ï¼Œç¬¬äºŒæ¬¡è¯»å–åˆ°äº†D1åŒ…çš„å‰©ä½™å†…å®¹D1-2å’ŒD2åŒ…çš„æ•´åŒ…ã€‚</li>
</ol>
<p>å¦‚æœæ­¤æ—¶æœåŠ¡ç«¯TCPæ¥å—æ»‘çª—éå¸¸å°ï¼Œè€Œæ•°æ®åŒ…D1å’ŒD2æ¯”è¾ƒå¤§ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‘ç”Ÿç¬¬äº”ç§å¯èƒ½ï¼Œå³æœåŠ¡ç«¯åˆ†å¤šæ¬¡æ¬¡æ‰èƒ½å°†D1å’ŒD2åŒ…æ¥æ”¶å®Œå…¨ï¼ŒæœŸé—´å‘é€å¤šæ¬¡æ‹†åŒ…ã€‚</p>
<h4 id="412-tcpç²˜åŒ…æ‹†åŒ…å‘ç”Ÿçš„åŸå› ">4.1.2 TCPç²˜åŒ…/æ‹†åŒ…å‘ç”Ÿçš„åŸå› </h4>
<ol>
<li>åº”ç”¨ç¨‹åºwriteå†™å…¥çš„å­—èŠ‚å¤§å°å¤§äºå¥—æ¥å£å‘é€ç¼“å†²åŒºå¤§å°</li>
<li>è¿›è¡ŒMSSå¤§å°çš„TCPåˆ†æ®µ</li>
<li>ä»¥å¤ªç½‘å¸§çš„payloadå¤§äºMTUè¿›è¡ŒIPåˆ†ç‰‡</li>
</ol>
<h4 id="413-ç²˜åŒ…é—®é¢˜çš„è§£å†³ç­–ç•¥">4.1.3 ç²˜åŒ…é—®é¢˜çš„è§£å†³ç­–ç•¥</h4>
<p>TCPæ— æ³•ç†è§£ä¸Šå±‚ä¸šåŠ¡é€»è¾‘ï¼Œåªèƒ½é€šè¿‡ä¸Šå±‚åº”ç”¨åè®®æ ˆè®¾è®¡æ¥è§£å†³ï¼Œå¦‚ä¸‹ï¼š</p>
<ol>
<li>æ¶ˆæ¯å®šé•¿</li>
<li>åœ¨åŒ…å°¾å¢åŠ å›è½¦æ¢è¡Œç¬¦è¿›è¡Œåˆ†å‰²</li>
<li>å°†æ¶ˆæ¯åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯å¤´ä¸­åŒ…å«è¡¨ç¤ºæ¶ˆæ¯æ€»é•¿åº¦çš„å­—æ®µ</li>
<li>æ›´å¯Œåœ¨çš„åº”ç”¨å±‚åè®®</li>
</ol>
<p>æ¥ä¸‹æ¥çœ‹Nettyå¦‚æœè§£å†³TCPç²˜åŒ…/æ‹†åŒ…é—®é¢˜</p>
<h3 id="42-æœªè€ƒè™‘tcpç²˜åŒ…æ¡ˆä¾‹">4.2 æœªè€ƒè™‘TCPç²˜åŒ…æ¡ˆä¾‹</h3>
<h4 id="421-timeserveræ”¹é€ ">4.2.1 TimeServeræ”¹é€ </h4>
<p>æˆ‘ä»¬ç”¨ä¸Šé¢çš„ä¾‹å­å¤åˆ»ä¸€ä¸‹ç²˜åŒ…åœºæ™¯ã€‚</p>
<blockquote>
<p>TimeServerHandleræ”¹é€ </p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

import java.util.Date;

/**
 * ç²˜åŒ…
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class TimeServerApHandler extends ChannelInboundHandlerAdapter {

    private int counter;

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
        ByteBuf byteBuf = (ByteBuf) msg;

        byte[] req = new byte[byteBuf.readableBytes()];
        byteBuf.readBytes(req);

        String body = new String(req, &quot;UTF-8&quot;).substring(0,req.length - System.getProperty(&quot;line.separator&quot;).length());
        //æ¯è¯»åˆ°ä¸€æ¡æ¶ˆæ¯åå°±è®°ä¸€æ¬¡æ•°ï¼Œç„¶åå‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
        //æŒ‰ç…§è®¾è®¡ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ€»æ•°åº”è¯¥äºå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯æ€»æ•°ç›¸åŒ
        System.out.println(&quot;The time server receive order :&quot; + body + &quot;; the counter is : &quot; + ++counter);

        String currentTime = &quot;QUERY TIME ORDER&quot;.equalsIgnoreCase(body) ? new Date(System.currentTimeMillis()).toString() : &quot;BAD ORDER&quot;;

        currentTime = currentTime + System.getProperty(&quot;line.separator&quot;);
        ByteBuf resp = Unpooled.copiedBuffer(currentTime.getBytes());

        //ä¸ºäº†æ•ˆç‡ï¼Œwriteå¹¶ä¸ç›´æ¥å°†æ¶ˆæ¯å†™å…¥åˆ°SocketChannelä¸­ï¼Œè°ƒç”¨writeæ–¹æ³•åªæ˜¯æŠŠå¾…å‘é€çš„æ¶ˆæ¯
        //æ”¾åˆ°å‘é€ç¼“å†²æ•°ç»„ä¸­ï¼Œå†è°ƒç”¨flushå‘é€
        ctx.write(resp);
        System.out.println(&quot;å†™å…¥å®Œæˆ&quot;);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        //å°†æ¶ˆæ¯å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å†™åˆ°SocketChannelä¸­å‘é€ç»™å¯¹æ–¹
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}
</code></pre>
<h4 id="422-timeclienthandleræ”¹é€ ">4.2.2 TimeClientHandleræ”¹é€ </h4>
<blockquote>
<p>TimeClientHandleræ”¹é€ </p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;


/**
 * å®¢æˆ·ç«¯ç²˜åŒ…
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:09
 */
public class TimeClientApHandler extends ChannelInboundHandlerAdapter {

//    private final ByteBuf firstMessage;
    private int counter;
    private byte[] req;

    public TimeClientApHandler() {
       req = ( &quot;QUERY TIME ORDER&quot; + System.getProperty(&quot;line.separator&quot;) ).getBytes();
//        firstMessage = Unpooled.buffer(req.length);
//        firstMessage.writeBytes(req);
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx){
        ByteBuf message = null;
        for (int i = 0; i &lt; 100; i++) {
            message = Unpooled.buffer(req.length);
            message.writeBytes(req);
            ctx.writeAndFlush(message);
        }
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception{
        ByteBuf byteBuf = (ByteBuf) msg;

        byte[] req = new byte[byteBuf.readableBytes()];
        byteBuf.readBytes(req);

        String body = new String(req, &quot;UTF-8&quot;);
        System.out.println(&quot;Now is :&quot; + body + &quot;; the counter is :&quot; + ++counter);

    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        System.out.println(&quot;é‡Šæ”¾èµ„æº&quot;);
        ctx.close();
    }
}
</code></pre>
<h4 id="423-è¿è¡Œ">4.2.3 è¿è¡Œ</h4>
<blockquote>
<p>æ‰§è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">QUERY TIME ORDER; the counter is : 18

Now is :BAD ORDER
; the counter is :1
</code></pre>
<p>æœåŠ¡ç«¯è¿è¡Œç»“æœè¡¨æ˜ä»–æ²¡æœ‰æ¥æ”¶åˆ°100æ¡æ¶ˆæ¯ï¼Œè¯´æ˜å‘ç”Ÿäº†TCPç²˜åŒ…ã€‚</p>
<p>å®¢æˆ·ç«¯åº”è¯¥æ¥æ”¶åˆ°100æ¡å½“å‰æ—¶é—´åˆ°æ¶ˆæ¯ï¼Œä½†å®é™…ä¸Šåªæ¥æ”¶åˆ°äº†1æ¡ï¼Œè¯´æ˜æœåŠ¡ç«¯è¿”å›åº”ç­”æ¶ˆæ¯ä¹Ÿå‘ç”Ÿäº†ç²˜åŒ…ã€‚</p>
<p>å½“TCPç²˜åŒ…æ—¶ï¼Œæˆ‘ä»¬åˆ°ç¨‹åºå°±ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<h3 id="43-åˆ©ç”¨linebasedframedecoderè§£å†³tcpç²˜åŒ…é—®é¢˜">4.3 åˆ©ç”¨LineBasedFrameDecoderè§£å†³TCPç²˜åŒ…é—®é¢˜</h3>
<h4 id="431-æ”¯æŒtcpç²˜åŒ…çš„timeserver">4.3.1 æ”¯æŒTCPç²˜åŒ…çš„TimeServer</h4>
<p>Nettyé»˜è®¤æä¾›äº†å¤šç§ç¼–è§£ç å™¨ç”¨äºå¤„ç†åŠåŒ…é—®é¢˜ã€‚</p>
<blockquote>
<p>TimeServer</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.LineBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * æœåŠ¡ç«¯ï¼ˆæ”¯æŒç²˜åŒ…ï¼‰
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:21
 */
public class TimeApServer {

    public void bind(int port){
        //é…ç½®æœåŠ¡ç«¯nioçº¿ç¨‹ç»„,å¤„ç†ç½‘ç»œäº‹ä»¶
        EventLoopGroup boosGroup = new NioEventLoopGroup();//ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();//ç”¨äºè¿›è¡ŒSocketChannelç½‘ç»œè¯»å†™

        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 1024)
                    .childHandler(new ChildChannelHandler());

            //ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            //ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
            //é€€å‡º
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            boosGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    private class ChildChannelHandler extends ChannelInitializer&lt;SocketChannel&gt; {

        @Override
        protected void initChannel(SocketChannel socketChannel) throws Exception {
            socketChannel.pipeline().addLast(new LineBasedFrameDecoder(1024));
            socketChannel.pipeline().addLast(new StringDecoder());
            socketChannel.pipeline().addLast(new TimeServerApHandler());
        }
    }

    public static void main(String[] args) {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new TimeApServer().bind(port);
    }
}

</code></pre>
<blockquote>
<p>TimeServerApHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

import java.util.Date;

/**
 * ç²˜åŒ…
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class TimeServerApHandler extends ChannelInboundHandlerAdapter {

    private int counter;

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
        String body = (String) msg;
        //æ¯è¯»åˆ°ä¸€æ¡æ¶ˆæ¯åå°±è®°ä¸€æ¬¡æ•°ï¼Œç„¶åå‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
        //æŒ‰ç…§è®¾è®¡ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ€»æ•°åº”è¯¥äºå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯æ€»æ•°ç›¸åŒ
        System.out.println(&quot;The time server receive order :&quot; + body + &quot;; the counter is : &quot; + ++counter);

        String currentTime = &quot;QUERY TIME ORDER&quot;.equalsIgnoreCase(body) ? new Date(System.currentTimeMillis()).toString() : &quot;BAD ORDER&quot;;

        currentTime = currentTime + System.getProperty(&quot;line.separator&quot;);
        ByteBuf resp = Unpooled.copiedBuffer(currentTime.getBytes());

        //ä¸ºäº†æ•ˆç‡ï¼Œwriteå¹¶ä¸ç›´æ¥å°†æ¶ˆæ¯å†™å…¥åˆ°SocketChannelä¸­ï¼Œè°ƒç”¨writeæ–¹æ³•åªæ˜¯æŠŠå¾…å‘é€çš„æ¶ˆæ¯
        //æ”¾åˆ°å‘é€ç¼“å†²æ•°ç»„ä¸­ï¼Œå†è°ƒç”¨flushå‘é€
        ctx.write(resp);
        System.out.println(&quot;å†™å…¥å®Œæˆ&quot;);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        //å°†æ¶ˆæ¯å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å†™åˆ°SocketChannelä¸­å‘é€ç»™å¯¹æ–¹
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}

</code></pre>
<h4 id="432-æ”¯æŒtcpç²˜åŒ…çš„tcpclient">4.3.2 æ”¯æŒTCPç²˜åŒ…çš„TcpClient</h4>
<blockquote>
<p>TimeApClient</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.LineBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * ç²˜åŒ…å®¢æˆ·ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:06
 */
public class TimeApClient {

    public void connect(int port ,String host) throws Exception {

        //é…ç½®nioçº¿ç¨‹ç»„
        EventLoopGroup group = new NioEventLoopGroup();

        try{
            Bootstrap b = new Bootstrap();
            b.group(group).channel(NioSocketChannel.class)
                    .option(ChannelOption.TCP_NODELAY, true)
                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            socketChannel.pipeline().addLast(new LineBasedFrameDecoder(1024));
                            socketChannel.pipeline().addLast(new StringDecoder());
                            socketChannel.pipeline().addLast(new TimeClientApHandler());
                        }
                    });

            //å‘èµ·å¼‚æ­¥è¿æ¥æ“ä½œ
            ChannelFuture f = b.connect(host, port).sync();
            //ç­‰å¾…å®¢æˆ·ç«¯é“¾è·¯å…³é—­
            f.channel().closeFuture().sync();
            //ä¼˜é›…é€€å‡ºï¼Œé‡Šæ”¾NIOçº¿ç¨‹ç»„
        }finally {
            group.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new TimeApClient().connect(port,&quot;127.0.0.1&quot;);
    }
}

</code></pre>
<blockquote>
<p>TimeClientApHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.book;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;


/**
 * å®¢æˆ·ç«¯ç²˜åŒ…
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:09
 */
public class TimeClientApHandler extends ChannelInboundHandlerAdapter {

//    private final ByteBuf firstMessage;
    private int counter;
    private byte[] req;

    public TimeClientApHandler() {
       req = ( &quot;QUERY TIME ORDER&quot; + System.getProperty(&quot;line.separator&quot;) ).getBytes();
//        firstMessage = Unpooled.buffer(req.length);
//        firstMessage.writeBytes(req);
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx){
        ByteBuf message = null;
        for (int i = 0; i &lt; 100; i++) {
            message = Unpooled.buffer(req.length);
            message.writeBytes(req);
            ctx.writeAndFlush(message);
        }
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception{
        String body = (String) msg;
        System.out.println(&quot;Now is :&quot; + body + &quot;; the counter is :&quot; + ++counter);

    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        System.out.println(&quot;é‡Šæ”¾èµ„æº&quot;);
        ctx.close();
    }
}

</code></pre>
<h4 id="433-è¿è¡Œ">4.3.3 è¿è¡Œ</h4>
<blockquote>
<p>æœåŠ¡ç«¯</p>
</blockquote>
<pre><code class="language-java">The time server receive order :QUERY TIME ORDER; the counter is : 100
å†™å…¥å®Œæˆ
</code></pre>
<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<pre><code class="language-java">Now is :Mon Oct 17 15:41:57 CST 2022; the counter is :98
Now is :Mon Oct 17 15:41:57 CST 2022; the counter is :99
Now is :Mon Oct 17 15:41:57 CST 2022; the counter is :100
</code></pre>
<h4 id="434-linebasedframedecoder-å’Œ-stringdecoderåŸç†åˆ†æ">4.3.4 LineBasedFrameDecoder å’Œ StringDecoderåŸç†åˆ†æ</h4>
<p>LineBasedFrameDecoderçš„å·¥ä½œåŸç†æ˜¯å®ƒä¸€æ¬¡éå†ByteBufçš„å¯è¯»å­—èŠ‚ï¼Œåˆ¤æ–­çœ‹æ˜¯å¦æœ‰\næˆ–è€…\r\nï¼Œå¦‚æœæœ‰å°±ä»¥æ¬¡ä½ç½®ä¸ºç»“æŸä½ç½®ï¼Œä»å¯è¯»ç´¢å¼•åˆ°ç»“æŸä½ç½®åŒºé—´çš„å­—èŠ‚å°±ç»„æˆäº†ä¸€è¡Œã€‚</p>
<p>å®ƒæ˜¯ä»¥æ¢è¡Œç¬¦ä¸ºç»“æŸæ ‡å¿—çš„è§£ç å™¨ï¼Œæ”¯æŒæºå¸¦ç»“æŸç¬¦æˆ–è€…ä¸æºå¸¦ç»“æŸç¬¦2ç§è§£ç æ–¹å¼ï¼ŒåŒæ—¶æ”¯æŒé…ç½®ä½†è¡Œæœ€å¤§é•¿åº¦ã€‚å¦‚æœè¿ç»­è¯»å–åˆ°æœ€å¤§é•¿åº¦åä»ç„¶æ²¡æœ‰å‡ºç°æ¢è¡Œç¬¦ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>StringDecoderçš„åŠŸèƒ½éå¸¸ç®€å•ï¼Œå°±æ˜¯å°†æ¥æ”¶åˆ°åˆ°å¯¹è±¡è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œç„¶åç»§ç»­è°ƒç”¨åç»­åˆ°Handlerã€‚</p>
<h2 id="5-åˆ†éš”ç¬¦å’Œå®šé•¿è§£ç å™¨åˆ°åº”ç”¨">5 åˆ†éš”ç¬¦å’Œå®šé•¿è§£ç å™¨åˆ°åº”ç”¨</h2>
<p>TCPä»¥æµçš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¸Šå±‚çš„åº”ç”¨åè®®ä¸ºäº†å¯¹æ¶ˆæ¯è¿›è¡ŒåŒºåˆ†ï¼Œä¸€èˆ¬é‡‡ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p>
<ol>
<li>æ¶ˆæ¯é•¿åº¦å›ºå®šï¼Œç´¯è®¡è¯»å–åˆ°é•¿åº¦æ€»å’Œä¸ºå®šé•¿LENçš„æŠ¥æ–‡åï¼Œå°±è®¤ä¸ºè¯»å–åˆ°äº†ä¸€ä¸ªå®Œæ•´åˆ°æ¶ˆæ¯ï¼Œç„¶åå°†è®¡æ•°å™¨ç½®ä½ï¼Œé‡æ–°å¼€å§‹è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®æŠ¥ã€‚</li>
<li>å°†å›è½¦æ¢è¡Œç¬¦ä½œä¸ºæ¶ˆæ¯ç»“æŸç¬¦</li>
<li>å°†ç‰¹æ®Šåˆ°åˆ†éš”ç¬¦ä½œä¸ºæ¶ˆæ¯åˆ°ç»“æŸæ ‡å¿—</li>
<li>é€šè¿‡åœ¨æ¶ˆæ¯å¤´ä¸­å®šä¹‰é•¿åº¦å­—æ®µæ¥è¡¨ç¤ºæ¶ˆæ¯åˆ°æ€»é•¿åº¦</li>
</ol>
<p>Nettyå¯¹ä¸Šé¢4ç§åšäº†ç»Ÿä¸€æŠ½è±¡ï¼Œæä¾›äº†4ç§è§£ç å™¨æ¥è§£å†³å¯¹åº”å¯¹é—®é¢˜ã€‚ä¸Šè¿°ä½¿ç”¨LineBasedFrameDecoder å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œè¿˜æœ‰<strong>DelimiterBasedFrameDecoder</strong>ç”¨äºè‡ªåŠ¨å®Œæˆä»¥åˆ†éš”ç¬¦åšç»“æŸæ ‡å¿—å¯¹è§£ç ï¼Œ<strong>FixedLengthFrameDecoder</strong>ç”¨äºè‡ªåŠ¨å®Œæˆå¯¹å®šé•¿æ¶ˆæ¯å¯¹è§£ç ã€‚</p>
<h3 id="51-delimiterbasedframedecoderåº”ç”¨å¼€å‘">5.1 DelimiterBasedFrameDecoderåº”ç”¨å¼€å‘</h3>
<p>ğŸ ä¾‹å­ï¼šæœ¬ä¾‹å°†ä»¥$_ä½œä¸ºåˆ†éš”ç¬¦</p>
<h4 id="511-delimiterbasedframedecoderæœåŠ¡ç«¯å¼€å‘">5.1.1 DelimiterBasedFrameDecoderæœåŠ¡ç«¯å¼€å‘</h4>
<blockquote>
<p>EchoServer</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.echo;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.DelimiterBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * ECHOæœåŠ¡ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:21
 */
public class EchoServer {

    public void bind(int port){
        //é…ç½®æœåŠ¡ç«¯nioçº¿ç¨‹ç»„,å¤„ç†ç½‘ç»œäº‹ä»¶
        EventLoopGroup boosGroup = new NioEventLoopGroup();//ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();//ç”¨äºè¿›è¡ŒSocketChannelç½‘ç»œè¯»å†™

        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 1024)
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel channel) throws Exception {
                            ByteBuf delimiter = Unpooled.copiedBuffer(&quot;$_&quot;.getBytes());
                            //å•ä½“æ¶ˆæ¯æœ€å¤§é•¿åº¦1024ï¼Œå½“è¾¾åˆ°è¯¥é•¿åº¦åä»ç„¶æ²¡æœ‰æŸ¥æ‰¾åˆ°åˆ†éš”ç¬¦å°±æŠ›å‡ºå¼‚å¸¸
                            channel.pipeline().addLast(new DelimiterBasedFrameDecoder(1024, delimiter));
                            channel.pipeline().addLast(new StringDecoder());//å°†ByteBufè§£ç æˆå­—ç¬¦ä¸²å¯¹è±¡
                            channel.pipeline().addLast(new EchoServerHandler());//æ¥æ”¶æ¶ˆæ¯
                        }
                    });

            //ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            //ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
            //é€€å‡º
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            boosGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new EchoServer().bind(port);
    }
}

</code></pre>
<blockquote>
<p>EchoServerHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.echo;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

import java.util.Date;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class EchoServerHandler extends ChannelInboundHandlerAdapter {
    private int counter = 0;

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
        String body = (String) msg;
        System.out.println(&quot;This is&quot; + ++counter + &quot;The time server receive client :&quot; + body);

        body += &quot;$_&quot;;
        ByteBuf echo = Unpooled.copiedBuffer(body.getBytes());
        ctx.write(echo);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}

</code></pre>
<h4 id="512-delimiterbasedframedecoderå®¢æˆ·ç«¯å¼€å‘">5.1.2 DelimiterBasedFrameDecoderå®¢æˆ·ç«¯å¼€å‘</h4>
<blockquote>
<p>EchoClient</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.echo;

import io.netty.bootstrap.Bootstrap;
import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.DelimiterBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * ECHOå®¢æˆ·ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:06
 */
public class EchoClient {

    public void connect(int port ,String host) throws Exception {

        //é…ç½®nioçº¿ç¨‹ç»„
        EventLoopGroup group = new NioEventLoopGroup();

        try{
            Bootstrap b = new Bootstrap();
            b.group(group).channel(NioSocketChannel.class)
                    .option(ChannelOption.TCP_NODELAY, true)
                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            ByteBuf delimiter = Unpooled.copiedBuffer(&quot;$_&quot;.getBytes());
                            //å•ä½“æ¶ˆæ¯æœ€å¤§é•¿åº¦1024ï¼Œå½“è¾¾åˆ°è¯¥é•¿åº¦åä»ç„¶æ²¡æœ‰æŸ¥æ‰¾åˆ°åˆ†éš”ç¬¦å°±æŠ›å‡ºå¼‚å¸¸
                            socketChannel.pipeline().addLast(new DelimiterBasedFrameDecoder(1024, delimiter));
                            socketChannel.pipeline().addLast(new StringDecoder());//å°†ByteBufè§£ç æˆå­—ç¬¦ä¸²å¯¹è±¡
                            socketChannel.pipeline().addLast(new EchoClientHandler());//æ¥æ”¶æ¶ˆæ¯
                        }
                    });

            //å‘èµ·å¼‚æ­¥è¿æ¥æ“ä½œ
            ChannelFuture f = b.connect(host, port).sync();
            //ç­‰å¾…å®¢æˆ·ç«¯é“¾è·¯å…³é—­
            f.channel().closeFuture().sync();
            //ä¼˜é›…é€€å‡ºï¼Œé‡Šæ”¾NIOçº¿ç¨‹ç»„
        }finally {
            group.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new EchoClient().connect(port,&quot;127.0.0.1&quot;);
    }
}
</code></pre>
<blockquote>
<p>EchoClientHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.echo;

import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;


/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 11:09
 */
public class EchoClientHandler extends ChannelInboundHandlerAdapter {

    private int counter;
    static final String ECHO_REQ = &quot;Hi LIKECAT,Welcome to my home.$_&quot;;

    public EchoClientHandler() {
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx){
        for (int i = 0; i &lt; 10; i++) {
            ctx.writeAndFlush(Unpooled.copiedBuffer(ECHO_REQ.getBytes()));
        }
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg){
        System.out.println(&quot;This is&quot; + ++counter + &quot;The times  receive server : [&quot; + msg + &quot;]&quot;);

    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,Throwable cause){
        ctx.close();
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        ctx.flush();
    }
}
</code></pre>
<h4 id="513-delimiterbasedframedecoderè¿è¡Œ">5.1.3 DelimiterBasedFrameDecoderè¿è¡Œ</h4>
<blockquote>
<p>æ‰§è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">This is1The time server receive client :Hi LIKECAT,Welcome to my home.
This is2The time server receive client :Hi LIKECAT,Welcome to my home.
This is3The time server receive client :Hi LIKECAT,Welcome to my home.
This is4The time server receive client :Hi LIKECAT,Welcome to my home.
This is5The time server receive client :Hi LIKECAT,Welcome to my home.
This is6The time server receive client :Hi LIKECAT,Welcome to my home.
This is7The time server receive client :Hi LIKECAT,Welcome to my home.
This is8The time server receive client :Hi LIKECAT,Welcome to my home.
This is9The time server receive client :Hi LIKECAT,Welcome to my home.
This is10The time server receive client :Hi LIKECAT,Welcome to my home.

</code></pre>
<p>å¦‚æœæ²¡æœ‰ä½¿ç”¨DelimiterBasedFrameDecoderåˆ™ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼Œå› ä¸ºæœåŠ¡ç«¯ä¸€æ¬¡è¯»å–äº†å®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œå¯¼è‡´TCPç²˜åŒ…æ‹†åŒ…é—®é¢˜çš„å‡ºç°ã€‚</p>
<blockquote>
<p>æ‰§è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">This is1The time server receive client :Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_Hi LIKECAT,Welcome to my home.$_
</code></pre>
<h3 id="52-fixedlengthframedecoderåº”ç”¨å¼€å‘">5.2 FixedLengthFrameDecoderåº”ç”¨å¼€å‘</h3>
<p>FixedLengthFrameDecoderæ˜¯å›ºå®šé•¿åº¦è§£ç å™¨ã€‚æ— è®ºä¸€æ¬¡æ¥æ”¶åˆ°å¤šå°‘æ•°æ®åŒ…ï¼Œå®ƒéƒ½ä¼šæŒ‰ç…§æ„é€ å‡½æ•°ä¸­è®¾ç½®éƒ½å›ºå®šé•¿åº¦è¿›è¡Œè§£ç ï¼Œå¦‚æœæ˜¯åŠåŒ…æ¶ˆæ¯ï¼Œåˆ™ä¼šç¼“å­˜åŠåŒ…æ¶ˆæ¯å¹¶ç­‰å¾…ä¸‹ä¸ªåŒ…åˆ°è¾¾åè¿›è¡Œæ‹¼åŒ…ï¼ŒçŸ¥é“è¯»å–ä¸€ä¸ªå®Œæ•´çš„åŒ…ã€‚</p>
<h4 id="521-fixedlengthframedecoderæœåŠ¡ç«¯å¼€å‘">5.2.1 FixedLengthFrameDecoderæœåŠ¡ç«¯å¼€å‘</h4>
<p>åœ¨æœåŠ¡ç«¯ä¸­æ–°å¢FixedLengthFrameDecoderï¼Œé•¿åº¦è®¾ç½®ä¸º20ã€‚</p>
<blockquote>
<p>FixedServer</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.fixed;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.FixedLengthFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;

/**
 * å®šé•¿è§£ç æœåŠ¡ç«¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:21
 */
public class FixedServer {

    public void bind(int port){
        //é…ç½®æœåŠ¡ç«¯nioçº¿ç¨‹ç»„,å¤„ç†ç½‘ç»œäº‹ä»¶
        EventLoopGroup boosGroup = new NioEventLoopGroup();//ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();//ç”¨äºè¿›è¡ŒSocketChannelç½‘ç»œè¯»å†™

        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 100)
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                        @Override
                        protected void initChannel(SocketChannel channel) throws Exception {
                            channel.pipeline().addLast(new FixedLengthFrameDecoder(20));
                            channel.pipeline().addLast(new StringDecoder());//å°†ByteBufè§£ç æˆå­—ç¬¦ä¸²å¯¹è±¡
                            channel.pipeline().addLast(new FixedServerHandler());//æ¥æ”¶æ¶ˆæ¯
                        }
                    });

            //ç»‘å®šç«¯å£ï¼ŒåŒæ­¥ç­‰å¾…æˆåŠŸ
            ChannelFuture f = b.bind(port).sync();
            //ç­‰å¾…æœåŠ¡ç«¯ç›‘å¬ç«¯å£å…³é—­
            f.channel().closeFuture().sync();
            //é€€å‡º
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            boosGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) {
        int port = 8080;

        if(args != null &amp;&amp; args.length &gt; 0){
            try {
                port = Integer.valueOf(args[0]);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }

        new FixedServer().bind(port);
    }
}
</code></pre>
<blockquote>
<p>FixedServerHandler</p>
</blockquote>
<pre><code class="language-java">package com.likecat.netty.fixed;

import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/17 10:41
 */
public class FixedServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
//        String body = (String) msg;
        System.out.println(&quot;The receive client :&quot; + msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx){
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause){
        ctx.close();
    }
}
</code></pre>
<h4 id="522-fixedlengthframedecoderè¿è¡Œ">5.2.2 FixedLengthFrameDecoderè¿è¡Œ</h4>
<p>è¿™æ¬¡æˆ‘ä»¬é€šè¿‡å‘½ä»¤çš„å½¢å¼è¿è¡Œï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œå³å¯äºæœåŠ¡ç«¯é€šä¿¡ï¼š</p>
<pre><code class="language-mysql">telnet localhost 8080
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[è§‚å¯Ÿè€…æ¨¡å¼]]></title>
        <id>https://q456qq520.github.io/post/guan-cha-zhe-mo-shi/</id>
        <link href="https://q456qq520.github.io/post/guan-cha-zhe-mo-shi/">
        </link>
        <updated>2022-10-11T07:40:53.000Z</updated>
        <summary type="html"><![CDATA[<p>è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸ä½ å®šä¹‰ä¸€ç§è®¢é˜…æœºåˆ¶ï¼Œ å¯åœ¨å¯¹è±¡äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å¤šä¸ª â€œè§‚å¯Ÿâ€ è¯¥å¯¹è±¡çš„å…¶ä»–å¯¹è±¡ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸ä½ å®šä¹‰ä¸€ç§è®¢é˜…æœºåˆ¶ï¼Œ å¯åœ¨å¯¹è±¡äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å¤šä¸ª â€œè§‚å¯Ÿâ€ è¯¥å¯¹è±¡çš„å…¶ä»–å¯¹è±¡ã€‚</p>
<!-- more -->
<h2 id="1é—®é¢˜">1.é—®é¢˜</h2>
<p>å‡å¦‚ä½ æœ‰ä¸¤ç§ç±»å‹çš„å¯¹è±¡ï¼š â€‹ é¡¾å®¢å’Œ å•†åº— ã€‚ é¡¾å®¢å¯¹æŸä¸ªç‰¹å®šå“ç‰Œçš„äº§å“éå¸¸æ„Ÿå…´è¶£ ï¼ˆä¾‹å¦‚æœ€æ–°å‹å·çš„ iPhone æ‰‹æœºï¼‰ï¼Œ è€Œè¯¥äº§å“å¾ˆå¿«å°†ä¼šåœ¨å•†åº—é‡Œå‡ºå”®ã€‚</p>
<p>é¡¾å®¢å¯ä»¥æ¯å¤©æ¥å•†åº—çœ‹çœ‹äº§å“æ˜¯å¦åˆ°è´§ã€‚ ä½†å¦‚æœå•†å“å°šæœªåˆ°è´§æ—¶ï¼Œ ç»å¤§å¤šæ•°æ¥åˆ°å•†åº—çš„é¡¾å®¢éƒ½ä¼šç©ºæ‰‹è€Œå½’ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œ æ¯æ¬¡æ–°äº§å“åˆ°è´§æ—¶ï¼Œ å•†åº—å¯ä»¥å‘æ‰€æœ‰é¡¾å®¢å‘é€é‚®ä»¶ ï¼ˆå¯èƒ½ä¼šè¢«è§†ä¸ºåƒåœ¾é‚®ä»¶ï¼‰ã€‚ è¿™æ ·ï¼Œ éƒ¨åˆ†é¡¾å®¢å°±æ— éœ€åå¤å‰å¾€å•†åº—äº†ï¼Œ ä½†ä¹Ÿå¯èƒ½ä¼šæƒ¹æ¼å¯¹æ–°äº§å“æ²¡æœ‰å…´è¶£çš„å…¶ä»–é¡¾å®¢ã€‚</p>
<p>æˆ‘ä»¬ä¼¼ä¹é‡åˆ°äº†ä¸€ä¸ªçŸ›ç›¾ï¼š è¦ä¹ˆè®©é¡¾å®¢æµªè´¹æ—¶é—´æ£€æŸ¥äº§å“æ˜¯å¦åˆ°è´§ï¼Œ è¦ä¹ˆè®©å•†åº—æµªè´¹èµ„æºå»é€šçŸ¥æ²¡æœ‰éœ€æ±‚çš„é¡¾å®¢ã€‚</p>
<h2 id="2è§£å†³æ–¹æ¡ˆ">2.è§£å†³æ–¹æ¡ˆ</h2>
<p>æ‹¥æœ‰ä¸€äº›å€¼å¾—å…³æ³¨çš„çŠ¶æ€çš„å¯¹è±¡é€šå¸¸è¢«ç§°ä¸ºç›®æ ‡ï¼Œç”±äºå®ƒè¦å°†è‡ªèº«çš„çŠ¶æ€æ”¹å˜é€šçŸ¥ç»™å…¶ä»–å¯¹è±¡ï¼Œ æˆ‘ä»¬ä¹Ÿå°†å…¶ç§°ä¸º<strong>å‘å¸ƒè€…</strong>ï¼ˆpubÂ­lishÂ­erï¼‰ã€‚ æ‰€æœ‰å¸Œæœ›å…³æ³¨å‘å¸ƒè€…çŠ¶æ€å˜åŒ–çš„å…¶ä»–å¯¹è±¡è¢«ç§°ä¸º<strong>è®¢é˜…è€…</strong>ï¼ˆsubÂ­scribersï¼‰ã€‚</p>
<p>è§‚å¯Ÿè€…æ¨¡å¼å»ºè®®ä½ ä¸ºå‘å¸ƒè€…ç±»æ·»åŠ è®¢é˜…æœºåˆ¶ï¼Œ è®©æ¯ä¸ªå¯¹è±¡éƒ½èƒ½è®¢é˜…æˆ–å–æ¶ˆè®¢é˜…å‘å¸ƒè€…äº‹ä»¶æµã€‚ ä¸è¦å®³æ€•ï¼ è¿™å¹¶ä¸åƒå¬ä¸Šå»é‚£ä¹ˆå¤æ‚ã€‚ å®é™…ä¸Šï¼Œ è¯¥æœºåˆ¶åŒ…æ‹¬ 1ï¼‰ ä¸€ä¸ªç”¨äºå­˜å‚¨è®¢é˜…è€…å¯¹è±¡å¼•ç”¨çš„åˆ—è¡¨æˆå‘˜å˜é‡ï¼› 2ï¼‰ å‡ ä¸ªç”¨äºæ·»åŠ æˆ–åˆ é™¤è¯¥åˆ—è¡¨ä¸­è®¢é˜…è€…çš„å…¬æœ‰æ–¹æ³•ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://refactoringguru.cn/images/patterns/diagrams/observer/solution1-zh-2x.png" alt="è®¢é˜…æœºåˆ¶å…è®¸å¯¹è±¡è®¢é˜…äº‹ä»¶é€šçŸ¥" loading="lazy"></figure>
<p>è®¢é˜…æœºåˆ¶å…è®¸å¯¹è±¡è®¢é˜…äº‹ä»¶é€šçŸ¥ã€‚</p>
<p>ç°åœ¨ï¼Œ æ— è®ºä½•æ—¶å‘ç”Ÿäº†é‡è¦çš„å‘å¸ƒè€…äº‹ä»¶ï¼Œ å®ƒéƒ½è¦éå†è®¢é˜…è€…å¹¶è°ƒç”¨å…¶å¯¹è±¡çš„ç‰¹å®šé€šçŸ¥æ–¹æ³•ã€‚</p>
<p>å®é™…åº”ç”¨ä¸­å¯èƒ½ä¼šæœ‰åå‡ ä¸ªä¸åŒçš„è®¢é˜…è€…ç±»è·Ÿè¸ªç€åŒä¸€ä¸ªå‘å¸ƒè€…ç±»çš„äº‹ä»¶ï¼Œ ä½ ä¸ä¼šå¸Œæœ›å‘å¸ƒè€…ä¸æ‰€æœ‰è¿™äº›ç±»ç›¸è€¦åˆçš„ã€‚ æ­¤å¤–å¦‚æœä»–äººä¼šä½¿ç”¨å‘å¸ƒè€…ç±»ï¼Œ é‚£ä¹ˆä½ ç”šè‡³å¯èƒ½ä¼šå¯¹å…¶ä¸­çš„ä¸€äº›ç±»ä¸€æ— æ‰€çŸ¥ã€‚</p>
<p>å› æ­¤ï¼Œ æ‰€æœ‰è®¢é˜…è€…éƒ½å¿…é¡»å®ç°åŒæ ·çš„æ¥å£ï¼Œ å‘å¸ƒè€…ä»…é€šè¿‡è¯¥æ¥å£ä¸è®¢é˜…è€…äº¤äº’ã€‚ æ¥å£ä¸­å¿…é¡»å£°æ˜é€šçŸ¥æ–¹æ³•åŠå…¶å‚æ•°ï¼Œ è¿™æ ·å‘å¸ƒè€…åœ¨å‘å‡ºé€šçŸ¥æ—¶è¿˜èƒ½ä¼ é€’ä¸€äº›ä¸Šä¸‹æ–‡æ•°æ®ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://refactoringguru.cn/images/patterns/diagrams/observer/solution2-zh-2x.png" alt="è®¢é˜…æœºåˆ¶å…è®¸å¯¹è±¡è®¢é˜…äº‹ä»¶é€šçŸ¥" loading="lazy"></figure>
<p>å‘å¸ƒè€…è°ƒç”¨è®¢é˜…è€…å¯¹è±¡ä¸­çš„ç‰¹å®šé€šçŸ¥æ–¹æ³•æ¥é€šçŸ¥è®¢é˜…è€…ã€‚</p>
<p>å¦‚æœä½ çš„åº”ç”¨ä¸­æœ‰å¤šä¸ªä¸åŒç±»å‹çš„å‘å¸ƒè€…ï¼Œ ä¸”å¸Œæœ›è®¢é˜…è€…å¯å…¼å®¹æ‰€æœ‰å‘å¸ƒè€…ï¼Œ é‚£ä¹ˆä½ ç”šè‡³å¯ä»¥è¿›ä¸€æ­¥è®©æ‰€æœ‰å‘å¸ƒè€…éµå¾ªåŒæ ·çš„æ¥å£ã€‚ è¯¥æ¥å£ä»…éœ€æè¿°å‡ ä¸ªè®¢é˜…æ–¹æ³•å³å¯ã€‚ è¿™æ ·è®¢é˜…è€…å°±èƒ½åœ¨ä¸ä¸å…·ä½“å‘å¸ƒè€…ç±»è€¦åˆçš„æƒ…å†µä¸‹é€šè¿‡æ¥å£è§‚å¯Ÿå‘å¸ƒè€…çš„çŠ¶æ€ã€‚</p>
<h2 id="3çœŸå®ä¸–ç•Œç±»æ¯”">3.çœŸå®ä¸–ç•Œç±»æ¯”</h2>
<p>å¦‚æœä½ è®¢é˜…äº†ä¸€ä»½æ‚å¿—æˆ–æŠ¥çº¸ï¼Œ é‚£å°±ä¸éœ€è¦å†å»æŠ¥æ‘ŠæŸ¥è¯¢æ–°å‡ºç‰ˆçš„åˆŠç‰©äº†ã€‚ å‡ºç‰ˆç¤¾ ï¼ˆå³åº”ç”¨ä¸­çš„ â€œå‘å¸ƒè€…â€ï¼‰ ä¼šåœ¨åˆŠç‰©å‡ºç‰ˆå ï¼ˆç”šè‡³æå‰ï¼‰ ç›´æ¥å°†æœ€æ–°ä¸€æœŸå¯„é€è‡³ä½ çš„é‚®ç®±ä¸­ã€‚</p>
<p>å‡ºç‰ˆç¤¾è´Ÿè´£ç»´æŠ¤è®¢é˜…è€…åˆ—è¡¨ï¼Œ äº†è§£è®¢é˜…è€…å¯¹å“ªäº›åˆŠç‰©æ„Ÿå…´è¶£ã€‚ å½“è®¢é˜…è€…å¸Œæœ›å‡ºç‰ˆç¤¾åœæ­¢å¯„é€æ–°ä¸€æœŸçš„æ‚å¿—æ—¶ï¼Œ ä»–ä»¬å¯éšæ—¶ä»è¯¥åˆ—è¡¨ä¸­é€€å‡ºã€‚</p>
<h2 id="4è§‚å¯Ÿè€…æ¨¡å¼ç»“æ„">4.è§‚å¯Ÿè€…æ¨¡å¼ç»“æ„</h2>
<figure data-type="image" tabindex="3"><img src="https://refactoringguru.cn/images/patterns/diagrams/observer/structure-2x.png" alt="è§‚å¯Ÿè€…æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<ol>
<li>
<p>å‘å¸ƒè€… ï¼ˆPubÂ­lishÂ­erï¼‰ ä¼šå‘å…¶ä»–å¯¹è±¡å‘é€å€¼å¾—å…³æ³¨çš„äº‹ä»¶ã€‚ äº‹ä»¶ä¼šåœ¨å‘å¸ƒè€…è‡ªèº«çŠ¶æ€æ”¹å˜æˆ–æ‰§è¡Œç‰¹å®šè¡Œä¸ºåå‘ç”Ÿã€‚ å‘å¸ƒè€…ä¸­åŒ…å«ä¸€ä¸ªå…è®¸æ–°è®¢é˜…è€…åŠ å…¥å’Œå½“å‰è®¢é˜…è€…ç¦»å¼€åˆ—è¡¨çš„è®¢é˜…æ„æ¶ã€‚</p>
</li>
<li>
<p>å½“æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ å‘é€è€…ä¼šéå†è®¢é˜…åˆ—è¡¨å¹¶è°ƒç”¨æ¯ä¸ªè®¢é˜…è€…å¯¹è±¡çš„é€šçŸ¥æ–¹æ³•ã€‚ è¯¥æ–¹æ³•æ˜¯åœ¨è®¢é˜…è€…æ¥å£ä¸­å£°æ˜çš„ã€‚</p>
</li>
<li>
<p>è®¢é˜…è€… ï¼ˆSubÂ­scriberï¼‰ æ¥å£å£°æ˜äº†é€šçŸ¥æ¥å£ã€‚ åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ è¯¥æ¥å£ä»…åŒ…å«ä¸€ä¸ª updateæ›´æ–°æ–¹æ³•ã€‚ è¯¥æ–¹æ³•å¯ä»¥æ‹¥æœ‰å¤šä¸ªå‚æ•°ï¼Œ ä½¿å‘å¸ƒè€…èƒ½åœ¨æ›´æ–°æ—¶ä¼ é€’äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
</li>
<li>
<p>å…·ä½“è®¢é˜…è€… ï¼ˆConÂ­crete SubÂ­scribersï¼‰ å¯ä»¥æ‰§è¡Œä¸€äº›æ“ä½œæ¥å›åº”å‘å¸ƒè€…çš„é€šçŸ¥ã€‚ æ‰€æœ‰å…·ä½“è®¢é˜…è€…ç±»éƒ½å®ç°äº†åŒæ ·çš„æ¥å£ï¼Œ å› æ­¤å‘å¸ƒè€…ä¸éœ€è¦ä¸å…·ä½“ç±»ç›¸è€¦åˆã€‚</p>
</li>
<li>
<p>è®¢é˜…è€…é€šå¸¸éœ€è¦ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯æ¥æ­£ç¡®åœ°å¤„ç†æ›´æ–°ã€‚ å› æ­¤ï¼Œ å‘å¸ƒè€…é€šå¸¸ä¼šå°†ä¸€äº›ä¸Šä¸‹æ–‡æ•°æ®ä½œä¸ºé€šçŸ¥æ–¹æ³•çš„å‚æ•°è¿›è¡Œä¼ é€’ã€‚ å‘å¸ƒè€…ä¹Ÿå¯å°†è‡ªèº«ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ï¼Œ ä½¿è®¢é˜…è€…ç›´æ¥è·å–æ‰€éœ€çš„æ•°æ®ã€‚</p>
</li>
<li>
<p>å®¢æˆ·ç«¯ ï¼ˆClientï¼‰ ä¼šåˆ†åˆ«åˆ›å»ºå‘å¸ƒè€…å’Œè®¢é˜…è€…å¯¹è±¡ï¼Œ ç„¶åä¸ºè®¢é˜…è€…æ³¨å†Œå‘å¸ƒè€…æ›´æ–°ã€‚</p>
</li>
</ol>
<h2 id="5è§‚å¯Ÿè€…æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯">5.è§‚å¯Ÿè€…æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯</h2>
<ol>
<li>
<p>å½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€çš„æ”¹å˜éœ€è¦æ”¹å˜å…¶ä»–å¯¹è±¡ï¼Œ æˆ–å®é™…å¯¹è±¡æ˜¯äº‹å…ˆæœªçŸ¥çš„æˆ–åŠ¨æ€å˜åŒ–çš„æ—¶ï¼Œ å¯ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚<br>
å½“ä½ ä½¿ç”¨å›¾å½¢ç”¨æˆ·ç•Œé¢ç±»æ—¶é€šå¸¸ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ã€‚ æ¯”å¦‚ï¼Œ ä½ åˆ›å»ºäº†è‡ªå®šä¹‰æŒ‰é’®ç±»å¹¶å…è®¸å®¢æˆ·ç«¯åœ¨æŒ‰é’®ä¸­æ³¨å…¥è‡ªå®šä¹‰ä»£ç ï¼Œ è¿™æ ·å½“ç”¨æˆ·æŒ‰ä¸‹æŒ‰é’®æ—¶å°±ä¼šè§¦å‘è¿™äº›ä»£ç ã€‚</p>
<p>è§‚å¯Ÿè€…æ¨¡å¼å…è®¸ä»»ä½•å®ç°äº†è®¢é˜…è€…æ¥å£çš„å¯¹è±¡è®¢é˜…å‘å¸ƒè€…å¯¹è±¡çš„äº‹ä»¶é€šçŸ¥ã€‚ ä½ å¯åœ¨æŒ‰é’®ä¸­æ·»åŠ è®¢é˜…æœºåˆ¶ï¼Œ å…è®¸å®¢æˆ·ç«¯é€šè¿‡è‡ªå®šä¹‰è®¢é˜…ç±»æ³¨å…¥è‡ªå®šä¹‰ä»£ç ã€‚</p>
</li>
<li>
<p>å½“åº”ç”¨ä¸­çš„ä¸€äº›å¯¹è±¡å¿…é¡»è§‚å¯Ÿå…¶ä»–å¯¹è±¡æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ ä½†ä»…èƒ½åœ¨æœ‰é™æ—¶é—´å†…æˆ–ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨ã€‚<br>
è®¢é˜…åˆ—è¡¨æ˜¯åŠ¨æ€çš„ï¼Œ å› æ­¤è®¢é˜…è€…å¯éšæ—¶åŠ å…¥æˆ–ç¦»å¼€è¯¥åˆ—è¡¨ã€‚</p>
</li>
</ol>
<h2 id="6å®ç°æ–¹å¼">6.å®ç°æ–¹å¼</h2>
<ol>
<li>
<p>ä»”ç»†æ£€æŸ¥ä½ çš„ä¸šåŠ¡é€»è¾‘ï¼Œ è¯•ç€å°†å…¶æ‹†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š ç‹¬ç«‹äºå…¶ä»–ä»£ç çš„æ ¸å¿ƒåŠŸèƒ½å°†ä½œä¸ºå‘å¸ƒè€…ï¼› å…¶ä»–ä»£ç åˆ™å°†è½¬åŒ–ä¸ºä¸€ç»„è®¢é˜…ç±»ã€‚</p>
</li>
<li>
<p>å£°æ˜è®¢é˜…è€…æ¥å£ã€‚ è¯¥æ¥å£è‡³å°‘åº”å£°æ˜ä¸€ä¸ª updateæ–¹æ³•ã€‚</p>
</li>
<li>
<p>å£°æ˜å‘å¸ƒè€…æ¥å£å¹¶å®šä¹‰ä¸€äº›æ¥å£æ¥åœ¨åˆ—è¡¨ä¸­æ·»åŠ å’Œåˆ é™¤è®¢é˜…å¯¹è±¡ã€‚ è®°ä½å‘å¸ƒè€…å¿…é¡»ä»…é€šè¿‡è®¢é˜…è€…æ¥å£ä¸å®ƒä»¬è¿›è¡Œäº¤äº’ã€‚</p>
</li>
<li>
<p>ç¡®å®šå­˜æ”¾å®é™…è®¢é˜…åˆ—è¡¨çš„ä½ç½®å¹¶å®ç°è®¢é˜…æ–¹æ³•ã€‚ é€šå¸¸æ‰€æœ‰ç±»å‹çš„å‘å¸ƒè€…ä»£ç çœ‹ä¸Šå»éƒ½ä¸€æ ·ï¼Œ å› æ­¤å°†åˆ—è¡¨æ”¾ç½®åœ¨ç›´æ¥æ‰©å±•è‡ªå‘å¸ƒè€…æ¥å£çš„æŠ½è±¡ç±»ä¸­æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ å…·ä½“å‘å¸ƒè€…ä¼šæ‰©å±•è¯¥ç±»ä»è€Œç»§æ‰¿æ‰€æœ‰çš„è®¢é˜…è¡Œä¸ºã€‚</p>
</li>
</ol>
<p>ä½†æ˜¯ï¼Œ å¦‚æœä½ éœ€è¦åœ¨ç°æœ‰çš„ç±»å±‚æ¬¡ç»“æ„ä¸­åº”ç”¨è¯¥æ¨¡å¼ï¼Œ åˆ™å¯ä»¥è€ƒè™‘ä½¿ç”¨ç»„åˆçš„æ–¹å¼ï¼š å°†è®¢é˜…é€»è¾‘æ”¾å…¥ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œ ç„¶åè®©æ‰€æœ‰å®é™…è®¢é˜…è€…ä½¿ç”¨è¯¥å¯¹è±¡ã€‚</p>
<ol start="5">
<li>
<p>åˆ›å»ºå…·ä½“å‘å¸ƒè€…ç±»ã€‚ æ¯æ¬¡å‘å¸ƒè€…å‘ç”Ÿäº†é‡è¦äº‹ä»¶æ—¶éƒ½å¿…é¡»é€šçŸ¥æ‰€æœ‰çš„è®¢é˜…è€…ã€‚</p>
</li>
<li>
<p>åœ¨å…·ä½“è®¢é˜…è€…ç±»ä¸­å®ç°é€šçŸ¥æ›´æ–°çš„æ–¹æ³•ã€‚ ç»å¤§éƒ¨åˆ†è®¢é˜…è€…éœ€è¦ä¸€äº›ä¸äº‹ä»¶ç›¸å…³çš„ä¸Šä¸‹æ–‡æ•°æ®ã€‚ è¿™äº›æ•°æ®å¯ä½œä¸ºé€šçŸ¥æ–¹æ³•çš„å‚æ•°æ¥ä¼ é€’ã€‚</p>
</li>
</ol>
<p>ä½†è¿˜æœ‰å¦ä¸€ç§é€‰æ‹©ã€‚ è®¢é˜…è€…æ¥æ”¶åˆ°é€šçŸ¥åç›´æ¥ä»é€šçŸ¥ä¸­è·å–æ‰€æœ‰æ•°æ®ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ å‘å¸ƒè€…å¿…é¡»é€šè¿‡æ›´æ–°æ–¹æ³•å°†è‡ªèº«ä¼ é€’å‡ºå»ã€‚ å¦ä¸€ç§ä¸å¤ªçµæ´»çš„æ–¹å¼æ˜¯é€šè¿‡æ„é€ å‡½æ•°å°†å‘å¸ƒè€…ä¸è®¢é˜…è€…æ°¸ä¹…æ€§åœ°è¿æ¥èµ·æ¥ã€‚</p>
<ol start="7">
<li>å®¢æˆ·ç«¯å¿…é¡»ç”Ÿæˆæ‰€éœ€çš„å…¨éƒ¨è®¢é˜…è€…ï¼Œ å¹¶åœ¨ç›¸åº”çš„å‘å¸ƒè€…å¤„å®Œæˆæ³¨å†Œå·¥ä½œã€‚</li>
</ol>
<h2 id="7è§‚å¯Ÿè€…æ¨¡å¼ä¼˜ç¼ºç‚¹">7.è§‚å¯Ÿè€…æ¨¡å¼ä¼˜ç¼ºç‚¹</h2>
<table>
<thead>
<tr>
<th>ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¼€é—­åŸåˆ™ã€‚ ä½ æ— éœ€ä¿®æ”¹å‘å¸ƒè€…ä»£ç å°±èƒ½å¼•å…¥æ–°çš„è®¢é˜…è€…ç±» ï¼ˆå¦‚æœæ˜¯å‘å¸ƒè€…æ¥å£åˆ™å¯è½»æ¾å¼•å…¥å‘å¸ƒè€…ç±»ï¼‰ã€‚</td>
<td style="text-align:center">è®¢é˜…è€…çš„é€šçŸ¥é¡ºåºæ˜¯éšæœºçš„ã€‚</td>
</tr>
<tr>
<td>ä½ å¯ä»¥åœ¨è¿è¡Œæ—¶å»ºç«‹å¯¹è±¡ä¹‹é—´çš„è”ç³»ã€‚</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<h2 id="8ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»">8.ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»</h2>
<ol>
<li>
<p>è´£ä»»é“¾æ¨¡å¼ã€ å‘½ä»¤æ¨¡å¼ã€ ä¸­ä»‹è€…æ¨¡å¼å’Œè§‚å¯Ÿè€…æ¨¡å¼ç”¨äºå¤„ç†è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„ä¸åŒè¿æ¥æ–¹å¼ï¼š</p>
<ul>
<li>è´£ä»»é“¾æŒ‰ç…§é¡ºåºå°†è¯·æ±‚åŠ¨æ€ä¼ é€’ç»™ä¸€ç³»åˆ—çš„æ½œåœ¨æ¥æ”¶è€…ï¼Œ ç›´è‡³å…¶ä¸­ä¸€åæ¥æ”¶è€…å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚</li>
<li>å‘½ä»¤åœ¨å‘é€è€…å’Œè¯·æ±‚è€…ä¹‹é—´å»ºç«‹å•å‘è¿æ¥ã€‚</li>
<li>ä¸­ä»‹è€…æ¸…é™¤äº†å‘é€è€…å’Œè¯·æ±‚è€…ä¹‹é—´çš„ç›´æ¥è¿æ¥ï¼Œ å¼ºåˆ¶å®ƒä»¬é€šè¿‡ä¸€ä¸ªä¸­ä»‹å¯¹è±¡è¿›è¡Œé—´æ¥æ²Ÿé€šã€‚</li>
<li>è§‚å¯Ÿè€…å…è®¸æ¥æ”¶è€…åŠ¨æ€åœ°è®¢é˜…æˆ–å–æ¶ˆæ¥æ”¶è¯·æ±‚ã€‚</li>
</ul>
</li>
<li>
<p>ä¸­ä»‹è€…å’Œè§‚å¯Ÿè€…ä¹‹é—´çš„åŒºåˆ«å¾€å¾€å¾ˆéš¾è®°ä½ã€‚ åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ ä½ å¯ä»¥ä½¿ç”¨å…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œ è€Œæœ‰æ—¶å¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚ è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p>ä¸­ä»‹è€…çš„ä¸»è¦ç›®æ ‡æ˜¯æ¶ˆé™¤ä¸€ç³»åˆ—ç³»ç»Ÿç»„ä»¶ä¹‹é—´çš„ç›¸äº’ä¾èµ–ã€‚ è¿™äº›ç»„ä»¶å°†ä¾èµ–äºåŒä¸€ä¸ªä¸­ä»‹è€…å¯¹è±¡ã€‚ è§‚å¯Ÿè€…çš„ç›®æ ‡æ˜¯åœ¨å¯¹è±¡ä¹‹é—´å»ºç«‹åŠ¨æ€çš„å•å‘è¿æ¥ï¼Œ ä½¿å¾—éƒ¨åˆ†å¯¹è±¡å¯ä½œä¸ºå…¶ä»–å¯¹è±¡çš„é™„å±å‘æŒ¥ä½œç”¨ã€‚</p>
<p>æœ‰ä¸€ç§æµè¡Œçš„ä¸­ä»‹è€…æ¨¡å¼å®ç°æ–¹å¼ä¾èµ–äºè§‚å¯Ÿè€…ã€‚ ä¸­ä»‹è€…å¯¹è±¡æ‹…å½“å‘å¸ƒè€…çš„è§’è‰²ï¼Œ å…¶ä»–ç»„ä»¶åˆ™ä½œä¸ºè®¢é˜…è€…ï¼Œ å¯ä»¥è®¢é˜…ä¸­ä»‹è€…çš„äº‹ä»¶æˆ–å–æ¶ˆè®¢é˜…ã€‚ å½“ä¸­ä»‹è€…ä»¥è¿™ç§æ–¹å¼å®ç°æ—¶ï¼Œ å®ƒå¯èƒ½çœ‹ä¸Šå»ä¸è§‚å¯Ÿè€…éå¸¸ç›¸ä¼¼ã€‚</p>
<p>å½“ä½ æ„Ÿåˆ°ç–‘æƒ‘æ—¶ï¼Œ è®°ä½å¯ä»¥é‡‡ç”¨å…¶ä»–æ–¹å¼æ¥å®ç°ä¸­ä»‹è€…ã€‚ ä¾‹å¦‚ï¼Œ ä½ å¯æ°¸ä¹…æ€§åœ°å°†æ‰€æœ‰ç»„ä»¶é“¾æ¥åˆ°åŒä¸€ä¸ªä¸­ä»‹è€…å¯¹è±¡ã€‚ è¿™ç§å®ç°æ–¹å¼å’Œè§‚å¯Ÿè€…å¹¶ä¸ç›¸åŒï¼Œ ä½†è¿™ä»æ˜¯ä¸€ç§ä¸­ä»‹è€…æ¨¡å¼ã€‚</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªç¨‹åºï¼Œ å…¶æ‰€æœ‰çš„ç»„ä»¶éƒ½å˜æˆäº†å‘å¸ƒè€…ï¼Œ å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’å»ºç«‹åŠ¨æ€è¿æ¥ã€‚ è¿™æ ·ç¨‹åºä¸­å°±æ²¡æœ‰ä¸­å¿ƒåŒ–çš„ä¸­ä»‹è€…å¯¹è±¡ï¼Œ è€Œåªæœ‰ä¸€äº›åˆ†å¸ƒå¼çš„è§‚å¯Ÿè€…ã€‚</p>
</li>
</ol>
<h2 id="9ä¼ªä»£ç ">9.ä¼ªä»£ç </h2>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œ è§‚å¯Ÿè€…æ¨¡å¼åœ¨æ–‡æœ¬ç¼–è¾‘å™¨çš„å¯¹è±¡ä¹‹é—´å»ºç«‹äº†é—´æ¥çš„åˆä½œå…³ç³»ã€‚ æ¯å½“ ç¼–è¾‘å™¨  ï¼ˆEdiÂ­torï¼‰ å¯¹è±¡æ”¹å˜æ—¶ï¼Œ å®ƒéƒ½ä¼šé€šçŸ¥å…¶è®¢é˜…è€…ã€‚ â€‹ é‚®ä»¶é€šçŸ¥ç›‘å¬å™¨  ï¼ˆEmailÂ­NotiÂ­fiÂ­caÂ­tionÂ­LisÂ­tenÂ­erï¼‰ å’Œ æ—¥å¿—å¼€å¯ç›‘å¬å™¨  ï¼ˆLogÂ­OpenÂ­LisÂ­tenÂ­erï¼‰ éƒ½å°†é€šè¿‡æ‰§è¡Œå…¶åŸºæœ¬è¡Œä¸ºæ¥å¯¹è¿™äº›é€šçŸ¥åšå‡ºååº”ã€‚</p>
<p>è®¢é˜…è€…ç±»ä¸ä¸ç¼–è¾‘å™¨ç±»ç›¸è€¦åˆï¼Œ ä¸”èƒ½åœ¨éœ€è¦æ—¶åœ¨å…¶ä»–åº”ç”¨ä¸­å¤ç”¨ã€‚ â€‹ ç¼–è¾‘å™¨ç±»ä»…ä¾èµ–äºæŠ½è±¡è®¢é˜…è€…æ¥å£ã€‚ è¿™æ ·å°±èƒ½å…è®¸åœ¨ä¸æ”¹å˜ç¼–è¾‘å™¨ä»£ç çš„æƒ…å†µä¸‹æ·»åŠ æ–°çš„è®¢é˜…è€…ç±»å‹ã€‚</p>
<blockquote>
<p>EventManager.java: åŸºç¡€å‘å¸ƒè€…</p>
</blockquote>
<pre><code class="language-java">package com.publisher;

import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * åŸºç¡€å‘å¸ƒè€…
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 16:05
 */
public class EventManager {
    Map&lt;String, List&lt;EventListener&gt;&gt; listeners = new HashMap&lt;&gt;();

    public EventManager(String... operations) {
        for (String operation : operations) {
            this.listeners.put(operation, new ArrayList&lt;&gt;());
        }
    }

    public void subscribe(String eventType, EventListener listener) {
        List&lt;EventListener&gt; users = listeners.get(eventType);
        users.add(listener);
    }

    public void unsubscribe(String eventType, EventListener listener) {
        List&lt;EventListener&gt; users = listeners.get(eventType);
        users.remove(listener);
    }

    public void notify(String eventType, File file) {
        List&lt;EventListener&gt; users = listeners.get(eventType);
        for (EventListener listener : users) {
            listener.update(eventType, file);
        }
    }
}

</code></pre>
<blockquote>
<p>Editor.java: å…·ä½“å‘å¸ƒè€…ï¼Œ ç”±å…¶ä»–å¯¹è±¡è¿½è¸ª</p>
</blockquote>
<pre><code class="language-java">package com.publisher;

import java.io.File;

/**
 * å…·ä½“å‘å¸ƒè€…ï¼Œ ç”±å…¶ä»–å¯¹è±¡è¿½è¸ª
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 16:06
 */
public class Editor {
    public EventManager events;
    private File file;

    public Editor() {
        this.events = new EventManager(&quot;open&quot;, &quot;save&quot;);
    }

    public void openFile(String filePath) {
        this.file = new File(filePath);
        events.notify(&quot;open&quot;, file);
    }

    public void saveFile() throws Exception {
        if (this.file != null) {
            events.notify(&quot;save&quot;, file);
        } else {
            throw new Exception(&quot;Please open a file first.&quot;);
        }
    }
}
</code></pre>
<blockquote>
<p>EventListener.java: é€šç”¨è§‚å¯Ÿè€…æ¥å£</p>
</blockquote>
<pre><code class="language-java">package com.publisher;

import java.io.File;

/**
 * é€šç”¨è§‚å¯Ÿè€…æ¥å£
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 16:07
 */
public interface EventListener {
    void update(String eventType, File file);
}
</code></pre>
<blockquote>
<p>EmailNotificationListener.java: æ”¶åˆ°é€šçŸ¥åå‘é€é‚®ä»¶</p>
</blockquote>
<pre><code class="language-java">package com.publisher;

import java.io.File;

/**
 * æ”¶åˆ°é€šçŸ¥åå‘é€é‚®ä»¶
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 16:09
 */
public class EmailNotificationListener implements EventListener {
    private String email;

    public EmailNotificationListener(String email) {
        this.email = email;
    }

    @Override
    public void update(String eventType, File file) {
        System.out.println(&quot;Email to &quot; + email + &quot;: Someone has performed &quot; + eventType + &quot; operation with the following file: &quot; + file.getName());
    }
}
</code></pre>
<blockquote>
<p>LogOpenListener.java: æ”¶åˆ°é€šçŸ¥ååœ¨æ—¥å¿—ä¸­è®°å½•ä¸€æ¡æ¶ˆæ¯</p>
</blockquote>
<pre><code class="language-java">package com.publisher;

import java.io.File;

/**
 * æ”¶åˆ°é€šçŸ¥ååœ¨æ—¥å¿—ä¸­è®°å½•ä¸€æ¡æ¶ˆæ¯
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 16:10
 */
public class LogOpenListener implements EventListener {
    private File log;

    public LogOpenListener(String fileName) {
        this.log = new File(fileName);
    }

    @Override
    public void update(String eventType, File file) {
        System.out.println(&quot;Save to log &quot; + log + &quot;: Someone has performed &quot; + eventType + &quot; operation with the following file: &quot; + file.getName());
    }
}
</code></pre>
<blockquote>
<p>Main</p>
</blockquote>
<pre><code class="language-java">package com.publisher;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 16:11
 */
public class Demo {
    public static void main(String[] args) {
        Editor editor = new Editor();
        editor.events.subscribe(&quot;open&quot;, new LogOpenListener(&quot;/path/to/log/file.txt&quot;));
        editor.events.subscribe(&quot;save&quot;, new EmailNotificationListener(&quot;admin@example.com&quot;));

        try {
            editor.openFile(&quot;test.txt&quot;);
            editor.saveFile();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">Save to log \path\to\log\file.txt: Someone has performed open operation with the following file: test.txt
Email to admin@example.com: Someone has performed save operation with the following file: test.txt
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[è®¿é—®è€…æ¨¡å¼]]></title>
        <id>https://q456qq520.github.io/post/fang-wen-zhe-mo-shi/</id>
        <link href="https://q456qq520.github.io/post/fang-wen-zhe-mo-shi/">
        </link>
        <updated>2022-10-11T03:23:34.000Z</updated>
        <summary type="html"><![CDATA[<p>è®¿é—®è€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½å°†ç®—æ³•ä¸å…¶æ‰€ä½œç”¨çš„å¯¹è±¡éš”ç¦»å¼€æ¥ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>è®¿é—®è€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½å°†ç®—æ³•ä¸å…¶æ‰€ä½œç”¨çš„å¯¹è±¡éš”ç¦»å¼€æ¥ã€‚</p>
<!-- more -->
<h2 id="1é—®é¢˜">1.é—®é¢˜</h2>
<p>å‡å¦‚ä½ çš„å›¢é˜Ÿå¼€å‘äº†ä¸€æ¬¾èƒ½å¤Ÿä½¿ç”¨å·¨å‹å›¾åƒä¸­åœ°ç†ä¿¡æ¯çš„åº”ç”¨ç¨‹åºã€‚ å›¾åƒä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ—¢èƒ½ä»£è¡¨å¤æ‚å®ä½“ ï¼ˆä¾‹å¦‚ä¸€åº§åŸå¸‚ï¼‰ï¼Œ ä¹Ÿèƒ½ä»£è¡¨æ›´ç²¾ç»†çš„å¯¹è±¡ ï¼ˆä¾‹å¦‚å·¥ä¸šåŒºå’Œæ—…æ¸¸æ™¯ç‚¹ç­‰ï¼‰ã€‚ å¦‚æœèŠ‚ç‚¹ä»£è¡¨çš„çœŸå®å¯¹è±¡ä¹‹é—´å­˜åœ¨å…¬è·¯ï¼Œ é‚£ä¹ˆè¿™äº›èŠ‚ç‚¹å°±ä¼šç›¸äº’è¿æ¥ã€‚ åœ¨ç¨‹åºå†…éƒ¨ï¼Œ æ¯ä¸ªèŠ‚ç‚¹çš„ç±»å‹éƒ½ç”±å…¶æ‰€å±çš„ç±»æ¥è¡¨ç¤ºï¼Œ æ¯ä¸ªç‰¹å®šçš„èŠ‚ç‚¹åˆ™æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://refactoringguru.cn/images/patterns/diagrams/visitor/problem1-2x.png" alt="å°†å›¾åƒå¯¼å‡ºä¸º XML" loading="lazy"></figure>
<p>ä¸€æ®µæ—¶é—´åï¼Œ ä½ æ¥åˆ°äº†å®ç°å°†å›¾åƒå¯¼å‡ºåˆ° XML æ–‡ä»¶ä¸­çš„ä»»åŠ¡ã€‚ è¿™äº›å·¥ä½œæœ€åˆçœ‹ä¸Šå»éå¸¸ç®€å•ã€‚ ä½ è®¡åˆ’ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç±»æ·»åŠ å¯¼å‡ºå‡½æ•°ï¼Œ ç„¶åé€’å½’æ‰§è¡Œå›¾åƒä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å¯¼å‡ºå‡½æ•°ã€‚ è§£å†³æ–¹æ¡ˆç®€å•ä¸”ä¼˜é›…ï¼š ä½¿ç”¨å¤šæ€æœºåˆ¶å¯ä»¥è®©å¯¼å‡ºæ–¹æ³•çš„è°ƒç”¨ä»£ç ä¸ä¼šå’Œå…·ä½“çš„èŠ‚ç‚¹ç±»ç›¸è€¦åˆã€‚</p>
<p>ä½†ä½ ä¸å¤ªèµ°è¿ï¼Œ ç³»ç»Ÿæ¶æ„å¸ˆæ‹’ç»æ‰¹å‡†å¯¹å·²æœ‰èŠ‚ç‚¹ç±»è¿›è¡Œä¿®æ”¹ã€‚ ä»–è®¤ä¸ºè¿™äº›ä»£ç å·²ç»æ˜¯äº§å“äº†ï¼Œ ä¸æƒ³å†’é™©å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œ å› ä¸ºä¿®æ”¹å¯èƒ½ä¼šå¼•å…¥æ½œåœ¨çš„ç¼ºé™·ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://refactoringguru.cn/images/patterns/diagrams/visitor/problem1-2x.png" alt="å°†å›¾åƒå¯¼å‡ºä¸º XML" loading="lazy"></figure>
<p>æ‰€æœ‰èŠ‚ç‚¹çš„ç±»ä¸­éƒ½å¿…é¡»æ·»åŠ å¯¼å‡ºè‡³ XML æ–‡ä»¶çš„æ–¹æ³•ï¼Œ ä½†å¦‚æœåœ¨ä¿®æ”¹ä»£ç çš„è¿‡ç¨‹ä¸­å¼•å…¥äº†ä»»ä½•ç¼ºé™·ï¼Œ é‚£ä¹ˆæ•´ä¸ªç¨‹åºéƒ½ä¼šé¢ä¸´é£é™©ã€‚</p>
<p>æ­¤å¤–ï¼Œ ä»–è¿˜è´¨ç–‘åœ¨èŠ‚ç‚¹ç±»ä¸­åŒ…å«å¯¼å‡º XML æ–‡ä»¶çš„ä»£ç æ˜¯å¦æœ‰æ„ä¹‰ã€‚ è¿™äº›ç±»çš„ä¸»è¦å·¥ä½œæ˜¯å¤„ç†åœ°ç†æ•°æ®ã€‚ å¯¼å‡º XML æ–‡ä»¶çš„ä»£ç æ”¾åœ¨è¿™é‡Œå¹¶ä¸åˆé€‚ã€‚</p>
<p>è¿˜æœ‰å¦ä¸€ä¸ªåŸå› ï¼Œ é‚£å°±æ˜¯åœ¨æ­¤é¡¹ä»»åŠ¡å®Œæˆåï¼Œ è¥é”€éƒ¨é—¨å¾ˆæœ‰å¯èƒ½ä¼šè¦æ±‚ç¨‹åºæä¾›å¯¼å‡ºå…¶ä»–ç±»å‹æ–‡ä»¶çš„åŠŸèƒ½ï¼Œ æˆ–è€…æå‡ºå…¶ä»–å¥‡æ€ªçš„è¦æ±‚ã€‚ è¿™æ ·ä½ å¾ˆå¯èƒ½ä¼šè¢«è¿«å†æ¬¡ä¿®æ”¹è¿™äº›é‡è¦ä½†è„†å¼±çš„ç±»ã€‚</p>
<h2 id="2è§£å†³æ–¹æ¡ˆ">2.è§£å†³æ–¹æ¡ˆ</h2>
<p>è®¿é—®è€…æ¨¡å¼å»ºè®®å°†æ–°è¡Œä¸ºæ”¾å…¥ä¸€ä¸ªåä¸ºè®¿é—®è€…çš„ç‹¬ç«‹ç±»ä¸­ï¼Œ è€Œä¸æ˜¯è¯•å›¾å°†å…¶æ•´åˆåˆ°å·²æœ‰ç±»ä¸­ã€‚ ç°åœ¨ï¼Œ éœ€è¦æ‰§è¡Œæ“ä½œçš„åŸå§‹å¯¹è±¡å°†ä½œä¸ºå‚æ•°è¢«ä¼ é€’ç»™è®¿é—®è€…ä¸­çš„æ–¹æ³•ï¼Œ è®©æ–¹æ³•èƒ½è®¿é—®å¯¹è±¡æ‰€åŒ…å«çš„ä¸€åˆ‡å¿…è¦æ•°æ®ã€‚</p>
<p>å¦‚æœç°åœ¨è¯¥æ“ä½œèƒ½åœ¨ä¸åŒç±»çš„å¯¹è±¡ä¸Šæ‰§è¡Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ æ¯”å¦‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œ å„èŠ‚ç‚¹ç±»å¯¼å‡º XML æ–‡ä»¶çš„å®é™…å®ç°å¾ˆå¯èƒ½ä¼šç¨æœ‰ä¸åŒã€‚ å› æ­¤ï¼Œ è®¿é—®è€…ç±»å¯ä»¥å®šä¹‰ä¸€ç»„ ï¼ˆè€Œä¸æ˜¯ä¸€ä¸ªï¼‰ æ–¹æ³•ï¼Œ ä¸”æ¯ä¸ªæ–¹æ³•å¯æ¥æ”¶ä¸åŒç±»å‹çš„å‚æ•°ï¼Œ å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-java">class ExportVisitor implements Visitor {
    method doForCity(City c) { â€¦â€¦ }
    method doForIndustry(Industry f) { â€¦â€¦ }
    method doForSightSeeing(SightSeeing ss) { â€¦â€¦ }
    // â€¦â€¦
}
</code></pre>
<p>ä½†æˆ‘ä»¬ç©¶ç«Ÿåº”è¯¥å¦‚ä½•è°ƒç”¨è¿™äº›æ–¹æ³• ï¼ˆå°¤å…¶æ˜¯åœ¨å¤„ç†æ•´ä¸ªå›¾åƒæ–¹é¢ï¼‰ å‘¢ï¼Ÿ è¿™äº›æ–¹æ³•çš„ç­¾åå„ä¸ç›¸åŒï¼Œ å› æ­¤æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨å¤šæ€æœºåˆ¶ã€‚ ä¸ºäº†å¯ä»¥æŒ‘é€‰å‡ºèƒ½å¤Ÿå¤„ç†ç‰¹å®šå¯¹è±¡çš„è®¿é—®è€…æ–¹æ³•ï¼Œ æˆ‘ä»¬éœ€è¦å¯¹å®ƒçš„ç±»è¿›è¡Œæ£€æŸ¥ã€‚ è¿™æ˜¯ä¸æ˜¯å¬ä¸Šå»åƒä¸ªå™©æ¢¦å‘¢ï¼Ÿ</p>
<pre><code class="language-java">for (Node node:graph) {
    if (node instanceof City)
        exportVisitor.doForCity((City) node)
    if (node instanceof Industry)
        exportVisitor.doForIndustry((Industry) node)
    // â€¦â€¦
}
</code></pre>
<p>ä½ å¯èƒ½ä¼šé—®ï¼Œ æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ–¹æ³•é‡è½½å‘¢ï¼Ÿ å°±æ˜¯ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•åç§°ï¼Œ ä½†å®ƒä»¬çš„å‚æ•°ä¸åŒã€‚ ä¸å¹¸çš„æ˜¯ï¼Œ å³ä½¿æˆ‘ä»¬çš„ç¼–ç¨‹è¯­è¨€ ï¼ˆä¾‹å¦‚ Java å’Œ C#ï¼‰ æ”¯æŒé‡è½½ä¹Ÿä¸è¡Œã€‚ ç”±äºæˆ‘ä»¬æ— æ³•æå‰çŸ¥æ™“èŠ‚ç‚¹å¯¹è±¡æ‰€å±çš„ç±»ï¼Œ æ‰€ä»¥é‡è½½æœºåˆ¶æ— æ³•æ‰§è¡Œæ­£ç¡®çš„æ–¹æ³•ã€‚ æ–¹æ³•ä¼šå°† èŠ‚ç‚¹åŸºç±»ä½œä¸ºè¾“å…¥å‚æ•°çš„é»˜è®¤ç±»å‹ã€‚</p>
<p>ä½†æ˜¯ï¼Œ è®¿é—®è€…æ¨¡å¼å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ å®ƒä½¿ç”¨äº†ä¸€ç§åä¸º<strong>åŒåˆ†æ´¾</strong>çš„æŠ€å·§ï¼Œ ä¸ä½¿ç”¨ç´¯èµ˜çš„æ¡ä»¶è¯­å¥ä¹Ÿå¯ä¸‹æ‰§è¡Œæ­£ç¡®çš„æ–¹æ³•ã€‚ ä¸å…¶è®©å®¢æˆ·ç«¯æ¥é€‰æ‹©è°ƒç”¨æ­£ç¡®ç‰ˆæœ¬çš„æ–¹æ³•ï¼Œ ä¸å¦‚å°†é€‰æ‹©æƒå§”æ´¾ç»™ä½œä¸ºå‚æ•°ä¼ é€’ç»™è®¿é—®è€…çš„å¯¹è±¡ã€‚ ç”±äºè¯¥å¯¹è±¡çŸ¥æ™“å…¶è‡ªèº«çš„ç±»ï¼Œ å› æ­¤èƒ½æ›´è‡ªç„¶åœ°åœ¨è®¿é—®è€…ä¸­é€‰å‡ºæ­£ç¡®çš„æ–¹æ³•ã€‚ å®ƒä»¬ä¼š â€œæ¥æ”¶â€ ä¸€ä¸ªè®¿é—®è€…å¹¶å‘Šè¯‰å…¶åº”æ‰§è¡Œçš„è®¿é—®è€…æ–¹æ³•ã€‚</p>
<pre><code class="language-java">// å®¢æˆ·ç«¯ä»£ç 
for (Node node:graph) {
    node.accept(exportVisitor)
}
// åŸå¸‚
class City {
    method accept(Visitor v) is
        v.doForCity(this)
    // â€¦â€¦
}

// å·¥ä¸šåŒº
class Industry {
    method accept(Visitor v) is
        v.doForIndustry(this)
    // â€¦â€¦
}
</code></pre>
<p>æˆ‘æ‰¿è®¤æœ€ç»ˆè¿˜æ˜¯ä¿®æ”¹äº†èŠ‚ç‚¹ç±»ï¼Œ ä½†æ¯•ç«Ÿæ”¹åŠ¨å¾ˆå°ï¼Œ ä¸”ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿåœ¨åç»­è¿›ä¸€æ­¥æ·»åŠ è¡Œä¸ºæ—¶æ— éœ€å†æ¬¡ä¿®æ”¹ä»£ç ã€‚</p>
<p>ç°åœ¨ï¼Œ å¦‚æœæˆ‘ä»¬æŠ½å–å‡ºæ‰€æœ‰è®¿é—®è€…çš„é€šç”¨æ¥å£ï¼Œ æ‰€æœ‰å·²æœ‰çš„èŠ‚ç‚¹éƒ½èƒ½ä¸æˆ‘ä»¬åœ¨ç¨‹åºä¸­å¼•å…¥çš„ä»»ä½•è®¿é—®è€…äº¤äº’ã€‚ å¦‚æœéœ€è¦å¼•å…¥ä¸èŠ‚ç‚¹ç›¸å…³çš„æŸä¸ªè¡Œä¸ºï¼Œ ä½ åªéœ€è¦å®ç°ä¸€ä¸ªæ–°çš„è®¿é—®è€…ç±»å³å¯ã€‚</p>
<h2 id="3çœŸå®ä¸–ç•Œç±»æ¯”">3.çœŸå®ä¸–ç•Œç±»æ¯”</h2>
<p>å‡å¦‚æœ‰è¿™æ ·ä¸€ä½éå¸¸å¸Œæœ›èµ¢å¾—æ–°å®¢æˆ·çš„èµ„æ·±ä¿é™©ä»£ç†äººã€‚ ä»–å¯ä»¥æ‹œè®¿è¡—åŒºä¸­çš„æ¯æ ‹æ¥¼ï¼Œ å°è¯•å‘æ¯ä¸ªè·¯äººæ¨é”€ä¿é™©ã€‚ æ‰€ä»¥ï¼Œ æ ¹æ®å¤§æ¥¼å†…ç»„ç»‡ç±»å‹çš„ä¸åŒï¼Œ ä»–å¯ä»¥æä¾›ä¸“é—¨çš„ä¿å•ï¼š</p>
<ol>
<li>å¦‚æœå»ºç­‘æ˜¯å±…æ°‘æ¥¼ï¼Œ ä»–ä¼šæ¨é”€åŒ»ç–—ä¿é™©ã€‚</li>
<li>å¦‚æœå»ºç­‘æ˜¯é“¶è¡Œï¼Œ ä»–ä¼šæ¨é”€å¤±çªƒä¿é™©ã€‚</li>
<li>å¦‚æœå»ºç­‘æ˜¯å’–å•¡å…ï¼Œ ä»–ä¼šæ¨é”€ç«ç¾å’Œæ´ªæ°´ä¿é™©ã€‚</li>
</ol>
<h2 id="4è®¿é—®è€…æ¨¡å¼ç»“æ„">4.è®¿é—®è€…æ¨¡å¼ç»“æ„</h2>
<figure data-type="image" tabindex="3"><img src="https://refactoringguru.cn/images/patterns/diagrams/visitor/structure-zh-2x.png" alt="è®¿é—®è€…æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<ol>
<li>
<p>è®¿é—®è€… ï¼ˆVisÂ­iÂ­torï¼‰ æ¥å£å£°æ˜äº†ä¸€ç³»åˆ—ä»¥å¯¹è±¡ç»“æ„çš„å…·ä½“å…ƒç´ ä¸ºå‚æ•°çš„è®¿é—®è€…æ–¹æ³•ã€‚ å¦‚æœç¼–ç¨‹è¯­è¨€æ”¯æŒé‡è½½ï¼Œ è¿™äº›æ–¹æ³•çš„åç§°å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Œ ä½†æ˜¯å…¶å‚æ•°ä¸€å®šæ˜¯ä¸åŒçš„ã€‚</p>
</li>
<li>
<p>å…·ä½“è®¿é—®è€… ï¼ˆConÂ­crete VisÂ­iÂ­torï¼‰ ä¼šä¸ºä¸åŒçš„å…·ä½“å…ƒç´ ç±»å®ç°ç›¸åŒè¡Œä¸ºçš„å‡ ä¸ªä¸åŒç‰ˆæœ¬ã€‚</p>
</li>
<li>
<p>å…ƒç´  ï¼ˆEleÂ­mentï¼‰ æ¥å£å£°æ˜äº†ä¸€ä¸ªæ–¹æ³•æ¥ â€œæ¥æ”¶â€ è®¿é—®è€…ã€‚ è¯¥æ–¹æ³•å¿…é¡»æœ‰ä¸€ä¸ªå‚æ•°è¢«å£°æ˜ä¸ºè®¿é—®è€…æ¥å£ç±»å‹ã€‚</p>
</li>
<li>
<p>å…·ä½“å…ƒç´  ï¼ˆConÂ­crete EleÂ­mentï¼‰ å¿…é¡»å®ç°æ¥æ”¶æ–¹æ³•ã€‚ è¯¥æ–¹æ³•çš„ç›®çš„æ˜¯æ ¹æ®å½“å‰å…ƒç´ ç±»å°†å…¶è°ƒç”¨é‡å®šå‘åˆ°ç›¸åº”è®¿é—®è€…çš„æ–¹æ³•ã€‚ è¯·æ³¨æ„ï¼Œ å³ä½¿å…ƒç´ åŸºç±»å®ç°äº†è¯¥æ–¹æ³•ï¼Œ æ‰€æœ‰å­ç±»éƒ½å¿…é¡»å¯¹å…¶è¿›è¡Œé‡å†™å¹¶è°ƒç”¨è®¿é—®è€…å¯¹è±¡ä¸­çš„åˆé€‚æ–¹æ³•ã€‚</p>
</li>
<li>
<p>å®¢æˆ·ç«¯ ï¼ˆClientï¼‰ é€šå¸¸ä¼šä½œä¸ºé›†åˆæˆ–å…¶ä»–å¤æ‚å¯¹è±¡ ï¼ˆä¾‹å¦‚ä¸€ä¸ªç»„åˆæ ‘ï¼‰ çš„ä»£è¡¨ã€‚ å®¢æˆ·ç«¯é€šå¸¸ä¸çŸ¥æ™“æ‰€æœ‰çš„å…·ä½“å…ƒç´ ç±»ï¼Œ å› ä¸ºå®ƒä»¬ä¼šé€šè¿‡æŠ½è±¡æ¥å£ä¸é›†åˆä¸­çš„å¯¹è±¡è¿›è¡Œäº¤äº’ã€‚</p>
</li>
</ol>
<h2 id="5è®¿é—®è€…æ¨¡å¼ç»“æ„é€‚åˆåº”ç”¨åœºæ™¯">5.è®¿é—®è€…æ¨¡å¼ç»“æ„é€‚åˆåº”ç”¨åœºæ™¯</h2>
<ol>
<li>
<p>å¦‚æœä½ éœ€è¦å¯¹ä¸€ä¸ªå¤æ‚å¯¹è±¡ç»“æ„ ï¼ˆä¾‹å¦‚å¯¹è±¡æ ‘ï¼‰ ä¸­çš„æ‰€æœ‰å…ƒç´ æ‰§è¡ŒæŸäº›æ“ä½œï¼Œ å¯ä½¿ç”¨è®¿é—®è€…æ¨¡å¼ã€‚<br>
è®¿é—®è€…æ¨¡å¼é€šè¿‡åœ¨è®¿é—®è€…å¯¹è±¡ä¸­ä¸ºå¤šä¸ªç›®æ ‡ç±»æä¾›ç›¸åŒæ“ä½œçš„å˜ä½“ï¼Œ è®©ä½ èƒ½åœ¨å±äºä¸åŒç±»çš„ä¸€ç»„å¯¹è±¡ä¸Šæ‰§è¡ŒåŒä¸€æ“ä½œã€‚</p>
</li>
<li>
<p>å¯ä½¿ç”¨è®¿é—®è€…æ¨¡å¼æ¥æ¸…ç†è¾…åŠ©è¡Œä¸ºçš„ä¸šåŠ¡é€»è¾‘ã€‚<br>
è¯¥æ¨¡å¼ä¼šå°†æ‰€æœ‰éä¸»è¦çš„è¡Œä¸ºæŠ½å–åˆ°ä¸€ç»„è®¿é—®è€…ç±»ä¸­ï¼Œ ä½¿å¾—ç¨‹åºçš„ä¸»è¦ç±»èƒ½æ›´ä¸“æ³¨äºä¸»è¦çš„å·¥ä½œã€‚</p>
</li>
<li>
<p>å½“æŸä¸ªè¡Œä¸ºä»…åœ¨ç±»å±‚æ¬¡ç»“æ„ä¸­çš„ä¸€äº›ç±»ä¸­æœ‰æ„ä¹‰ï¼Œ è€Œåœ¨å…¶ä»–ç±»ä¸­æ²¡æœ‰æ„ä¹‰æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚<br>
ä½ å¯å°†è¯¥è¡Œä¸ºæŠ½å–åˆ°å•ç‹¬çš„è®¿é—®è€…ç±»ä¸­ï¼Œ åªéœ€å®ç°æ¥æ”¶ç›¸å…³ç±»çš„å¯¹è±¡ä½œä¸ºå‚æ•°çš„è®¿é—®è€…æ–¹æ³•å¹¶å°†å…¶ä»–æ–¹æ³•ç•™ç©ºå³å¯ã€‚</p>
</li>
</ol>
<h2 id="6å®ç°æ–¹å¼">6.å®ç°æ–¹å¼</h2>
<ol>
<li>
<p>åœ¨è®¿é—®è€…æ¥å£ä¸­å£°æ˜ä¸€ç»„ â€œè®¿é—®â€ æ–¹æ³•ï¼Œ åˆ†åˆ«å¯¹åº”ç¨‹åºä¸­çš„æ¯ä¸ªå…·ä½“å…ƒç´ ç±»ã€‚</p>
</li>
<li>
<p>å£°æ˜å…ƒç´ æ¥å£ã€‚ å¦‚æœç¨‹åºä¸­å·²æœ‰å…ƒç´ ç±»å±‚æ¬¡æ¥å£ï¼Œ å¯åœ¨å±‚æ¬¡ç»“æ„åŸºç±»ä¸­æ·»åŠ æŠ½è±¡çš„ â€œæ¥æ”¶â€ æ–¹æ³•ã€‚ è¯¥æ–¹æ³•å¿…é¡»æ¥å—è®¿é—®è€…å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚</p>
</li>
<li>
<p>åœ¨æ‰€æœ‰å…·ä½“å…ƒç´ ç±»ä¸­å®ç°æ¥æ”¶æ–¹æ³•ã€‚ è¿™äº›æ–¹æ³•å¿…é¡»å°†è°ƒç”¨é‡å®šå‘åˆ°å½“å‰å…ƒç´ å¯¹åº”çš„è®¿é—®è€…å¯¹è±¡ä¸­çš„è®¿é—®è€…æ–¹æ³•ä¸Šã€‚</p>
</li>
<li>
<p>å…ƒç´ ç±»åªèƒ½é€šè¿‡è®¿é—®è€…æ¥å£ä¸è®¿é—®è€…è¿›è¡Œäº¤äº’ã€‚ ä¸è¿‡è®¿é—®è€…å¿…é¡»çŸ¥æ™“æ‰€æœ‰çš„å…·ä½“å…ƒç´ ç±»ï¼Œ å› ä¸ºè¿™äº›ç±»åœ¨è®¿é—®è€…æ–¹æ³•ä¸­éƒ½è¢«ä½œä¸ºå‚æ•°ç±»å‹å¼•ç”¨ã€‚</p>
</li>
<li>
<p>ä¸ºæ¯ä¸ªæ— æ³•åœ¨å…ƒç´ å±‚æ¬¡ç»“æ„ä¸­å®ç°çš„è¡Œä¸ºåˆ›å»ºä¸€ä¸ªå…·ä½“è®¿é—®è€…ç±»å¹¶å®ç°æ‰€æœ‰çš„è®¿é—®è€…æ–¹æ³•ã€‚<br>
ä½ å¯èƒ½ä¼šé‡åˆ°è®¿é—®è€…éœ€è¦è®¿é—®å…ƒç´ ç±»çš„éƒ¨åˆ†ç§æœ‰æˆå‘˜å˜é‡çš„æƒ…å†µã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ ä½ è¦ä¹ˆå°†è¿™äº›å˜é‡æˆ–æ–¹æ³•è®¾ä¸ºå…¬æœ‰ï¼Œ è¿™å°†ç ´åå…ƒç´ çš„å°è£…ï¼› è¦ä¹ˆå°†è®¿é—®è€…ç±»åµŒå…¥åˆ°å…ƒç´ ç±»ä¸­ã€‚</p>
</li>
<li>
<p>å®¢æˆ·ç«¯å¿…é¡»åˆ›å»ºè®¿é—®è€…å¯¹è±¡å¹¶é€šè¿‡ â€œæ¥æ”¶â€ æ–¹æ³•å°†å…¶ä¼ é€’ç»™å…ƒç´ ã€‚</p>
</li>
</ol>
<h2 id="7è®¿é—®è€…æ¨¡å¼ç»“æ„ä¼˜ç¼ºç‚¹">7.è®¿é—®è€…æ¨¡å¼ç»“æ„ä¼˜ç¼ºç‚¹</h2>
<table>
<thead>
<tr>
<th>ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¼€é—­åŸåˆ™ã€‚ ä½ å¯ä»¥å¼•å…¥åœ¨ä¸åŒç±»å¯¹è±¡ä¸Šæ‰§è¡Œçš„æ–°è¡Œä¸ºï¼Œ ä¸”æ— éœ€å¯¹è¿™äº›ç±»åšå‡ºä¿®æ”¹ã€‚</td>
<td style="text-align:center">æ¯æ¬¡åœ¨å…ƒç´ å±‚æ¬¡ç»“æ„ä¸­æ·»åŠ æˆ–ç§»é™¤ä¸€ä¸ªç±»æ—¶ï¼Œ ä½ éƒ½è¦æ›´æ–°æ‰€æœ‰çš„è®¿é—®è€…ã€‚</td>
</tr>
<tr>
<td>å•ä¸€èŒè´£åŸåˆ™ã€‚ å¯å°†åŒä¸€è¡Œä¸ºçš„ä¸åŒç‰ˆæœ¬ç§»åˆ°åŒä¸€ä¸ªç±»ä¸­ã€‚</td>
<td style="text-align:center">åœ¨è®¿é—®è€…åŒæŸä¸ªå…ƒç´ è¿›è¡Œäº¤äº’æ—¶ï¼Œ å®ƒä»¬å¯èƒ½æ²¡æœ‰è®¿é—®å…ƒç´ ç§æœ‰æˆå‘˜å˜é‡å’Œæ–¹æ³•çš„å¿…è¦æƒé™ã€‚</td>
</tr>
<tr>
<td>è®¿é—®è€…å¯¹è±¡å¯ä»¥åœ¨ä¸å„ç§å¯¹è±¡äº¤äº’æ—¶æ”¶é›†ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚ å½“ä½ æƒ³è¦éå†ä¸€äº›å¤æ‚çš„å¯¹è±¡ç»“æ„ ï¼ˆä¾‹å¦‚å¯¹è±¡æ ‘ï¼‰ï¼Œ å¹¶åœ¨ç»“æ„ä¸­çš„æ¯ä¸ªå¯¹è±¡ä¸Šåº”ç”¨è®¿é—®è€…æ—¶ï¼Œ è¿™äº›ä¿¡æ¯å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<h2 id="8ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»">8.ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»</h2>
<ol>
<li>
<p>ä½ å¯ä»¥å°†è®¿é—®è€…æ¨¡å¼è§†ä¸ºå‘½ä»¤æ¨¡å¼çš„åŠ å¼ºç‰ˆæœ¬ï¼Œ å…¶å¯¹è±¡å¯å¯¹ä¸åŒç±»çš„å¤šç§å¯¹è±¡æ‰§è¡Œæ“ä½œã€‚</p>
</li>
<li>
<p>ä½ å¯ä»¥ä½¿ç”¨è®¿é—®è€…å¯¹æ•´ä¸ªç»„åˆæ¨¡å¼æ ‘æ‰§è¡Œæ“ä½œã€‚</p>
</li>
<li>
<p>å¯ä»¥åŒæ—¶ä½¿ç”¨è®¿é—®è€…å’Œè¿­ä»£å™¨æ¨¡å¼æ¥éå†å¤æ‚æ•°æ®ç»“æ„ï¼Œ å¹¶å¯¹å…¶ä¸­çš„å…ƒç´ æ‰§è¡Œæ‰€éœ€æ“ä½œï¼Œ å³ä½¿è¿™äº›å…ƒç´ æ‰€å±çš„ç±»å®Œå…¨ä¸åŒã€‚</p>
</li>
</ol>
<h2 id="9ä¼ªä»£ç ">9.ä¼ªä»£ç </h2>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œ æˆ‘ä»¬å¸Œæœ›å°†ä¸€ç³»åˆ—å‡ ä½•å½¢çŠ¶å¯¼å‡ºä¸º XML æ–‡ä»¶ã€‚ é‡ç‚¹åœ¨äºæˆ‘ä»¬ä¸å¸Œæœ›ç›´æ¥ä¿®æ”¹å½¢çŠ¶ä»£ç ï¼Œ æˆ–è€…è‡³å°‘èƒ½ç¡®ä¿æœ€å°ç¨‹åº¦çš„ä¿®æ”¹ã€‚</p>
<p>æœ€ç»ˆï¼Œ è®¿é—®è€…æ¨¡å¼å»ºç«‹äº†ä¸€ä¸ªæ¡†æ¶ï¼Œ å…è®¸æˆ‘ä»¬åœ¨ä¸ä¿®æ”¹å·²æœ‰ç±»çš„æƒ…å†µä¸‹å‘å½¢çŠ¶å±‚æ¬¡ç»“æ„ä¸­æ·»åŠ æ–°çš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>Shape-é€šç”¨å½¢çŠ¶æ¥å£</p>
</blockquote>
<pre><code class="language-java">package com.visitor;

/**
 * é€šç”¨å½¢çŠ¶æ¥å£
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 15:19
 */
public interface Shape {
    void move(int x, int y);

    void draw();
    
    String accept(Visitor visitor);
}
</code></pre>
<blockquote>
<p>Dot ç‚¹</p>
</blockquote>
<pre><code class="language-java">package com.visitor;

/**
 * ç‚¹
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 15:23
 */
public class Dot implements Shape {
    private int id;
    private int x;
    private int y;

    public Dot() {
    }

    public Dot(int id, int x, int y) {
        this.id = id;
        this.x = x;
        this.y = y;
    }

    @Override
    public void move(int x, int y) {
        // move shape
    }

    @Override
    public void draw() {
        // draw shape
    }

    @Override
    public String accept(Visitor visitor) {
        return visitor.visitDot(this);
    }

    public int getX() {
        return x;
    }

    public int getY() {
        return y;
    }

    public int getId() {
        return id;
    }
}
</code></pre>
<blockquote>
<p>Circle åœ†å½¢</p>
</blockquote>
<pre><code class="language-java">package com.visitor;

/**
 * åœ†
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 15:24
 */
public class Circle extends Dot {
    private int radius;

    public Circle(int id, int x, int y, int radius) {
        super(id, x, y);
        this.radius = radius;
    }

    @Override
    public String accept(Visitor visitor) {
        return visitor.visitCircle(this);
    }

    public int getRadius() {
        return radius;
    }
}
</code></pre>
<blockquote>
<p>Rectangle çŸ©å½¢</p>
</blockquote>
<pre><code class="language-java">package com.visitor;

/**
 * çŸ©å½¢
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 15:25
 */
public class Rectangle implements Shape {
    private int id;
    private int x;
    private int y;
    private int width;
    private int height;

    public Rectangle(int id, int x, int y, int width, int height) {
        this.id = id;
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
    }

    @Override
    public String accept(Visitor visitor) {
        return visitor.visitRectangle(this);
    }

    @Override
    public void move(int x, int y) {
        // move shape
    }

    @Override
    public void draw() {
        // draw shape
    }

    public int getId() {
        return id;
    }

    public int getX() {
        return x;
    }

    public int getY() {
        return y;
    }

    public int getWidth() {
        return width;
    }

    public int getHeight() {
        return height;
    }
}
</code></pre>
<blockquote>
<p>CompoundShape ç»„åˆå½¢çŠ¶</p>
</blockquote>
<pre><code class="language-java">package com.visitor;

import java.util.ArrayList;
import java.util.List;

/**
 * ç»„åˆå½¢çŠ¶
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 15:26
 */
public class CompoundShape implements Shape {
    public int id;
    public List&lt;Shape&gt; children = new ArrayList&lt;&gt;();

    public CompoundShape(int id) {
        this.id = id;
    }

    @Override
    public void move(int x, int y) {
        // move shape
    }

    @Override
    public void draw() {
        // draw shape
    }

    public int getId() {
        return id;
    }

    @Override
    public String accept(Visitor visitor) {
        return visitor.visitCompoundGraphic(this);
    }

    public void add(Shape shape) {
        children.add(shape);
    }
}
</code></pre>
<blockquote>
<p>Visitor é€šç”¨è®¿é—®è€…æ¥å£</p>
</blockquote>
<pre><code class="language-java">package com.visitor;

/**
 * é€šç”¨è®¿é—®è€…æ¥å£
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 15:20
 */
public interface Visitor {
    String visitDot(Dot dot);

    String visitCircle(Circle circle);

    String visitRectangle(Rectangle rectangle);

    String visitCompoundGraphic(CompoundShape cg);
}
</code></pre>
<blockquote>
<p>XMLExportVisitor å…·ä½“è®¿é—®è€…</p>
</blockquote>
<pre><code class="language-java">package com.visitor;

/**
 * å…·ä½“è®¿é—®è€…
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 15:28
 */
public class XMLExportVisitor implements Visitor {

    public String export(Shape... args) {
        StringBuilder sb = new StringBuilder();
        sb.append(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&quot; + &quot;\n&quot;);
        for (Shape shape : args) {
            sb.append(shape.accept(this)).append(&quot;\n&quot;);
        }
        return sb.toString();
    }

    public String visitDot(Dot d) {
        return &quot;&lt;dot&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;id&gt;&quot; + d.getId() + &quot;&lt;/id&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;x&gt;&quot; + d.getX() + &quot;&lt;/x&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;y&gt;&quot; + d.getY() + &quot;&lt;/y&gt;&quot; + &quot;\n&quot; +
                &quot;&lt;/dot&gt;&quot;;
    }

    public String visitCircle(Circle c) {
        return &quot;&lt;circle&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;id&gt;&quot; + c.getId() + &quot;&lt;/id&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;x&gt;&quot; + c.getX() + &quot;&lt;/x&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;y&gt;&quot; + c.getY() + &quot;&lt;/y&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;radius&gt;&quot; + c.getRadius() + &quot;&lt;/radius&gt;&quot; + &quot;\n&quot; +
                &quot;&lt;/circle&gt;&quot;;
    }

    public String visitRectangle(Rectangle r) {
        return &quot;&lt;rectangle&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;id&gt;&quot; + r.getId() + &quot;&lt;/id&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;x&gt;&quot; + r.getX() + &quot;&lt;/x&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;y&gt;&quot; + r.getY() + &quot;&lt;/y&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;width&gt;&quot; + r.getWidth() + &quot;&lt;/width&gt;&quot; + &quot;\n&quot; +
                &quot;    &lt;height&gt;&quot; + r.getHeight() + &quot;&lt;/height&gt;&quot; + &quot;\n&quot; +
                &quot;&lt;/rectangle&gt;&quot;;
    }

    public String visitCompoundGraphic(CompoundShape cg) {
        return &quot;&lt;compound_graphic&gt;&quot; + &quot;\n&quot; +
                &quot;   &lt;id&gt;&quot; + cg.getId() + &quot;&lt;/id&gt;&quot; + &quot;\n&quot; +
                _visitCompoundGraphic(cg) +
                &quot;&lt;/compound_graphic&gt;&quot;;
    }

    private String _visitCompoundGraphic(CompoundShape cg) {
        StringBuilder sb = new StringBuilder();
        for (Shape shape : cg.children) {
            String obj = shape.accept(this);
            // Proper indentation for sub-objects.
            obj = &quot;    &quot; + obj.replace(&quot;\n&quot;, &quot;\n    &quot;) + &quot;\n&quot;;
            sb.append(obj);
        }
        return sb.toString();
    }
}
</code></pre>
<blockquote>
<p>Main</p>
</blockquote>
<pre><code class="language-java">package com.visitor;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 15:29
 */
public class Demo {
    public static void main(String[] args) {
        Dot dot = new Dot(1, 10, 55);
        Circle circle = new Circle(2, 23, 15, 10);
        Rectangle rectangle = new Rectangle(3, 10, 17, 20, 30);

        CompoundShape compoundShape = new CompoundShape(4);
        compoundShape.add(dot);
        compoundShape.add(circle);
        compoundShape.add(rectangle);

        CompoundShape c = new CompoundShape(5);
        c.add(dot);
        compoundShape.add(c);

        export(circle, compoundShape);
    }

    private static void export(Shape... shapes) {
        XMLExportVisitor exportVisitor = new XMLExportVisitor();
        System.out.println(exportVisitor.export(shapes));
    }
}
</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;circle&gt;
    &lt;id&gt;2&lt;/id&gt;
    &lt;x&gt;23&lt;/x&gt;
    &lt;y&gt;15&lt;/y&gt;
    &lt;radius&gt;10&lt;/radius&gt;
&lt;/circle&gt;
&lt;compound_graphic&gt;
   &lt;id&gt;4&lt;/id&gt;
    &lt;dot&gt;
        &lt;id&gt;1&lt;/id&gt;
        &lt;x&gt;10&lt;/x&gt;
        &lt;y&gt;55&lt;/y&gt;
    &lt;/dot&gt;
    &lt;circle&gt;
        &lt;id&gt;2&lt;/id&gt;
        &lt;x&gt;23&lt;/x&gt;
        &lt;y&gt;15&lt;/y&gt;
        &lt;radius&gt;10&lt;/radius&gt;
    &lt;/circle&gt;
    &lt;rectangle&gt;
        &lt;id&gt;3&lt;/id&gt;
        &lt;x&gt;10&lt;/x&gt;
        &lt;y&gt;17&lt;/y&gt;
        &lt;width&gt;20&lt;/width&gt;
        &lt;height&gt;30&lt;/height&gt;
    &lt;/rectangle&gt;
    &lt;compound_graphic&gt;
       &lt;id&gt;5&lt;/id&gt;
        &lt;dot&gt;
            &lt;id&gt;1&lt;/id&gt;
            &lt;x&gt;10&lt;/x&gt;
            &lt;y&gt;55&lt;/y&gt;
        &lt;/dot&gt;
    &lt;/compound_graphic&gt;
&lt;/compound_graphic&gt;
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[æ¨¡æ¿æ–¹æ³•æ¨¡å¼]]></title>
        <id>https://q456qq520.github.io/post/mo-ban-fang-fa-mo-shi/</id>
        <link href="https://q456qq520.github.io/post/mo-ban-fang-fa-mo-shi/">
        </link>
        <updated>2022-10-10T08:57:19.000Z</updated>
        <summary type="html"><![CDATA[<p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒåœ¨è¶…ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„æ¡†æ¶ï¼Œ å…è®¸å­ç±»åœ¨ä¸ä¿®æ”¹ç»“æ„çš„æƒ…å†µä¸‹é‡å†™ç®—æ³•çš„ç‰¹å®šæ­¥éª¤ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒåœ¨è¶…ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„æ¡†æ¶ï¼Œ å…è®¸å­ç±»åœ¨ä¸ä¿®æ”¹ç»“æ„çš„æƒ…å†µä¸‹é‡å†™ç®—æ³•çš„ç‰¹å®šæ­¥éª¤ã€‚</p>
<!-- more -->
<h2 id="1é—®é¢˜">1.é—®é¢˜</h2>
<p>å‡å¦‚ä½ æ­£åœ¨å¼€å‘ä¸€æ¬¾åˆ†æå…¬å¸æ–‡æ¡£çš„æ•°æ®æŒ–æ˜ç¨‹åºã€‚ ç”¨æˆ·éœ€è¦å‘ç¨‹åºè¾“å…¥å„ç§æ ¼å¼ ï¼ˆPDFã€ DOC æˆ– CSVï¼‰ çš„æ–‡æ¡£ï¼Œ ç¨‹åºåˆ™ä¼šè¯•å›¾ä»è¿™äº›æ–‡ä»¶ä¸­æŠ½å–æœ‰æ„ä¹‰çš„æ•°æ®ï¼Œå¹¶ä»¥ç»Ÿä¸€çš„æ ¼å¼å°†å…¶è¿”å›ç»™ç”¨æˆ·ã€‚</p>
<p>è¯¥ç¨‹åºçš„é¦–ä¸ªç‰ˆæœ¬ä»…æ”¯æŒ DOC æ–‡ä»¶ã€‚ åœ¨æ¥ä¸‹æ¥çš„ä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼Œç¨‹åºèƒ½å¤Ÿæ”¯æŒ CSV æ–‡ä»¶ã€‚ä¸€ä¸ªæœˆåï¼Œä½  â€œæ•™ä¼šâ€ äº†ç¨‹åºä»PDFæ–‡ä»¶ä¸­æŠ½å–æ•°æ®ã€‚</p>
<p>ä¸€æ®µæ—¶é—´åï¼Œ ä½ å‘ç°è¿™ä¸‰ä¸ªç±»ä¸­åŒ…å«è®¸å¤šç›¸ä¼¼ä»£ç ã€‚ å°½ç®¡è¿™äº›ç±»å¤„ç†ä¸åŒæ•°æ®æ ¼å¼çš„ä»£ç å®Œå…¨ä¸åŒï¼Œ ä½†æ•°æ®å¤„ç†å’Œåˆ†æçš„ä»£ç å´å‡ ä¹å®Œå…¨ä¸€æ ·ã€‚ å¦‚æœèƒ½åœ¨ä¿æŒç®—æ³•ç»“æ„å®Œæ•´çš„æƒ…å†µä¸‹å»é™¤é‡å¤ä»£ç ï¼Œ è¿™éš¾é“ä¸æ˜¯ä¸€ä»¶å¾ˆæ£’çš„äº‹æƒ…å—ï¼Ÿ</p>
<p>è¿˜æœ‰å¦ä¸€ä¸ªä¸ä½¿ç”¨è¿™äº›ç±»çš„å®¢æˆ·ç«¯ä»£ç ç›¸å…³çš„é—®é¢˜ï¼š å®¢æˆ·ç«¯ä»£ç ä¸­åŒ…å«è®¸å¤šæ¡ä»¶è¯­å¥ï¼Œ ä»¥æ ¹æ®ä¸åŒçš„å¤„ç†å¯¹è±¡ç±»å‹é€‰æ‹©åˆé€‚çš„å¤„ç†è¿‡ç¨‹ã€‚ å¦‚æœæ‰€æœ‰å¤„ç†æ•°æ®çš„ç±»éƒ½æ‹¥æœ‰ç›¸åŒçš„æ¥å£æˆ–åŸºç±»ï¼Œ é‚£ä¹ˆä½ å°±å¯ä»¥å»é™¤å®¢æˆ·ç«¯ä»£ç ä¸­çš„æ¡ä»¶è¯­å¥ï¼Œ è½¬è€Œä½¿ç”¨å¤šæ€æœºåˆ¶æ¥åœ¨å¤„ç†å¯¹è±¡ä¸Šè°ƒç”¨å‡½æ•°ã€‚</p>
<h2 id="2è§£å†³æ–¹æ¡ˆ">2.è§£å†³æ–¹æ¡ˆ</h2>
<p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼å»ºè®®å°†ç®—æ³•åˆ†è§£ä¸ºä¸€ç³»åˆ—æ­¥éª¤ï¼Œ ç„¶åå°†è¿™äº›æ­¥éª¤æ”¹å†™ä¸ºæ–¹æ³•ï¼Œ æœ€ååœ¨ â€œæ¨¡æ¿æ–¹æ³•â€ ä¸­ä¾æ¬¡è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚ æ­¥éª¤å¯ä»¥æ˜¯ æŠ½è±¡çš„ï¼Œ ä¹Ÿå¯ä»¥æœ‰ä¸€äº›é»˜è®¤çš„å®ç°ã€‚ ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ç®—æ³•ï¼Œ å®¢æˆ·ç«¯éœ€è¦è‡ªè¡Œæä¾›å­ç±»å¹¶å®ç°æ‰€æœ‰çš„æŠ½è±¡æ­¥éª¤ã€‚ å¦‚æœ‰å¿…è¦è¿˜éœ€é‡å†™ä¸€äº›æ­¥éª¤ ï¼ˆä½†è¿™ä¸€æ­¥ä¸­ä¸åŒ…æ‹¬æ¨¡æ¿æ–¹æ³•è‡ªèº«ï¼‰ã€‚</p>
<p>è®©æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åœ¨æ•°æ®æŒ–æ˜åº”ç”¨ä¸­å®ç°ä¸Šè¿°æ–¹æ¡ˆã€‚ æˆ‘ä»¬å¯ä¸ºå›¾ä¸­çš„ä¸‰ä¸ªè§£æç®—æ³•åˆ›å»ºä¸€ä¸ªåŸºç±»ï¼Œ è¯¥ç±»å°†å®šä¹‰è°ƒç”¨äº†ä¸€ç³»åˆ—ä¸åŒæ–‡æ¡£å¤„ç†æ­¥éª¤çš„æ¨¡æ¿æ–¹æ³•ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://refactoringguru.cn/images/patterns/diagrams/template-method/solution-zh-2x.png" alt="æ¨¡æ¿æ–¹æ³•å°†ç®—æ³•åˆ†è§£ä¸ºæ­¥éª¤" loading="lazy"></figure>
<p>æ¨¡æ¿æ–¹æ³•å°†ç®—æ³•åˆ†è§£ä¸ºæ­¥éª¤ï¼Œ å¹¶å…è®¸å­ç±»é‡å†™è¿™äº›æ­¥éª¤ï¼Œ è€Œéé‡å†™å®é™…çš„æ¨¡æ¿æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆï¼Œ æˆ‘ä»¬å°†æ‰€æœ‰æ­¥éª¤å£°æ˜ä¸º æŠ½è±¡ç±»å‹ï¼Œ å¼ºåˆ¶è¦æ±‚å­ç±»è‡ªè¡Œå®ç°è¿™äº›æ–¹æ³•ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ å­ç±»ä¸­å·²æœ‰æ‰€æœ‰å¿…è¦çš„å®ç°ï¼Œ å› æ­¤æˆ‘ä»¬åªéœ€è°ƒæ•´è¿™äº›æ–¹æ³•çš„ç­¾åï¼Œ ä½¿ä¹‹ä¸è¶…ç±»çš„æ–¹æ³•åŒ¹é…å³å¯ã€‚</p>
<p>ç°åœ¨ï¼Œ è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å»é™¤é‡å¤ä»£ç ã€‚ å¯¹äºä¸åŒçš„æ•°æ®æ ¼å¼ï¼Œ æ‰“å¼€å’Œå…³é—­æ–‡ä»¶ä»¥åŠæŠ½å–å’Œè§£ææ•°æ®çš„ä»£ç éƒ½ä¸åŒï¼Œ å› æ­¤æ— éœ€ä¿®æ”¹è¿™äº›æ–¹æ³•ã€‚ ä½†åˆ†æåŸå§‹æ•°æ®å’Œç”ŸæˆæŠ¥å‘Šç­‰å…¶ä»–æ­¥éª¤çš„å®ç°æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œ å› æ­¤å¯å°†å…¶æå–åˆ°åŸºç±»ä¸­ï¼Œ ä»¥è®©å­ç±»å…±äº«è¿™äº›ä»£ç ã€‚</p>
<p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„é‚£æ ·ï¼Œ æˆ‘ä»¬æœ‰ä¸¤ç§ç±»å‹çš„æ­¥éª¤ï¼š</p>
<ul>
<li>æŠ½è±¡æ­¥éª¤å¿…é¡»ç”±å„ä¸ªå­ç±»æ¥å®ç°</li>
<li>å¯é€‰æ­¥éª¤å·²æœ‰ä¸€äº›é»˜è®¤å®ç°ï¼Œ ä½†ä»å¯åœ¨éœ€è¦æ—¶è¿›è¡Œé‡å†™</li>
</ul>
<p>è¿˜æœ‰å¦ä¸€ç§åä¸ºé’©å­çš„æ­¥éª¤ã€‚ é’©å­æ˜¯å†…å®¹ä¸ºç©ºçš„å¯é€‰æ­¥éª¤ã€‚ å³ä½¿ä¸é‡å†™é’©å­ï¼Œ æ¨¡æ¿æ–¹æ³•ä¹Ÿèƒ½å·¥ä½œã€‚ é’©å­é€šå¸¸æ”¾ç½®åœ¨ç®—æ³•é‡è¦æ­¥éª¤çš„å‰åï¼Œ ä¸ºå­ç±»æä¾›é¢å¤–çš„ç®—æ³•æ‰©å±•ç‚¹ã€‚</p>
<h2 id="3çœŸå®ä¸–ç•Œç±»æ¯”">3.çœŸå®ä¸–ç•Œç±»æ¯”</h2>
<p>æ¨¡æ¿æ–¹æ³•å¯ç”¨äºå»ºé€ å¤§é‡æˆ¿å±‹ã€‚ æ ‡å‡†æˆ¿å±‹å»ºé€ æ–¹æ¡ˆä¸­å¯æä¾›å‡ ä¸ªæ‰©å±•ç‚¹ï¼Œ å…è®¸æ½œåœ¨æˆ¿å±‹ä¸šä¸»è°ƒæ•´æˆå“æˆ¿å±‹çš„éƒ¨åˆ†ç»†èŠ‚ã€‚</p>
<p>æ¯ä¸ªå»ºé€ æ­¥éª¤ ï¼ˆä¾‹å¦‚æ‰“åœ°åŸºã€ å»ºé€ æ¡†æ¶ã€ å»ºé€ å¢™å£å’Œå®‰è£…æ°´ç”µç®¡çº¿ç­‰ï¼‰ éƒ½èƒ½è¿›è¡Œå¾®è°ƒï¼Œ è¿™ä½¿å¾—æˆå“æˆ¿å±‹ä¼šç•¥æœ‰ä¸åŒã€‚</p>
<h2 id="4æ¨¡æ¿æ–¹æ³•æ¨¡å¼ç»“æ„">4.æ¨¡æ¿æ–¹æ³•æ¨¡å¼ç»“æ„</h2>
<figure data-type="image" tabindex="2"><img src="https://refactoringguru.cn/images/patterns/diagrams/template-method/structure-2x.png" alt="æ¨¡æ¿æ–¹æ³•æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<ol>
<li>
<p>æŠ½è±¡ç±» ï¼ˆAbstractÂ­Classï¼‰ ä¼šå£°æ˜ä½œä¸ºç®—æ³•æ­¥éª¤çš„æ–¹æ³•ï¼Œ ä»¥åŠä¾æ¬¡è°ƒç”¨å®ƒä»¬çš„å®é™…æ¨¡æ¿æ–¹æ³•ã€‚ ç®—æ³•æ­¥éª¤å¯ä»¥è¢«å£°æ˜ä¸º æŠ½è±¡ç±»å‹ï¼Œ ä¹Ÿå¯ä»¥æä¾›ä¸€äº›é»˜è®¤å®ç°ã€‚</p>
</li>
<li>
<p>å…·ä½“ç±» ï¼ˆConÂ­creteÂ­Classï¼‰ å¯ä»¥é‡å†™æ‰€æœ‰æ­¥éª¤ï¼Œ ä½†ä¸èƒ½é‡å†™æ¨¡æ¿æ–¹æ³•è‡ªèº«ã€‚</p>
</li>
</ol>
<h2 id="5æ¨¡æ¿æ–¹æ³•æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯">5.æ¨¡æ¿æ–¹æ³•æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯</h2>
<ol>
<li>
<p>å½“ä½ åªå¸Œæœ›å®¢æˆ·ç«¯æ‰©å±•æŸä¸ªç‰¹å®šç®—æ³•æ­¥éª¤ï¼Œ è€Œä¸æ˜¯æ•´ä¸ªç®—æ³•æˆ–å…¶ç»“æ„æ—¶ï¼Œ å¯ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚<br>
æ¨¡æ¿æ–¹æ³•å°†æ•´ä¸ªç®—æ³•è½¬æ¢ä¸ºä¸€ç³»åˆ—ç‹¬ç«‹çš„æ­¥éª¤ï¼Œ ä»¥ä¾¿å­ç±»èƒ½å¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œ åŒæ—¶è¿˜å¯è®©è¶…ç±»ä¸­æ‰€å®šä¹‰çš„ç»“æ„ä¿æŒå®Œæ•´ã€‚</p>
</li>
<li>
<p>å½“å¤šä¸ªç±»çš„ç®—æ³•é™¤ä¸€äº›ç»†å¾®ä¸åŒä¹‹å¤–å‡ ä¹å®Œå…¨ä¸€æ ·æ—¶ï¼Œ ä½ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ ä½†å…¶åæœå°±æ˜¯ï¼Œ åªè¦ç®—æ³•å‘ç”Ÿå˜åŒ–ï¼Œ ä½ å°±å¯èƒ½éœ€è¦ä¿®æ”¹æ‰€æœ‰çš„ç±»ã€‚<br>
åœ¨å°†ç®—æ³•è½¬æ¢ä¸ºæ¨¡æ¿æ–¹æ³•æ—¶ï¼Œ ä½ å¯å°†ç›¸ä¼¼çš„å®ç°æ­¥éª¤æå–åˆ°è¶…ç±»ä¸­ä»¥å»é™¤é‡å¤ä»£ç ã€‚ å­ç±»é—´å„ä¸åŒçš„ä»£ç å¯ç»§ç»­ä¿ç•™åœ¨å­ç±»ä¸­ã€‚</p>
</li>
</ol>
<h2 id="6å®ç°æ–¹å¼">6.å®ç°æ–¹å¼</h2>
<ol>
<li>
<p>åˆ†æç›®æ ‡ç®—æ³•ï¼Œ ç¡®å®šèƒ½å¦å°†å…¶åˆ†è§£ä¸ºå¤šä¸ªæ­¥éª¤ã€‚ ä»æ‰€æœ‰å­ç±»çš„è§’åº¦å‡ºå‘ï¼Œ è€ƒè™‘å“ªäº›æ­¥éª¤èƒ½å¤Ÿé€šç”¨ï¼Œ å“ªäº›æ­¥éª¤å„ä¸ç›¸åŒã€‚</p>
</li>
<li>
<p>åˆ›å»ºæŠ½è±¡åŸºç±»å¹¶å£°æ˜ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•å’Œä»£è¡¨ç®—æ³•æ­¥éª¤çš„ä¸€ç³»åˆ—æŠ½è±¡æ–¹æ³•ã€‚ åœ¨æ¨¡æ¿æ–¹æ³•ä¸­æ ¹æ®ç®—æ³•ç»“æ„ä¾æ¬¡è°ƒç”¨ç›¸åº”æ­¥éª¤ã€‚ å¯ç”¨ finalæœ€ç»ˆä¿®é¥°æ¨¡æ¿æ–¹æ³•ä»¥é˜²æ­¢å­ç±»å¯¹å…¶è¿›è¡Œé‡å†™ã€‚</p>
</li>
<li>
<p>è™½ç„¶å¯å°†æ‰€æœ‰æ­¥éª¤å…¨éƒ½è®¾ä¸ºæŠ½è±¡ç±»å‹ï¼Œ ä½†é»˜è®¤å®ç°å¯èƒ½ä¼šç»™éƒ¨åˆ†æ­¥éª¤å¸¦æ¥å¥½å¤„ï¼Œ å› ä¸ºå­ç±»æ— éœ€å®ç°é‚£äº›æ–¹æ³•ã€‚</p>
</li>
<li>
<p>å¯è€ƒè™‘åœ¨ç®—æ³•çš„å…³é”®æ­¥éª¤ä¹‹é—´æ·»åŠ é’©å­ã€‚</p>
</li>
<li>
<p>ä¸ºæ¯ä¸ªç®—æ³•å˜ä½“æ–°å»ºä¸€ä¸ªå…·ä½“å­ç±»ï¼Œ å®ƒå¿…é¡»å®ç°æ‰€æœ‰çš„æŠ½è±¡æ­¥éª¤ï¼Œ ä¹Ÿå¯ä»¥é‡å†™éƒ¨åˆ†å¯é€‰æ­¥éª¤ã€‚</p>
</li>
</ol>
<h2 id="7æ¨¡æ¿æ–¹æ³•æ¨¡å¼ä¼˜ç¼ºç‚¹">7.æ¨¡æ¿æ–¹æ³•æ¨¡å¼ä¼˜ç¼ºç‚¹</h2>
<table>
<thead>
<tr>
<th>ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½ å¯ä»…å…è®¸å®¢æˆ·ç«¯é‡å†™ä¸€ä¸ªå¤§å‹ç®—æ³•ä¸­çš„ç‰¹å®šéƒ¨åˆ†ï¼Œ ä½¿å¾—ç®—æ³•å…¶ä»–éƒ¨åˆ†ä¿®æ”¹å¯¹å…¶æ‰€é€ æˆçš„å½±å“å‡å°ã€‚</td>
<td style="text-align:center">éƒ¨åˆ†å®¢æˆ·ç«¯å¯èƒ½ä¼šå—åˆ°ç®—æ³•æ¡†æ¶çš„é™åˆ¶ã€‚</td>
</tr>
<tr>
<td>ä½ å¯å°†é‡å¤ä»£ç æå–åˆ°ä¸€ä¸ªè¶…ç±»ä¸­ã€‚</td>
<td style="text-align:center">é€šè¿‡å­ç±»æŠ‘åˆ¶é»˜è®¤æ­¥éª¤å®ç°å¯èƒ½ä¼šå¯¼è‡´è¿åé‡Œæ°æ›¿æ¢åŸåˆ™ã€‚</td>
</tr>
<tr>
<td>-</td>
<td style="text-align:center">æ¨¡æ¿æ–¹æ³•ä¸­çš„æ­¥éª¤è¶Šå¤šï¼Œ å…¶ç»´æŠ¤å·¥ä½œå°±å¯èƒ½ä¼šè¶Šå›°éš¾ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="8ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»">8.ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»</h2>
<ol>
<li>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ã€‚ åŒæ—¶ï¼Œ å·¥å‚æ–¹æ³•å¯ä»¥ä½œä¸ºä¸€ä¸ªå¤§å‹æ¨¡æ¿æ–¹æ³•ä¸­çš„ä¸€ä¸ªæ­¥éª¤ã€‚</p>
</li>
<li>
<p>æ¨¡æ¿æ–¹æ³•åŸºäºç»§æ‰¿æœºåˆ¶ï¼š å®ƒå…è®¸ä½ é€šè¿‡æ‰©å±•å­ç±»ä¸­çš„éƒ¨åˆ†å†…å®¹æ¥æ”¹å˜éƒ¨åˆ†ç®—æ³•ã€‚ ç­–ç•¥æ¨¡å¼åŸºäºç»„åˆæœºåˆ¶ï¼š ä½ å¯ä»¥é€šè¿‡å¯¹ç›¸åº”è¡Œä¸ºæä¾›ä¸åŒçš„ç­–ç•¥æ¥æ”¹å˜å¯¹è±¡çš„éƒ¨åˆ†è¡Œä¸ºã€‚ æ¨¡æ¿æ–¹æ³•åœ¨ç±»å±‚æ¬¡ä¸Šè¿ä½œï¼Œ å› æ­¤å®ƒæ˜¯é™æ€çš„ã€‚ ç­–ç•¥åœ¨å¯¹è±¡å±‚æ¬¡ä¸Šè¿ä½œï¼Œ å› æ­¤å…è®¸åœ¨è¿è¡Œæ—¶åˆ‡æ¢è¡Œä¸ºã€‚</p>
</li>
</ol>
<h2 id="9ä¼ªä»£ç ">9.ä¼ªä»£ç </h2>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œ æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªå¯ä¸ç¤¾äº¤ç½‘ç»œåä½œçš„ç®—æ³•ã€‚ ä¸ç‰¹å®šç¤¾äº¤ç½‘ç»œç›¸åŒ¹é…çš„å­ç±»å°†æ ¹æ®ç¤¾äº¤ç½‘ç»œæ‰€æä¾›çš„ API æ¥å®ç°è¿™äº›æ­¥éª¤ã€‚</p>
<blockquote>
<p>networks-åŸºç¡€ç¤¾äº¤ç½‘ç»œç±»</p>
</blockquote>
<pre><code class="language-java">package com.templateMethod;

/**
 * åŸºç¡€ç¤¾äº¤ç½‘ç»œç±»
 * @author likecat
 * @version 1.0
 * @date 2022/10/10 17:29
 */
public abstract class Network {
    String userName;
    String password;

    Network() {}

    /**
     * æ•°æ®å‘å¸ƒ
     */
    public boolean post(String message) {
        if (logIn(this.userName, this.password)) {
            // Send the post data.
            boolean result =  sendData(message.getBytes());
            logOut();
            return result;
        }
        return false;
    }

    //ç™»é™†
    abstract boolean logIn(String userName, String password);
    
    //å‘æ•°æ®
    abstract boolean sendData(byte[] data);
    
    //ç™»å‡º
    abstract void logOut();
}
</code></pre>
<blockquote>
<p>Facebook-å…·ä½“ç¤¾äº¤ç½‘ç»œ</p>
</blockquote>
<pre><code class="language-java">package com.templateMethod;

/**
 * å…·ä½“ç¤¾äº¤ç½‘ç»œ
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 10:57
 */
public class Facebook extends Network {
    public Facebook(String userName, String password) {
        this.userName = userName;
        this.password = password;
    }

    public boolean logIn(String userName, String password) {
        System.out.println(&quot;\nChecking user's parameters&quot;);
        System.out.println(&quot;Name: &quot; + this.userName);
        System.out.print(&quot;Password: &quot;);
        for (int i = 0; i &lt; this.password.length(); i++) {
            System.out.print(&quot;*&quot;);
        }
        //æ¨¡æ‹Ÿå»¶è¿Ÿ
        simulateNetworkLatency();
        System.out.println(&quot;\n\nLogIn success on Facebook&quot;);
        return true;
    }

    public boolean sendData(byte[] data) {
        boolean messagePosted = true;
        if (messagePosted) {
            System.out.println(&quot;Message: '&quot; + new String(data) + &quot;' was posted on Facebook&quot;);
            return true;
        } else {
            return false;
        }
    }

    public void logOut() {
        System.out.println(&quot;User: '&quot; + userName + &quot;' was logged out from Facebook&quot;);
    }

    private void simulateNetworkLatency() {
        try {
            int i = 0;
            System.out.println();
            while (i &lt; 10) {
                System.out.print(&quot;.&quot;);
                Thread.sleep(500);
                i++;
            }
        } catch (InterruptedException ex) {
            ex.printStackTrace();
        }
    }
}
</code></pre>
<blockquote>
<p>Twitter</p>
</blockquote>
<pre><code class="language-java">package com.templateMethod;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 11:01
 */
public class Twitter extends Network {

    public Twitter(String userName, String password) {
        this.userName = userName;
        this.password = password;
    }

    public boolean logIn(String userName, String password) {
        System.out.println(&quot;\nChecking user's parameters&quot;);
        System.out.println(&quot;Name: &quot; + this.userName);
        System.out.print(&quot;Password: &quot;);
        for (int i = 0; i &lt; this.password.length(); i++) {
            System.out.print(&quot;*&quot;);
        }
        simulateNetworkLatency();
        System.out.println(&quot;\n\nLogIn success on Twitter&quot;);
        return true;
    }

    public boolean sendData(byte[] data) {
        boolean messagePosted = true;
        if (messagePosted) {
            System.out.println(&quot;Message: '&quot; + new String(data) + &quot;' was posted on Twitter&quot;);
            return true;
        } else {
            return false;
        }
    }

    public void logOut() {
        System.out.println(&quot;User: '&quot; + userName + &quot;' was logged out from Twitter&quot;);
    }

    private void simulateNetworkLatency() {
        try {
            int i = 0;
            System.out.println();
            while (i &lt; 10) {
                System.out.print(&quot;.&quot;);
                Thread.sleep(500);
                i++;
            }
        } catch (InterruptedException ex) {
            ex.printStackTrace();
        }
    }
}
</code></pre>
<blockquote>
<p>Main</p>
</blockquote>
<pre><code class="language-java">package com.templateMethod;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/10/11 11:01
 */
public class Demo {
    public static void main(String[] args) throws IOException {
        BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));
        Network network = null;
        System.out.print(&quot;Input user name: &quot;);
        String userName = reader.readLine();
        System.out.print(&quot;Input password: &quot;);
        String password = reader.readLine();

        // Enter the message.
        System.out.print(&quot;Input message: &quot;);
        String message = reader.readLine();

        System.out.println(&quot;\nChoose social network for posting message.\n&quot; +
                &quot;1 - Facebook\n&quot; +
                &quot;2 - Twitter&quot;);
        int choice = Integer.parseInt(reader.readLine());

        // Create proper network object and send the message.
        if (choice == 1) {
            network = new Facebook(userName, password);
        } else if (choice == 2) {
            network = new Twitter(userName, password);
        }
        network.post(message);
    }
}
</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="language-java">Input user name: likecat
Input password: 123456
Input message: you pro?

Choose social network for posting message.
1 - Facebook
2 - Twitter
1

Checking user's parameters
Name: likecat
Password: ******
..........

LogIn success on Facebook
Message: 'you pro?' was posted on Facebook
User: 'likecat' was logged out from Facebook
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Linux åŸºç¡€å‘½ä»¤]]></title>
        <id>https://q456qq520.github.io/post/linux-ji-chu-ming-ling/</id>
        <link href="https://q456qq520.github.io/post/linux-ji-chu-ming-ling/">
        </link>
        <updated>2022-09-19T09:19:08.000Z</updated>
        <content type="html"><![CDATA[<h1 id="æŸ¥è¯¢">æŸ¥è¯¢</h1>
<ol>
<li>
<p>æŸ¥çœ‹ç«¯å£å ç”¨<br>
netstat -anp |grep 22</p>
</li>
<li>
<p>æŸ¥çœ‹è¿›ç¨‹å ç”¨çš„ç«¯å£<br>
netstat -anp |grep ssh</p>
</li>
</ol>
<h1 id="httpè¯·æ±‚">httpè¯·æ±‚</h1>
<ol>
<li>curl-post<br>
curl -H &quot;Content-Type: application/json&quot; -X POST -d '' http://xxx</li>
</ol>
<h1 id="mysql">mysql</h1>
<ol>
<li>
<p>è¿æ¥<br>
mysql -uroot -p</p>
</li>
<li>
<p>æŸ¥çœ‹è¡¨ç»“æ„<br>
desc table<br>
describe table<br>
show columns from tbale</p>
</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[RocketMqæŠ€æœ¯å†…å¹•ç¬”è®°ï¼ˆä¸‰ï¼‰]]></title>
        <id>https://q456qq520.github.io/post/rocketmq-ji-zhu-nei-mu-bi-ji-san/</id>
        <link href="https://q456qq520.github.io/post/rocketmq-ji-zhu-nei-mu-bi-ji-san/">
        </link>
        <updated>2022-09-15T03:54:22.000Z</updated>
        <summary type="html"><![CDATA[<h1 id="4-æ¶ˆæ¯å­˜å‚¨">4 æ¶ˆæ¯å­˜å‚¨</h1>
<h2 id="41-å­˜å‚¨æ¦‚è¦è®¾è®¡">4.1 å­˜å‚¨æ¦‚è¦è®¾è®¡</h2>
<p>RocketMQä¸»è¦å­˜å‚¨çš„æ–‡ä»¶åŒ…æ‹¬Comitlogæ–‡ä»¶ã€ConsumeQueueæ–‡ä»¶ã€IndexFileæ–‡<br>
ä»¶ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<h1 id="4-æ¶ˆæ¯å­˜å‚¨">4 æ¶ˆæ¯å­˜å‚¨</h1>
<h2 id="41-å­˜å‚¨æ¦‚è¦è®¾è®¡">4.1 å­˜å‚¨æ¦‚è¦è®¾è®¡</h2>
<p>RocketMQä¸»è¦å­˜å‚¨çš„æ–‡ä»¶åŒ…æ‹¬Comitlogæ–‡ä»¶ã€ConsumeQueueæ–‡ä»¶ã€IndexFileæ–‡<br>
ä»¶ã€‚</p>
<!-- more -->
<p>RocketMQå°†æ‰€æœ‰ä¸»é¢˜çš„æ¶ˆæ¯å­˜å‚¨åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç¡®ä¿æ¶ˆæ¯å‘é€æ—¶é¡ºåºå†™æ–‡ä»¶ã€‚ä¸ºäº†æé«˜æ¶ˆæ¯æ¶ˆè´¹çš„æ•ˆç‡ï¼Œ RocketMQ å¼•å…¥äº† ConsumeQueue æ¶ˆæ¯é˜Ÿåˆ— æ–‡ä»¶ï¼Œæ¯ä¸ªæ¶ˆæ¯ä¸»é¢˜åŒ…å«å¤šä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æœ‰ä¸€ä¸ªæ¶ˆæ¯æ–‡ä»¶ - IndexFileç´¢å¼•æ–‡ä»¶ï¼Œå…¶ä¸»è¦è®¾è®¡ç†å¿µå°±æ˜¯ä¸ºäº†åŠ é€Ÿæ¶ˆæ¯çš„æ£€ç´¢æ€§èƒ½ï¼Œæ ¹æ®æ¶ˆæ¯çš„å±æ€§å¿«é€Ÿä» Commitlog æ–‡ä»¶ä¸­æ£€ç´¢æ¶ˆæ¯ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1663233972923.png" alt="RocketMQ æ¶ˆæ¯å­˜å‚¨è®¾è®¡åŸç†å›¾" loading="lazy"></figure>
<p>1 ) CommitLog:æ¶ˆæ¯å­˜å‚¨æ–‡ä»¶ï¼Œæ‰€æœ‰æ¶ˆæ¯ä¸»é¢˜çš„æ¶ˆæ¯éƒ½å­˜å‚¨åœ¨ CommitLog æ–‡ä»¶ä¸­ ã€‚<br>
2 ) ConsumeQueue :æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œæ¶ˆæ¯åˆ°è¾¾CommitLogæ–‡ä»¶åï¼Œå°†å¼‚æ­¥è½¬å‘åˆ°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œä¾›æ¶ˆæ¯æ¶ˆè´¹è€…æ¶ˆè´¹ ã€‚<br>
3 ) IndexFile:æ¶ˆæ¯ç´¢å¼•æ–‡ä»¶ï¼Œä¸»è¦å­˜å‚¨æ¶ˆæ¯ Key ä¸ Offset çš„å¯¹åº”å…³ç³» ã€‚<br>
4 )äº‹åŠ¡çŠ¶æ€æœåŠ¡ : å­˜å‚¨æ¯æ¡æ¶ˆæ¯çš„äº‹åŠ¡çŠ¶æ€ ã€‚<br>
5 )å®šæ—¶æ¶ˆæ¯æœåŠ¡:æ¯ä¸€ä¸ªå»¶è¿Ÿçº§åˆ«å¯¹åº”ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå­˜å‚¨å»¶è¿Ÿé˜Ÿåˆ—çš„æ¶ˆæ¯æ‹‰å–<br>
è¿›åº¦ã€‚</p>
<h2 id="42-åˆè¯†æ¶ˆæ¯å­˜å‚¨">4.2 åˆè¯†æ¶ˆæ¯å­˜å‚¨</h2>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1663311285978.png" alt="CommitLog" loading="lazy"></figure>
<ol>
<li>CommitLog ä¸»è¦ç”±å‡ éƒ¨åˆ†ç»„æˆï¼š</li>
</ol>
<p>MappedFileQueueï¼š ä¸»è¦ç”¨æ¥æ“ä½œç›¸å…³æ•°æ®å­˜å‚¨æ–‡ä»¶ã€‚å°†ä¸€ç³»åˆ—çš„MappedFileæŠ½è±¡æˆä¸€ä¸ªé˜Ÿåˆ—ã€‚<br>
FlushManagerï¼š æ•°æ®è½åœ°ç£ç›˜çš„ç®¡ç†ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šå®æ—¶æ•°æ®åˆ·ç›˜(FlushRealTimeService),ä»¥åŠå¼‚æ­¥åˆ·ç›˜(GroupCommitService)<br>
FlushDiskWatcherï¼š åˆ·ç›˜è§‚å¯Ÿè€…ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„åˆ·ç›˜è¯·æ±‚ï¼Œå¯¹äºè§„å®šæ—¶é—´å†…æ²¡æœ‰åˆ·ç›˜æˆåŠŸçš„è¿›è¡Œå¤„ç†ã€‚</p>
<ol start="2">
<li>MappedFileQueue</li>
</ol>
<p>MappedFileQueue æ˜¯å¯¹æ•°æ®å­˜å‚¨æ–‡ä»¶çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå°†å¤šä¸ªæ•°æ®æ–‡ä»¶æŠ½è±¡æˆä¸ºä¸€ä¸ªæ–‡ä»¶é˜Ÿåˆ—ã€‚é€šè¿‡è¿™ä¸ªæ–‡ä»¶é˜Ÿåˆ—å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œæ“ä½œã€‚åŒæ—¶ä¿å­˜ä¸€äº› CommitLog çš„å±æ€§ã€‚</p>
<ol start="3">
<li>MappedFile<br>
MappedFile æ˜¯å¯¹æ–‡ä»¶çš„æŠ½è±¡ï¼ŒåŒ…å«äº†å¯¹RocketMQæ•°æ®æ–‡ä»¶çš„æ•´ä¸ªæ“ä½œã€‚ä¾‹å¦‚è·å–æ–‡ä»¶åç§°ã€æ–‡ä»¶å¤§å°ã€åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯ç”¨ã€æ˜¯å¦å·²ç»æ»¡äº†ç­‰ç­‰çš„æ“ä½œã€‚</li>
</ol>
<p>å•ä¸ªæ•°æ®æ–‡ä»¶é»˜è®¤æ˜¯ 1G ã€‚ç”±äºåªç”¨äº†ä¸€ä¸ªå­—èŠ‚ä¿å­˜Topicçš„é•¿åº¦æ‰€ä»¥Topicçš„æœ€å¤§é•¿åº¦æ˜¯127å­—ç¬¦ã€‚</p>
<p>æ¶ˆæ¯å­˜å‚¨å®ç°ç±»: org.apache.rocketmq.store.DefaultMessageStoreã€‚</p>
<blockquote>
<p>DefaultMessageStoreçš„æ ¸å¿ƒå±æ€§</p>
</blockquote>
<pre><code class="language-java">//æ¶ˆæ¯å­˜å‚¨é…ç½®å±æ€§
private final MessageStoreConfig messageStoreConfig;
//CommitLog æ–‡ä»¶çš„å­˜å‚¨å®ç°ç±»
private final CommitLog commitLog;
//æ¶ˆæ¯é˜Ÿåˆ—å­˜å‚¨
private final ConsumeQueueStore consumeQueueStore;
//æ¶ˆæ¯é˜Ÿåˆ—æ–‡ä»¶ ConsumeQueueåˆ·ç›˜çº¿ç¨‹ã€‚
private final FlushConsumeQueueService flushConsumeQueueService;
//æ¸…é™¤ CommitLog æ–‡ä»¶æœåŠ¡
private final CleanCommitLogService cleanCommitLogService;
//æ¸…é™¤ ConsumeQueue æ–‡ä»¶æœåŠ¡
private final CleanConsumeQueueService cleanConsumeQueueService;

private final CorrectLogicOffsetService correctLogicOffsetService;

//ç´¢å¼•æ–‡ä»¶å®ç°ç±»
private final IndexService indexService;
//MappedFile åˆ†é…æœåŠ¡
private final AllocateMappedFileService allocateMappedFileService;
//CommitLogæ¶ˆæ¯åˆ†å‘ï¼Œæ ¹æ® CommitLogæ–‡ä»¶æ„å»º ConsumeQueueã€ IndexFile æ–‡ä»¶ ã€‚
private ReputMessageService reputMessageService;
//å­˜å‚¨ HA æœºåˆ¶
private HAService haService;
//æ¶ˆæ¯å †å†…å­˜ç¼“å­˜
private final StoreStatsService storeStatsService;
private final TransientStorePool transientStorePool;

private final RunningFlags runningFlags = new RunningFlags();
private final SystemClock systemClock = new SystemClock();

private final ScheduledExecutorService scheduledExecutorService;
private final BrokerStatsManager brokerStatsManager;
//æ¶ˆæ¯æ‹‰å–é•¿è½®è¯¢æ¨¡å¼æ¶ˆæ¯è¾¾åˆ°ç›‘å¬å™¨
private final MessageArrivingListener messageArrivingListener;
//Brokeré…ç½®å±æ€§
private final BrokerConfig brokerConfig;

private volatile boolean shutdown = true;
//æ–‡ä»¶åˆ·ç›˜æ£€æµ‹ç‚¹
private StoreCheckpoint storeCheckpoint;
private TimerMessageStore timerMessageStore;

private AtomicLong printTimes = new AtomicLong(0);
//CommitLog æ–‡ä»¶è½¬å‘è¯·æ±‚
private final LinkedList&lt;CommitLogDispatcher&gt; dispatcherList;
</code></pre>
<h2 id="43-æ¶ˆæ¯å‘é€å­˜å‚¨æµç¨‹">4.3 æ¶ˆæ¯å‘é€å­˜å‚¨æµç¨‹</h2>
<p><img src="https://q456qq520.github.io/post-images/1663315678088.png" alt="æ¶ˆæ¯å­˜å‚¨æ—¶åºå›¾" loading="lazy"><br>
æ¶ˆæ¯å­˜å‚¨å…¥å£: org.apache.rocketmq.store.DefaultMessageStore#putMessageã€‚</p>
<p><strong>Step 1</strong>:å¦‚æœå½“å‰Brokeråœæ­¢å·¥ä½œæˆ– Brokerä¸ºSLAVEè§’è‰²æˆ–å½“å‰Rocketä¸æ”¯æŒå†™å…¥åˆ™æ‹’ç»æ¶ˆæ¯å†™å…¥;å¦‚æœæ¶ˆæ¯ä¸»é¢˜é•¿åº¦è¶…è¿‡256ä¸ªå­—ç¬¦ã€æ¶ˆæ¯å±æ€§é•¿åº¦è¶…è¿‡65536ä¸ªå­—ç¬¦å°†æ‹’ç»è¯¥æ¶ˆæ¯å†™äººã€‚</p>
<p><strong>Step 2</strong>:å¦‚æœæ¶ˆæ¯çš„å»¶è¿Ÿçº§åˆ«å¤§äº0ï¼Œå°†æ¶ˆæ¯çš„åŸä¸»é¢˜åç§°ä¸åŸæ¶ˆæ¯é˜Ÿåˆ— ID å­˜å…¥æ¶ˆæ¯å±æ€§ä¸­ï¼Œç”¨å»¶è¿Ÿæ¶ˆæ¯ä¸»é¢˜SCHEDULE_TOPICã€æ¶ˆæ¯é˜Ÿåˆ— ID æ›´æ–°åŸå…ˆæ¶ˆæ¯çš„ä¸»é¢˜ä¸é˜Ÿåˆ—ã€‚</p>
<p><strong>Step 3</strong>:è·å–å½“å‰å¯ä»¥å†™å…¥çš„ Commitlogæ–‡ä»¶</p>
<pre><code class="language-java">MappedFile unlockMappedFile = null;
MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile();
</code></pre>
<p>Commitlogæ–‡ä»¶å­˜å‚¨ç›®å½•ä¸º<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>R</mi><mi>O</mi><mi>C</mi><mi>K</mi><mi>E</mi><msub><mi>T</mi><mi>H</mi></msub><mi>O</mi><mi>M</mi><mi>E</mi></mrow><mi mathvariant="normal">/</mi><mi>s</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>e</mi><mi mathvariant="normal">/</mi><mi>c</mi><mi>o</mi><mi>m</mi><mi>m</mi><mi>i</mi><mi>t</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi mathvariant="normal">ç›®</mi><mi mathvariant="normal">å½•</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">æ¯</mi><mi mathvariant="normal">ä¸€</mi><mi mathvariant="normal">ä¸ª</mi><mi mathvariant="normal">æ–‡</mi><mi mathvariant="normal">ä»¶</mi><mi mathvariant="normal">é»˜</mi><mi mathvariant="normal">è®¤</mi><mn>1</mn><mi>G</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">ä¸€</mi><mi mathvariant="normal">ä¸ª</mi><mi mathvariant="normal">æ–‡</mi><mi mathvariant="normal">ä»¶</mi><mi mathvariant="normal">å†™</mi><mi mathvariant="normal">æ»¡</mi><mi mathvariant="normal">å</mi><mi mathvariant="normal">å†</mi><mi mathvariant="normal">åˆ›</mi><mi mathvariant="normal">å»º</mi><mi mathvariant="normal">å¦</mi><mi mathvariant="normal">å¤–</mi><mi mathvariant="normal">ä¸€</mi><mi mathvariant="normal">ä¸ª</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">ä»¥</mi><mi mathvariant="normal">è¯¥</mi><mi mathvariant="normal">æ–‡</mi><mi mathvariant="normal">ä»¶</mi><mi mathvariant="normal">ä¸­</mi><mi mathvariant="normal">ç¬¬</mi><mi mathvariant="normal">ä¸€</mi><mi mathvariant="normal">ä¸ª</mi><mi mathvariant="normal">å</mi><mi mathvariant="normal">ç§»</mi><mi mathvariant="normal">é‡</mi><mi mathvariant="normal">ä¸º</mi><mi mathvariant="normal">æ–‡</mi><mi mathvariant="normal">ä»¶</mi><mi mathvariant="normal">å</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">å</mi><mi mathvariant="normal">ç§»</mi><mi mathvariant="normal">é‡</mi><mi mathvariant="normal">å°</mi><mi mathvariant="normal">äº</mi><mn>20</mn><mi mathvariant="normal">ä½</mi><mi mathvariant="normal">ç”¨</mi><mn>0</mn><mi mathvariant="normal">è¡¥</mi><mi mathvariant="normal">é½</mi><mi mathvariant="normal">ã€‚</mi><mi>M</mi><mi>a</mi><mi>p</mi><mi>p</mi><mi>e</mi><mi>d</mi><mi>F</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>Q</mi><mi>u</mi><mi>e</mi><mi>u</mi><mi>e</mi><mi mathvariant="normal">å¯</mi><mi mathvariant="normal">ä»¥</mi><mi mathvariant="normal">çœ‹</mi><mi mathvariant="normal">ä½œ</mi><mi mathvariant="normal">æ˜¯</mi></mrow><annotation encoding="application/x-tex">{ROCKET_HOME}/store/commitlog ç›®å½•ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶é»˜è®¤1Gï¼Œä¸€ä¸ªæ–‡ä»¶å†™æ»¡åå†åˆ›å»ºå¦å¤–ä¸€ä¸ªï¼Œä»¥è¯¥æ–‡ä»¶ä¸­ç¬¬ä¸€ä¸ªåç§»é‡ä¸ºæ–‡ä»¶åï¼Œåç§»é‡å°äº20ä½ç”¨0è¡¥é½ã€‚MappedFileQueue å¯ä»¥çœ‹ä½œæ˜¯</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span></span><span class="mord">/</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord">/</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord cjk_fallback">ç›®</span><span class="mord cjk_fallback">å½•</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">æ¯</span><span class="mord cjk_fallback">ä¸€</span><span class="mord cjk_fallback">ä¸ª</span><span class="mord cjk_fallback">æ–‡</span><span class="mord cjk_fallback">ä»¶</span><span class="mord cjk_fallback">é»˜</span><span class="mord cjk_fallback">è®¤</span><span class="mord">1</span><span class="mord mathdefault">G</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">ä¸€</span><span class="mord cjk_fallback">ä¸ª</span><span class="mord cjk_fallback">æ–‡</span><span class="mord cjk_fallback">ä»¶</span><span class="mord cjk_fallback">å†™</span><span class="mord cjk_fallback">æ»¡</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">å†</span><span class="mord cjk_fallback">åˆ›</span><span class="mord cjk_fallback">å»º</span><span class="mord cjk_fallback">å¦</span><span class="mord cjk_fallback">å¤–</span><span class="mord cjk_fallback">ä¸€</span><span class="mord cjk_fallback">ä¸ª</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">ä»¥</span><span class="mord cjk_fallback">è¯¥</span><span class="mord cjk_fallback">æ–‡</span><span class="mord cjk_fallback">ä»¶</span><span class="mord cjk_fallback">ä¸­</span><span class="mord cjk_fallback">ç¬¬</span><span class="mord cjk_fallback">ä¸€</span><span class="mord cjk_fallback">ä¸ª</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">ç§»</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">ä¸º</span><span class="mord cjk_fallback">æ–‡</span><span class="mord cjk_fallback">ä»¶</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">ç§»</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">å°</span><span class="mord cjk_fallback">äº</span><span class="mord">2</span><span class="mord">0</span><span class="mord cjk_fallback">ä½</span><span class="mord cjk_fallback">ç”¨</span><span class="mord">0</span><span class="mord cjk_fallback">è¡¥</span><span class="mord cjk_fallback">é½</span><span class="mord cjk_fallback">ã€‚</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">a</span><span class="mord mathdefault">p</span><span class="mord mathdefault">p</span><span class="mord mathdefault">e</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">Q</span><span class="mord mathdefault">u</span><span class="mord mathdefault">e</span><span class="mord mathdefault">u</span><span class="mord mathdefault">e</span><span class="mord cjk_fallback">å¯</span><span class="mord cjk_fallback">ä»¥</span><span class="mord cjk_fallback">çœ‹</span><span class="mord cjk_fallback">ä½œ</span><span class="mord cjk_fallback">æ˜¯</span></span></span></span>  {ROCKET_HOME}/store/commitlogæ–‡ä»¶å¤¹ï¼Œè€ŒMappedFileåˆ™å¯¹åº”è¯¥æ–‡ä»¶å¤¹ä¸‹ä¸€ä¸ªä¸ªçš„æ–‡ä»¶ã€‚</p>
<p><strong>Step 4</strong>:åœ¨å†™å…¥Commitlogä¹‹å‰ï¼Œå…ˆç”³è¯·putMessageLock,ä¹Ÿå°±æ˜¯å°†æ¶ˆæ¯å­˜å‚¨åˆ°Commitlogæ–‡ä»¶ä¸­æ˜¯ä¸²è¡Œçš„ ã€‚</p>
<pre><code class="language-java">putMessageLock.lock(); //spin or ReentrantLock ,depending on store config
</code></pre>
<p>**Step 5 **:è®¾ç½®æ¶ˆæ¯çš„å­˜å‚¨æ—¶é—´ï¼Œå¦‚æœmappedFileä¸ºç©ºï¼Œè¡¨æ˜$  {ROCKET_HOME}/store/Commitlogç›®å½•ä¸‹ä¸å­˜åœ¨ä»»ä½•æ–‡ä»¶ï¼Œè¯´æ˜æœ¬æ¬¡æ¶ˆæ¯æ˜¯ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€ï¼Œç”¨åç§»é‡0åˆ›å»ºç¬¬ä¸€ä¸ªcommitæ–‡ä»¶ï¼Œæ–‡ä»¶ä¸º 00000000000000000000ï¼Œå¦‚æœæ–‡ä»¶åˆ›å»ºå¤±è´¥ï¼ŒæŠ›å‡º CREATE MAPEDFILE FAILEDï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯ç£ç›˜ç©ºé—´ä¸è¶³æˆ–æƒé™ä¸å¤Ÿã€‚</p>
<pre><code class="language-java">if (null == mappedFile || mappedFile.isFull()) {
    mappedFile = this.mappedFileQueue.getLastMappedFile(0); // Mark: NewFile may be cause noise
}
if (null == mappedFile) {
    log.error(&quot;create mapped file1 error, topic: &quot; + msg.getTopic() + &quot; clientAddr: &quot; + msg.getBornHostString());
    beginTimeInLock = 0;
    return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.CREATE_MAPPED_FILE_FAILED, null));
}
</code></pre>
<p><strong>Step 6</strong> :å°†æ¶ˆæ¯è¿½åŠ åˆ° MappedFile ä¸­ã€‚ é¦–å…ˆå…ˆè·å– MappedFile å½“å‰å†™æŒ‡é’ˆï¼Œå¦‚æœcurrentPoså¤§äºæˆ–ç­‰äºæ–‡ä»¶å¤§å°åˆ™è¡¨æ˜æ–‡ä»¶å·²å†™æ»¡ï¼ŒæŠ›å‡º AppendMessageStatus.UNKNOWN_ ERRORã€‚ å¦‚æœ currentPoså°äºæ–‡ä»¶å¤§å°ï¼Œé€šè¿‡ slice()æ–¹æ³•åˆ›å»ºä¸€ä¸ªä¸ MappedFile çš„å…±äº«å†…å­˜åŒºï¼Œå¹¶è®¾ç½®position ä¸ºå½“å‰æŒ‡é’ˆã€‚</p>
<pre><code class="language-java">public AppendMessageResult appendMessagesInner(final MessageExt messageExt, final AppendMessageCallback cb,
                                                PutMessageContext putMessageContext) {
    assert messageExt != null;
    assert cb != null;

    int currentPos = WROTE_POSITION_UPDATER.get(this);

    if (currentPos &lt; this.fileSize) {
        ByteBuffer byteBuffer = appendMessageBuffer().slice();
        byteBuffer.position(currentPos);
        AppendMessageResult result;
        if (messageExt instanceof MessageExtBatch &amp;&amp; !((MessageExtBatch) messageExt).isInnerBatch()) {
            // traditional batch message
            result = cb.doAppend(this.getFileFromOffset(), byteBuffer, this.fileSize - currentPos,
                    (MessageExtBatch) messageExt, putMessageContext);
        } else if (messageExt instanceof MessageExtBrokerInner) {
            // traditional single message or newly introduced inner-batch message
            result = cb.doAppend(this.getFileFromOffset(), byteBuffer, this.fileSize - currentPos,
                    (MessageExtBrokerInner) messageExt, putMessageContext);
        } else {
            return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);
        }
        WROTE_POSITION_UPDATER.addAndGet(this, result.getWroteBytes());
        this.storeTimestamp = result.getStoreTimestamp();
        return result;
    }
    log.error(&quot;MappedFile.appendMessage return null, wrotePosition: {} fileSize: {}&quot;, currentPos, this.fileSize);
    return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);
}
</code></pre>
<p><strong>Step 7</strong>:åˆ›å»ºå…¨å±€å”¯ä¸€æ¶ˆæ¯ IDï¼Œæ¶ˆæ¯IDæœ‰16å­—èŠ‚ã€‚å‰4å­—èŠ‚ä¸ºIPï¼Œä¸­é—´4å­—èŠ‚ä¸ºç«¯å£å·ï¼Œæœ€å8å­—èŠ‚ä¸ºæ¶ˆæ¯åç§»é‡ã€‚</p>
<pre><code class="language-java">long wroteOffset = fileFromOffset + byteBuffer.position();

Supplier&lt;String&gt; msgIdSupplier = () -&gt; {
    int sysflag = msgInner.getSysFlag();
    int msgIdLen = (sysflag &amp; MessageSysFlag.STOREHOSTADDRESS_V6_FLAG) == 0 ? 4 + 4 + 8 : 16 + 4 + 8;
    ByteBuffer msgIdBuffer = ByteBuffer.allocate(msgIdLen);
    MessageExt.socketAddress2ByteBuffer(msgInner.getStoreHost(), msgIdBuffer);
    msgIdBuffer.clear();//because socketAddress2ByteBuffer flip the buffer
    msgIdBuffer.putLong(msgIdLen - 8, wroteOffset);
    return UtilAll.bytes2string(msgIdBuffer.array());
};
</code></pre>
<p>å¯ä»¥é€šè¿‡ UtilAll.bytes2stringæ–¹æ³•å°† msgld å­—èŠ‚æ•°ç»„è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œé€šè¿‡ Uti1All.string2bytes æ–¹æ³•å°†msgldå­—ç¬¦ä¸²è¿˜åŸæˆ16ä¸ªå­—èŠ‚çš„å­—èŠ‚æ•°ç»„ï¼Œä»è€Œæ ¹æ®æå–æ¶ˆæ¯åç§»é‡ï¼Œå¯ä»¥å¿«é€Ÿé€šè¿‡msgldæ‰¾åˆ°æ¶ˆæ¯å†…å®¹ã€‚</p>
<p><strong>Step 8</strong> : è·å–è¯¥æ¶ˆæ¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„åç§»é‡ã€‚CommitLogä¸­ä¿å­˜äº†å½“å‰æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—çš„å½“å‰å¾…å†™å…¥åç§»é‡ã€‚</p>
<p><strong>Step 9</strong>:æ ¹æ®æ¶ˆæ¯ã€ä½“çš„é•¿åº¦ã€ä¸»é¢˜çš„é•¿åº¦ã€å±æ€§çš„é•¿åº¦ç»“åˆæ¶ˆæ¯å­˜å‚¨æ ¼å¼è®¡ç®—æ¶ˆæ¯çš„æ€»é•¿åº¦ã€‚</p>
<p><strong>Step l0</strong> :å¦‚æœæ¶ˆæ¯é•¿åº¦+END_FILE_MIN_BLANK_LENGTHå¤§äºCommitLogæ–‡ä»¶çš„ç©ºé—²ç©ºé—´ï¼Œåˆ™è¿”å› AppendMessageStatus.END_OF_FILE, Brokerä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ CommitLogæ–‡ä»¶æ¥å­˜å‚¨è¯¥æ¶ˆæ¯ã€‚ ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªCommitLogæ–‡ä»¶æœ€å°‘ä¼šç©ºé—² 8ä¸ªå­— èŠ‚ï¼Œé«˜4å­—èŠ‚å­˜å‚¨å½“å‰æ–‡ä»¶å‰©ä½™ç©ºé—´ï¼Œä½4å­—èŠ‚å­˜å‚¨é­”æ•° : CommitLog.BLANK MAGIC CODE ã€‚</p>
<pre><code class="language-java">if ((msgLen + END_FILE_MIN_BLANK_LENGTH) &gt; maxBlank) {
    this.msgStoreItemMemory.clear();
    // 1 TOTALSIZE
    this.msgStoreItemMemory.putInt(maxBlank);
    // 2 MAGICCODE
    this.msgStoreItemMemory.putInt(CommitLog.BLANK_MAGIC_CODE);
    // 3 The remaining space may be any value
    // Here the length of the specially set maxBlank
    final long beginTimeMills = CommitLog.this.defaultMessageStore.now();
    byteBuffer.put(this.msgStoreItemMemory.array(), 0, 8);
    return new AppendMessageResult(AppendMessageStatus.END_OF_FILE, wroteOffset,
        maxBlank, /* only wrote 8 bytes, but declare wrote maxBlank for compute write position */
        msgIdSupplier, msgInner.getStoreTimestamp(),
        queueOffset, CommitLog.this.defaultMessageStore.now() - beginTimeMills);
}
</code></pre>
<p><strong>Step 11</strong> :å°†æ¶ˆæ¯å†…å®¹å­˜å‚¨åˆ°ByteBufferä¸­ï¼Œç„¶ååˆ›å»ºAppendMessageResultã€‚ è¿™é‡Œåªæ˜¯å°†æ¶ˆæ¯å­˜å‚¨åœ¨ MappedFileå¯¹åº”çš„å†…å­˜æ˜ å°„Bufferä¸­ï¼Œå¹¶æ²¡æœ‰åˆ·å†™åˆ°ç£ç›˜ã€‚</p>
<pre><code class="language-java">final long beginTimeMills = CommitLog.this.defaultMessageStore.now();
CommitLog.this.getMessageStore().getPerfCounter().startTick(&quot;WRITE_MEMORY_TIME_MS&quot;);
// Write messages to the queue buffer
byteBuffer.put(preEncodeBuffer);
CommitLog.this.getMessageStore().getPerfCounter().endTick(&quot;WRITE_MEMORY_TIME_MS&quot;);
msgInner.setEncodedBuff(null);
return new AppendMessageResult(AppendMessageStatus.PUT_OK, wroteOffset, msgLen, msgIdSupplier,msgInner.getStoreTimestamp(), queueOffset, CommitLog.this.defaultMessageStore.now() - beginTimeMills, messageNum);
</code></pre>
<blockquote>
<p>AppendMessageResultæ ¸å¿ƒå±æ€§</p>
</blockquote>
<pre><code class="language-java">public class AppendMessageResult {
    //æ¶ˆæ¯è¿½åŠ ç»“æœ  PUT_OK :è¿½åŠ æˆåŠŸ;END_OF_FILE :è¶…è¿‡æ–‡ä»¶å¤§å°;MESSAGE SIZE EXCEEDED :æ¶ˆæ¯é•¿åº¦è¶…è¿‡æœ€å¤§å…è®¸é•¿åº¦: PROPERTIES_SIZE_EXCEEDED :æ¶ˆæ¯ã€å±æ€§è¶…è¿‡æœ€å¤§å…è®¸é•¿åº¦; UNKNOWN ERROR :æœªçŸ¥å¼‚å¸¸ ã€‚
    private AppendMessageStatus status;
    // æ¶ˆæ¯çš„ç‰©ç†åç§»é‡
    private long wroteOffset;
    // æ¶ˆæ¯çš„å¤§å°
    private int wroteBytes;
    // æ¶ˆæ¯ ID
    private String msgId;
    private Supplier&lt;String&gt; msgIdSupplier;
    // æ¶ˆæ¯å­˜å‚¨æ—¶é—´æˆ³
    private long storeTimestamp;
    // æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—é€»è¾‘åç§»é‡ï¼Œç±»ä¼¼äºæ•°ç»„ä¸‹æ ‡
    private long logicsOffset;
    private long pagecacheRT = 0;
    //æ¶ˆæ¯æ¡æ•°ï¼Œæ‰¹é‡æ¶ˆæ¯å‘é€æ—¶æ¶ˆæ¯æ¡æ•°
    private int msgNum = 1;
}
</code></pre>
<p><strong>Step 12</strong>:æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘åç§»é‡ ã€‚</p>
<p><strong>Step 13</strong>:å¤„ç†å®Œæ¶ˆæ¯è¿½åŠ é€»è¾‘åå°†é‡Šæ”¾ putMessageLocké”ã€‚</p>
<p><strong>Step 14</strong> : DefaultAppendMessageCallback#doAppend åªæ˜¯å°†æ¶ˆæ¯è¿½åŠ åœ¨å†…å­˜ä¸­ï¼Œ éœ€è¦æ ¹æ®æ˜¯åŒæ­¥åˆ·ç›˜è¿˜æ˜¯å¼‚æ­¥åˆ·ç›˜æ–¹å¼ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œç„¶åæ‰§è¡Œ HA ä¸»ä»åŒæ­¥å¤åˆ¶ã€‚</p>
<h2 id="44-å­˜å‚¨æ–‡ä»¶ç»„ç»‡ä¸å†…å­˜æ˜ å°„">4.4 å­˜å‚¨æ–‡ä»¶ç»„ç»‡ä¸å†…å­˜æ˜ å°„</h2>
<p>RocketMQé€šè¿‡ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶æ¥æé«˜IOè®¿é—®æ€§èƒ½ï¼Œæ— è®ºæ˜¯CommitLogã€ ConsumeQueueè¿˜æ˜¯ IndexFileï¼Œå•ä¸ªæ–‡ä»¶éƒ½è¢«è®¾è®¡ä¸ºå›ºå®šé•¿åº¦ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶å†™æ»¡ä»¥åå†åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œæ–‡ä»¶åå°±ä¸ºè¯¥æ–‡ä»¶ç¬¬ ä¸€æ¡æ¶ˆæ¯å¯¹åº”çš„å…¨å±€ç‰©ç†åç§»é‡ã€‚</p>
<h3 id="441-mappedfilequeue-æ˜ å°„æ–‡ä»¶é˜Ÿåˆ—">4.4.1 MappedFileQueue æ˜ å°„æ–‡ä»¶é˜Ÿåˆ—</h3>
<p>MappedFileQueuå·³æ˜¯ MappedFile çš„ç®¡ç†å®¹å™¨ï¼Œ Mappå·³dFileQueueæ˜¯å¯¹å­˜å‚¨ç›®å½•çš„å°è£…ï¼Œä¾‹å¦‚ CommitLogæ–‡ä»¶çš„å­˜å‚¨è·¯å¾„${ROCKET_HOME}/store/commitlog/ï¼Œè¯¥ç›®å½•ä¸‹ä¼šå­˜åœ¨å¤šä¸ªå†…å­˜æ˜ å°„æ–‡ä»¶(MappedFile)ã€‚</p>
<pre><code class="language-java">public class MappedFileQueue implements Swappable {
    //å­˜å‚¨ç›®å½•
    protected final String storePath;
    //å•ä¸ªæ–‡ä»¶çš„å­˜å‚¨å¤§å°
    protected final int mappedFileSize;
    //MappedFile æ–‡ä»¶é›†åˆ
    protected final CopyOnWriteArrayList&lt;MappedFile&gt; mappedFiles = new CopyOnWriteArrayList&lt;MappedFile&gt;();
    //åˆ›å»º MappedFileæœåŠ¡ç±»
    protected final AllocateMappedFileService allocateMappedFileService;
    //å½“å‰åˆ·ç›˜æŒ‡é’ˆï¼Œè¡¨ç¤ºè¯¥æŒ‡é’ˆä¹‹å‰çš„æ‰€æœ‰æ•°æ®å…¨éƒ¨æŒä¹…åŒ–åˆ°ç£ç›˜
    protected long flushedWhere = 0;
    //å½“å‰æ•°æ®æäº¤æŒ‡é’ˆï¼Œå†…å­˜ä¸­ByteBufferå½“å‰çš„å†™æŒ‡é’ˆï¼Œè¯¥å€¼å¤§äºç­‰äºflushedWhere
    protected long committedWhere = 0;

    protected volatile long storeTimestamp = 0;
}
</code></pre>
<blockquote>
<p>æŸ¥æ‰¾ MappedFile</p>
</blockquote>
<pre><code class="language-java">/**
    * æŸ¥æ‰¾ MappedFile
    * @param timestamp
    * @return
    */
public MappedFile getMappedFileByTime(final long timestamp) {
    Object[] mfs = this.copyMappedFiles(0);

    if (null == mfs)
        return null;

    for (int i = 0; i &lt; mfs.length; i++) {
        MappedFile mappedFile = (MappedFile) mfs[i];
        if (mappedFile.getLastModifiedTimestamp() &gt;= timestamp) {
            return mappedFile;
        }
    }

    return (MappedFile) mfs[mfs.length - 1];
}
</code></pre>
<p>æ ¹æ®æ¶ˆæ¯å­˜å‚¨æ—¶é—´æˆ³æ¥æŸ¥æ‰¾ MappdFileã€‚ä»MappedFile åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´å¤§äºå¾…æŸ¥æ‰¾æ—¶é—´æˆ³çš„æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å›æœ€åä¸€ä¸ªMappedFileæ–‡ä»¶ã€‚</p>
<p>RocketMQ é‡‡å–å®šæ—¶åˆ é™¤å­˜å‚¨æ–‡ä»¶çš„ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å­˜å‚¨æ–‡ä»¶ä¸­ï¼Œ ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸ä¸€å®šæ˜¯ 00000000000000000000ï¼Œå› ä¸ºè¯¥æ–‡ä»¶åœ¨æŸä¸€æ—¶åˆ»ä¼šè¢«åˆ é™¤ï¼Œæ•…æ ¹æ®offsetå®šä½MappedFileçš„ç®—æ³•ä¸º</p>
<pre><code class="language-java">(int) ((offset / this.mappedFileSize) - (firstMappedFile.getFileFromOffset() / this.mappedFileSize));
</code></pre>
<blockquote>
<p>MappedFileQueue#findMappedFileByOffset</p>
</blockquote>
<pre><code class="language-java">public MappedFile findMappedFileByOffset(final long offset, final boolean returnFirstOnNotFound) {
    try {
        MappedFile firstMappedFile = this.getFirstMappedFile();
        MappedFile lastMappedFile = this.getLastMappedFile();
        if (firstMappedFile != null &amp;&amp; lastMappedFile != null) {
            if (offset &lt; firstMappedFile.getFileFromOffset() || offset &gt;= lastMappedFile.getFileFromOffset() + this.mappedFileSize) {
                LOG_ERROR.warn(&quot;Offset not matched. Request offset: {}, firstOffset: {}, lastOffset: {}, mappedFileSize: {}, mappedFiles count: {}&quot;,
                    offset,
                    firstMappedFile.getFileFromOffset(),
                    lastMappedFile.getFileFromOffset() + this.mappedFileSize,
                    this.mappedFileSize,
                    this.mappedFiles.size());
            } else {
                int index = (int) ((offset / this.mappedFileSize) - (firstMappedFile.getFileFromOffset() / this.mappedFileSize));
                MappedFile targetFile = null;
                try {
                    targetFile = this.mappedFiles.get(index);
                } catch (Exception ignored) {
                }

                if (targetFile != null &amp;&amp; offset &gt;= targetFile.getFileFromOffset()
                    &amp;&amp; offset &lt; targetFile.getFileFromOffset() + this.mappedFileSize) {
                    return targetFile;
                }

                for (MappedFile tmpMappedFile : this.mappedFiles) {
                    if (offset &gt;= tmpMappedFile.getFileFromOffset()
                        &amp;&amp; offset &lt; tmpMappedFile.getFileFromOffset() + this.mappedFileSize) {
                        return tmpMappedFile;
                    }
                }
            }

            if (returnFirstOnNotFound) {
                return firstMappedFile;
            }
        }
    } catch (Exception e) {
        log.error(&quot;findMappedFileByOffset Exception&quot;, e);
    }

    return null;
}
</code></pre>
<p>è·å–å­˜å‚¨æ–‡ä»¶æœ€å°åç§»é‡ï¼Œä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¹¶ä¸æ˜¯ç›´æ¥è¿”å›0ï¼Œè€Œæ˜¯è¿”å›MappedÂ­Fileçš„ getFileFormOffset()ã€‚</p>
<pre><code class="language-java">public long getMinOffset() {
    if (!this.mappedFiles.isEmpty()) {
        try {
            return this.mappedFiles.get(0).getFileFromOffset();
        } catch (IndexOutOfBoundsException e) {
            //continue;
        } catch (Exception e) {
            log.error(&quot;getMinOffset has exception.&quot;, e);
        }
    }
    return -1;
}
</code></pre>
<p>è·å–å­˜å‚¨æ–‡ä»¶çš„æœ€å¤§åç§»é‡ã€‚ è¿”å›æœ€åä¸€ä¸ªMappå·³dFileæ–‡ä»¶çš„fileFromOffsetåŠ ä¸ŠMappedFile æ–‡ä»¶å½“å‰çš„è¯»æŒ‡é’ˆã€‚</p>
<pre><code class="language-java">public long getMaxOffset() {
    MappedFile mappedFile = getLastMappedFile();
    if (mappedFile != null) {
        return mappedFile.getFileFromOffset() + mappedFile.getReadPosition();
    }
    return 0;
}
</code></pre>
<p>è¿”å›å­˜å‚¨æ–‡ä»¶å½“å‰çš„å†™æŒ‡é’ˆã€‚ è¿”å›æœ€åä¸€ä¸ªæ–‡ä»¶çš„ fileFromOffsetåŠ ä¸Šå½“å‰å†™æŒ‡é’ˆä½ç½®ã€‚</p>
<pre><code class="language-java">public long getMaxWrotePosition() {
    MappedFile mappedFile = getLastMappedFile();
    if (mappedFile != null) {
        return mappedFile.getFileFromOffset() + mappedFile.getWrotePosition();
    }
    return 0;
}
</code></pre>
<h3 id="442-mappedfile-å†…å­˜æ˜ å°„æ–‡ä»¶">4.4.2 MappedFile å†…å­˜æ˜ å°„æ–‡ä»¶</h3>
<p>MappedFile æ˜¯RocketMQå†…å­˜æ˜ å°„æ–‡ä»¶çš„å…·ä½“å®ç°ã€‚</p>
<pre><code class="language-java">public class DefaultMappedFile extends AbstractMappedFile {
    //æ“ä½œç³»ç»Ÿæ¯é¡µå¤§å°ï¼Œé»˜è®¤4k
    public static final int OS_PAGE_SIZE = 1024 * 4;
    protected static final InternalLogger log = InternalLoggerFactory.getLogger(LoggerName.STORE_LOGGER_NAME);

    //å½“å‰JVMå®ä¾‹ä¸­Mapped Fileè™šæ‹Ÿå†…å­˜
    protected static final AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY = new AtomicLong(0);
    //å½“å‰JVMå®ä¾‹ä¸­MappedFileå¯¹è±¡ä¸ªæ•°
    protected static final AtomicInteger TOTAL_MAPPED_FILES = new AtomicInteger(0);

    protected static final AtomicIntegerFieldUpdater&lt;DefaultMappedFile&gt; WROTE_POSITION_UPDATER;
    protected static final AtomicIntegerFieldUpdater&lt;DefaultMappedFile&gt; COMMITTED_POSITION_UPDATER;
    protected static final AtomicIntegerFieldUpdater&lt;DefaultMappedFile&gt; FLUSHED_POSITION_UPDATER;

    //å½“å‰è¯¥æ–‡ä»¶çš„å†™æŒ‡é’ˆï¼Œä»0å¼€å§‹
    protected volatile int wrotePosition;
    //å½“å‰æ–‡ä»¶çš„æäº¤æŒ‡é’ˆï¼Œå¦‚æœå¼€å¯transientStorePoolEnable åˆ™æ•°æ®ä¼šå­˜å‚¨åœ¨TransientStorePoolä¸­ï¼Œç„¶åæäº¤åˆ°å†…å­˜æ˜ å°„ByteBufferä¸­ï¼Œå†åˆ·å†™åˆ°ç£ç›˜ã€‚
    protected volatile int committedPosition;
    //åˆ·å†™åˆ°ç£ç›˜æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆä¹‹å‰çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­
    protected volatile int flushedPosition;
    //æ–‡ä»¶å¤§å°
    protected int fileSize;
    //æ–‡ä»¶é€šé“
    protected FileChannel fileChannel;
    /**
     * Message will put to here first, and then reput to FileChannel if writeBuffer is not null.
     */
    //å †å†…å­˜ByteBufferï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œæ•°æ®é¦–å…ˆå°†å­˜å‚¨åœ¨è¯¥Bufferä¸­ï¼Œç„¶åæäº¤åˆ°MappedFileå¯¹åº”çš„å†…å­˜æ˜ å°„æ–‡ä»¶Bufferã€‚transientStorePoolEnableä¸ºtrueæ—¶ä¸ä¸ºç©ºã€‚
    protected ByteBuffer writeBuffer = null;
    //å †å†…å­˜æ± ï¼Œ transientStorePoolEnableä¸ºtrueæ—¶å¯ç”¨ã€‚
    protected TransientStorePool transientStorePool = null;
    //æ–‡ä»¶åç§°
    protected String fileName;
    //è¯¥æ–‡ä»¶çš„åˆå§‹åç§»é‡
    protected long fileFromOffset;
    //ç‰©ç†æ–‡ä»¶
    protected File file;
    //ç‰©ç†æ–‡ä»¶å¯¹åº”çš„å†…å­˜æ˜ å°„ Buffer
    protected MappedByteBuffer mappedByteBuffer;
    //æ–‡ä»¶æœ€åä¸€æ¬¡ å†…å®¹å†™å…¥æ—¶é—´
    protected volatile long storeTimestamp = 0;
    //æ˜¯å¦æ˜¯MappedFileQueueé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ–‡ä»¶
    protected boolean firstCreateInQueue = false;
    private long lastFlushTime = -1L;

    protected MappedByteBuffer mappedByteBufferWaitToClean = null;
    protected long swapMapTime = 0L;
    protected long mappedByteBufferAccessCountSinceLastSwap = 0L;
}
</code></pre>
<h4 id="1-mappedfileåˆå§‹åŒ–">1. MappedFileåˆå§‹åŒ–</h4>
<pre><code class="language-java">
æ ¹æ®æ˜¯å¦å¼€å¯ transientStorePoo!Enable åœ¨ä¸¤ç§åˆå§‹åŒ–æƒ…å†µ transientStorePoolEnable
trueè¡¨ç¤ºå†…å®¹å…ˆå­˜å‚¨åœ¨å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ Commit çº¿ç¨‹å°†æ•°æ®æäº¤åˆ°å†…å­˜æ˜ å°„ uffer
ä¸­ï¼Œå†é€šè¿‡ Flush çº¿ç¨‹å°†å†…å­˜æ˜ å°„ Bufferä¸­çš„æ•°æ®æŒåŒ–åˆ°ç£ç›˜ä¸­ã€‚

&gt;åˆå§‹åŒ–
private void init(final String fileName, final int fileSize) throws IOException {
    this.fileName = fileName;
    this.fileSize = fileSize;
    this.file = new File(fileName);

    //åˆå§‹åŒ– fileFromOffset ä¸ºæ–‡ä»¶åï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶åä»£è¡¨è¯¥æ–‡ä»¶çš„èµ·å§‹åç§»é‡
    this.fileFromOffset = Long.parseLong(this.file.getName());
    boolean ok = false;

    UtilAll.ensureDirOK(this.file.getParent());

    try {
        //åˆ›å»ºè¯»å†™æ–‡ä»¶é€šé“ï¼Œå¹¶å°†æ–‡ä»¶å†…å®¹ä½¿ç”¨ NIO çš„å†…å­˜æ˜ å°„ Bufferå°†æ–‡ä»¶æ˜  å°„åˆ°å†…å­˜ä¸­ã€‚
        this.fileChannel = new RandomAccessFile(this.file, &quot;rw&quot;).getChannel();
        this.mappedByteBuffer = this.fileChannel.map(MapMode.READ_WRITE, 0, fileSize);
        TOTAL_MAPPED_VIRTUAL_MEMORY.addAndGet(fileSize);
        TOTAL_MAPPED_FILES.incrementAndGet();
        ok = true;
    } catch (FileNotFoundException e) {
        log.error(&quot;Failed to create file &quot; + this.fileName, e);
        throw e;
    } catch (IOException e) {
        log.error(&quot;Failed to map file &quot; + this.fileName, e);
        throw e;
    } finally {
        if (!ok &amp;&amp; this.fileChannel != null) {
            this.fileChannel.close();
        }
    }
}
</code></pre>
<p>å¦‚æœtransientstorePooIEnabIe ä¸º trueï¼Œåˆ™åˆå§‹åŒ– MappedFile çš„ writeBufferã€‚</p>
<blockquote>
<p>åˆå§‹åŒ–</p>
</blockquote>
<pre><code class="language-java">@Override
public void init(final String fileName, final int fileSize,
                    final TransientStorePool transientStorePool) throws IOException {
    init(fileName, fileSize);
    this.writeBuffer = transientStorePool.borrowBuffer();
    this.transientStorePool = transientStorePool;
}
</code></pre>
<h4 id="2-mappedfileæäº¤commit">2. MappedFileæäº¤(commit)</h4>
<p>å†…å­˜æ˜ å°„æ–‡ä»¶çš„æäº¤åŠ¨ä½œç”± MappedFile çš„commitæ–¹æ³•å®ç°ã€‚</p>
<blockquote>
<p>Commitä»£ç </p>
</blockquote>
<pre><code class="language-java">@Override
public int commit(final int commitLeastPages) {
    if (writeBuffer == null) {
        //no need to commit data to file channel, so just regard wrotePosition as committedPosition.
        //writeBufferå¦‚æœä¸ºç©ºï¼Œç›´æ¥è¿”å› wrotePositionæŒ‡é’ˆ
        return WROTE_POSITION_UPDATER.get(this);
    }
    //åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å°æäº¤é¡µæ•°,ä¸æ»¡åˆ™ä¸æ‰§è¡Œæœ¬æ¬¡æäº¤æ“ä½œï¼Œå¾…ä¸‹æ¬¡æäº¤ 
    if (this.isAbleToCommit(commitLeastPages)) {
        if (this.hold()) {
             //å…·ä½“æäº¤
            commit0();
            this.release();
        } else {
            log.warn(&quot;in commit, hold failed, commit offset = &quot; + COMMITTED_POSITION_UPDATER.get(this));
        }
    }

    // All dirty data has been committed to FileChannel.
    if (writeBuffer != null &amp;&amp; this.transientStorePool != null &amp;&amp; this.fileSize == COMMITTED_POSITION_UPDATER.get(this)) {
        this.transientStorePool.returnBuffer(writeBuffer);
        this.writeBuffer = null;
    }

    return COMMITTED_POSITION_UPDATER.get(this);
}
</code></pre>
<blockquote>
<p>åˆ¤æ–­æ˜¯å¦éœ€è¦æäº¤</p>
</blockquote>
<pre><code class="language-java">protected boolean isAbleToCommit(final int commitLeastPages) {
    int commit = COMMITTED_POSITION_UPDATER.get(this);
    int write = WROTE_POSITION_UPDATER.get(this);
    //å¦‚æœæ–‡ä»¶æ»¡äº†
    if (this.isFull()) {
        return true;
    }
    //å¦‚æœ commitLeastPageså¤§äº 0, åˆ™æ¯”è¾ƒ wrotePosition( å½“å‰ writeBuffer çš„å†™æŒ‡é’ˆ)ä¸ä¸Š ä¸€æ¬¡æäº¤çš„æŒ‡é’ˆ(committedPosition)
    // çš„å·®å€¼ï¼Œé™¤ä»¥ OS_PAGE_SIZEå¾—åˆ°å½“å‰è„é¡µçš„æ•°é‡ï¼Œå¦‚æœå¤§äº commitLeastPagesåˆ™è¿”å› true;
    if (commitLeastPages &gt; 0) {
        return ((write / OS_PAGE_SIZE) - (commit / OS_PAGE_SIZE)) &gt;= commitLeastPages;
    }
    // å¦‚æœ commitLeastPages å° äº 0 è¡¨ç¤ºåªè¦å­˜åœ¨è„é¡µå°±æäº¤
    return write &gt; commit;
}
</code></pre>
<blockquote>
<p>å…·ä½“æäº¤</p>
</blockquote>
<pre><code class="language-java">protected void commit0() {
    int writePos = WROTE_POSITION_UPDATER.get(this);
    int lastCommittedPosition = COMMITTED_POSITION_UPDATER.get(this);

    if (writePos - lastCommittedPosition &gt; 0) {
        try {
            //åˆ›å»º writeBufferçš„å…±äº«ç¼“å­˜åŒº
            ByteBuffer byteBuffer = writeBuffer.slice();

            //å°†æ–°åˆ›å»ºçš„ position å› é€€åˆ°ä¸Šä¸€æ¬¡æäº¤çš„ä½ç½®( lastCommittedPosition)
            byteBuffer.position(lastCommittedPosition);
            //è®¾ç½® limitä¸º wrotePosition (å½“å‰æœ€å¤§æœ‰æ•ˆæ•°æ®æŒ‡é’ˆ)
            byteBuffer.limit(writePos);
            //æ›´æ–°committedPositionæŒ‡é’ˆä¸ºwrotePosition
            this.fileChannel.position(lastCommittedPosition);
            //æŠŠlastCommittedPositionåˆ°wrotePositionçš„æ•°æ®å¤åˆ¶ (å†™å…¥)åˆ°FileChannelä¸­
            this.fileChannel.write(byteBuffer);
            COMMITTED_POSITION_UPDATER.set(this, writePos);
        } catch (Throwable e) {
            log.error(&quot;Error occurred when commit data to FileChannel.&quot;, e);
        }
    }
}
</code></pre>
<p>commitçš„ä½œç”¨å°±æ˜¯å°†MappedFile#Â­ writeBuffer ä¸­çš„æ•°æ®æäº¤åˆ°æ–‡ä»¶é€šé“ FileChannel ä¸­ã€‚</p>
<p><em>ByteBuffer ä½¿ç”¨æŠ€å·§ : slice() æ–¹æ³•åˆ›å»º ä¸€ ä¸ªå…±äº«ç¼“å­˜åŒº ï¼Œä¸åŸå…ˆçš„ ByteBuffer å…±äº«å†…å­˜ä½†ç»´æŠ¤ä¸€å¥—ç‹¬ç«‹çš„æŒ‡é’ˆ (positionã€ markã€ limit)ã€‚</em></p>
<h4 id="3-mappedfileåˆ·ç›˜flush">3. MappedFileåˆ·ç›˜(flush)</h4>
<p>åˆ·ç›˜æŒ‡çš„æ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®åˆ·å†™åˆ°ç£ç›˜ï¼Œæ°¸ä¹…å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼Œå…¶å…·ä½“å®ç°ç”±MappedFileçš„flushæ–¹æ³•å®ç°ã€‚</p>
<blockquote>
<p>flushæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">@Override
public int flush(final int flushLeastPages) {
    if (this.isAbleToFlush(flushLeastPages)) {
        if (this.hold()) {
            //è·å–æœ€å¤§è¯»æŒ‡é’ˆ
            int value = getReadPosition();

            try {
                this.mappedByteBufferAccessCountSinceLastSwap++;

                //We only append data to fileChannel or mappedByteBuffer, never both.
                if (writeBuffer != null || this.fileChannel.position() != 0) {
                    this.fileChannel.force(false);
                } else {
                    this.mappedByteBuffer.force();
                }
                this.lastFlushTime = System.currentTimeMillis();
            } catch (Throwable e) {
                log.error(&quot;Error occurred when force data to disk.&quot;, e);
            }

            FLUSHED_POSITION_UPDATER.set(this, value);
            this.release();
        } else {
            log.warn(&quot;in flush, hold failed, flush offset = &quot; + FLUSHED_POSITION_UPDATER.get(this));
            FLUSHED_POSITION_UPDATER.set(this, getReadPosition());
        }
    }
    return this.getFlushedPosition();
}
</code></pre>
<p>åˆ·å†™ç£ç›˜ï¼Œç›´æ¥è°ƒç”¨mappedByteBufferæˆ–fileChannelçš„forceæ–¹æ³•å°†å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆ flushedPositionåº”è¯¥ç­‰äºMappedByteBufferä¸­çš„å†™æŒ‡é’ˆ;å¦‚æœwriteÂ­Bufferä¸ä¸ºç©ºï¼ŒflushedPositionåº”ç­‰äºä¸Šä¸€æ¬¡commitæŒ‡é’ˆ;å› ä¸ºä¸Šä¸€æ¬¡æäº¤çš„æ•°æ®å°±æ˜¯è¿›å…¥åˆ°MappedByteBufferä¸­çš„æ•°æ®;å¦‚æœ writeBufferä¸ºç©ºï¼Œæ•°æ®æ˜¯ç›´æ¥è¿›å…¥åˆ°MappedÂ­ByteBuffer, wrotePositionä»£è¡¨çš„æ˜¯ MappedByteBufferä¸­çš„æŒ‡é’ˆï¼Œæ•…è®¾ç½®flushedPositionä¸ºwrotePositionã€‚</p>
<h4 id="4-è·å–-mappedfile-æœ€å¤§è¯»æŒ‡é’ˆ-getreadposition">4. è·å– MappedFile æœ€å¤§è¯»æŒ‡é’ˆ( getReadPosition)</h4>
<blockquote>
<p>è·å–æœ€å¤§è¯»æŒ‡é’ˆ</p>
</blockquote>
<pre><code class="language-java">public int getReadPosition() {
    return this.writeBuffer == null ? WROTE_POSITION_UPDATER.get(this) : COMMITTED_POSITION_UPDATER.get(this);
}
</code></pre>
<p>è·å–å½“å‰æ–‡ä»¶æœ€å¤§çš„å¯è¯»æŒ‡é’ˆã€‚å¦‚æœwriteBufferä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰çš„å†™æŒ‡é’ˆ;å¦‚æœwriteBufferä¸ä¸ºç©ºï¼Œ åˆ™è¿”å›ä¸Šä¸€æ¬¡æäº¤çš„æŒ‡é’ˆã€‚åªæœ‰æäº¤äº†çš„æ•°æ®(å†™å…¥åˆ° MappedByteBufferæˆ– FileChannelä¸­çš„æ•°æ® )æ‰æ˜¯å®‰å…¨çš„æ•°æ®ã€‚</p>
<blockquote>
<p>MappedFile#selectMappedBuffer</p>
</blockquote>
<pre><code class="language-java">public SelectMappedBufferResult selectMappedBuffer(int pos, int size) {
    int readPosition = getReadPosition();
    if ((pos + size) &lt;= readPosition) {
        if (this.hold()) {
            this.mappedByteBufferAccessCountSinceLastSwap++;

            ByteBuffer byteBuffer = this.mappedByteBuffer.slice();
            byteBuffer.position(pos);
            ByteBuffer byteBufferNew = byteBuffer.slice();
            byteBufferNew.limit(size);
            return new SelectMappedBufferResult(this.fileFromOffset + pos, byteBufferNew, size, this);
        } else {
            log.warn(&quot;matched, but hold failed, request pos: &quot; + pos + &quot;, fileFromOffset: &quot;
                    + this.fileFromOffset);
        }
    } else {
        log.warn(&quot;selectMappedBuffer request pos invalid, request pos: &quot; + pos + &quot;, size: &quot; + size
                + &quot;, fileFromOffset: &quot; + this.fileFromOffset);
    }

    return null;
}
</code></pre>
<p>æŸ¥æ‰¾ pos åˆ°å½“å‰æœ€å¤§å¯è¯»ä¹‹é—´çš„æ•°æ®ï¼Œç”±äºåœ¨æ•´ä¸ªå†™å…¥æœŸé—´éƒ½æœªæ›¾æ”¹å˜ MappedByteÂ­Bufferçš„æŒ‡é’ˆ ï¼Œæ‰€ä»¥mappedByteBuffer.slice()æ–¹æ³•è¿”å›çš„å…±äº«ç¼“å­˜åŒºç©ºé—´ä¸ºæ•´ä¸ªMappedÂ­Fileï¼Œç„¶åé€šè¿‡è®¾ç½® byteBufferçš„positionä¸ºå¾…æŸ¥æ‰¾çš„å€¼ï¼Œè¯»å–å­—èŠ‚ä¸ºå½“å‰å¯è¯»å­—èŠ‚é•¿åº¦ï¼Œæœ€ç»ˆè¿”å›çš„ ByteBuffer çš„ limit (å¯è¯» æœ€å¤§é•¿åº¦)ä¸º sizeã€‚æ•´ä¸ªå…±äº«ç¼“å­˜åŒºçš„å®¹é‡ä¸º(MappedFile#fileSize-pos)ï¼Œæ•…åœ¨æ“ä½œSelectMappedBufferResultä¸èƒ½å¯¹åŒ…å«åœ¨é‡Œé¢çš„ByteBufferè°ƒç”¨flipæ–¹æ³•ã€‚</p>
<p><em>æ“ä½œByteBuffer æ—¶å¦‚æœä½¿ç”¨äº†slice()æ–¹æ³•ï¼Œå¯¹å…¶ByteBufferè¿›è¡Œè¯»å–æ—¶ä¸€èˆ¬æ‰‹åŠ¨æŒ‡å®špositionä¸limit æŒ‡é’ˆï¼Œè€Œä¸æ˜¯è°ƒç”¨flipæ–¹æ³•æ¥åˆ‡æ¢è¯»å†™çŠ¶æ€ã€‚</em></p>
<h4 id="5-mappedfile-é”€æ¯-destory">5 . MappedFile é”€æ¯( destory)</h4>
<p>MappedFileæ–‡ä»¶é”€æ¯çš„å®ç°æ–¹æ³•ä¸ºpublic boolean destroy(final long intervalForcibly), intervalForciblyè¡¨ç¤ºæ‹’ç»è¢«é”€æ¯çš„æœ€å¤§å­˜æ´»æ—¶é—´ã€‚</p>
<p>Step 1:å…³é—­MappedFile</p>
<blockquote>
<p>destroy -&gt; shutdown()</p>
</blockquote>
<pre><code class="language-java">public void shutdown(final long intervalForcibly) {
    if (this.available) {
        //åˆæ¬¡è°ƒç”¨æ—¶ this.available ä¸º trueï¼Œè®¾ç½® available ä¸º false
        this.available = false;
        //è®¾ç½®åˆæ¬¡å…³é—­çš„æ—¶é—´æˆ³( firstShutdownTimestamp)ä¸ºå½“å‰æ—¶é—´æˆ³
        this.firstShutdownTimestamp = System.currentTimeMillis();
        //ç„¶åè°ƒç”¨ release()æ–¹æ³• å°è¯•é‡Šæ”¾èµ„æºï¼Œ
        this.release();
    } else if (this.getRefCount() &gt; 0) {
        //å¼•ç”¨æ¬¡æ•°å¤§äº0ï¼Œå¯¹æ¯”å½“å‰æ—¶é—´ä¸ firstShutdownTimestampï¼Œå¦‚æœå·²ç»è¶…è¿‡äº†å…¶æœ€å¤§æ‹’ç»å­˜æ´»æœŸï¼Œæ¯æ‰§è¡Œä¸€æ¬¡ï¼Œå°†å¼•ç”¨æ•°å‡å°‘ 1000ï¼Œç›´åˆ°å¼•ç”¨æ•°å°äº0
        if ((System.currentTimeMillis() - this.firstShutdownTimestamp) &gt;= intervalForcibly) {
            this.refCount.set(-1000 - this.getRefCount());
            this.release();
        }
    }
}
</code></pre>
<p>Step2 : åˆ¤æ–­æ˜¯å¦æ¸…ç†å®Œæˆ</p>
<blockquote>
<p>åˆ¤æ–­æ˜¯å¦æ¸…ç†å®Œæˆ</p>
</blockquote>
<pre><code class="language-java">public boolean isCleanupOver() {
    //å¼•ç”¨æ¬¡æ•°å°äºç­‰äº0å¹¶ä¸” cleanupOverä¸º true, cleanupOverä¸ºtrueçš„è§¦å‘æ¡ä»¶æ˜¯releaseæˆåŠŸå°†MappedByteBufferèµ„æºé‡Šæ”¾ã€‚
    return this.refCount.get() &lt;= 0 &amp;&amp; this.cleanupOver;
}
</code></pre>
<p>Step3: å…³é—­æ–‡ä»¶é€šé“ï¼Œ åˆ é™¤ç‰©ç†æ–‡ä»¶ã€‚</p>
<pre><code class="language-java">long lastModified = getLastModifiedTimestamp();
this.fileChannel.close();
log.info(&quot;close file channel &quot; + this.fileName + &quot; OK&quot;);

long beginTime = System.currentTimeMillis();
boolean result = this.file.delete();
</code></pre>
<p>åœ¨æ•´ MappedFileé”€æ¯è¿‡ç¨‹ï¼Œé¦–å…ˆéœ€è¦é‡Šæ”¾èµ„æºï¼Œé‡Šæ”¾èµ„æºçš„å‰ææ¡ä»¶æ˜¯è¯¥ MappedÂ­File çš„å¼•ç”¨å°äºç­‰äº 0ï¼Œæ¥ä¸‹æ¥é‡ç‚¹çœ‹ä¸€ä¸‹releaseæ–¹æ³•çš„å®ç°åŸç†ã€‚</p>
<pre><code class="language-java">public void release() {
    long value = this.refCount.decrementAndGet();
    if (value &gt; 0)
        return;

    synchronized (this) {
        this.cleanupOver = this.cleanup(value);
    }
}
</code></pre>
<p>å¦‚æœå¼•ç”¨æ•°å°äºç­‰äº0ï¼Œåˆ™æ‰§è¡Œ cleanup æ–¹æ³•</p>
<blockquote>
<p>cleanup()</p>
</blockquote>
<pre><code class="language-java">public boolean cleanup(final long currentRef) {
    if (this.isAvailable()) {
        //availableä¸ºtrueï¼Œè¡¨ç¤ºMappedFileå½“å‰å¯ç”¨ï¼Œæ— é¡»æ¸…ç†
        log.error(&quot;this file[REF:&quot; + currentRef + &quot;] &quot; + this.fileName
                + &quot; have not shutdown, stop unmapping.&quot;);
        return false;
    }

    if (this.isCleanupOver()) {
        //èµ„æºå·²ç»è¢«æ¸…é™¤ï¼Œè¿”å›true
        log.error(&quot;this file[REF:&quot; + currentRef + &quot;] &quot; + this.fileName
                + &quot; have cleanup, do not do it again.&quot;);
        return true;
    }

    //å¦‚æœæ˜¯å †å¤–å†…å­˜ï¼Œè°ƒç”¨å †å¤–å†…å­˜çš„cleanupæ–¹æ³•æ¸…é™¤
    UtilAll.cleanBuffer(this.mappedByteBuffer);
    UtilAll.cleanBuffer(this.mappedByteBufferWaitToClean);
    this.mappedByteBufferWaitToClean = null;
    TOTAL_MAPPED_VIRTUAL_MEMORY.addAndGet(this.fileSize * (-1));
    TOTAL_MAPPED_FILES.decrementAndGet();
    log.info(&quot;unmap file[REF:&quot; + currentRef + &quot;] &quot; + this.fileName + &quot; OK&quot;);
    return true;
}
</code></pre>
<h3 id="443-transientstorepool">4.4.3 TransientStorePool</h3>
<p>TransientStorePool: çŸ­æš‚çš„å­˜å‚¨æ± ã€‚ RocketMQå•ç‹¬åˆ›å»ºä¸€ä¸ªMappedByteBufferå†…å­˜ç¼“å­˜æ± ï¼Œç”¨æ¥ä¸´ æ—¶å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å…ˆå†™äººè¯¥å†…å­˜æ˜ å°„ä¸­ï¼Œç„¶åç”±commitçº¿ç¨‹å®šæ—¶å°†æ•°æ®ä»è¯¥å†…å­˜å¤åˆ¶åˆ°ä¸ç›®çš„ç‰©ç†æ–‡ä»¶å¯¹åº”çš„å†…å­˜æ˜ å°„ä¸­ã€‚ä¸»è¦ä½œç”¨æä¾›ä¸€ç§å†…å­˜é”å®šï¼Œå°†å½“å‰å †å¤–å†…å­˜ä¸€ç›´é”å®šåœ¨å†…å­˜ä¸­ï¼Œé¿å…è¢«è¿›ç¨‹å°†å†…å­˜äº¤æ¢åˆ°ç£ç›˜ã€‚</p>
<blockquote>
<p>æ ¸å¿ƒå±æ€§</p>
</blockquote>
<pre><code class="language-java">public class TransientStorePool {
  //avaliableBuffersä¸ªæ•°ï¼Œå¯é€šè¿‡åœ¨brokerä¸­é…ç½®æ–‡ä»¶ä¸­è®¾ç½® transient-StorePoolSizeï¼Œé»˜è®¤ä¸º5ã€‚
    private final int poolSize;
    //æ¯ä¸ª ByteBufferå¤§å°ï¼Œ é»˜è®¤ä¸ºmappedFileSizeCommitLogï¼Œè¡¨æ˜TransientStorePoolä¸ºcommitlogæ–‡ä»¶æœåŠ¡
    private final int fileSize;
    //ByteBufferå®¹å™¨ï¼ŒåŒç«¯é˜Ÿåˆ—
    private final Deque&lt;ByteBuffer&gt; availableBuffers;
    private final MessageStoreConfig storeConfig;
}
</code></pre>
<blockquote>
<p>åˆå§‹åŒ–</p>
</blockquote>
<pre><code class="language-java">public void init() {
        //åˆ›å»º poolSizeä¸ªå †å¤–å†…å­˜ ï¼Œ å¹¶åˆ©ç”¨com.sun.jna.Libraryç±»åº“å°†è¯¥æ‰¹å†…å­˜é”å®šï¼Œé¿å…è¢«ç½®æ¢åˆ°äº¤æ¢åŒºï¼Œæé«˜å­˜å‚¨æ€§èƒ½
    for (int i = 0; i &lt; poolSize; i++) {
        ByteBuffer byteBuffer = ByteBuffer.allocateDirect(fileSize);

        final long address = ((DirectBuffer) byteBuffer).address();
        Pointer pointer = new Pointer(address);
        LibC.INSTANCE.mlock(pointer, new NativeLong(fileSize));

        availableBuffers.offer(byteBuffer);
    }
}
</code></pre>
<h2 id="45-rocketmq-å­˜å‚¨æ–‡ä»¶">4.5 RocketMQ å­˜å‚¨æ–‡ä»¶</h2>
<p>RocketMQ å­˜å‚¨è·¯å¾„ä¸º${ROCKET_HOME}/store</p>
<figure data-type="image" tabindex="3"><img src="https://q456qq520.github.io/post-images/1664335193541.png" alt="file dir" loading="lazy"></figure>
<ol>
<li>commitlog:æ¶ˆæ¯å­˜å‚¨ç›®å½•</li>
<li>config:è¿è¡ŒæœŸé—´ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹åˆ—ä¿¡æ¯<br>
consumerFilter.json: ä¸»é¢˜æ¶ˆæ¯è¿‡æ»¤ä¿¡æ¯<br>
consumerOffset.json: é›†ç¾¤æ¶ˆè´¹æ¨¡å¼æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦<br>
delayOffset.json:å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–è¿›åº¦<br>
subscriptionGroup.json: æ¶ˆæ¯æ¶ˆè´¹ç»„é…ç½®ä¿¡æ¯<br>
topics.json: topicé…ç½®å±æ€§</li>
<li>consumequå·³ue:æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—å­˜å‚¨ç›®å½•</li>
<li>index:æ¶ˆæ¯ç´¢å¼•æ–‡ä»¶å­˜å‚¨ç›®å½•ã€‚</li>
<li>abort :å¦‚æœå­˜åœ¨ abortæ–‡ä»¶è¯´æ˜ Brokeréæ­£å¸¸å…³é—­ï¼Œè¯¥æ–‡ä»¶é»˜è®¤å¯åŠ¨æ—¶åˆ›å»ºï¼Œæ­£å¸¸<br>
é€€å‡ºä¹‹å‰åˆ é™¤ ã€‚</li>
<li>checkpoint:æ–‡ä»¶æ£€æµ‹ç‚¹ï¼Œå­˜å‚¨ commitlogæ–‡ä»¶æœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´æˆ³ã€ consumequeue<br>
æœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´ã€ index ç´¢å¼•æ–‡ä»¶æœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´æˆ³</li>
</ol>
<h3 id="451-commitlog-æ–‡ä»¶">4.5.1 Commitlog æ–‡ä»¶</h3>
<p>Commitlog æ–‡ä»¶å­˜å‚¨çš„é€»è¾‘è§†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼Œæ¯æ¡æ¶ˆæ¯çš„å‰é¢4ä¸ªå­—èŠ‚å­˜å‚¨è¯¥æ¡æ¶ˆæ¯çš„æ€»é•¿åº¦ã€‚<br>
<img src="https://q456qq520.github.io/post-images/1664335547565.png" alt="æ¶ˆæ¯ç»„ç»‡æ–¹å¼" loading="lazy"></p>
<p>åˆ†ææ¶ˆæ¯çš„æŸ¥æ‰¾å®ç°<br>
Step 1:è·å–å½“å‰ Commitlog ç›®å½•æœ€å°åç§»é‡ ï¼Œé¦–å…ˆè·å–ç›®å½•ä¸‹çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœè¯¥æ–‡ä»¶å¯ç”¨ï¼Œ åˆ™è¿”å›è¯¥æ–‡ä»¶çš„èµ·å§‹åç§»é‡ï¼Œå¦åˆ™è¿”å›ä¸‹ä¸€ä¸ªæ–‡ä»¶çš„èµ·å§‹åç§»é‡ã€‚</p>
<blockquote>
<p>è·å–æœ€å°åç§»é‡</p>
</blockquote>
<pre><code class="language-java">public long getMinOffset() {
    MappedFile mappedFile = this.mappedFileQueue.getFirstMappedFile();
    if (mappedFile != null) {
        if (mappedFile.isAvailable()) {
            return mappedFile.getFileFromOffset();
        } else {
            return this.rollNextFile(mappedFile.getFileFromOffset());
        }
    }
    return -1;
}
</code></pre>
<blockquote>
<p>æ–‡ä»¶ä¸å¯ç”¨</p>
</blockquote>
<pre><code class="language-java">public long rollNextFile(final long offset) {
        int mappedFileSize = this.defaultMessageStore.getMessageStoreConfig().getMappedFileSizeCommitLog();
        return offset + mappedFileSize - offset % mappedFileSize;
    }
</code></pre>
<p>æ ¹æ®è¯¥offsetè¿”å›ä¸‹ä¸€ä¸ªæ–‡ä»¶çš„èµ·å§‹åç§»é‡ã€‚é¦–å…ˆè·å–ä¸€ä¸ªæ–‡ä»¶çš„å¤§å°ï¼Œå‡å»(offset% mappedFileSize)å…¶ç›®çš„æ˜¯å›åˆ°ä¸‹ä¸€æ–‡ä»¶çš„èµ·å§‹åç§»é‡ã€‚</p>
<p>Step 2:æ ¹æ®åç§»é‡ä¸æ¶ˆæ¯é•¿åº¦æŸ¥æ‰¾æ¶ˆæ¯ã€‚</p>
<p>é¦–å…ˆæ ¹æ®åç§»æ‰¾åˆ°æ‰€åœ¨çš„ç‰©ç†åç§»é‡ï¼Œç„¶åç”¨ offset ä¸æ–‡ä»¶é•¿åº¦å–ä½™å¾—åˆ°åœ¨æ–‡ä»¶å†…çš„åç§»é‡ï¼Œä»è¯¥åç§»é‡è¯»å–sizeé•¿åº¦çš„å†…å®¹è¿”å›å³å¯ã€‚ å¦‚æœåªæ ¹æ®æ¶ˆæ¯åç§»æŸ¥æ‰¾æ¶ˆæ¯ï¼Œ åˆ™é¦–å…ˆæ‰¾åˆ°æ–‡ä»¶å†…çš„åç§»é‡ï¼Œç„¶åå°è¯•è¯»å–4ä¸ªå­—èŠ‚è·å–æ¶ˆæ¯ çš„å®é™…é•¿åº¦ï¼Œæœ€åè¯»å–æŒ‡å®šå­—èŠ‚å³å¯ã€‚</p>
<pre><code class="language-java">public SelectMappedBufferResult getMessage(final long offset, final int size) {
    int mappedFileSize = this.defaultMessageStore.getMessageStoreConfig().getMappedFileSizeCommitLog();
    MappedFile mappedFile = this.mappedFileQueue.findMappedFileByOffset(offset, offset == 0);
    if (mappedFile != null) {
        int pos = (int) (offset % mappedFileSize);
        return mappedFile.selectMappedBuffer(pos, size);
    }
    return null;
}
</code></pre>
<h3 id="452-consumequeue-æ–‡ä»¶">4.5.2 ConsumeQueue æ–‡ä»¶</h3>
<p>RocketMQåŸºäºä¸»é¢˜è®¢é˜…æ¨¡å¼å®ç°æ¶ˆæ¯æ¶ˆè´¹ï¼Œæ¶ˆè´¹è€…å…³å¿ƒçš„æ˜¯ä¸€ä¸ªä¸»é¢˜ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œä½†ç”±äºåŒä¸€ä¸»é¢˜çš„æ¶ˆæ¯ä¸è¿ç»­åœ°å­˜å‚¨åœ¨commitlogæ–‡ä»¶ä¸­ã€‚è®¾è®¡äº†æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶( Consumequeue)ï¼Œè¯¥æ–‡ä»¶å¯ä»¥çœ‹æˆæ˜¯ Commitlogå…³äºæ¶ˆæ¯æ¶ˆè´¹çš„â€œç´¢å¼•â€æ–‡ä»¶ï¼Œconsumequeueçš„ç¬¬ä¸€çº§ç›®å½•ä¸ºæ¶ˆæ¯ä¸»é¢˜ï¼Œç¬¬äºŒçº§ç›®å½•ä¸ºä¸»é¢˜çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<p>æ¯ä¸€ä¸ªconsumequeueæ¡ç›®ä¸ä¼šå­˜å‚¨å…¨é‡æ¶ˆæ¯ï¼Œç›®çš„æ˜¯ä¸ºäº†å¿«é€Ÿæ£€ç´¢ã€‚</p>
<p>å•ä¸ªConsumeQueueæ–‡ä»¶ä¸­é»˜è®¤åŒ…å«30ä¸‡ä¸ªæ¡ç›®ï¼Œå•ä¸ªæ–‡ä»¶çš„é•¿åº¦ä¸º 30wÃ—20 å­—èŠ‚ï¼Œå•ä¸ªConsumeQueueæ–‡ä»¶å¯ä»¥çœ‹å‡ºæ˜¯ä¸€ä¸ªConsumeQueueæ¡ç›®çš„æ•°ç»„ï¼Œå…¶ä¸‹æ ‡ä¸ºConsumeÂ­Queueçš„é€»è¾‘åç§»é‡ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¿›åº¦å­˜å‚¨çš„åç§»é‡å³é€»è¾‘åç§»é‡ã€‚ConsumeQueue å³ä¸º Commitlogæ–‡ä»¶çš„ç´¢å¼•æ–‡ä»¶ï¼Œå…¶æ„å»ºæœºåˆ¶æ˜¯å½“æ¶ˆæ¯åˆ°è¾¾Commitlogæ–‡ä»¶åï¼Œç”±ä¸“é—¨çš„çº¿ç¨‹äº§ç”Ÿæ¶ˆæ¯è½¬å‘ä»»åŠ¡ï¼Œä»è€Œæ„å»ºæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸ä¸‹æ–‡æåˆ°çš„ç´¢å¼•æ–‡ä»¶ã€‚</p>
<h3 id="453-index-ç´¢å¼•æ–‡ä»¶">4.5.3 Index ç´¢å¼•æ–‡ä»¶</h3>
<p>æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ˜¯ RocketMQä¸“é—¨ä¸ºæ¶ˆæ¯è®¢é˜…æ„å»ºçš„ç´¢å¼•æ–‡ä»¶ï¼Œæé«˜æ ¹æ®ä¸»é¢˜ä¸æ¶ˆæ¯é˜Ÿåˆ—æ£€ç´¢æ¶ˆæ¯çš„é€Ÿåº¦ï¼Œå¦å¤–RocketMQå¼•å…¥äº†Hashç´¢å¼•æœºåˆ¶ä¸ºæ¶ˆæ¯å»ºç«‹ç´¢å¼•ã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://q456qq520.github.io/post-images/1664355515340.png" alt="Indexç´¢å¼•æ–‡ä»¶" loading="lazy"></figure>
<p>lndexFileæ€»å…±åŒ…å« lndexHeaderã€Hashæ§½ ã€Hash æ¡ç›®(æ•°æ®)ã€‚</p>
<p>1 ) IndexHeaderå¤´éƒ¨ï¼ŒåŒ…å«40ä¸ªå­—èŠ‚ï¼Œè®°å½•è¯¥IndexFile çš„ç»Ÿè®¡ä¿¡æ¯<br>
beginTimestamp: è¯¥ç´¢å¼•æ–‡ä»¶ä¸­åŒ…å«æ¶ˆæ¯çš„æœ€å°å­˜å‚¨æ—¶é—´<br>
endTimestamp: è¯¥ç´¢å¼•æ–‡ä»¶ä¸­åŒ…å«æ¶ˆæ¯çš„æœ€å¤§å­˜å‚¨æ—¶é—´<br>
beginPhyoffset: è¯¥ç´¢å¼•æ–‡ä»¶ä¸­åŒ…å«æ¶ˆæ¯çš„æœ€å°ç‰©ç†åç§»é‡(commitlogæ–‡ä»¶åç§»é‡)<br>
endPhyoffset:è¯¥ç´¢å¼•æ–‡ä»¶ä¸­åŒ…å«æ¶ˆæ¯çš„æœ€å¤§ç‰©ç†åç§»é‡( commitlogæ–‡ä»¶åç§»é‡)<br>
hashslotCount: hashslotä¸ªæ•°ï¼Œå¹¶ä¸æ˜¯hashæ§½ä½¿ç”¨çš„ä¸ªæ•°ï¼Œåœ¨è¿™é‡Œæ„ä¹‰ä¸å¤§<br>
indexCount: Indexæ¡ç›®åˆ—è¡¨å½“å‰å·²ä½¿ç”¨çš„ä¸ªæ•°ï¼ŒIndexæ¡ç›®åœ¨Indexæ¡ç›®åˆ—è¡¨ä¸­æŒ‰é¡ºåºå­˜å‚¨ã€‚<br>
2) Hashæ§½ï¼Œä¸€ä¸ªIndexFileé»˜è®¤åŒ…å«500ä¸‡ä¸ªHashæ§½ï¼Œæ¯ä¸ªHashæ§½å­˜å‚¨çš„æ˜¯è½åœ¨è¯¥Hashæ§½çš„hashcodeæœ€æ–°çš„Indexçš„ç´¢å¼•<br>
3 )Indexæ¡ç›®åˆ—è¡¨ï¼Œé»˜è®¤ä¸€ä¸ªç´¢å¼•æ–‡ä»¶åŒ…å« 2000ä¸‡ä¸ªæ¡ç›®<br>
hashcode: keyçš„hashcodeã€‚<br>
phyoffset: æ¶ˆæ¯å¯¹åº”çš„ç‰©ç†åç§»é‡<br>
timedif:è¯¥æ¶ˆæ¯å­˜å‚¨æ—¶é—´ä¸ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³çš„å·®å€¼ï¼Œå°äº0è¯¥æ¶ˆæ¯æ— æ•ˆ<br>
prelndexNo:è¯¥æ¡ç›®çš„å‰ä¸€æ¡è®°å½•çš„Indexç´¢å¼•ï¼Œå½“å‡ºç°hashå†²çªæ—¶ï¼Œæ„å»ºçš„é“¾è¡¨ç»“æ„</p>
<h3 id="454-checkpointæ–‡ä»¶">4.5.4 checkpointæ–‡ä»¶</h3>
<p>checkpointçš„ä½œç”¨æ˜¯è®°å½• Comitlogã€ConsumeQueueã€Indexæ–‡ä»¶çš„åˆ·ç›˜æ—¶é—´ç‚¹ï¼Œæ–‡ä»¶<br>
å›ºå®šé•¿åº¦ä¸º4kï¼Œå…¶ä¸­åªç”¨è¯¥æ–‡ä»¶çš„å‰é¢24ä¸ªå­—èŠ‚ã€‚</p>
<figure data-type="image" tabindex="5"><img src="https://q456qq520.github.io/post-images/1664356272730.png" alt="checkpointæ–‡ä»¶" loading="lazy"></figure>
<p>physicMsgTimestamp: commitlogæ–‡ä»¶åˆ·ç›˜æ—¶é—´ç‚¹<br>
logicsMsgTimestamp: æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶åˆ·ç›˜æ—¶é—´ç‚¹<br>
indexMsgTimestamp: ç´¢å¼•æ–‡ä»¶åˆ·ç›˜æ—¶é—´ç‚¹</p>
<h2 id="46-å®æ—¶æ›´æ–°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ä¸ç´¢å¼•æ–‡ä»¶">4.6 å®æ—¶æ›´æ–°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ä¸ç´¢å¼•æ–‡ä»¶</h2>
<p>å½“æ¶ˆæ¯ç”Ÿäº§è€…æäº¤çš„æ¶ˆæ¯å­˜å‚¨åœ¨Commitlogæ–‡ä»¶ä¸­ï¼ŒConsumeQueueã€IndexFileéœ€è¦åŠæ—¶æ›´æ–°ï¼Œå¦åˆ™æ¶ˆ æ¯æ— æ³•åŠæ—¶è¢«æ¶ˆè´¹ï¼Œæ ¹æ®æ¶ˆæ¯å±æ€§æŸ¥æ‰¾æ¶ˆæ¯ä¹Ÿä¼šå‡ºç°è¾ƒå¤§å»¶è¿Ÿã€‚RocketMQé€šè¿‡å¼€å¯ä¸€ä¸ªçº¿ç¨‹ ReputMessageServcieæ¥å‡†å®æ—¶è½¬å‘CommitLogæ–‡ä»¶æ›´æ–°äº‹ä»¶ï¼Œç›¸åº”çš„ä»»åŠ¡å¤„ç†å™¨æ ¹æ®è½¬å‘çš„æ¶ˆæ¯åŠæ—¶æ›´æ–° ConsumeQueueã€IndexFileæ–‡ä»¶ã€‚</p>
<p>BrokeræœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ä¼šå¯åŠ¨ ReputMessageServiceçº¿ç¨‹ï¼Œå¹¶åˆå§‹åŒ–ä¸€ä¸ªéå¸¸å…³é”®çš„å‚æ•° reputFfomOffsetï¼Œè¯¥å‚æ•°çš„å«ä¹‰æ˜¯ ReputMessageServiceä»å“ªä¸ªç‰©ç†åç§»é‡å¼€å§‹è½¬å‘æ¶ˆæ¯ç»™ ConsumeQueueå’ŒIndexFileã€‚å¦‚æœå…è®¸é‡å¤è½¬å‘ï¼ŒreputFromOffsetè®¾ç½®ä¸ºCommitLogçš„æäº¤æŒ‡é’ˆ;å¦‚æœä¸å…è®¸é‡å¤è½¬å‘ï¼ŒreputFromOffsetè®¾ç½®ä¸ºCommitlogçš„å†…å­˜ä¸­æœ€å¤§åç§»é‡ã€‚</p>
<blockquote>
<p>DefaultMessageStore#start</p>
</blockquote>
<pre><code class="language-java">if (this.getMessageStoreConfig().isDuplicationEnable()) {
    this.reputMessageService.setReputFromOffset(this.commitLog.getConfirmOffset());
} else {
    // It is [recover]'s responsibility to fully dispatch the commit log data before the max offset of commit log.
    this.reputMessageService.setReputFromOffset(this.commitLog.getMaxOffset());
}
this.reputMessageService.start();
</code></pre>
<p>ReputMessageServiceçº¿ç¨‹æ¯æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡æ¨é€ä¼‘æ¯1æ¯«ç§’å°±ç»§ç»­å°è¯•æ¨é€æ¶ˆæ¯åˆ°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—å’Œç´¢å¼•æ–‡ä»¶ï¼Œæ¶ˆæ¯æ¶ˆè´¹è½¬å‘çš„æ ¸å¿ƒå®ç°åœ¨doReputæ–¹æ³•ä¸­å®ç°ã€‚</p>
<blockquote>
<p>DefaultMessageStore#run</p>
</blockquote>
<pre><code class="language-java">@Override
public void run() {
    DefaultMessageStore.LOGGER.info(this.getServiceName() + &quot; service started&quot;);
    while (!this.isStopped()) {
        try {
            Thread.sleep(1);
            this.doReput();
        } catch (Exception e) {
            DefaultMessageStore.LOGGER.warn(this.getServiceName() + &quot; service has exception. &quot;, e);
        }
    }
    DefaultMessageStore.LOGGER.info(this.getServiceName() + &quot; service end&quot;);
}
</code></pre>
<p>Step 1 :è¿”å›reputFromOffsetåç§»é‡å¼€å§‹çš„å…¨éƒ¨æœ‰æ•ˆæ•°æ®(commitlogæ–‡ä»¶)ã€‚ç„¶åå¾ªç¯è¯»å–æ¯ä¸€æ¡æ¶ˆæ¯</p>
<pre><code class="language-java">//è¿”å›reputFromOffsetåç§»é‡å¼€å§‹çš„å…¨éƒ¨æœ‰æ•ˆæ•°æ®(commitlogæ–‡ä»¶)ã€‚ç„¶åå¾ªç¯è¯»å–æ¯ä¸€æ¡æ¶ˆæ¯ ã€‚
SelectMappedBufferResult result = DefaultMessageStore.this.commitLog.getData(reputFromOffset);
</code></pre>
<p>Step 2:ä»resultè¿”å›çš„ByteBufferä¸­å¾ªç¯è¯»å–æ¶ˆæ¯ï¼Œä¸€æ¬¡è¯»å–ä¸€æ¡</p>
<pre><code class="language-java">//ä»resultè¿”å›çš„ByteBufferä¸­å¾ªç¯è¯»å–æ¶ˆæ¯ï¼Œä¸€æ¬¡è¯»å–ä¸€æ¡
DispatchRequest dispatchRequest =
    DefaultMessageStore.this.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), false, false, false);
int size = dispatchRequest.getBufferSize() == -1 ? dispatchRequest.getMsgSize() : dispatchRequest.getBufferSize();
</code></pre>
<p>Step 3</p>
<pre><code class="language-java">if (dispatchRequest.isSuccess()) {
        //å¦‚æœæ¶ˆæ¯é•¿åº¦å¤§äº0ï¼Œåˆ™è°ƒç”¨doDispatchæ–¹æ³•
        //æœ€ç»ˆå°†åˆ†åˆ«è°ƒç”¨CommitLogDispatcherBuildConsumeQueue (æ„å»ºæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—)ã€ CommitLogDispatcherBuildIndex(æ„å»ºç´¢å¼•æ–‡ä»¶)ã€‚
        if (size &gt; 0) {
            DefaultMessageStore.this.doDispatch(dispatchRequest); 
            //.....    
    }
}
</code></pre>
<p>å…¶ä¸­é‡ç‚¹DispatchRequestçš„æ ¸å¿ƒå±æ€§ä¸ºï¼š</p>
<blockquote>
<p>DispatchRequest</p>
</blockquote>
<pre><code class="language-java">public class DispatchRequest {
    //æ¶ˆæ¯ä¸»é¢˜åç§°
    private final String topic;
    //æ¶ˆæ¯é˜Ÿåˆ—ID
    private final int queueId;
    //æ¶ˆæ¯ç‰©ç†åç§»é‡
    private final long commitLogOffset;
    //æ¶ˆæ¯é•¿åº¦
    private int msgSize;
    //æ¶ˆæ¯è¿‡æ»¤ tag hashcode
    private final long tagsCode;
    //æ¶ˆæ¯å­˜å‚¨æ—¶é—´æˆ³
    private final long storeTimestamp;
    //æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡
    private final long consumeQueueOffset;
    //æ¶ˆæ¯ç´¢å¼•keyã€‚å¤šä¸ªç´¢å¼•keyç”¨ç©ºæ ¼éš”å¼€
    private final String keys;
    //æ˜¯å¦æˆåŠŸè§£æåˆ°å®Œæ•´çš„æ¶ˆæ¯
    private final boolean success;
    //æ¶ˆæ¯å”¯ä¸€é”®
    private final String uniqKey;
    //æ¶ˆæ¯ç³»ç»Ÿæ ‡è®°
    private final int sysFlag;
    //æ¶ˆæ¯é¢„å¤„ç†äº‹åŠ¡åç§»é‡
    private final long preparedTransactionOffset;
    //æ¶ˆæ¯å±æ€§
    private final Map&lt;String, String&gt; propertiesMap;
    //ä½å›¾
    private byte[] bitMap;

    private int bufferSize = -1;//the buffer size maybe larger than the msg size if the message is wrapped by something

    // for batch consume queue
    private long  msgBaseOffset = -1;
    private short batchSize = 1;

    private long nextReputFromOffset = -1;
}
</code></pre>
<h3 id="461-æ ¹æ®æ¶ˆæ¯æ›´æ–°-conumequeue">4.6.1 æ ¹æ®æ¶ˆæ¯æ›´æ–° ConumeQueue</h3>
<p>æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—è½¬å‘ä»»åŠ¡å®ç°ç±»ä¸º : CommitLogDispatcherBuildConsumeQueueï¼Œå†…éƒ¨æœ€<br>
ç»ˆå°†è°ƒç”¨ putMessagePositioninfoæ–¹æ³•ã€‚</p>
<p>Step 1:æ ¹æ®æ¶ˆæ¯ä¸»é¢˜ä¸é˜Ÿåˆ—IDï¼Œå…ˆè·å–æ´»åˆ›å»ºå¯¹åº”çš„ConumeQueueæ–‡ä»¶</p>
<blockquote>
<p>putMessagePositionInfoWrapper</p>
</blockquote>
<pre><code class="language-java">public void putMessagePositionInfoWrapper(DispatchRequest dispatchRequest) {
    ConsumeQueueInterface cq = this.findOrCreateConsumeQueue(dispatchRequest.getTopic(), dispatchRequest.getQueueId());
    this.putMessagePositionInfoWrapper(cq, dispatchRequest);
}
</code></pre>
<p>*æ¯ä¸€ä¸ªæ¶ˆæ¯ä¸»é¢˜å¯¹åº”ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ç›®å½•ç„¶åä¸»é¢˜ä¸‹æ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åå–å‡ºè¯¥æ–‡ä»¶å¤¹æœ€åçš„ConsumeQueueæ–‡ä»¶å³å¯ *</p>
<p>Step 2:</p>
<blockquote>
<p>putMessagePositionInfo</p>
</blockquote>
<pre><code class="language-java">private boolean putMessagePositionInfo(final long offset, final int size, final long tagsCode,
        final long cqOffset) {
        if (offset + size &lt;= this.maxPhysicOffset) {
            log.warn(&quot;Maybe try to build consume queue repeatedly maxPhysicOffset={} phyOffset={}&quot;, maxPhysicOffset, offset);
            return true;
        }
        //ä¾æ¬¡å°†æ¶ˆæ¯åç§»é‡ã€æ¶ˆæ¯é•¿åº¦ã€tag hashcodeå†™å…¥åˆ°ByteBufferä¸­
        this.byteBufferIndex.flip();
        this.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);
        this.byteBufferIndex.putLong(offset);
        this.byteBufferIndex.putInt(size);
        this.byteBufferIndex.putLong(tagsCode);

        final long expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;

        //consumeQueueOffsetè®¡ç®—ConsumeQueueä¸­çš„ç‰©ç†åœ°å€ï¼Œå°†å†…å®¹è¿½åŠ åˆ°ConsumeQueueçš„å†…
        //å­˜æ˜ å°„æ–‡ä»¶ä¸­(æœ¬æ“ä½œåªè¿½å‡»å¹¶ä¸åˆ·ç›˜)ï¼ŒConsumeQueueçš„åˆ·ç›˜æ–¹å¼å›ºå®šä¸ºå¼‚æ­¥åˆ·ç›˜æ¨¡å¼
        MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile(expectLogicOffset);
        if (mappedFile != null) {
            //......
            this.maxPhysicOffset = offset + size;
            return mappedFile.appendMessage(this.byteBufferIndex.array());
        }
        return false;
    }
</code></pre>
<h3 id="462-æ ¹æ®æ¶ˆæ¯æ›´æ–°-indexç´¢å¼•æ–‡ä»¶">4.6.2 æ ¹æ®æ¶ˆæ¯æ›´æ–° Indexç´¢å¼•æ–‡ä»¶</h3>
<p>Hashç´¢å¼•æ–‡ä»¶è½¬å‘ä»»åŠ¡å®ç°ç±» : CommitLogDispatcherBuildlndex</p>
<blockquote>
<p>CommitLogDispatcherBuildIndex</p>
</blockquote>
<pre><code class="language-java">class CommitLogDispatcherBuildIndex implements CommitLogDispatcher {
    @Override
    //å¦‚æœmesssagelndexEnableè®¾ç½®ä¸ºtrueï¼Œåˆ™è°ƒç”¨IndexService#buildlndexæ„å»ºHashç´¢å¼•ï¼Œå¦åˆ™å¿½ç•¥æœ¬æ¬¡è½¬å‘ä»»åŠ¡ ã€‚
    public void dispatch(DispatchRequest request) {
        if (DefaultMessageStore.this.messageStoreConfig.isMessageIndexEnable()) {
            DefaultMessageStore.this.indexService.buildIndex(request);
        }
    }
}
</code></pre>
<p>Step1:è·å–æˆ–åˆ›å»ºIndexFileæ–‡ä»¶å¹¶è·å–æ–‡ä»¶æœ€å¤§ç‰©ç†åç§»é‡ã€‚å¦‚æœè¯¥æ¶ˆæ¯çš„ç‰©ç†åç§»é‡å°äºç´¢å¼•æ–‡ä»¶ä¸­çš„ç‰©ç†åç§»ï¼Œåˆ™è¯´æ˜æ˜¯é‡å¤æ•°æ®ï¼Œå¿½ç•¥æœ¬æ¬¡ç´¢å¼•æ„å»ºã€‚</p>
<p>Step2 :å¦‚æœæ¶ˆæ¯çš„å”¯ä¸€é”®ä¸ä¸ºç©ºï¼Œåˆ™æ·»åŠ åˆ° Hashç´¢å¼•ä¸­ï¼Œä»¥ä¾¿åŠ é€Ÿæ ¹æ®å”¯ä¸€é”®æ£€ç´¢æ¶ˆæ¯ã€‚</p>
<p>Step3:æ„å»ºç´¢å¼•é”®ï¼ŒRocketMQ æ”¯æŒä¸ºåŒä¸€ä¸ªæ¶ˆæ¯å»ºç«‹å¤šä¸ªç´¢å¼•ï¼Œå¤šä¸ªç´¢å¼•é”®ç©ºæ ¼åˆ†å¼€</p>
<blockquote>
<p>buildIndex</p>
</blockquote>
<pre><code class="language-java">public void buildIndex(DispatchRequest req) {
    //è·å–æˆ–åˆ›å»ºIndexFileæ–‡ä»¶å¹¶è·å–æ–‡ä»¶æœ€å¤§ç‰©ç†åç§»é‡
    IndexFile indexFile = retryGetAndCreateIndexFile();
    if (indexFile != null) {
        long endPhyOffset = indexFile.getEndPhyOffset();
        DispatchRequest msg = req;
        String topic = msg.getTopic();
        String keys = msg.getKeys();
        //å¦‚æœè¯¥æ¶ˆæ¯çš„ç‰©ç†åç§»é‡å°äºç´¢å¼•æ–‡ä»¶ä¸­çš„ç‰©ç†åç§»ï¼Œåˆ™è¯´æ˜æ˜¯é‡å¤æ•°æ®ï¼Œå¿½ç•¥æœ¬æ¬¡ç´¢å¼•æ„å»ºã€‚
        if (msg.getCommitLogOffset() &lt; endPhyOffset) {
            return;
        }

        final int tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());
        switch (tranType) {
            case MessageSysFlag.TRANSACTION_NOT_TYPE:
            case MessageSysFlag.TRANSACTION_PREPARED_TYPE:
            case MessageSysFlag.TRANSACTION_COMMIT_TYPE:
                break;
            case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:
                return;
        }

        //å¦‚æœæ¶ˆæ¯çš„å”¯ä¸€é”®ä¸ä¸ºç©ºï¼Œåˆ™æ·»åŠ åˆ° Hashç´¢å¼•ä¸­ï¼Œä»¥ä¾¿åŠ é€Ÿæ ¹æ®å”¯ä¸€é”®æ£€ç´¢æ¶ˆæ¯
        if (req.getUniqKey() != null) {
            indexFile = putKey(indexFile, msg, buildKey(topic, req.getUniqKey()));
            if (indexFile == null) {
                LOGGER.error(&quot;putKey error commitlog {} uniqkey {}&quot;, req.getCommitLogOffset(), req.getUniqKey());
                return;
            }
        }
        //Step3:æ„å»ºç´¢å¼•é”®ï¼ŒRocketMQ æ”¯æŒä¸ºåŒä¸€ä¸ªæ¶ˆæ¯å»ºç«‹å¤šä¸ªç´¢å¼•ï¼Œå¤šä¸ªç´¢å¼•é”®ç©ºæ ¼åˆ†å¼€
        if (keys != null &amp;&amp; keys.length() &gt; 0) {
            String[] keyset = keys.split(MessageConst.KEY_SEPARATOR);
            for (int i = 0; i &lt; keyset.length; i++) {
                String key = keyset[i];
                if (key.length() &gt; 0) {
                    indexFile = putKey(indexFile, msg, buildKey(topic, key));
                    if (indexFile == null) {
                        LOGGER.error(&quot;putKey error commitlog {} uniqkey {}&quot;, req.getCommitLogOffset(), req.getUniqKey());
                        return;
                    }
                }
            }
        }
    } else {
        LOGGER.error(&quot;build index error, stop building index&quot;);
    }
}
</code></pre>
<h2 id="47-æ¶ˆæ¯é˜Ÿåˆ—ä¸ç´¢å¼•æ–‡ä»¶æ¢å¤">4.7 æ¶ˆæ¯é˜Ÿåˆ—ä¸ç´¢å¼•æ–‡ä»¶æ¢å¤</h2>
<p>RocketMQå­˜å‚¨é¦–å…ˆå°†æ¶ˆæ¯å…¨é‡å­˜å‚¨åœ¨Commitlogæ–‡ä»¶ä¸­ï¼Œç„¶åå¼‚æ­¥ç”Ÿæˆè½¬å‘ä»»åŠ¡æ›´æ–°ConsumeQueueã€Indexæ–‡ä»¶ã€‚ å¦‚æœæ¶ˆæ¯æˆåŠŸå­˜å‚¨åˆ° Commitlog æ–‡ä»¶ä¸­ï¼Œè½¬å‘ä»»åŠ¡æœªæˆåŠŸæ‰§è¡Œï¼Œæ­¤æ—¶æ¶ˆæ¯æœåŠ¡å™¨Brokerç”±äºæŸä¸ªåŸå› å®•æœºï¼Œå¯¼è‡´Commitlogã€ConsumeQueueã€IndexFileæ–‡ä»¶æ•°æ®ä¸ä¸€è‡´ã€‚å¦‚æœä¸åŠ ä»¥äººå·¥ä¿®å¤çš„è¯ï¼Œä¼šæœ‰ä¸€éƒ¨åˆ†æ¶ˆæ¯å³ä¾¿åœ¨Commitlogæ–‡ä»¶ä¸­å­˜åœ¨ï¼Œä½†ç”±äºå¹¶æ²¡æœ‰è½¬å‘åˆ° Consumequeueï¼Œè¿™éƒ¨åˆ†æ¶ˆæ¯å°†æ°¸è¿œä¸ä¼šè¢«æ¶ˆè´¹è€…æ¶ˆè´¹ ã€‚ é‚£RocketMQ æ˜¯å¦‚ä½•ä½¿Commitlogã€æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—(ConsumeQueue)è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§çš„å‘¢?</p>
<p>Step1:åˆ¤æ–­ä¸Šä¸€æ¬¡é€€å‡ºæ˜¯å¦æ­£å¸¸ã€‚</p>
<p>å…¶å®ç°æœºåˆ¶æ˜¯Brokeråœ¨å¯åŠ¨æ—¶åˆ›å»º${ROCå£T_ HOME}/store/abortæ–‡ä»¶ï¼Œåœ¨é€€å‡ºæ—¶é€šè¿‡æ³¨å†ŒJVMé’©å­å‡½æ•°åˆ é™¤abortæ–‡ä»¶ã€‚å¦‚æœä¸‹ä¸€æ¬¡å¯åŠ¨æ—¶å­˜åœ¨abortæ–‡ä»¶ã€‚è¯´æ˜Brokeræ˜¯å¼‚å¸¸é€€å‡ºçš„ Commitlogä¸Consumequeue æ•°æ®æœ‰å¯èƒ½ä¸ä¸€è‡´ï¼Œéœ€è¦è¿›è¡Œä¿®å¤ã€‚</p>
<blockquote>
<p>isTempFileExist</p>
</blockquote>
<pre><code class="language-java">private boolean isTempFileExist() {
    String fileName = StorePathConfigHelper.getAbortFile(this.messageStoreConfig.getStorePathRootDir());
    File file = new File(fileName);
    return file.exists();
}
</code></pre>
<p>Step2:åŠ è½½å»¶è¿Ÿé˜Ÿåˆ—</p>
<p>Step3 :åŠ è½½Commitlogæ–‡ä»¶</p>
<blockquote>
<p>MappedFileQueue#doLoad</p>
</blockquote>
<pre><code class="language-java">public boolean doLoad(List&lt;File&gt; files) {
    // ascending order
    files.sort(Comparator.comparing(File::getName));

    for (File file : files) {
        //å¦‚æœæ–‡ä»¶å¤§å°ä¸é…ç½®æ–‡ä»¶çš„å•ä¸ªæ–‡ä»¶å¤§å°ä¸ä¸€è‡´ï¼Œå°†å¿½ç•¥è¯¥ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼Œ
        if (file.length() != this.mappedFileSize) {
            log.warn(file + &quot;\t&quot; + file.length()
                    + &quot; length not matched message store config value, please check it manually&quot;);
            return false;
        }

        try {
            MappedFile mappedFile = new DefaultMappedFile(file.getPath(), mappedFileSize);
            //æŒ‡é’ˆéƒ½è®¾ç½®ä¸ºæ–‡ä»¶å¤§å°
            mappedFile.setWrotePosition(this.mappedFileSize);
            mappedFile.setFlushedPosition(this.mappedFileSize);
            mappedFile.setCommittedPosition(this.mappedFileSize);
            this.mappedFiles.add(mappedFile);
            log.info(&quot;load &quot; + file.getPath() + &quot; OK&quot;);
        } catch (IOException e) {
            log.error(&quot;load file &quot; + file + &quot; error&quot;, e);
            return false;
        }
    }
    return true;
}
</code></pre>
<p>Step4 :åŠ è½½æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—</p>
<p>Steps :åŠ è½½å­˜å‚¨æ£€æµ‹ç‚¹ï¼Œæ£€æµ‹ç‚¹ä¸»è¦è®°å½•commitlogæ–‡ä»¶ã€Consumequeueæ–‡ä»¶ã€Indexç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜ç‚¹ï¼Œå°†åœ¨ä¸‹æ–‡çš„æ–‡ä»¶åˆ·ç›˜æœºåˆ¶ä¸­å†æ¬¡æäº¤ã€‚</p>
<blockquote>
<p>åŠ è½½å­˜å‚¨æ£€æµ‹ç‚¹</p>
</blockquote>
<pre><code class="language-java">this.storeCheckpoint =
    new StoreCheckpoint(StorePathConfigHelper.getStoreCheckpoint(this.messageStoreConfig.getStorePathRootDir()));
this.masterFlushedOffset = this.storeCheckpoint.getMasterFlushedOffset();
this.indexService.load(lastExitOK);
</code></pre>
<p>Step6 :åŠ è½½ç´¢å¼•æ–‡ä»¶ï¼Œå¦‚æœä¸Šæ¬¡å¼‚å¸¸é€€å‡ºï¼Œè€Œä¸”ç´¢å¼•æ–‡ä»¶ä¸Šæ¬¡åˆ·ç›˜æ—¶é—´å°äºè¯¥ç´¢å¼•æ–‡ä»¶æœ€å¤§çš„æ¶ˆæ¯æ—¶é—´æˆ³è¯¥æ–‡ä»¶å°†ç«‹å³é”€æ¯ã€‚</p>
<blockquote>
<p>this.indexService.load(lastExitOK);</p>
</blockquote>
<pre><code class="language-java">public boolean load(final boolean lastExitOK) {
    File dir = new File(this.storePath);
    File[] files = dir.listFiles();
    if (files != null) {
        // ascending order
        Arrays.sort(files);
        for (File file : files) {
            try {
                IndexFile f = new IndexFile(file.getPath(), this.hashSlotNum, this.indexNum, 0, 0);
                f.load();

                if (!lastExitOK) {
                    if (f.getEndTimestamp() &gt; this.defaultMessageStore.getStoreCheckpoint()
                        .getIndexMsgTimestamp()) {
                        f.destroy(0);
                        continue;
                    }
                }
                this.indexFileList.add(f);
            } catch (IOException e) {
                return false;
            } catch (NumberFormatException e) {
            }
        }
    }
    return true;
}
</code></pre>
<p>Step7 :æ ¹æ®Brokeræ˜¯å¦æ˜¯æ­£å¸¸åœæ­¢æ‰§è¡Œä¸åŒçš„æ¢å¤ç­–ç•¥</p>
<blockquote>
<p>æ¢å¤ç­–ç•¥</p>
</blockquote>
<pre><code class="language-java">private void recover(final boolean lastExitOK) {
    long recoverCqStart = System.currentTimeMillis();
    long maxPhyOffsetOfConsumeQueue = this.recoverConsumeQueue();
    long recoverCqEnd = System.currentTimeMillis();

    if (lastExitOK) {
        this.commitLog.recoverNormally(maxPhyOffsetOfConsumeQueue);
    } else {
        this.commitLog.recoverAbnormally(maxPhyOffsetOfConsumeQueue);
    }
    long recoverClogEnd = System.currentTimeMillis();
    this.recoverTopicQueueTable();
    long recoverOffsetEnd = System.currentTimeMillis();
}
</code></pre>
<p>Step8:æ¢å¤ ConsumeQueue æ–‡ä»¶åï¼Œå°†åœ¨CommitLogå®ä¾‹ä¸­ä¿å­˜æ¯ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—å½“å‰çš„å­˜å‚¨é€»è¾‘åç§»é‡</p>
<h3 id="471-broker-æ­£å¸¸åœæ­¢æ–‡ä»¶æ¢å¤">4.7.1 Broker æ­£å¸¸åœæ­¢æ–‡ä»¶æ¢å¤</h3>
<p>Step1 : Brokeræ­£å¸¸åœæ­¢å†é‡å¯æ—¶ï¼Œä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹è¿›è¡Œæ¢å¤ï¼Œå¦‚æœä¸è¶³3ä¸ªæ–‡ä»¶ï¼Œåˆ™ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹æ¢å¤ã€‚checkCRCOnRecoverå‚æ•°è®¾ç½®åœ¨è¿›è¡Œæ–‡ä»¶æ¢å¤æ—¶æŸ¥æ‰¾æ¶ˆæ¯æ—¶æ˜¯å¦éªŒè¯CRCã€‚</p>
<p>Step2:éå†Commitlogæ–‡ä»¶ï¼Œæ¯æ¬¡å–å‡ºä¸€æ¡æ¶ˆæ¯ï¼Œ å¦‚æœæŸ¥æ‰¾ç»“æœä¸ºtrueå¹¶ä¸”æ¶ˆæ¯çš„é•¿åº¦å¤§äº0è¡¨ç¤ºæ¶ˆ æ¯æ­£ç¡®ï¼ŒmappedFileOffset æŒ‡é’ˆå‘å‰ç§»åŠ¨æœ¬æ¡æ¶ˆ æ¯çš„é•¿ åº¦; å¦‚æœæŸ¥æ‰¾ç»“æœä¸ºtrueå¹¶ä¸”æ¶ˆæ¯çš„é•¿åº¦ç­‰äº0ï¼Œè¡¨ç¤ºå·²åˆ°è¯¥æ–‡ä»¶çš„æœ«å°¾ï¼Œå¦‚æœè¿˜æœ‰ä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ™é‡ç½®processOffsetã€mappedFileOffseté‡å¤æ­¥éª¤3ï¼Œå¦åˆ™è·³å‡ºå¾ªç¯; å¦‚æœæŸ¥æ‰¾ç»“æ„ä¸ºfalseï¼Œè¡¨æ˜è¯¥æ–‡ä»¶æœªå¡«æ»¡æ‰€æœ‰æ¶ˆæ¯ï¼Œè·³å‡ºå¾ªç¯ï¼Œç»“æŸéå†æ–‡ä»¶ã€‚</p>
<p>Step3: æ›´æ–°MappedFileQueueçš„flushedWhereä¸commiteedWhereæŒ‡é’ˆ</p>
<p>Step4:åˆ é™¤offsetä¹‹åçš„æ‰€æœ‰æ–‡ä»¶</p>
<h3 id="472-broker-å¼‚å¸¸åœæ­¢æ–‡ä»¶æ¢å¤">4.7.2 Broker å¼‚å¸¸åœæ­¢æ–‡ä»¶æ¢å¤</h3>
<p>å¼‚å¸¸æ–‡ä»¶æ¢å¤çš„ æ­¥éª¤ä¸æ­£å¸¸åœæ­¢æ–‡ä»¶æ¢å¤çš„æµç¨‹åŸºæœ¬ç›¸åŒï¼Œå…¶ä¸»è¦å·®åˆ«æœ‰ä¸¤ä¸ªã€‚é¦–å…ˆæ­£å¸¸åœæ­¢é»˜è®¤ä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹è¿›è¡Œæ¢å¤ï¼Œè€Œå¼‚å¸¸åœæ­¢åˆ™éœ€è¦ä»æœ€åä¸€ä¸ªæ–‡ä»¶å¾€å‰èµ°ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¶ˆæ¯å­˜å‚¨æ­£å¸¸çš„æ–‡ä»¶ ã€‚ å…¶æ¬¡ï¼Œå¦‚æœcommitlogç›®å½•æ²¡æœ‰æ¶ˆæ¯æ–‡ä»¶ï¼Œå¦‚æœåœ¨æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ç›®å½•ä¸‹å­˜åœ¨æ–‡ä»¶ï¼Œåˆ™éœ€è¦é”€æ¯ã€‚</p>
<p>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ¶ˆæ¯æ–‡ä»¶æ˜¯ä¸€ä¸ªæ­£ç¡®çš„æ–‡ä»¶å‘¢?</p>
<p>Step1 :é¦–å…ˆåˆ¤æ–­æ–‡ä»¶çš„é­”æ•°ï¼Œå¦‚æœä¸æ˜¯MESSAGE MAGIC_CODEï¼Œè¿”å›falseï¼Œè¡¨ç¤ºè¯¥æ–‡ä»¶ä¸ç¬¦åˆcommitlogæ¶ˆæ¯æ–‡ä»¶çš„å­˜å‚¨æ ¼å¼ã€‚</p>
<blockquote>
<p>isMappedFileMatchedRecover</p>
</blockquote>
<pre><code class="language-java">int magicCode = byteBuffer.getInt(MessageDecoder.MESSAGE_MAGIC_CODE_POSITION);
if (magicCode != MESSAGE_MAGIC_CODE) {
    return false;
}
</code></pre>
<p>Step2 :å¦‚æœæ–‡ä»¶ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„å­˜å‚¨æ—¶é—´ç­‰äº0ï¼Œè¿”å›falseï¼Œè¯´æ˜è¯¥æ¶ˆæ¯å­˜å‚¨æ–‡ä»¶ä¸­æœªå­˜å‚¨ä»»ä½•æ¶ˆæ¯ã€‚<br>
Step3 :å¯¹æ¯”æ–‡ä»¶ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³ä¸æ£€æµ‹ç‚¹,æ–‡ä»¶ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³å°äºæ–‡ä»¶æ£€æµ‹ç‚¹è¯´æ˜è¯¥æ–‡ä»¶éƒ¨åˆ†æ¶ˆæ¯æ˜¯å¯é çš„ï¼Œåˆ™ä»è¯¥æ–‡ä»¶å¼€å§‹æ¢å¤ã€‚<br>
Step4 :å¦‚æœæ ¹æ®å‰3æ­¥ç®—æ³•æ‰¾ åˆ° MappedFileï¼Œåˆ™éå†MappedFileä¸­çš„æ¶ˆæ¯ï¼ŒéªŒè¯æ¶ˆæ¯çš„åˆæ³•æ€§ï¼Œå¹¶å°†æ¶ˆæ¯é‡æ–°è½¬å‘åˆ°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ä¸ç´¢å¼•æ–‡ä»¶<br>
Step5 :å¦‚æœæœªæ‰¾åˆ°æœ‰æ•ˆ MappedFileï¼Œåˆ™è®¾ç½®commitlogç›®å½•çš„flushedWhereã€committedÂ­WhereæŒ‡é’ˆéƒ½ä¸º0ï¼Œå¹¶é”€æ¯æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ã€‚</p>
<h2 id="48-æ–‡ä»¶åˆ·ç›˜æœºåˆ¶">4.8 æ–‡ä»¶åˆ·ç›˜æœºåˆ¶</h2>
<p>RocketMQ çš„å­˜å‚¨ä¸è¯»å†™æ˜¯åŸºäº JDK NIO çš„å†…å­˜æ˜ å°„æœºåˆ¶ï¼Œæ¶ˆæ¯å­˜å‚¨æ—¶é¦–å…ˆå°†æ¶ˆæ¯è¿½åŠ åˆ°å†…å­˜ï¼Œå†æ ¹æ®é…ç½®çš„åˆ·ç›˜ç­–ç•¥åœ¨ä¸åŒæ—¶é—´è¿›è¡Œåˆ·å†™ç£ç›˜ã€‚å¦‚æœæ˜¯åŒæ­¥åˆ·ç›˜ï¼Œæ¶ˆæ¯è¿½åŠ åˆ°å†…å­˜åï¼Œå°†åŒæ­¥è°ƒç”¨MappedByteBufferçš„force()æ–¹æ³•;å¦‚æœæ˜¯å¼‚æ­¥åˆ·ç›˜ï¼Œåœ¨æ¶ˆæ¯è¿½åŠ åˆ°å†…å­˜åç«‹åˆ»è¿”å›ç»™æ¶ˆæ¯å‘é€ç«¯ã€‚RocketMQä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æŒ‰ç…§æŸä¸€ä¸ªè®¾å®šçš„é¢‘ç‡æ‰§è¡Œåˆ·ç›˜æ“ä½œã€‚</p>
<p><em>ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜å¹¶ä¸æ˜¯é‡‡å–å®šæ—¶åˆ·ç›˜æœºåˆ¶ï¼Œè€Œæ˜¯æ¯æ›´æ–°ä¸€æ¬¡ç´¢å¼•æ–‡ä»¶å°±ä¼šå°†ä¸Šä¸€æ¬¡çš„æ”¹åŠ¨åˆ·å†™åˆ°ç£ç›˜</em></p>
<h3 id="481-broker-åŒæ­¥åˆ·ç›˜">4.8.1 Broker åŒæ­¥åˆ·ç›˜</h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[RocketMqæŠ€æœ¯å†…å¹•ç¬”è®°ï¼ˆäºŒï¼‰]]></title>
        <id>https://q456qq520.github.io/post/rocketmq-ji-zhu-nei-mu-bi-ji-er/</id>
        <link href="https://q456qq520.github.io/post/rocketmq-ji-zhu-nei-mu-bi-ji-er/">
        </link>
        <updated>2022-09-13T11:18:59.000Z</updated>
        <summary type="html"><![CDATA[<h1 id="3-æ¶ˆæ¯å‘é€">3 æ¶ˆæ¯å‘é€</h1>
<p>RocketMQ å‘é€æ™®é€šæ¶ˆæ¯æœ‰ ä¸‰ ç§å®ç°æ–¹å¼:å¯é åŒæ­¥å‘é€ ã€ å¯é å¼‚æ­¥å‘é€ ã€ å•å‘ (Oneway)å‘é€ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<h1 id="3-æ¶ˆæ¯å‘é€">3 æ¶ˆæ¯å‘é€</h1>
<p>RocketMQ å‘é€æ™®é€šæ¶ˆæ¯æœ‰ ä¸‰ ç§å®ç°æ–¹å¼:å¯é åŒæ­¥å‘é€ ã€ å¯é å¼‚æ­¥å‘é€ ã€ å•å‘ (Oneway)å‘é€ã€‚</p>
<!-- more -->
<h2 id="31-rocketmq-æ¶ˆæ¯å‘é€">3.1 RocketMQ æ¶ˆæ¯å‘é€</h2>
<p>RocketMQ æ”¯æŒ 3 ç§æ¶ˆæ¯å‘é€æ–¹å¼ :åŒæ­¥(sync)ã€ å¼‚æ­¥(async)ã€å•å‘(oneway)ã€‚<br>
åŒæ­¥ : å‘é€è€…å‘ MQ æ‰§è¡Œå‘é€æ¶ˆæ¯ API æ—¶ï¼ŒåŒæ­¥ç­‰å¾…ï¼Œ ç›´åˆ°æ¶ˆæ¯æœåŠ¡å™¨è¿”å›å‘é€ç»“æœ ã€‚<br>
å¼‚æ­¥ : å‘é€è€…å‘ MQ æ‰§è¡Œå‘é€æ¶ˆæ¯ API æ—¶ï¼Œè°ƒç”¨æ¶ˆæ¯å‘é€Apiåï¼Œç«‹å³è¿”å›ï¼Œæ¶ˆæ¯å‘é€è€…çº¿ç¨‹ä¸é˜»å¡ï¼Œç›´åˆ°è¿è¡Œç»“æŸï¼Œæ¶ˆæ¯å‘é€æˆåŠŸæˆ–å¤±è´¥çš„å›è°ƒä»»åŠ¡åœ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚<br>
å•å‘:æ¶ˆæ¯å‘é€è€…å‘ MQ æ‰§è¡Œå‘é€æ¶ˆæ¯ APIæ—¶ï¼Œç›´æ¥è¿”å›ï¼Œä¸ç­‰å¾…æ¶ˆæ¯æœåŠ¡å™¨çš„ç»“æœï¼Œä¹Ÿä¸æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç®€å•åœ°è¯´ï¼Œå°±æ˜¯åªç®¡å‘ï¼Œä¸åœ¨ä¹æ¶ˆæ¯æ˜¯å¦æˆåŠŸå­˜å‚¨åœ¨æ¶ˆæ¯æœåŠ¡å™¨ä¸Š ã€‚</p>
<h2 id="32-è®¤è¯†rocketmqæ¶ˆæ¯">3.2 è®¤è¯†RocketMQæ¶ˆæ¯</h2>
<p>RocketMQ æ¶ˆæ¯å°è£…ç±»æ˜¯ org.apache.rocketmq.common.message.Messageã€‚</p>
<pre><code class="language-java">public class Message implements Serializable {
    private static final long serialVersionUID = 8445773977080406428L;

    private String topic;
    private int flag;
    private Map&lt;String, String&gt; properties;
    private byte[] body;
    private String transactionId;
}
</code></pre>
<p>Message æ‰©å±•å±æ€§ä¸»è¦åŒ…å«ä¸‹é¢å‡ ä¸ª ã€‚<br>
tag:æ¶ˆæ¯TAGï¼Œç”¨äºæ¶ˆæ¯è¿‡æ»¤ ã€‚<br>
keys: Messageç´¢å¼•é”®ï¼Œå¤šä¸ªç”¨ç©ºæ ¼éš”å¼€ï¼ŒRocketMQå¯ä»¥æ ¹æ®è¿™äº› keyå¿«é€Ÿæ£€ç´¢åˆ°æ¶ˆæ¯ ã€‚ waitStoreMsgOK:æ¶ˆæ¯å‘é€æ—¶æ˜¯å¦ç­‰æ¶ˆæ¯å­˜å‚¨å®Œæˆåå†è¿”å› ã€‚<br>
delayTimeLevel: æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«ï¼Œç”¨äºå®šæ—¶æ¶ˆæ¯æˆ–æ¶ˆæ¯é‡è¯• ã€‚</p>
<h2 id="33-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹">3.3 ç”Ÿäº§è€…å¯åŠ¨æµç¨‹</h2>
<h3 id="331-åˆè¯†-defaultmqproducer-æ¶ˆæ¯å‘é€è€…">3.3.1 åˆè¯† DefaultMQProducer æ¶ˆæ¯å‘é€è€…</h3>
<p>DefaultMQProduceræ˜¯é»˜è®¤çš„æ¶ˆæ¯ç”Ÿäº§è€…å®ç°ç±»ï¼Œå®ƒå®ç° MQAdmin çš„æ¥å£ã€‚å…¶ä¸»è¦æ¥å£æœ‰ï¼š</p>
<pre><code class="language-java">/**
    * @param key accesskey
    * @param newTopic ä¸»é¢˜åç§°
    * @param queueNum é˜Ÿåˆ—æ•°é‡
    * @param topicSysFlag ä¸»é¢˜ç³»ç»Ÿæ ‡ç­¾ï¼Œé»˜è®¤ä¸º0
    * @param attributes
    * @throws MQClientException if there is any client error.
    */
@Deprecated
@Override
public void createTopic(String key, String newTopic, int queueNum, int topicSysFlag, Map&lt;String, String&gt; attributes) throws MQClientException {
    this.defaultMQProducerImpl.createTopic(key, withNamespace(newTopic), queueNum, topicSysFlag);
}

/**
    * æ ¹æ® æ—¶é—´ æˆ³ä»é˜Ÿåˆ—ä¸­æŸ¥æ‰¾å…¶åç§»é‡
    */
@Override
public long searchOffset(MessageQueue mq, long timestamp) throws MQClientException {
    return this.defaultMQProducerImpl.searchOffset(queueWithNamespace(mq), timestamp);
}

/**
    * æŸ¥æ‰¾è¯¥æ¶ˆæ¯ é˜Ÿåˆ—ä¸­ æœ€å¤§çš„ç‰©ç†åç§»é‡
    */
@Deprecated
@Override
public long maxOffset(MessageQueue mq) throws MQClientException {
    return this.defaultMQProducerImpl.maxOffset(queueWithNamespace(mq));
}

/**
    * æŸ¥æ‰¾è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€å°ç‰©ç†åç§»é‡
    */
@Deprecated
@Override
public long minOffset(MessageQueue mq) throws MQClientException {
    return this.defaultMQProducerImpl.minOffset(queueWithNamespace(mq));
}


/**
    * æ ¹æ®æ¶ˆæ¯åç§»é‡æŸ¥æ‰¾æ¶ˆæ¯
    */
@Deprecated
@Override
public MessageExt viewMessage(
    String offsetMsgId) throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
    return this.defaultMQProducerImpl.viewMessage(offsetMsgId);
}

/**
    * æ ¹æ®æ¡ä»¶æŸ¥è¯¢æ¶ˆæ¯
    * @param topic message topic
    * @param key message key index word  æ¶ˆæ¯ç´¢å¼•å­—æ®µ
    * @param maxNum max message number æœ¬æ¬¡æœ€å¤šå–å‡ºæ¶ˆæ¯æ¡æ•°ã€‚
    * @param begin from when å¼€å§‹æ—¶é—´
    * @param end to when ç»“æŸæ—¶é—´
    */
@Deprecated
@Override
public QueryResult queryMessage(String topic, String key, int maxNum, long begin, long end)
    throws MQClientException, InterruptedException {
    return this.defaultMQProducerImpl.queryMessage(withNamespace(topic), key, maxNum, begin, end);
}

    /**
    * æ ¹æ®ä¸»é¢˜ä¸æ¶ˆæ¯ ID æŸ¥æ‰¾æ¶ˆæ¯
    * @throws InterruptedException if the sending thread is interrupted.
    */
@Deprecated
@Override
public MessageExt viewMessage(String topic,
    String msgId) throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
    try {
        return this.viewMessage(msgId);
    } catch (Exception ignored) {
    }
    return this.defaultMQProducerImpl.queryMessageByUniqKey(withNamespace(topic), msgId);
}

/**
    * æŸ¥æ‰¾è¯¥ä¸»é¢˜ä¸‹æ‰€æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—
    */
@Override
public List&lt;MessageQueue&gt; fetchPublishMessageQueues(String topic) throws MQClientException {
    return this.defaultMQProducerImpl.fetchPublishMessageQueues(withNamespace(topic));
}

    /**
    * åŒæ­¥å‘é€æ¶ˆæ¯ï¼Œå…·ä½“å‘é€åˆ°ä¸»é¢˜ä¸­çš„å“ªä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç”±è´Ÿè½½ç®—æ³•å†³å®š
    */
@Override
public SendResult send(
    Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    return this.defaultMQProducerImpl.send(msg);
}

/**
    * åŒæ­¥å‘é€æ¶ˆæ¯ï¼Œå¦‚æœå‘é€è¶…è¿‡ timeout åˆ™æŠ›å‡ºè¶…æ—¶å¼‚å¸¸
    */
@Override
public SendResult send(Message msg,
    long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    return this.defaultMQProducerImpl.send(msg, timeout);
}

/**
    * å¼‚æ­¥å‘é€æ¶ˆæ¯ï¼Œ sendCallbackå‚æ•°æ˜¯æ¶ˆæ¯å‘é€æˆåŠŸåçš„å›è°ƒæ–¹æ³• 
    */
@Override
public void send(Message msg,
    SendCallback sendCallback) throws MQClientException, RemotingException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    this.defaultMQProducerImpl.send(msg, sendCallback);
}

/**
    * å¼‚æ­¥å‘é€æ¶ˆæ¯ ï¼Œå¦‚æœå‘é€è¶…è¿‡ timeoutæŒ‡å®šçš„å€¼ï¼Œåˆ™æŠ›å‡ºè¶…æ—¶å¼‚å¸¸
    */
@Override
public void send(Message msg, SendCallback sendCallback, long timeout)
    throws MQClientException, RemotingException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    this.defaultMQProducerImpl.send(msg, sendCallback, timeout);
}

    /**
    * å•å‘æ¶ˆæ¯å‘é€ï¼Œå°±æ˜¯ä¸åœ¨ä¹å‘é€ç»“æœï¼Œæ¶ˆæ¯å‘é€å‡ºå»åè¯¥æ–¹æ³•ç«‹å³è¿”å›
    */
@Override
public void sendOneway(Message msg) throws MQClientException, RemotingException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    this.defaultMQProducerImpl.sendOneway(msg);
}

/**
    * åŒæ­¥æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œå‘é€åˆ°æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—
    */
@Override
public SendResult send(Message msg, MessageQueue mq)
    throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    return this.defaultMQProducerImpl.send(msg, queueWithNamespace(mq));
}

/**
    * åŒæ­¥æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œå‘é€åˆ°æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ— è¶…æ—¶å¼‚å¸¸
    */
@Override
public SendResult send(Message msg, MessageQueue mq, long timeout)
    throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    return this.defaultMQProducerImpl.send(msg, queueWithNamespace(mq), timeout);
}

/**
    * å¼‚æ­¥æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œå‘é€åˆ°æŒ‡å®šæ¶ˆæ¯ é˜Ÿåˆ— 
    */
@Override
public void send(Message msg, MessageQueue mq, SendCallback sendCallback)
    throws MQClientException, RemotingException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    this.defaultMQProducerImpl.send(msg, queueWithNamespace(mq), sendCallback);
}

/**
    * å¼‚æ­¥æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œå‘é€åˆ°æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ— è¶…æ—¶å¼‚å¸¸
    */
@Override
public void send(Message msg, MessageQueue mq, SendCallback sendCallback, long timeout)
    throws MQClientException, RemotingException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    this.defaultMQProducerImpl.send(msg, queueWithNamespace(mq), sendCallback, timeout);
}

/**
    * å•å‘æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œå‘é€åˆ°æŒ‡å®šçš„æ¶ˆæ¯é˜Ÿåˆ—
    */
@Override
public void sendOneway(Message msg,
    MessageQueue mq) throws MQClientException, RemotingException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    this.defaultMQProducerImpl.sendOneway(msg, queueWithNamespace(mq));
}

/**
    * æ¶ˆæ¯å‘é€ï¼ŒæŒ‡å®šæ¶ˆæ¯é€‰æ‹©ç®—æ³•ï¼Œè¦†ç›–æ¶ˆæ¯ç”Ÿäº§è€…é»˜è®¤çš„æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½
    */
@Override
public SendResult send(Message msg, MessageQueueSelector selector, Object arg)
    throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    return this.defaultMQProducerImpl.send(msg, selector, arg);
}

/**
    * åŒæ­¥æ‰¹é‡æ¶ˆæ¯å‘é€
    */
@Override
public SendResult send(Collection&lt;Message&gt; msgs, MessageQueue messageQueue,
    long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    return this.defaultMQProducerImpl.send(batch(msgs), messageQueue, timeout);
}
</code></pre>
<blockquote>
<p>DefaultMQProduceræ ¸å¿ƒå±æ€§</p>
</blockquote>
<pre><code class="language-java"> /**
    * ç”Ÿäº§è€…æ‰€å±ç»„ï¼Œæ¶ˆæ¯æœåŠ¡å™¨åœ¨å›æŸ¥äº‹åŠ¡çŠ¶æ€æ—¶ä¼šéšæœºé€‰æ‹©è¯¥ç»„ä¸­ä»»ä½•ä¸€ä¸ªç”Ÿäº§è€…å‘èµ·äº‹åŠ¡å›æŸ¥è¯·æ±‚ 
    */
private String producerGroup;

/**
    * é»˜è®¤ topicKeyã€‚
    */
private String createTopicKey = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;

/**
    * é»˜è®¤ä¸»é¢˜åœ¨æ¯ä¸€ä¸ª Broker é˜Ÿåˆ—æ•°é‡ã€‚
    */
private volatile int defaultTopicQueueNums = 4;

/**
    * å‘é€æ¶ˆæ¯é»˜è®¤è¶…æ—¶æ—¶é—´ï¼Œ é»˜è®¤ 3sã€‚
    */
private int sendMsgTimeout = 3000;

/**
    * æ¶ˆæ¯ä½“è¶…è¿‡è¯¥å€¼åˆ™å¯ç”¨å‹ç¼©ï¼Œé»˜è®¤ 4Kã€‚
    */
private int compressMsgBodyOverHowmuch = 1024 * 4;

/**
    *
    * åŒ æ­¥æ–¹å¼å‘é€æ¶ˆæ¯é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 2ï¼Œæ€»å…±æ‰§è¡Œ 3 æ¬¡ ã€‚
    */
private int retryTimesWhenSendFailed = 2;

/**
    * å¼‚æ­¥æ–¹å¼å‘é€æ¶ˆæ¯é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 2ã€‚
    */
private int retryTimesWhenSendAsyncFailed = 2;

/**
    * æ¶ˆæ¯é‡è¯•æ—¶é€‰æ‹©å¦å¤–ä¸€ä¸ª Brokeræ—¶æ˜¯å¦ä¸ç­‰ å¾…å­˜å‚¨ç»“æœå°±è¿”å› ï¼Œ é»˜è®¤ä¸º falseã€‚
    */
private boolean retryAnotherBrokerWhenNotStoreOK = false;

/**
    * å…è®¸å‘é€çš„æœ€å¤§æ¶ˆæ¯é•¿åº¦ï¼Œé»˜è®¤ä¸º 4Mï¼Œçœ©å€¼æœ€å¤§å€¼ä¸º 2&quot;32-1
    */
private int maxMessageSize = 1024 * 1024 * 4; // 4M
</code></pre>
<h3 id="332-æ¶ˆæ¯ç”Ÿäº§è€…å¯åŠ¨æµç¨‹">3.3.2 æ¶ˆæ¯ç”Ÿäº§è€…å¯åŠ¨æµç¨‹</h3>
<p>æ¶ˆæ¯ç”Ÿäº§è€…å¯åŠ¨ä¸»è¦ä»DefaultMQProducerlmplçš„startæ–¹æ³•å¼€å§‹ã€‚</p>
<pre><code class="language-java">public void start(final boolean startFactory) throws MQClientException {
    switch (this.serviceState) {
        case CREATE_JUST:
            this.serviceState = ServiceState.START_FAILED;

//Step1:æ£€æŸ¥productGroupæ˜¯å¦ç¬¦åˆè¦æ±‚;å¹¶æ”¹å˜ç”Ÿäº§è€…çš„ instanceNameä¸ºè¿›ç¨‹ IDã€‚
            this.checkConfig();
            if (!this.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) {
                this.defaultMQProducer.changeInstanceNameToPID();
            }

 // /Step2 :åˆ›å»º MQClientInstanceå®ä¾‹ã€‚ æ•´ä¸ªJVM å®ä¾‹ä¸­åªå­˜åœ¨ä¸€ä¸ª MQClientManagerå®ä¾‹ï¼Œç»´æŠ¤ä¸€ä¸ªMQClientInstanceç¼“å­˜è¡¨ ConcurrentMap&lt;String/*clientIdç¯ï¼ŒMQClientInstance&gt; factoryTable =new ConcurrentHashMap&lt;Stringï¼Œ MQClientInstance&gt;()ï¼Œä¹Ÿå°±æ˜¯ åŒä¸€ä¸ª clientIdåª ä¼šåˆ›å»ºä¸€ä¸ª MQClientInstanceã€‚
            this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook);


//Step3 :å‘ MQClientlnstanceæ³¨å†Œï¼Œå°†å½“å‰ç”Ÿäº§è€…åŠ å…¥åˆ° MQClientlnstanceç®¡ç†ä¸­ï¼Œæ–¹ ä¾¿åç»­è°ƒç”¨ç½‘ç»œè¯·æ±‚ã€è¿›è¡Œå¿ƒè·³æ£€æµ‹ç­‰ã€‚
//Step4 : å¯åŠ¨ MQClientlnstanceï¼Œå¦‚æœ MQC!ientlnstance å·²ç»å¯åŠ¨ ï¼Œåˆ™æœ¬æ¬¡å¯ åŠ¨ä¸ä¼šçœŸ æ­£æ‰§è¡Œã€‚
            boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);
            if (!registerOK) {
                this.serviceState = ServiceState.CREATE_JUST;
                throw new MQClientException(&quot;The producer group[&quot; + this.defaultMQProducer.getProducerGroup()
                    + &quot;] has been created before, specify another name please.&quot; + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),
                    null);
            }

            this.topicPublishInfoTable.put(this.defaultMQProducer.getCreateTopicKey(), new TopicPublishInfo());

            if (startFactory) {
                mQClientFactory.start();
            }

            log.info(&quot;the producer [{}] start OK. sendMessageWithVIPChannel={}&quot;, this.defaultMQProducer.getProducerGroup(),
                this.defaultMQProducer.isSendMessageWithVIPChannel());
            this.serviceState = ServiceState.RUNNING;
            break;
        case RUNNING:
        case START_FAILED:
        case SHUTDOWN_ALREADY:
            throw new MQClientException(&quot;The producer service state not OK, maybe started once, &quot;
                + this.serviceState
                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),
                null);
        default:
            break;
    }

    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();

    RequestFutureHolder.getInstance().startScheduledTask(this);

}
</code></pre>
<blockquote>
<p>MQClientManager</p>
</blockquote>
<pre><code class="language-java">public MQClientInstance getOrCreateMQClientInstance(final ClientConfig clientConfig, RPCHook rpcHook) {
    String clientId = clientConfig.buildMQClientId();
    MQClientInstance instance = this.factoryTable.get(clientId);
    if (null == instance) {
        instance =
            new MQClientInstance(clientConfig.cloneClientConfig(),
                this.factoryIndexGenerator.getAndIncrement(), clientId, rpcHook);
        MQClientInstance prev = this.factoryTable.putIfAbsent(clientId, instance);
        if (prev != null) {
            instance = prev;
            log.warn(&quot;Returned Previous MQClientInstance for clientId:[{}]&quot;, clientId);
        } else {
            log.info(&quot;Created new MQClientInstance for clientId:[{}]&quot;, clientId);
        }
    }

    return instance;
}
</code></pre>
<h2 id="34-æ¶ˆæ¯å‘é€åŸºæœ¬æµç¨‹">3.4 æ¶ˆæ¯å‘é€åŸºæœ¬æµç¨‹</h2>
<p>æ¶ˆæ¯å‘é€æµç¨‹ä¸»è¦çš„æ­¥éª¤:éªŒè¯æ¶ˆæ¯ã€æŸ¥æ‰¾è·¯ç”± ã€ æ¶ˆæ¯å‘é€ (åŒ…å«å¼‚å¸¸å¤„ç†æœºåˆ¶) ã€‚</p>
<blockquote>
<p>åŒæ­¥æ¶ˆæ¯å‘é€å…¥å£</p>
</blockquote>
<pre><code class="language-java">//DefaultMQProducer
public SendResult send(
    Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    msg.setTopic(withNamespace(msg.getTopic()));
    return this.defaultMQProducerImpl.send(msg);
}

//DefaultMQProducerImpl
public SendResult send(Message msg,
    long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    return this.sendDefaultImpl(msg, CommunicationMode.SYNC, null, timeout);
}
</code></pre>
<h3 id="341-æ¶ˆæ¯é•¿åº¦éªŒè¯">3.4.1 æ¶ˆæ¯é•¿åº¦éªŒè¯</h3>
<p>æ¶ˆæ¯å‘é€ä¹‹å‰ï¼Œé¦–å…ˆç¡®ä¿ç”Ÿäº§è€…å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œç„¶åéªŒè¯æ¶ˆæ¯æ˜¯å¦ç¬¦åˆç›¸åº”çš„è§„èŒƒï¼Œå…·ä½“çš„è§„èŒƒè¦æ±‚æ˜¯ä¸»é¢˜åç§°ã€æ¶ˆæ¯ä½“ä¸èƒ½ä¸ºç©ºã€æ¶ˆæ¯é•¿åº¦ä¸èƒ½ç­‰äº 0ä¸”é»˜è®¤ä¸èƒ½è¶…è¿‡å…è®¸ å‘é€æ¶ˆæ¯çš„æœ€å¤§é•¿åº¦ 4M (maxMessageSize=1024 *1024 *4)ã€‚</p>
<pre><code class="language-java">public static void checkMessage(Message msg, DefaultMQProducer defaultMQProducer) throws MQClientException {
    if (null == msg) {
        throw new MQClientException(ResponseCode.MESSAGE_ILLEGAL, &quot;the message is null&quot;);
    }
    // topic
    Validators.checkTopic(msg.getTopic());
    Validators.isNotAllowedSendTopic(msg.getTopic());

    // body
    if (null == msg.getBody()) {
        throw new MQClientException(ResponseCode.MESSAGE_ILLEGAL, &quot;the message body is null&quot;);
    }

    if (0 == msg.getBody().length) {
        throw new MQClientException(ResponseCode.MESSAGE_ILLEGAL, &quot;the message body length is zero&quot;);
    }

    if (msg.getBody().length &gt; defaultMQProducer.getMaxMessageSize()) {
        throw new MQClientException(ResponseCode.MESSAGE_ILLEGAL,
            &quot;the message body size over max value, MAX: &quot; + defaultMQProducer.getMaxMessageSize());
    }
}
</code></pre>
<h3 id="342-æŸ¥æ‰¾ä¸»é¢˜è·¯ç”±ä¿¡æ¯">3.4.2 æŸ¥æ‰¾ä¸»é¢˜è·¯ç”±ä¿¡æ¯</h3>
<p>æ¶ˆæ¯å‘é€ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦è·å–ä¸»é¢˜çš„è·¯ç”±ä¿¡æ¯ï¼Œç¡®è®¤å‘é€åˆ°å…·ä½“çš„ BrokerèŠ‚ç‚¹ã€‚ã€‚</p>
<pre><code class="language-java">private TopicPublishInfo tryToFindTopicPublishInfo(final String topic) {
    TopicPublishInfo topicPublishInfo = this.topicPublishInfoTable.get(topic);
    if (null == topicPublishInfo || !topicPublishInfo.ok()) {
        this.topicPublishInfoTable.putIfAbsent(topic, new TopicPublishInfo());
        this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);
        topicPublishInfo = this.topicPublishInfoTable.get(topic);
    }

    if (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) {
        return topicPublishInfo;
    } else {
        this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, true, this.defaultMQProducer);
        topicPublishInfo = this.topicPublishInfoTable.get(topic);
        return topicPublishInfo;
    }
}
</code></pre>
<p>tryToFindTopicPublishlnfoæ˜¯æŸ¥æ‰¾ä¸»é¢˜çš„è·¯ç”±ä¿¡æ¯çš„æ–¹æ³•ã€‚å¦‚æœç”Ÿäº§è€…ä¸­ç¼“å­˜äº† topic çš„è·¯ç”±ä¿¡æ¯ï¼Œå¦‚æœè¯¥è·¯ç”±ä¿¡æ¯ä¸­åŒ…å«äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥è·¯ç”±ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜æˆ–æ²¡æœ‰åŒ…å«æ¶ˆæ¯é˜Ÿåˆ—ï¼Œ åˆ™å‘ NameServeræŸ¥è¯¢è¯¥topicçš„è·¯ç”±ä¿¡æ¯ã€‚å¦‚æœæœ€ç»ˆæœªæ‰¾åˆ°è·¯ç”±ä¿¡æ¯ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ : æ— æ³•æ‰¾åˆ°ä¸»é¢˜ç›¸å…³è·¯ç”±ä¿¡æ¯å¼‚å¸¸ã€‚</p>
<blockquote>
<p>TopicPublishInfo</p>
</blockquote>
<pre><code class="language-java">public class TopicPublishInfo {
    private boolean orderTopic = false; //æ˜¯å¦æ˜¯é¡ºåºæ¶ˆæ¯
    private boolean haveTopicRouterInfo = false; 
    private List&lt;MessageQueue&gt; messageQueueList = new ArrayList&lt;MessageQueue&gt;();  //è¯¥ä¸»é¢˜é˜Ÿåˆ—çš„æ¶ˆæ¯é˜Ÿåˆ—
    private volatile ThreadLocalIndex sendWhichQueue = new ThreadLocalIndex(); // æ¯é€‰æ‹©ä¸€æ¬¡æ¶ˆæ¯ é˜Ÿåˆ—ï¼Œ è¯¥å€¼ä¼šè‡ªå¢ lï¼Œå¦‚æœ Integer.MAX_VALUE,åˆ™é‡ç½®ä¸º 0ï¼Œç”¨äºé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€‚
    private TopicRouteData topicRouteData;
}

public class TopicRouteData extends RemotingSerializable {
    private String orderTopicConf;
    private List&lt;QueueData&gt; queueDatas; //topic é˜Ÿåˆ—å…ƒæ•°æ® ã€‚
    private List&lt;BrokerData&gt; brokerDatas; //topic åˆ†å¸ƒçš„ brokerå…ƒæ•°æ® 
    private HashMap&lt;String/* brokerAddr */, List&lt;String&gt;/* Filter Server */&gt; filterServerTable; //broker ä¸Šè¿‡æ»¤æœåŠ¡å™¨åœ°å€åˆ—è¡¨ã€‚
    //It could be null or empty
    private Map&lt;String/*brokerName*/, TopicQueueMappingInfo&gt; topicQueueMappingByBroker;
}
</code></pre>
<p>ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯æ—¶ï¼Œæœ¬åœ°æ²¡æœ‰ç¼“å­˜ topic çš„è·¯ç”±ä¿¡æ¯ï¼ŒæŸ¥è¯¢NameServerå°è¯•è·å–ï¼Œå¦‚æœè·¯ç”±ä¿¡æ¯æœªæ‰¾åˆ°ï¼Œå†æ¬¡å°è¯•ç”¨é»˜è®¤ä¸»é¢˜ DefaultMQProducerlmpl#createTopicKeyå»æŸ¥è¯¢ï¼Œå¦‚æœ BrokerConfig#autoCreateTopicEnableä¸ºtrueæ—¶ï¼ŒNameServerå°†è¿”å›è·¯ç”±ä¿¡æ¯ï¼Œå¦‚æœ autoCreateTopicEnableä¸ºfalseå°†æŠ›å‡ºæ— æ³•æ‰¾åˆ°topicè·¯ç”±å¼‚å¸¸ã€‚</p>
<blockquote>
<p>updateTopicRouteInfoFromNameServer</p>
</blockquote>
<pre><code class="language-java">public boolean updateTopicRouteInfoFromNameServer(final String topic, boolean isDefault,
    DefaultMQProducer defaultMQProducer) {
    try {
        //è·å–é”
        if (this.lockNamesrv.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) {
            try {
//Step 1 :å¦‚æœisDefaultä¸ºtrueï¼Œåˆ™ä½¿ç”¨é»˜è®¤ä¸»é¢˜å»æŸ¥è¯¢ï¼Œå¦‚æœæŸ¥è¯¢åˆ°è·¯ç”±ä¿¡æ¯ï¼Œ
// åˆ™æ›¿æ¢è·¯ç”±ä¿¡æ¯ä¸­è¯»å†™é˜Ÿåˆ—ä¸ªæ•°ä¸ºæ¶ˆæ¯ç”Ÿäº§è€…é»˜è®¤çš„é˜Ÿåˆ—ä¸ªæ•°(defaultTopicQueueNums);å¦‚æœ
// isDefaultä¸ºfalseï¼Œåˆ™ä½¿ç”¨å‚æ•° topicå»æŸ¥è¯¢;å¦‚æœæœªæŸ¥è¯¢åˆ°è·¯ç”±ä¿¡æ¯ï¼Œåˆ™è¿”å›falseï¼Œè¡¨ç¤ºè·¯ç”±ä¿¡æ¯æœªå˜åŒ–
                TopicRouteData topicRouteData;
                if (isDefault &amp;&amp; defaultMQProducer != null) {
                    topicRouteData = this.mQClientAPIImpl.getDefaultTopicRouteInfoFromNameServer(defaultMQProducer.getCreateTopicKey(),
                        clientConfig.getMqClientApiTimeout());
                    if (topicRouteData != null) {
                        for (QueueData data : topicRouteData.getQueueDatas()) {
                            int queueNums = Math.min(defaultMQProducer.getDefaultTopicQueueNums(), data.getReadQueueNums());
                            data.setReadQueueNums(queueNums);
                            data.setWriteQueueNums(queueNums);
                        }
                    }
                } else {
                    topicRouteData = this.mQClientAPIImpl.getTopicRouteInfoFromNameServer(topic, clientConfig.getMqClientApiTimeout());
                }
                if (topicRouteData != null) {
                    TopicRouteData old = this.topicRouteTable.get(topic);
                      //Step2:å¦‚æœè·¯ç”±ä¿¡æ¯æ‰¾åˆ°ï¼Œä¸æœ¬åœ°ç¼“å­˜ä¸­çš„è·¯ç”±ä¿¡æ¯è¿›è¡Œå¯¹æ¯”ï¼Œåˆ¤æ–­è·¯ç”±ä¿¡æ¯æ˜¯å¦å‘ç”Ÿäº†æ”¹å˜ï¼Œå¦‚æœæœªå‘ç”Ÿå˜åŒ–ï¼Œåˆ™ç›´æ¥è¿”å›falseã€‚
                    boolean changed = topicRouteData.topicRouteDataChanged(old);
                    if (!changed) {
                        changed = this.isNeedUpdateTopicRouteInfo(topic);
                    } else {
                        log.info(&quot;the topic[{}] route info changed, old[{}] ,new[{}]&quot;, topic, old, topicRouteData);
                    }

      //Step3:æ›´æ–° MQClientInstanceBrokeråœ°å€ç¼“å­˜è¡¨ã€‚
                    if (changed) {
                        for (BrokerData bd : topicRouteData.getBrokerDatas()) {
                            this.brokerAddrTable.put(bd.getBrokerName(), bd.getBrokerAddrs());
                        }

                        // Update endpoint map
                        {
                            ConcurrentMap&lt;MessageQueue, String&gt; mqEndPoints = topicRouteData2EndpointsForStaticTopic(topic, topicRouteData);
                            if (!mqEndPoints.isEmpty()) {
                                topicEndPointsTable.put(topic, mqEndPoints);
                            }
                        }

                        // Update Pub info
                        {
                            TopicPublishInfo publishInfo = topicRouteData2TopicPublishInfo(topic, topicRouteData);
                            publishInfo.setHaveTopicRouterInfo(true);
                            for (Entry&lt;String, MQProducerInner&gt; entry : this.producerTable.entrySet()) {
                                MQProducerInner impl = entry.getValue();
                                if (impl != null) {
                                    impl.updateTopicPublishInfo(topic, publishInfo);
                                }
                            }
                        }

// step 4:æ ¹æ® topicRouteDataä¸­çš„ List&lt;QueueData&gt;è½¬æ¢æˆtopicPublishInfoçš„ List&lt;MessageQueue&gt;
//åˆ—è¡¨ã€‚å…¶å…·ä½“å®ç°åœ¨topicRouteData2TopicPublishInfoï¼Œ ç„¶åä¼šæ›´æ–°è¯¥ MQClientInstanceæ‰€ç®¡è¾–çš„æ‰€æœ‰æ¶ˆæ¯å‘é€å…³äºtopicçš„è·¯ç”±ä¿¡æ¯
                        if (!consumerTable.isEmpty()) {
                            Set&lt;MessageQueue&gt; subscribeInfo = topicRouteData2TopicSubscribeInfo(topic, topicRouteData);
                            for (Entry&lt;String, MQConsumerInner&gt; entry : this.consumerTable.entrySet()) {
                                MQConsumerInner impl = entry.getValue();
                                if (impl != null) {
                                    impl.updateTopicSubscribeInfo(topic, subscribeInfo);
                                }
                            }
                        }
                        TopicRouteData cloneTopicRouteData = new TopicRouteData(topicRouteData);
                        log.info(&quot;topicRouteTable.put. Topic = {}, TopicRouteData[{}]&quot;, topic, cloneTopicRouteData);
                        this.topicRouteTable.put(topic, cloneTopicRouteData);
                        return true;
                    }
                } else {
                    log.warn(&quot;updateTopicRouteInfoFromNameServer, getTopicRouteInfoFromNameServer return null, Topic: {}. [{}]&quot;, topic, this.clientId);
                }
            } catch (MQClientException e) {
                if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX) &amp;&amp; !topic.equals(TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC)) {
                    log.warn(&quot;updateTopicRouteInfoFromNameServer Exception&quot;, e);
                }
            } catch (RemotingException e) {
                log.error(&quot;updateTopicRouteInfoFromNameServer Exception&quot;, e);
                throw new IllegalStateException(e);
            } finally {
                this.lockNamesrv.unlock();
            }
        } else {
            log.warn(&quot;updateTopicRouteInfoFromNameServer tryLock timeout {}ms. [{}]&quot;, LOCK_TIMEOUT_MILLIS, this.clientId);
        }
    } catch (InterruptedException e) {
        log.warn(&quot;updateTopicRouteInfoFromNameServer Exception&quot;, e);
    }

    return false;
}
</code></pre>
<p>å¾ªç¯éå†è·¯ç”±ä¿¡æ¯çš„QueueData ä¿¡æ¯ï¼Œå¦‚æœé˜Ÿåˆ—æ²¡æœ‰å†™æƒé™ï¼Œåˆ™ç»§ç»­éå†ä¸‹ä¸€ä¸ªQueueData ï¼Œæ ¹æ® topic+åºå·åˆ›å»º MessageQueueï¼Œå¡«å…… topicPublishlnfoçš„List<QuueMessage>ã€‚ å®Œæˆæ¶ˆæ¯å‘é€çš„è·¯ç”±æŸ¥æ‰¾ ã€‚</p>
<blockquote>
<p>topicRouteData2TopicSubscribeInfo</p>
</blockquote>
<pre><code class="language-java">public static Set&lt;MessageQueue&gt; topicRouteData2TopicSubscribeInfo(final String topic, final TopicRouteData route) {
    Set&lt;MessageQueue&gt; mqList = new HashSet&lt;&gt;();
    if (route.getTopicQueueMappingByBroker() != null
            &amp;&amp; !route.getTopicQueueMappingByBroker().isEmpty()) {
        ConcurrentMap&lt;MessageQueue, String&gt; mqEndPoints = topicRouteData2EndpointsForStaticTopic(topic, route);
        return mqEndPoints.keySet();
    }
    List&lt;QueueData&gt; qds = route.getQueueDatas();
    for (QueueData qd : qds) {
        if (PermName.isReadable(qd.getPerm())) {
            for (int i = 0; i &lt; qd.getReadQueueNums(); i++) {
                MessageQueue mq = new MessageQueue(topic, qd.getBrokerName(), i);
                mqList.add(mq);
            }
        }
    }

    return mqList;
}
</code></pre>
<h3 id="343-é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—">3.4.3 é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>é¦–å…ˆæ¶ˆæ¯å‘é€ç«¯é‡‡ç”¨é‡è¯•æœºåˆ¶ ï¼Œç”±retryTimesWhenSendFailedæŒ‡å®šåŒæ­¥æ–¹å¼é‡è¯•æ¬¡æ•°ï¼Œå¼‚æ­¥é‡è¯•æœºåˆ¶åœ¨æ”¶åˆ°æ¶ˆæ¯å‘é€ç»“æ„åæ‰§è¡Œå›è°ƒä¹‹å‰è¿›è¡Œé‡è¯•ã€‚ç”±retryTimesWhenSend-AsyncFailedæŒ‡å®šï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¾ªç¯æ‰§è¡Œï¼Œé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€å‘é€æ¶ˆæ¯ï¼Œå‘é€æˆåŠŸåˆ™è¿”å›ï¼Œæ”¶åˆ°å¼‚å¸¸åˆ™é‡è¯•ã€‚é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—æœ‰ä¸¤ç§æ–¹å¼ã€‚</p>
<p>1 ) sendLatencyFaultEnable=falseï¼Œé»˜è®¤ä¸å¯ç”¨Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶ã€‚<br>
2 ) sendLatencyFaultEnable=trueï¼Œå¯ç”¨Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶ã€‚</p>
<h4 id="1-é»˜è®¤æœºåˆ¶">1. é»˜è®¤æœºåˆ¶</h4>
<pre><code class="language-java">public MessageQueue selectOneMessageQueue(final TopicPublishInfo tpInfo, final String lastBrokerName) {
    //åˆ¤æ–­å¯ç”¨ä¸å¯ç”¨Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶
    if (this.sendLatencyFaultEnable) {
        try {
            int index = tpInfo.getSendWhichQueue().incrementAndGet();
            for (int i = 0; i &lt; tpInfo.getMessageQueueList().size(); i++) {
                int pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();
                if (pos &lt; 0)
                    pos = 0;
                MessageQueue mq = tpInfo.getMessageQueueList().get(pos);
                //éªŒè¯è¯¥æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦å¯ç”¨
                if (latencyFaultTolerance.isAvailable(mq.getBrokerName()))
                    return mq;
            }

            final String notBestBroker = latencyFaultTolerance.pickOneAtLeast();
            int writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);
            if (writeQueueNums &gt; 0) {
                final MessageQueue mq = tpInfo.selectOneMessageQueue();
                if (notBestBroker != null) {
                    mq.setBrokerName(notBestBroker);
                    mq.setQueueId(tpInfo.getSendWhichQueue().incrementAndGet() % writeQueueNums);
                }
                return mq;
            } else {
                latencyFaultTolerance.remove(notBestBroker);
            }
        } catch (Exception e) {
            log.error(&quot;Error occurred when selecting message queue&quot;, e);
        }

        return tpInfo.selectOneMessageQueue();
    }
    //ä¸å¯ç”¨Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶
    return tpInfo.selectOneMessageQueue(lastBrokerName);
}
</code></pre>
<blockquote>
<p>TopicPublishInfo å¯ç”¨Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶</p>
</blockquote>
<pre><code class="language-java">public MessageQueue selectOneMessageQueue(final String lastBrokerName) {
    if (lastBrokerName == null) {
        return selectOneMessageQueue();
    } else {
        for (int i = 0; i &lt; this.messageQueueList.size(); i++) {
            int index = this.sendWhichQueue.incrementAndGet();
            int pos = Math.abs(index) % this.messageQueueList.size();
            if (pos &lt; 0)
                pos = 0;
            MessageQueue mq = this.messageQueueList.get(pos);
            if (!mq.getBrokerName().equals(lastBrokerName)) {
                return mq;
            }
        }
        return selectOneMessageQueue();
    }
}

public MessageQueue selectOneMessageQueue() {
    int index = this.sendWhichQueue.incrementAndGet();
    int pos = Math.abs(index) % this.messageQueueList.size();
    if (pos &lt; 0)
        pos = 0;
    return this.messageQueueList.get(pos);
}
</code></pre>
<p>é¦–å…ˆåœ¨ä¸€æ¬¡æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå¤šæ¬¡æ‰§è¡Œé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—è¿™ä¸ªæ–¹æ³•ï¼ŒlastBrokerNameå°±æ˜¯ä¸Šä¸€æ¬¡é€‰æ‹©çš„æ‰§è¡Œå‘é€æ¶ˆæ¯å¤±è´¥çš„Brokerã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—é€‰æ‹©æ—¶ï¼ŒlastBrokerNameä¸ºnullï¼Œæ­¤æ—¶ç›´æ¥ç”¨ sendWhichQueueè‡ªå¢å†è·å–å€¼ï¼Œä¸å½“å‰è·¯ç”±è¡¨ä¸­æ¶ˆæ¯é˜Ÿåˆ—ä¸ªæ•°å–æ¨¡ï¼Œè¿”å›è¯¥ä½ç½®çš„MessageQueue(selectOneMessageQueue()æ–¹æ³•)ï¼Œå¦‚æœæ¶ˆæ¯å‘é€å†å¤±è´¥çš„è¯ï¼Œä¸‹æ¬¡è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—é€‰æ‹©æ—¶è§„é¿ä¸Šæ¬¡ MesageQueueæ‰€åœ¨çš„Brokerï¼Œå¦åˆ™è¿˜æ˜¯å¾ˆæœ‰å¯èƒ½å†æ¬¡å¤±è´¥ã€‚</p>
<p>è¯¥ç®—æ³•åœ¨ä¸€æ¬¡æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­èƒ½æˆåŠŸè§„é¿æ•…éšœçš„Brokerï¼Œä½†å¦‚æœ Brokerè‹¥æœºï¼Œç”±äºè·¯ ç”±ç®—æ³•ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æŒ‰ Brokeræ’åºçš„ï¼Œå¦‚æœä¸Šä¸€æ¬¡æ ¹æ®è·¯ç”±ç®—æ³•é€‰æ‹©çš„æ˜¯è‹¥æœºçš„Brokerçš„ç¬¬ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆéšåçš„ä¸‹æ¬¡é€‰æ‹©çš„æ˜¯è‹¥æœºBrokerçš„ç¬¬äºŒä¸ªé˜Ÿåˆ—ï¼Œæ¶ˆæ¯å‘é€å¾ˆæœ‰å¯èƒ½ä¼šå¤±è´¥ï¼Œå†æ¬¡å¼•å‘é‡è¯•ï¼Œå¸¦æ¥ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚</p>
<p>Brokerä¸å¯ç”¨åï¼Œè·¯ç”±ä¿¡æ¯ä¸­ä¸ºä»€ä¹ˆè¿˜ä¼šåŒ…å«è¯¥ Brokerçš„è·¯ç”±ä¿¡æ¯å‘¢?å…¶å®è¿™ä¸éš¾è§£é‡Š:é¦–å…ˆï¼Œ NameServer æ£€æµ‹Brokeræ˜¯å¦å¯ç”¨æ˜¯æœ‰å»¶è¿Ÿçš„ï¼Œæœ€çŸ­ä¸ºä¸€æ¬¡å¿ƒè·³æ£€æµ‹é—´éš”(10s); å…¶æ¬¡ï¼ŒNameServerä¸ä¼š æ£€æµ‹åˆ° Brokerå²©æœºåé©¬ä¸Šæ¨é€æ¶ˆæ¯ç»™æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œè€Œæ˜¯æ¶ˆæ¯ç”Ÿäº§è€…æ¯éš” 30sæ›´æ–°ä¸€æ¬¡è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¶ˆæ¯ç”Ÿäº§è€…æœ€å¿«æ„ŸçŸ¥Brokeræœ€æ–°çš„è·¯ç”±ä¿¡æ¯ä¹Ÿéœ€è¦30sã€‚å¦‚æœèƒ½å¼•äººä¸€ç§æœºåˆ¶ï¼Œåœ¨ Brokerè‹¥æœºæœŸé—´ï¼Œå¦‚æœä¸€æ¬¡æ¶ˆæ¯å‘é€å¤±è´¥åï¼Œå¯ä»¥å°†è¯¥ Brokeræš‚æ—¶æ’é™¤åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©èŒƒå›´ä¸­ã€‚</p>
<h4 id="2-brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶">2. Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶</h4>
<p>ä»£ç å¦‚ä¸Š</p>
<p>1 )æ ¹æ®å¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè½®è¯¢è·å–ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— ã€‚<br>
2)éªŒè¯è¯¥æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦å¯ç”¨ï¼ŒlatencyFaultTolerance.isAvailable(mq.getBrokerName())<br>
3)å¦‚æœè¿”å›çš„ MessageQueueå¯ç”¨ï¼Œ ç§»é™¤latencyFaultToleranceå…³äºè¯¥topicæ¡ç›®ï¼Œ è¡¨<br>
æ˜è¯¥Brokeræ•…éšœå·²ç»æ¢å¤ã€‚</p>
<p><strong>Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶æ ¸å¿ƒç±»-LatencyFaultTolerance</strong></p>
<pre><code class="language-java">public interface LatencyFaultTolerance&lt;T&gt; {
    /**
     * æ›´æ–°å¤±è´¥æ¡ç›®
     * @param name brokerName
     * @param currentLatency æ¶ˆæ¯å‘é€æ•…éšœå»¶è¿Ÿæ—¶é—´
     * @param notAvailableDuration ä¸å¯ç”¨æŒç»­æ—¶è¾°ï¼Œåœ¨è¿™ä¸ªæ—¶é—´å†…Brokerå°†è¢«è§„é¿
     */
    void updateFaultItem(final T name, final long currentLatency, final long notAvailableDuration);

    /**
     * åˆ¤æ–­ Brokeræ˜¯å¦å¯ç”¨
     * @param name
     * @return
     */
    boolean isAvailable(final T name);

    /**
     * ç§»é™¤Faultæ¡ç›®ï¼Œæ„å‘³ç€Brokeré‡æ–°å‚ä¸è·¯ç”±è®¡ç®—
     * @param name
     */
    void remove(final T name);

    /**
     * å°è¯•ä»è§„é¿çš„Brokerä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„Brokerï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°†è¿”å›null
     * @return
     */
    T pickOneAtLeast();
}
</code></pre>
<p><strong>Faultltem: å¤±è´¥æ¡ç›®(è§„é¿è§„åˆ™æ¡ç›®)</strong></p>
<pre><code class="language-java">class FaultItem implements Comparable&lt;FaultItem&gt; {
    //æ¡ç›®å”¯ä¸€é”®ï¼Œè¿™é‡Œä¸ºbrokerName
    private final String name;
    //æœ¬æ¬¡æ¶ˆæ¯å‘é€å»¶è¿Ÿ
    private volatile long currentLatency;
    //æ•…éšœè§„é¿å¼€å§‹æ—¶é—´
    private volatile long startTimestamp;
}
</code></pre>
<p><strong>MQFaultStrategy:æ¶ˆæ¯å¤±è´¥ç­–ç•¥ï¼Œå»¶è¿Ÿå®ç°çš„é—¨é¢ç±»</strong></p>
<pre><code class="language-java">private long[] latencyMax = {50L, 100L, 550L, 1000L, 2000L, 3000L, 15000L};
private long[] notAvailableDuration = {0L, 0L, 30000L, 60000L, 120000L, 180000L, 600000L};
</code></pre>
<p>latencyMaxæ ¹æ®currentLatencyæœ¬æ¬¡æ¶ˆæ¯å‘é€å»¶è¿Ÿï¼Œä»latencyMaxå°¾éƒ¨å‘å‰æ‰¾åˆ°<br>
ç¬¬ä¸€ä¸ªæ¯”currentLatencyå°çš„ç´¢å¼•indexï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å›0ã€‚ç„¶åæ ¹æ®è¿™ä¸ªç´¢å¼•ä» notAvailableDurationæ•°ç»„ä¸­å–å‡ºå¯¹åº”çš„æ—¶é—´ï¼Œåœ¨è¿™ä¸ªæ—¶é•¿å†…ï¼ŒBrokerå°†è®¾ç½®ä¸ºä¸å¯ç”¨ã€‚</p>
<blockquote>
<p><em>MQFaultStrategy#updateFaultltem</em></p>
</blockquote>
<pre><code class="language-java">/**
    * æ›´æ–°å¤±è´¥æ¡ç›®
    * @param brokerName
    * @param currentLatency æœ¬æ¬¡æ¶ˆæ¯å‘é€å»¶è¿Ÿæ—¶é—´
    * @param isolation isolationï¼Œæ˜¯å¦éš”ç¦»ï¼Œè¯¥å‚æ•°çš„å«ä¹‰å¦‚æœä¸º trueï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ—¶é•¿30sæ¥
    * è®¡ç®—Brokeræ•…éšœè§„é¿æ—¶é•¿ï¼Œå¦‚æœä¸ºfalseï¼Œåˆ™ä½¿ç”¨æœ¬æ¬¡æ¶ˆæ¯å‘é€å»¶è¿Ÿæ—¶é—´æ¥è®¡ç®—Brokeræ•…éšœè§„é¿æ—¶é•¿ã€‚
    */
public void updateFaultItem(final String brokerName, final long currentLatency, boolean isolation) {
    if (this.sendLatencyFaultEnable) {
        long duration = computeNotAvailableDuration(isolation ? 30000 : currentLatency);
        this.latencyFaultTolerance.updateFaultItem(brokerName, currentLatency, duration);
    }
}

private long computeNotAvailableDuration(final long currentLatency) {
    for (int i = latencyMax.length - 1; i &gt;= 0; i--) {
        if (currentLatency &gt;= latencyMax[i])
            return this.notAvailableDuration[i];
    }

    return 0;
}
</code></pre>
<p>computeNotAvailableDurationçš„ä½œç”¨æ˜¯è®¡ç®—å› æœ¬æ¬¡æ¶ˆæ¯å‘é€æ•…éšœéœ€è¦å°† Broker è§„é¿çš„æ—¶é•¿ï¼Œä¹Ÿå°±æ˜¯æ¥ä¸‹æ¥å¤šä¹…çš„æ—¶é—´å†…è¯¥ Brokerå°†ä¸å‚ä¸æ¶ˆæ¯å‘é€é˜Ÿåˆ—è´Ÿè½½ã€‚å…·ä½“ç®—æ³•:ä» latencyMaxæ•°ç»„å°¾éƒ¨å¼€å§‹å¯»æ‰¾ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”currentLatencyå°çš„ä¸‹æ ‡ï¼Œ ç„¶åä»notAvailableDurationæ•°ç»„ä¸­è·å–éœ€è¦è§„é¿çš„æ—¶é•¿ï¼Œè¯¥æ–¹æ³•æœ€ç»ˆè°ƒç”¨LatencyFaultToleranceçš„updateFaultltemã€‚</p>
<pre><code class="language-java">@Override
public void updateFaultItem(final String name, final long currentLatency, final long notAvailableDuration) {
    FaultItem old = this.faultItemTable.get(name);
    if (null == old) {
        final FaultItem faultItem = new FaultItem(name);
        faultItem.setCurrentLatency(currentLatency);
        faultItem.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);

        old = this.faultItemTable.putIfAbsent(name, faultItem);
        if (old != null) {
            old.setCurrentLatency(currentLatency);
            old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);
        }
    } else {
        old.setCurrentLatency(currentLatency);
        old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);
    }
}
</code></pre>
<p>æ ¹æ® brokeråç§°ä»ç¼“å­˜è¡¨ä¸­è·å–Faultitemï¼Œå¦‚æœæ‰¾åˆ°åˆ™æ›´æ–°Faultltemï¼Œå¦åˆ™åˆ›å»ºFaultltemã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®ç‚¹ã€‚<br>
1)currentLatencyã€startTimeStampè¢«volatileä¿®é¥°ã€‚<br>
2)startTimeStampä¸ºå½“å‰ç³»ç»Ÿæ—¶é—´åŠ ä¸Šéœ€è¦è§„é¿çš„æ—¶é•¿ã€‚startTimeStampæ˜¯åˆ¤æ–­brokerå½“å‰æ˜¯å¦å¯ç”¨çš„ç›´æ¥ä¸€å¥ï¼Œè¯·çœ‹ Faultltem#isAvailableæ–¹æ³•ã€‚</p>
<pre><code class="language-java">public boolean isAvailable() {
    return (System.currentTimeMillis() - startTimestamp) &gt;= 0;
}
</code></pre>
<h3 id="344-æ¶ˆæ¯å‘é€">3.4.4 æ¶ˆæ¯å‘é€</h3>
<pre><code class="language-java">/**
    * å‘é€æ¶ˆæ¯
    * @param msg å¾…å‘é€æ¶ˆæ¯
    * @param mq  æ¶ˆæ¯å°†å‘é€åˆ°è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸Š
    * @param communicationMode æ¶ˆæ¯å‘é€æ¨¡å¼
    * @param sendCallback å¼‚æ­¥æ¶ˆæ¯å›è°ƒå‡½æ•°
    * @param topicPublishInfo ä¸»é¢˜è·¯ç”±ä¿¡æ¯
    * @param timeout æ¶ˆæ¯å‘é€è¶…æ—¶æ—¶é—´
    */
private SendResult sendKernelImpl(final Message msg,
    final MessageQueue mq,
    final CommunicationMode communicationMode,
    final SendCallback sendCallback,
    final TopicPublishInfo topicPublishInfo,
    final long timeout)
</code></pre>
<p>Step 1:æ ¹æ®MessageQueueè·å–Brokerçš„ç½‘ç»œåœ°å€ã€‚å¦‚æœMQClientlnstanceçš„brokerAddrTableç¦¾ç¼“å­˜è¯¥Brokerçš„ä¿¡æ¯ï¼Œåˆ™ä»NameServerä¸»åŠ¨æ›´æ–°ä¸€ä¸‹topicçš„è·¯ç”±ä¿¡æ¯ã€‚å¦‚æœè·¯ç”±æ›´æ–°åè¿˜æ˜¯æ‰¾ä¸åˆ° Brokerä¿¡æ¯ï¼Œåˆ™æŠ›å‡ºMQClientExceptionï¼Œæç¤ºBrokerä¸å­˜åœ¨ã€‚</p>
<blockquote>
<p>DefaultMQProducelmpl#sendKernellmpl</p>
</blockquote>
<pre><code class="language-java">String brokerName = this.mQClientFactory.getBrokerNameFromMessageQueue(mq);
String brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(brokerName);
if (null == brokerAddr) {
    tryToFindTopicPublishInfo(mq.getTopic());
    brokerName = this.mQClientFactory.getBrokerNameFromMessageQueue(mq);
    brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(brokerName);
}
</code></pre>
<p>Step2:ä¸ºæ¶ˆæ¯åˆ†é…å…¨å±€å”¯ä¸€ID ï¼Œå¦‚æœæ¶ˆæ¯ä½“é»˜è®¤è¶…è¿‡ 4K(compressMsgBodyOverHowmuch), ä¼šå¯¹æ¶ˆæ¯ä½“é‡‡ç”¨ zipå‹ç¼©ï¼Œå¹¶è®¾ç½®æ¶ˆæ¯çš„ç³»ç»Ÿæ ‡è®°ä¸º MessageSysFlag.COMPRESSED_FLAGã€‚ å¦‚æœæ˜¯äº‹åŠ¡ Preparedæ¶ˆæ¯ï¼Œåˆ™è®¾æ¶ˆæ¯çš„ç³»ç»Ÿæ ‡è®°ä¸ºMessageSysFlag.TRANSACTION_ PREPARED_TYPEã€‚</p>
<blockquote>
<p>DefaultMQProducelmpl#sendKernellmpl</p>
</blockquote>
<pre><code class="language-java">if (!(msg instanceof MessageBatch)) {
    MessageClientIDSetter.setUniqID(msg);
}

boolean topicWithNamespace = false;
if (null != this.mQClientFactory.getClientConfig().getNamespace()) {
    msg.setInstanceId(this.mQClientFactory.getClientConfig().getNamespace());
    topicWithNamespace = true;
}

int sysFlag = 0;
boolean msgBodyCompressed = false;
if (this.tryToCompressMessage(msg)) {//å‹ç¼©æ¶ˆæ¯
    sysFlag |= MessageSysFlag.COMPRESSED_FLAG;
    sysFlag |= compressType.getCompressionFlag();
    msgBodyCompressed = true;
}

final String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);
if (Boolean.parseBoolean(tranMsg)) {
    sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;
}
</code></pre>
<p>Step3 :å¦‚æœæ³¨å†Œäº†æ¶ˆæ¯å‘é€é’©å­å‡½æ•°ï¼Œåˆ™æ‰§è¡Œæ¶ˆæ¯å‘é€ä¹‹å‰çš„å¢å¼ºé€»è¾‘ã€‚é€šè¿‡DefaultMQProducerlmpl#registerSendMessageHookæ³¨å†Œé’©å­å¤„ç†ç±»ï¼Œå¹¶ä¸”å¯ä»¥æ³¨å†Œå¤šä¸ªã€‚</p>
<pre><code class="language-java">if (hasCheckForbiddenHook()) {
    CheckForbiddenContext checkForbiddenContext = new CheckForbiddenContext();
    checkForbiddenContext.setNameSrvAddr(this.defaultMQProducer.getNamesrvAddr());
    checkForbiddenContext.setGroup(this.defaultMQProducer.getProducerGroup());
    checkForbiddenContext.setCommunicationMode(communicationMode);
    checkForbiddenContext.setBrokerAddr(brokerAddr);
    checkForbiddenContext.setMessage(msg);
    checkForbiddenContext.setMq(mq);
    checkForbiddenContext.setUnitMode(this.isUnitMode());
    this.executeCheckForbiddenHook(checkForbiddenContext);
}

if (this.hasSendMessageHook()) {
    context = new SendMessageContext();
    context.setProducer(this);
    context.setProducerGroup(this.defaultMQProducer.getProducerGroup());
    context.setCommunicationMode(communicationMode);
    context.setBornHost(this.defaultMQProducer.getClientIP());
    context.setBrokerAddr(brokerAddr);
    context.setMessage(msg);
    context.setMq(mq);
    context.setNamespace(this.defaultMQProducer.getNamespace());
    String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);
    if (isTrans != null &amp;&amp; isTrans.equals(&quot;true&quot;)) {
        context.setMsgType(MessageType.Trans_Msg_Half);
    }

    if (msg.getProperty(&quot;__STARTDELIVERTIME&quot;) != null || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != null) {
        context.setMsgType(MessageType.Delay_Msg);
    }
    this.executeSendMessageHookBefore(context);
}
</code></pre>
<p>Step4 :æ„å»ºæ¶ˆæ¯å‘é€è¯·æ±‚åŒ…ã€‚ ä¸»è¦åŒ…å«å¦‚ä¸‹é‡è¦ä¿¡æ¯:ç”Ÿäº§è€…ç»„ã€ä¸»é¢˜åç§°ã€é»˜è®¤åˆ›å»ºä¸»é¢˜ Keyã€è¯¥ä¸»é¢˜åœ¨å•ä¸ªBrokeré»˜è®¤é˜Ÿåˆ—æ•° ã€é˜Ÿåˆ—ID (é˜Ÿåˆ—åºå·)ã€æ¶ˆæ¯ç³»ç»Ÿæ ‡è®°( MessageSysFlag)ã€æ¶ˆæ¯å‘é€æ—¶é—´ã€æ¶ˆæ¯æ ‡è®°(RocketMQå¯¹æ¶ˆæ¯ä¸­çš„ flagä¸åšä»»ä½•å¤„ç†ï¼Œä¾›åº”ç”¨ç¨‹åºä½¿ç”¨)ã€æ¶ˆæ¯æ‰©å±•å±æ€§ã€æ¶ˆæ¯é‡è¯•æ¬¡æ•°ã€æ˜¯å¦æ˜¯æ‰¹é‡æ¶ˆæ¯ç­‰ã€‚</p>
<pre><code class="language-java">SendMessageRequestHeader requestHeader = new SendMessageRequestHeader();
requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());
requestHeader.setTopic(msg.getTopic());
requestHeader.setDefaultTopic(this.defaultMQProducer.getCreateTopicKey());
requestHeader.setDefaultTopicQueueNums(this.defaultMQProducer.getDefaultTopicQueueNums());
requestHeader.setQueueId(mq.getQueueId());
requestHeader.setSysFlag(sysFlag);
requestHeader.setBornTimestamp(System.currentTimeMillis());
requestHeader.setFlag(msg.getFlag());
requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));
requestHeader.setReconsumeTimes(0);
requestHeader.setUnitMode(this.isUnitMode());
requestHeader.setBatch(msg instanceof MessageBatch);
if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
    String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);
    if (reconsumeTimes != null) {
        requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));
        MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);
    }

    String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);
    if (maxReconsumeTimes != null) {
        requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));
        MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);
    }
}
</code></pre>
<p>Step5:æ ¹æ®æ¶ˆæ¯å‘é€æ–¹å¼ï¼ŒåŒæ­¥ã€å¼‚æ­¥ã€å•å‘æ–¹å¼è¿›è¡Œç½‘ç»œä¼ è¾“ã€‚</p>
<blockquote>
<p>MQClientAPIImpl#sendMessage</p>
</blockquote>
<pre><code class="language-java"> public SendResult sendMessage(
        final String addr,
        final String brokerName,
        final Message msg,
        final SendMessageRequestHeader requestHeader,
        final long timeoutMillis,
        final CommunicationMode communicationMode,
        final SendCallback sendCallback,
        final TopicPublishInfo topicPublishInfo,
        final MQClientInstance instance,
        final int retryTimesWhenSendFailed,
        final SendMessageContext context,
        final DefaultMQProducerImpl producer
    ) throws RemotingException, MQBrokerException, InterruptedException {
        long beginStartTime = System.currentTimeMillis();
        RemotingCommand request = null;
        String msgType = msg.getProperty(MessageConst.PROPERTY_MESSAGE_TYPE);
        boolean isReply = msgType != null &amp;&amp; msgType.equals(MixAll.REPLY_MESSAGE_FLAG);
        if (isReply) {
            if (sendSmartMsg) {
                SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);
                request = RemotingCommand.createRequestCommand(RequestCode.SEND_REPLY_MESSAGE_V2, requestHeaderV2);
            } else {
                request = RemotingCommand.createRequestCommand(RequestCode.SEND_REPLY_MESSAGE, requestHeader);
            }
        } else {
            if (sendSmartMsg || msg instanceof MessageBatch) {
                SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);
                request = RemotingCommand.createRequestCommand(msg instanceof MessageBatch ? RequestCode.SEND_BATCH_MESSAGE : RequestCode.SEND_MESSAGE_V2, requestHeaderV2);
            } else {
                request = RemotingCommand.createRequestCommand(RequestCode.SEND_MESSAGE, requestHeader);
            }
        }
        request.setBody(msg.getBody());

        switch (communicationMode) {
            case ONEWAY:
                this.remotingClient.invokeOneway(addr, request, timeoutMillis);
                return null;
            case ASYNC:
                final AtomicInteger times = new AtomicInteger();
                long costTimeAsync = System.currentTimeMillis() - beginStartTime;
                if (timeoutMillis &lt; costTimeAsync) {
                    throw new RemotingTooMuchRequestException(&quot;sendMessage call timeout&quot;);
                }
                this.sendMessageAsync(addr, brokerName, msg, timeoutMillis - costTimeAsync, request, sendCallback, topicPublishInfo, instance,
                    retryTimesWhenSendFailed, times, context, producer);
                return null;
            case SYNC:
                long costTimeSync = System.currentTimeMillis() - beginStartTime;
                if (timeoutMillis &lt; costTimeSync) {
                    throw new RemotingTooMuchRequestException(&quot;sendMessage call timeout&quot;);
                }
                return this.sendMessageSync(addr, brokerName, msg, timeoutMillis - costTimeSync, request);
            default:
                assert false;
                break;
        }

        return null;
    }
</code></pre>
<p>Step6:å¦‚æœæ³¨å†Œäº†æ¶ˆæ¯å‘é€é’©å­å‡½æ•°ï¼Œæ‰§è¡Œ afteré€»è¾‘ã€‚ æ³¨æ„ï¼Œå°±ç®—æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­å‘<br>
ç”Ÿ RemotingExceptionã€ MQBrokerExceptionã€ InterruptedExceptionæ—¶è¯¥æ–¹æ³•ä¹Ÿä¼šæ‰§è¡Œã€‚</p>
<pre><code class="language-java">if (this.hasSendMessageHook()) {
    context.setSendResult(sendResult);
    this.executeSendMessageHookAfter(context);
}
</code></pre>
<h4 id="1-åŒæ­¥å‘é€">1. åŒæ­¥å‘é€</h4>
<p>MQå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯çš„å…¥å£æ˜¯MQClientAPIImpl#sendMessageã€‚è¯·æ±‚å‘½ä»¤æ˜¯RequestÂ­<br>
Code.SEND_MESSAGEï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è¯¥å‘½ä»¤çš„å¤„ç†ç±»: org.apache.rocketmq.broker.processor. SendMessageProcessorã€‚å…¥å£æ–¹æ³•åœ¨ SendMessageProcessor#sendMessageã€‚</p>
<pre><code class="language-java">public RemotingCommand sendMessage(final ChannelHandlerContext ctx,
    final RemotingCommand request,
    final SendMessageContext sendMessageContext,
    final SendMessageRequestHeader requestHeader,
    final TopicQueueMappingContext mappingContext,
    final SendMessageCallback sendMessageCallback) throws RemotingCommandException {
    //å‘é€æ¶ˆæ¯å¹¶ä¸”è¿›è¡Œæ¶ˆæ¯å®¡æŸ¥
    final RemotingCommand response = preSend(ctx, request, requestHeader);
    if (response.getCode() != -1) {
        return response;
    }

    final SendMessageResponseHeader responseHeader = (SendMessageResponseHeader) response.readCustomHeader();

    final byte[] body = request.getBody();

    int queueIdInt = requestHeader.getQueueId();
    TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());

    if (queueIdInt &lt; 0) {
        queueIdInt = randomQueueId(topicConfig.getWriteQueueNums());
    }

    MessageExtBrokerInner msgInner = new MessageExtBrokerInner();
    msgInner.setTopic(requestHeader.getTopic());
    msgInner.setQueueId(queueIdInt);

    Map&lt;String, String&gt; oriProps = MessageDecoder.string2messageProperties(requestHeader.getProperties());

    // Step2:å¦‚æœæ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡å…è®¸çš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ¶ˆæ¯å°†è¿›å…¥åˆ° DLD å»¶è¿Ÿé˜Ÿåˆ— 
    if (!handleRetryAndDLQ(requestHeader, response, request, msgInner, topicConfig, oriProps)) {
        return response;
    }

    msgInner.setBody(body);
    msgInner.setFlag(requestHeader.getFlag());

    String uniqKey = oriProps.get(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);
    if (uniqKey == null || uniqKey.length() &lt;= 0) {
        uniqKey = MessageClientIDSetter.createUniqID();
        oriProps.put(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX, uniqKey);
    }

    MessageAccessor.setProperties(msgInner, oriProps);
    msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(topicConfig.getTopicFilterType(), msgInner.getTags()));
    msgInner.setBornTimestamp(requestHeader.getBornTimestamp());
    msgInner.setBornHost(ctx.channel().remoteAddress());
    msgInner.setStoreHost(this.getStoreHost());
    msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == null ? 0 : requestHeader.getReconsumeTimes());
    String clusterName = this.brokerController.getBrokerConfig().getBrokerClusterName();
    MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_CLUSTER, clusterName);

    msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgInner.getProperties()));

    // Map&lt;String, String&gt; oriProps = MessageDecoder.string2messageProperties(requestHeader.getProperties());
    String traFlag = oriProps.get(MessageConst.PROPERTY_TRANSACTION_PREPARED);
    boolean sendTransactionPrepareMessage = false;
    if (Boolean.parseBoolean(traFlag)
        &amp;&amp; !(msgInner.getReconsumeTimes() &gt; 0 &amp;&amp; msgInner.getDelayTimeLevel() &gt; 0)) { //For client under version 4.6.1
        if (this.brokerController.getBrokerConfig().isRejectTransactionMessage()) {
            response.setCode(ResponseCode.NO_PERMISSION);
            response.setRemark(
                &quot;the broker[&quot; + this.brokerController.getBrokerConfig().getBrokerIP1()
                    + &quot;] sending transaction message is forbidden&quot;);
            return response;
        }
        sendTransactionPrepareMessage = true;
    }

    long beginTimeMillis = this.brokerController.getMessageStore().now();

    if (brokerController.getBrokerConfig().isAsyncSendEnable()) {
        CompletableFuture&lt;PutMessageResult&gt; asyncPutMessageFuture;
        if (sendTransactionPrepareMessage) {
            asyncPutMessageFuture = this.brokerController.getTransactionalMessageService().asyncPrepareMessage(msgInner);
        } else {
            asyncPutMessageFuture = this.brokerController.getMessageStore().asyncPutMessage(msgInner);
        }

        final int finalQueueIdInt = queueIdInt;
        final MessageExtBrokerInner finalMsgInner = msgInner;
        asyncPutMessageFuture.thenAcceptAsync(putMessageResult -&gt; {
            RemotingCommand responseFuture =
                handlePutMessageResult(putMessageResult, response, request, finalMsgInner, responseHeader, sendMessageContext,
                    ctx, finalQueueIdInt, beginTimeMillis, mappingContext);
            if (responseFuture != null) {
                doResponse(ctx, request, responseFuture);
            }
            sendMessageCallback.onComplete(sendMessageContext, response);
        }, this.brokerController.getPutMessageFutureExecutor());
        // Returns null to release the send message thread
        return null;
    } else {
        PutMessageResult putMessageResult = null;
        if (sendTransactionPrepareMessage) {
            putMessageResult = this.brokerController.getTransactionalMessageService().prepareMessage(msgInner);
        } else {
            //è°ƒç”¨ DefaultMessageStore#putMessage è¿›è¡Œæ¶ˆæ¯ å­˜å‚¨
            putMessageResult = this.brokerController.getMessageStore().putMessage(msgInner);
        }
        handlePutMessageResult(putMessageResult, response, request, msgInner, responseHeader, sendMessageContext, ctx, queueIdInt, beginTimeMillis, mappingContext);
        sendMessageCallback.onComplete(sendMessageContext, response);
        return response;
    }
}
</code></pre>
<blockquote>
<p>msgCheck</p>
</blockquote>
<pre><code class="language-java">protected RemotingCommand msgCheck(final ChannelHandlerContext ctx,
    final SendMessageRequestHeader requestHeader, final RemotingCommand request,
    final RemotingCommand response) {

    //1 )æ£€æŸ¥è¯¥Brokeræ˜¯å¦æœ‰å†™æƒé™
    if (!PermName.isWriteable(this.brokerController.getBrokerConfig().getBrokerPermission())
        &amp;&amp; this.brokerController.getTopicConfigManager().isOrderTopic(requestHeader.getTopic())) {
        response.setCode(ResponseCode.NO_PERMISSION);
        response.setRemark(&quot;the broker[&quot; + this.brokerController.getBrokerConfig().getBrokerIP1()
            + &quot;] sending message is forbidden&quot;);
        return response;
    }

    //æ£€æŸ¥è¯¥Topicæ˜¯å¦å¯ä»¥è¿›è¡Œæ¶ˆæ¯å‘é€ã€‚ä¸»è¦é’ˆå¯¹é»˜è®¤ä¸»é¢˜ï¼Œé»˜è®¤ä¸»é¢˜ä¸èƒ½å‘é€æ¶ˆæ¯ï¼Œä»…ä»…ä¾›è·¯ç”±æŸ¥æ‰¾
    if (!TopicValidator.validateTopic(requestHeader.getTopic(), response)) {
        return response;
    }
    if (TopicValidator.isNotAllowedSendTopic(requestHeader.getTopic(), response)) {
        return response;
    }

    TopicConfig topicConfig =
        this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());
    if (null == topicConfig) {
        int topicSysFlag = 0;
        if (requestHeader.isUnitMode()) {
            if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
                topicSysFlag = TopicSysFlag.buildSysFlag(false, true);
            } else {
                topicSysFlag = TopicSysFlag.buildSysFlag(true, false);
            }
        }

        LOGGER.warn(&quot;the topic {} not exist, producer: {}&quot;, requestHeader.getTopic(), ctx.channel().remoteAddress());
        //åœ¨ NameServerç«¯å­˜å‚¨ä¸»é¢˜çš„é…ç½®ä¿¡æ¯ï¼Œ
        topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageMethod(
            requestHeader.getTopic(),
            requestHeader.getDefaultTopic(),
            RemotingHelper.parseChannelRemoteAddr(ctx.channel()),
            requestHeader.getDefaultTopicQueueNums(), topicSysFlag);

        if (null == topicConfig) {
            if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
                topicConfig =
                    this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(
                        requestHeader.getTopic(), 1, PermName.PERM_WRITE | PermName.PERM_READ,
                        topicSysFlag);
            }
        }

        if (null == topicConfig) {
            response.setCode(ResponseCode.TOPIC_NOT_EXIST);
            response.setRemark(&quot;topic[&quot; + requestHeader.getTopic() + &quot;] not exist, apply first please!&quot;
                + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));
            return response;
        }
    }
    //4)æ£€æŸ¥é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—ä¸åˆæ³•ï¼Œè¿”å›é”™è¯¯ç  ã€‚
    int queueIdInt = requestHeader.getQueueId();
    int idValid = Math.max(topicConfig.getWriteQueueNums(), topicConfig.getReadQueueNums());
    if (queueIdInt &gt;= idValid) {
        String errorInfo = String.format(&quot;request queueId[%d] is illegal, %s Producer: %s&quot;,
            queueIdInt,
            topicConfig,
            RemotingHelper.parseChannelRemoteAddr(ctx.channel()));

        LOGGER.warn(errorInfo);
        response.setCode(ResponseCode.SYSTEM_ERROR);
        response.setRemark(errorInfo);

        return response;
    }
    return response;
}
</code></pre>
<blockquote>
<p>handleRetryAndDLQ</p>
</blockquote>
<pre><code class="language-java">private boolean handleRetryAndDLQ(SendMessageRequestHeader requestHeader, RemotingCommand response,
    RemotingCommand request,
    MessageExt msg, TopicConfig topicConfig, Map&lt;String, String&gt; properties) {
    String newTopic = requestHeader.getTopic();
    if (null != newTopic &amp;&amp; newTopic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
        String groupName = newTopic.substring(MixAll.RETRY_GROUP_TOPIC_PREFIX.length());
        SubscriptionGroupConfig subscriptionGroupConfig =
            this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(groupName);
        if (null == subscriptionGroupConfig) {
            response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);
            response.setRemark(
                &quot;subscription group not exist, &quot; + groupName + &quot; &quot; + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));
            return false;
        }

        int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();
        if (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal() &amp;&amp; requestHeader.getMaxReconsumeTimes() != null) {
            maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();
        }
        int reconsumeTimes = requestHeader.getReconsumeTimes() == null ? 0 : requestHeader.getReconsumeTimes();
        // Using '&gt;' instead of '&gt;=' to compatible with the case that reconsumeTimes here are increased by client.

        // Step2:å¦‚æœæ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡å…è®¸çš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ¶ˆæ¯å°†è¿›å…¥åˆ° DLD å»¶è¿Ÿé˜Ÿåˆ—ã€‚å»¶è¿Ÿé˜Ÿåˆ—ä¸»é¢˜: %DLQ%+æ¶ˆè´¹ç»„å
        if (reconsumeTimes &gt; maxReconsumeTimes) {
            properties.put(MessageConst.PROPERTY_DELAY_TIME_LEVEL, &quot;-1&quot;);
            newTopic = MixAll.getDLQTopic(groupName);
            int queueIdInt = randomQueueId(DLQ_NUMS_PER_GROUP);
            topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic,
                DLQ_NUMS_PER_GROUP,
                PermName.PERM_WRITE | PermName.PERM_READ, 0
            );
            msg.setTopic(newTopic);
            msg.setQueueId(queueIdInt);
            msg.setDelayTimeLevel(0);
            if (null == topicConfig) {
                response.setCode(ResponseCode.SYSTEM_ERROR);
                response.setRemark(&quot;topic[&quot; + newTopic + &quot;] not exist&quot;);
                return false;
            }
        }
    }
    int sysFlag = requestHeader.getSysFlag();
    if (TopicFilterType.MULTI_TAG == topicConfig.getTopicFilterType()) {
        sysFlag |= MessageSysFlag.MULTI_TAGS_FLAG;
    }
    msg.setSysFlag(sysFlag);
    return true;
}
</code></pre>
<h4 id="2å¼‚æ­¥å‘é€">2.å¼‚æ­¥å‘é€</h4>
<p>æ¶ˆæ¯å¼‚æ­¥å‘é€æ˜¯æŒ‡æ¶ˆæ¯ç”Ÿäº§è€…è°ƒç”¨å‘é€çš„ APIåï¼Œæ— é¡»é˜»å¡ç­‰å¾…æ¶ˆæ¯æœåŠ¡å™¨è¿”å›æœ¬æ¬¡æ¶ˆæ¯å‘é€ç»“æœï¼Œåªéœ€è¦æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä¾›æ¶ˆæ¯å‘é€å®¢æˆ·ç«¯åœ¨æ”¶åˆ°å“åº”ç»“æœå›è°ƒã€‚ å¼‚æ­¥æ–¹ å¼ç›¸æ¯”åŒæ­¥æ–¹å¼ï¼Œæ¶ˆæ¯å‘é€ç«¯çš„å‘é€æ€§èƒ½ä¼šæ˜¾è‘—æé«˜ï¼Œä½†ä¸ºäº†ä¿æŠ¤æ¶ˆæ¯æœåŠ¡å™¨çš„è´Ÿè½½å‹åŠ›ï¼Œ RocketMQ å¯¹æ¶ˆæ¯ å‘é€çš„å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œäº†äº•å‘æ§åˆ¶ï¼Œé€šè¿‡å‚æ•°clientAsyncSemaphoreValueæ¥æ§åˆ¶ï¼Œé»˜è®¤ä¸º65535ã€‚å¼‚æ­¥æ¶ˆæ¯å‘é€è™½ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ DefaultMQProducer#retryTimesÂ­WhenSendAsyncFailed å±æ€§æ¥æ§åˆ¶æ¶ˆæ¯é‡è¯•æ¬¡æ•°ï¼Œä½†æ˜¯é‡è¯•çš„è°ƒç”¨äºº å£æ˜¯åœ¨æ”¶åˆ°æœåŠ¡ç«¯å“åº”åŒ…æ—¶è¿›è¡Œçš„ï¼Œå¦‚æœå‡ºç°ç½‘ç»œå¼‚å¸¸ã€ç½‘ç»œè¶…æ—¶ç­‰å°†ä¸ä¼šé‡è¯•ã€‚</p>
<h4 id="3-å•å‘å‘é€">3. å•å‘å‘é€</h4>
<p>å•å‘å‘é€æ˜¯æŒ‡æ¶ˆæ¯ç”Ÿäº§è€…è°ƒç”¨æ¶ˆæ¯å‘é€çš„APIåï¼Œæ— é¡»ç­‰å¾…æ¶ˆæ¯æœåŠ¡å™¨è¿”å›æœ¬æ¬¡æ¶ˆæ¯å‘é€ç»“æœï¼Œå¹¶ä¸”æ— é¡»æä¾›å›è°ƒå‡½æ•°ï¼Œè¡¨ç¤ºæ¶ˆæ¯å‘é€å‹æ ¹å°±ä¸å…³å¿ƒæœ¬æ¬¡æ¶ˆæ¯å‘é€æ˜¯å¦æˆåŠŸï¼Œå…¶å®ç°åŸç†ä¸å¼‚æ­¥æ¶ˆæ¯å‘é€ç›¸åŒï¼Œåªæ˜¯æ¶ˆæ¯å‘é€å®¢æˆ·ç«¯åœ¨æ”¶åˆ°å“åº”ç»“æœåä»€ä¹ˆéƒ½ä¸åšè€Œå·²ï¼Œå¹¶ä¸”æ²¡æœ‰é‡è¯•æœºåˆ¶ã€‚</p>
<h2 id="35-æ‰¹é‡æ¶ˆæ¯å‘é€">3.5 æ‰¹é‡æ¶ˆæ¯å‘é€</h2>
<p>æ‰¹é‡æ¶ˆæ¯å‘é€æ˜¯å°†åŒä¸€ä¸»é¢˜çš„å¤šæ¡æ¶ˆæ¯ä¸€èµ·æ‰“åŒ…å‘é€åˆ°æ¶ˆæ¯æœåŠ¡ç«¯ï¼Œå‡å°‘ç½‘ç»œè°ƒç”¨æ¬¡æ•°ï¼Œæé«˜ç½‘ç»œä¼ è¾“æ•ˆç‡ ã€‚</p>
<p>å½“ç„¶ï¼Œå¹¶ä¸æ˜¯åœ¨åŒä¸€æ‰¹æ¬¡ä¸­å‘é€çš„æ¶ˆæ¯æ•°é‡è¶Šå¤šæ€§èƒ½å°±è¶Šå¥½ï¼Œå…¶åˆ¤æ–­ä¾æ®æ˜¯å•æ¡æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå•æ¡æ¶ˆæ¯å†…å®¹æ¯”è¾ƒé•¿ï¼Œåˆ™æ‰“åŒ…å¤šæ¡æ¶ˆæ¯å‘é€ä¼šå½±å“å…¶ä»–çº¿ç¨‹å‘é€æ¶ˆæ¯çš„å“åº”æ—¶é—´ï¼Œå¹¶ä¸”å•æ‰¹æ¬¡æ¶ˆæ¯å‘é€æ€»é•¿åº¦ä¸èƒ½è¶…è¿‡ DefaultMQProducer#maxMessageSizeã€‚</p>
<blockquote>
<p>RemotingCommand</p>
</blockquote>
<pre><code class="language-java">//è¯·æ±‚å‘½ä»¤ç¼–ç ï¼Œè¯·æ±‚å‘½ä»¤ç±»å‹
private int code;
private LanguageCode language = LanguageCode.JAVA;

//ç‰ˆæœ¬å·
private int version = 0;

//å®¢æˆ·ç«¯è¯·æ±‚åºå·
private int opaque = requestId.getAndIncrement();

//æ ‡è®°ã€‚å€’æ•°ç¬¬ä¸€ä½è¡¨ç¤ºè¯·æ±‚ç±»å‹ï¼ŒO:è¯·æ±‚; 1:è¿”å›ã€‚å€’æ•°ç¬¬äºŒä½ï¼Œ1:è¡¨ç¤ºoneway
private int flag = 0;

//æè¿°
private String remark;
//æ‰©å±•å±æ€§
private HashMap&lt;String, String&gt; extFields;
//æ¯ä¸ªè¯·æ±‚å¯¹åº” çš„è¯·æ±‚å¤´ä¿¡æ¯
private transient CommandCustomHeader customHeader;

private SerializeType serializeTypeCurrentRPC = serializeTypeConfigInThisServer;
//è¯·æ±‚ä½“
private transient byte[] body;
</code></pre>
<p>å•æ¡æ¶ˆæ¯å‘é€æ—¶ï¼Œæ¶ˆæ¯ä½“çš„å†…å®¹å°†ä¿å­˜åœ¨bodyä¸­ã€‚ æ‰¹é‡æ¶ˆæ¯å‘é€ ï¼Œéœ€è¦å°†å¤šæ¡æ¶ˆæ¯ä½“çš„å†…å®¹å­˜å‚¨åœ¨bodyä¸­ã€‚</p>
<p>RocketMQé‡‡å–çš„æ–¹å¼æ˜¯ï¼Œå¯¹å•æ¡æ¶ˆæ¯å†…å®¹ä½¿ç”¨å›ºå®šæ ¼å¼è¿›è¡Œå­˜å‚¨ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1663150413082.png" alt="æ¶ˆæ¯å°è£…æ ¼å¼" loading="lazy"></figure>
<blockquote>
<p>DefaultMQProducer#send æ¶ˆæ¯æ‰¹é‡å‘è¿­</p>
</blockquote>
<pre><code class="language-java">@Override
public SendResult send(
    Collection&lt;Message&gt; msgs) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    return this.defaultMQProducerImpl.send(batch(msgs));
}
</code></pre>
<p>é¦–å…ˆåœ¨æ¶ˆæ¯å‘é€ç«¯ï¼Œè°ƒç”¨batchæ–¹æ³•ï¼Œå°†ä¸€æ‰¹æ¶ˆæ¯å°è£…æˆMessageBatchå¯¹è±¡ã€‚MessageÂ­Batchç»§æ‰¿è‡ªMessageå¯¹è±¡ï¼ŒMessageBatchå†…éƒ¨æŒæœ‰List<Message> messagesã€‚è¿™æ ·çš„è¯ï¼Œæ‰¹é‡æ¶ˆæ¯å‘é€ä¸å•æ¡æ¶ˆæ¯å‘é€çš„å¤„ç†æµç¨‹å®Œå…¨ä¸€æ ·ã€‚MessageBatchåªéœ€è¦å°†è¯¥é›†åˆä¸­çš„æ¯æ¡æ¶ˆæ¯çš„æ¶ˆæ¯ä½“ bodyèšåˆæˆä¸€ä¸ª byteæ•°ç»„ï¼Œåœ¨æ¶ˆæ¯æœåŠ¡ç«¯èƒ½å¤Ÿä»è¯¥ byte[] æ•°å€¼ä¸­æ­£ç¡®è§£æå‡ºæ¶ˆæ¯å³å¯ã€‚</p>
<p>åœ¨åˆ›å»ºRemotingCommandå¯¹è±¡æ—¶å°†è°ƒç”¨messageBatch#encode()æ–¹æ³•å¡«å……åˆ°Remoting-Commandçš„bodyåŸŸä¸­ã€‚</p>
<pre><code class="language-java">public static byte[] encodeMessages(List&lt;Message&gt; messages) {
    //TO DO refactor, accumulate in one buffer, avoid copies
    List&lt;byte[]&gt; encodedMessages = new ArrayList&lt;byte[]&gt;(messages.size());
    int allSize = 0;
    for (Message message : messages) {
        byte[] tmp = encodeMessage(message);
        encodedMessages.add(tmp);
        allSize += tmp.length;
    }
    byte[] allBytes = new byte[allSize];
    int pos = 0;
    for (byte[] bytes : encodedMessages) {
        System.arraycopy(bytes, 0, allBytes, pos, bytes.length);
        pos += bytes.length;
    }
    return allBytes;
}

public static byte[] encodeMessage(Message message) {
    //only need flag, body, properties
    byte[] body = message.getBody();
    int bodyLen = body.length;
    String properties = messageProperties2String(message.getProperties());
    byte[] propertiesBytes = properties.getBytes(CHARSET_UTF8);
    //note properties length must not more than Short.MAX
    short propertiesLength = (short) propertiesBytes.length;
    int sysFlag = message.getFlag();
    int storeSize = 4 // 1 TOTALSIZE
        + 4 // 2 MAGICCOD
        + 4 // 3 BODYCRC
        + 4 // 4 FLAG
        + 4 + bodyLen // 4 BODY
        + 2 + propertiesLength;
    ByteBuffer byteBuffer = ByteBuffer.allocate(storeSize);
    // 1 TOTALSIZE
    byteBuffer.putInt(storeSize);

    // 2 MAGICCODE
    byteBuffer.putInt(0);

    // 3 BODYCRC
    byteBuffer.putInt(0);

    // 4 FLAG
    int flag = message.getFlag();
    byteBuffer.putInt(flag);

    // 5 BODY
    byteBuffer.putInt(bodyLen);
    byteBuffer.put(body);

    // 6 properties
    byteBuffer.putShort(propertiesLength);
    byteBuffer.put(propertiesBytes);

    return byteBuffer.array();
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[RocketMqæŠ€æœ¯å†…å¹•ç¬”è®°ï¼ˆä¸€ï¼‰]]></title>
        <id>https://q456qq520.github.io/post/rocketmq-ji-zhu-nei-mu-bi-ji-yi/</id>
        <link href="https://q456qq520.github.io/post/rocketmq-ji-zhu-nei-mu-bi-ji-yi/">
        </link>
        <updated>2022-09-07T09:47:04.000Z</updated>
        <summary type="html"><![CDATA[<h1 id="1-å¤§çº²">1 å¤§çº²</h1>
<h2 id="11-rocketmq-åŸä»£ç çš„ç›®å½•ç»“æ„">1.1 RocketMQ åŸä»£ç çš„ç›®å½•ç»“æ„</h2>
<p>RocketMQ æ ¸å¿ƒç›® å½•è¯´æ˜å¦‚ä¸‹ ã€‚</p>
<ol>
<li>broker: brokeræ¨¡å—(brokerå¯åŠ¨è¿›ç¨‹) ã€‚</li>
</ol>
]]></summary>
        <content type="html"><![CDATA[<h1 id="1-å¤§çº²">1 å¤§çº²</h1>
<h2 id="11-rocketmq-åŸä»£ç çš„ç›®å½•ç»“æ„">1.1 RocketMQ åŸä»£ç çš„ç›®å½•ç»“æ„</h2>
<p>RocketMQ æ ¸å¿ƒç›® å½•è¯´æ˜å¦‚ä¸‹ ã€‚</p>
<ol>
<li>broker: brokeræ¨¡å—(brokerå¯åŠ¨è¿›ç¨‹) ã€‚</li>
</ol>
<!-- more --> 
<ol start="3">
<li>client:æ¶ˆæ¯å®¢æˆ·ç«¯ï¼ŒåŒ…å«æ¶ˆæ¯ç”Ÿäº§è€…ã€æ¶ˆæ¯æ¶ˆè´¹è€…ç›¸å…³ç±»ã€‚</li>
<li>common:å…¬å…±åŒ…ã€‚</li>
<li>dev:å¼€å‘è€…ä¿¡æ¯(éæºä»£ç )ã€‚</li>
<li>distribution:éƒ¨ç½²å®ä¾‹æ–‡ä»¶å¤¹(éæºä»£ç )ã€‚</li>
<li>example: RocketMQ ç¤ºä¾‹ä»£ç  ã€‚</li>
<li>filter:æ¶ˆæ¯è¿‡æ»¤ç›¸å…³åŸºç¡€ç±»ã€‚</li>
<li>filtersrv: æ¶ˆæ¯è¿‡æ»¤æœåŠ¡å™¨å®ç°ç›¸å…³ç±»(Filterå¯åŠ¨è¿›ç¨‹)ã€‚</li>
<li>logappender:æ—¥å¿—å®ç°ç›¸å…³ç±»ã€‚</li>
<li>namesrv : NameServer å®ç°ç›¸å…³ç±»(Nameså·³rverå¯åŠ¨è¿›ç¨‹) ã€‚</li>
<li>openmessaging: æ¶ˆæ¯å¼€æ”¾æ ‡å‡†ï¼Œæ­£åœ¨åˆ¶å®šä¸­ ã€‚</li>
<li>remoting: è¿œç¨‹é€šä¿¡æ¨¡å—ï¼ŒåŸºäº Nettyã€‚</li>
<li>srvutil:æœåŠ¡å™¨å·¥å…·ç±»ã€‚</li>
<li>store:æ¶ˆæ¯å­˜å‚¨å®ç°ç›¸å…³ç±» ã€‚</li>
<li>style: checkstyleç›¸å…³å®ç°ã€‚</li>
<li>test: æµ‹è¯•ç›¸å…³ç±»ã€‚</li>
<li>tools: å·¥å…·ç±»ï¼Œç›‘æ§å‘½ä»¤ç›¸å…³å®ç°ç±»ã€‚</li>
</ol>
<h2 id="12-rocketmq-çš„è®¾è®¡ç†å¿µå’Œç›®æ ‡">1.2 RocketMQ çš„è®¾è®¡ç†å¿µå’Œç›®æ ‡</h2>
<h3 id="121-è®¾è®¡ç†å¿µ">1.2.1 è®¾è®¡ç†å¿µ</h3>
<p>RocketMQ è®¾è®¡åŸºäºä¸»é¢˜çš„å‘å¸ƒä¸ è®¢é˜… æ¨¡å¼ ï¼Œ (Broker)ã€æ¶ˆæ¯æ¶ˆè´¹ã€‚</p>
<p>NameServerï¼šå®ç°å…ƒæ•°æ®çš„ç®¡ç†(Topicè·¯ç”±ä¿¡æ¯ç­‰)ï¼Œå› ä¸º Topic è·¯ç”±ä¿¡æ¯æ— é¡»åœ¨é›†ç¾¤ä¹‹ é—´ä¿æŒå¼ºä¸€è‡´ï¼Œè¿½æ±‚æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¹¶ä¸”èƒ½å®¹ å¿åˆ†é’Ÿçº§çš„ ä¸ä¸€è‡´ ã€‚</p>
<p>é«˜æ•ˆçš„IOå­˜å‚¨æœºåˆ¶ï¼šRocketMQè¿½æ±‚æ¶ˆæ¯å‘é€çš„é«˜ååé‡ï¼Œ RocketMQ çš„æ¶ˆæ¯å­˜å‚¨æ–‡ä»¶è®¾è®¡æˆæ–‡ä»¶ç»„çš„æ¦‚å¿µï¼Œç»„å†…å•ä¸ªæ–‡ä»¶å¤§å°å›ºå®šï¼Œæ–¹ä¾¿å¼•äººå†…å­˜ læ˜ å°„æœºåˆ¶ï¼Œæ‰€ æœ‰ä¸» é¢˜çš„æ¶ˆæ¯å­˜å‚¨åŸºäºé¡ºåºå†™ï¼Œæå¤§åœ°æé«˜äº†æ¶ˆæ¯å†™æ€§èƒ½ï¼Œ åŒæ—¶ä¸ºäº†å…¼é¡¾æ¶ˆæ¯æ¶ˆè´¹ä¸æ¶ˆæ¯æŸ¥æ‰¾ï¼Œå¼•å…¥äº†æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸ç´¢å¼•æ–‡ä»¶ã€‚</p>
<h3 id="122-è®¾è®¡èƒ½åŠ›">1.2.2 è®¾è®¡èƒ½åŠ›</h3>
<ol>
<li>
<p>æ¶æ„æ¨¡å¼<br>
RocketMQ ä¸å¤§éƒ¨åˆ†æ¶ˆæ¯ä¸­é—´ä»¶ä¸€æ ·ï¼Œé‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼ŒåŸºæœ¬çš„å‚ä¸ç»„ä»¶ä¸»è¦åŒ…æ‹¬ :<br>
æ¶ˆæ¯å‘é€è€…ã€æ¶ˆæ¯æœåŠ¡å™¨(æ¶ˆæ¯å­˜å‚¨)ã€æ¶ˆæ¯æ¶ˆè´¹ã€è·¯ç”±å‘ç° ã€‚</p>
</li>
<li>
<p>é¡ºåºæ¶ˆæ¯<br>
æ‰€è°“é¡ºåºæ¶ˆæ¯ï¼Œå°±æ˜¯æ¶ˆæ¯æ¶ˆè´¹è€…æŒ‰ç…§æ¶ˆæ¯è¾¾åˆ°æ¶ˆæ¯å­˜å‚¨æœåŠ¡å™¨çš„é¡ºåºæ¶ˆè´¹ ã€‚ RocketMQ å¯ä»¥ä¸¥æ ¼ä¿è¯æ¶ˆæ¯æœ‰åº ã€‚</p>
</li>
<li>
<p>æ¶ˆæ¯è¿‡æ»¤<br>
RocketMQ æ¶ˆæ¯è¿‡æ»¤æ”¯æŒåœ¨æœåŠ¡ç«¯ä¸æ¶ˆè´¹ç«¯çš„æ¶ˆæ¯è¿‡æ»¤æœºåˆ¶ ã€‚<br>
1 )æ¶ˆæ¯åœ¨ Broker ç«¯è¿‡æ»¤ã€‚Brokeråªå°†æ¶ˆæ¯æ¶ˆè´¹è€…æ„Ÿå…´è¶£çš„æ¶ˆæ¯å‘é€ç»™æ¶ˆæ¯æ¶ˆè´¹è€… ã€‚<br>
2 )æ¶ˆæ¯åœ¨æ¶ˆæ¯æ¶ˆè´¹ç«¯è¿‡æ»¤ï¼Œæ¶ˆæ¯è¿‡æ»¤æ–¹å¼å®Œå…¨ç”±æ¶ˆæ¯æ¶ˆè´¹è€…è‡ªå®šä¹‰ï¼Œä½†ç¼ºç‚¹æ˜¯æœ‰å¾ˆå¤šæ— ç”¨çš„æ¶ˆæ¯ä¼šä» Brokerä¼ è¾“åˆ°æ¶ˆè´¹ç«¯ã€‚</p>
</li>
<li>
<p>æ¶ˆæ¯å­˜å‚¨<br>
RocketMQ è¿½æ±‚æ¶ˆæ¯å­˜å‚¨çš„é«˜æ€§èƒ½ï¼Œå¼•äººå†…å­˜æ˜ å°„æœºåˆ¶ï¼Œæ‰€æœ‰ä¸»é¢˜çš„æ¶ˆæ¯é¡ºåºå­˜å‚¨åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ ã€‚ åŒæ—¶ä¸ºäº†é¿å…æ¶ˆæ¯æ— é™åœ¨æ¶ˆæ¯å­˜å‚¨æœåŠ¡å™¨ä¸­ç´¯ç§¯ï¼Œå¼•å…¥äº†æ¶ˆæ¯æ–‡ä»¶è¿‡æœŸæœºåˆ¶ä¸æ–‡ä»¶å­˜å‚¨ç©ºé—´æŠ¥è­¦æœºåˆ¶ã€‚</p>
</li>
<li>
<p>æ¶ˆæ¯é«˜å¯ç”¨æ€§<br>
é€šå¸¸å½±å“æ¶ˆæ¯å¯é æ€§çš„æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µ ã€‚</p>
</li>
</ol>
<ol>
<li>Brokeræ­£å¸¸å…³æœºã€‚</li>
<li>Brokerå¼‚å¸¸ Crashã€‚</li>
<li>OS Crashã€‚</li>
<li>æœºå™¨æ–­ç”µï¼Œä½† æ˜¯ èƒ½ç«‹å³æ¢å¤ä¾›ç”µæƒ…å†µ ã€‚</li>
<li>æœºå™¨æ— æ³•å¼€æœº(å¯èƒ½æ˜¯ CPUã€ä¸»æ¿ã€ å†…å­˜ç­‰å…³é”®è®¾å¤‡æŸ å)ã€‚</li>
<li>ç£ç›˜è®¾å¤‡æŸåã€‚<br>
æƒ…å†µ 1~4 çš„ RocketMQ åœ¨åŒæ­¥åˆ·ç›˜æœºåˆ¶ä¸‹å¯ä»¥ç¡®ä¿ä¸ä¸¢å¤±æ¶ˆæ¯ï¼Œåœ¨å¼‚æ­¥åˆ·ç›˜æ¨¡å¼ä¸‹ï¼Œä¼šä¸¢å¤±å°‘é‡æ¶ˆæ¯ ã€‚ æƒ…å†µ 5-6 å±äºå•ç‚¹æ•…éšœï¼Œä¸€æ—¦å‘ç”Ÿï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„æ¶ˆæ¯å…¨ éƒ¨ä¸¢å¤±ï¼Œå¦‚æœå¼€å¯äº†å¼‚æ­¥å¤åˆ¶æœºåˆ¶ï¼Œ RoketMQ èƒ½ä¿è¯åªä¸¢å¤±å°‘é‡æ¶ˆæ¯ã€‚</li>
</ol>
<ol start="6">
<li>
<p>æ¶ˆæ¯åˆ°è¾¾ (æ¶ˆè´¹)ä½å»¶è¿Ÿ<br>
RocketMQåœ¨æ¶ˆæ¯ä¸å‘ç”Ÿæ¶ˆæ¯å †ç§¯æ—¶ï¼Œä»¥é•¿è½®è¯¢æ¨¡å¼å®ç°å‡†å®æ—¶çš„æ¶ˆæ¯æ¨é€æ¨¡å¼ã€‚</p>
</li>
<li>
<p>ç¡®ä¿æ¶ˆæ¯å¿…é¡»è¢«æ¶ˆè´¹ä¸€æ¬¡<br>
RocketMQ é€šè¿‡æ¶ˆæ¯æ¶ˆè´¹ç¡®è®¤æœºåˆ¶(ACK)æ¥ç¡®ä¿æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œä½†ç”±äºACKæ¶ˆæ¯æœ‰å¯èƒ½ä¸¢å¤±ç­‰å…¶ä»–åŸå› ï¼ŒRocketMQæ— æ³•åšåˆ°æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œæœ‰é‡å¤æ¶ˆè´¹çš„å¯èƒ½ã€‚</p>
</li>
<li>
<p>å›æº¯æ¶ˆæ¯<br>
å›æº¯æ¶ˆæ¯æ˜¯æŒ‡æ¶ˆæ¯æ¶ˆè´¹ç«¯å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œç”±äºä¸šåŠ¡è¦æ±‚éœ€è¦é‡æ–°æ¶ˆè´¹æ¶ˆæ¯ã€‚ RocketMQ æ”¯æŒæŒ‰æ—¶é—´å›æº¯æ¶ˆæ¯ï¼Œæ—¶é—´ç»´åº¦å¯ç²¾ç¡®åˆ°æ¯«ç§’ï¼Œå¯ä»¥å‘å‰æˆ–å‘åå›æº¯ã€‚</p>
</li>
<li>
<p>æ¶ˆæ¯å †ç§¯<br>
RocketMQ æ¶ˆæ¯å­˜å‚¨ä½¿ç”¨ç£ç›˜æ–‡ä»¶ (å†…å­˜æ˜ å°„æœºåˆ¶)ï¼Œå¹¶ä¸”åœ¨ç‰©ç†å¸ƒå±€ä¸Šä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„æ–‡ä»¶ç»„æˆé€»è¾‘æ–‡ä»¶ç»„ï¼Œå¯ä»¥æ— é™å¾ªç¯ä½¿ç”¨ã€‚ RocketMQæ¶ˆæ¯å­˜å‚¨æ–‡ä»¶å¹¶ä¸æ˜¯æ°¸ä¹…å­˜å‚¨åœ¨æ¶ˆæ¯æœåŠ¡å™¨ç«¯ï¼Œè€Œæ˜¯æä¾›äº†è¿‡æœŸæœºåˆ¶ï¼Œé»˜è®¤ä¿ç•™3å¤©ã€‚</p>
</li>
<li>
<p>å®šæ—¶æ¶ˆæ¯<br>
å®š æ—¶æ¶ˆæ¯ æ˜¯æŒ‡æ¶ˆæ¯å‘é€åˆ° Broker åï¼Œ ä¸èƒ½è¢«æ¶ˆæ¯æ¶ˆè´¹ç«¯ç«‹å³æ¶ˆè´¹ï¼Œè¦åˆ°ç‰¹å®šçš„æ—¶é—´ç‚¹æˆ–è€…ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚ å¦‚æœè¦æ”¯æŒä»»æ„ç²¾åº¦çš„å®šæ—¶æ¶ˆæ¯æ¶ˆè´¹ï¼Œå¿…é¡»åœ¨æ¶ˆæ¯æœåŠ¡ç«¯å¯¹æ¶ˆæ¯è¿›è¡Œæ’åºï¼ŒåŠ¿å¿…å¸¦æ¥å¾ˆå¤§çš„æ€§èƒ½æŸè€—ï¼Œæ•…RocketMQä¸æ”¯æŒä»»æ„ç²¾åº¦çš„å®šæ—¶æ¶ˆæ¯ï¼Œè€Œåªæ”¯æŒç‰¹å®šå»¶è¿Ÿçº§åˆ«ã€‚</p>
</li>
<li>
<p>æ¶ˆæ¯é‡è¯•æœºåˆ¶<br>
æ¶ˆæ¯é‡è¯•æ˜¯æŒ‡æ¶ˆæ¯åœ¨æ¶ˆè´¹æ—¶ï¼Œå¦‚æœå‘é€å¼‚å¸¸ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶éœ€è¦æ”¯æŒæ¶ˆæ¯é‡æ–°æŠ•é€’ï¼ŒRocketMQæ”¯æŒæ¶ˆæ¯é‡è¯•æœºåˆ¶ã€‚</p>
</li>
</ol>
<h1 id="2-rocketmqè·¯ç”±ä¸­å¿ƒnameserver">2 RocketMQè·¯ç”±ä¸­å¿ƒNameServer</h1>
<h2 id="21-nameserver-æ¶æ„è®¾è®¡">2.1 NameServer æ¶æ„è®¾è®¡</h2>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1663034308783.png" alt="RocketMQ ç‰©ç†éƒ¨ç½²å›¾" loading="lazy"></figure>
<p>Brokeræ¶ˆæ¯æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶å‘æ‰€æœ‰ NameServeræ³¨å†Œï¼Œæ¶ˆæ¯ç”Ÿäº§è€…(Producer)åœ¨å‘é€æ¶ˆ æ¯ä¹‹å‰å…ˆä» NameServerè·å–Broker æœåŠ¡å™¨åœ°å€åˆ—è¡¨ï¼Œç„¶åæ ¹æ®è´Ÿè½½ç®—æ³•ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ å°æ¶ˆæ¯æœåŠ¡å™¨è¿›è¡Œæ¶ˆæ¯å‘é€ã€‚NameServerä¸æ¯å° Broker æœåŠ¡å™¨ä¿æŒé•¿è¿æ¥ï¼Œå¹¶é—´éš”30sæ£€æµ‹Brokeræ˜¯å¦å­˜æ´»ï¼Œå¦‚æœæ£€æµ‹åˆ° Brokerå³æœºï¼Œåˆ™ä»è·¯ç”±æ³¨å†Œè¡¨ä¸­å°†å…¶ç§»é™¤ã€‚ä½†æ˜¯è·¯ç”±å˜åŒ–ä¸ä¼šé©¬ä¸Šé€šçŸ¥æ¶ˆæ¯ç”Ÿäº§è€…ã€‚</p>
<p>NameServeræœ¬èº«çš„é«˜å¯ç”¨å¯é€šè¿‡éƒ¨ ç½²å¤šå° NameServeræœåŠ¡å™¨æ¥å®ç°ï¼Œä½†å½¼æ­¤ä¹‹é—´äº’ä¸é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯ NameServeræœåŠ¡å™¨ä¹‹é—´åœ¨æŸä¸€æ—¶åˆ»çš„æ•°æ®å¹¶ä¸ä¼šå®Œå…¨ç›¸åŒï¼Œä½†è¿™å¯¹æ¶ˆ æ¯å‘é€ä¸ä¼šé€ æˆä»»ä½•å½±å“ã€‚</p>
<h2 id="22-nameserver-å¯åŠ¨æµç¨‹">2.2 NameServer å¯åŠ¨æµç¨‹</h2>
<p>NameServerå¯åŠ¨ç±» : org.apache.rocketmq.namesrv.NamesrvStartupã€‚</p>
<ol>
<li>Step 1: é¦–å…ˆæ¥è§£æé…ç½®æ–‡ä»¶ï¼Œéœ€è¦å¡«å…… NameServerConfigã€NettyServerConfigå±æ€§å€¼ã€‚</li>
</ol>
<pre><code class="language-java">  public static void parseCommandlineAndConfigFile(String[] args) throws Exception {
        System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));
        //PackageConflictDetect.detectFastjson();

        Options options = ServerUtil.buildCommandlineOptions(new Options());
        CommandLine commandLine = ServerUtil.parseCmdLine(&quot;mqnamesrv&quot;, args, buildCommandlineOptions(options), new PosixParser());
        if (null == commandLine) {
            System.exit(-1);
            return;
        }

        namesrvConfig = new NamesrvConfig();
        nettyServerConfig = new NettyServerConfig();
        nettyClientConfig = new NettyClientConfig();
        nettyServerConfig.setListenPort(9876);
        controllerConfig = new ControllerConfig();
        if (commandLine.hasOption('c')) {
            String file = commandLine.getOptionValue('c');
            if (file != null) {
                InputStream in = new BufferedInputStream(Files.newInputStream(Paths.get(file)));
                properties = new Properties();
                properties.load(in);
                MixAll.properties2Object(properties, namesrvConfig);
                MixAll.properties2Object(properties, nettyServerConfig);
                MixAll.properties2Object(properties, nettyClientConfig);
                MixAll.properties2Object(properties, controllerConfig);

                namesrvConfig.setConfigStorePath(file);

                System.out.printf(&quot;load config properties file OK, %s%n&quot;, file);
                in.close();
            }
        }

        if (commandLine.hasOption('p')) {
            MixAll.printObjectProperties(null, namesrvConfig);
            MixAll.printObjectProperties(null, nettyServerConfig);
            MixAll.printObjectProperties(null, nettyClientConfig);
            MixAll.printObjectProperties(null, controllerConfig);
            System.exit(0);
        }

        MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), namesrvConfig);

        if (null == namesrvConfig.getRocketmqHome()) {
            System.out.printf(&quot;Please set the %s variable in your environment to match the location of the RocketMQ installation%n&quot;, MixAll.ROCKETMQ_HOME_ENV);
            System.exit(-2);
        }

        LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();
        JoranConfigurator configurator = new JoranConfigurator();
        configurator.setContext(lc);
        lc.reset();
        configurator.doConfigure(namesrvConfig.getRocketmqHome() + &quot;/conf/logback_namesrv.xml&quot;);

        log = InternalLoggerFactory.getLogger(LoggerName.NAMESRV_LOGGER_NAME);

        MixAll.printObjectProperties(log, namesrvConfig);
        MixAll.printObjectProperties(log, nettyServerConfig);
    }
</code></pre>
<p>åˆ›å»º NameServerConfig ( NameServerä¸šåŠ¡å‚æ•°)ã€NettyServer-Config ( NameServerç½‘ç»œå‚æ•°)ï¼Œç„¶ååœ¨è§£æå¯åŠ¨æ—¶æŠŠæŒ‡å®šçš„é…ç½®æ–‡ä»¶æˆ–å¯åŠ¨å‘½ä»¤ä¸­çš„é€‰é¡¹ å€¼ï¼Œå¡«å……åˆ° nameServerConfig,nettyServerConfigå¯¹è±¡ã€‚</p>
<pre><code class="language-java">public class NamesrvConfig {
    //rocketmq ä¸»ç›®å½•ï¼Œå¯ä»¥é€šè¿‡ -Drocketmq.home.dir=pathæˆ–é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ ROCKETMQ_HOME æ¥é…ç½® RocketMQ çš„ä¸»ç›®å½• ã€‚
    private String rocketmqHome = System.getProperty(MixAll.ROCKETMQ_HOME_PROPERTY, System.getenv(MixAll.ROCKETMQ_HOME_ENV));

    //NameServerå­˜å‚¨ KV é…ç½®å±æ€§ çš„æŒä¹…åŒ–è·¯å¾„ 
    private String kvConfigPath = System.getProperty(&quot;user.home&quot;) + File.separator + &quot;namesrv&quot; + File.separator + &quot;kvConfig.json&quot;;

    //NameServer é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„
    private String configStorePath = System.getProperty(&quot;user.home&quot;) + File.separator + &quot;namesrv&quot; + File.separator + &quot;namesrv.properties&quot;;
    private String productEnvName = &quot;center&quot;;
    private boolean clusterTest = false;

    //æ˜¯å¦æ”¯æŒé¡ºåºæ¶ˆæ¯ï¼Œé»˜è®¤æ˜¯ä¸æ”¯æŒ
    private boolean orderMessageEnable = false;
    private boolean returnOrderTopicConfigToBroker = true;
}
</code></pre>
<pre><code class="language-java">public class NettyServerConfig implements Cloneable {

    //NameServerç›‘æ˜•ç«¯å£ï¼Œè¯¥å€¼é»˜è®¤ä¼šè¢«åˆå§‹åŒ–ä¸º 9876
    private int listenPort = 0;

    //Nettyä¸šåŠ¡çº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°ã€‚
    private int serverWorkerThreads = 8;

    //Netty publicä»»åŠ¡çº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°ï¼ŒNettyç½‘ç»œè®¾è®¡ï¼Œ
    //æ ¹æ®ä¸šåŠ¡ç±»å‹ä¼šåˆ›å»ºä¸åŒçš„çº¿ç¨‹æ± ï¼Œæ¯”å¦‚å¤„ç†æ¶ˆæ¯å‘é€ã€æ¶ˆæ¯æ¶ˆè´¹ã€å¿ƒè·³æ£€æµ‹ç­‰ ã€‚
    //å¦‚æœè¯¥ä¸šåŠ¡ç±»å‹(RequestCode)æœªæ³¨å†Œçº¿ç¨‹æ± ï¼Œ åˆ™ç”± publicçº¿ç¨‹æ± æ‰§è¡Œã€‚
    private int serverCallbackExecutorThreads = 0;

    //IOçº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°ï¼Œä¸»è¦æ˜¯ NameServerã€Brokerç«¯è§£æè¯·æ±‚ã€è¿”å›ç›¸åº”çš„çº¿ç¨‹ä¸ªæ•°ï¼Œè¿™ç±»çº¿ç¨‹ä¸»è¦æ˜¯å¤„ç†ç½‘ç»œè¯·æ±‚çš„è§£æè¯·æ±‚åŒ…ï¼Œç„¶åè½¬å‘åˆ°
    //å„ä¸ªä¸šåŠ¡çº¿ç¨‹æ± å®Œæˆå…·ä½“çš„ä¸šåŠ¡æ“ä½œï¼Œç„¶åå°†ç»“æœå†è¿”å›è°ƒç”¨æ–¹ ã€‚
    private int serverSelectorThreads = 3;

    //send oneway æ¶ˆæ¯è¯·æ±‚äº•å‘åº¦
    private int serverOnewaySemaphoreValue = 256;

    //å¼‚æ­¥æ¶ˆæ¯å‘é€æœ€å¤§å¹¶å‘åº¦
    private int serverAsyncSemaphoreValue = 64;

    //ç½‘ç»œè¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œé»˜è®¤120sã€‚ å¦‚æœè¿æ¥ç©ºé—²æ—¶é—´è¶…è¿‡è¯¥å‚æ•°è®¾ç½®çš„å€¼ï¼Œè¿æ¥å°†è¢«å…³é—­ã€‚
    private int serverChannelMaxIdleTimeSeconds = 120;

    //ç½‘ç»œ socketå‘é€ç¼“å­˜åŒºå¤§å°ï¼Œ é»˜è®¤ 64k
    private int serverSocketSndBufSize = NettySystemConfig.socketSndbufSize;
    //ç½‘ç»œ socketæ¥æ”¶ç¼“å­˜åŒºå¤§å° ï¼Œé»˜è®¤ 64k
    private int serverSocketRcvBufSize = NettySystemConfig.socketRcvbufSize;
    private int writeBufferHighWaterMark = NettySystemConfig.writeBufferHighWaterMark;
    private int writeBufferLowWaterMark = NettySystemConfig.writeBufferLowWaterMark;
    private int serverSocketBacklog = NettySystemConfig.socketBacklog;
    //ByteBufferæ˜¯å¦å¼€å¯ç¼“å­˜ ï¼Œ å»ºè®®å¼€å¯
    private boolean serverPooledByteBufAllocatorEnable = true;

    /**
     * make install
     * ../glibc-2.10.1/configure \ --prefix=/usr \ --with-headers=/usr/include \
     * --host=x86_64-linux-gnu \ --build=x86_64-pc-linux-gnu \ --without-gd
     */
    //æ˜¯å¦å¯ç”¨EpollIOæ¨¡å‹ï¼Œ Linuxç¯å¢ƒå»ºè®®å¼€å¯ã€‚
    private boolean useEpollNativeSelector = false;
}
</code></pre>
<blockquote>
<p>ï¸å¯åŠ¨ NameServeræ—¶ï¼Œå¯ä»¥å…ˆä½¿ç”¨/mqnameserver-c configFile -p æ‰“å°å½“å‰åŠ è½½çš„é…ç½®å±æ€§</p>
</blockquote>
<ol start="2">
<li>Step2:æ ¹æ®å¯åŠ¨å±æ€§åˆ›å»º NamesrvControllerå®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–è¯¥å®ä¾‹ï¼Œå®ä¾‹ä¸ºNameServeræ ¸å¿ƒæ§åˆ¶å™¨ã€‚</li>
</ol>
<pre><code class="language-java">  public boolean initialize() {
        //åŠ è½½kvConfigPathä¸‹kvConfig.jsoné…ç½®æ–‡ä»¶é‡Œçš„KVé…ç½®ï¼Œç„¶åå°†è¿™äº›é…ç½®æ”¾åˆ°KVConfigManager#configTableå±æ€§ä¸­
        loadConfig();
        //æ ¹æ®nettyServerConfigåˆå§‹åŒ–ä¸€ä¸ªnettyæœåŠ¡å™¨ã€‚
        initiateNetworkComponents();
        //åˆå§‹åŒ–è´Ÿè´£å¤„ç†Nettyç½‘ç»œäº¤äº’æ•°æ®çš„çº¿ç¨‹æ± ï¼Œé»˜è®¤çº¿ç¨‹æ•°æ˜¯16ä¸ª
        initiateThreadExecutors();
        ////æ³¨å†ŒNettyæœåŠ¡ç«¯ä¸šåŠ¡å¤„ç†é€»è¾‘ï¼Œå¦‚æœå¼€å¯äº†clusterTestï¼Œé‚£ä¹ˆæ³¨å†Œçš„è¯·æ±‚å¤„ç†ç±»æ˜¯ClusterTestRequestProcessorï¼Œå¦åˆ™è¯·æ±‚å¤„ç†ç±»æ˜¯DefaultRequestProcessor
        registerProcessor();
        //æ³¨å†Œå¿ƒè·³æœºåˆ¶çº¿ç¨‹æ± ï¼Œå»¶è¿Ÿ5æ¯«ç§’å¯åŠ¨ï¼Œæ¯éš”5ç§’éå†RouteInfoManager#brokerLiveTableè¿™ä¸ªå±æ€§ï¼Œç”¨æ¥æ‰«æä¸å­˜æ´»çš„broker
        //æ³¨å†Œæ‰“å°KVé…ç½®çº¿ç¨‹æ± ï¼Œå»¶è¿Ÿ1åˆ†é’Ÿå¯åŠ¨ã€æ¯10åˆ†é’Ÿæ‰“å°å‡ºkvConfigé…ç½®
        startScheduleService();
        initiateSslContext();
        initiateRpcHooks();
        return true;
    }
</code></pre>
<ol start="3">
<li>Step3 :æ³¨å†ŒJVMé’©å­å‡½æ•°å¹¶å¯åŠ¨æœåŠ¡å™¨ï¼Œä»¥ä¾¿ç›‘æ˜• Brokerã€æ¶ˆæ¯ç”Ÿäº§è€…çš„ç½‘ç»œè¯·æ±‚ ã€‚</li>
</ol>
<pre><code class="language-java">//åœ¨ JVM è¿›ç¨‹å…³é—­ä¹‹å‰ï¼Œå…ˆå°†çº¿ç¨‹æ± å…³é—­ï¼ŒåŠæ—¶é‡Šæ”¾èµ„æº ã€‚
        Runtime.getRuntime().addShutdownHook(new ShutdownHookThread(log, (Callable&lt;Void&gt;) () -&gt; {
            controller.shutdown();
            return null;
        }));

        controller.start();
</code></pre>
<h2 id="23-nameserver-è·¯ç”±æ³¨å†Œ-æ•…éšœå‰”é™¤">2.3 NameServer è·¯ç”±æ³¨å†Œã€æ•…éšœå‰”é™¤</h2>
<p>NameServerä¸»è¦ä½œç”¨æ˜¯ä¸ºæ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…æä¾›å…³äºä¸»é¢˜Topicçš„è·¯ç”±ä¿¡æ¯ï¼Œé‚£ä¹ˆNameServeréœ€è¦å­˜å‚¨è·¯ç”±çš„åŸºç¡€ä¿¡æ¯ï¼Œè¿˜è¦èƒ½å¤Ÿç®¡ç†BrokerèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬è·¯ç”±æ³¨å†Œã€ è·¯ç”±åˆ é™¤ç­‰åŠŸèƒ½ã€‚</p>
<h3 id="231-è·¯ç”±å…ƒä¿¡æ¯">2.3.1 è·¯ç”±å…ƒä¿¡æ¯</h3>
<p>NameServerè·¯ç”±å®ç°ç±»: org.apache.rocketmq.namesrv.routeinfo.RoutelnfoManager</p>
<blockquote>
<p>RoutelnfoManage è·¯ç”±å…ƒæ•°æ®</p>
</blockquote>
<pre><code class="language-java">public class RouteInfoManager {
    private static final InternalLogger log = InternalLoggerFactory.getLogger(LoggerName.NAMESRV_LOGGER_NAME);
    private final static long DEFAULT_BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2;
    private final ReadWriteLock lock = new ReentrantReadWriteLock();

    //Topic æ¶ˆæ¯é˜Ÿåˆ—è·¯ç”±ä¿¡æ¯ï¼Œæ¶ˆæ¯å‘é€æ—¶æ ¹æ®è·¯ç”±è¡¨è¿›è¡Œè´Ÿ è½½å‡è¡¡ ã€‚
    private final Map&lt;String/* topic */, Map&lt;String, QueueData&gt;&gt; topicQueueTable;

    //Broker åŸºç¡€ä¿¡æ¯ï¼Œ åŒ…å« brokerNameã€ æ‰€å±é›†ç¾¤åç§° ã€ ä¸»å¤‡ Brokeråœ°å€ã€‚
    private final Map&lt;String/* brokerName */, BrokerData&gt; brokerAddrTable;

    //Broker é›†ç¾¤ä¿¡æ¯ï¼Œå­˜å‚¨é›†ç¾¤ä¸­æ‰€æœ‰ Broker åç§° ã€‚
    private final Map&lt;String/* clusterName */, Set&lt;String/* brokerName */&gt;&gt; clusterAddrTable;
    //Broker çŠ¶æ€ä¿¡æ¯ ã€‚ NameServer æ¯æ¬¡ æ”¶åˆ°å¿ƒè·³åŒ…æ—¶ä¼š æ›¿æ¢è¯¥ä¿¡ æ¯
    private final Map&lt;BrokerAddrInfo/* brokerAddr */, BrokerLiveInfo&gt; brokerLiveTable;
    // Brokerä¸Šçš„ FilterServeråˆ—è¡¨ï¼Œç”¨äºç±»æ¨¡å¼æ¶ˆæ¯è¿‡æ»¤
    private final Map&lt;BrokerAddrInfo/* brokerAddr */, List&lt;String&gt;/* Filter Server */&gt; filterServerTable;
    private final Map&lt;String/* topic */, Map&lt;String/*brokerName*/, TopicQueueMappingInfo&gt;&gt; topicQueueMappingInfoTable;

    private final BatchUnregistrationService unRegisterService;

    private final NamesrvController namesrvController;
    private final NamesrvConfig namesrvConfig;
}
</code></pre>
<p>RocketMQåŸºäºè®¢é˜…å‘å¸ƒæœºåˆ¶ï¼Œä¸€ä¸ªTopicæ‹¥æœ‰å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ— ï¼Œä¸€ä¸ªBrokerä¸ºæ¯ä¸€ä¸»é¢˜é»˜è®¤åˆ›å»º4ä¸ªè¯»é˜Ÿåˆ—4ä¸ªå†™é˜Ÿåˆ—ã€‚å¤šä¸ªBrokerç»„æˆä¸€ä¸ªé›†ç¾¤ï¼ŒBrokerNameç”±ç›¸åŒçš„å¤šå°Brokerç»„æˆMaster-Slaveæ¶æ„ ï¼Œ brokerIdä¸º0ä»£è¡¨ Masterï¼Œå¤§äº0è¡¨ç¤ºSlaveã€‚ BrokerLivelnfoä¸­çš„lastUpdateTimestamp å­˜å‚¨ä¸Šæ¬¡æ”¶åˆ°Brokerå¿ƒè·³åŒ…çš„æ—¶é—´ã€‚</p>
<h3 id="232-è·¯ç”±æ³¨å†Œ">2.3.2 è·¯ç”±æ³¨å†Œ</h3>
<p>RocketMQè·¯ç”±æ³¨å†Œæ˜¯é€šè¿‡ Brokerä¸NameServerçš„å¿ƒè·³åŠŸèƒ½å®ç°çš„ã€‚Brokerå¯åŠ¨æ—¶ å‘ é›†ç¾¤ä¸­ æ‰€æœ‰çš„ NameServerå‘é€å¿ƒè·³è¯­å¥ï¼Œæ¯éš”30så‘ é›†ç¾¤ ä¸­æ‰€ æœ‰ NameServerå‘é€å¿ƒè·³åŒ…ï¼ŒNameServeræ”¶åˆ°Brokerå¿ƒè·³åŒ…æ—¶ä¼šæ›´æ–°brokerLiveTableç¼“å­˜ä¸­BrokerLivelnfoçš„lastUpdateTimestampï¼Œç„¶åNameServeræ¯éš”10sæ‰«æ brokerLiveTableï¼Œå¦‚æœè¿ç»­120sæ²¡æœ‰æ”¶åˆ°å¿ƒè·³åŒ…ï¼Œ NameServerå°†ç§»é™¤è¯¥ Brokerçš„è·¯ç”±ä¿¡æ¯åŒæ—¶å…³é—­Socketè¿æ¥ã€‚</p>
<ol>
<li>Brokerå‘é€å¿ƒè·³åŒ…</li>
</ol>
<blockquote>
<p>Brokerç«¯å¿ƒè·³åŒ…å‘é€</p>
</blockquote>
<pre><code class="language-java">  scheduledFutures.add(this.scheduledExecutorService.scheduleAtFixedRate(new AbstractBrokerRunnable(this.getBrokerIdentity()) {
            @Override
            public void run2() {
                try {
                    if (System.currentTimeMillis() &lt; shouldStartTime) {
                        BrokerController.LOG.info(&quot;Register to namesrv after {}&quot;, shouldStartTime);
                        return;
                    }
                    if (isIsolated) {
                        BrokerController.LOG.info(&quot;Skip register for broker is isolated&quot;);
                        return;
                    }
                    BrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister());
                } catch (Throwable e) {
                    BrokerController.LOG.error(&quot;registerBrokerAll Exception&quot;, e);
                }
            }
        }, 1000 * 10, Math.max(10000, Math.min(brokerConfig.getRegisterNameServerPeriod(), 60000)), TimeUnit.MILLISECONDS));
</code></pre>
<blockquote>
<p>registerBrokerAll</p>
</blockquote>
<pre><code class="language-java">   final List&lt;RegisterBrokerResult&gt; registerBrokerResultList = new CopyOnWriteArrayList&lt;&gt;();

final CountDownLatch countDownLatch = new CountDownLatch(nameServerAddressList.size());
    for (final String namesrvAddr : nameServerAddressList) {
        brokerOuterExecutor.execute(new AbstractBrokerRunnable(brokerIdentity) {
            @Override
            public void run2() {
                try {
                    RegisterBrokerResult result = registerBroker(namesrvAddr, oneway, timeoutMills, requestHeader, body);
                    if (result != null) {
                        registerBrokerResultList.add(result);
                    }

                    LOGGER.info(&quot;Registering current broker to name server completed. TargetHost={}&quot;, namesrvAddr);
                } catch (Exception e) {
                    LOGGER.error(&quot;Failed to register current broker to name server. TargetHost={}&quot;, namesrvAddr, e);
                } finally {
                    countDownLatch.countDown();
                }
            }
        });
    }

        try {
        if (!countDownLatch.await(timeoutMills, TimeUnit.MILLISECONDS)) {
            LOGGER.warn(&quot;Registration to one or more name servers does NOT complete within deadline. Timeout threshold: {}ms&quot;, timeoutMills);
        }
    } catch (InterruptedException ignore) {
    }
</code></pre>
<p>è¯¥æ–¹æ³•ä¸»è¦æ˜¯éå† NameServeråˆ—è¡¨ï¼ŒBrokeræ¶ˆæ¯æœåŠ¡å™¨ä¾æ¬¡å‘ NameServerå‘é€å¿ƒè·³åŒ…ã€‚</p>
<pre><code class="language-java">  private RegisterBrokerResult registerBroker(
            final String namesrvAddr,
            final boolean oneway,
            final int timeoutMills,
            final RegisterBrokerRequestHeader requestHeader,
            final byte[] body
    ) throws RemotingCommandException, MQBrokerException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
            InterruptedException {
        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.REGISTER_BROKER, requestHeader);
        request.setBody(body);

        if (oneway) {
            try {
                this.remotingClient.invokeOneway(namesrvAddr, request, timeoutMills);
            } catch (RemotingTooMuchRequestException e) {
                // Ignore
            }
            return null;
        }
        //....
    }
</code></pre>
<p>å‘é€å¿ƒè·³åŒ…å…·ä½“é€»è¾‘ï¼Œé¦–å…ˆå°è£…è¯·æ±‚åŒ…å¤´( Header)ã€‚</p>
<p>brokerAddr: broker åœ°å€ ã€‚<br>
brokerId: brokerld,0:Master;å¤§ 0: Slaveã€‚<br>
brokerName:brokeråç§°ã€‚<br>
clusterName: é›†ç¾¤åç§°ã€‚<br>
haServerAddr: master åœ°å€ï¼Œåˆæ¬¡è¯·æ±‚æ—¶è¯¥å€¼ä¸ºç©ºï¼Œslave å‘Nameserveræ³¨å†Œåè¿”å›ã€‚<br>
requestBody:<br>
filterServerListï¼šæ¶ˆæ¯è¿‡æ»¤æœåŠ¡å™¨åˆ—è¡¨ã€‚<br>
topicConfigWrapperï¼šä¸»é¢˜é…ç½®ã€‚</p>
<pre><code class="language-java">    final RegisterBrokerRequestHeader requestHeader = new RegisterBrokerRequestHeader();
    requestHeader.setBrokerAddr(brokerAddr);
    requestHeader.setBrokerId(brokerId);
    requestHeader.setBrokerName(brokerName);
    requestHeader.setClusterName(clusterName);
    requestHeader.setHaServerAddr(haServerAddr);
    requestHeader.setEnableActingMaster(enableActingMaster);
    requestHeader.setCompressed(false);

    RegisterBrokerBody requestBody = new RegisterBrokerBody();
    requestBody.setTopicConfigSerializeWrapper(TopicConfigAndMappingSerializeWrapper.from(topicConfigWrapper));
    requestBody.setFilterServerList(filterServerList);
</code></pre>
<blockquote>
<p>RocketMQç½‘ç»œä¼ è¾“åŸºäº Netty,æ¯ä¸€ä¸ªè¯·æ±‚ï¼ŒRocketMQéƒ½ä¼šå®šä¹‰ä¸€ä¸ªRequestCodeï¼Œç„¶ååœ¨æœåŠ¡ç«¯ä¼šå¯¹åº”ç›¸åº”çš„ç½‘ç»œå¤„ç†å™¨ (processoråŒ…ä¸­)ã€‚</p>
</blockquote>
<ol start="2">
<li>NameServerå¤„ç†å¿ƒè·³åŒ…</li>
</ol>
<p>org.apache.rocketmq.namesrv.processor.DefaultRequestProcessor ç½‘ç»œå¤„ç†å™¨è§£æè¯·æ±‚ç±»å‹ï¼Œ å¦‚æœè¯·æ±‚ç±»å‹ä¸ºRequestCode.REGISTER_BROKERï¼Œåˆ™è¯·æ±‚æœ€ç»ˆè½¬å‘åˆ°RoutelnfoMan ager#registerBrokerã€‚</p>
<pre><code class="language-java">this.lock.writeLock().lockInterruptibly();

//init or update the cluster info
Set&lt;String&gt; brokerNames = this.clusterAddrTable.computeIfAbsent(clusterName, k -&gt; new HashSet&lt;&gt;());
brokerNames.add(brokerName);
</code></pre>
<ul>
<li>Step1:è·¯ç”±æ³¨å†Œéœ€è¦åŠ å†™é”ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹RoutelnfoManagerä¸­çš„è·¯ç”±è¡¨ã€‚</li>
</ul>
<pre><code class="language-java">// æ˜¯å¦ç¬¬ä¸€ä¸ªæ³¨å†Œ
boolean registerFirst = false; 
BrokerData brokerData = this.brokerAddrTable.get(brokerName);
if (null == brokerData) {
    registerFirst = true;
    brokerData = new BrokerData(clusterName, brokerName, new HashMap&lt;&gt;());
    this.brokerAddrTable.put(brokerName, brokerData);
}

boolean isOldVersionBroker = enableActingMaster == null;
brokerData.setEnableActingMaster(!isOldVersionBroker &amp;&amp; enableActingMaster);
brokerData.setZoneName(zoneName);

//çœç•¥

String oldAddr = brokerAddrsMap.put(brokerId, brokerAddr);
registerFirst = registerFirst || (StringUtils.isEmpty(oldAddr));
</code></pre>
<p>Step2 :ç»´æŠ¤BrokerDataä¿¡æ¯ï¼Œé¦–å…ˆä»brokerAddrTableæ ¹æ® BrokerNameå°è¯•è·å– Brokerä¿¡æ¯ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºBrokerDataå¹¶æ”¾å…¥åˆ°brokerAddrTable, registerFirstè®¾ç½®ä¸º true;å¦‚æœå­˜åœ¨ï¼Œç›´æ¥æ›¿æ¢åŸå…ˆçš„ï¼ŒregisterFirstè®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºéç¬¬ä¸€æ¬¡æ³¨å†Œã€‚</p>
<pre><code class="language-java">boolean isMaster = MixAll.MASTER_ID == brokerId;
boolean isPrimeSlave = !isOldVersionBroker &amp;&amp; !isMaster
        &amp;&amp; brokerId == Collections.min(brokerAddrsMap.keySet());
if (null != topicConfigWrapper &amp;&amp; (isMaster || isPrimeSlave)) {

        ConcurrentMap&lt;String, TopicConfig&gt; tcTable =
                topicConfigWrapper.getTopicConfigTable();
        if (tcTable != null) {
            for (Map.Entry&lt;String, TopicConfig&gt; entry : tcTable.entrySet()) {
                if (registerFirst || this.isTopicConfigChanged(clusterName, brokerAddr,
                        topicConfigWrapper.getDataVersion(), brokerName,
                        entry.getValue().getTopicName())) {
                    final TopicConfig topicConfig = entry.getValue();
                    if (isPrimeSlave) {
                        // Wipe write perm for prime slave
                        topicConfig.setPerm(topicConfig.getPerm() &amp; (~PermName.PERM_WRITE));
                    }
                    this.createAndUpdateQueueData(brokerName, topicConfig);
                }
            }
        }
}
</code></pre>
<ul>
<li>Step3 :å¦‚æœBrokerä¸ºMasterï¼Œå¹¶ä¸”BrokerTopicé…ç½®ä¿¡æ¯å‘ç”Ÿå˜åŒ–æˆ–è€…æ˜¯åˆæ¬¡æ³¨å†Œï¼Œåˆ™éœ€è¦åˆ›å»ºæˆ–æ›´æ–° Topicè·¯ç”±å…ƒæ•°æ®ï¼Œå¡«å……topicQueueTableï¼Œå…¶å®å°±æ˜¯ä¸ºé»˜è®¤ä¸»é¢˜è‡ªåŠ¨æ³¨ å†Œè·¯ç”±ä¿¡æ¯å…¶ä¸­åŒ…å« MixAII.DEFAULT_TOPICçš„è·¯ç”±ä¿¡æ¯ã€‚å½“æ¶ˆæ¯ç”Ÿäº§è€…å‘é€ä¸»é¢˜æ—¶ï¼Œå¦‚æœè¯¥ä¸»é¢˜æœªåˆ›å»ºå¹¶ä¸”BrokerConfigçš„autoCreateTopicEnableä¸ºtrueæ—¶ï¼Œå°†è¿”å›MixAII. DEFAULT_TOPICçš„è·¯ç”±ä¿¡æ¯ã€‚</li>
</ul>
<pre><code class="language-java">private void createAndUpdateQueueData(final String brokerName, final TopicConfig topicConfig) {
    QueueData queueData = new QueueData();
    queueData.setBrokerName(brokerName);
    queueData.setWriteQueueNums(topicConfig.getWriteQueueNums());
    queueData.setReadQueueNums(topicConfig.getReadQueueNums());
    queueData.setPerm(topicConfig.getPerm());
    queueData.setTopicSysFlag(topicConfig.getTopicSysFlag());

    Map&lt;String, QueueData&gt; queueDataMap = this.topicQueueTable.get(topicConfig.getTopicName());
    if (null == queueDataMap) {
        queueDataMap = new HashMap&lt;&gt;();
        queueDataMap.put(brokerName, queueData);
        this.topicQueueTable.put(topicConfig.getTopicName(), queueDataMap);
        log.info(&quot;new topic registered, {} {}&quot;, topicConfig.getTopicName(), queueData);
    } else {
        final QueueData existedQD = queueDataMap.get(brokerName);
        if (existedQD == null) {
            queueDataMap.put(brokerName, queueData);
        } else if (!existedQD.equals(queueData)) {
            log.info(&quot;topic changed, {} OLD: {} NEW: {}&quot;, topicConfig.getTopicName(), existedQD,
                queueData);
            queueDataMap.put(brokerName, queueData);
        }
    }
}
</code></pre>
<p>æ ¹æ® TopicConfigåˆ›å»º QueueDataæ•°æ®ç»“æ„ ï¼Œç„¶åæ›´æ–° topicQueueTableã€‚</p>
<pre><code class="language-java">BrokerAddrInfo brokerAddrInfo = new BrokerAddrInfo(clusterName, brokerAddr);
BrokerLiveInfo prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddrInfo,
        new BrokerLiveInfo(
                System.currentTimeMillis(),
                timeoutMillis == null ? DEFAULT_BROKER_CHANNEL_EXPIRED_TIME : timeoutMillis,
                topicConfigWrapper == null ? new DataVersion() : topicConfigWrapper.getDataVersion(),
                channel,
                haServerAddr));
if (null == prevBrokerLiveInfo) {
    log.info(&quot;new broker registered, {} HAService: {}&quot;, brokerAddrInfo, haServerAddr);
}
</code></pre>
<ul>
<li>Step4: æ›´æ–°BrokerLivelnfoï¼Œå­˜æ´»Brokerä¿¡æ¯è¡¨ï¼Œ BrokeLivelnfoæ˜¯æ‰§è¡Œè·¯ç”±åˆ é™¤çš„é‡è¦ä¾æ®ã€‚</li>
</ul>
<pre><code class="language-java">if (filterServerList != null) {
    if (filterServerList.isEmpty()) {
        this.filterServerTable.remove(brokerAddrInfo);
    } else {
        this.filterServerTable.put(brokerAddrInfo, filterServerList);
    }
}

if (MixAll.MASTER_ID != brokerId) {
    String masterAddr = brokerData.getBrokerAddrs().get(MixAll.MASTER_ID);
    if (masterAddr != null) {
        BrokerAddrInfo masterAddrInfo = new BrokerAddrInfo(clusterName, masterAddr);
        BrokerLiveInfo masterLiveInfo = this.brokerLiveTable.get(masterAddrInfo);
        if (masterLiveInfo != null) {
            result.setHaServerAddr(masterLiveInfo.getHaServerAddr());
            result.setMasterAddr(masterAddr);
        }
    }
}
</code></pre>
<ul>
<li>Step5 : æ³¨å†ŒBrokerçš„è¿‡æ»¤å™¨Serveråœ°å€åˆ—è¡¨ï¼Œä¸€ä¸ªBrokerä¸Šä¼šå…³è”å¤šä¸ªFilterServeræ¶ˆæ¯è¿‡æ»¤æœåŠ¡å™¨;å¦‚æœæ­¤Brokerä¸ºä»èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦æŸ¥æ‰¾è¯¥Brokerçš„Master çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶æ›´æ–°å¯¹åº”çš„masterAddrå±æ€§ ã€‚</li>
</ul>
<blockquote>
<p>NameServeä¸Brokerä¿æŒé•¿è¿æ¥ï¼Œ BrokerçŠ¶æ€å­˜å‚¨åœ¨ brokerLiveTableä¸­ï¼ŒNameServeræ¯æ”¶åˆ°ä¸€ä¸ªå¿ƒè·³åŒ…ï¼Œå°†æ›´æ–° brokerLiveTableä¸­å…³äºBrokerçš„çŠ¶æ€ä¿¡æ¯ä»¥åŠè·¯ ç”±è¡¨( topicQueueTableã€ brokerAddrTableã€brokerLiveTableã€filterServerTable)ã€‚ æ›´æ–°ä¸Šè¿° è·¯ç”±è¡¨( HashTable)ä½¿ç”¨äº†é”ç²’åº¦è¾ƒå°‘çš„<strong>è¯»å†™é”</strong>ï¼Œå…è®¸å¤šä¸ªæ¶ˆæ¯å‘é€è€…( Producer)å¹¶å‘è¯»ï¼Œä¿è¯æ¶ˆæ¯å‘é€æ—¶çš„é«˜å¹¶å‘ã€‚ä½†åŒä¸€æ—¶åˆ»NameServeråªå¤„ç†ä¸€ä¸ªBrokerå¿ƒè·³åŒ…ï¼Œå¤šä¸ªå¿ƒè·³åŒ…è¯·æ±‚ä¸²è¡Œæ‰§è¡Œã€‚</p>
</blockquote>
<h3 id="233-è·¯ç”±åˆ é™¤">2.3.3 è·¯ç”±åˆ é™¤</h3>
<p>NameServerä¼šæ¯éš”10sæ‰«æbrokerLiveTableçŠ¶æ€è¡¨ï¼Œå¦‚æœBrokerLiveçš„lastUpdateTimestampçš„æ—¶é—´æˆ³è·å½“å‰æ—¶é—´è¶…è¿‡ 120sï¼Œåˆ™è®¤ä¸ºBrokerå¤±æ•ˆï¼Œç§»é™¤è¯¥ Broker, å…³é—­ä¸Brokerè¿æ¥ï¼Œå¹¶åŒæ—¶æ›´æ–°topicQueueTableã€brokerAddrTableã€brokerLiveTableã€filterServerTableã€‚</p>
<p>RocktMQæœ‰ä¸¤ä¸ªè§¦å‘ç‚¹æ¥è§¦å‘è·¯ç”±åˆ é™¤ã€‚</p>
<ol>
<li>NameServerå®šæ—¶æ‰«æ brokerLiveTableæ£€æµ‹ä¸Šæ¬¡å¿ƒè·³åŒ…ä¸å½“å‰ç³»ç»Ÿæ—¶é—´çš„æ—¶é—´å·®ï¼Œå¦‚æœæ—¶é—´æˆ³å¤§äº 120såˆ™éœ€è¦ç§»é™¤è¯¥ Brokerä¿¡æ¯ ã€‚<br>
2 ) Brokeråœ¨æ­£å¸¸è¢«å…³é—­çš„æƒ…å†µä¸‹ä¼šæ‰§è¡ŒunregisterBrokeræŒ‡ä»¤ã€‚</li>
</ol>
<pre><code class="language-java">public void scanNotActiveBroker() {
    try {
        log.info(&quot;start scanNotActiveBroker&quot;);
        for (Entry&lt;BrokerAddrInfo, BrokerLiveInfo&gt; next : this.brokerLiveTable.entrySet()) {
            long last = next.getValue().getLastUpdateTimestamp();
            long timeoutMillis = next.getValue().getHeartbeatTimeoutMillis();
            if ((last + timeoutMillis) &lt; System.currentTimeMillis()) {
                RemotingUtil.closeChannel(next.getValue().getChannel());
                log.warn(&quot;The broker channel expired, {} {}ms&quot;, next.getKey(), timeoutMillis);
                this.onChannelDestroy(next.getKey());
            }
        }
    } catch (Exception e) {
        log.error(&quot;scanNotActiveBroker exception&quot;, e);
    }
}
</code></pre>
<pre><code class="language-java">public void onChannelDestroy(BrokerAddrInfo brokerAddrInfo) {
    UnRegisterBrokerRequestHeader unRegisterRequest = new UnRegisterBrokerRequestHeader();
    boolean needUnRegister = false;
    if (brokerAddrInfo != null) {
        try {
            try {
                this.lock.readLock().lockInterruptibly();
                needUnRegister = setupUnRegisterRequest(unRegisterRequest, brokerAddrInfo);
            } finally {
                this.lock.readLock().unlock();
            }
        } catch (Exception e) {
            log.error(&quot;onChannelDestroy Exception&quot;, e);
        }
    }

    if (needUnRegister) {
        boolean result = this.submitUnRegisterBrokerRequest(unRegisterRequest);
        log.info(&quot;the broker's channel destroyed, submit the unregister request at once, &quot; +
            &quot;broker info: {}, submit result: {}&quot;, unRegisterRequest, result);
    }
}
</code></pre>
<p>Step1 :ç”³è¯·å†™é”ï¼ŒæŠŠéœ€è¦ç§»é™¤çš„brokeræ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—ã€‚</p>
<pre><code class="language-java">public void unRegisterBroker(Set&lt;UnRegisterBrokerRequestHeader&gt; unRegisterRequests) {
        try {
            try {
                Set&lt;String&gt; removedBroker = new HashSet&lt;&gt;();
                Set&lt;String&gt; reducedBroker = new HashSet&lt;&gt;();
                Map&lt;String, BrokerStatusChangeInfo&gt; needNotifyBrokerMap = new HashMap&lt;&gt;();

                this.lock.writeLock().lockInterruptibly();
                for (final UnRegisterBrokerRequestHeader unRegisterRequest : unRegisterRequests) {
                    final String brokerName = unRegisterRequest.getBrokerName();
                    final String clusterName = unRegisterRequest.getClusterName();

                    BrokerAddrInfo brokerAddrInfo = new BrokerAddrInfo(clusterName, unRegisterRequest.getBrokerAddr());

                    BrokerLiveInfo brokerLiveInfo = this.brokerLiveTable.remove(brokerAddrInfo);
                    log.info(&quot;unregisterBroker, remove from brokerLiveTable {}, {}&quot;,
                        brokerLiveInfo != null ? &quot;OK&quot; : &quot;Failed&quot;,
                        brokerAddrInfo
                    );

                    this.filterServerTable.remove(brokerAddrInfo);

                    boolean removeBrokerName = false;
                    boolean isMinBrokerIdChanged = false;
                    BrokerData brokerData = this.brokerAddrTable.get(brokerName);
                    if (null != brokerData) {
                        if (!brokerData.getBrokerAddrs().isEmpty() &amp;&amp;
                            unRegisterRequest.getBrokerId().equals(Collections.min(brokerData.getBrokerAddrs().keySet()))) {
                            isMinBrokerIdChanged = true;
                        }
                        String addr = brokerData.getBrokerAddrs().remove(unRegisterRequest.getBrokerId());
                        log.info(&quot;unregisterBroker, remove addr from brokerAddrTable {}, {}&quot;,
                            addr != null ? &quot;OK&quot; : &quot;Failed&quot;,
                            brokerAddrInfo
                        );
                        if (brokerData.getBrokerAddrs().isEmpty()) {
                            this.brokerAddrTable.remove(brokerName);
                            log.info(&quot;unregisterBroker, remove name from brokerAddrTable OK, {}&quot;,
                                brokerName
                            );

                            removeBrokerName = true;
                        } else if (isMinBrokerIdChanged) {
                            needNotifyBrokerMap.put(brokerName, new BrokerStatusChangeInfo(
                                brokerData.getBrokerAddrs(), addr, null));
                        }
                    }

                    if (removeBrokerName) {
                        Set&lt;String&gt; nameSet = this.clusterAddrTable.get(clusterName);
                        if (nameSet != null) {
                            boolean removed = nameSet.remove(brokerName);
                            log.info(&quot;unregisterBroker, remove name from clusterAddrTable {}, {}&quot;,
                                removed ? &quot;OK&quot; : &quot;Failed&quot;,
                                brokerName);

                            if (nameSet.isEmpty()) {
                                this.clusterAddrTable.remove(clusterName);
                                log.info(&quot;unregisterBroker, remove cluster from clusterAddrTable {}&quot;,
                                    clusterName
                                );
                            }
                        }
                        removedBroker.add(brokerName);
                    } else {
                        reducedBroker.add(brokerName);
                    }
                }

                cleanTopicByUnRegisterRequests(removedBroker, reducedBroker);

                if (!needNotifyBrokerMap.isEmpty() &amp;&amp; namesrvConfig.isNotifyMinBrokerIdChanged()) {
                    notifyMinBrokerIdChanged(needNotifyBrokerMap);
                }
            } finally {
                this.lock.writeLock().unlock();
            }
        } catch (Exception e) {
            log.error(&quot;unregisterBroker Exception&quot;, e);
        }
    }
</code></pre>
<p>Step2 :ç»Ÿä¸€åˆ é™¤æ¯ä¸ªmapä¸­å…ƒæ•°æ®ã€‚</p>
<pre><code class="language-java">private void cleanTopicByUnRegisterRequests(Set&lt;String&gt; removedBroker, Set&lt;String&gt; reducedBroker) {
    Iterator&lt;Entry&lt;String, Map&lt;String, QueueData&gt;&gt;&gt; itMap = this.topicQueueTable.entrySet().iterator();
    while (itMap.hasNext()) {
        Entry&lt;String, Map&lt;String, QueueData&gt;&gt; entry = itMap.next();

        String topic = entry.getKey();
        Map&lt;String, QueueData&gt; queueDataMap = entry.getValue();

        for (final String brokerName : removedBroker) {
            final QueueData removedQD = queueDataMap.remove(brokerName);
            if (removedQD != null) {
                log.debug(&quot;removeTopicByBrokerName, remove one broker's topic {} {}&quot;, topic, removedQD);
            }
        }

        if (queueDataMap.isEmpty()) {
            log.debug(&quot;removeTopicByBrokerName, remove the topic all queue {}&quot;, topic);
            itMap.remove();
        }

        for (final String brokerName : reducedBroker) {
            final QueueData queueData = queueDataMap.get(brokerName);

            if (queueData != null) {
                if (this.brokerAddrTable.get(brokerName).isEnableActingMaster()) {
                    // Master has been unregistered, wipe the write perm
                    if (isNoMasterExists(brokerName)) {
                        queueData.setPerm(queueData.getPerm() &amp; (~PermName.PERM_WRITE));
                    }
                }
            }
        }
    }
}
</code></pre>
<p>Step3 :åˆ é™¤Topicé˜Ÿåˆ—ä¸­å…ƒæ•°æ®ã€‚</p>
<h3 id="234-è·¯ç”±å‘ç°">2.3.4 è·¯ç”±å‘ç°</h3>
<p>RocketMQè·¯ç”±å‘ç°æ˜¯éå®æ—¶çš„ï¼Œå½“Topicè·¯ç”±å‡ºç°å˜åŒ–åï¼ŒNameServerä¸ä¸»åŠ¨æ¨é€ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯ç”±å®¢æˆ·ç«¯å®šæ—¶æ‹‰å–ä¸»é¢˜æœ€æ–°çš„è·¯ç”±ã€‚æ ¹æ®ä¸»é¢˜åç§°æ‹‰å–è·¯ç”±ä¿¡æ¯çš„å‘½ä»¤ç¼–ç ä¸º: GET_ROUTEINTO_BY_TOPICã€‚</p>
<pre><code class="language-java">public class TopicRouteData extends RemotingSerializable {

    //é¡ºåºæ¶ˆæ¯é…ç½®å†…å®¹ï¼Œæ¥è‡ªäº kvConfigã€‚
    private String orderTopicConf;
    //topic é˜Ÿåˆ—å…ƒæ•°æ® 
    private List&lt;QueueData&gt; queueDatas;
    //topicåˆ†å¸ƒçš„ brokerå…ƒæ•°æ®
    private List&lt;BrokerData&gt; brokerDatas;
    //brokerä¸Šè¿‡æ»¤æœåŠ¡å™¨åœ°å€åˆ—è¡¨ã€‚
    private HashMap&lt;String/* brokerAddr */, List&lt;String&gt;/* Filter Server */&gt; filterServerTable;
    //It could be null or empty
    private Map&lt;String/*brokerName*/, TopicQueueMappingInfo&gt; topicQueueMappingByBroker;
}
</code></pre>
<pre><code class="language-java">public RemotingCommand getRouteInfoByTopic(ChannelHandlerContext ctx,
        RemotingCommand request) throws RemotingCommandException {
        final RemotingCommand response = RemotingCommand.createResponseCommand(null);
        final GetRouteInfoRequestHeader requestHeader =
            (GetRouteInfoRequestHeader) request.decodeCommandCustomHeader(GetRouteInfoRequestHeader.class);

        TopicRouteData topicRouteData = this.namesrvController.getRouteInfoManager().pickupTopicRouteData(requestHeader.getTopic());

        if (topicRouteData != null) {
            if (this.namesrvController.getNamesrvConfig().isOrderMessageEnable()) {
                String orderTopicConf =
                    this.namesrvController.getKvConfigManager().getKVConfig(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG,
                        requestHeader.getTopic());
                topicRouteData.setOrderTopicConf(orderTopicConf);
            }

            byte[] content;
            Boolean standardJsonOnly = requestHeader.getAcceptStandardJsonOnly();
            if (request.getVersion() &gt;= MQVersion.Version.V4_9_4.ordinal() || (null != standardJsonOnly &amp;&amp; standardJsonOnly)) {
                content = topicRouteData.encode(SerializerFeature.BrowserCompatible,
                    SerializerFeature.QuoteFieldNames, SerializerFeature.SkipTransientField,
                    SerializerFeature.MapSortField);
            } else {
                content = topicRouteData.encode();
            }

            response.setBody(content);
            response.setCode(ResponseCode.SUCCESS);
            response.setRemark(null);
            return response;
        }

        response.setCode(ResponseCode.TOPIC_NOT_EXIST);
        response.setRemark(&quot;No topic route info in name server for the topic: &quot; + requestHeader.getTopic()
            + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));
        return response;
    }
</code></pre>
<p>Step1:è°ƒç”¨ RouterlnfoManager çš„æ–¹æ³•ï¼Œä»è·¯ç”± è¡¨ topicQueueTableã€ brokerAddrTableã€ filterServerTableä¸­åˆ†åˆ«å¡«å……TopicRouteDataä¸­çš„List<QueueData>ã€List<BrokerData>å’Œ filterServer åœ°å€è¡¨ ã€‚<br>
Step2 : å¦‚æœæ‰¾åˆ°ä¸»é¢˜å¯¹åº”çš„è·¯ç”±ä¿¡æ¯å¹¶ä¸”è¯¥ä¸»é¢˜ä¸ºé¡ºåºæ¶ˆæ¯ï¼Œåˆ™ä» NameServer KVconfig ä¸­è·å–å…³äºé¡ºåºæ¶ˆæ¯ç›¸å…³ çš„é…ç½®å¡«å……è·¯ç”±ä¿¡æ¯ ã€‚</p>
<p>å¦‚æœæ‰¾ä¸åˆ°è·¯ç”±ä¿¡æ¯CODEåˆ™ä½¿ç”¨ TOPIC_NOT_EXISTS ï¼Œè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„è·¯ç”± ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1663067880142.png" alt="NameServer è·¯ç”± æ³¨å†Œã€åˆ é™¤æœºåˆ¶" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Redis6.0çš„æ–°ç‰¹æ€§]]></title>
        <id>https://q456qq520.github.io/post/redis60-de-xin-te-xing/</id>
        <link href="https://q456qq520.github.io/post/redis60-de-xin-te-xing/">
        </link>
        <updated>2022-09-07T07:26:39.000Z</updated>
        <summary type="html"><![CDATA[<p>Redis 6.0ç‰ˆæœ¬ä¸­æ–°å‡ºçš„å¤šçº¿ç¨‹ç‰¹æ€§ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>Redis 6.0ç‰ˆæœ¬ä¸­æ–°å‡ºçš„å¤šçº¿ç¨‹ç‰¹æ€§ã€‚</p>
<!-- more -->
<h1 id="1-ä»å•çº¿ç¨‹å¤„ç†ç½‘ç»œè¯·æ±‚åˆ°å¤šçº¿ç¨‹å¤„ç†">1 ä»å•çº¿ç¨‹å¤„ç†ç½‘ç»œè¯·æ±‚åˆ°å¤šçº¿ç¨‹å¤„ç†</h1>
<p>åœ¨Redis 6.0ä¸­ï¼Œéå¸¸å—å…³æ³¨çš„ç¬¬ä¸€ä¸ªæ–°ç‰¹æ€§å°±æ˜¯å¤šçº¿ç¨‹ã€‚è¿™æ˜¯å› ä¸ºï¼ŒRedisä¸€ç›´è¢«å¤§å®¶ç†ŸçŸ¥çš„å°±æ˜¯å®ƒçš„å•çº¿ç¨‹æ¶æ„ï¼Œè™½ç„¶æœ‰äº›å‘½ä»¤æ“ä½œå¯ä»¥ç”¨åå°çº¿ç¨‹æˆ–å­è¿›ç¨‹æ‰§è¡Œï¼ˆæ¯”å¦‚æ•°æ®åˆ é™¤ã€å¿«ç…§ç”Ÿæˆã€AOFé‡å†™ï¼‰ï¼Œä½†æ˜¯ï¼Œä»ç½‘ç»œIOå¤„ç†åˆ°å®é™…çš„è¯»å†™å‘½ä»¤å¤„ç†ï¼Œéƒ½æ˜¯ç”±å•ä¸ªçº¿ç¨‹å®Œæˆçš„ã€‚</p>
<p>**Redisçš„å¤šIOçº¿ç¨‹åªæ˜¯ç”¨æ¥å¤„ç†ç½‘ç»œè¯·æ±‚çš„ï¼Œå¯¹äºè¯»å†™å‘½ä»¤ï¼ŒRedisä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†ã€‚**è¿™æ˜¯å› ä¸ºï¼ŒRediså¤„ç†è¯·æ±‚æ—¶ï¼Œç½‘ç»œå¤„ç†ç»å¸¸æ˜¯ç“¶é¢ˆï¼Œé€šè¿‡å¤šä¸ªIOçº¿ç¨‹å¹¶è¡Œå¤„ç†ç½‘ç»œæ“ä½œï¼Œå¯ä»¥æå‡å®ä¾‹çš„æ•´ä½“å¤„ç†æ€§èƒ½ã€‚è€Œç»§ç»­ä½¿ç”¨å•çº¿ç¨‹æ‰§è¡Œå‘½ä»¤æ“ä½œï¼Œå°±ä¸ç”¨ä¸ºäº†ä¿è¯Luaè„šæœ¬ã€äº‹åŠ¡çš„åŸå­æ€§ï¼Œé¢å¤–å¼€å‘å¤šçº¿ç¨‹äº’æ–¥æœºåˆ¶äº†ã€‚</p>
<h2 id="11-ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹å…·ä½“æ˜¯æ€ä¹ˆåä½œå®Œæˆè¯·æ±‚å¤„ç†çš„">1.1 ä¸»çº¿ç¨‹å’ŒIOçº¿ç¨‹å…·ä½“æ˜¯æ€ä¹ˆåä½œå®Œæˆè¯·æ±‚å¤„ç†çš„?</h2>
<p>å¯ä»¥æŠŠä¸»çº¿ç¨‹å’Œå¤šIOçº¿ç¨‹çš„åä½œåˆ†æˆå››ä¸ªé˜¶æ®µã€‚</p>
<h3 id="111-é˜¶æ®µä¸€æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å»ºç«‹socketè¿æ¥å¹¶åˆ†é…å¤„ç†çº¿ç¨‹">1.1.1 é˜¶æ®µä¸€ï¼šæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å»ºç«‹Socketè¿æ¥ï¼Œå¹¶åˆ†é…å¤„ç†çº¿ç¨‹</h3>
<p>é¦–å…ˆï¼Œä¸»çº¿ç¨‹è´Ÿè´£æ¥æ”¶å»ºç«‹è¿æ¥è¯·æ±‚ã€‚å½“æœ‰å®¢æˆ·ç«¯è¯·æ±‚å’Œå®ä¾‹å»ºç«‹Socketè¿æ¥æ—¶ï¼Œä¸»çº¿ç¨‹ä¼šåˆ›å»ºå’Œå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå¹¶æŠŠ Socket æ”¾å…¥å…¨å±€ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚ç´§æ¥ç€ï¼Œä¸»çº¿ç¨‹é€šè¿‡è½®è¯¢æ–¹æ³•æŠŠSocketè¿æ¥åˆ†é…ç»™IOçº¿ç¨‹ã€‚</p>
<h3 id="112-é˜¶æ®µäºŒioçº¿ç¨‹è¯»å–å¹¶è§£æè¯·æ±‚">1.1.2 é˜¶æ®µäºŒï¼šIOçº¿ç¨‹è¯»å–å¹¶è§£æè¯·æ±‚</h3>
<p>ä¸»çº¿ç¨‹ä¸€æ—¦æŠŠSocketåˆ†é…ç»™IOçº¿ç¨‹ï¼Œå°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…IOçº¿ç¨‹å®Œæˆå®¢æˆ·ç«¯è¯·æ±‚è¯»å–å’Œè§£æã€‚å› ä¸ºæœ‰å¤šä¸ªIOçº¿ç¨‹åœ¨å¹¶è¡Œå¤„ç†ã€‚</p>
<h3 id="113-é˜¶æ®µä¸‰ä¸»çº¿ç¨‹æ‰§è¡Œè¯·æ±‚æ“ä½œ">1.1.3 é˜¶æ®µä¸‰ï¼šä¸»çº¿ç¨‹æ‰§è¡Œè¯·æ±‚æ“ä½œ</h3>
<p>ç­‰åˆ°IOçº¿ç¨‹è§£æå®Œè¯·æ±‚ï¼Œä¸»çº¿ç¨‹è¿˜æ˜¯ä¼šä»¥å•çº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œè¿™äº›å‘½ä»¤æ“ä½œã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1662536175466.png" alt="ä¸»çº¿ç¨‹æ‰§è¡Œè¯·æ±‚æ“ä½œ" loading="lazy"></figure>
<h3 id="114-é˜¶æ®µå››ioçº¿ç¨‹å›å†™socketå’Œä¸»çº¿ç¨‹æ¸…ç©ºå…¨å±€é˜Ÿåˆ—">1.1.4 é˜¶æ®µå››ï¼šIOçº¿ç¨‹å›å†™Socketå’Œä¸»çº¿ç¨‹æ¸…ç©ºå…¨å±€é˜Ÿåˆ—</h3>
<p>å½“ä¸»çº¿ç¨‹æ‰§è¡Œå®Œè¯·æ±‚æ“ä½œåï¼Œä¼šæŠŠéœ€è¦è¿”å›çš„ç»“æœå†™å…¥ç¼“å†²åŒºï¼Œç„¶åï¼Œä¸»çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…IOçº¿ç¨‹æŠŠè¿™äº›ç»“æœå›å†™åˆ°Socketä¸­ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>å’ŒIOçº¿ç¨‹è¯»å–å’Œè§£æè¯·æ±‚ä¸€æ ·ï¼ŒIOçº¿ç¨‹å›å†™Socketæ—¶ï¼Œä¹Ÿæ˜¯æœ‰å¤šä¸ªçº¿ç¨‹åœ¨å¹¶å‘æ‰§è¡Œï¼Œæ‰€ä»¥å›å†™Socketçš„é€Ÿåº¦ä¹Ÿå¾ˆå¿«ã€‚ç­‰åˆ°IOçº¿ç¨‹å›å†™Socketå®Œæ¯•ï¼Œä¸»çº¿ç¨‹ä¼šæ¸…ç©ºå…¨å±€é˜Ÿåˆ—ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„åç»­è¯·æ±‚ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1662536234785.png" alt="IOçº¿ç¨‹å›å†™Socketå’Œä¸»çº¿ç¨‹æ¸…ç©ºå…¨å±€é˜Ÿåˆ—" loading="lazy"></figure>
<h2 id="12-å¼€å¯å¤šçº¿ç¨‹">1.2 å¼€å¯å¤šçº¿ç¨‹</h2>
<p>åœ¨Redis 6.0ä¸­ï¼Œå¤šçº¿ç¨‹æœºåˆ¶é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹åŠŸèƒ½ï¼Œéœ€è¦åœ¨redis.confä¸­å®Œæˆä¸¤ä¸ªè®¾ç½®ã€‚</p>
<ol>
<li><strong>è®¾ç½®io-thread-do-readsé…ç½®é¡¹ä¸ºyesï¼Œè¡¨ç¤ºå¯ç”¨å¤šçº¿ç¨‹ã€‚</strong></li>
</ol>
<blockquote>
<p>io-threads-do-reads yes</p>
</blockquote>
<ol start="2">
<li><strong>è®¾ç½®çº¿ç¨‹ä¸ªæ•°</strong></li>
</ol>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œçº¿ç¨‹ä¸ªæ•°è¦å°äºRediså®ä¾‹æ‰€åœ¨æœºå™¨çš„CPUæ ¸ä¸ªæ•°ï¼Œä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ª8æ ¸çš„æœºå™¨æ¥è¯´ï¼ŒRediså®˜æ–¹å»ºè®®é…ç½®6ä¸ªIOçº¿ç¨‹ã€‚</p>
<blockquote>
<p>io-threads  6</p>
</blockquote>
<h1 id="2-å®ç°æœåŠ¡ç«¯ååŠ©çš„å®¢æˆ·ç«¯ç¼“å­˜">2 å®ç°æœåŠ¡ç«¯ååŠ©çš„å®¢æˆ·ç«¯ç¼“å­˜</h1>
<p>å’Œä¹‹å‰çš„ç‰ˆæœ¬ç›¸æ¯”ï¼ŒRedis 6.0æ–°å¢äº†ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼Œå°±æ˜¯å®ç°äº†æœåŠ¡ç«¯ååŠ©çš„å®¢æˆ·ç«¯ç¼“å­˜åŠŸèƒ½ï¼Œä¹Ÿç§°ä¸ºè·Ÿè¸ªï¼ˆTrackingï¼‰åŠŸèƒ½ã€‚æœ‰äº†è¿™ä¸ªåŠŸèƒ½ï¼Œä¸šåŠ¡åº”ç”¨ä¸­çš„Rediså®¢æˆ·ç«¯å°±å¯ä»¥æŠŠè¯»å–çš„æ•°æ®ç¼“å­˜åœ¨ä¸šåŠ¡åº”ç”¨æœ¬åœ°äº†ï¼Œåº”ç”¨å°±å¯ä»¥ç›´æ¥åœ¨æœ¬åœ°å¿«é€Ÿè¯»å–æ•°æ®äº†ã€‚</p>
<p>ä¸è¿‡ï¼Œå½“æŠŠæ•°æ®ç¼“å­˜åœ¨å®¢æˆ·ç«¯æœ¬åœ°æ—¶ï¼Œæˆ‘ä»¬ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæ•°æ®è¢«ä¿®æ”¹äº†æˆ–æ˜¯å¤±æ•ˆäº†ï¼Œå¦‚ä½•é€šçŸ¥å®¢æˆ·ç«¯å¯¹ç¼“å­˜çš„æ•°æ®åšå¤±æ•ˆå¤„ç†ï¼Ÿ</p>
<p>6.0å®ç°çš„TrackingåŠŸèƒ½å®ç°äº†ä¸¤ç§æ¨¡å¼ï¼Œæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="21-æ™®é€šæ¨¡å¼">2.1 æ™®é€šæ¨¡å¼</h2>
<p>åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œå®ä¾‹ä¼šåœ¨æœåŠ¡ç«¯è®°å½•å®¢æˆ·ç«¯è¯»å–è¿‡çš„keyï¼Œå¹¶ç›‘æµ‹keyæ˜¯å¦æœ‰ä¿®æ”¹ã€‚ä¸€æ—¦keyçš„å€¼å‘ç”Ÿå˜åŒ–ï¼ŒæœåŠ¡ç«¯ä¼šç»™å®¢æˆ·ç«¯å‘é€<strong>invalidate</strong>æ¶ˆæ¯ï¼Œé€šçŸ¥å®¢æˆ·ç«¯ç¼“å­˜å¤±æ•ˆäº†ã€‚</p>
<p>åœ¨ä½¿ç”¨æ™®é€šæ¨¡å¼æ—¶ï¼ŒæœåŠ¡ç«¯å¯¹äºè®°å½•çš„keyåªä¼šæŠ¥å‘Šä¸€æ¬¡invalidateæ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒæœåŠ¡ç«¯åœ¨ç»™å®¢æˆ·ç«¯å‘é€è¿‡ä¸€æ¬¡invalidateæ¶ˆæ¯åï¼Œå¦‚æœkeyå†è¢«ä¿®æ”¹ï¼Œæ­¤æ—¶ï¼ŒæœåŠ¡ç«¯å°±ä¸ä¼šå†æ¬¡ç»™å®¢æˆ·ç«¯å‘é€invalidateæ¶ˆæ¯ã€‚</p>
<p>åªæœ‰å½“å®¢æˆ·ç«¯å†æ¬¡æ‰§è¡Œè¯»å‘½ä»¤æ—¶ï¼ŒæœåŠ¡ç«¯æ‰ä¼šå†æ¬¡ç›‘æµ‹è¢«è¯»å–çš„keyï¼Œå¹¶åœ¨keyä¿®æ”¹æ—¶å‘é€invalidateæ¶ˆæ¯ã€‚è¿™æ ·è®¾è®¡çš„è€ƒè™‘æ˜¯èŠ‚çœæœ‰é™çš„å†…å­˜ç©ºé—´ã€‚æ¯•ç«Ÿï¼Œå¦‚æœå®¢æˆ·ç«¯ä¸å†è®¿é—®è¿™ä¸ªkeyäº†ï¼Œè€ŒæœåŠ¡ç«¯ä»ç„¶è®°å½•keyçš„ä¿®æ”¹æƒ…å†µï¼Œå°±ä¼šæµªè´¹å†…å­˜èµ„æºã€‚</p>
<p>é€šè¿‡æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œæ‰“å¼€æˆ–å…³é—­æ™®é€šæ¨¡å¼ä¸‹çš„TrackingåŠŸèƒ½ã€‚</p>
<blockquote>
<p>CLIENT TRACKING ON|OFF</p>
</blockquote>
<h2 id="22-å¹¿æ’­æ¨¡å¼">2.2 å¹¿æ’­æ¨¡å¼</h2>
<p>åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼ŒæœåŠ¡ç«¯ä¼šç»™å®¢æˆ·ç«¯å¹¿æ’­æ‰€æœ‰keyçš„å¤±æ•ˆæƒ…å†µï¼Œä¸è¿‡ï¼Œè¿™æ ·åšäº†ä¹‹åï¼Œå¦‚æœkey è¢«é¢‘ç¹ä¿®æ”¹ï¼ŒæœåŠ¡ç«¯ä¼šå‘é€å¤§é‡çš„å¤±æ•ˆå¹¿æ’­æ¶ˆæ¯ï¼Œè¿™å°±ä¼šæ¶ˆè€—å¤§é‡çš„ç½‘ç»œå¸¦å®½èµ„æºã€‚</p>
<p>æ‰€ä»¥ï¼Œåœ¨å®é™…åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¼šè®©å®¢æˆ·ç«¯æ³¨å†Œå¸Œæœ›è·Ÿè¸ªçš„keyçš„å‰ç¼€ï¼Œå½“å¸¦æœ‰æ³¨å†Œå‰ç¼€çš„keyè¢«ä¿®æ”¹æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šæŠŠå¤±æ•ˆæ¶ˆæ¯å¹¿æ’­ç»™æ‰€æœ‰æ³¨å†Œçš„å®¢æˆ·ç«¯ã€‚</p>
<p><strong>å’Œæ™®é€šæ¨¡å¼ä¸åŒï¼Œåœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œå³ä½¿å®¢æˆ·ç«¯è¿˜æ²¡æœ‰è¯»å–è¿‡keyï¼Œä½†åªè¦å®ƒæ³¨å†Œäº†è¦è·Ÿè¸ªçš„keyï¼ŒæœåŠ¡ç«¯éƒ½ä¼šæŠŠkeyå¤±æ•ˆæ¶ˆæ¯é€šçŸ¥ç»™è¿™ä¸ªå®¢æˆ·ç«¯ã€‚</strong></p>
<p>æ³¨å†Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>CLIENT TRACKING ON BCAST PREFIX user</p>
</blockquote>
<p>æ™®é€šæ¨¡å¼å’Œå¹¿æ’­æ¨¡å¼ï¼Œéœ€è¦å®¢æˆ·ç«¯ä½¿ç”¨RESP 3åè®®ï¼ŒRESP 3åè®®æ˜¯6.0æ–°å¯ç”¨çš„é€šä¿¡åè®®ã€‚</p>
<h2 id="23-resp-2åè®®">2.3 RESP 2åè®®</h2>
<p>å¯¹äºä½¿ç”¨RESP 2åè®®çš„å®¢æˆ·ç«¯æ¥è¯´ï¼Œå°±éœ€è¦ä½¿ç”¨å¦ä¸€ç§æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯<strong>é‡å®šå‘æ¨¡å¼ï¼ˆredirectï¼‰</strong>ã€‚åœ¨é‡å®šå‘æ¨¡å¼ä¸‹ï¼Œæƒ³è¦è·å¾—å¤±æ•ˆæ¶ˆæ¯é€šçŸ¥çš„å®¢æˆ·ç«¯ï¼Œå°±éœ€è¦æ‰§è¡Œè®¢é˜…å‘½ä»¤<strong>SUBSCRIBE</strong>ï¼Œä¸“é—¨è®¢é˜…ç”¨äºå‘é€å¤±æ•ˆæ¶ˆæ¯çš„é¢‘é“_redis_:invalidateã€‚åŒæ—¶ï¼Œå†ä½¿ç”¨å¦å¤–ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œæ‰§è¡ŒCLIENT TRACKINGå‘½ä»¤ï¼Œè®¾ç½®æœåŠ¡ç«¯å°†å¤±æ•ˆæ¶ˆæ¯è½¬å‘ç»™ä½¿ç”¨RESP 2åè®®çš„å®¢æˆ·ç«¯ã€‚</p>
<p>å‡è®¾å®¢æˆ·ç«¯Bæƒ³è¦è·å–å¤±æ•ˆæ¶ˆæ¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯Båªæ”¯æŒRESP 2åè®®ï¼Œå®¢æˆ·ç«¯Aæ”¯æŒRESP 3åè®®ã€‚æˆ‘ä»¬å¯ä»¥åˆ†åˆ«åœ¨å®¢æˆ·ç«¯Bå’ŒAä¸Šæ‰§è¡ŒSUBSCRIBEå’ŒCLIENT TRACKINGï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-redis">//å®¢æˆ·ç«¯Bæ‰§è¡Œï¼Œå®¢æˆ·ç«¯Bçš„IDå·æ˜¯303
SUBSCRIBE _redis_:invalidate

//å®¢æˆ·ç«¯Aæ‰§è¡Œ
CLIENT TRACKING ON BCAST REDIRECT 303
</code></pre>
<p>è¿™æ ·è®¾ç½®ä»¥åï¼Œå¦‚æœæœ‰é”®å€¼å¯¹è¢«ä¿®æ”¹äº†ï¼Œå®¢æˆ·ç«¯Bå°±å¯ä»¥é€šè¿‡_redis_:invalidateé¢‘é“ï¼Œè·å¾—å¤±æ•ˆæ¶ˆæ¯äº†ã€‚</p>
<h1 id="3-å®ä¾‹çš„è®¿é—®æƒé™æ§åˆ¶åˆ—è¡¨åŠŸèƒ½access-control-listacl">3 å®ä¾‹çš„è®¿é—®æƒé™æ§åˆ¶åˆ—è¡¨åŠŸèƒ½ï¼ˆAccess Control Listï¼ŒACLï¼‰</h1>
<h2 id="31-ä»ç®€å•çš„åŸºäºå¯†ç è®¿é—®åˆ°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶">3.1 ä»ç®€å•çš„åŸºäºå¯†ç è®¿é—®åˆ°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶</h2>
<p>åœ¨Redis 6.0 ç‰ˆæœ¬ä¹‹å‰ï¼Œè¦æƒ³å®ç°å®ä¾‹çš„å®‰å…¨è®¿é—®ï¼Œåªèƒ½é€šè¿‡è®¾ç½®å¯†ç æ¥æ§åˆ¶ï¼Œä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯è¿æ¥å®ä¾‹å‰éœ€è¦è¾“å…¥å¯†ç ã€‚</p>
<p>æ­¤å¤–ï¼Œå¯¹äºä¸€äº›é«˜é£é™©çš„å‘½ä»¤ï¼ˆä¾‹å¦‚KEYSã€FLUSHDBã€FLUSHALLç­‰ï¼‰ï¼Œåœ¨Redis 6.0 ä¹‹å‰ï¼Œæˆ‘ä»¬ä¹Ÿåªèƒ½é€šè¿‡rename-commandæ¥é‡æ–°å‘½åè¿™äº›å‘½ä»¤ï¼Œé¿å…å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨ã€‚</p>
<p>Redis 6.0 æä¾›äº†æ›´åŠ ç»†ç²’åº¦çš„è®¿é—®æƒé™æ§åˆ¶ï¼Œè¿™ä¸»è¦æœ‰ä¸¤æ–¹é¢çš„ä½“ç°ã€‚</p>
<p>é¦–å…ˆï¼Œ6.0ç‰ˆæœ¬æ”¯æŒåˆ›å»ºä¸åŒç”¨æˆ·æ¥ä½¿ç”¨Redisã€‚åœ¨6.0ç‰ˆæœ¬å‰ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªå¯†ç è¿›è¡Œç™»å½•ä½¿ç”¨ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨æˆ·çš„æ¦‚å¿µï¼Œè€Œåœ¨6.0ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ACL SETUSERå‘½ä»¤åˆ›å»ºç”¨æˆ·ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ›å»ºå¹¶å¯ç”¨ä¸€ä¸ªç”¨æˆ·normaluserï¼ŒæŠŠå®ƒçš„å¯†ç è®¾ç½®ä¸ºâ€œabcâ€ï¼š</p>
<blockquote>
<p>ACL SETUSER normaluser on &gt; abc</p>
</blockquote>
<p>å¦å¤–ï¼Œ6.0ç‰ˆæœ¬è¿˜æ”¯æŒä»¥ç”¨æˆ·ä¸ºç²’åº¦è®¾ç½®å‘½ä»¤æ“ä½œçš„è®¿é—®æƒé™ã€‚åŠ å·ï¼ˆ+ï¼‰å’Œå‡å·ï¼ˆ-ï¼‰å°±åˆ†åˆ«è¡¨ç¤ºç»™ç”¨æˆ·èµ‹äºˆæˆ–æ’¤é”€å‘½ä»¤çš„è°ƒç”¨æƒé™ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬è¦è®¾ç½®ç”¨æˆ·normaluseråªèƒ½è°ƒç”¨Hashç±»å‹çš„å‘½ä»¤æ“ä½œï¼Œè€Œä¸èƒ½è°ƒç”¨Stringç±»å‹çš„å‘½ä»¤æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<blockquote>
<p>ACL SETUSER normaluser +@hash -@string</p>
</blockquote>
<p>é™¤äº†è®¾ç½®æŸä¸ªå‘½ä»¤æˆ–æŸç±»å‘½ä»¤çš„è®¿é—®æ§åˆ¶æƒé™ï¼Œ6.0ç‰ˆæœ¬è¿˜æ”¯æŒä»¥keyä¸ºç²’åº¦è®¾ç½®è®¿é—®æƒé™ã€‚</p>
<p>å…·ä½“çš„åšæ³•æ˜¯ä½¿ç”¨æ³¢æµªå·â€œ~â€å’Œkeyçš„å‰ç¼€æ¥è¡¨ç¤ºæ§åˆ¶è®¿é—®çš„keyã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œå°±å¯ä»¥è®¾ç½®ç”¨æˆ·normaluseråªèƒ½å¯¹ä»¥â€œuser:â€ä¸ºå‰ç¼€çš„keyè¿›è¡Œå‘½ä»¤æ“ä½œï¼š</p>
<blockquote>
<p>ACL SETUSER normaluser ~user:* +@all</p>
</blockquote>
<h1 id="4-å¯ç”¨resp-3åè®®">4 å¯ç”¨RESP 3åè®®</h1>
<p>Redis 6.0å®ç°äº†RESP 3é€šä¿¡åè®®ï¼Œè€Œä¹‹å‰éƒ½æ˜¯ä½¿ç”¨çš„RESP 2ã€‚åœ¨RESP 2ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„é€šä¿¡å†…å®¹éƒ½æ˜¯ä»¥å­—èŠ‚æ•°ç»„å½¢å¼è¿›è¡Œç¼–ç çš„ï¼Œå®¢æˆ·ç«¯éœ€è¦æ ¹æ®æ“ä½œçš„å‘½ä»¤æˆ–æ˜¯æ•°æ®ç±»å‹è‡ªè¡Œå¯¹ä¼ è¾“çš„æ•°æ®è¿›è¡Œè§£ç ï¼Œå¢åŠ äº†å®¢æˆ·ç«¯å¼€å‘å¤æ‚åº¦ã€‚</p>
<p>è€ŒRESP 3ç›´æ¥æ”¯æŒå¤šç§æ•°æ®ç±»å‹çš„åŒºåˆ†ç¼–ç ï¼ŒåŒ…æ‹¬ç©ºå€¼ã€æµ®ç‚¹æ•°ã€å¸ƒå°”å€¼ã€æœ‰åºçš„å­—å…¸é›†åˆã€æ— åºçš„é›†åˆç­‰ã€‚</p>
<p>æ‰€è°“åŒºåˆ†ç¼–ç ï¼Œå°±æ˜¯æŒ‡ç›´æ¥é€šè¿‡ä¸åŒçš„å¼€å¤´å­—ç¬¦ï¼ŒåŒºåˆ†ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥ç›´æ¥é€šè¿‡åˆ¤æ–­ä¼ é€’æ¶ˆæ¯çš„å¼€å¤´å­—ç¬¦ï¼Œæ¥å®ç°æ•°æ®è½¬æ¢æ“ä½œäº†ï¼Œæå‡äº†å®¢æˆ·ç«¯çš„æ•ˆç‡ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRESP 3åè®®è¿˜å¯ä»¥æ”¯æŒå®¢æˆ·ç«¯ä»¥æ™®é€šæ¨¡å¼å’Œå¹¿æ’­æ¨¡å¼å®ç°å®¢æˆ·ç«¯ç¼“å­˜ã€‚</p>
]]></content>
    </entry>
</feed>