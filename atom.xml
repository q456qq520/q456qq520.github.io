<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://q456qq520.github.io</id>
    <title>LIKE CAT</title>
    <updated>2022-08-17T03:37:38.124Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://q456qq520.github.io"/>
    <link rel="self" href="https://q456qq520.github.io/atom.xml"/>
    <subtitle>ä¸€æ¡å°å’¸é±¼</subtitle>
    <logo>https://q456qq520.github.io/images/avatar.png</logo>
    <icon>https://q456qq520.github.io/favicon.ico</icon>
    <rights>All rights reserved 2022, LIKE CAT</rights>
    <entry>
        <title type="html"><![CDATA[JAVAå¹¶å‘ï¼ˆä¸‰ï¼‰]]></title>
        <id>https://q456qq520.github.io/post/java-bing-fa-san/</id>
        <link href="https://q456qq520.github.io/post/java-bing-fa-san/">
        </link>
        <updated>2022-08-16T03:20:47.000Z</updated>
        <content type="html"><![CDATA[<h1 id="5-javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶">5 Javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶ã€</h1>
<h2 id="51-concurrenthashmapçš„å®ç°åŸç†ä¸ä½¿ç”¨">5.1 ConcurrentHashMapçš„å®ç°åŸç†ä¸ä½¿ç”¨</h2>
<h3 id="511-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨concurrenthashmap">5.1.1 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ConcurrentHashMap</h3>
<p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ä½¿ç”¨HashMapå¯èƒ½å¯¼è‡´ç¨‹åºæ­»å¾ªç¯ã€‚è€Œä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„HashTableæ•ˆç‡åˆéå¸¸ä½ä¸‹ï¼ŒåŸºäºä»¥ä¸Šä¸¤ä¸ªåŸå› ï¼Œä¾¿æœ‰äº†ConcurrentHashMapçš„ç™»åœºæœºä¼šã€‚</p>
<h5 id="1çº¿ç¨‹ä¸å®‰å…¨çš„hashmap">ï¼ˆ1ï¼‰çº¿ç¨‹ä¸å®‰å…¨çš„HashMap</h5>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨HashMapè¿›è¡Œputæ“ä½œä¼šå¼•èµ·æ­»å¾ªç¯ï¼Œå¯¼è‡´CPUåˆ©ç”¨ç‡æ¥è¿‘100%ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨HashMapã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-java">final HashMap&lt;String, String&gt; map = new HashMap&lt;String, String&gt;(2);
Thread t = new Thread(new Runnable() {
    @Override
    public void run() {
        for (int i = 0; i &lt; 10000; i++) {
            new Thread(new Runnable() {
                @Override
                public void run() {
                    map.put(UUID.randomUUID().toString(), &quot;&quot;);
                }
            }, &quot;ftf&quot; + i).start();
        }
    }
}, &quot;ftf&quot;);
t.start();
t.join();
</code></pre>
<p>HashMapåœ¨å¹¶å‘æ‰§è¡Œputæ“ä½œæ—¶ä¼šå¼•èµ·æ­»å¾ªç¯ï¼Œ<strong>æ˜¯å› ä¸ºå¤šçº¿ç¨‹ä¼šå¯¼è‡´HashMapçš„Entryé“¾è¡¨å½¢æˆç¯å½¢æ•°æ®ç»“æ„ï¼Œä¸€æ—¦å½¢æˆç¯å½¢æ•°æ®ç»“æ„ï¼ŒEntryçš„nextèŠ‚ç‚¹æ°¸è¿œä¸ä¸ºç©ºï¼Œå°±ä¼šäº§ç”Ÿæ­»å¾ªç¯è·å–Entryã€‚</strong></p>
<h5 id="2æ•ˆç‡ä½ä¸‹çš„hashtable">ï¼ˆ2ï¼‰æ•ˆç‡ä½ä¸‹çš„HashTable</h5>
<p>HashTableå®¹å™¨ä½¿ç”¨synchronizedæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†åœ¨çº¿ç¨‹ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹HashTableçš„æ•ˆç‡éå¸¸ä½ä¸‹ã€‚å› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®HashTableçš„åŒæ­¥æ–¹æ³•ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿè®¿é—®HashTableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œä¼šè¿›å…¥é˜»å¡æˆ–è½®è¯¢çŠ¶æ€ã€‚å¦‚çº¿ç¨‹1ä½¿ç”¨putè¿›è¡Œå…ƒç´ æ·»åŠ ï¼Œçº¿ç¨‹2ä¸ä½†ä¸èƒ½ä½¿ç”¨putæ–¹æ³•æ·»åŠ å…ƒç´ ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨getæ–¹æ³•æ¥è·å–å…ƒç´ ï¼Œæ‰€ä»¥ç«äº‰è¶Šæ¿€çƒˆæ•ˆç‡è¶Šä½ã€‚</p>
<h5 id="3concurrenthashmapçš„é”åˆ†æ®µæŠ€æœ¯å¯æœ‰æ•ˆæå‡å¹¶å‘è®¿é—®ç‡">ï¼ˆ3ï¼‰ConcurrentHashMapçš„é”åˆ†æ®µæŠ€æœ¯å¯æœ‰æ•ˆæå‡å¹¶å‘è®¿é—®ç‡</h5>
<p>ConcurrentHashMapæ‰€ä½¿ç”¨çš„é”åˆ†æ®µæŠ€æœ¯ï¼Œé¦–å…ˆå°†æ•°æ®åˆ†æˆä¸€æ®µä¸€æ®µåœ°å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®çš„æ—¶å€™ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚</p>
<h3 id="512-concurrenthashmapçš„ç»“æ„">5.1.2 ConcurrentHashMapçš„ç»“æ„</h3>
<p>åœ¨JDK1.5~1.7ç‰ˆæœ¬ï¼ŒJavaä½¿ç”¨äº†åˆ†æ®µé”æœºåˆ¶å®ç°ConcurrentHashMap.</p>
<p>ç®€è€Œè¨€ä¹‹ï¼ŒConcurrentHashMapåœ¨å¯¹è±¡ä¸­ä¿å­˜äº†ä¸€ä¸ªSegmentæ•°ç»„ï¼Œå³å°†æ•´ä¸ªHashè¡¨åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†æ®µï¼›è€Œæ¯ä¸ªSegmentå…ƒç´ ï¼Œå³æ¯ä¸ªåˆ†æ®µåˆ™ç±»ä¼¼äºä¸€ä¸ªHashtableï¼›è¿™æ ·ï¼Œåœ¨æ‰§è¡Œputæ“ä½œæ—¶é¦–å…ˆæ ¹æ®hashç®—æ³•å®šä½åˆ°å…ƒç´ å±äºå“ªä¸ªSegmentï¼Œç„¶åå¯¹è¯¥SegmentåŠ é”å³å¯ã€‚å› æ­¤ï¼ŒConcurrentHashMapåœ¨å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹ä¸­å¯æ˜¯å®ç°å¤šçº¿ç¨‹putæ“ä½œã€‚</p>
<p>åœ¨JDK1.7ä¹‹å‰ï¼ŒConcurrentHashMapæ˜¯é€šè¿‡åˆ†æ®µé”æœºåˆ¶æ¥å®ç°çš„ï¼Œæ‰€ä»¥å…¶æœ€å¤§å¹¶å‘åº¦å—Segmentçš„ä¸ªæ•°é™åˆ¶ã€‚å› æ­¤ï¼Œåœ¨JDK1.8ä¸­ï¼ŒConcurrentHashMapçš„å®ç°åŸç†æ‘’å¼ƒäº†è¿™ç§è®¾è®¡ï¼Œè€Œæ˜¯é€‰æ‹©äº†ä¸HashMapç±»ä¼¼çš„æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ–¹å¼å®ç°ï¼Œè€ŒåŠ é”åˆ™é‡‡ç”¨CASå’Œsynchronizedå®ç°ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1660640046350.png" alt="" loading="lazy"></figure>
<h3 id="513-åˆå§‹åŒ–">5.1.3 åˆå§‹åŒ–</h3>
<pre><code class="language-java">// è¿™æ„é€ å‡½æ•°é‡Œï¼Œä»€ä¹ˆéƒ½ä¸å¹²
public ConcurrentHashMap() {
}
public ConcurrentHashMap(int initialCapacity) {
    if (initialCapacity &lt; 0)
        throw new IllegalArgumentException();
    int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ?
               MAXIMUM_CAPACITY :
               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1));
    this.sizeCtl = cap;
}
</code></pre>
<p>é€šè¿‡æä¾›åˆå§‹å®¹é‡ï¼Œè®¡ç®—äº† sizeCtlï¼ŒsizeCtl = ã€ (1.5 * initialCapacity + 1)ï¼Œç„¶åå‘ä¸Šå–æœ€è¿‘çš„ 2 çš„ n æ¬¡æ–¹ã€‘ã€‚å¦‚ initialCapacity ä¸º 10ï¼Œé‚£ä¹ˆå¾—åˆ° sizeCtl ä¸º 16ï¼Œå¦‚æœ initialCapacity ä¸º 11ï¼Œå¾—åˆ° sizeCtl ä¸º 32ã€‚</p>
<h3 id="514-concurrenthashmapçš„æ“ä½œ">5.1.4 ConcurrentHashMapçš„æ“ä½œ</h3>
<h5 id="1put">1.put</h5>
<pre><code class="language-java">public V put(K key, V value) {
    return putVal(key, value, false);
}
final V putVal(K key, V value, boolean onlyIfAbsent) {
    if (key == null || value == null) throw new NullPointerException();
    // å¾—åˆ° hash å€¼
    int hash = spread(key.hashCode());
    // ç”¨äºè®°å½•ç›¸åº”é“¾è¡¨çš„é•¿åº¦
    int binCount = 0;
    for (Node&lt;K,V&gt;[] tab = table;;) {
        Node&lt;K,V&gt; f; int n, i, fh;
        // å¦‚æœæ•°ç»„&quot;ç©º&quot;ï¼Œè¿›è¡Œæ•°ç»„åˆå§‹åŒ–
        if (tab == null || (n = tab.length) == 0)
            // åˆå§‹åŒ–æ•°ç»„ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»
            tab = initTable();

        // æ‰¾è¯¥ hash å€¼å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¾—åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ f
        else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) {
            // å¦‚æœæ•°ç»„è¯¥ä½ç½®ä¸ºç©ºï¼Œ
            //    ç”¨ä¸€æ¬¡ CAS æ“ä½œå°†è¿™ä¸ªæ–°å€¼æ”¾å…¥å…¶ä¸­å³å¯ï¼Œè¿™ä¸ª put æ“ä½œå·®ä¸å¤šå°±ç»“æŸäº†ï¼Œå¯ä»¥æ‹‰åˆ°æœ€åé¢äº†
            //          å¦‚æœ CAS å¤±è´¥ï¼Œé‚£å°±æ˜¯æœ‰å¹¶å‘æ“ä½œï¼Œè¿›åˆ°ä¸‹ä¸€ä¸ªå¾ªç¯å°±å¥½äº†
            if (casTabAt(tab, i, null,
                         new Node&lt;K,V&gt;(hash, key, value, null)))
                break;                   // no lock when adding to empty bin
        }
        // hash å±…ç„¶å¯ä»¥ç­‰äº MOVEDï¼Œè¿™ä¸ªéœ€è¦åˆ°åé¢æ‰èƒ½çœ‹æ˜ç™½ï¼Œä¸è¿‡ä»åå­—ä¸Šä¹Ÿèƒ½çŒœåˆ°ï¼Œè‚¯å®šæ˜¯å› ä¸ºåœ¨æ‰©å®¹
        else if ((fh = f.hash) == MOVED)
            // å¸®åŠ©æ•°æ®è¿ç§»ï¼Œè¿™ä¸ªç­‰åˆ°çœ‹å®Œæ•°æ®è¿ç§»éƒ¨åˆ†çš„ä»‹ç»åï¼Œå†ç†è§£è¿™ä¸ªå°±å¾ˆç®€å•äº†
            tab = helpTransfer(tab, f);

        else { // åˆ°è¿™é‡Œå°±æ˜¯è¯´ï¼Œf æ˜¯è¯¥ä½ç½®çš„å¤´èŠ‚ç‚¹ï¼Œè€Œä¸”ä¸ä¸ºç©º

            V oldVal = null;
            // è·å–æ•°ç»„è¯¥ä½ç½®çš„å¤´èŠ‚ç‚¹çš„ç›‘è§†å™¨é”
            synchronized (f) {
                if (tabAt(tab, i) == f) {
                    if (fh &gt;= 0) { // å¤´èŠ‚ç‚¹çš„ hash å€¼å¤§äº 0ï¼Œè¯´æ˜æ˜¯é“¾è¡¨
                        // ç”¨äºç´¯åŠ ï¼Œè®°å½•é“¾è¡¨çš„é•¿åº¦
                        binCount = 1;
                        // éå†é“¾è¡¨
                        for (Node&lt;K,V&gt; e = f;; ++binCount) {
                            K ek;
                            // å¦‚æœå‘ç°äº†&quot;ç›¸ç­‰&quot;çš„ keyï¼Œåˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œå€¼è¦†ç›–ï¼Œç„¶åä¹Ÿå°±å¯ä»¥ break äº†
                            if (e.hash == hash &amp;&amp;
                                ((ek = e.key) == key ||
                                 (ek != null &amp;&amp; key.equals(ek)))) {
                                oldVal = e.val;
                                if (!onlyIfAbsent)
                                    e.val = value;
                                break;
                            }
                            // åˆ°äº†é“¾è¡¨çš„æœ€æœ«ç«¯ï¼Œå°†è¿™ä¸ªæ–°å€¼æ”¾åˆ°é“¾è¡¨çš„æœ€åé¢
                            Node&lt;K,V&gt; pred = e;
                            if ((e = e.next) == null) {
                                pred.next = new Node&lt;K,V&gt;(hash, key,
                                                          value, null);
                                break;
                            }
                        }
                    }
                    else if (f instanceof TreeBin) { // çº¢é»‘æ ‘
                        Node&lt;K,V&gt; p;
                        binCount = 2;
                        // è°ƒç”¨çº¢é»‘æ ‘çš„æ’å€¼æ–¹æ³•æ’å…¥æ–°èŠ‚ç‚¹
                        if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,
                                                       value)) != null) {
                            oldVal = p.val;
                            if (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                }
            }

            if (binCount != 0) {
                // åˆ¤æ–­æ˜¯å¦è¦å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œä¸´ç•Œå€¼å’Œ HashMap ä¸€æ ·ï¼Œä¹Ÿæ˜¯ 8
                if (binCount &gt;= TREEIFY_THRESHOLD)
                    // è¿™ä¸ªæ–¹æ³•å’Œ HashMap ä¸­ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹ä¸åŒï¼Œé‚£å°±æ˜¯å®ƒä¸æ˜¯ä¸€å®šä¼šè¿›è¡Œçº¢é»‘æ ‘è½¬æ¢ï¼Œ
                    // å¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©è¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘
                    //    å…·ä½“æºç æˆ‘ä»¬å°±ä¸çœ‹äº†ï¼Œæ‰©å®¹éƒ¨åˆ†åé¢è¯´
                    treeifyBin(tab, i);
                if (oldVal != null)
                    return oldVal;
                break;
            }
        }
    }
    // 
    addCount(1L, binCount);
    return null;
}
</code></pre>
<p>åˆå§‹åŒ–æ•°ç»„: initTable<br>
è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ï¼Œç„¶åä¼šè®¾ç½® sizeCtlã€‚</p>
<p>åˆå§‹åŒ–æ–¹æ³•ä¸­çš„å¹¶å‘é—®é¢˜æ˜¯é€šè¿‡å¯¹ sizeCtl è¿›è¡Œä¸€ä¸ª CAS æ“ä½œæ¥æ§åˆ¶çš„</p>
<pre><code class="language-java">private final Node&lt;K,V&gt;[] initTable() {
    Node&lt;K,V&gt;[] tab; int sc;
    while ((tab = table) == null || tab.length == 0) {
        if ((sc = sizeCtl) &lt; 0)
            Thread.yield(); // lost initialization race; just spin
        else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {
            try {
                if ((tab = table) == null || tab.length == 0) {
                    int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY;
                    @SuppressWarnings(&quot;unchecked&quot;)
                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n];
                    table = tab = nt;
                    sc = n - (n &gt;&gt;&gt; 2);
                }
            } finally {
                sizeCtl = sc;
            }
            break;
        }
    }
    return tab;
}
</code></pre>
<p><strong>é“¾è¡¨è½¬çº¢é»‘æ ‘: treeifyBin</strong><br>
treeifyBin ä¸ä¸€å®šå°±ä¼šè¿›è¡Œçº¢é»‘æ ‘è½¬æ¢ï¼Œä¹Ÿå¯èƒ½æ˜¯ä»…ä»…åšæ•°ç»„æ‰©å®¹ã€‚</p>
<pre><code class="language-java">private final void treeifyBin(Node&lt;K,V&gt;[] tab, int index) {
    Node&lt;K,V&gt; b; int n, sc;
    if (tab != null) {
        // MIN_TREEIFY_CAPACITY ä¸º 64
        // æ‰€ä»¥ï¼Œå¦‚æœæ•°ç»„é•¿åº¦å°äº 64 çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ 32 æˆ–è€… 16 æˆ–è€…æ›´å°çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œæ•°ç»„æ‰©å®¹
        if ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)
            // åé¢æˆ‘ä»¬å†è¯¦ç»†åˆ†æè¿™ä¸ªæ–¹æ³•
            tryPresize(n &lt;&lt; 1);
        // b æ˜¯å¤´èŠ‚ç‚¹
        else if ((b = tabAt(tab, index)) != null &amp;&amp; b.hash &gt;= 0) {
            // åŠ é”
            synchronized (b) {

                if (tabAt(tab, index) == b) {
                    // ä¸‹é¢å°±æ˜¯éå†é“¾è¡¨ï¼Œå»ºç«‹ä¸€é¢—çº¢é»‘æ ‘
                    TreeNode&lt;K,V&gt; hd = null, tl = null;
                    for (Node&lt;K,V&gt; e = b; e != null; e = e.next) {
                        TreeNode&lt;K,V&gt; p =
                            new TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,
                                              null, null);
                        if ((p.prev = tl) == null)
                            hd = p;
                        else
                            tl.next = p;
                        tl = p;
                    }
                    // å°†çº¢é»‘æ ‘è®¾ç½®åˆ°æ•°ç»„ç›¸åº”ä½ç½®ä¸­
                    setTabAt(tab, index, new TreeBin&lt;K,V&gt;(hd));
                }
            }
        }
    }
}
</code></pre>
<p><strong>æ‰©å®¹: tryPresize</strong></p>
<pre><code class="language-java"> // é¦–å…ˆè¦è¯´æ˜çš„æ˜¯ï¼Œæ–¹æ³•å‚æ•° size ä¼ è¿›æ¥çš„æ—¶å€™å°±å·²ç»ç¿»äº†å€äº†
private final void tryPresize(int size) {
    // c: size çš„ 1.5 å€ï¼Œå†åŠ  1ï¼Œå†å¾€ä¸Šå–æœ€è¿‘çš„ 2 çš„ n æ¬¡æ–¹ã€‚
    int c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY :
        tableSizeFor(size + (size &gt;&gt;&gt; 1) + 1);
    int sc;
    while ((sc = sizeCtl) &gt;= 0) {
        Node&lt;K,V&gt;[] tab = table; int n;

        // è¿™ä¸ª if åˆ†æ”¯å’Œä¹‹å‰è¯´çš„åˆå§‹åŒ–æ•°ç»„çš„ä»£ç åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨ç®¡è¿™å—ä»£ç 
        if (tab == null || (n = tab.length) == 0) {
            n = (sc &gt; c) ? sc : c;
            if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {
                try {
                    if (table == tab) {
                        @SuppressWarnings(&quot;unchecked&quot;)
                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n];
                        table = nt;
                        sc = n - (n &gt;&gt;&gt; 2); // 0.75 * n
                    }
                } finally {
                    sizeCtl = sc;
                }
            }
        }
        else if (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)
            break;
        else if (tab == table) {
            // æˆ‘æ²¡çœ‹æ‡‚ rs çš„çœŸæ­£å«ä¹‰æ˜¯ä»€ä¹ˆï¼Œä¸è¿‡ä¹Ÿå…³ç³»ä¸å¤§
            int rs = resizeStamp(n);

            if (sc &lt; 0) {
                Node&lt;K,V&gt;[] nt;
                if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||
                    sc == rs + MAX_RESIZERS || (nt = nextTable) == null ||
                    transferIndex &lt;= 0)
                    break;
                // 2. ç”¨ CAS å°† sizeCtl åŠ  1ï¼Œç„¶åæ‰§è¡Œ transfer æ–¹æ³•
                //    æ­¤æ—¶ nextTab ä¸ä¸º null
                if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))
                    transfer(tab, nt);
            }
            // 1. å°† sizeCtl è®¾ç½®ä¸º (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)
            //     æˆ‘æ˜¯æ²¡çœ‹æ‡‚è¿™ä¸ªå€¼çœŸæ­£çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ? ä¸è¿‡å¯ä»¥è®¡ç®—å‡ºæ¥çš„æ˜¯ï¼Œç»“æœæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„è´Ÿæ•°
            //  è°ƒç”¨ transfer æ–¹æ³•ï¼Œæ­¤æ—¶ nextTab å‚æ•°ä¸º null
            else if (U.compareAndSwapInt(this, SIZECTL, sc,
                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))
                transfer(tab, null);
        }
    }
}
</code></pre>
<p>è¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒåœ¨äº sizeCtl å€¼çš„æ“ä½œï¼Œé¦–å…ˆå°†å…¶è®¾ç½®ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼Œç„¶åæ‰§è¡Œ transfer(tab, null)ï¼Œå†ä¸‹ä¸€ä¸ªå¾ªç¯å°† sizeCtl åŠ  1ï¼Œå¹¶æ‰§è¡Œ transfer(tab, nt)ï¼Œä¹‹åå¯èƒ½æ˜¯ç»§ç»­ sizeCtl åŠ  1ï¼Œå¹¶æ‰§è¡Œ transfer(tab, nt)ã€‚ æ‰€ä»¥ï¼Œå¯èƒ½çš„æ“ä½œå°±æ˜¯æ‰§è¡Œ 1 æ¬¡ transfer(tab, null) + å¤šæ¬¡ transfer(tab, nt)ã€‚</p>
<p><strong>æ•°æ®è¿ç§»: transfer</strong></p>
<p>è‘—ä½œæƒå½’https://pdai.techæ‰€æœ‰ã€‚<br>
é“¾æ¥ï¼šhttps://pdai.tech/md/java/thread/java-thread-x-juc-collection-ConcurrentHashMap.html</p>
<p>åŸæ•°ç»„é•¿åº¦ä¸º nï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ n ä¸ªè¿ç§»ä»»åŠ¡ï¼Œè®©æ¯ä¸ªçº¿ç¨‹æ¯æ¬¡è´Ÿè´£ä¸€ä¸ªå°ä»»åŠ¡æ˜¯æœ€ç®€å•çš„ï¼Œæ¯åšå®Œä¸€ä¸ªä»»åŠ¡å†æ£€æµ‹æ˜¯å¦æœ‰å…¶ä»–æ²¡åšå®Œçš„ä»»åŠ¡ï¼Œå¸®åŠ©è¿ç§»å°±å¯ä»¥äº†ï¼Œè€Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ª strideï¼Œç®€å•ç†è§£å°±æ˜¯æ­¥é•¿ï¼Œæ¯ä¸ªçº¿ç¨‹æ¯æ¬¡è´Ÿè´£è¿ç§»å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚æ¯æ¬¡è¿ç§» 16 ä¸ªå°ä»»åŠ¡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªå…¨å±€çš„è°ƒåº¦è€…æ¥å®‰æ’å“ªä¸ªçº¿ç¨‹æ‰§è¡Œå“ªå‡ ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªå°±æ˜¯å±æ€§ transferIndex çš„ä½œç”¨ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå‘èµ·æ•°æ®è¿ç§»çš„çº¿ç¨‹ä¼šå°† transferIndex æŒ‡å‘åŸæ•°ç»„æœ€åçš„ä½ç½®ï¼Œç„¶åä»åå¾€å‰çš„ stride ä¸ªä»»åŠ¡å±äºç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åå°† transferIndex æŒ‡å‘æ–°çš„ä½ç½®ï¼Œå†å¾€å‰çš„ stride ä¸ªä»»åŠ¡å±äºç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œä¾æ­¤ç±»æ¨ã€‚å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ç¬¬äºŒä¸ªçº¿ç¨‹ä¸æ˜¯çœŸçš„ä¸€å®šæŒ‡ä»£äº†ç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå…¶å®å°±æ˜¯å°†ä¸€ä¸ªå¤§çš„è¿ç§»ä»»åŠ¡åˆ†ä¸ºäº†ä¸€ä¸ªä¸ªä»»åŠ¡åŒ…ã€‚</p>
<pre><code class="language-java">
private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) {
    int n = tab.length, stride;

    // stride åœ¨å•æ ¸ä¸‹ç›´æ¥ç­‰äº nï¼Œå¤šæ ¸æ¨¡å¼ä¸‹ä¸º (n&gt;&gt;&gt;3)/NCPUï¼Œæœ€å°å€¼æ˜¯ 16
    // stride å¯ä»¥ç†è§£ä¸ºâ€æ­¥é•¿â€œï¼Œæœ‰ n ä¸ªä½ç½®æ˜¯éœ€è¦è¿›è¡Œè¿ç§»çš„ï¼Œ
    //   å°†è¿™ n ä¸ªä»»åŠ¡åˆ†ä¸ºå¤šä¸ªä»»åŠ¡åŒ…ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…æœ‰ stride ä¸ªä»»åŠ¡
    if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)
        stride = MIN_TRANSFER_STRIDE; // subdivide range

    // å¦‚æœ nextTab ä¸º nullï¼Œå…ˆè¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–
    //    å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œå¤–å›´ä¼šä¿è¯ç¬¬ä¸€ä¸ªå‘èµ·è¿ç§»çš„çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œå‚æ•° nextTab ä¸º null
    //       ä¹‹åå‚ä¸è¿ç§»çš„çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼ŒnextTab ä¸ä¼šä¸º null
    if (nextTab == null) {
        try {
            // å®¹é‡ç¿»å€
            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1];
            nextTab = nt;
        } catch (Throwable ex) {      // try to cope with OOME
            sizeCtl = Integer.MAX_VALUE;
            return;
        }
        // nextTable æ˜¯ ConcurrentHashMap ä¸­çš„å±æ€§
        nextTable = nextTab;
        // transferIndex ä¹Ÿæ˜¯ ConcurrentHashMap çš„å±æ€§ï¼Œç”¨äºæ§åˆ¶è¿ç§»çš„ä½ç½®
        transferIndex = n;
    }

    int nextn = nextTab.length;

    // ForwardingNode ç¿»è¯‘è¿‡æ¥å°±æ˜¯æ­£åœ¨è¢«è¿ç§»çš„ Node
    // è¿™ä¸ªæ„é€ æ–¹æ³•ä¼šç”Ÿæˆä¸€ä¸ªNodeï¼Œkeyã€value å’Œ next éƒ½ä¸º nullï¼Œå…³é”®æ˜¯ hash ä¸º MOVED
    // åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼ŒåŸæ•°ç»„ä¸­ä½ç½® i å¤„çš„èŠ‚ç‚¹å®Œæˆè¿ç§»å·¥ä½œåï¼Œ
    //    å°±ä¼šå°†ä½ç½® i å¤„è®¾ç½®ä¸ºè¿™ä¸ª ForwardingNodeï¼Œç”¨æ¥å‘Šè¯‰å…¶ä»–çº¿ç¨‹è¯¥ä½ç½®å·²ç»å¤„ç†è¿‡äº†
    //    æ‰€ä»¥å®ƒå…¶å®ç›¸å½“äºæ˜¯ä¸€ä¸ªæ ‡å¿—ã€‚
    ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab);


    // advance æŒ‡çš„æ˜¯åšå®Œäº†ä¸€ä¸ªä½ç½®çš„è¿ç§»å·¥ä½œï¼Œå¯ä»¥å‡†å¤‡åšä¸‹ä¸€ä¸ªä½ç½®çš„äº†
    boolean advance = true;
    boolean finishing = false; // to ensure sweep before committing nextTab

    /*
     * ä¸‹é¢è¿™ä¸ª for å¾ªç¯ï¼Œæœ€éš¾ç†è§£çš„åœ¨å‰é¢ï¼Œè€Œè¦çœ‹æ‡‚å®ƒä»¬ï¼Œåº”è¯¥å…ˆçœ‹æ‡‚åé¢çš„ï¼Œç„¶åå†å€’å›æ¥çœ‹
     * 
     */

    // i æ˜¯ä½ç½®ç´¢å¼•ï¼Œbound æ˜¯è¾¹ç•Œï¼Œæ³¨æ„æ˜¯ä»åå¾€å‰
    for (int i = 0, bound = 0;;) {
        Node&lt;K,V&gt; f; int fh;

        // ä¸‹é¢è¿™ä¸ª while çœŸçš„æ˜¯ä¸å¥½ç†è§£
        // advance ä¸º true è¡¨ç¤ºå¯ä»¥è¿›è¡Œä¸‹ä¸€ä¸ªä½ç½®çš„è¿ç§»äº†
        //   ç®€å•ç†è§£ç»“å±€: i æŒ‡å‘äº† transferIndexï¼Œbound æŒ‡å‘äº† transferIndex-stride
        while (advance) {
            int nextIndex, nextBound;
            if (--i &gt;= bound || finishing)
                advance = false;

            // å°† transferIndex å€¼èµ‹ç»™ nextIndex
            // è¿™é‡Œ transferIndex ä¸€æ—¦å°äºç­‰äº 0ï¼Œè¯´æ˜åŸæ•°ç»„çš„æ‰€æœ‰ä½ç½®éƒ½æœ‰ç›¸åº”çš„çº¿ç¨‹å»å¤„ç†äº†
            else if ((nextIndex = transferIndex) &lt;= 0) {
                i = -1;
                advance = false;
            }
            else if (U.compareAndSwapInt
                     (this, TRANSFERINDEX, nextIndex,
                      nextBound = (nextIndex &gt; stride ?
                                   nextIndex - stride : 0))) {
                // çœ‹æ‹¬å·ä¸­çš„ä»£ç ï¼ŒnextBound æ˜¯è¿™æ¬¡è¿ç§»ä»»åŠ¡çš„è¾¹ç•Œï¼Œæ³¨æ„ï¼Œæ˜¯ä»åå¾€å‰
                bound = nextBound;
                i = nextIndex - 1;
                advance = false;
            }
        }
        if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) {
            int sc;
            if (finishing) {
                // æ‰€æœ‰çš„è¿ç§»æ“ä½œå·²ç»å®Œæˆ
                nextTable = null;
                // å°†æ–°çš„ nextTab èµ‹å€¼ç»™ table å±æ€§ï¼Œå®Œæˆè¿ç§»
                table = nextTab;
                // é‡æ–°è®¡ç®— sizeCtl: n æ˜¯åŸæ•°ç»„é•¿åº¦ï¼Œæ‰€ä»¥ sizeCtl å¾—å‡ºçš„å€¼å°†æ˜¯æ–°æ•°ç»„é•¿åº¦çš„ 0.75 å€
                sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1);
                return;
            }

            // ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒsizeCtl åœ¨è¿ç§»å‰ä¼šè®¾ç½®ä¸º (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2
            // ç„¶åï¼Œæ¯æœ‰ä¸€ä¸ªçº¿ç¨‹å‚ä¸è¿ç§»å°±ä¼šå°† sizeCtl åŠ  1ï¼Œ
            // è¿™é‡Œä½¿ç”¨ CAS æ“ä½œå¯¹ sizeCtl è¿›è¡Œå‡ 1ï¼Œä»£è¡¨åšå®Œäº†å±äºè‡ªå·±çš„ä»»åŠ¡
            if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) {
                // ä»»åŠ¡ç»“æŸï¼Œæ–¹æ³•é€€å‡º
                if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)
                    return;

                // åˆ°è¿™é‡Œï¼Œè¯´æ˜ (sc - 2) == resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFTï¼Œ
                // ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„è¿ç§»ä»»åŠ¡éƒ½åšå®Œäº†ï¼Œä¹Ÿå°±ä¼šè¿›å…¥åˆ°ä¸Šé¢çš„ if(finishing){} åˆ†æ”¯äº†
                finishing = advance = true;
                i = n; // recheck before commit
            }
        }
        // å¦‚æœä½ç½® i å¤„æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰ä»»ä½•èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ”¾å…¥åˆšåˆšåˆå§‹åŒ–çš„ ForwardingNode â€ç©ºèŠ‚ç‚¹â€œ
        else if ((f = tabAt(tab, i)) == null)
            advance = casTabAt(tab, i, null, fwd);
        // è¯¥ä½ç½®å¤„æ˜¯ä¸€ä¸ª ForwardingNodeï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»è¿‡äº†
        else if ((fh = f.hash) == MOVED)
            advance = true; // already processed
        else {
            // å¯¹æ•°ç»„è¯¥ä½ç½®å¤„çš„ç»“ç‚¹åŠ é”ï¼Œå¼€å§‹å¤„ç†æ•°ç»„è¯¥ä½ç½®å¤„çš„è¿ç§»å·¥ä½œ
            synchronized (f) {
                if (tabAt(tab, i) == f) {
                    Node&lt;K,V&gt; ln, hn;
                    // å¤´èŠ‚ç‚¹çš„ hash å¤§äº 0ï¼Œè¯´æ˜æ˜¯é“¾è¡¨çš„ Node èŠ‚ç‚¹
                    if (fh &gt;= 0) {
                        // ä¸‹é¢è¿™ä¸€å—å’Œ Java7 ä¸­çš„ ConcurrentHashMap è¿ç§»æ˜¯å·®ä¸å¤šçš„ï¼Œ
                        // éœ€è¦å°†é“¾è¡¨ä¸€åˆ†ä¸ºäºŒï¼Œ
                        //   æ‰¾åˆ°åŸé“¾è¡¨ä¸­çš„ lastRunï¼Œç„¶å lastRun åŠå…¶ä¹‹åçš„èŠ‚ç‚¹æ˜¯ä¸€èµ·è¿›è¡Œè¿ç§»çš„
                        //   lastRun ä¹‹å‰çš„èŠ‚ç‚¹éœ€è¦è¿›è¡Œå…‹éš†ï¼Œç„¶ååˆ†åˆ°ä¸¤ä¸ªé“¾è¡¨ä¸­
                        int runBit = fh &amp; n;
                        Node&lt;K,V&gt; lastRun = f;
                        for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) {
                            int b = p.hash &amp; n;
                            if (b != runBit) {
                                runBit = b;
                                lastRun = p;
                            }
                        }
                        if (runBit == 0) {
                            ln = lastRun;
                            hn = null;
                        }
                        else {
                            hn = lastRun;
                            ln = null;
                        }
                        for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) {
                            int ph = p.hash; K pk = p.key; V pv = p.val;
                            if ((ph &amp; n) == 0)
                                ln = new Node&lt;K,V&gt;(ph, pk, pv, ln);
                            else
                                hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);
                        }
                        // å…¶ä¸­çš„ä¸€ä¸ªé“¾è¡¨æ”¾åœ¨æ–°æ•°ç»„çš„ä½ç½® i
                        setTabAt(nextTab, i, ln);
                        // å¦ä¸€ä¸ªé“¾è¡¨æ”¾åœ¨æ–°æ•°ç»„çš„ä½ç½® i+n
                        setTabAt(nextTab, i + n, hn);
                        // å°†åŸæ•°ç»„è¯¥ä½ç½®å¤„è®¾ç½®ä¸º fwdï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»å¤„ç†å®Œæ¯•ï¼Œ
                        //    å…¶ä»–çº¿ç¨‹ä¸€æ—¦çœ‹åˆ°è¯¥ä½ç½®çš„ hash å€¼ä¸º MOVEDï¼Œå°±ä¸ä¼šè¿›è¡Œè¿ç§»äº†
                        setTabAt(tab, i, fwd);
                        // advance è®¾ç½®ä¸º trueï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»å®Œæ¯•
                        advance = true;
                    }
                    else if (f instanceof TreeBin) {
                        // çº¢é»‘æ ‘çš„è¿ç§»
                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;
                        TreeNode&lt;K,V&gt; lo = null, loTail = null;
                        TreeNode&lt;K,V&gt; hi = null, hiTail = null;
                        int lc = 0, hc = 0;
                        for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) {
                            int h = e.hash;
                            TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt;
                                (h, e.key, e.val, null, null);
                            if ((h &amp; n) == 0) {
                                if ((p.prev = loTail) == null)
                                    lo = p;
                                else
                                    loTail.next = p;
                                loTail = p;
                                ++lc;
                            }
                            else {
                                if ((p.prev = hiTail) == null)
                                    hi = p;
                                else
                                    hiTail.next = p;
                                hiTail = p;
                                ++hc;
                            }
                        }
                        // å¦‚æœä¸€åˆ†ä¸ºäºŒåï¼ŒèŠ‚ç‚¹æ•°å°äºç­‰äº6ï¼Œé‚£ä¹ˆå°†çº¢é»‘æ ‘è½¬æ¢å›é“¾è¡¨
                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :
                            (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t;
                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :
                            (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t;

                        // å°† ln æ”¾ç½®åœ¨æ–°æ•°ç»„çš„ä½ç½® i
                        setTabAt(nextTab, i, ln);
                        // å°† hn æ”¾ç½®åœ¨æ–°æ•°ç»„çš„ä½ç½® i+n
                        setTabAt(nextTab, i + n, hn);
                        // å°†åŸæ•°ç»„è¯¥ä½ç½®å¤„è®¾ç½®ä¸º fwdï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»å¤„ç†å®Œæ¯•ï¼Œ
                        //    å…¶ä»–çº¿ç¨‹ä¸€æ—¦çœ‹åˆ°è¯¥ä½ç½®çš„ hash å€¼ä¸º MOVEDï¼Œå°±ä¸ä¼šè¿›è¡Œè¿ç§»äº†
                        setTabAt(tab, i, fwd);
                        // advance è®¾ç½®ä¸º trueï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»å®Œæ¯•
                        advance = true;
                    }
                }
            }
        }
    }
}
</code></pre>
<p><strong>get è¿‡ç¨‹åˆ†æ</strong></p>
<ul>
<li>è®¡ç®— hash å€¼</li>
<li>æ ¹æ® hash å€¼æ‰¾åˆ°æ•°ç»„å¯¹åº”ä½ç½®: (n - 1) &amp; h</li>
<li>æ ¹æ®è¯¥ä½ç½®å¤„ç»“ç‚¹æ€§è´¨è¿›è¡Œç›¸åº”æŸ¥æ‰¾<br>
å¦‚æœè¯¥ä½ç½®ä¸º nullï¼Œé‚£ä¹ˆç›´æ¥è¿”å› null å°±å¯ä»¥äº†<br>
å¦‚æœè¯¥ä½ç½®å¤„çš„èŠ‚ç‚¹åˆšå¥½å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œè¿”å›è¯¥èŠ‚ç‚¹çš„å€¼å³å¯<br>
å¦‚æœè¯¥ä½ç½®èŠ‚ç‚¹çš„ hash å€¼å°äº 0ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹ï¼Œæˆ–è€…æ˜¯çº¢é»‘æ ‘<br>
å¦‚æœä»¥ä¸Š 3 æ¡éƒ½ä¸æ»¡è¶³ï¼Œé‚£å°±æ˜¯é“¾è¡¨ï¼Œè¿›è¡Œéå†æ¯”å¯¹å³å¯</li>
</ul>
<h2 id="52-concurrentlinkedqueue">5.2 ConcurrentLinkedQueue</h2>
<p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ã€‚å¦‚æœè¦å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—æœ‰ä¸¤ç§æ–¹å¼ï¼šä¸€ç§æ˜¯ä½¿ç”¨é˜»å¡ç®—æ³•ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨éé˜»å¡ç®—æ³•ã€‚ä½¿ç”¨é˜»å¡ç®—æ³•çš„é˜Ÿåˆ—å¯ä»¥ç”¨ä¸€ä¸ªé”ï¼ˆå…¥é˜Ÿå’Œå‡ºé˜Ÿç”¨åŒä¸€æŠŠé”ï¼‰æˆ–ä¸¤ä¸ªé”ï¼ˆå…¥é˜Ÿå’Œå‡ºé˜Ÿç”¨ä¸åŒçš„é”ï¼‰ç­‰æ–¹å¼æ¥å®ç°ã€‚éé˜»å¡çš„å®ç°æ–¹å¼åˆ™å¯ä»¥ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥å®ç°ã€‚</p>
<p>ConcurrentLinkedQueueæ˜¯ä¸€ä¸ªä½¿ç”¨éé˜»å¡ç®—æ³•çš„åŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œå®ƒé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„è§„<br>
åˆ™å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œå½“æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå®ƒä¼šæ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼›å½“æˆ‘ä»¬è·å–ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå®ƒä¼šè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ã€‚å®ƒé‡‡ç”¨äº†â€œwait-freeâ€ç®—æ³•ï¼ˆå³CASç®—æ³•ï¼‰æ¥å®ç°ã€‚</p>
<pre><code class="language-java">public class ConcurrentLinkedQueue&lt;E&gt; extends AbstractQueue&lt;E&gt;
        implements Queue&lt;E&gt;, java.io.Serializable {}
</code></pre>
<p>ConcurrentLinkedQueueç»§æ‰¿äº†æŠ½è±¡ç±»AbstractQueueï¼ŒAbstractQueueå®šä¹‰äº†å¯¹é˜Ÿåˆ—çš„åŸºæœ¬æ“ä½œï¼›åŒæ—¶å®ç°äº†Queueæ¥å£ï¼ŒQueueå®šä¹‰äº†å¯¹é˜Ÿåˆ—çš„åŸºæœ¬æ“ä½œï¼ŒåŒæ—¶ï¼Œè¿˜å®ç°äº†Serializableæ¥å£ï¼Œè¡¨ç¤ºå¯ä»¥è¢«åºåˆ—åŒ–ã€‚</p>
<p>ç±»çš„å±æ€§å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å±æ€§ä¸­åŒ…å«äº†headåŸŸå’ŒtailåŸŸï¼Œè¡¨ç¤ºé“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾ç»“ç‚¹ï¼ŒåŒæ—¶ï¼ŒConcurrentLinkedQueueä¹Ÿä½¿ç”¨äº†åå°„æœºåˆ¶å’ŒCASæœºåˆ¶æ¥æ›´æ–°å¤´èŠ‚ç‚¹å’Œå°¾ç»“ç‚¹ï¼Œä¿è¯åŸå­æ€§ã€‚</p>
</blockquote>
<pre><code class="language-java">public class ConcurrentLinkedQueue&lt;E&gt; extends AbstractQueue&lt;E&gt;
        implements Queue&lt;E&gt;, java.io.Serializable {
    // ç‰ˆæœ¬åºåˆ—å·        
    private static final long serialVersionUID = 196745693267521676L;
    // åå°„æœºåˆ¶
    private static final sun.misc.Unsafe UNSAFE;
    // headåŸŸçš„åç§»é‡
    private static final long headOffset;
    // tailåŸŸçš„åç§»é‡
    private static final long tailOffset;
    static {
        try {
            UNSAFE = sun.misc.Unsafe.getUnsafe();
            Class&lt;?&gt; k = ConcurrentLinkedQueue.class;
            headOffset = UNSAFE.objectFieldOffset
                (k.getDeclaredField(&quot;head&quot;));
            tailOffset = UNSAFE.objectFieldOffset
                (k.getDeclaredField(&quot;tail&quot;));
        } catch (Exception e) {
            throw new Error(e);
        }
    }
    
    // å¤´èŠ‚ç‚¹
    private transient volatile Node&lt;E&gt; head;
    // å°¾ç»“ç‚¹
    private transient volatile Node&lt;E&gt; tail;
}
</code></pre>
<h3 id="521-concurrentlinkedqueueçš„ç»“æ„">5.2.1 ConcurrentLinkedQueueçš„ç»“æ„</h3>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1660644979695.png" alt="ConcurrentLinkedQueueçš„ç±»å›¾" loading="lazy"></figure>
<p>ConcurrentLinkedQueueç”±headèŠ‚ç‚¹å’ŒtailèŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ç”±èŠ‚ç‚¹å…ƒç´ ï¼ˆitemï¼‰å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆnextï¼‰çš„å¼•ç”¨ç»„æˆï¼ŒèŠ‚ç‚¹ä¸èŠ‚ç‚¹ä¹‹é—´å°±æ˜¯é€šè¿‡è¿™ä¸ªnextå…³è”èµ·æ¥ï¼Œä»è€Œç»„æˆä¸€å¼ é“¾è¡¨ç»“æ„çš„é˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹headèŠ‚ç‚¹å­˜å‚¨çš„å…ƒç´ ä¸ºç©ºï¼ŒtailèŠ‚ç‚¹ç­‰äºheadèŠ‚ç‚¹ã€‚</p>
<pre><code class="language-java">private static class Node&lt;E&gt; {
    // å…ƒç´ 
    volatile E item;
    // nextåŸŸ
    volatile Node&lt;E&gt; next;

    /**
        * Constructs a new node.  Uses relaxed write because item can
        * only be seen after publication via casNext.
        */
    // æ„é€ å‡½æ•°
    Node(E item) {
        // è®¾ç½®itemçš„å€¼
        UNSAFE.putObject(this, itemOffset, item);
    }
    // æ¯”è¾ƒå¹¶æ›¿æ¢itemå€¼
    boolean casItem(E cmp, E val) {
        return UNSAFE.compareAndSwapObject(this, itemOffset, cmp, val);
    }
    
    void lazySetNext(Node&lt;E&gt; val) {
        // è®¾ç½®nextåŸŸçš„å€¼ï¼Œå¹¶ä¸ä¼šä¿è¯ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§
        UNSAFE.putOrderedObject(this, nextOffset, val);
    }
    // æ¯”è¾ƒå¹¶æ›¿æ¢nextåŸŸçš„å€¼
    boolean casNext(Node&lt;E&gt; cmp, Node&lt;E&gt; val) {
        return UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val);
    }

    // Unsafe mechanics
    // åå°„æœºåˆ¶
    private static final sun.misc.Unsafe UNSAFE;
    // itemåŸŸçš„åç§»é‡
    private static final long itemOffset;
    // nextåŸŸçš„åç§»é‡
    private static final long nextOffset;

    static {
        try {
            UNSAFE = sun.misc.Unsafe.getUnsafe();
            Class&lt;?&gt; k = Node.class;
            itemOffset = UNSAFE.objectFieldOffset
                (k.getDeclaredField(&quot;item&quot;));
            nextOffset = UNSAFE.objectFieldOffset
                (k.getDeclaredField(&quot;next&quot;));
        } catch (Exception e) {
            throw new Error(e);
        }
    }
}
</code></pre>
<h3 id="522-å…¥é˜Ÿåˆ—">5.2.2 å…¥é˜Ÿåˆ—</h3>
<h5 id="1å…¥é˜Ÿåˆ—çš„è¿‡ç¨‹">1.å…¥é˜Ÿåˆ—çš„è¿‡ç¨‹</h5>
<p>å…¥é˜Ÿåˆ—å°±æ˜¯å°†å…¥é˜ŸèŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</p>
<p>å…¥é˜Ÿä¸»è¦åšä¸¤ä»¶äº‹æƒ…ï¼šç¬¬ä¸€æ˜¯å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆå½“å‰é˜Ÿåˆ—å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬äºŒæ˜¯æ›´æ–°tailèŠ‚ç‚¹ï¼Œå¦‚æœtailèŠ‚ç‚¹çš„nextèŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆtailèŠ‚ç‚¹ï¼Œ<strong>å¦‚æœtailèŠ‚ç‚¹çš„nextèŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆtailçš„nextèŠ‚ç‚¹ï¼Œæ‰€ä»¥tailèŠ‚ç‚¹ä¸æ€»æ˜¯å°¾èŠ‚ç‚¹ã€‚</strong></p>
<p>å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œå…¥é˜Ÿçš„æƒ…å†µå°±å˜å¾—æ›´åŠ å¤æ‚äº†ï¼Œå› ä¸ºå¯èƒ½ä¼šå‡ºç°å…¶ä»–çº¿ç¨‹æ’é˜Ÿçš„æƒ…å†µã€‚å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨<br>
å…¥é˜Ÿï¼Œé‚£ä¹ˆå®ƒå¿…é¡»å…ˆè·å–å°¾èŠ‚ç‚¹ï¼Œç„¶åè®¾ç½®å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå…¥é˜ŸèŠ‚ç‚¹ï¼Œä½†è¿™æ—¶å¯èƒ½æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ’é˜Ÿäº†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹è¦æš‚åœå…¥é˜Ÿæ“ä½œï¼Œç„¶åé‡æ–°è·å–å°¾èŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>offeræ¥å£</p>
</blockquote>
<pre><code class="language-java">public boolean offer(E e) {
    // å…ƒç´ ä¸ä¸ºnull
    checkNotNull(e);
    // æ–°ç”Ÿä¸€ä¸ªç»“ç‚¹
    final Node&lt;E&gt; newNode = new Node&lt;E&gt;(e);

    for (Node&lt;E&gt; t = tail, p = t;;) { // æ— é™å¾ªç¯
        // qä¸ºpç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹
        Node&lt;E&gt; q = p.next;
        if (q == null) { // qç»“ç‚¹ä¸ºnull
            // p is last node
            if (p.casNext(null, newNode)) { // æ¯”è¾ƒå¹¶è¿›è¡Œæ›¿æ¢pç»“ç‚¹çš„nextåŸŸ
                // Successful CAS is the linearization point
                // for e to become an element of this queue,
                // and for newNode to become &quot;live&quot;.
                if (p != t) // pä¸ç­‰äºtç»“ç‚¹ï¼Œä¸ä¸€è‡´    // hop two nodes at a time
                    // æ¯”è¾ƒå¹¶æ›¿æ¢å°¾ç»“ç‚¹
                    casTail(t, newNode);  // Failure is OK.
                // è¿”å›
                return true;
            }
            // Lost CAS race to another thread; re-read next
        }
        else if (p == q) // pç»“ç‚¹ç­‰äºqç»“ç‚¹
            // We have fallen off list.  If tail is unchanged, it
            // will also be off-list, in which case we need to
            // jump to head, from which all live nodes are always
            // reachable.  Else the new tail is a better bet.
            // åŸæ¥çš„å°¾ç»“ç‚¹ä¸ç°åœ¨çš„å°¾ç»“ç‚¹æ˜¯å¦ç›¸ç­‰ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™pèµ‹å€¼ä¸ºheadï¼Œå¦åˆ™ï¼Œèµ‹å€¼ä¸ºç°åœ¨çš„å°¾ç»“ç‚¹
            p = (t != (t = tail)) ? t : head;
        else
            // Check for tail updates after two hops.
            // é‡æ–°èµ‹å€¼pç»“ç‚¹
            p = (p != t &amp;&amp; t != (t = tail)) ? t : q;
    }
}
</code></pre>
<p>æ•´ä¸ªå…¥é˜Ÿè¿‡ç¨‹ä¸»è¦åšä¸¤ä»¶äº‹æƒ…ï¼šç¬¬ä¸€æ˜¯å®šä½å‡ºå°¾èŠ‚ç‚¹ï¼›ç¬¬äºŒæ˜¯ä½¿ç”¨CASç®—æ³•å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆå°¾èŠ‚ç‚¹çš„nextèŠ‚ç‚¹ï¼Œå¦‚ä¸æˆåŠŸåˆ™é‡è¯•ã€‚</p>
<h3 id="523-å‡ºé˜Ÿåˆ—">5.2.3 å‡ºé˜Ÿåˆ—</h3>
<p>å‡ºé˜Ÿåˆ—çš„å°±æ˜¯ä»é˜Ÿåˆ—é‡Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹å…ƒç´ ï¼Œå¹¶æ¸…ç©ºè¯¥èŠ‚ç‚¹å¯¹å…ƒç´ çš„å¼•ç”¨ã€‚</p>
<p>å¹¶ä¸æ˜¯æ¯æ¬¡å‡ºé˜Ÿæ—¶éƒ½æ›´æ–°headèŠ‚ç‚¹ï¼Œå½“headèŠ‚ç‚¹é‡Œæœ‰å…ƒç´ æ—¶ï¼Œç›´æ¥å¼¹å‡ºheadèŠ‚ç‚¹é‡Œçš„å…ƒç´ ï¼Œè€Œä¸ä¼šæ›´æ–°headèŠ‚ç‚¹ã€‚åªæœ‰å½“headèŠ‚ç‚¹é‡Œæ²¡æœ‰å…ƒç´ æ—¶ï¼Œå‡ºé˜Ÿæ“ä½œæ‰ä¼šæ›´æ–°headèŠ‚ç‚¹ã€‚è¿™ç§åšæ³•ä¹Ÿæ˜¯é€šè¿‡<strong>hopså˜é‡</strong>æ¥å‡å°‘ä½¿ç”¨CASæ›´æ–°headèŠ‚ç‚¹çš„æ¶ˆè€—ï¼Œä»è€Œæé«˜å‡ºé˜Ÿæ•ˆç‡ã€‚</p>
<pre><code class="language-java">public E poll() {
    restartFromHead:
    for (;;) { // æ— é™å¾ªç¯
        for (Node&lt;E&gt; h = head, p = h, q;;) { // ä¿å­˜å¤´èŠ‚ç‚¹
            // itemé¡¹
            E item = p.item;

            if (item != null &amp;&amp; p.casItem(item, null)) { // itemä¸ä¸ºnullå¹¶ä¸”æ¯”è¾ƒå¹¶æ›¿æ¢itemæˆåŠŸ
                // Successful CAS is the linearization point
                // for item to be removed from this queue.
                if (p != h) // pä¸ç­‰äºh    // hop two nodes at a time
                    // æ›´æ–°å¤´èŠ‚ç‚¹
                    updateHead(h, ((q = p.next) != null) ? q : p); 
                // è¿”å›item
                return item;
            }
            else if ((q = p.next) == null) { // qç»“ç‚¹ä¸ºnull
                // æ›´æ–°å¤´èŠ‚ç‚¹
                updateHead(h, p);
                return null;
            }
            else if (p == q) // pç­‰äºq
                // ç»§ç»­å¾ªç¯
                continue restartFromHead;
            else
                // pèµ‹å€¼ä¸ºq
                p = q;
        }
    }
}
</code></pre>
<p>é¦–å…ˆè·å–å¤´èŠ‚ç‚¹çš„å…ƒç´ ï¼Œç„¶ååˆ¤æ–­å¤´èŠ‚ç‚¹å…ƒç´ æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œè¡¨ç¤ºå¦å¤–ä¸€ä¸ªçº¿ç¨‹å·²ç»è¿›è¡Œäº†ä¸€æ¬¡å‡ºé˜Ÿæ“ä½œå°†è¯¥èŠ‚ç‚¹çš„å…ƒç´ å–èµ°ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨CASçš„æ–¹å¼å°†å¤´èŠ‚ç‚¹çš„å¼•ç”¨è®¾ç½®æˆnullï¼Œå¦‚æœCASæˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›å¤´èŠ‚ç‚¹çš„å…ƒç´ ï¼Œå¦‚æœä¸æˆåŠŸï¼Œè¡¨ç¤ºå¦å¤–ä¸€ä¸ªçº¿ç¨‹å·²ç»è¿›è¡Œäº†ä¸€æ¬¡å‡ºé˜Ÿæ“ä½œæ›´æ–°äº†headèŠ‚ç‚¹ï¼Œå¯¼è‡´å…ƒç´ å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡æ–°è·å–å¤´èŠ‚ç‚¹ã€‚</p>
<h3 id="524-remove">5.2.4 remove</h3>
<pre><code class="language-java">public boolean remove(Object o) {
    // å…ƒç´ ä¸ºnullï¼Œè¿”å›
    if (o == null) return false;
    Node&lt;E&gt; pred = null;
    for (Node&lt;E&gt; p = first(); p != null; p = succ(p)) { // è·å–ç¬¬ä¸€ä¸ªå­˜æ´»çš„ç»“ç‚¹
        // ç¬¬ä¸€ä¸ªå­˜æ´»ç»“ç‚¹çš„itemå€¼
        E item = p.item;
        if (item != null &amp;&amp;
            o.equals(item) &amp;&amp;
            p.casItem(item, null)) { // æ‰¾åˆ°itemç›¸ç­‰çš„ç»“ç‚¹ï¼Œå¹¶ä¸”å°†è¯¥ç»“ç‚¹çš„itemè®¾ç½®ä¸ºnull
            // pçš„åç»§ç»“ç‚¹
            Node&lt;E&gt; next = succ(p);
            if (pred != null &amp;&amp; next != null) // predä¸ä¸ºnullå¹¶ä¸”nextä¸ä¸ºnull
                // æ¯”è¾ƒå¹¶æ›¿æ¢nextåŸŸ
                pred.casNext(p, next);
            return true;
        }
        // predèµ‹å€¼ä¸ºp
        pred = p;
    }
    return false;
}
</code></pre>
<h3 id="525-hopså»¶è¿Ÿæ›´æ–°çš„ç­–ç•¥çš„è®¾è®¡">5.2.5 HOPS(å»¶è¿Ÿæ›´æ–°çš„ç­–ç•¥)çš„è®¾è®¡</h3>
<p>é€šè¿‡ä¸Šé¢å¯¹offerå’Œpollæ–¹æ³•çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°tailå’Œheadæ˜¯å»¶è¿Ÿæ›´æ–°çš„ï¼Œä¸¤è€…æ›´æ–°è§¦å‘æ—¶æœºä¸ºï¼š</p>
<p><strong>tailæ›´æ–°è§¦å‘æ—¶æœº</strong>ï¼šå½“tailæŒ‡å‘çš„èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºnullçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå®šä½é˜Ÿåˆ—çœŸæ­£çš„é˜Ÿå°¾èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰¾åˆ°é˜Ÿå°¾èŠ‚ç‚¹åå®Œæˆæ’å…¥ä¹‹åæ‰ä¼šé€šè¿‡casTailè¿›è¡Œtailæ›´æ–°ï¼›å½“tailæŒ‡å‘çš„èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnullçš„æ—¶å€™ï¼Œåªæ’å…¥èŠ‚ç‚¹ä¸æ›´æ–°tailã€‚</p>
<p><strong>headæ›´æ–°è§¦å‘æ—¶æœº</strong>ï¼šå½“headæŒ‡å‘çš„èŠ‚ç‚¹çš„itemåŸŸä¸ºnullçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå®šä½é˜Ÿåˆ—çœŸæ­£çš„é˜Ÿå¤´èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰¾åˆ°é˜Ÿå¤´èŠ‚ç‚¹åå®Œæˆåˆ é™¤ä¹‹åæ‰ä¼šé€šè¿‡updateHeadè¿›è¡Œheadæ›´æ–°ï¼›å½“headæŒ‡å‘çš„èŠ‚ç‚¹çš„itemåŸŸä¸ä¸ºnullçš„æ—¶å€™ï¼Œåªåˆ é™¤èŠ‚ç‚¹ä¸æ›´æ–°headã€‚</p>
<p>å¦‚æœè®©tailæ°¸è¿œä½œä¸ºé˜Ÿåˆ—çš„é˜Ÿå°¾èŠ‚ç‚¹ï¼Œå®ç°çš„ä»£ç é‡ä¼šæ›´å°‘ï¼Œè€Œä¸”é€»è¾‘æ›´æ˜“æ‡‚ã€‚ä½†æ˜¯ï¼Œè¿™æ ·åšæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå¦‚æœå¤§é‡çš„å…¥é˜Ÿæ“ä½œï¼Œæ¯æ¬¡éƒ½è¦æ‰§è¡ŒCASè¿›è¡Œtailçš„æ›´æ–°ï¼Œæ±‡æ€»èµ·æ¥å¯¹æ€§èƒ½ä¹Ÿä¼šæ˜¯å¤§å¤§çš„æŸè€—ã€‚å¦‚æœèƒ½å‡å°‘CASæ›´æ–°çš„æ“ä½œï¼Œæ— ç–‘å¯ä»¥å¤§å¤§æå‡å…¥é˜Ÿçš„æ“ä½œæ•ˆç‡ï¼Œæ‰€ä»¥æ¯é—´éš”1æ¬¡(tailå’Œé˜Ÿå°¾èŠ‚ç‚¹çš„è·ç¦»ä¸º1)è¿›è¡Œæ‰åˆ©ç”¨CASæ›´æ–°tailã€‚å¯¹headçš„æ›´æ–°ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œè™½ç„¶ï¼Œè¿™æ ·è®¾è®¡ä¼šå¤šå‡ºåœ¨å¾ªç¯ä¸­å®šä½é˜Ÿå°¾èŠ‚ç‚¹ï¼Œä½†æ€»ä½“æ¥è¯´è¯»çš„æ“ä½œæ•ˆç‡è¦è¿œè¿œé«˜äºå†™çš„æ€§èƒ½ï¼Œå› æ­¤ï¼Œå¤šå‡ºæ¥çš„åœ¨å¾ªç¯ä¸­å®šä½å°¾èŠ‚ç‚¹çš„æ“ä½œçš„æ€§èƒ½æŸè€—ç›¸å¯¹è€Œè¨€æ˜¯å¾ˆå°çš„ã€‚</p>
<h2 id="53-javaä¸­çš„é˜»å¡é˜Ÿåˆ—">5.3 Javaä¸­çš„é˜»å¡é˜Ÿåˆ—</h2>
<h3 id="531-ä»€ä¹ˆæ˜¯é˜»å¡é˜Ÿåˆ—">5.3.1 ä»€ä¹ˆæ˜¯é˜»å¡é˜Ÿåˆ—</h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Netty (ä¸€)]]></title>
        <id>https://q456qq520.github.io/post/netty-yi/</id>
        <link href="https://q456qq520.github.io/post/netty-yi/">
        </link>
        <updated>2022-08-14T14:29:06.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä¸€-nio-åŸºç¡€">ä¸€. NIO åŸºç¡€</h1>
<p>non-blocking io éé˜»å¡ IO</p>
<h2 id="1-ä¸‰å¤§ç»„ä»¶">1. ä¸‰å¤§ç»„ä»¶</h2>
<h3 id="11-channel-buffer">1.1 Channel &amp; Buffer</h3>
<p>channel æœ‰ä¸€ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„<strong>åŒå‘é€šé“</strong>ï¼Œå¯ä»¥ä» channel å°†æ•°æ®è¯»å…¥bufferï¼Œä¹Ÿå¯ä»¥å°† buffer çš„æ•°æ®å†™å…¥ channelï¼Œè€Œä¹‹å‰çš„ stream è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œchannel æ¯”stream æ›´ä¸ºåº•å±‚</p>
<p>å¸¸è§çš„ Channel æœ‰</p>
<ul>
<li>FileChannel</li>
<li>DatagramChannel ï¼ˆudpï¼‰</li>
<li>SocketChannel ï¼ˆtcpï¼‰</li>
<li>ServerSocketChannel ï¼ˆtcpï¼‰</li>
</ul>
<p>buffer åˆ™ç”¨æ¥ç¼“å†²è¯»å†™æ•°æ®ï¼Œå¸¸è§çš„ buffer æœ‰</p>
<ul>
<li>ByteBuffer
<ul>
<li>MappedByteBuffer</li>
<li>DirectByteBuffer</li>
<li>HeapByteBuffer</li>
</ul>
</li>
<li>ShortBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>FloatBuffer</li>
<li>DoubleBuffer</li>
<li>CharBuffer</li>
</ul>
<h3 id="12-selector">1.2 Selector</h3>
<p>selector å•ä»å­—é¢æ„æ€ä¸å¥½ç†è§£ï¼Œéœ€è¦ç»“åˆæœåŠ¡å™¨çš„è®¾è®¡æ¼”åŒ–æ¥ç†è§£å®ƒçš„ç”¨é€”</p>
<h4 id="å¤šçº¿ç¨‹ç‰ˆè®¾è®¡">å¤šçº¿ç¨‹ç‰ˆè®¾è®¡</h4>
<p>ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªsocketï¼Œè¿™æ ·è®¾è®¡ä¼šæœ‰å¦‚ä¸‹ç¼ºç‚¹</p>
<h4 id="ï¸-å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹">âš ï¸ å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹</h4>
<ul>
<li>å†…å­˜å ç”¨é«˜</li>
<li>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜</li>
<li>åªé€‚åˆè¿æ¥æ•°å°‘çš„åœºæ™¯</li>
</ul>
<h4 id="çº¿ç¨‹æ± ç‰ˆè®¾è®¡">çº¿ç¨‹æ± ç‰ˆè®¾è®¡</h4>
<p>ä¸€ä¸ªçº¿ç¨‹å¯¹åº”å¤šä¸ªsocketã€‚</p>
<h4 id="ï¸-çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹">âš ï¸ çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹</h4>
<ul>
<li>é˜»å¡æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ª socket è¿æ¥</li>
<li>ä»…é€‚åˆçŸ­è¿æ¥åœºæ™¯</li>
</ul>
<h4 id="selector-ç‰ˆè®¾è®¡">selector ç‰ˆè®¾è®¡</h4>
<p>selector çš„ä½œç”¨å°±æ˜¯é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ª channelï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œè¿™äº› channel å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½çš„åœºæ™¯ï¼ˆlow trafficï¼‰</p>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1660489074106.png" alt="selector ç‰ˆè®¾è®¡" loading="lazy"></figure>
<p>è°ƒç”¨ selector çš„ select() ä¼šé˜»å¡ç›´åˆ° channel å‘ç”Ÿäº†è¯»å†™å°±ç»ªäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å‘ç”Ÿï¼Œselect æ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ thread æ¥å¤„ç†</p>
<h2 id="2-bytebuffer">2. ByteBuffer</h2>
<p>æœ‰ä¸€æ™®é€šæ–‡æœ¬æ–‡ä»¶ data.txtï¼Œå†…å®¹ä¸º</p>
<pre><code>1234567890abcd
</code></pre>
<p>ä½¿ç”¨ FileChannel æ¥è¯»å–æ–‡ä»¶å†…å®¹</p>
<pre><code class="language-java">@Slf4j
public class ChannelDemo1 {
    public static void main(String[] args) {
        try (RandomAccessFile file = new RandomAccessFile(&quot;helloword/data.txt&quot;, &quot;rw&quot;)) {
            FileChannel channel = file.getChannel();
            ByteBuffer buffer = ByteBuffer.allocate(10);
            do {
                // å‘ buffer å†™å…¥
                int len = channel.read(buffer);
                log.debug(&quot;è¯»åˆ°å­—èŠ‚æ•°ï¼š{}&quot;, len);
                if (len == -1) {
                    break;
                }
                // åˆ‡æ¢ buffer è¯»æ¨¡å¼
                buffer.flip();
                while(buffer.hasRemaining()) {
                    log.debug(&quot;{}&quot;, (char)buffer.get());
                }
                // åˆ‡æ¢ buffer å†™æ¨¡å¼
                buffer.clear();
            } while (true);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 id="21-bytebuffer-æ­£ç¡®ä½¿ç”¨å§¿åŠ¿">2.1  ByteBuffer æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</h3>
<ol>
<li>å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ channel.read(buffer)</li>
<li>è°ƒç”¨ flip() åˆ‡æ¢è‡³<strong>è¯»æ¨¡å¼</strong></li>
<li>ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()</li>
<li>è°ƒç”¨ clear() æˆ– compact() åˆ‡æ¢è‡³<strong>å†™æ¨¡å¼</strong></li>
<li>é‡å¤ 1~4 æ­¥éª¤</li>
</ol>
<h3 id="22-bytebuffer-ç»“æ„">2.2 ByteBuffer ç»“æ„</h3>
<p>ByteBuffer æœ‰ä»¥ä¸‹é‡è¦å±æ€§</p>
<ul>
<li>capacityï¼ˆå®¹é‡ï¼‰</li>
<li>positionï¼ˆä½ç½®ï¼‰</li>
<li>limit</li>
</ul>
<p>ä¸€å¼€å§‹</p>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1660492137807.png" alt="" loading="lazy"></figure>
<p>å†™æ¨¡å¼ä¸‹ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€<br>
<img src="https://q456qq520.github.io/post-images/1660492145738.png" alt="" loading="lazy"></p>
<p>flip åŠ¨ä½œå‘ç”Ÿåï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶<br>
<img src="https://q456qq520.github.io/post-images/1660492152484.png" alt="" loading="lazy"></p>
<p>è¯»å– 4 ä¸ªå­—èŠ‚åï¼ŒçŠ¶æ€</p>
<figure data-type="image" tabindex="3"><img src="https://q456qq520.github.io/post-images/1660492162158.png" alt="" loading="lazy"></figure>
<p>clear åŠ¨ä½œå‘ç”Ÿåï¼Œ<br>
<img src="https://q456qq520.github.io/post-images/1660492170703.png" alt="" loading="lazy"></p>
<p>compact æ–¹æ³•ï¼Œæ˜¯æŠŠæœªè¯»å®Œçš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™æ¨¡å¼<br>
<img src="https://q456qq520.github.io/post-images/1660492179063.png" alt="" loading="lazy"></p>
<h4 id="è°ƒè¯•å·¥å…·ç±»">ğŸ’¡ è°ƒè¯•å·¥å…·ç±»</h4>
<pre><code class="language-java">public class ByteBufferUtil {
    private static final char[] BYTE2CHAR = new char[256];
    private static final char[] HEXDUMP_TABLE = new char[256 * 4];
    private static final String[] HEXPADDING = new String[16];
    private static final String[] HEXDUMP_ROWPREFIXES = new String[65536 &gt;&gt;&gt; 4];
    private static final String[] BYTE2HEX = new String[256];
    private static final String[] BYTEPADDING = new String[16];

    static {
        final char[] DIGITS = &quot;0123456789abcdef&quot;.toCharArray();
        for (int i = 0; i &lt; 256; i++) {
            HEXDUMP_TABLE[i &lt;&lt; 1] = DIGITS[i &gt;&gt;&gt; 4 &amp; 0x0F];
            HEXDUMP_TABLE[(i &lt;&lt; 1) + 1] = DIGITS[i &amp; 0x0F];
        }

        int i;

        // Generate the lookup table for hex dump paddings
        for (i = 0; i &lt; HEXPADDING.length; i++) {
            int padding = HEXPADDING.length - i;
            StringBuilder buf = new StringBuilder(padding * 3);
            for (int j = 0; j &lt; padding; j++) {
                buf.append(&quot;   &quot;);
            }
            HEXPADDING[i] = buf.toString();
        }

        // Generate the lookup table for the start-offset header in each row (up to 64KiB).
        for (i = 0; i &lt; HEXDUMP_ROWPREFIXES.length; i++) {
            StringBuilder buf = new StringBuilder(12);
            buf.append(NEWLINE);
            buf.append(Long.toHexString(i &lt;&lt; 4 &amp; 0xFFFFFFFFL | 0x100000000L));
            buf.setCharAt(buf.length() - 9, '|');
            buf.append('|');
            HEXDUMP_ROWPREFIXES[i] = buf.toString();
        }

        // Generate the lookup table for byte-to-hex-dump conversion
        for (i = 0; i &lt; BYTE2HEX.length; i++) {
            BYTE2HEX[i] = ' ' + StringUtil.byteToHexStringPadded(i);
        }

        // Generate the lookup table for byte dump paddings
        for (i = 0; i &lt; BYTEPADDING.length; i++) {
            int padding = BYTEPADDING.length - i;
            StringBuilder buf = new StringBuilder(padding);
            for (int j = 0; j &lt; padding; j++) {
                buf.append(' ');
            }
            BYTEPADDING[i] = buf.toString();
        }

        // Generate the lookup table for byte-to-char conversion
        for (i = 0; i &lt; BYTE2CHAR.length; i++) {
            if (i &lt;= 0x1f || i &gt;= 0x7f) {
                BYTE2CHAR[i] = '.';
            } else {
                BYTE2CHAR[i] = (char) i;
            }
        }
    }

    /**
     * æ‰“å°æ‰€æœ‰å†…å®¹
     * @param buffer
     */
    public static void debugAll(ByteBuffer buffer) {
        int oldlimit = buffer.limit();
        buffer.limit(buffer.capacity());
        StringBuilder origin = new StringBuilder(256);
        appendPrettyHexDump(origin, buffer, 0, buffer.capacity());
        System.out.println(&quot;+--------+-------------------- all ------------------------+----------------+&quot;);
        System.out.printf(&quot;position: [%d], limit: [%d]\n&quot;, buffer.position(), oldlimit);
        System.out.println(origin);
        buffer.limit(oldlimit);
    }

    /**
     * æ‰“å°å¯è¯»å–å†…å®¹
     * @param buffer
     */
    public static void debugRead(ByteBuffer buffer) {
        StringBuilder builder = new StringBuilder(256);
        appendPrettyHexDump(builder, buffer, buffer.position(), buffer.limit() - buffer.position());
        System.out.println(&quot;+--------+-------------------- read -----------------------+----------------+&quot;);
        System.out.printf(&quot;position: [%d], limit: [%d]\n&quot;, buffer.position(), buffer.limit());
        System.out.println(builder);
    }

    private static void appendPrettyHexDump(StringBuilder dump, ByteBuffer buf, int offset, int length) {
        if (isOutOfBounds(offset, length, buf.capacity())) {
            throw new IndexOutOfBoundsException(
                    &quot;expected: &quot; + &quot;0 &lt;= offset(&quot; + offset + &quot;) &lt;= offset + length(&quot; + length
                            + &quot;) &lt;= &quot; + &quot;buf.capacity(&quot; + buf.capacity() + ')');
        }
        if (length == 0) {
            return;
        }
        dump.append(
                &quot;         +-------------------------------------------------+&quot; +
                        NEWLINE + &quot;         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |&quot; +
                        NEWLINE + &quot;+--------+-------------------------------------------------+----------------+&quot;);

        final int startIndex = offset;
        final int fullRows = length &gt;&gt;&gt; 4;
        final int remainder = length &amp; 0xF;

        // Dump the rows which have 16 bytes.
        for (int row = 0; row &lt; fullRows; row++) {
            int rowStartIndex = (row &lt;&lt; 4) + startIndex;

            // Per-row prefix.
            appendHexDumpRowPrefix(dump, row, rowStartIndex);

            // Hex dump
            int rowEndIndex = rowStartIndex + 16;
            for (int j = rowStartIndex; j &lt; rowEndIndex; j++) {
                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);
            }
            dump.append(&quot; |&quot;);

            // ASCII dump
            for (int j = rowStartIndex; j &lt; rowEndIndex; j++) {
                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);
            }
            dump.append('|');
        }

        // Dump the last row which has less than 16 bytes.
        if (remainder != 0) {
            int rowStartIndex = (fullRows &lt;&lt; 4) + startIndex;
            appendHexDumpRowPrefix(dump, fullRows, rowStartIndex);

            // Hex dump
            int rowEndIndex = rowStartIndex + remainder;
            for (int j = rowStartIndex; j &lt; rowEndIndex; j++) {
                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);
            }
            dump.append(HEXPADDING[remainder]);
            dump.append(&quot; |&quot;);

            // Ascii dump
            for (int j = rowStartIndex; j &lt; rowEndIndex; j++) {
                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);
            }
            dump.append(BYTEPADDING[remainder]);
            dump.append('|');
        }

        dump.append(NEWLINE +
                &quot;+--------+-------------------------------------------------+----------------+&quot;);
    }

    private static void appendHexDumpRowPrefix(StringBuilder dump, int row, int rowStartIndex) {
        if (row &lt; HEXDUMP_ROWPREFIXES.length) {
            dump.append(HEXDUMP_ROWPREFIXES[row]);
        } else {
            dump.append(NEWLINE);
            dump.append(Long.toHexString(rowStartIndex &amp; 0xFFFFFFFFL | 0x100000000L));
            dump.setCharAt(dump.length() - 9, '|');
            dump.append('|');
        }
    }

    public static short getUnsignedByte(ByteBuffer buffer, int index) {
        return (short) (buffer.get(index) &amp; 0xFF);
    }
}
</code></pre>
<h3 id="23-bytebuffer-å¸¸è§æ–¹æ³•">2.3 ByteBuffer å¸¸è§æ–¹æ³•</h3>
<h4 id="åˆ†é…ç©ºé—´">åˆ†é…ç©ºé—´</h4>
<p>å¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ï¼Œå…¶å®ƒ buffer ç±»ä¹Ÿæœ‰è¯¥æ–¹æ³•</p>
<pre><code class="language-java"> //HeapByteBuffer å †å†…å­˜
//è¯»å†™æ•ˆç‡ä½ï¼Œå—gcå½±å“
System.out.println(ByteBuffer.allocate(16).getClass());

//DirectByteBuffer ç›´æ¥å†…å­˜
//è¯»å†™æ•ˆç‡é«˜ï¼Œå°‘ä¸€æ¬¡æ‹·è´ï¼Œåˆ†é…æ•ˆç‡ä½
System.out.println(ByteBuffer.allocateDirect(16).getClass());
</code></pre>
<h4 id="å‘-buffer-å†™å…¥æ•°æ®">å‘ buffer å†™å…¥æ•°æ®</h4>
<p>æœ‰ä¸¤ç§åŠæ³•</p>
<ul>
<li>è°ƒç”¨ channel çš„ read æ–¹æ³•</li>
<li>è°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•</li>
</ul>
<pre><code class="language-java">int readBytes = channel.read(buf);
</code></pre>
<p>å’Œ</p>
<pre><code class="language-java">buf.put((byte)127);
</code></pre>
<h4 id="ä»-buffer-è¯»å–æ•°æ®">ä» buffer è¯»å–æ•°æ®</h4>
<p>åŒæ ·æœ‰ä¸¤ç§åŠæ³•</p>
<ul>
<li>è°ƒç”¨ channel çš„ write æ–¹æ³•</li>
<li>è°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•</li>
</ul>
<pre><code class="language-java">int writeBytes = channel.write(buf);
</code></pre>
<p>å’Œ</p>
<pre><code class="language-java">byte b = buf.get();
</code></pre>
<p>get æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°ï¼Œå¦‚æœæƒ³é‡å¤è¯»å–æ•°æ®</p>
<ul>
<li>å¯ä»¥è°ƒç”¨ rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0</li>
<li>æˆ–è€…è°ƒç”¨ get(int i) æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ</li>
</ul>
<h4 id="mark-å’Œ-reset">mark å’Œ reset</h4>
<p>mark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®</p>
<blockquote>
<p><strong>æ³¨æ„</strong></p>
<p>rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®</p>
</blockquote>
<h4 id="å­—ç¬¦ä¸²ä¸-bytebuffer-äº’è½¬">å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬</h4>
<pre><code class="language-java">ByteBuffer buffer1 = StandardCharsets.UTF_8.encode(&quot;ä½ å¥½&quot;);
ByteBuffer buffer2 = Charset.forName(&quot;utf-8&quot;).encode(&quot;ä½ å¥½&quot;);

debug(buffer1);
debug(buffer2);

CharBuffer buffer3 = StandardCharsets.UTF_8.decode(buffer1);
System.out.println(buffer3.getClass());
System.out.println(buffer3.toString());
</code></pre>
<p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| e4 bd a0 e5 a5 bd                               |......          |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| e4 bd a0 e5 a5 bd                               |......          |
+--------+-------------------------------------------------+----------------+
class java.nio.HeapCharBuffer
ä½ å¥½
</code></pre>
<h4 id="ï¸-buffer-çš„çº¿ç¨‹å®‰å…¨">âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨</h4>
<blockquote>
<p>Buffer æ˜¯<strong>éçº¿ç¨‹å®‰å…¨çš„</strong></p>
</blockquote>
<h3 id="24-scattering-reads">2.4 Scattering Reads</h3>
<p>åˆ†æ•£è¯»å–ï¼Œæœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ 3parts.txt</p>
<pre><code>onetwothree
</code></pre>
<p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼è¯»å–ï¼Œå¯ä»¥å°†æ•°æ®å¡«å……è‡³å¤šä¸ª buffer</p>
<pre><code class="language-java">try (RandomAccessFile file = new RandomAccessFile(&quot;helloword/3parts.txt&quot;, &quot;rw&quot;)) {
    FileChannel channel = file.getChannel();
    ByteBuffer a = ByteBuffer.allocate(3);
    ByteBuffer b = ByteBuffer.allocate(3);
    ByteBuffer c = ByteBuffer.allocate(5);
    channel.read(new ByteBuffer[]{a, b, c});
    a.flip();
    b.flip();
    c.flip();
    debug(a);
    debug(b);
    debug(c);
} catch (IOException e) {
    e.printStackTrace();
}
</code></pre>
<p>ç»“æœ</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6f 6e 65                                        |one             |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 74 77 6f                                        |two             |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 74 68 72 65 65                                  |three           |
+--------+-------------------------------------------------+----------------+
</code></pre>
<h3 id="25-gathering-writes">2.5 Gathering Writes</h3>
<p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å†™å…¥ï¼Œå¯ä»¥å°†å¤šä¸ª buffer çš„æ•°æ®å¡«å……è‡³ channel</p>
<pre><code class="language-java">try (RandomAccessFile file = new RandomAccessFile(&quot;helloword/3parts.txt&quot;, &quot;rw&quot;)) {
    FileChannel channel = file.getChannel();
    ByteBuffer d = ByteBuffer.allocate(4);
    ByteBuffer e = ByteBuffer.allocate(4);
    channel.position(11);

    d.put(new byte[]{'f', 'o', 'u', 'r'});
    e.put(new byte[]{'f', 'i', 'v', 'e'});
    d.flip();
    e.flip();
    debug(d);
    debug(e);
    channel.write(new ByteBuffer[]{d, e});
} catch (IOException e) {
    e.printStackTrace();
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 6f 75 72                                     |four            |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 69 76 65                                     |five            |
+--------+-------------------------------------------------+----------------+
</code></pre>
<p>æ–‡ä»¶å†…å®¹</p>
<pre><code>onetwothreefourfive
</code></pre>
<h3 id="26-ç»ƒä¹ ">2.6 ç»ƒä¹ </h3>
<p>ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´ä½¿ç”¨ \n è¿›è¡Œåˆ†éš”<br>
ä½†ç”±äºæŸç§åŸå› è¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°ç»„åˆï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æœ‰3æ¡ä¸º</p>
<ul>
<li>Hello,world\n</li>
<li>I'm zhangsan\n</li>
<li>How are you?\n</li>
</ul>
<p>å˜æˆäº†ä¸‹é¢çš„ä¸¤ä¸ª byteBuffer (é»åŒ…ï¼ŒåŠåŒ…)</p>
<ul>
<li>Hello,world\nI'm zhangsan\nHo</li>
<li>w are you?\n</li>
</ul>
<p>ç°åœ¨è¦æ±‚ä½ ç¼–å†™ç¨‹åºï¼Œå°†é”™ä¹±çš„æ•°æ®æ¢å¤æˆåŸå§‹çš„æŒ‰ \n åˆ†éš”çš„æ•°æ®</p>
<pre><code class="language-java">public static void main(String[] args) {
    ByteBuffer source = ByteBuffer.allocate(32);
    //                     11            24
    source.put(&quot;Hello,world\nI'm zhangsan\nHo&quot;.getBytes());
    split(source);

    source.put(&quot;w are you?\nhaha!\n&quot;.getBytes());
    split(source);
}

private static void split(ByteBuffer source) {
    source.flip();
    int oldLimit = source.limit();
    for (int i = 0; i &lt; oldLimit; i++) {
        if (source.get(i) == '\n') {
            System.out.println(i);
            ByteBuffer target = ByteBuffer.allocate(i + 1 - source.position());
            // 0 ~ limit
            source.limit(i + 1);
            target.put(source); // ä»source è¯»ï¼Œå‘ target å†™
            debugAll(target);
            source.limit(oldLimit);
        }
    }
    source.compact();
}
</code></pre>
<h2 id="3-æ–‡ä»¶ç¼–ç¨‹">3. æ–‡ä»¶ç¼–ç¨‹</h2>
<h3 id="31-filechannel">3.1 FileChannel</h3>
<h4 id="ï¸-filechannel-å·¥ä½œæ¨¡å¼">âš ï¸ FileChannel å·¥ä½œæ¨¡å¼</h4>
<blockquote>
<p>FileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹</p>
</blockquote>
<h4 id="è·å–">è·å–</h4>
<p>ä¸èƒ½ç›´æ¥æ‰“å¼€ FileChannelï¼Œå¿…é¡»é€šè¿‡ FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile æ¥è·å– FileChannelï¼Œå®ƒä»¬éƒ½æœ‰ getChannel æ–¹æ³•</p>
<ul>
<li>é€šè¿‡ FileInputStream è·å–çš„ channel åªèƒ½è¯»</li>
<li>é€šè¿‡ FileOutputStream è·å–çš„ channel åªèƒ½å†™</li>
<li>é€šè¿‡ RandomAccessFile æ˜¯å¦èƒ½è¯»å†™æ ¹æ®æ„é€  RandomAccessFile æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š</li>
</ul>
<h4 id="è¯»å–">è¯»å–</h4>
<p>ä¼šä» channel è¯»å–æ•°æ®å¡«å…… ByteBufferï¼Œè¿”å›å€¼è¡¨ç¤ºè¯»åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œ-1 è¡¨ç¤ºåˆ°è¾¾äº†æ–‡ä»¶çš„æœ«å°¾</p>
<pre><code class="language-java">int readBytes = channel.read(buffer);
</code></pre>
<h4 id="å†™å…¥">å†™å…¥</h4>
<p>å†™å…¥çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼Œ SocketChannel</p>
<pre><code class="language-java">ByteBuffer buffer = ...;
buffer.put(...); // å­˜å…¥æ•°æ®
buffer.flip();   // åˆ‡æ¢è¯»æ¨¡å¼

while(buffer.hasRemaining()) {
    channel.write(buffer);
}
</code></pre>
<p>åœ¨ while ä¸­è°ƒç”¨ channel.write æ˜¯å› ä¸º write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channel</p>
<h4 id="å…³é—­">å…³é—­</h4>
<p>channel å¿…é¡»å…³é—­ï¼Œä¸è¿‡è°ƒç”¨äº† FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³•</p>
<h4 id="ä½ç½®">ä½ç½®</h4>
<p>è·å–å½“å‰ä½ç½®</p>
<pre><code class="language-java">long pos = channel.position();
</code></pre>
<p>è®¾ç½®å½“å‰ä½ç½®</p>
<pre><code class="language-java">long newPos = ...;
channel.position(newPos);
</code></pre>
<p>è®¾ç½®å½“å‰ä½ç½®æ—¶ï¼Œå¦‚æœè®¾ç½®ä¸ºæ–‡ä»¶çš„æœ«å°¾</p>
<ul>
<li>è¿™æ—¶è¯»å–ä¼šè¿”å› -1</li>
<li>è¿™æ—¶å†™å…¥ï¼Œä¼šè¿½åŠ å†…å®¹ï¼Œä½†è¦æ³¨æ„å¦‚æœ position è¶…è¿‡äº†æ–‡ä»¶æœ«å°¾ï¼Œå†å†™å…¥æ—¶åœ¨æ–°å†…å®¹å’ŒåŸæœ«å°¾ä¹‹é—´ä¼šæœ‰ç©ºæ´ï¼ˆ00ï¼‰</li>
</ul>
<h4 id="å¤§å°">å¤§å°</h4>
<p>ä½¿ç”¨ size æ–¹æ³•è·å–æ–‡ä»¶çš„å¤§å°</p>
<h4 id="å¼ºåˆ¶å†™å…¥">å¼ºåˆ¶å†™å…¥</h4>
<p>æ“ä½œç³»ç»Ÿå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šå°†æ•°æ®ç¼“å­˜ï¼Œä¸æ˜¯ç«‹åˆ»å†™å…¥ç£ç›˜ã€‚å¯ä»¥è°ƒç”¨ force(true)  æ–¹æ³•å°†æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆæ–‡ä»¶çš„æƒé™ç­‰ä¿¡æ¯ï¼‰ç«‹åˆ»å†™å…¥ç£ç›˜</p>
<h3 id="32-ä¸¤ä¸ª-channel-ä¼ è¾“æ•°æ®">3.2 ä¸¤ä¸ª Channel ä¼ è¾“æ•°æ®</h3>
<pre><code class="language-java">String FROM = &quot;helloword/data.txt&quot;;
String TO = &quot;helloword/to.txt&quot;;
long start = System.nanoTime();
try (FileChannel from = new FileInputStream(FROM).getChannel();
     FileChannel to = new FileOutputStream(TO).getChannel();
    ) {
    from.transferTo(0, from.size(), to);
} catch (IOException e) {
    e.printStackTrace();
}
long end = System.nanoTime();
System.out.println(&quot;transferTo ç”¨æ—¶ï¼š&quot; + (end - start) / 1000_000.0);
</code></pre>
<p>è¾“å‡º</p>
<pre><code>transferTo ç”¨æ—¶ï¼š8.2011
</code></pre>
<p>è¶…è¿‡ 2g å¤§å°çš„æ–‡ä»¶ä¼ è¾“</p>
<pre><code class="language-java">public class TestFileChannelTransferTo {
    public static void main(String[] args) {
        try (
                FileChannel from = new FileInputStream(&quot;data.txt&quot;).getChannel();
                FileChannel to = new FileOutputStream(&quot;to.txt&quot;).getChannel();
        ) {
            // æ•ˆç‡é«˜ï¼Œåº•å±‚ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´è¿›è¡Œä¼˜åŒ–
            long size = from.size();
            // left å˜é‡ä»£è¡¨è¿˜å‰©ä½™å¤šå°‘å­—èŠ‚
            for (long left = size; left &gt; 0; ) {
                System.out.println(&quot;position:&quot; + (size - left) + &quot; left:&quot; + left);
                left -= from.transferTo((size - left), left, to);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>å®é™…ä¼ è¾“ä¸€ä¸ªè¶…å¤§æ–‡ä»¶</p>
<pre><code>position:0 left:7769948160
position:2147483647 left:5622464513
position:4294967294 left:3474980866
position:6442450941 left:1327497219
</code></pre>
<h3 id="33-path">3.3 Path</h3>
<p>jdk7 å¼•å…¥äº† Path å’Œ Paths ç±»</p>
<ul>
<li>Path ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„</li>
<li>Paths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– Path å®ä¾‹</li>
</ul>
<pre><code class="language-java">Path source = Paths.get(&quot;1.txt&quot;); // ç›¸å¯¹è·¯å¾„ ä½¿ç”¨ user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt

Path source = Paths.get(&quot;d:\\1.txt&quot;); // ç»å¯¹è·¯å¾„ ä»£è¡¨äº†  d:\1.txt

Path source = Paths.get(&quot;d:/1.txt&quot;); // ç»å¯¹è·¯å¾„ åŒæ ·ä»£è¡¨äº†  d:\1.txt

Path projects = Paths.get(&quot;d:\\data&quot;, &quot;projects&quot;); // ä»£è¡¨äº†  d:\data\projects
</code></pre>
<ul>
<li><code>.</code> ä»£è¡¨äº†å½“å‰è·¯å¾„</li>
<li><code>..</code> ä»£è¡¨äº†ä¸Šä¸€çº§è·¯å¾„</li>
</ul>
<p>ä¾‹å¦‚ç›®å½•ç»“æ„å¦‚ä¸‹</p>
<pre><code>d:
	|- data
		|- projects
			|- a
			|- b
</code></pre>
<p>ä»£ç </p>
<pre><code class="language-java">Path path = Paths.get(&quot;d:\\data\\projects\\a\\..\\b&quot;);
System.out.println(path);
System.out.println(path.normalize()); // æ­£å¸¸åŒ–è·¯å¾„
</code></pre>
<p>ä¼šè¾“å‡º</p>
<pre><code>d:\data\projects\a\..\b
d:\data\projects\b
</code></pre>
<h3 id="34-files">3.4 Files</h3>
<p>æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p>
<pre><code class="language-java">Path path = Paths.get(&quot;helloword/data.txt&quot;);
System.out.println(Files.exists(path));
</code></pre>
<p>åˆ›å»ºä¸€çº§ç›®å½•</p>
<pre><code class="language-java">Path path = Paths.get(&quot;helloword/d1&quot;);
Files.createDirectory(path);
</code></pre>
<ul>
<li>å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException</li>
<li>ä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ NoSuchFileException</li>
</ul>
<p>åˆ›å»ºå¤šçº§ç›®å½•ç”¨</p>
<pre><code class="language-java">Path path = Paths.get(&quot;helloword/d1/d2&quot;);
Files.createDirectories(path);
</code></pre>
<p>æ‹·è´æ–‡ä»¶</p>
<pre><code class="language-java">Path source = Paths.get(&quot;helloword/data.txt&quot;);
Path target = Paths.get(&quot;helloword/target.txt&quot;);

Files.copy(source, target);
</code></pre>
<ul>
<li>å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException</li>
</ul>
<p>å¦‚æœå¸Œæœ›ç”¨ source è¦†ç›–æ‰ targetï¼Œéœ€è¦ç”¨ StandardCopyOption æ¥æ§åˆ¶</p>
<pre><code class="language-java">Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);
</code></pre>
<p>ç§»åŠ¨æ–‡ä»¶</p>
<pre><code class="language-java">Path source = Paths.get(&quot;helloword/data.txt&quot;);
Path target = Paths.get(&quot;helloword/data.txt&quot;);

Files.move(source, target, StandardCopyOption.ATOMIC_MOVE);
</code></pre>
<ul>
<li>StandardCopyOption.ATOMIC_MOVE ä¿è¯æ–‡ä»¶ç§»åŠ¨çš„åŸå­æ€§</li>
</ul>
<p>åˆ é™¤æ–‡ä»¶</p>
<pre><code class="language-java">Path target = Paths.get(&quot;helloword/target.txt&quot;);

Files.delete(target);
</code></pre>
<ul>
<li>å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ NoSuchFileException</li>
</ul>
<p>åˆ é™¤ç›®å½•</p>
<pre><code class="language-java">Path target = Paths.get(&quot;helloword/d1&quot;);

Files.delete(target);
</code></pre>
<ul>
<li>å¦‚æœç›®å½•è¿˜æœ‰å†…å®¹ï¼Œä¼šæŠ›å¼‚å¸¸ DirectoryNotEmptyException</li>
</ul>
<p>éå†ç›®å½•æ–‡ä»¶</p>
<pre><code class="language-java">public static void main(String[] args) throws IOException {
    Path path = Paths.get(&quot;C:\\Program Files\\Java\\jdk1.8.0_91&quot;);
    AtomicInteger dirCount = new AtomicInteger();
    AtomicInteger fileCount = new AtomicInteger();
    Files.walkFileTree(path, new SimpleFileVisitor&lt;Path&gt;(){
        @Override
        public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) 
            throws IOException {
            System.out.println(dir);
            dirCount.incrementAndGet();
            return super.preVisitDirectory(dir, attrs);
        }

        @Override
        public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) 
            throws IOException {
            System.out.println(file);
            fileCount.incrementAndGet();
            return super.visitFile(file, attrs);
        }
    });
    System.out.println(dirCount); // 133
    System.out.println(fileCount); // 1479
}
</code></pre>
<p>ç»Ÿè®¡ jar çš„æ•°ç›®</p>
<pre><code class="language-java">Path path = Paths.get(&quot;C:\\Program Files\\Java\\jdk1.8.0_91&quot;);
AtomicInteger fileCount = new AtomicInteger();
Files.walkFileTree(path, new SimpleFileVisitor&lt;Path&gt;(){
    @Override
    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) 
        throws IOException {
        if (file.toFile().getName().endsWith(&quot;.jar&quot;)) {
            fileCount.incrementAndGet();
        }
        return super.visitFile(file, attrs);
    }
});
System.out.println(fileCount); // 724
</code></pre>
<p>åˆ é™¤å¤šçº§ç›®å½•</p>
<pre><code class="language-java">Path path = Paths.get(&quot;d:\\a&quot;);
Files.walkFileTree(path, new SimpleFileVisitor&lt;Path&gt;(){
    @Override
    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) 
        throws IOException {
        Files.delete(file);
        return super.visitFile(file, attrs);
    }

    @Override
    public FileVisitResult postVisitDirectory(Path dir, IOException exc) 
        throws IOException {
        Files.delete(dir);
        return super.postVisitDirectory(dir, exc);
    }
});
</code></pre>
<h4 id="ï¸-åˆ é™¤å¾ˆå±é™©">âš ï¸ åˆ é™¤å¾ˆå±é™©</h4>
<blockquote>
<p>åˆ é™¤æ˜¯å±é™©æ“ä½œï¼Œç¡®ä¿è¦é€’å½’åˆ é™¤çš„æ–‡ä»¶å¤¹æ²¡æœ‰é‡è¦å†…å®¹</p>
</blockquote>
<p>æ‹·è´å¤šçº§ç›®å½•</p>
<pre><code class="language-java">long start = System.currentTimeMillis();
String source = &quot;D:\\Snipaste-1.16.2-x64&quot;;
String target = &quot;D:\\Snipaste-1.16.2-x64aaa&quot;;

Files.walk(Paths.get(source)).forEach(path -&gt; {
    try {
        String targetName = path.toString().replace(source, target);
        // æ˜¯ç›®å½•
        if (Files.isDirectory(path)) {
            Files.createDirectory(Paths.get(targetName));
        }
        // æ˜¯æ™®é€šæ–‡ä»¶
        else if (Files.isRegularFile(path)) {
            Files.copy(path, Paths.get(targetName));
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
});
long end = System.currentTimeMillis();
System.out.println(end - start);
</code></pre>
<h2 id="4-ç½‘ç»œç¼–ç¨‹">4. ç½‘ç»œç¼–ç¨‹</h2>
<h3 id="41-éé˜»å¡-vs-é˜»å¡">4.1 éé˜»å¡ vs é˜»å¡</h3>
<h4 id="é˜»å¡">é˜»å¡</h4>
<ul>
<li>é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ
<ul>
<li>ServerSocketChannel.accept ä¼šåœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶è®©çº¿ç¨‹æš‚åœ</li>
<li>SocketChannel.read ä¼šåœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è®©çº¿ç¨‹æš‚åœ</li>
<li>é˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®</li>
</ul>
</li>
<li>å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ</li>
<li>ä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢
<ul>
<li>32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½</li>
<li>å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œå› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥</li>
</ul>
</li>
</ul>
<p>æœåŠ¡å™¨ç«¯</p>
<pre><code class="language-java">// ä½¿ç”¨ nio æ¥ç†è§£é˜»å¡æ¨¡å¼, å•çº¿ç¨‹
// 0. ByteBuffer
ByteBuffer buffer = ByteBuffer.allocate(16);
// 1. åˆ›å»ºäº†æœåŠ¡å™¨
ServerSocketChannel ssc = ServerSocketChannel.open();

// 2. ç»‘å®šç›‘å¬ç«¯å£
ssc.bind(new InetSocketAddress(8080));

// 3. è¿æ¥é›†åˆ
List&lt;SocketChannel&gt; channels = new ArrayList&lt;&gt;();
while (true) {
    // 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡
    log.debug(&quot;connecting...&quot;);
    SocketChannel sc = ssc.accept(); // é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ
    log.debug(&quot;connected... {}&quot;, sc);
    channels.add(sc);
    for (SocketChannel channel : channels) {
        // 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
        log.debug(&quot;before read... {}&quot;, channel);
        channel.read(buffer); // é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ
        buffer.flip();
        debugRead(buffer);
        buffer.clear();
        log.debug(&quot;after read...{}&quot;, channel);
    }
}
</code></pre>
<p>å®¢æˆ·ç«¯</p>
<pre><code class="language-java">SocketChannel sc = SocketChannel.open();
sc.connect(new InetSocketAddress(&quot;localhost&quot;, 8080));
System.out.println(&quot;waiting...&quot;);
</code></pre>
<h4 id="éé˜»å¡">éé˜»å¡</h4>
<ul>
<li>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šä¸ä¼šè®©çº¿ç¨‹æš‚åœ
<ul>
<li>åœ¨ ServerSocketChannel.accept åœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶ï¼Œä¼šè¿”å› nullï¼Œç»§ç»­è¿è¡Œ</li>
<li>SocketChannel.read åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šè¿”å› 0ï¼Œä½†çº¿ç¨‹ä¸å¿…é˜»å¡ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶å®ƒ SocketChannel çš„ read æˆ–æ˜¯å»æ‰§è¡Œ ServerSocketChannel.accept</li>
<li>å†™æ•°æ®æ—¶ï¼Œçº¿ç¨‹åªæ˜¯ç­‰å¾…æ•°æ®å†™å…¥ Channel å³å¯ï¼Œæ— éœ€ç­‰ Channel é€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»</li>
</ul>
</li>
<li>ä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº† cpu</li>
<li>æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO æ”¹è¿›çš„åœ°æ–¹ï¼‰</li>
</ul>
<p>æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜</p>
<pre><code class="language-java">// ä½¿ç”¨ nio æ¥ç†è§£éé˜»å¡æ¨¡å¼, å•çº¿ç¨‹
// 0. ByteBuffer
ByteBuffer buffer = ByteBuffer.allocate(16);
// 1. åˆ›å»ºäº†æœåŠ¡å™¨
ServerSocketChannel ssc = ServerSocketChannel.open();
ssc.configureBlocking(false); // éé˜»å¡æ¨¡å¼
// 2. ç»‘å®šç›‘å¬ç«¯å£
ssc.bind(new InetSocketAddress(8080));
// 3. è¿æ¥é›†åˆ
List&lt;SocketChannel&gt; channels = new ArrayList&lt;&gt;();
while (true) {
    // 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡
    SocketChannel sc = ssc.accept(); // éé˜»å¡ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œä½†scæ˜¯null
    if (sc != null) {
        log.debug(&quot;connected... {}&quot;, sc);
        sc.configureBlocking(false); // éé˜»å¡æ¨¡å¼
        channels.add(sc);
    }
    for (SocketChannel channel : channels) {
        // 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
        int read = channel.read(buffer);// éé˜»å¡ï¼Œçº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œread è¿”å› 0
        if (read &gt; 0) {
            buffer.flip();
            debugRead(buffer);
            buffer.clear();
            log.debug(&quot;after read...{}&quot;, channel);
        }
    }
}
</code></pre>
<h4 id="å¤šè·¯å¤ç”¨">å¤šè·¯å¤ç”¨</h4>
<p>å•çº¿ç¨‹å¯ä»¥é…åˆ Selector å®Œæˆå¯¹å¤šä¸ª Channel å¯è¯»å†™äº‹ä»¶çš„ç›‘æ§ï¼Œè¿™ç§°ä¹‹ä¸º<strong>å¤šè·¯å¤ç”¨</strong></p>
<ul>
<li>å¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œ IOã€æ™®é€šæ–‡ä»¶ IO æ²¡æ³•åˆ©ç”¨å¤šè·¯å¤ç”¨</li>
<li>å¦‚æœä¸ç”¨ Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨åšæ— ç”¨åŠŸï¼Œè€Œ Selector èƒ½å¤Ÿä¿è¯
<ul>
<li>æœ‰å¯è¿æ¥äº‹ä»¶æ—¶æ‰å»è¿æ¥</li>
<li>æœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–</li>
<li>æœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥
<ul>
<li>é™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannel æœªå¿…æ—¶æ—¶å¯å†™ï¼Œä¸€æ—¦ Channel å¯å†™ï¼Œä¼šè§¦å‘ Selector çš„å¯å†™äº‹ä»¶</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="42-selector">4.2 Selector</h3>
<pre><code class="language-mermaid">graph TD
subgraph selector ç‰ˆ
thread --&gt; selector
selector --&gt; c1(channel)
selector --&gt; c2(channel)
selector --&gt; c3(channel)
end
</code></pre>
<p>å¥½å¤„</p>
<ul>
<li>ä¸€ä¸ªçº¿ç¨‹é…åˆ selector å°±å¯ä»¥ç›‘æ§å¤šä¸ª channel çš„äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿçº¿ç¨‹æ‰å»å¤„ç†ã€‚é¿å…éé˜»å¡æ¨¡å¼ä¸‹æ‰€åšæ— ç”¨åŠŸ</li>
<li>è®©è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å……åˆ†åˆ©ç”¨</li>
<li>èŠ‚çº¦äº†çº¿ç¨‹çš„æ•°é‡</li>
<li>å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ul>
<h4 id="åˆ›å»º">åˆ›å»º</h4>
<pre><code class="language-java">Selector selector = Selector.open();
</code></pre>
<h4 id="ç»‘å®š-channel-äº‹ä»¶">ç»‘å®š Channel äº‹ä»¶</h4>
<p>ä¹Ÿç§°ä¹‹ä¸ºæ³¨å†Œäº‹ä»¶ï¼Œç»‘å®šçš„äº‹ä»¶ selector æ‰ä¼šå…³å¿ƒ</p>
<pre><code class="language-java">channel.configureBlocking(false);
SelectionKey key = channel.register(selector, ç»‘å®šäº‹ä»¶);
</code></pre>
<ul>
<li>channel å¿…é¡»å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼</li>
<li>FileChannel æ²¡æœ‰éé˜»å¡æ¨¡å¼ï¼Œå› æ­¤ä¸èƒ½é…åˆ selector ä¸€èµ·ä½¿ç”¨</li>
<li>ç»‘å®šçš„äº‹ä»¶ç±»å‹å¯ä»¥æœ‰
<ul>
<li>connect - å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶è§¦å‘</li>
<li>accept - æœåŠ¡å™¨ç«¯æˆåŠŸæ¥å—è¿æ¥æ—¶è§¦å‘</li>
<li>read - æ•°æ®å¯è¯»å…¥æ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºæ¥æ”¶èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½è¯»å…¥çš„æƒ…å†µ</li>
<li>write - æ•°æ®å¯å†™å‡ºæ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºå‘é€èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½å†™å‡ºçš„æƒ…å†µ</li>
</ul>
</li>
</ul>
<h4 id="ç›‘å¬-channel-äº‹ä»¶">ç›‘å¬ Channel äº‹ä»¶</h4>
<p>å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹æ³•æ¥ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨æœ‰å¤šå°‘ channel å‘ç”Ÿäº†äº‹ä»¶</p>
<p>æ–¹æ³•1ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿ</p>
<pre><code class="language-java">int count = selector.select();
</code></pre>
<p>æ–¹æ³•2ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿï¼Œæˆ–æ˜¯è¶…æ—¶ï¼ˆæ—¶é—´å•ä½ä¸º msï¼‰</p>
<pre><code class="language-java">int count = selector.select(long timeout);
</code></pre>
<p>æ–¹æ³•3ï¼Œä¸ä¼šé˜»å¡ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œç«‹åˆ»è¿”å›ï¼Œè‡ªå·±æ ¹æ®è¿”å›å€¼æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶</p>
<pre><code class="language-java">int count = selector.selectNow();
</code></pre>
<h4 id="select-ä½•æ—¶ä¸é˜»å¡">ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡</h4>
<blockquote>
<ul>
<li>äº‹ä»¶å‘ç”Ÿæ—¶
<ul>
<li>å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶</li>
<li>å®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ï¼Œéƒ½ä¼šè§¦å‘ read äº‹ä»¶ï¼Œå¦å¤–å¦‚æœå‘é€çš„æ•°æ®å¤§äº buffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘å¤šæ¬¡è¯»å–äº‹ä»¶</li>
<li>channel å¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶</li>
<li>åœ¨ linux ä¸‹ nio bug å‘ç”Ÿæ—¶</li>
</ul>
</li>
<li>è°ƒç”¨ selector.wakeup()</li>
<li>è°ƒç”¨ selector.close()</li>
<li>selector æ‰€åœ¨çº¿ç¨‹ interrupt</li>
</ul>
</blockquote>
<h3 id="43-å¤„ç†-accept-äº‹ä»¶">4.3 å¤„ç† accept äº‹ä»¶</h3>
<p>å®¢æˆ·ç«¯ä»£ç ä¸º</p>
<pre><code class="language-java">public class Client {
    public static void main(String[] args) {
        try (Socket socket = new Socket(&quot;localhost&quot;, 8080)) {
            System.out.println(socket);
            socket.getOutputStream().write(&quot;world&quot;.getBytes());
            System.in.read();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>æœåŠ¡å™¨ç«¯ä»£ç ä¸º</p>
<pre><code class="language-java">@Slf4j
public class ChannelDemo6 {
    public static void main(String[] args) {
        try (ServerSocketChannel channel = ServerSocketChannel.open()) {
            channel.bind(new InetSocketAddress(8080));
            System.out.println(channel);
            Selector selector = Selector.open();
            channel.configureBlocking(false);
            channel.register(selector, SelectionKey.OP_ACCEPT);

            while (true) {
                int count = selector.select();
//                int count = selector.selectNow();
                log.debug(&quot;select count: {}&quot;, count);
//                if(count &lt;= 0) {
//                    continue;
//                }

                // è·å–æ‰€æœ‰äº‹ä»¶
                Set&lt;SelectionKey&gt; keys = selector.selectedKeys();

                // éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†
                Iterator&lt;SelectionKey&gt; iter = keys.iterator();
                while (iter.hasNext()) {
                    SelectionKey key = iter.next();
                    // åˆ¤æ–­äº‹ä»¶ç±»å‹
                    if (key.isAcceptable()) {
                        ServerSocketChannel c = (ServerSocketChannel) key.channel();
                        // å¿…é¡»å¤„ç†
                        SocketChannel sc = c.accept();
                        log.debug(&quot;{}&quot;, sc);
                    }
                    // å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤
                    iter.remove();
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h4 id="äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†">ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†</h4>
<blockquote>
<p>äº‹ä»¶å‘ç”Ÿåï¼Œè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼ˆcancelï¼‰ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™ä¸‹æ¬¡è¯¥äº‹ä»¶ä»ä¼šè§¦å‘ï¼Œè¿™æ˜¯å› ä¸º nio åº•å±‚ä½¿ç”¨çš„æ˜¯æ°´å¹³è§¦å‘</p>
</blockquote>
<h3 id="44-å¤„ç†-read-äº‹ä»¶">4.4 å¤„ç† read äº‹ä»¶</h3>
<pre><code class="language-java">@Slf4j
public class ChannelDemo6 {
    public static void main(String[] args) {
        try (ServerSocketChannel channel = ServerSocketChannel.open()) {
            channel.bind(new InetSocketAddress(8080));
            System.out.println(channel);
            Selector selector = Selector.open();
            channel.configureBlocking(false);
            channel.register(selector, SelectionKey.OP_ACCEPT);

            while (true) {
                int count = selector.select();
//                int count = selector.selectNow();
                log.debug(&quot;select count: {}&quot;, count);
//                if(count &lt;= 0) {
//                    continue;
//                }

                // è·å–æ‰€æœ‰äº‹ä»¶
                Set&lt;SelectionKey&gt; keys = selector.selectedKeys();

                // éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†
                Iterator&lt;SelectionKey&gt; iter = keys.iterator();
                while (iter.hasNext()) {
                    SelectionKey key = iter.next();
                    // åˆ¤æ–­äº‹ä»¶ç±»å‹
                    if (key.isAcceptable()) {
                        ServerSocketChannel c = (ServerSocketChannel) key.channel();
                        // å¿…é¡»å¤„ç†
                        SocketChannel sc = c.accept();
                        sc.configureBlocking(false);
                        sc.register(selector, SelectionKey.OP_READ);
                        log.debug(&quot;è¿æ¥å·²å»ºç«‹: {}&quot;, sc);
                    } else if (key.isReadable()) {
                        SocketChannel sc = (SocketChannel) key.channel();
                        ByteBuffer buffer = ByteBuffer.allocate(128);
                        int read = sc.read(buffer);
                        if(read == -1) {
                            key.cancel();
                            sc.close();
                        } else {
                            buffer.flip();
                            debug(buffer);
                        }
                    }
                    // å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤
                    iter.remove();
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>å¼€å¯ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œä¿®æ”¹ä¸€ä¸‹å‘é€æ–‡å­—ï¼Œè¾“å‡º</p>
<pre><code>sun.nio.ch.ServerSocketChannelImpl[/0:0:0:0:0:0:0:0:8080]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60367]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60378]
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 6f 72 6c 64                                  |world           |
+--------+-------------------------------------------------+----------------+
</code></pre>
<h4 id="ä¸ºä½•è¦-iterremove">ğŸ’¡ ä¸ºä½•è¦ iter.remove()</h4>
<blockquote>
<p>å› ä¸º select åœ¨äº‹ä»¶å‘ç”Ÿåï¼Œå°±ä¼šå°†ç›¸å…³çš„ key æ”¾å…¥ selectedKeys é›†åˆï¼Œä½†ä¸ä¼šåœ¨å¤„ç†å®Œåä» selectedKeys é›†åˆä¸­ç§»é™¤ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–ç åˆ é™¤ã€‚ä¾‹å¦‚</p>
<ul>
<li>ç¬¬ä¸€æ¬¡è§¦å‘äº† ssckey ä¸Šçš„ accept äº‹ä»¶ï¼Œæ²¡æœ‰ç§»é™¤ ssckey</li>
<li>ç¬¬äºŒæ¬¡è§¦å‘äº† sckey ä¸Šçš„ read äº‹ä»¶ï¼Œä½†è¿™æ—¶ selectedKeys ä¸­è¿˜æœ‰ä¸Šæ¬¡çš„ ssckey ï¼Œåœ¨å¤„ç†æ—¶å› ä¸ºæ²¡æœ‰çœŸæ­£çš„ serverSocket è¿ä¸Šäº†ï¼Œå°±ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸</li>
</ul>
</blockquote>
<h4 id="cancel-çš„ä½œç”¨">ğŸ’¡ cancel çš„ä½œç”¨</h4>
<blockquote>
<p>cancel ä¼šå–æ¶ˆæ³¨å†Œåœ¨ selector ä¸Šçš„ channelï¼Œå¹¶ä» keys é›†åˆä¸­åˆ é™¤ key åç»­ä¸ä¼šå†ç›‘å¬äº‹ä»¶</p>
</blockquote>
<h4 id="ï¸-ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜">âš ï¸  ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜</h4>
<p>ä»¥å‰æœ‰åŒå­¦å†™è¿‡è¿™æ ·çš„ä»£ç ï¼Œæ€è€ƒæ³¨é‡Šä¸­ä¸¤ä¸ªé—®é¢˜ï¼Œä»¥ bio ä¸ºä¾‹ï¼Œå…¶å® nio é“ç†æ˜¯ä¸€æ ·çš„</p>
<pre><code class="language-java">public class Server {
    public static void main(String[] args) throws IOException {
        ServerSocket ss=new ServerSocket(9000);
        while (true) {
            Socket s = ss.accept();
            InputStream in = s.getInputStream();
            // è¿™é‡Œè¿™ä¹ˆå†™ï¼Œæœ‰æ²¡æœ‰é—®é¢˜
            byte[] arr = new byte[4];
            while(true) {
                int read = in.read(arr);
                // è¿™é‡Œè¿™ä¹ˆå†™ï¼Œæœ‰æ²¡æœ‰é—®é¢˜
                if(read == -1) {
                    break;
                }
                System.out.println(new String(arr, 0, read));
            }
        }
    }
}
</code></pre>
<p>å®¢æˆ·ç«¯</p>
<pre><code class="language-java">public class Client {
    public static void main(String[] args) throws IOException {
        Socket max = new Socket(&quot;localhost&quot;, 9000);
        OutputStream out = max.getOutputStream();
        out.write(&quot;hello&quot;.getBytes());
        out.write(&quot;world&quot;.getBytes());
        out.write(&quot;ä½ å¥½&quot;.getBytes());
        max.close();
    }
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code>hell
owor
ldï¿½
ï¿½å¥½

</code></pre>
<p>ä¸ºä»€ä¹ˆï¼Ÿ</p>
<h4 id="å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ">å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ</h4>
<figure data-type="image" tabindex="4"><img src="img/0023.png" alt="" loading="lazy"></figure>
<ul>
<li>ä¸€ç§æ€è·¯æ˜¯å›ºå®šæ¶ˆæ¯é•¿åº¦ï¼Œæ•°æ®åŒ…å¤§å°ä¸€æ ·ï¼ŒæœåŠ¡å™¨æŒ‰é¢„å®šé•¿åº¦è¯»å–ï¼Œç¼ºç‚¹æ˜¯æµªè´¹å¸¦å®½</li>
<li>å¦ä¸€ç§æ€è·¯æ˜¯æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ï¼Œç¼ºç‚¹æ˜¯æ•ˆç‡ä½</li>
<li>TLV æ ¼å¼ï¼Œå³ Type ç±»å‹ã€Length é•¿åº¦ã€Value æ•°æ®ï¼Œç±»å‹å’Œé•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„ bufferï¼Œç¼ºç‚¹æ˜¯ buffer éœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™å½±å“ server ååé‡
<ul>
<li>Http 1.1 æ˜¯ TLV æ ¼å¼</li>
<li>Http 2.0 æ˜¯ LTV æ ¼å¼</li>
</ul>
</li>
</ul>
<pre><code class="language-mermaid">sequenceDiagram 
participant c1 as å®¢æˆ·ç«¯1
participant s as æœåŠ¡å™¨
participant b1 as ByteBuffer1
participant b2 as ByteBuffer2
c1 -&gt;&gt; s: å‘é€ 01234567890abcdef3333\r
s -&gt;&gt; b1: ç¬¬ä¸€æ¬¡ read å­˜å…¥ 01234567890abcdef
s -&gt;&gt; b2: æ‰©å®¹
b1 -&gt;&gt; b2: æ‹·è´ 01234567890abcdef
s -&gt;&gt; b2: ç¬¬äºŒæ¬¡ read å­˜å…¥ 3333\r
b2 -&gt;&gt; b2: 01234567890abcdef3333\r
</code></pre>
<p>æœåŠ¡å™¨ç«¯</p>
<pre><code class="language-java">private static void split(ByteBuffer source) {
    source.flip();
    for (int i = 0; i &lt; source.limit(); i++) {
        // æ‰¾åˆ°ä¸€æ¡å®Œæ•´æ¶ˆæ¯
        if (source.get(i) == '\n') {
            int length = i + 1 - source.position();
            // æŠŠè¿™æ¡å®Œæ•´æ¶ˆæ¯å­˜å…¥æ–°çš„ ByteBuffer
            ByteBuffer target = ByteBuffer.allocate(length);
            // ä» source è¯»ï¼Œå‘ target å†™
            for (int j = 0; j &lt; length; j++) {
                target.put(source.get());
            }
            debugAll(target);
        }
    }
    source.compact(); // 0123456789abcdef  position 16 limit 16
}

public static void main(String[] args) throws IOException {
    // 1. åˆ›å»º selector, ç®¡ç†å¤šä¸ª channel
    Selector selector = Selector.open();
    ServerSocketChannel ssc = ServerSocketChannel.open();
    ssc.configureBlocking(false);
    // 2. å»ºç«‹ selector å’Œ channel çš„è”ç³»ï¼ˆæ³¨å†Œï¼‰
    // SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒå¯ä»¥çŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶
    SelectionKey sscKey = ssc.register(selector, 0, null);
    // key åªå…³æ³¨ accept äº‹ä»¶
    sscKey.interestOps(SelectionKey.OP_ACCEPT);
    log.debug(&quot;sscKey:{}&quot;, sscKey);
    ssc.bind(new InetSocketAddress(8080));
    while (true) {
        // 3. select æ–¹æ³•, æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹é˜»å¡ï¼Œæœ‰äº‹ä»¶ï¼Œçº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œ
        // select åœ¨äº‹ä»¶æœªå¤„ç†æ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡, äº‹ä»¶å‘ç”Ÿåè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼Œä¸èƒ½ç½®ä¹‹ä¸ç†
        selector.select();
        // 4. å¤„ç†äº‹ä»¶, selectedKeys å†…éƒ¨åŒ…å«äº†æ‰€æœ‰å‘ç”Ÿçš„äº‹ä»¶
        Iterator&lt;SelectionKey&gt; iter = selector.selectedKeys().iterator(); // accept, read
        while (iter.hasNext()) {
            SelectionKey key = iter.next();
            // å¤„ç†key æ—¶ï¼Œè¦ä» selectedKeys é›†åˆä¸­åˆ é™¤ï¼Œå¦åˆ™ä¸‹æ¬¡å¤„ç†å°±ä¼šæœ‰é—®é¢˜
            iter.remove();
            log.debug(&quot;key: {}&quot;, key);
            // 5. åŒºåˆ†äº‹ä»¶ç±»å‹
            if (key.isAcceptable()) { // å¦‚æœæ˜¯ accept
                ServerSocketChannel channel = (ServerSocketChannel) key.channel();
                SocketChannel sc = channel.accept();
                sc.configureBlocking(false);
                ByteBuffer buffer = ByteBuffer.allocate(16); // attachment
                // å°†ä¸€ä¸ª byteBuffer ä½œä¸ºé™„ä»¶å…³è”åˆ° selectionKey ä¸Š
                SelectionKey scKey = sc.register(selector, 0, buffer);
                scKey.interestOps(SelectionKey.OP_READ);
                log.debug(&quot;{}&quot;, sc);
                log.debug(&quot;scKey:{}&quot;, scKey);
            } else if (key.isReadable()) { // å¦‚æœæ˜¯ read
                try {
                    SocketChannel channel = (SocketChannel) key.channel(); // æ‹¿åˆ°è§¦å‘äº‹ä»¶çš„channel
                    // è·å– selectionKey ä¸Šå…³è”çš„é™„ä»¶
                    ByteBuffer buffer = (ByteBuffer) key.attachment();
                    int read = channel.read(buffer); // å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread çš„æ–¹æ³•çš„è¿”å›å€¼æ˜¯ -1
                    if(read == -1) {
                        key.cancel();
                    } else {
                        split(buffer);
                        // éœ€è¦æ‰©å®¹
                        if (buffer.position() == buffer.limit()) {
                            ByteBuffer newBuffer = ByteBuffer.allocate(buffer.capacity() * 2);
                            buffer.flip();
                            newBuffer.put(buffer); // 0123456789abcdef3333\n
                            key.attach(newBuffer);
                        }
                    }

                } catch (IOException e) {
                    e.printStackTrace();
                    key.cancel();  // å› ä¸ºå®¢æˆ·ç«¯æ–­å¼€äº†,å› æ­¤éœ€è¦å°† key å–æ¶ˆï¼ˆä» selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰
                }
            }
        }
    }
}
</code></pre>
<p>å®¢æˆ·ç«¯</p>
<pre><code class="language-java">SocketChannel sc = SocketChannel.open();
sc.connect(new InetSocketAddress(&quot;localhost&quot;, 8080));
SocketAddress address = sc.getLocalAddress();
// sc.write(Charset.defaultCharset().encode(&quot;hello\nworld\n&quot;));
sc.write(Charset.defaultCharset().encode(&quot;0123\n456789abcdef&quot;));
sc.write(Charset.defaultCharset().encode(&quot;0123456789abcdef3333\n&quot;));
System.in.read();
</code></pre>
<h4 id="bytebuffer-å¤§å°åˆ†é…">ByteBuffer å¤§å°åˆ†é…</h4>
<ul>
<li>æ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œå› ä¸º ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ª channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ ByteBuffer</li>
<li>ByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ª ByteBuffer 1Mb çš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±è¦ 1Tb å†…å­˜ï¼Œå› æ­¤éœ€è¦è®¾è®¡å¤§å°å¯å˜çš„ ByteBuffer
<ul>
<li>ä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ bufferï¼Œä¾‹å¦‚ 4kï¼Œå¦‚æœå‘ç°æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é… 8k çš„ bufferï¼Œå°† 4k buffer å†…å®¹æ‹·è´è‡³ 8k bufferï¼Œä¼˜ç‚¹æ˜¯æ¶ˆæ¯è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½ï¼Œå‚è€ƒå®ç° <a href="http://tutorials.jenkov.com/java-performance/resizable-array.html">http://tutorials.jenkov.com/java-performance/resizable-array.html</a></li>
<li>å¦ä¸€ç§æ€è·¯æ˜¯ç”¨å¤šä¸ªæ•°ç»„ç»„æˆ bufferï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æå¤æ‚ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†æ‹·è´å¼•èµ·çš„æ€§èƒ½æŸè€—</li>
</ul>
</li>
</ul>
<h3 id="45-å¤„ç†-write-äº‹ä»¶">4.5 å¤„ç† write äº‹ä»¶</h3>
<h4 id="ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­">ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­</h4>
<ul>
<li>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œæ— æ³•ä¿è¯æŠŠ buffer ä¸­æ‰€æœ‰æ•°æ®éƒ½å†™å…¥ channelï¼Œå› æ­¤éœ€è¦è¿½è¸ª write æ–¹æ³•çš„è¿”å›å€¼ï¼ˆä»£è¡¨å®é™…å†™å…¥å­—èŠ‚æ•°ï¼‰</li>
<li>ç”¨ selector ç›‘å¬æ‰€æœ‰ channel çš„å¯å†™äº‹ä»¶ï¼Œæ¯ä¸ª channel éƒ½éœ€è¦ä¸€ä¸ª key æ¥è·Ÿè¸ª bufferï¼Œä½†è¿™æ ·åˆä¼šå¯¼è‡´å ç”¨å†…å­˜è¿‡å¤šï¼Œå°±æœ‰ä¸¤é˜¶æ®µç­–ç•¥
<ul>
<li>å½“æ¶ˆæ¯å¤„ç†å™¨ç¬¬ä¸€æ¬¡å†™å…¥æ¶ˆæ¯æ—¶ï¼Œæ‰å°† channel æ³¨å†Œåˆ° selector ä¸Š</li>
<li>selector æ£€æŸ¥ channel ä¸Šçš„å¯å†™äº‹ä»¶ï¼Œå¦‚æœæ‰€æœ‰çš„æ•°æ®å†™å®Œäº†ï¼Œå°±å–æ¶ˆ channel çš„æ³¨å†Œ</li>
<li>å¦‚æœä¸å–æ¶ˆï¼Œä¼šæ¯æ¬¡å¯å†™å‡ä¼šè§¦å‘ write äº‹ä»¶</li>
</ul>
</li>
</ul>
<pre><code class="language-java">public class WriteServer {

    public static void main(String[] args) throws IOException {
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.configureBlocking(false);
        ssc.bind(new InetSocketAddress(8080));

        Selector selector = Selector.open();
        ssc.register(selector, SelectionKey.OP_ACCEPT);

        while(true) {
            selector.select();

            Iterator&lt;SelectionKey&gt; iter = selector.selectedKeys().iterator();
            while (iter.hasNext()) {
                SelectionKey key = iter.next();
                iter.remove();
                if (key.isAcceptable()) {
                    SocketChannel sc = ssc.accept();
                    sc.configureBlocking(false);
                    SelectionKey sckey = sc.register(selector, SelectionKey.OP_READ);
                    // 1. å‘å®¢æˆ·ç«¯å‘é€å†…å®¹
                    StringBuilder sb = new StringBuilder();
                    for (int i = 0; i &lt; 3000000; i++) {
                        sb.append(&quot;a&quot;);
                    }
                    ByteBuffer buffer = Charset.defaultCharset().encode(sb.toString());
                    int write = sc.write(buffer);
                    // 3. write è¡¨ç¤ºå®é™…å†™äº†å¤šå°‘å­—èŠ‚
                    System.out.println(&quot;å®é™…å†™å…¥å­—èŠ‚:&quot; + write);
                    // 4. å¦‚æœæœ‰å‰©ä½™æœªè¯»å­—èŠ‚ï¼Œæ‰éœ€è¦å…³æ³¨å†™äº‹ä»¶
                    if (buffer.hasRemaining()) {
                        // read 1  write 4
                        // åœ¨åŸæœ‰å…³æ³¨äº‹ä»¶çš„åŸºç¡€ä¸Šï¼Œå¤šå…³æ³¨ å†™äº‹ä»¶
                        sckey.interestOps(sckey.interestOps() + SelectionKey.OP_WRITE);
                        // æŠŠ buffer ä½œä¸ºé™„ä»¶åŠ å…¥ sckey
                        sckey.attach(buffer);
                    }
                } else if (key.isWritable()) {
                    ByteBuffer buffer = (ByteBuffer) key.attachment();
                    SocketChannel sc = (SocketChannel) key.channel();
                    int write = sc.write(buffer);
                    System.out.println(&quot;å®é™…å†™å…¥å­—èŠ‚:&quot; + write);
                    if (!buffer.hasRemaining()) { // å†™å®Œäº†
                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);
                        key.attach(null);
                    }
                }
            }
        }
    }
}
</code></pre>
<p>å®¢æˆ·ç«¯</p>
<pre><code class="language-java">public class WriteClient {
    public static void main(String[] args) throws IOException {
        Selector selector = Selector.open();
        SocketChannel sc = SocketChannel.open();
        sc.configureBlocking(false);
        sc.register(selector, SelectionKey.OP_CONNECT | SelectionKey.OP_READ);
        sc.connect(new InetSocketAddress(&quot;localhost&quot;, 8080));
        int count = 0;
        while (true) {
            selector.select();
            Iterator&lt;SelectionKey&gt; iter = selector.selectedKeys().iterator();
            while (iter.hasNext()) {
                SelectionKey key = iter.next();
                iter.remove();
                if (key.isConnectable()) {
                    System.out.println(sc.finishConnect());
                } else if (key.isReadable()) {
                    ByteBuffer buffer = ByteBuffer.allocate(1024 * 1024);
                    count += sc.read(buffer);
                    buffer.clear();
                    System.out.println(count);
                }
            }
        }
    }
}
</code></pre>
<h4 id="write-ä¸ºä½•è¦å–æ¶ˆ">ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ</h4>
<p>åªè¦å‘ channel å‘é€æ•°æ®æ—¶ï¼Œsocket ç¼“å†²å¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šé¢‘ç¹è§¦å‘ï¼Œå› æ­¤åº”å½“åªåœ¨ socket ç¼“å†²åŒºå†™ä¸ä¸‹æ—¶å†å…³æ³¨å¯å†™äº‹ä»¶ï¼Œæ•°æ®å†™å®Œä¹‹åå†å–æ¶ˆå…³æ³¨</p>
<h3 id="46-æ›´è¿›ä¸€æ­¥">4.6 æ›´è¿›ä¸€æ­¥</h3>
<h4 id="åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–">ğŸ’¡ åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–</h4>
<blockquote>
<p>ç°åœ¨éƒ½æ˜¯å¤šæ ¸ cpuï¼Œè®¾è®¡æ—¶è¦å……åˆ†è€ƒè™‘åˆ«è®© cpu çš„åŠ›é‡è¢«ç™½ç™½æµªè´¹</p>
</blockquote>
<p>å‰é¢çš„ä»£ç åªæœ‰ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤šæ ¸ cpuï¼Œå¦‚ä½•æ”¹è¿›å‘¢ï¼Ÿ</p>
<p>åˆ†ä¸¤ç»„é€‰æ‹©å™¨</p>
<ul>
<li>å•çº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œä¸“é—¨å¤„ç† accept äº‹ä»¶</li>
<li>åˆ›å»º cpu æ ¸å¿ƒæ•°çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œè½®æµå¤„ç† read äº‹ä»¶</li>
</ul>
<pre><code class="language-java">public class ChannelDemo7 {
    public static void main(String[] args) throws IOException {
        new BossEventLoop().register();
    }


    @Slf4j
    static class BossEventLoop implements Runnable {
        private Selector boss;
        private WorkerEventLoop[] workers;
        private volatile boolean start = false;
        AtomicInteger index = new AtomicInteger();

        public void register() throws IOException {
            if (!start) {
                ServerSocketChannel ssc = ServerSocketChannel.open();
                ssc.bind(new InetSocketAddress(8080));
                ssc.configureBlocking(false);
                boss = Selector.open();
                SelectionKey ssckey = ssc.register(boss, 0, null);
                ssckey.interestOps(SelectionKey.OP_ACCEPT);
                workers = initEventLoops();
                new Thread(this, &quot;boss&quot;).start();
                log.debug(&quot;boss start...&quot;);
                start = true;
            }
        }

        public WorkerEventLoop[] initEventLoops() {
//        EventLoop[] eventLoops = new EventLoop[Runtime.getRuntime().availableProcessors()];
            WorkerEventLoop[] workerEventLoops = new WorkerEventLoop[2];
            for (int i = 0; i &lt; workerEventLoops.length; i++) {
                workerEventLoops[i] = new WorkerEventLoop(i);
            }
            return workerEventLoops;
        }

        @Override
        public void run() {
            while (true) {
                try {
                    boss.select();
                    Iterator&lt;SelectionKey&gt; iter = boss.selectedKeys().iterator();
                    while (iter.hasNext()) {
                        SelectionKey key = iter.next();
                        iter.remove();
                        if (key.isAcceptable()) {
                            ServerSocketChannel c = (ServerSocketChannel) key.channel();
                            SocketChannel sc = c.accept();
                            sc.configureBlocking(false);
                            log.debug(&quot;{} connected&quot;, sc.getRemoteAddress());
                            workers[index.getAndIncrement() % workers.length].register(sc);
                        }
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    @Slf4j
    static class WorkerEventLoop implements Runnable {
        private Selector worker;
        private volatile boolean start = false;
        private int index;

        private final ConcurrentLinkedQueue&lt;Runnable&gt; tasks = new ConcurrentLinkedQueue&lt;&gt;();

        public WorkerEventLoop(int index) {
            this.index = index;
        }

        public void register(SocketChannel sc) throws IOException {
            if (!start) {
                worker = Selector.open();
                new Thread(this, &quot;worker-&quot; + index).start();
                start = true;
            }
            tasks.add(() -&gt; {
                try {
                    SelectionKey sckey = sc.register(worker, 0, null);
                    sckey.interestOps(SelectionKey.OP_READ);
                    worker.selectNow();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            });
            worker.wakeup();
        }

        @Override
        public void run() {
            while (true) {
                try {
                    worker.select();
                    Runnable task = tasks.poll();
                    if (task != null) {
                        task.run();
                    }
                    Set&lt;SelectionKey&gt; keys = worker.selectedKeys();
                    Iterator&lt;SelectionKey&gt; iter = keys.iterator();
                    while (iter.hasNext()) {
                        SelectionKey key = iter.next();
                        if (key.isReadable()) {
                            SocketChannel sc = (SocketChannel) key.channel();
                            ByteBuffer buffer = ByteBuffer.allocate(128);
                            try {
                                int read = sc.read(buffer);
                                if (read == -1) {
                                    key.cancel();
                                    sc.close();
                                } else {
                                    buffer.flip();
                                    log.debug(&quot;{} message:&quot;, sc.getRemoteAddress());
                                    debugAll(buffer);
                                }
                            } catch (IOException e) {
                                e.printStackTrace();
                                key.cancel();
                                sc.close();
                            }
                        }
                        iter.remove();
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
</code></pre>
<h4 id="å¦‚ä½•æ‹¿åˆ°-cpu-ä¸ªæ•°">ğŸ’¡ å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°</h4>
<blockquote>
<ul>
<li>Runtime.getRuntime().availableProcessors() å¦‚æœå·¥ä½œåœ¨ docker å®¹å™¨ä¸‹ï¼Œå› ä¸ºå®¹å™¨ä¸æ˜¯ç‰©ç†éš”ç¦»çš„ï¼Œä¼šæ‹¿åˆ°ç‰©ç† cpu ä¸ªæ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨ç”³è¯·æ—¶çš„ä¸ªæ•°</li>
<li>è¿™ä¸ªé—®é¢˜ç›´åˆ° jdk 10 æ‰ä¿®å¤ï¼Œä½¿ç”¨ jvm å‚æ•° UseContainerSupport é…ç½®ï¼Œ é»˜è®¤å¼€å¯</li>
</ul>
</blockquote>
<h3 id="47-udp">4.7 UDP</h3>
<ul>
<li>UDP æ˜¯æ— è¿æ¥çš„ï¼Œclient å‘é€æ•°æ®ä¸ä¼šç®¡ server æ˜¯å¦å¼€å¯</li>
<li>server è¿™è¾¹çš„ receive æ–¹æ³•ä¼šå°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å…¥ byte bufferï¼Œä½†å¦‚æœæ•°æ®æŠ¥æ–‡è¶…è¿‡ buffer å¤§å°ï¼Œå¤šå‡ºæ¥çš„æ•°æ®ä¼šè¢«é»˜é»˜æŠ›å¼ƒ</li>
</ul>
<p>é¦–å…ˆå¯åŠ¨æœåŠ¡å™¨ç«¯</p>
<pre><code class="language-java">public class UdpServer {
    public static void main(String[] args) {
        try (DatagramChannel channel = DatagramChannel.open()) {
            channel.socket().bind(new InetSocketAddress(9999));
            System.out.println(&quot;waiting...&quot;);
            ByteBuffer buffer = ByteBuffer.allocate(32);
            channel.receive(buffer);
            buffer.flip();
            debug(buffer);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code>waiting...
</code></pre>
<p>è¿è¡Œå®¢æˆ·ç«¯</p>
<pre><code class="language-java">public class UdpClient {
    public static void main(String[] args) {
        try (DatagramChannel channel = DatagramChannel.open()) {
            ByteBuffer buffer = StandardCharsets.UTF_8.encode(&quot;hello&quot;);
            InetSocketAddress address = new InetSocketAddress(&quot;localhost&quot;, 9999);
            channel.send(buffer, address);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>æ¥ä¸‹æ¥æœåŠ¡å™¨ç«¯è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
</code></pre>
<h2 id="5-nio-vs-bio">5. NIO vs BIO</h2>
<h3 id="51-stream-vs-channel">5.1 stream vs channel</h3>
<ul>
<li>stream ä¸ä¼šè‡ªåŠ¨ç¼“å†²æ•°æ®ï¼Œchannel ä¼šåˆ©ç”¨ç³»ç»Ÿæä¾›çš„å‘é€ç¼“å†²åŒºã€æ¥æ”¶ç¼“å†²åŒºï¼ˆæ›´ä¸ºåº•å±‚ï¼‰</li>
<li>stream ä»…æ”¯æŒé˜»å¡ APIï¼Œchannel åŒæ—¶æ”¯æŒé˜»å¡ã€éé˜»å¡ APIï¼Œç½‘ç»œ channel å¯é…åˆ selector å®ç°å¤šè·¯å¤ç”¨</li>
<li>äºŒè€…å‡ä¸ºå…¨åŒå·¥ï¼Œå³è¯»å†™å¯ä»¥åŒæ—¶è¿›è¡Œ</li>
</ul>
<h3 id="52-io-æ¨¡å‹">5.2 IO æ¨¡å‹</h3>
<p>åŒæ­¥é˜»å¡ã€åŒæ­¥éé˜»å¡ã€åŒæ­¥å¤šè·¯å¤ç”¨ã€å¼‚æ­¥é˜»å¡ï¼ˆæ²¡æœ‰æ­¤æƒ…å†µï¼‰ã€å¼‚æ­¥éé˜»å¡</p>
<ul>
<li>åŒæ­¥ï¼šçº¿ç¨‹è‡ªå·±å»è·å–ç»“æœï¼ˆä¸€ä¸ªçº¿ç¨‹ï¼‰</li>
<li>å¼‚æ­¥ï¼šçº¿ç¨‹è‡ªå·±ä¸å»è·å–ç»“æœï¼Œè€Œæ˜¯ç”±å…¶å®ƒçº¿ç¨‹é€ç»“æœï¼ˆè‡³å°‘ä¸¤ä¸ªçº¿ç¨‹ï¼‰</li>
</ul>
<p>å½“è°ƒç”¨ä¸€æ¬¡ channel.read æˆ– stream.read åï¼Œä¼šåˆ‡æ¢è‡³æ“ä½œç³»ç»Ÿå†…æ ¸æ€æ¥å®ŒæˆçœŸæ­£æ•°æ®è¯»å–ï¼Œè€Œè¯»å–åˆåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li>ç­‰å¾…æ•°æ®é˜¶æ®µ</li>
<li>å¤åˆ¶æ•°æ®é˜¶æ®µ</li>
</ul>
<figure data-type="image" tabindex="5"><img src="img/0033.png" alt="" loading="lazy"></figure>
<ul>
<li>
<p>é˜»å¡ IO</p>
<figure data-type="image" tabindex="6"><img src="img/0039.png" alt="" loading="lazy"></figure>
</li>
<li>
<p>éé˜»å¡  IO</p>
<figure data-type="image" tabindex="7"><img src="img/0035.png" alt="" loading="lazy"></figure>
</li>
<li>
<p>å¤šè·¯å¤ç”¨</p>
<figure data-type="image" tabindex="8"><img src="img/0038.png" alt="" loading="lazy"></figure>
</li>
<li>
<p>ä¿¡å·é©±åŠ¨</p>
</li>
<li>
<p>å¼‚æ­¥ IO</p>
<figure data-type="image" tabindex="9"><img src="img/0037.png" alt="" loading="lazy"></figure>
</li>
<li>
<p>é˜»å¡ IO vs å¤šè·¯å¤ç”¨</p>
<figure data-type="image" tabindex="10"><img src="img/0034.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="11"><img src="img/0036.png" alt="" loading="lazy"></figure>
</li>
</ul>
<h4 id="å‚è€ƒ">ğŸ”– å‚è€ƒ</h4>
<p>UNIX ç½‘ç»œç¼–ç¨‹ - å· I</p>
<h3 id="53-é›¶æ‹·è´">5.3 é›¶æ‹·è´</h3>
<h4 id="ä¼ ç»Ÿ-io-é—®é¢˜">ä¼ ç»Ÿ IO é—®é¢˜</h4>
<p>ä¼ ç»Ÿçš„ IO å°†ä¸€ä¸ªæ–‡ä»¶é€šè¿‡ socket å†™å‡º</p>
<pre><code class="language-java">File f = new File(&quot;helloword/data.txt&quot;);
RandomAccessFile file = new RandomAccessFile(file, &quot;r&quot;);

byte[] buf = new byte[(int)f.length()];
file.read(buf);

Socket socket = ...;
socket.getOutputStream().write(buf);
</code></pre>
<p>å†…éƒ¨å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<figure data-type="image" tabindex="12"><img src="img/0024.png" alt="" loading="lazy"></figure>
<ol>
<li>
<p>java æœ¬èº«å¹¶ä¸å…·å¤‡ IO è¯»å†™èƒ½åŠ›ï¼Œå› æ­¤ read æ–¹æ³•è°ƒç”¨åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œå»è°ƒç”¨æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰çš„è¯»èƒ½åŠ›ï¼Œå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ã€‚è¿™æœŸé—´ç”¨æˆ·çº¿ç¨‹é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ DMAï¼ˆDirect Memory Accessï¼‰æ¥å®ç°æ–‡ä»¶è¯»ï¼Œå…¶é—´ä¹Ÿä¸ä¼šä½¿ç”¨ cpu</p>
<blockquote>
<p>DMA ä¹Ÿå¯ä»¥ç†è§£ä¸ºç¡¬ä»¶å•å…ƒï¼Œç”¨æ¥è§£æ”¾ cpu å®Œæˆæ–‡ä»¶ IO</p>
</blockquote>
</li>
<li>
<p>ä»<strong>å†…æ ¸æ€</strong>åˆ‡æ¢å›<strong>ç”¨æˆ·æ€</strong>ï¼Œå°†æ•°æ®ä»<strong>å†…æ ¸ç¼“å†²åŒº</strong>è¯»å…¥<strong>ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆå³ byte[] bufï¼‰ï¼Œè¿™æœŸé—´ cpu ä¼šå‚ä¸æ‹·è´ï¼Œæ— æ³•åˆ©ç”¨ DMA</p>
</li>
<li>
<p>è°ƒç”¨ write æ–¹æ³•ï¼Œè¿™æ—¶å°†æ•°æ®ä»<strong>ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆbyte[] bufï¼‰å†™å…¥ <strong>socket ç¼“å†²åŒº</strong>ï¼Œcpu ä¼šå‚ä¸æ‹·è´</p>
</li>
<li>
<p>æ¥ä¸‹æ¥è¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè¿™é¡¹èƒ½åŠ› java åˆä¸å…·å¤‡ï¼Œå› æ­¤åˆå¾—ä»<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçš„å†™èƒ½åŠ›ï¼Œä½¿ç”¨ DMA å°† <strong>socket ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</p>
</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ä¸­é—´ç¯èŠ‚è¾ƒå¤šï¼Œjava çš„ IO å®é™…ä¸æ˜¯ç‰©ç†è®¾å¤‡çº§åˆ«çš„è¯»å†™ï¼Œè€Œæ˜¯ç¼“å­˜çš„å¤åˆ¶ï¼Œåº•å±‚çš„çœŸæ­£è¯»å†™æ˜¯æ“ä½œç³»ç»Ÿæ¥å®Œæˆçš„</p>
<ul>
<li>ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢å‘ç”Ÿäº† 3 æ¬¡ï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒé‡é‡çº§</li>
<li>æ•°æ®æ‹·è´äº†å…± 4 æ¬¡</li>
</ul>
<h4 id="nio-ä¼˜åŒ–">NIO ä¼˜åŒ–</h4>
<p>é€šè¿‡ DirectByteBuf</p>
<ul>
<li>ByteBuffer.allocate(10)  HeapByteBuffer ä½¿ç”¨çš„è¿˜æ˜¯ java å†…å­˜</li>
<li>ByteBuffer.allocateDirect(10)  DirectByteBuffer ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜</li>
</ul>
<figure data-type="image" tabindex="13"><img src="img/0025.png" alt="" loading="lazy"></figure>
<p>å¤§éƒ¨åˆ†æ­¥éª¤ä¸ä¼˜åŒ–å‰ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚å”¯æœ‰ä¸€ç‚¹ï¼šjava å¯ä»¥ä½¿ç”¨ DirectByteBuf å°†å †å¤–å†…å­˜æ˜ å°„åˆ° jvm å†…å­˜ä¸­æ¥ç›´æ¥è®¿é—®ä½¿ç”¨</p>
<ul>
<li>è¿™å—å†…å­˜ä¸å— jvm åƒåœ¾å›æ”¶çš„å½±å“ï¼Œå› æ­¤å†…å­˜åœ°å€å›ºå®šï¼Œæœ‰åŠ©äº IO è¯»å†™</li>
<li>java ä¸­çš„ DirectByteBuf å¯¹è±¡ä»…ç»´æŠ¤äº†æ­¤å†…å­˜çš„è™šå¼•ç”¨ï¼Œå†…å­˜å›æ”¶åˆ†æˆä¸¤æ­¥
<ul>
<li>DirectByteBuf å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œå°†è™šå¼•ç”¨åŠ å…¥å¼•ç”¨é˜Ÿåˆ—</li>
<li>é€šè¿‡ä¸“é—¨çº¿ç¨‹è®¿é—®å¼•ç”¨é˜Ÿåˆ—ï¼Œæ ¹æ®è™šå¼•ç”¨é‡Šæ”¾å †å¤–å†…å­˜</li>
</ul>
</li>
<li>å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢æ¬¡æ•°æ²¡æœ‰å‡å°‘</li>
</ul>
<p>è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆåº•å±‚é‡‡ç”¨äº† linux 2.1 åæä¾›çš„ sendFile æ–¹æ³•ï¼‰ï¼Œjava ä¸­å¯¹åº”ç€ä¸¤ä¸ª channel è°ƒç”¨ transferTo/transferFrom æ–¹æ³•æ‹·è´æ•°æ®</p>
<figure data-type="image" tabindex="14"><img src="img/0026.png" alt="" loading="lazy"></figure>
<ol>
<li>java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>
<li>æ•°æ®ä»<strong>å†…æ ¸ç¼“å†²åŒº</strong>ä¼ è¾“åˆ° <strong>socket ç¼“å†²åŒº</strong>ï¼Œcpu ä¼šå‚ä¸æ‹·è´</li>
<li>æœ€åä½¿ç”¨ DMA å°† <strong>socket ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°</p>
<ul>
<li>åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li>
<li>æ•°æ®æ‹·è´äº† 3 æ¬¡</li>
</ul>
<p>è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆlinux 2.4ï¼‰</p>
<figure data-type="image" tabindex="15"><img src="img/0027.png" alt="" loading="lazy"></figure>
<ol>
<li>java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>
<li>åªä¼šå°†ä¸€äº› offset å’Œ length ä¿¡æ¯æ‹·å…¥ <strong>socket ç¼“å†²åŒº</strong>ï¼Œå‡ ä¹æ— æ¶ˆè€—</li>
<li>ä½¿ç”¨ DMA å°† <strong>å†…æ ¸ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>
</ol>
<p>æ•´ä¸ªè¿‡ç¨‹ä»…åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ•°æ®æ‹·è´äº† 2 æ¬¡ã€‚æ‰€è°“çš„ã€é›¶æ‹·è´ã€‘ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ— æ‹·è´ï¼Œè€Œæ˜¯åœ¨ä¸ä¼šæ‹·è´é‡å¤æ•°æ®åˆ° jvm å†…å­˜ä¸­ï¼Œé›¶æ‹·è´çš„ä¼˜ç‚¹æœ‰</p>
<ul>
<li>æ›´å°‘çš„ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li>
<li>ä¸åˆ©ç”¨ cpu è®¡ç®—ï¼Œå‡å°‘ cpu ç¼“å­˜ä¼ªå…±äº«</li>
<li>é›¶æ‹·è´é€‚åˆå°æ–‡ä»¶ä¼ è¾“</li>
</ul>
<h3 id="53-aio">5.3 AIO</h3>
<p>AIO ç”¨æ¥è§£å†³æ•°æ®å¤åˆ¶é˜¶æ®µçš„é˜»å¡é—®é¢˜</p>
<ul>
<li>åŒæ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…ç»“æœï¼Œè¿˜æ˜¯ç›¸å½“äºé—²ç½®</li>
<li>å¼‚æ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸å¿…ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯å°†æ¥ç”±æ“ä½œç³»ç»Ÿæ¥é€šè¿‡å›è°ƒæ–¹å¼ç”±å¦å¤–çš„çº¿ç¨‹æ¥è·å¾—ç»“æœ</li>
</ul>
<blockquote>
<p>å¼‚æ­¥æ¨¡å‹éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰æä¾›æ”¯æŒ</p>
<ul>
<li>Windows ç³»ç»Ÿé€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ IO</li>
<li>Linux ç³»ç»Ÿå¼‚æ­¥ IO åœ¨ 2.6 ç‰ˆæœ¬å¼•å…¥ï¼Œä½†å…¶åº•å±‚å®ç°è¿˜æ˜¯ç”¨å¤šè·¯å¤ç”¨æ¨¡æ‹Ÿäº†å¼‚æ­¥ IOï¼Œæ€§èƒ½æ²¡æœ‰ä¼˜åŠ¿</li>
</ul>
</blockquote>
<h4 id="æ–‡ä»¶-aio">æ–‡ä»¶ AIO</h4>
<p>å…ˆæ¥çœ‹çœ‹ AsynchronousFileChannel</p>
<pre><code class="language-java">@Slf4j
public class AioDemo1 {
    public static void main(String[] args) throws IOException {
        try{
            AsynchronousFileChannel s = 
                AsynchronousFileChannel.open(
                	Paths.get(&quot;1.txt&quot;), StandardOpenOption.READ);
            ByteBuffer buffer = ByteBuffer.allocate(2);
            log.debug(&quot;begin...&quot;);
            s.read(buffer, 0, null, new CompletionHandler&lt;Integer, ByteBuffer&gt;() {
                @Override
                public void completed(Integer result, ByteBuffer attachment) {
                    log.debug(&quot;read completed...{}&quot;, result);
                    buffer.flip();
                    debug(buffer);
                }

                @Override
                public void failed(Throwable exc, ByteBuffer attachment) {
                    log.debug(&quot;read failed...&quot;);
                }
            });

        } catch (IOException e) {
            e.printStackTrace();
        }
        log.debug(&quot;do other things...&quot;);
        System.in.read();
    }
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code>13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - begin...
13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - do other things...
13:44:56 [DEBUG] [Thread-5] c.i.aio.AioDemo1 - read completed...2
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 0d                                           |a.              |
+--------+-------------------------------------------------+----------------+
</code></pre>
<p>å¯ä»¥çœ‹åˆ°</p>
<ul>
<li>å“åº”æ–‡ä»¶è¯»å–æˆåŠŸçš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ Thread-5</li>
<li>ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰ IO æ“ä½œé˜»å¡</li>
</ul>
<h4 id="å®ˆæŠ¤çº¿ç¨‹">ğŸ’¡ å®ˆæŠ¤çº¿ç¨‹</h4>
<p>é»˜è®¤æ–‡ä»¶ AIO ä½¿ç”¨çš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥æœ€åè¦æ‰§è¡Œ <code>System.in.read()</code> ä»¥é¿å…å®ˆæŠ¤çº¿ç¨‹æ„å¤–ç»“æŸ</p>
<h4 id="ç½‘ç»œ-aio">ç½‘ç»œ AIO</h4>
<pre><code class="language-java">public class AioServer {
    public static void main(String[] args) throws IOException {
        AsynchronousServerSocketChannel ssc = AsynchronousServerSocketChannel.open();
        ssc.bind(new InetSocketAddress(8080));
        ssc.accept(null, new AcceptHandler(ssc));
        System.in.read();
    }

    private static void closeChannel(AsynchronousSocketChannel sc) {
        try {
            System.out.printf(&quot;[%s] %s close\n&quot;, Thread.currentThread().getName(), sc.getRemoteAddress());
            sc.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static class ReadHandler implements CompletionHandler&lt;Integer, ByteBuffer&gt; {
        private final AsynchronousSocketChannel sc;

        public ReadHandler(AsynchronousSocketChannel sc) {
            this.sc = sc;
        }

        @Override
        public void completed(Integer result, ByteBuffer attachment) {
            try {
                if (result == -1) {
                    closeChannel(sc);
                    return;
                }
                System.out.printf(&quot;[%s] %s read\n&quot;, Thread.currentThread().getName(), sc.getRemoteAddress());
                attachment.flip();
                System.out.println(Charset.defaultCharset().decode(attachment));
                attachment.clear();
                // å¤„ç†å®Œç¬¬ä¸€ä¸ª read æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ read æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª read äº‹ä»¶
                sc.read(attachment, attachment, this);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        @Override
        public void failed(Throwable exc, ByteBuffer attachment) {
            closeChannel(sc);
            exc.printStackTrace();
        }
    }

    private static class WriteHandler implements CompletionHandler&lt;Integer, ByteBuffer&gt; {
        private final AsynchronousSocketChannel sc;

        private WriteHandler(AsynchronousSocketChannel sc) {
            this.sc = sc;
        }

        @Override
        public void completed(Integer result, ByteBuffer attachment) {
            // å¦‚æœä½œä¸ºé™„ä»¶çš„ buffer è¿˜æœ‰å†…å®¹ï¼Œéœ€è¦å†æ¬¡ write å†™å‡ºå‰©ä½™å†…å®¹
            if (attachment.hasRemaining()) {
                sc.write(attachment);
            }
        }

        @Override
        public void failed(Throwable exc, ByteBuffer attachment) {
            exc.printStackTrace();
            closeChannel(sc);
        }
    }

    private static class AcceptHandler implements CompletionHandler&lt;AsynchronousSocketChannel, Object&gt; {
        private final AsynchronousServerSocketChannel ssc;

        public AcceptHandler(AsynchronousServerSocketChannel ssc) {
            this.ssc = ssc;
        }

        @Override
        public void completed(AsynchronousSocketChannel sc, Object attachment) {
            try {
                System.out.printf(&quot;[%s] %s connected\n&quot;, Thread.currentThread().getName(), sc.getRemoteAddress());
            } catch (IOException e) {
                e.printStackTrace();
            }
            ByteBuffer buffer = ByteBuffer.allocate(16);
            // è¯»äº‹ä»¶ç”± ReadHandler å¤„ç†
            sc.read(buffer, buffer, new ReadHandler(sc));
            // å†™äº‹ä»¶ç”± WriteHandler å¤„ç†
            sc.write(Charset.defaultCharset().encode(&quot;server hello!&quot;), ByteBuffer.allocate(16), new WriteHandler(sc));
            // å¤„ç†å®Œç¬¬ä¸€ä¸ª accpet æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ accept æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª accept äº‹ä»¶
            ssc.accept(null, this);
        }

        @Override
        public void failed(Throwable exc, Object attachment) {
            exc.printStackTrace();
        }
    }
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[JAVAå¹¶å‘ï¼ˆäºŒï¼‰]]></title>
        <id>https://q456qq520.github.io/post/java-bing-fa-er/</id>
        <link href="https://q456qq520.github.io/post/java-bing-fa-er/">
        </link>
        <updated>2022-08-10T06:52:00.000Z</updated>
        <content type="html"><![CDATA[<h1 id="4-javaä¸­çš„é”">4ã€Javaä¸­çš„é”</h1>
<h2 id="41-lockæ¥å£">4.1 Lockæ¥å£</h2>
<p>é”æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼ˆä½†æ˜¯æœ‰äº›é”å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„è®¿é—®å…±äº«èµ„æºï¼Œæ¯”å¦‚è¯»å†™é”ï¼‰ã€‚åœ¨Lockæ¥å£å‡ºç°ä¹‹å‰ï¼ŒJavaç¨‹åºæ˜¯é synchronizedå…³é”®å­—å®ç°é”åŠŸèƒ½çš„ï¼Œè€ŒJava SE 5ä¹‹åï¼Œå¹¶å‘åŒ…ä¸­æ–°å¢äº†<strong>Lockæ¥å£</strong>ï¼ˆä»¥åŠç›¸å…³å®ç°ç±»ï¼‰ç”¨æ¥å®ç°é”åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸<strong>synchronized</strong>å…³é”®å­—ç±»ä¼¼çš„åŒæ­¥åŠŸèƒ½ï¼Œåªæ˜¯åœ¨ä½¿ç”¨æ—¶éœ€è¦æ˜¾å¼åœ°è·å–å’Œé‡Šæ”¾é”ã€‚è™½ç„¶å®ƒç¼ºå°‘äº†ï¼ˆé€šè¿‡synchronizedå—æˆ–è€…æ–¹æ³•æ‰€æä¾›çš„ï¼‰éšå¼è·å–é‡Šæ”¾é”çš„ä¾¿æ·æ€§ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†é”è·å–ä¸é‡Šæ”¾çš„å¯æ“ä½œæ€§ã€å¯ä¸­æ–­çš„è·å–é”ä»¥åŠè¶…æ—¶è·å–é”ç­‰å¤šç§synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„åŒæ­¥ç‰¹æ€§ã€‚</p>
<p>ä½¿ç”¨synchronizedå…³é”®å­—å°†ä¼šéšå¼åœ°è·å–é”ï¼Œä½†æ˜¯å®ƒå°†é”çš„è·å–å’Œé‡Šæ”¾å›ºåŒ–äº†ï¼Œä¹Ÿå°±æ˜¯å…ˆè·å–å†é‡Šæ”¾ã€‚å½“ç„¶ï¼Œè¿™ç§æ–¹å¼ç®€åŒ–äº†åŒæ­¥çš„ç®¡ç†ï¼Œå¯æ˜¯æ‰©å±•æ€§æ²¡æœ‰æ˜¾ç¤ºçš„é”è·å–å’Œé‡Šæ”¾æ¥çš„å¥½ã€‚ä¾‹å¦‚ï¼Œé’ˆå¯¹ä¸€ä¸ªåœºæ™¯ï¼Œæ‰‹æŠŠæ‰‹è¿›è¡Œé”è·å–å’Œé‡Šæ”¾ï¼Œå…ˆè·å¾—é”Aï¼Œç„¶åå†è·å–é”Bï¼Œå½“é”Bè·å¾—åï¼Œé‡Šæ”¾é”AåŒæ—¶è·å–é”Cï¼Œå½“é”Cè·å¾—åï¼Œå†é‡Šæ”¾BåŒæ—¶è·å–é”Dï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™ç§åœºæ™¯ä¸‹ï¼Œsynchronizedå…³é”®å­—å°±ä¸é‚£ä¹ˆå®¹æ˜“å®ç°äº†ï¼Œè€Œä½¿ç”¨Lockå´å®¹æ˜“è®¸å¤šã€‚</p>
<p>Lockçš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œä»£ç æ¸…å•4-1æ˜¯Lockçš„ä½¿ç”¨çš„æ–¹å¼ã€‚</p>
<blockquote>
<p>ä»£ç æ¸…å•4-1 LockUseCase.java</p>
</blockquote>
<pre><code class="language-java">Lock lock = new ReentrantLock();
lock.lock();
try {
            
} finally {
    lock.unlock();
}
</code></pre>
<p>åœ¨finallyå—ä¸­é‡Šæ”¾é”ï¼Œç›®çš„æ˜¯ä¿è¯åœ¨è·å–åˆ°é”ä¹‹åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¢«é‡Šæ”¾ã€‚<em>ä¸è¦å°†è·å–é”çš„è¿‡ç¨‹å†™åœ¨tryå—ä¸­ï¼Œå› ä¸ºå¦‚æœåœ¨è·å–é”ï¼ˆè‡ªå®šä¹‰é”çš„å®ç°ï¼‰æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼‚å¸¸æŠ›å‡ºçš„åŒæ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´é”æ— æ•…é‡Šæ”¾ã€‚</em></p>
<p>Lockæ¥å£æä¾›çš„synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„ä¸»è¦ç‰¹æ€§å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1660118700493.png" alt="Lockæ¥å£æä¾›çš„synchronizedå…³é”®å­—ä¸å…·å¤‡çš„ä¸»è¦ç‰¹æ€§" loading="lazy"></figure>
<p>Lockæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå®šä¹‰äº†é”è·å–å’Œé‡Šæ”¾çš„åŸºæœ¬æ“ä½œï¼ŒLockçš„APIå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p>Lockçš„API</p>
</blockquote>
<pre><code class="language-java">
//è·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å½“å‰çº¿ç¨‹ä¼šè·å–é”ï¼Œå½“é”è·å¾—åï¼Œè¿”å›
void lock();

//å¯ä¸­æ–­è·å–é”ï¼Œå³åœ¨é”çš„è·å–ä¸­å¯ä¸­æ–­å½“å‰çº¿ç¨‹
void lockInterruptibly() throws InterruptedException;

//å°è¯•éé˜»å¡çš„è·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•åç«‹å³è¿”å›ï¼Œå¦‚æœèƒ½å¤Ÿè·å–åˆ™è¿”å›tureï¼Œåä¹‹false
boolean tryLock();

//è¶…æ—¶è·å–é”ï¼Œå½“å‰çº¿ç¨‹åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¼šè¿”å›
//1ã€å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è·å¾—é”
//2ã€å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è¢«ä¸­æ–­
//3ã€è¶…æ—¶æ—¶é—´ç»“æŸ,è¿”å›false
boolean tryLock(long time, TimeUnit unit) throws InterruptedException;

//é‡Šæ”¾é”
void unlock();

//è·å–ç­‰å¾…é€šçŸ¥ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å’Œå½“å‰é”ç»‘å®šã€‚å½“å‰çº¿ç¨‹åªæœ‰è·å–äº†é”ï¼Œæ‰èƒ½è°ƒç”¨è¯¥ç»„ä»¶å¤§wait()ï¼Œè€Œè°ƒç”¨åå½“å‰çº¿ç¨‹é‡Šæ”¾é”
Condition newCondition();
</code></pre>
<p>Lockæ¥å£çš„å®ç°åŸºæœ¬éƒ½æ˜¯é€šè¿‡èšåˆäº†ä¸€ä¸ªåŒæ­¥å™¨çš„å­ç±»æ¥å®Œæˆçº¿ç¨‹è®¿é—®æ§åˆ¶çš„ã€‚</p>
<h2 id="42-é˜Ÿåˆ—åŒæ­¥å™¨">4.2 é˜Ÿåˆ—åŒæ­¥å™¨</h2>
<p>é˜Ÿåˆ—åŒæ­¥å™¨AbstractQueuedSynchronizerï¼ˆä»¥ä¸‹ç®€ç§°åŒæ­¥å™¨ï¼‰ï¼Œæ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ª<strong>intæˆå‘˜å˜é‡</strong>è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚</p>
<p>åŒæ­¥å™¨çš„ä¸»è¦ä½¿ç”¨æ–¹å¼æ˜¯ç»§æ‰¿ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿åŒæ­¥å™¨å¹¶å®ç°å®ƒçš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œåœ¨æŠ½è±¡æ–¹æ³•çš„å®ç°è¿‡ç¨‹ä¸­å…ä¸äº†è¦å¯¹åŒæ­¥çŠ¶æ€è¿›è¡Œæ›´æ”¹ï¼Œè¿™æ—¶å°±éœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„3ä¸ªæ–¹æ³•ï¼ˆgetState()ã€setState(int newState)å’ŒcompareAndSetState(int expect,int update)ï¼‰æ¥è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå®ƒä»¬èƒ½å¤Ÿä¿è¯çŠ¶æ€çš„æ”¹å˜æ˜¯å®‰å…¨çš„ã€‚</p>
<p>åŒæ­¥å™¨è‡ªèº«æ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£ï¼Œå®ƒä»…ä»…æ˜¯å®šä¹‰äº†è‹¥å¹²åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾çš„æ–¹æ³•æ¥ä¾›è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ä½¿ç”¨ï¼ŒåŒæ­¥å™¨æ—¢å¯ä»¥æ”¯æŒç‹¬å å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥æ”¯æŒå…±äº«å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿å®ç°ä¸åŒç±»å‹çš„åŒæ­¥ç»„ä»¶ï¼ˆReentrantLockã€ReentrantReadWriteLockå’ŒCountDownLatchç­‰ï¼‰ã€‚</p>
<p>åŒæ­¥å™¨æ˜¯å®ç°é”ï¼ˆä¹Ÿå¯ä»¥æ˜¯ä»»æ„åŒæ­¥ç»„ä»¶ï¼‰çš„å…³é”®ï¼Œåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨ï¼Œåˆ©ç”¨åŒæ­¥å™¨å®ç°é”çš„è¯­ä¹‰ã€‚å¯ä»¥è¿™æ ·ç†è§£äºŒè€…ä¹‹é—´çš„å…³ç³»ï¼š<strong>é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…ä¸é”äº¤äº’çš„æ¥å£ï¼ˆæ¯”å¦‚å¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹å¹¶è¡Œè®¿é—®ï¼‰ï¼Œéšè—äº†å®ç°ç»†èŠ‚ï¼›åŒæ­¥å™¨é¢å‘çš„æ˜¯é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ä¸å”¤é†’ç­‰åº•å±‚æ“ä½œã€‚</strong></p>
<h3 id="421-é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£ä¸ç¤ºä¾‹">4.2.1 é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£ä¸ç¤ºä¾‹</h3>
<p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäº<strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</strong>çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨è€…éœ€è¦ç»§æ‰¿åŒæ­¥å™¨å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ï¼Œéšåå°†åŒæ­¥å™¨ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•å°†ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚</p>
<p>é‡å†™åŒæ­¥å™¨æŒ‡å®šçš„æ–¹æ³•æ—¶ï¼Œéœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„å¦‚ä¸‹3ä¸ªæ–¹æ³•æ¥è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€ã€‚</p>
<p>getState()ï¼šè·å–å½“å‰åŒæ­¥çŠ¶æ€ã€‚<br>
setState(int newState)ï¼šè®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€ã€‚<br>
compareAndSetState(int expect,int update)ï¼šä½¿ç”¨CASè®¾ç½®å½“å‰çŠ¶æ€ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿä¿è¯çŠ¶æ€è®¾ç½®çš„åŸå­æ€§ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1660120867568.png" alt="åŒæ­¥å™¨å¯é‡å†™çš„æ–¹æ³•" loading="lazy"></figure>
<p>å®ç°è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶æ—¶ï¼Œå°†ä¼šè°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://q456qq520.github.io/post-images/1660121528935.png" alt="åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•" loading="lazy"></figure>
<p>åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•åŸºæœ¬ä¸Šåˆ†ä¸º3ç±»ï¼š<strong>ç‹¬å å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€</strong>ã€<strong>å…±äº«å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€</strong>å’Œ<strong>æŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µ</strong>ã€‚è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶å°†ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•æ¥å®ç°è‡ªå·±çš„åŒæ­¥è¯­ä¹‰ã€‚</p>
<p>åªæœ‰æŒæ¡äº†åŒæ­¥å™¨çš„å·¥ä½œåŸç†æ‰èƒ½æ›´åŠ æ·±å…¥åœ°ç†è§£å¹¶å‘åŒ…ä¸­å…¶ä»–çš„å¹¶å‘ç»„ä»¶ï¼Œæ‰€ä»¥ä¸‹é¢é€šè¿‡ä¸€ä¸ªç‹¬å é”çš„ç¤ºä¾‹æ¥æ·±å…¥äº†è§£ä¸€ä¸‹åŒæ­¥å™¨çš„å·¥ä½œåŸç†ã€‚</p>
<p>é¡¾åæ€ä¹‰ï¼Œ<strong>ç‹¬å é”å°±æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”ï¼Œè€Œå…¶ä»–è·å–é”çš„çº¿ç¨‹åªèƒ½å¤„äºåŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œåªæœ‰è·å–é”çš„çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåç»§çš„çº¿ç¨‹æ‰èƒ½å¤Ÿè·å–é”</strong>ï¼Œå¦‚ä»£ç æ¸…å•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">package cm.lock;

import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.AbstractQueuedSynchronizer;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;

/**
 * ç‹¬å é”
 * @author likecat
 * @version 1.0
 * @date 2022/8/10 16:58
 */
public class Mutex implements Lock {
    // é™æ€å†…éƒ¨ç±»ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨
    private static class Sync extends AbstractQueuedSynchronizer {
        // æ˜¯å¦å¤„äºå ç”¨çŠ¶æ€
        protected boolean isHeldExclusively() {
            return getState() == 1;
        }
        // å½“çŠ¶æ€ä¸º0çš„æ—¶å€™è·å–é”
        public boolean tryAcquire(int acquires) {
            if (compareAndSetState(0, 1)) {
                ////è®¾ç½®æ‹¥æœ‰çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }
        // é‡Šæ”¾é”ï¼Œå°†çŠ¶æ€è®¾ç½®ä¸º0
        protected boolean tryRelease(int releases) {
            if (getState() == 0) throw new
                    IllegalMonitorStateException();
            setExclusiveOwnerThread(null);
            setState(0);
            return true;
        }
        // è¿”å›ä¸€ä¸ªConditionï¼Œæ¯ä¸ªconditionéƒ½åŒ…å«äº†ä¸€ä¸ªconditioné˜Ÿåˆ—
        Condition newCondition() { return new ConditionObject(); }
    }
    // ä»…éœ€è¦å°†æ“ä½œä»£ç†åˆ°Syncä¸Šå³å¯
    private final Sync sync = new Sync();
    public void lock() { sync.acquire(1); }
    public boolean tryLock() { return sync.tryAcquire(1); }
    public void unlock() { sync.release(1); }
    public Condition newCondition() { return sync.newCondition(); }
    public boolean isLocked() { return sync.isHeldExclusively(); }
    public boolean hasQueuedThreads() { return sync.hasQueuedThreads(); }
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireInterruptibly(1);
    }
    public boolean tryLock(long timeout, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquireNanos(1, unit.toNanos(timeout));
    }
}
</code></pre>
<p>ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œç‹¬å é”Mutexæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ï¼Œå®ƒåœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å æœ‰é”ã€‚Mutexä¸­å®šä¹‰äº†ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œè¯¥å†…éƒ¨ç±»ç»§æ‰¿äº†åŒæ­¥å™¨å¹¶å®ç°äº†ç‹¬å å¼è·å–å’Œé‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚</p>
<p>åœ¨tryAcquire(int acquires)æ–¹æ³•ä¸­ï¼Œå¦‚æœç»è¿‡CASè®¾ç½®æˆåŠŸï¼ˆåŒæ­¥çŠ¶æ€è®¾ç½®ä¸º1ï¼‰ï¼Œåˆ™ä»£è¡¨è·å–äº†åŒæ­¥çŠ¶æ€ï¼Œè€Œåœ¨tryRelease(int releases)æ–¹æ³•ä¸­åªæ˜¯å°†åŒæ­¥çŠ¶æ€é‡ç½®ä¸º0ã€‚ç”¨æˆ·ä½¿ç”¨Mutexæ—¶å¹¶ä¸ä¼šç›´æ¥å’Œå†…éƒ¨åŒæ­¥å™¨çš„å®ç°æ‰“äº¤é“ï¼Œè€Œæ˜¯è°ƒç”¨Mutexæä¾›çš„æ–¹æ³•ï¼Œåœ¨Mutexçš„å®ç°ä¸­ï¼Œä»¥è·å–é”çš„lock()æ–¹æ³•ä¸ºä¾‹ï¼Œåªéœ€è¦åœ¨æ–¹æ³•å®ç°ä¸­è°ƒç”¨åŒæ­¥å™¨çš„æ¨¡æ¿æ–¹æ³•acquire(int args)å³å¯ï¼Œå½“å‰çº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åä¼šè¢«åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œè¿™æ ·å°±å¤§å¤§é™ä½äº†å®ç°ä¸€ä¸ªå¯é è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„é—¨æ§›ã€‚</p>
<h3 id="422-é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ">4.2.2 é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ</h3>
<p>åŒæ­¥å™¨æ˜¯å¦‚ä½•å®Œæˆçº¿ç¨‹åŒæ­¥çš„æ­¥éª¤ä¸»è¦åŒ…æ‹¬ï¼šåŒæ­¥é˜Ÿåˆ—ã€ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾ã€å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾ä»¥åŠè¶…æ—¶è·å–åŒæ­¥çŠ¶æ€ç­‰åŒæ­¥å™¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¸æ¨¡æ¿æ–¹æ³•</p>
<h5 id="1åŒæ­¥é˜Ÿåˆ—">1.åŒæ­¥é˜Ÿåˆ—</h5>
<p>åŒæ­¥å™¨ä¾èµ–å†…éƒ¨çš„åŒæ­¥é˜Ÿåˆ—ï¼ˆä¸€ä¸ªFIFOåŒå‘é˜Ÿåˆ—ï¼‰æ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†ï¼Œå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶ï¼ŒåŒæ­¥å™¨ä¼šå°†å½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œä¼šæŠŠé¦–èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚</p>
<p>åŒæ­¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼ˆNodeï¼‰ç”¨æ¥ä¿å­˜<strong>è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹å¼•ç”¨</strong>ã€<strong>ç­‰å¾…çŠ¶æ€</strong>ä»¥åŠ<strong>å‰é©±</strong>å’Œ<br>
<strong>åç»§èŠ‚ç‚¹</strong>ï¼ŒèŠ‚ç‚¹çš„å±æ€§ç±»å‹ä¸åç§°ä»¥åŠæè¿°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">static final class Node {
    static final int CANCELLED =  1;
    static final int SIGNAL =       -1;
    static final int CONDITION = -2;
    static final int PROPAGATE = -3;
    //ç­‰å¾…çŠ¶æ€ï¼ŒåŒ…å«å¦‚ä¸‹çŠ¶æ€
    //CANCELLED,å€¼ä¸º1,ç”±äºåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹ç­‰å¾…è¶…æ—¶æˆ–è€…è¢«ä¸­æ–­ï¼Œéœ€è¦ä»åŒæ­¥é˜Ÿåˆ—ä¸­å–æ¶ˆç­‰å¾…ï¼ŒèŠ‚ç‚¹è¿›å…¥è¯¥çŠ¶æ€å°†ä¸ä¼šå˜åŒ–
    //SIGNAL,å€¼ä¸º-1,åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œå½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹å¦‚æœé‡Šæ”¾äº†åŒæ­¥çŠ¶æ€æˆ–è€…è¢«å–æ¶ˆï¼Œå°†ä¼šé€šçŸ¥åç»§èŠ‚ç‚¹ï¼Œä½¿åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¾—ä»¥è¿è¡Œ
    //CONDITION,å€¼ä¸º-2,èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…åœ¨Conditionä¸Šï¼Œè€Œå½“å…¶ä»–çº¿ç¨‹å¯¹Conditionè°ƒç”¨äº† signalã€‚æ–¹æ³•åï¼Œè¯¥èŠ‚ç‚¹å°†ä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼ŒåŠ å…¥åˆ°å¯¹åŒæ­¥çŠ¶æ€çš„è·å–ä¸­
    //PROPAGATE,å€¼ä¸º-3.è¡¨ç¤ºä¸‹ä¸€æ¬¡å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–å°†ä¼šæ— æ¡ä»¶åœ°è¢«ä¼ æ’­ä¸‹å»
    //INITIAL,å€¼ä¸º0,åˆå§‹çŠ¶æ€
    volatile int waitStatus;

    //å‰é©±ç»“ç‚¹ï¼Œå½“å‰ç»“ç‚¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—æ—¶è¢«è®¾ç½®
    volatile Node prev;

    //åç»§ç»“ç‚¹
    volatile Node next;

    //ç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»§ç»“ç‚¹ï¼Œå¦‚æœå½“å‰ç»“ç‚¹æ˜¯å…±äº«çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—æ®µå°†æ˜¯ä¸€ä¸ªSHAREDå¸¸é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ç»“ç‚¹ç±»å‹ï¼ˆç‹¬å å’Œå…±äº«ï¼‰å’Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»§ç»“ç‚¹å…¬ç”¨ä¸€ä¸ªå­—æ®µ
    Node nextWaiter;

    //è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹
     volatile Thread thread;
}
</code></pre>
<p>èŠ‚ç‚¹æ˜¯æ„æˆåŒæ­¥é˜Ÿåˆ—çš„åŸºç¡€ï¼ŒåŒæ­¥å™¨æ‹¥æœ‰é¦–èŠ‚ç‚¹ï¼ˆheadï¼‰å’Œå°¾èŠ‚ç‚¹ï¼ˆtailï¼‰ï¼Œæ²¡æœ‰æˆåŠŸè·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†ä¼šæˆä¸ºèŠ‚ç‚¹åŠ å…¥è¯¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ŒåŒæ­¥é˜Ÿåˆ—çš„åŸºæœ¬ç»“æ„å¦‚å›¾ä¸‹æ‰€ç¤ºã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://q456qq520.github.io/post-images/1660147528285.png" alt="åŒæ­¥é˜Ÿåˆ—çš„åŸºæœ¬ç»“æ„" loading="lazy"></figure>
<p>åŒæ­¥å™¨åŒ…å«äº†ä¸¤ä¸ªèŠ‚ç‚¹ç±»å‹çš„å¼•ç”¨ï¼Œä¸€ä¸ªæŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œè€Œå¦ä¸€ä¸ªæŒ‡å‘å°¾èŠ‚ç‚¹ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æˆåŠŸåœ°è·å–äº†åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…é”ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹å°†æ— æ³•è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œè½¬è€Œè¢«æ„é€ æˆä¸ºèŠ‚ç‚¹å¹¶åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œè€Œè¿™ä¸ªåŠ å…¥é˜Ÿåˆ—çš„è¿‡ç¨‹å¿…é¡»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤åŒæ­¥å™¨æä¾›äº†ä¸€ä¸ªåŸºäºCASçš„è®¾ç½®å°¾èŠ‚ç‚¹çš„æ–¹æ³•ï¼šcompareAndSetTail(Node expect,Nodeupdate)ï¼Œï¼Œå®ƒéœ€è¦ä¼ é€’å½“å‰çº¿ç¨‹â€œè®¤ä¸ºâ€çš„å°¾èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹ï¼Œåªæœ‰è®¾ç½®æˆåŠŸåï¼Œå½“å‰èŠ‚ç‚¹æ‰æ­£å¼ä¸ä¹‹å‰çš„å°¾èŠ‚ç‚¹å»ºç«‹å…³è”ã€‚</p>
<p>åŒæ­¥é˜Ÿåˆ—éµå¾ªFIFOï¼Œé¦–èŠ‚ç‚¹æ˜¯è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„èŠ‚ç‚¹ï¼Œé¦–èŠ‚ç‚¹çš„çº¿ç¨‹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œå°†ä¼šå”¤é†’åç»§èŠ‚ç‚¹ï¼Œè€Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶å°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹ã€‚</p>
<p>è®¾ç½®é¦–èŠ‚ç‚¹æ˜¯é€šè¿‡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œç”±äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œå› æ­¤è®¾ç½®å¤´èŠ‚ç‚¹çš„æ–¹æ³•å¹¶ä¸éœ€è¦ä½¿ç”¨CASæ¥ä¿è¯ï¼Œå®ƒåªéœ€è¦å°†é¦–èŠ‚ç‚¹è®¾ç½®æˆä¸ºåŸé¦–èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å¹¶æ–­å¼€åŸé¦–èŠ‚ç‚¹çš„nextå¼•ç”¨å³å¯ã€‚</p>
<h5 id="2ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾">2.ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾</h5>
<p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„acquire(int arg)æ–¹æ³•å¯ä»¥è·å–åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸æ•æ„Ÿï¼Œä¹Ÿå°±æ˜¯ç”±äºçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åè¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåç»­å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸ä¼šä»åŒæ­¥é˜Ÿåˆ—ä¸­ç§»å‡ºã€‚</p>
<blockquote>
<p>åŒæ­¥å™¨çš„acquireæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">public final void acquire(int arg) {
        if (!tryAcquire(arg) &amp;&amp;
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            selfInterrupt();
    }
</code></pre>
<p>ä¸Šè¿°ä»£ç ä¸»è¦å®Œæˆäº†åŒæ­¥çŠ¶æ€è·å–ã€èŠ‚ç‚¹æ„é€ ã€åŠ å…¥åŒæ­¥é˜Ÿåˆ—ä»¥åŠåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­è‡ªæ—‹ç­‰å¾…çš„ç›¸å…³å·¥ä½œï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯ï¼šé¦–å…ˆè°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°çš„tryAcquire(int arg)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¿è¯çº¿ç¨‹å®‰å…¨çš„è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœåŒæ­¥çŠ¶æ€è·å–å¤±è´¥ï¼Œåˆ™æ„é€ åŒæ­¥èŠ‚ç‚¹ï¼ˆç‹¬å å¼Node.EXCLUSIVEï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼‰å¹¶é€šè¿‡addWaiter(Node node)æ–¹æ³•å°†è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œæœ€åè°ƒç”¨acquireQueued(Node node,int arg)æ–¹æ³•ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹ä»¥â€œæ­»å¾ªç¯â€çš„æ–¹å¼è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœè·å–ä¸åˆ°åˆ™é˜»å¡èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œè€Œè¢«é˜»å¡çº¿ç¨‹çš„å”¤é†’ä¸»è¦ä¾é å‰é©±èŠ‚ç‚¹çš„å‡ºé˜Ÿæˆ–é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­æ¥å®ç°ã€‚</p>
<p>ä¸‹é¢åˆ†æä¸€ä¸‹ç›¸å…³å·¥ä½œã€‚é¦–å…ˆæ˜¯èŠ‚ç‚¹çš„æ„é€ ä»¥åŠåŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>åŒæ­¥å™¨çš„addWaiterå’Œenqæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">private Node addWaiter(Node mode) {
    Node node = new Node(Thread.currentThread(), mode);
    // Try the fast path of enq; backup to full enq on failure
    Node pred = tail;
    if (pred != null) {
        node.prev = pred;
        //é€šè¿‡ä½¿ç”¨compareAndSetTail(Node expect,Node update)æ–¹æ³•æ¥ç¡®ä¿èŠ‚ç‚¹èƒ½å¤Ÿè¢«çº¿ç¨‹å®‰å…¨æ·»åŠ 
        if (compareAndSetTail(pred, node)) {
            pred.next = node;
            return node;
        }
    }
    enq(node);
    return node;
}

    private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        if (t == null) { // Must initialize
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}
</code></pre>
<p>åœ¨enq(final Node node)æ–¹æ³•ä¸­ï¼ŒåŒæ­¥å™¨é€šè¿‡â€œæ­»å¾ªç¯â€æ¥ä¿è¯èŠ‚ç‚¹çš„æ­£ç¡®æ·»åŠ ï¼Œåœ¨â€œæ­»å¾ªç¯â€ä¸­åªæœ‰é€šè¿‡CASå°†èŠ‚ç‚¹è®¾ç½®æˆä¸ºå°¾èŠ‚ç‚¹ä¹‹åï¼Œå½“å‰çº¿ç¨‹æ‰èƒ½ä»è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ï¼Œå½“å‰çº¿ç¨‹ä¸æ–­åœ°å°è¯•è®¾ç½®ã€‚å¯ä»¥çœ‹å‡ºï¼Œenq(final Node node)æ–¹æ³•å°†å¹¶å‘æ·»åŠ èŠ‚ç‚¹çš„è¯·æ±‚é€šè¿‡CASå˜å¾—â€œä¸²è¡ŒåŒ–â€äº†ã€‚</p>
<blockquote>
<p>åŒæ­¥å™¨çš„acquireQueuedæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">@ReservedStackAccess
final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return interrupted;
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
} 
</code></pre>
<p>åœ¨acquireQueued(final Node node,int arg)æ–¹æ³•ä¸­ï¼Œå½“å‰çº¿ç¨‹åœ¨â€œæ­»å¾ªç¯â€ä¸­å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè€Œåªæœ‰å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹æ‰èƒ½å¤Ÿå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼ŸåŸå› æœ‰ä¸¤ä¸ªï¼Œå¦‚ä¸‹ã€‚</p>
<p>ç¬¬ä¸€ï¼Œå¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œè€Œå¤´èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†ä¼š<br>
å”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼Œåç»§èŠ‚ç‚¹çš„çº¿ç¨‹è¢«å”¤é†’åéœ€è¦æ£€æŸ¥è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦æ˜¯å¤´èŠ‚ç‚¹ã€‚</p>
<p>ç¬¬äºŒï¼Œç»´æŠ¤åŒæ­¥é˜Ÿåˆ—çš„FIFOåŸåˆ™ã€‚è¯¥æ–¹æ³•ä¸­ï¼ŒèŠ‚ç‚¹è‡ªæ—‹è·å–åŒæ­¥çŠ¶æ€çš„è¡Œä¸ºå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<figure data-type="image" tabindex="5"><img src="https://q456qq520.github.io/post-images/1660187742025.png" alt="èŠ‚ç‚¹è‡ªæ—‹è·å–åŒæ­¥çŠ¶æ€" loading="lazy"></figure>
<p>ç”±äºéé¦–èŠ‚ç‚¹çº¿ç¨‹å‰é©±èŠ‚ç‚¹å‡ºé˜Ÿæˆ–è€…è¢«ä¸­æ–­è€Œä»ç­‰å¾…çŠ¶æ€è¿”å›ï¼Œéšåæ£€æŸ¥è‡ªå·±çš„å‰é©±æ˜¯å¦æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚å¯ä»¥çœ‹åˆ°èŠ‚ç‚¹å’ŒèŠ‚ç‚¹ä¹‹é—´åœ¨å¾ªç¯æ£€æŸ¥çš„è¿‡ç¨‹ä¸­åŸºæœ¬ä¸ç›¸äº’é€šä¿¡ï¼Œè€Œæ˜¯ç®€å•åœ°åˆ¤æ–­è‡ªå·±çš„å‰é©±æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹ï¼Œè¿™æ ·å°±ä½¿å¾—èŠ‚ç‚¹çš„é‡Šæ”¾è§„åˆ™ç¬¦åˆFIFOï¼Œå¹¶ä¸”ä¹Ÿä¾¿äºå¯¹è¿‡æ—©é€šçŸ¥çš„å¤„ç†ï¼ˆè¿‡æ—©é€šçŸ¥æ˜¯æŒ‡å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹çš„çº¿ç¨‹ç”±äºä¸­æ–­è€Œè¢«å”¤é†’ï¼‰ã€‚</p>
<p>ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–æµç¨‹ï¼Œä¹Ÿå°±æ˜¯acquire(int arg)æ–¹æ³•è°ƒç”¨æµç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://q456qq520.github.io/post-images/1660187831672.png" alt="ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–æµç¨‹" loading="lazy"></figure>
<p>å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ä¸”èƒ½å¤Ÿè·å–åŒæ­¥çŠ¶æ€çš„åˆ¤æ–­æ¡ä»¶å’Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€æ˜¯è·å–åŒæ­¥çŠ¶æ€çš„è‡ªæ—‹è¿‡ç¨‹ã€‚å½“åŒæ­¥çŠ¶æ€è·å–æˆåŠŸä¹‹åï¼Œå½“å‰çº¿ç¨‹ä»acquire(int arg)æ–¹æ³•è¿”å›ï¼Œå¦‚æœå¯¹äºé”è¿™ç§å¹¶å‘ç»„ä»¶è€Œè¨€ï¼Œä»£è¡¨ç€å½“å‰çº¿ç¨‹è·å–äº†é”ã€‚</p>
<p>å½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¹¶æ‰§è¡Œäº†ç›¸åº”é€»è¾‘ä¹‹åï¼Œå°±éœ€è¦é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œä½¿å¾—åç»­èŠ‚ç‚¹èƒ½å¤Ÿç»§ç»­è·å–åŒæ­¥çŠ¶æ€ã€‚é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„**release(int arg)**æ–¹æ³•å¯ä»¥é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•åœ¨é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹åï¼Œä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼ˆè¿›è€Œä½¿åç»§èŠ‚ç‚¹é‡æ–°å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼‰ã€‚è¯¥æ–¹æ³•ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre><code class="language-java">@ReservedStackAccess
public final boolean release(int arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null &amp;&amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}
</code></pre>
<p>è¯¥æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼šå”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çº¿ç¨‹ï¼ŒunparkSuccessor(Node node)æ–¹æ³•ä½¿ç”¨LockSupportæ¥å”¤é†’å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚</p>
<p>åˆ†æäº†ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾è¿‡ç¨‹åï¼Œé€‚å½“åšä¸ªæ€»ç»“ï¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å™¨ç»´æŠ¤ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œè·å–çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹éƒ½ä¼šè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­å¹¶åœ¨é˜Ÿåˆ—ä¸­è¿›è¡Œè‡ªæ—‹ï¼›ç§»å‡ºé˜Ÿåˆ—ï¼ˆæˆ–åœæ­¢è‡ªæ—‹ï¼‰çš„æ¡ä»¶æ˜¯å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ä¸”æˆåŠŸè·å–äº†åŒæ­¥çŠ¶æ€ã€‚åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å™¨è°ƒç”¨tryRelease(int arg)æ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç„¶åå”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚</p>
<h5 id="3å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾">3.å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾</h5>
<p>å…±äº«å¼è·å–ä¸ç‹¬å å¼è·å–æœ€ä¸»è¦çš„åŒºåˆ«åœ¨äº<strong>åŒä¸€æ—¶åˆ»èƒ½å¦æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚</strong></p>
<p>ä»¥æ–‡ä»¶çš„è¯»å†™ä¸ºä¾‹ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºåœ¨å¯¹æ–‡ä»¶è¿›è¡Œè¯»æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸€æ—¶åˆ»å¯¹äºè¯¥æ–‡ä»¶çš„å†™æ“ä½œå‡è¢«é˜»å¡ï¼Œè€Œè¯»æ“ä½œèƒ½å¤ŸåŒæ—¶è¿›è¡Œã€‚å†™æ“ä½œè¦æ±‚å¯¹èµ„æºçš„ç‹¬å å¼è®¿é—®ï¼Œè€Œè¯»æ“ä½œå¯ä»¥æ˜¯å…±äº«å¼è®¿é—®ï¼Œä¸¤ç§ä¸åŒçš„è®¿é—®æ¨¡å¼åœ¨åŒä¸€æ—¶åˆ»å¯¹æ–‡ä»¶æˆ–èµ„æºçš„è®¿é—®æƒ…å†µã€‚</p>
<p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„acquireShared(int arg)æ–¹æ³•å¯ä»¥å…±äº«å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p>åŒæ­¥å™¨çš„acquireSharedå’ŒdoAcquireSharedæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">public final void acquireShared(int arg) {
    //è¿”å›å€¼å¤§äºç­‰äº0æ—¶ï¼Œè¡¨ç¤ºèƒ½å¤Ÿè·å–åˆ°åŒæ­¥çŠ¶æ€
    if (tryAcquireShared(arg) &lt; 0)
        doAcquireShared(arg);
}

private void doAcquireShared(int arg) {
    final Node node = addWaiter(Node.SHARED);
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head) {
                int r = tryAcquireShared(arg);
                //å¦‚æœè¿”å›å€¼å¤§äºç­‰äº0ï¼Œè¡¨ç¤ºè¯¥æ¬¡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸå¹¶ä»è‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡º
                if (r &gt;= 0) {
                    setHeadAndPropagate(node, r);
                    p.next = null; // help GC
                    if (interrupted)
                        selfInterrupt();
                    failed = false;
                    return;
                }
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
</code></pre>
<p>åœ¨acquireShared(int arg)æ–¹æ³•ä¸­ï¼ŒåŒæ­¥å™¨è°ƒç”¨tryAcquireShared(int arg)æ–¹æ³•å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼ŒtryAcquireShared(int arg)æ–¹æ³•è¿”å›å€¼ä¸ºintç±»å‹ï¼Œå½“è¿”å›å€¼å¤§äºç­‰äº0æ—¶ï¼Œè¡¨ç¤ºèƒ½å¤Ÿè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚å› æ­¤ï¼Œåœ¨å…±äº«å¼è·å–çš„è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼ŒæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€å¹¶é€€å‡ºè‡ªæ—‹çš„æ¡ä»¶å°±æ˜¯tryAcquireShared(int arg)æ–¹æ³•è¿”å›å€¼å¤§äºç­‰äº0ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨doAcquireShared(int arg)æ–¹æ³•çš„è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå½“å‰èŠ‚çš„å‰é©±ä¸ºå¤´èŠ‚ç‚¹æ—¶ï¼Œå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè¿”å›å€¼å¤§äºç­‰äº0ï¼Œè¡¨ç¤ºè¯¥æ¬¡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸå¹¶ä»è‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºã€‚</p>
<p>ä¸ç‹¬å å¼ä¸€æ ·ï¼Œå…±äº«å¼è·å–ä¹Ÿéœ€è¦é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡è°ƒç”¨releaseShared(int arg)æ–¹æ³•å¯ä»¥é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p>åŒæ­¥å™¨çš„releaseSharedæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">@ReservedStackAccess
public final boolean releaseShared(int arg) {
    if (tryReleaseShared(arg)) {
        doReleaseShared();
        return true;
    }
    return false;
}
</code></pre>
<p>è¯¥æ–¹æ³•åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†ä¼šå”¤é†’åç»­å¤„äºç­‰å¾…çŠ¶æ€çš„èŠ‚ç‚¹ã€‚å¯¹äºèƒ½å¤Ÿæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®çš„å¹¶å‘ç»„ä»¶ï¼ˆæ¯”å¦‚Semaphoreï¼‰ï¼Œå®ƒå’Œç‹¬å å¼ä¸»è¦åŒºåˆ«åœ¨äºtryReleaseShared(int arg)æ–¹æ³•å¿…é¡»ç¡®ä¿åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…èµ„æºæ•°ï¼‰çº¿ç¨‹å®‰å…¨é‡Šæ”¾ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡å¾ªç¯å’ŒCASæ¥ä¿è¯çš„ï¼Œå› ä¸ºé‡Šæ”¾åŒæ­¥çŠ¶æ€çš„æ“ä½œä¼šåŒæ—¶æ¥è‡ªå¤šä¸ªçº¿ç¨‹ã€‚</p>
<blockquote>
<p>åŒæ­¥å™¨çš„tryReleaseSharedæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">protected boolean tryReleaseShared(int releases) {
    // Decrement count; signal when transition to zero
    for (;;) {
        int c = getState();
        if (c == 0)
            return false;
        int nextc = c-1;
        if (compareAndSetState(c, nextc))
            return nextc == 0;
    }
}
</code></pre>
<h5 id="4ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€">4.ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€</h5>
<p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„doAcquireNanos(int arg,long nanosTimeout)æ–¹æ³•å¯ä»¥è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€ï¼Œ**å³åœ¨æŒ‡å®šçš„æ—¶é—´æ®µå†…è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–åˆ°åŒæ­¥çŠ¶æ€åˆ™è¿”å›trueï¼Œå¦åˆ™ï¼Œè¿”å›falseã€‚**è¯¥æ–¹æ³•æä¾›äº†ä¼ ç»ŸJavaåŒæ­¥æ“ä½œï¼ˆæ¯”å¦‚synchronizedå…³é”®å­—ï¼‰æ‰€ä¸å…·å¤‡çš„ç‰¹æ€§ã€‚</p>
<p>doAcquireNanos(int arg,long nanosTimeout)æ–¹æ³•åœ¨æ”¯æŒå“åº”ä¸­æ–­çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†è¶…æ—¶è·å–çš„ç‰¹æ€§ã€‚é’ˆå¯¹è¶…æ—¶è·å–ï¼Œä¸»è¦éœ€è¦è®¡ç®—å‡ºéœ€è¦ç¡çœ çš„æ—¶é—´é—´éš”nanosTimeoutï¼Œå¦‚æœnanosTimeoutå¤§äº0åˆ™è¡¨ç¤ºè¶…æ—¶æ—¶é—´æœªåˆ°ï¼Œéœ€è¦ç»§ç»­ç¡çœ nanosTimeoutçº³ç§’ï¼Œåä¹‹ï¼Œè¡¨ç¤ºå·²ç»è¶…æ—¶ï¼Œ</p>
<blockquote>
<p>åŒæ­¥å™¨çš„doAcquireNanosæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">private boolean doAcquireNanos(int arg, long nanosTimeout)
    throws InterruptedException {
if (nanosTimeout &lt;= 0L)
    return false;
final long deadline = System.nanoTime() + nanosTimeout;
final Node node = addWaiter(Node.EXCLUSIVE);
boolean failed = true;
try {
    for (;;) {
        final Node p = node.predecessor();
        if (p == head &amp;&amp; tryAcquire(arg)) {
            setHead(node);
            p.next = null; // help GC
            failed = false;
            return true;
        }
        nanosTimeout = deadline - System.nanoTime();
        if (nanosTimeout &lt;= 0L)
            return false;
        if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
            nanosTimeout &gt; spinForTimeoutThreshold)
            LockSupport.parkNanos(this, nanosTimeout);
        if (Thread.interrupted())
            throw new InterruptedException();
    }
} finally {
    if (failed)
        cancelAcquire(node);
}
}
</code></pre>
<p>è¯¥æ–¹æ³•åœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œå½“èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹æ—¶å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–æˆåŠŸåˆ™ä»è¯¥æ–¹æ³•è¿”å›ï¼Œè¿™ä¸ªè¿‡ç¨‹å’Œç‹¬å å¼åŒæ­¥è·å–çš„è¿‡ç¨‹ç±»ä¼¼ï¼Œä½†æ˜¯åœ¨åŒæ­¥çŠ¶æ€è·å–å¤±è´¥çš„å¤„ç†ä¸Šæœ‰æ‰€ä¸åŒã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼ˆnanosTimeoutå°äºç­‰äº0è¡¨ç¤ºå·²ç»è¶…æ—¶ï¼‰ï¼Œå¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œé‡æ–°è®¡ç®—è¶…æ—¶é—´éš”nanosTimeoutï¼Œç„¶åä½¿å½“å‰çº¿ç¨‹ç­‰å¾…nanosTimeoutçº³ç§’ï¼ˆå½“å·²åˆ°è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œè¯¥çº¿ç¨‹ä¼šä»LockSupport.parkNanos(Objectblocker,long nanos)æ–¹æ³•è¿”å›ï¼‰ã€‚</p>
<p>å¦‚æœnanosTimeoutå°äºç­‰äºspinForTimeoutThresholdï¼ˆ1000çº³ç§’ï¼‰æ—¶ï¼Œå°†ä¸ä¼šä½¿è¯¥çº¿ç¨‹è¿›è¡Œè¶…æ—¶ç­‰å¾…ï¼Œè€Œæ˜¯è¿›å…¥å¿«é€Ÿçš„è‡ªæ—‹è¿‡ç¨‹ã€‚åŸå› åœ¨äºï¼Œéå¸¸çŸ­çš„è¶…æ—¶ç­‰å¾…æ— æ³•åšåˆ°ååˆ†ç²¾ç¡®ï¼Œå¦‚æœè¿™æ—¶å†è¿›è¡Œè¶…æ—¶ç­‰å¾…ï¼Œç›¸åä¼šè®©nanosTimeoutçš„è¶…æ—¶ä»æ•´ä½“ä¸Šè¡¨ç°å¾—åè€Œä¸ç²¾ç¡®ã€‚å› æ­¤ï¼Œåœ¨è¶…æ—¶éå¸¸çŸ­çš„åœºæ™¯ä¸‹ï¼ŒåŒæ­¥å™¨ä¼šè¿›å…¥æ— æ¡ä»¶çš„å¿«é€Ÿè‡ªæ—‹ã€‚</p>
<p>ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€doAcquireNanos(int arg,long nanosTimeout)å’Œç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€acquire(int args)åœ¨æµç¨‹ä¸Šéå¸¸ç›¸ä¼¼ï¼Œå…¶ä¸»è¦åŒºåˆ«åœ¨äºæœªè·å–åˆ°åŒæ­¥çŠ¶æ€æ—¶çš„å¤„ç†é€»è¾‘ã€‚acquire(int args)åœ¨æœªè·å–åˆ°åŒæ­¥çŠ¶æ€æ—¶ï¼Œå°†ä¼šä½¿å½“å‰çº¿ç¨‹ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€ŒdoAcquireNanos(int arg,long nanosTimeout)ä¼šä½¿å½“å‰çº¿ç¨‹ç­‰å¾…nanosTimeoutçº³ç§’ï¼Œå¦‚æœå½“å‰çº¿ç¨‹åœ¨nanosTimeoutçº³ç§’å†…æ²¡æœ‰è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œå°†ä¼šä»ç­‰å¾…é€»è¾‘ä¸­è‡ªåŠ¨è¿”å›ã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://q456qq520.github.io/post-images/1660200122402.png" alt="ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€çš„æµç¨‹" loading="lazy"></figure>
<h5 id="5è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶twinslock">5.è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶â€”â€”TwinsLock</h5>
<p>è®¾è®¡ä¸€ä¸ªåŒæ­¥å·¥å…·ï¼šè¯¥å·¥å…·åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªå…è®¸è‡³å¤šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œè¶…è¿‡ä¸¤ä¸ªçº¿ç¨‹çš„è®¿é—®å°†è¢«é˜»å¡ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªåŒæ­¥å·¥å…·å‘½åä¸ºTwinsLockã€‚</p>
<p>é¦–å…ˆï¼Œç¡®å®šè®¿é—®æ¨¡å¼ã€‚TwinsLockèƒ½å¤Ÿåœ¨åŒä¸€æ—¶åˆ»æ”¯æŒå¤šä¸ªçº¿ç¨‹çš„è®¿é—®ï¼Œè¿™æ˜¾ç„¶æ˜¯å…±äº«å¼è®¿é—®ï¼Œå› æ­¤ï¼Œéœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„acquireShared(int args)æ–¹æ³•ç­‰å’ŒSharedç›¸å…³çš„æ–¹æ³•ï¼Œè¿™å°±è¦æ±‚TwinsLockå¿…é¡»é‡å†™tryAcquireShared(int args)æ–¹æ³•å’ŒtryReleaseShared(int args)æ–¹æ³•ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åŒæ­¥å™¨çš„å…±äº«å¼åŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾æ–¹æ³•å¾—ä»¥æ‰§è¡Œã€‚</p>
<p>å…¶æ¬¡ï¼Œå®šä¹‰èµ„æºæ•°ã€‚TwinsLockåœ¨åŒä¸€æ—¶åˆ»å…è®¸è‡³å¤šä¸¤ä¸ªçº¿ç¨‹çš„åŒæ—¶è®¿é—®ï¼Œè¡¨æ˜åŒæ­¥èµ„æºæ•°ä¸º2ï¼Œè¿™æ ·å¯ä»¥è®¾ç½®åˆå§‹çŠ¶æ€statusä¸º2ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè·å–ï¼Œstatuså‡1ï¼Œè¯¥çº¿ç¨‹é‡Šæ”¾ï¼Œåˆ™statusåŠ 1ï¼ŒçŠ¶æ€çš„åˆæ³•èŒƒå›´ä¸º0ã€1å’Œ2ï¼Œå…¶ä¸­0è¡¨ç¤ºå½“å‰å·²ç»æœ‰ä¸¤ä¸ªçº¿ç¨‹è·å–äº†åŒæ­¥èµ„æºï¼Œæ­¤æ—¶å†æœ‰å…¶ä»–çº¿ç¨‹å¯¹åŒæ­¥çŠ¶æ€è¿›è¡Œè·å–ï¼Œè¯¥çº¿ç¨‹åªèƒ½è¢«é˜»å¡ã€‚åœ¨åŒæ­¥çŠ¶æ€å˜æ›´æ—¶ï¼Œéœ€è¦ä½¿ç”¨compareAndSet(int expect,int update)æ–¹æ³•åšåŸå­æ€§ä¿éšœã€‚</p>
<p>æœ€åï¼Œç»„åˆè‡ªå®šä¹‰åŒæ­¥å™¨ã€‚å‰é¢çš„ç« èŠ‚æåˆ°ï¼Œè‡ªå®šä¹‰åŒæ­¥ç»„ä»¶é€šè¿‡ç»„åˆè‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ŒæˆåŒæ­¥åŠŸèƒ½ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è‡ªå®šä¹‰åŒæ­¥å™¨ä¼šè¢«å®šä¹‰ä¸ºè‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å†…éƒ¨ç±»ã€‚</p>
<pre><code class="language-java">package cm.lock;

import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.AbstractQueuedSynchronizer;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;

/**
 * è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶â€”â€”TwinsLock
 * @author likecat
 * @version 1.0
 * @date 2022/8/11 15:00
 */
public class TwinsLock implements Lock {
    private final Sync sync = new Sync(2);
    private static final class Sync extends AbstractQueuedSynchronizer {
        Sync(int count) {
            if (count &lt;= 0) {
                throw new IllegalArgumentException(&quot;count must large than zero.&quot;);
            }
            setState(count);
        }
        public int tryAcquireShared(int reduceCount) {
            for (;;) {
                int current = getState();
                int newCount = current - reduceCount;
                if (newCount &gt;= 0 || compareAndSetState(current,
                        newCount)) {
                    return newCount;
                }
            }
        }
        public boolean tryReleaseShared(int returnCount) {
            for (;;) {
                int current = getState();
                int newCount = current + returnCount;
                if (compareAndSetState(current, newCount)) {
                    return true;
                }
            }
        }
    }
    public void lock() {
        sync.acquireShared(1);
    }

    @Override
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireInterruptibly(1);
    }

    @Override
    public boolean tryLock() {
        return sync.tryAcquireShared(1) &gt;= 0;
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquireSharedNanos(1,time);
    }

    public void unlock() {
        sync.releaseShared(1);
    }

    @Override
    public Condition newCondition() {
        return null;
    }
}
</code></pre>
<p>TwinsLockå®ç°äº†Lockæ¥å£ï¼Œæä¾›äº†é¢å‘ä½¿ç”¨è€…çš„æ¥å£ï¼Œä½¿ç”¨è€…è°ƒç”¨lock()æ–¹æ³•è·å–é”ï¼Œéšåè°ƒç”¨unlock()æ–¹æ³•é‡Šæ”¾é”ï¼Œè€ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°é”ã€‚TwinsLockåŒæ—¶åŒ…å«äº†ä¸€ä¸ªè‡ªå®šä¹‰åŒæ­¥å™¨Syncï¼Œè€Œè¯¥åŒæ­¥å™¨é¢å‘çº¿ç¨‹è®¿é—®å’ŒåŒæ­¥çŠ¶æ€æ§åˆ¶ã€‚ä»¥å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ä¸ºä¾‹ï¼šåŒæ­¥å™¨ä¼šå…ˆè®¡ç®—å‡ºè·å–åçš„åŒæ­¥çŠ¶æ€ï¼Œç„¶åé€šè¿‡CASç¡®ä¿çŠ¶æ€çš„æ­£ç¡®è®¾ç½®ï¼Œå½“tryAcquireShared(int reduceCount)æ–¹æ³•è¿”å›å€¼å¤§äºç­‰äº0æ—¶ï¼Œå½“å‰çº¿ç¨‹æ‰è·å–åŒæ­¥çŠ¶æ€ï¼Œå¯¹äºä¸Šå±‚çš„TwinsLockè€Œè¨€ï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å¾—äº†é”ã€‚</p>
<p>åŒæ­¥å™¨ä½œä¸ºä¸€ä¸ªæ¡¥æ¢ï¼Œè¿æ¥çº¿ç¨‹è®¿é—®ä»¥åŠåŒæ­¥çŠ¶æ€æ§åˆ¶ç­‰åº•å±‚æŠ€æœ¯ä¸ä¸åŒå¹¶å‘ç»„ä»¶ï¼ˆæ¯”å¦‚Lockã€CountDownLatchç­‰ï¼‰çš„æ¥å£è¯­ä¹‰ã€‚</p>
<p>ä¸‹é¢ç¼–å†™ä¸€ä¸ªæµ‹è¯•æ¥éªŒè¯TwinsLockæ˜¯å¦èƒ½æŒ‰ç…§é¢„æœŸå·¥ä½œã€‚åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œå®šä¹‰äº†å·¥ä½œè€…çº¿ç¨‹Workerï¼Œè¯¥çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è·å–é”ï¼Œå½“è·å–é”ä¹‹åä½¿å½“å‰çº¿ç¨‹ç¡çœ 1ç§’ï¼ˆå¹¶ä¸é‡Šæ”¾é”ï¼‰ï¼Œéšåæ‰“å°å½“å‰çº¿ç¨‹åç§°ï¼Œæœ€åå†æ¬¡ç¡çœ 1ç§’å¹¶é‡Šæ”¾é”ï¼Œæµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre><code class="language-java">package cm.lock;

import cm.SleepUtils;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/11 15:11
 */
public class TwinsLockTest {

    public static void main(String[] args) throws InterruptedException {
        TwinsLock lock = new TwinsLock();
         class Worker extends Thread {
            public void run() {
                while (true) {
                    lock.lock();
                    try {
                        SleepUtils.second(1);
                        System.out.println(Thread.currentThread().getName());
                        SleepUtils.second(1);
                    } finally {
                        lock.unlock();
                    }
                }
            }
        }
        // å¯åŠ¨10ä¸ªçº¿ç¨‹
        for (int i = 0; i &lt; 10; i++) {
            Worker w = new Worker();
            w.setDaemon(true);
            w.start();
        }
//         æ¯éš”1ç§’æ¢è¡Œ
        for (int i = 0; i &lt; 10; i++) {
            SleepUtils.second(1);
            System.out.println();
        }
    }

}
</code></pre>
<p>è¿è¡Œè¯¥æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥çœ‹åˆ°çº¿ç¨‹åç§°æˆå¯¹è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸¤ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°é”ï¼Œè¿™è¡¨æ˜TwinsLockå¯ä»¥æŒ‰ç…§é¢„æœŸæ­£ç¡®å·¥ä½œã€‚</p>
<h2 id="43-é‡å…¥é”">4.3 é‡å…¥é”</h2>
<p>é‡å…¥é”ReentrantLockï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ”¯æŒé‡è¿›å…¥çš„é”ï¼Œ<strong>å®ƒè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥é”çš„è¿˜æ”¯æŒè·å–é”æ—¶çš„å…¬å¹³å’Œéå…¬å¹³æ€§é€‰æ‹©</strong>ã€‚</p>
<p>synchronizedå…³é”®å­—éšå¼çš„æ”¯æŒé‡è¿›å…¥ï¼Œæ¯”å¦‚ä¸€ä¸ªsynchronizedä¿®é¥°çš„é€’å½’æ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œæ‰§è¡Œçº¿ç¨‹åœ¨è·å–äº†é”ä¹‹åä»èƒ½è¿ç»­å¤šæ¬¡åœ°è·å¾—è¯¥é”ã€‚</p>
<p>ReentrantLockè™½ç„¶æ²¡èƒ½åƒsynchronizedå…³é”®å­—ä¸€æ ·æ”¯æŒéšå¼çš„é‡è¿›å…¥ï¼Œä½†æ˜¯åœ¨è°ƒç”¨lock()æ–¹æ³•æ—¶ï¼Œå·²ç»è·å–åˆ°é”çš„çº¿ç¨‹ï¼Œèƒ½å¤Ÿå†æ¬¡è°ƒç”¨lock()æ–¹æ³•è·å–é”è€Œä¸è¢«é˜»å¡ã€‚</p>
<p>è¿™é‡Œæåˆ°ä¸€ä¸ªé”è·å–çš„å…¬å¹³æ€§é—®é¢˜ï¼Œ<strong>å¦‚æœåœ¨ç»å¯¹æ—¶é—´ä¸Šï¼Œå…ˆå¯¹é”è¿›è¡Œè·å–çš„è¯·æ±‚ä¸€å®šå…ˆè¢«æ»¡è¶³ï¼Œé‚£ä¹ˆè¿™ä¸ªé”æ˜¯å…¬å¹³çš„ï¼Œåä¹‹ï¼Œæ˜¯ä¸å…¬å¹³çš„</strong>ã€‚å…¬å¹³çš„è·å–é”ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹æœ€ä¼˜å…ˆè·å–é”ï¼Œä¹Ÿå¯ä»¥è¯´é”è·å–æ˜¯é¡ºåºçš„ã€‚ReentrantLockæä¾›äº†ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œèƒ½å¤Ÿæ§åˆ¶é”æ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚</p>
<p>äº‹å®ä¸Šï¼Œå…¬å¹³çš„é”æœºåˆ¶å¾€å¾€æ²¡æœ‰éå…¬å¹³çš„æ•ˆç‡é«˜ï¼Œä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯ä»»ä½•åœºæ™¯éƒ½æ˜¯ä»¥TPSä½œä¸ºå”¯ä¸€çš„æŒ‡æ ‡ï¼Œå…¬å¹³é”èƒ½å¤Ÿå‡å°‘â€œé¥¥é¥¿â€å‘ç”Ÿçš„æ¦‚ç‡ï¼Œç­‰å¾…è¶Šä¹…çš„è¯·æ±‚è¶Šæ˜¯èƒ½å¤Ÿå¾—åˆ°ä¼˜å…ˆæ»¡è¶³ã€‚</p>
<h5 id="1å®ç°é‡è¿›å…¥">1.å®ç°é‡è¿›å…¥</h5>
<p>é‡è¿›å…¥æ˜¯æŒ‡ä»»æ„çº¿ç¨‹åœ¨è·å–åˆ°é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šè¢«é”æ‰€é˜»å¡ï¼Œè¯¥ç‰¹æ€§çš„å®ç°éœ€è¦è§£å†³ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ã€‚</p>
<blockquote>
<p>1ï¼‰çº¿ç¨‹å†æ¬¡è·å–é”ã€‚é”éœ€è¦å»è¯†åˆ«è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰å æ®é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡æˆåŠŸè·å–ã€‚</p>
</blockquote>
<blockquote>
<p>2ï¼‰é”çš„æœ€ç»ˆé‡Šæ”¾ã€‚çº¿ç¨‹é‡å¤næ¬¡è·å–äº†é”ï¼Œéšååœ¨ç¬¬næ¬¡é‡Šæ”¾è¯¥é”åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°è¯¥é”ã€‚é”çš„æœ€ç»ˆé‡Šæ”¾è¦æ±‚é”å¯¹äºè·å–è¿›è¡Œè®¡æ•°è‡ªå¢ï¼Œè®¡æ•°è¡¨ç¤ºå½“å‰é”è¢«é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œé”è¢«é‡Šæ”¾æ—¶ï¼Œè®¡æ•°è‡ªå‡ï¼Œå½“è®¡æ•°ç­‰äº0æ—¶è¡¨ç¤ºé”å·²ç»æˆåŠŸé‡Šæ”¾ã€‚</p>
</blockquote>
<p>ReentrantLockæ˜¯é€šè¿‡ç»„åˆè‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ç°é”çš„è·å–ä¸é‡Šæ”¾ï¼Œä»¥éå…¬å¹³æ€§ï¼ˆé»˜è®¤çš„ï¼‰å®ç°ä¸ºä¾‹ï¼Œè·å–åŒæ­¥çŠ¶æ€çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p>ReentrantLockçš„nonfairTryAcquireæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">final boolean nonfairTryAcquire(int acquires) {
        final Thread current = Thread.currentThread();
        int c = getState();
        if (c == 0) {
            if (compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(current);
                return true;
            }
        }
        else if (current == getExclusiveOwnerThread()) {
            int nextc = c + acquires;
            if (nextc &lt; 0) // overflow
                throw new Error(&quot;Maximum lock count exceeded&quot;);
            setState(nextc);
            return true;
        }
        return false;
    }
</code></pre>
<p>è¯¥æ–¹æ³•å¢åŠ äº†å†æ¬¡è·å–åŒæ­¥çŠ¶æ€çš„å¤„ç†é€»è¾‘ï¼šé€šè¿‡åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè·å–é”çš„çº¿ç¨‹æ¥å†³å®šè·å–æ“ä½œæ˜¯å¦æˆåŠŸï¼Œå¦‚æœæ˜¯è·å–é”çš„çº¿ç¨‹å†æ¬¡è¯·æ±‚ï¼Œåˆ™å°†åŒæ­¥çŠ¶æ€å€¼è¿›è¡Œå¢åŠ å¹¶è¿”å›trueï¼Œè¡¨ç¤ºè·å–åŒæ­¥çŠ¶æ€æˆåŠŸã€‚</p>
<p>æˆåŠŸè·å–é”çš„çº¿ç¨‹å†æ¬¡è·å–é”ï¼Œåªæ˜¯å¢åŠ äº†åŒæ­¥çŠ¶æ€å€¼ï¼Œè¿™ä¹Ÿå°±è¦æ±‚ReentrantLockåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶å‡å°‘åŒæ­¥çŠ¶æ€å€¼ï¼Œè¯¥æ–¹æ³•çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p>ReentrantLockçš„tryReleaseæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">protected final boolean tryRelease(int releases) {
        int c = getState() - releases;
        if (Thread.currentThread() != getExclusiveOwnerThread())
            throw new IllegalMonitorStateException();
        boolean free = false;
        if (c == 0) {
            free = true;
            setExclusiveOwnerThread(null);
        }
        setState(c);
        return free;
    }
</code></pre>
<p>å¦‚æœè¯¥é”è¢«è·å–äº†næ¬¡ï¼Œé‚£ä¹ˆå‰(n-1)æ¬¡tryRelease(int releases)æ–¹æ³•å¿…é¡»è¿”å›falseï¼Œè€Œåªæœ‰åŒæ­¥çŠ¶æ€å®Œå…¨é‡Šæ”¾äº†ï¼Œæ‰èƒ½è¿”å›trueã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•å°†åŒæ­¥çŠ¶æ€æ˜¯å¦ä¸º0ä½œä¸ºæœ€ç»ˆé‡Šæ”¾çš„æ¡ä»¶ï¼Œå½“åŒæ­¥çŠ¶æ€ä¸º0æ—¶ï¼Œå°†å æœ‰çº¿ç¨‹è®¾ç½®ä¸ºnullï¼Œå¹¶è¿”å›trueï¼Œè¡¨ç¤ºé‡Šæ”¾æˆåŠŸã€‚</p>
<h5 id="2å…¬å¹³ä¸éå…¬å¹³è·å–é”çš„åŒºåˆ«">2.å…¬å¹³ä¸éå…¬å¹³è·å–é”çš„åŒºåˆ«</h5>
<p>å…¬å¹³æ€§ä¸å¦æ˜¯é’ˆå¯¹è·å–é”è€Œè¨€çš„ï¼Œå¦‚æœä¸€ä¸ªé”æ˜¯å…¬å¹³çš„ï¼Œé‚£ä¹ˆé”çš„è·å–é¡ºåºå°±åº”è¯¥ç¬¦åˆè¯·æ±‚çš„ç»å¯¹æ—¶é—´é¡ºåºï¼Œä¹Ÿå°±æ˜¯FIFOã€‚</p>
<p>å¯¹äºéå…¬å¹³é”ï¼Œåªè¦CASè®¾ç½®åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–äº†é”ï¼Œè€Œå…¬å¹³é”åˆ™ä¸åŒï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p>ReentrantLockçš„tryAcquireæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">protected final boolean tryAcquire(int acquires) {
        final Thread current = Thread.currentThread();
        int c = getState();
        if (c == 0) {
            if (!hasQueuedPredecessors() &amp;&amp;
                compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(current);
                return true;
            }
        }
        else if (current == getExclusiveOwnerThread()) {
            int nextc = c + acquires;
            if (nextc &lt; 0)
                throw new Error(&quot;Maximum lock count exceeded&quot;);
            setState(nextc);
            return true;
        }
        return false;
    }
    ```

è¯¥æ–¹æ³•ä¸nonfairTryAcquire(int acquires)æ¯”è¾ƒï¼Œå”¯ä¸€ä¸åŒçš„ä½ç½®ä¸ºåˆ¤æ–­æ¡ä»¶å¤šäº†hasQueuedPredecessors()æ–¹æ³•ï¼Œå³åŠ å…¥äº†åŒæ­¥é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå¦‚æœè¯¥æ–¹æ³•è¿”å›trueï¼Œåˆ™è¡¨ç¤ºæœ‰çº¿ç¨‹æ¯”å½“å‰çº¿ç¨‹æ›´æ—©åœ°è¯·æ±‚è·å–é”ï¼Œå› æ­¤éœ€è¦ç­‰å¾…å‰é©±çº¿ç¨‹è·å–å¹¶é‡Šæ”¾é”ä¹‹åæ‰èƒ½ç»§ç»­è·å–é”ã€‚

ä¸‹é¢ç¼–å†™ä¸€ä¸ªæµ‹è¯•æ¥è§‚å¯Ÿå…¬å¹³å’Œéå…¬å¹³é”åœ¨è·å–é”æ—¶çš„åŒºåˆ«ï¼Œåœ¨æµ‹è¯•ç”¨ä¾‹ä¸­å®šä¹‰äº†å†…éƒ¨ç±»ReentrantLock2ï¼Œè¯¥ç±»ä¸»è¦å…¬å¼€äº†getQueuedThreads()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›æ­£åœ¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹åˆ—è¡¨ï¼Œç”±äºåˆ—è¡¨æ˜¯é€†åºè¾“å‡ºï¼Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿç»“æœï¼Œå°†å…¶è¿›è¡Œåè½¬ï¼Œæµ‹è¯•ç”¨ä¾‹ï¼ˆéƒ¨åˆ†ï¼‰å¦‚ä¸‹æ‰€ç¤ºã€‚

```java
package cm.lock;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/11 17:19
 */
public class FairAndUnfairTest {
    private static Lock fairLock = new ReentrantLock2(true);
    private static Lock unfairLock = new ReentrantLock2(false);

public static void main(String[] args) {
    testLock(unfairLock);
    System.out.println(&quot;--------&quot;);
    testLock(fairLock);
}

    private static void testLock(Lock lock) {
        // å¯åŠ¨5ä¸ªJob
        for (int i = 0; i &lt; 5; i++) {
            Job job = new Job(lock);
            job.start();
        }
    }
    private static class Job extends Thread {
        private Lock lock;
        public Job(Lock lock) {
            this.lock = lock;
        }
        public void run() {
            // è¿ç»­2æ¬¡æ‰“å°å½“å‰çš„Threadå’Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„Thread
            for (int i = 0; i &lt; 2; i++) {
                lock.lock();
                try {
                        Thread.sleep(1000);
                        System.out.println(&quot;è·å–é”çš„å½“å‰çº¿ç¨‹[&quot; + Thread.currentThread().getName() + &quot;], åŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹&quot; + ((ReentrantLock2)lock).getQueuedThreads() + &quot;&quot;);
                } catch (InterruptedException e) {
                     e.printStackTrace();
                } finally {
                 lock.unlock();
                }
            }
        }
    }
    private static class ReentrantLock2 extends ReentrantLock {
        public ReentrantLock2(boolean fair) {
            super(fair);
        }

        public Collection&lt;Thread&gt; getQueuedThreads() {
            List&lt;Thread&gt; arrayList = new ArrayList&lt;Thread&gt;(super.
                    getQueuedThreads());
            Collections.reverse(arrayList);
            return arrayList;
        }
    }
}
</code></pre>
<p>å…¬å¹³æ€§é”æ¯æ¬¡éƒ½æ˜¯ä»åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è·å–åˆ°é”ï¼Œè€Œéå…¬å¹³æ€§é”å‡ºç°äº†ä¸€ä¸ªçº¿ç¨‹è¿ç»­è·å–é”çš„æƒ…å†µã€‚</p>
<p>ä¸ºä»€ä¹ˆä¼šå‡ºç°çº¿ç¨‹è¿ç»­è·å–é”çš„æƒ…å†µå‘¢ï¼Ÿå›é¡¾nonfairTryAcquire(int acquires)æ–¹æ³•ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚é”æ—¶ï¼Œåªè¦è·å–äº†åŒæ­¥çŠ¶æ€å³æˆåŠŸè·å–é”ã€‚åœ¨è¿™ä¸ªå‰æä¸‹ï¼Œåˆšé‡Šæ”¾é”çš„çº¿ç¨‹å†æ¬¡è·å–åŒæ­¥çŠ¶æ€çš„å‡ ç‡ä¼šéå¸¸å¤§ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹åªèƒ½åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚<strong>éå…¬å¹³æ€§é”å¯èƒ½ä½¿çº¿ç¨‹â€œé¥¥é¥¿â€ã€‚</strong></p>
<p><em><strong>å…¬å¹³æ€§é”ä¿è¯äº†é”çš„è·å–æŒ‰ç…§FIFOåŸåˆ™ï¼Œè€Œä»£ä»·æ˜¯è¿›è¡Œå¤§é‡çš„çº¿ç¨‹åˆ‡æ¢ã€‚éå…¬å¹³æ€§é”è™½ç„¶å¯èƒ½é€ æˆçº¿ç¨‹â€œé¥¥é¥¿â€ï¼Œä½†æå°‘çš„çº¿ç¨‹åˆ‡æ¢ï¼Œä¿è¯äº†å…¶æ›´å¤§çš„ååé‡ã€‚</strong></em></p>
<h2 id="54-è¯»å†™é”">5.4 è¯»å†™é”</h2>
<p>ä¹‹å‰æåˆ°é”ï¼ˆå¦‚Mutexå’ŒReentrantLockï¼‰åŸºæœ¬éƒ½æ˜¯æ’ä»–é”ï¼Œè¿™äº›é”åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè®¿é—®ï¼Œè€Œè¯»å†™é”åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥å…è®¸å¤šä¸ªè¯»çº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯åœ¨å†™çº¿ç¨‹è®¿é—®æ—¶ï¼Œæ‰€æœ‰çš„è¯»çº¿ç¨‹å’Œå…¶ä»–å†™çº¿ç¨‹å‡è¢«é˜»å¡ã€‚<strong>è¯»å†™é”ç»´æŠ¤äº†ä¸€å¯¹é”ï¼Œä¸€ä¸ªè¯»é”å’Œä¸€ä¸ªå†™é”ï¼Œé€šè¿‡åˆ†ç¦»è¯»é”å’Œå†™é”ï¼Œä½¿å¾—å¹¶å‘æ€§ç›¸æ¯”ä¸€èˆ¬çš„æ’ä»–é”æœ‰äº†å¾ˆå¤§æå‡ã€‚</strong></p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¯»å†™é”çš„æ€§èƒ½éƒ½ä¼šæ¯”æ’å®ƒé”å¥½ï¼Œå› ä¸ºå¤§å¤šæ•°åœºæ™¯è¯»æ˜¯å¤šäºå†™çš„ã€‚åœ¨è¯»å¤šäºå†™çš„æƒ…å†µä¸‹ï¼Œè¯»å†™é”èƒ½å¤Ÿæä¾›æ¯”æ’å®ƒé”æ›´å¥½çš„å¹¶å‘æ€§å’Œååé‡ã€‚Javaå¹¶å‘åŒ…æä¾›è¯»å†™é”çš„å®ç°æ˜¯ReentrantReadWriteLockï¼Œå®ƒæä¾›çš„ç‰¹æ€§å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure data-type="image" tabindex="8"><img src="https://q456qq520.github.io/post-images/1660287490202.png" alt="ReentrantReadWriteLockçš„ç‰¹æ€§" loading="lazy"></figure>
<h3 id="441-è¯»å†™é”çš„æ¥å£ä¸ç¤ºä¾‹">4.4.1 è¯»å†™é”çš„æ¥å£ä¸ç¤ºä¾‹</h3>
<p>ReadWriteLockä»…å®šä¹‰äº†è·å–è¯»é”å’Œå†™é”çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå³readLock()æ–¹æ³•å’ŒwriteLock()æ–¹æ³•ï¼Œè€Œå…¶å®ç°â€”â€”ReentrantReadWriteLockï¼Œé™¤äº†æ¥å£æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æä¾›äº†ä¸€äº›ä¾¿äºå¤–ç•Œç›‘æ§å…¶å†…éƒ¨å·¥ä½œçŠ¶æ€çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä»¥åŠæè¿°å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p>ReentrantReadWriteLockå±•ç¤ºå†…éƒ¨å·¥ä½œçŠ¶æ€çš„æ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">//è¿”å›å½“å‰åº¦é”è¢«è·å–çš„æ¬¡æ•°ï¼Œè¯¥æ¬¡æ•°ä¸èƒ½ä¸è·å–è¯»é”çš„çº¿ç¨‹æ•°
int getReadLockCount() 

//è¿”å›å½“å‰çº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°
int getReadHoldCount()

//åˆ¤æ–­å†™é”æ˜¯å¦è¢«è·å–
boolean isWriteLocked()

//è¿”å›å½“å‰å†™é”è¢«è·å–çš„æ¬¡æ•°
int getWriteHoldCount()
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ä¸€ä¸ªç¼“å­˜ç¤ºä¾‹è¯´æ˜è¯»å†™é”çš„ä½¿ç”¨æ–¹å¼ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-java">package cm.lock;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * è¯»å†™é”ç¼“å­˜ç¤ºä¾‹
 * @author likecat
 * @version 1.0
 * @date 2022/8/12 15:06
 */
public class Cache {
    static Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
    static ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
    static Lock r = rwl.readLock();
    static Lock w = rwl.writeLock();
    // è·å–ä¸€ä¸ªkeyå¯¹åº”çš„value
    public static final Object get(String key) {
        r.lock();
        try {
            return map.get(key);
        } finally {
            r.unlock();
        }
    }
    // è®¾ç½®keyå¯¹åº”çš„valueï¼Œå¹¶è¿”å›æ—§çš„value
    public static final Object put(String key, Object value) {
        w.lock();
        try {
            return map.put(key, value);
        } finally {
            w.unlock();
        }
    }
    
    // æ¸…ç©ºæ‰€æœ‰çš„å†…å®¹
    public static final void clear() {
        w.lock();
        try {
            map.clear();
        } finally {
            w.unlock();
        }
    }
}
</code></pre>
<p>ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼ŒCacheç»„åˆä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„HashMapä½œä¸ºç¼“å­˜çš„å®ç°ï¼ŒåŒæ—¶ä½¿ç”¨è¯»å†™é”çš„è¯»é”å’Œå†™é”æ¥ä¿è¯Cacheæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚åœ¨è¯»æ“ä½œget(String key)æ–¹æ³•ä¸­ï¼Œéœ€è¦è·å–è¯»é”ï¼Œè¿™ä½¿å¾—å¹¶å‘è®¿é—®è¯¥æ–¹æ³•æ—¶ä¸ä¼šè¢«é˜»å¡ã€‚å†™æ“ä½œput(String key,Object value)æ–¹æ³•å’Œclear()æ–¹æ³•ï¼Œåœ¨æ›´æ–°HashMapæ—¶å¿…é¡»æå‰è·å–å†™é”ï¼Œå½“è·å–å†™é”åï¼Œå…¶ä»–çº¿ç¨‹å¯¹äºè¯»é”å’Œå†™é”çš„è·å–å‡è¢«é˜»å¡ï¼Œè€Œåªæœ‰å†™é”è¢«é‡Šæ”¾ä¹‹åï¼Œå…¶ä»–è¯»å†™æ“ä½œæ‰èƒ½ç»§ç»­ã€‚Cacheä½¿ç”¨è¯»å†™é”æå‡è¯»æ“ä½œçš„å¹¶å‘æ€§ï¼Œä¹Ÿä¿è¯æ¯æ¬¡å†™æ“ä½œå¯¹æ‰€æœ‰çš„è¯»å†™æ“ä½œçš„å¯è§æ€§ã€‚</p>
<h3 id="442-è¯»å†™é”çš„å®ç°åˆ†æ">4.4.2 è¯»å†™é”çš„å®ç°åˆ†æ</h3>
<h5 id="1è¯»å†™çŠ¶æ€çš„è®¾è®¡">1.è¯»å†™çŠ¶æ€çš„è®¾è®¡</h5>
<p><em>è¯»å†™é”åŒæ ·ä¾èµ–è‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ç°åŒæ­¥åŠŸèƒ½ï¼Œè€Œè¯»å†™çŠ¶æ€å°±æ˜¯å…¶åŒæ­¥å™¨çš„åŒæ­¥çŠ¶æ€ã€‚</em></p>
<p>å›æƒ³ReentrantLockä¸­è‡ªå®šä¹‰åŒæ­¥å™¨çš„å®ç°ï¼ŒåŒæ­¥çŠ¶æ€è¡¨ç¤ºé”è¢«ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œè¯»å†™é”çš„è‡ªå®šä¹‰åŒæ­¥å™¨éœ€è¦åœ¨åŒæ­¥çŠ¶æ€ï¼ˆä¸€ä¸ªæ•´å‹å˜é‡ï¼‰ä¸Šç»´æŠ¤å¤šä¸ªè¯»çº¿ç¨‹å’Œä¸€ä¸ªå†™çº¿ç¨‹çš„çŠ¶æ€ã€‚</p>
<p>å¦‚æœåœ¨ä¸€ä¸ªæ•´å‹å˜é‡ä¸Šç»´æŠ¤å¤šç§çŠ¶æ€ï¼Œå°±ä¸€å®šéœ€è¦â€œæŒ‰ä½åˆ‡å‰²ä½¿ç”¨â€è¿™ä¸ªå˜é‡ï¼Œè¯»å†™é”å°†å˜é‡åˆ‡åˆ†æˆäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œ<strong>é«˜16ä½è¡¨ç¤ºè¯»ï¼Œä½16ä½è¡¨ç¤ºå†™</strong>ï¼Œåˆ’åˆ†æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure data-type="image" tabindex="9"><img src="https://q456qq520.github.io/post-images/1660288434069.png" alt="è¯»å†™é”çŠ¶æ€çš„åˆ’åˆ†æ–¹å¼" loading="lazy"></figure>
<p>å½“å‰åŒæ­¥çŠ¶æ€è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œä¸”é‡è¿›å…¥äº†ä¸¤æ¬¡ï¼ŒåŒæ—¶ä¹Ÿè¿ç»­è·å–äº†ä¸¤æ¬¡è¯»é”ã€‚è¯»å†™é”æ˜¯å¦‚ä½•è¿…é€Ÿç¡®å®šè¯»å’Œå†™å„è‡ªçš„çŠ¶æ€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ä½è¿ç®—ã€‚å‡è®¾å½“å‰åŒæ­¥çŠ¶æ€å€¼ä¸ºSï¼Œå†™çŠ¶æ€ç­‰äºS&amp;0x0000FFFFï¼ˆå°†é«˜16ä½å…¨éƒ¨æŠ¹å»ï¼‰ï¼Œè¯»çŠ¶æ€ç­‰äºS&gt;&gt;&gt;16ï¼ˆæ— ç¬¦å·è¡¥0å³ç§»16ä½ï¼‰ã€‚å½“å†™çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+1ï¼Œå½“è¯»çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+(1&lt;&lt;16)ï¼Œä¹Ÿå°±æ˜¯S+0x00010000ã€‚</p>
<p>æ ¹æ®çŠ¶æ€çš„åˆ’åˆ†èƒ½å¾—å‡ºä¸€ä¸ªæ¨è®ºï¼š<em><strong>Sä¸ç­‰äº0æ—¶ï¼Œå½“å†™çŠ¶æ€ï¼ˆS&amp;0x0000FFFFï¼‰ç­‰äº0æ—¶ï¼Œåˆ™è¯»çŠ¶æ€ï¼ˆS&gt;&gt;&gt;16ï¼‰å¤§äº0ï¼Œå³è¯»é”å·²è¢«è·å–ã€‚</strong></em></p>
<h5 id="2å†™é”çš„è·å–ä¸é‡Šæ”¾">2.å†™é”çš„è·å–ä¸é‡Šæ”¾</h5>
<p>å†™é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„æ’å®ƒé”ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å¢åŠ å†™çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–å†™é”æ—¶ï¼Œè¯»é”å·²ç»è¢«è·å–ï¼ˆè¯»çŠ¶æ€ä¸ä¸º0ï¼‰æˆ–è€…è¯¥çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè·å–å†™é”çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p>ReentrantReadWriteLockçš„tryAcquireæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">protected final boolean tryAcquire(int acquires) {
    Thread current = Thread.currentThread();
    int c = getState();
    int w = exclusiveCount(c);
    if (c != 0) {
        // (Note: if c != 0 and w == 0 then shared count != 0)
        //// å­˜åœ¨è¯»é”æˆ–è€…å½“å‰è·å–çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹
        if (w == 0 || current != getExclusiveOwnerThread())
            return false;
        if (w + exclusiveCount(acquires) &gt; MAX_COUNT)
            throw new Error(&quot;Maximum lock count exceeded&quot;);
        // Reentrant acquire
        setState(c + acquires);
        return true;
    }
    if (writerShouldBlock() ||
        !compareAndSetState(c, c + acquires))
        return false;
    setExclusiveOwnerThread(current);
    return true;
}
</code></pre>
<p>è¯¥æ–¹æ³•é™¤äº†é‡å…¥æ¡ä»¶ï¼ˆå½“å‰çº¿ç¨‹ä¸ºè·å–äº†å†™é”çš„çº¿ç¨‹ï¼‰ä¹‹å¤–ï¼Œå¢åŠ äº†ä¸€ä¸ªè¯»é”æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ã€‚å¦‚æœå­˜åœ¨è¯»é”ï¼Œåˆ™å†™é”ä¸èƒ½è¢«è·å–ï¼ŒåŸå› åœ¨äºï¼šè¯»å†™é”è¦ç¡®ä¿å†™é”çš„æ“ä½œå¯¹è¯»é”å¯è§ï¼Œå¦‚æœå…è®¸è¯»é”åœ¨å·²è¢«è·å–çš„æƒ…å†µä¸‹å¯¹å†™é”çš„è·å–ï¼Œé‚£ä¹ˆæ­£åœ¨è¿è¡Œçš„å…¶ä»–è¯»çº¿ç¨‹å°±æ— æ³•æ„ŸçŸ¥åˆ°å½“å‰å†™çº¿ç¨‹çš„æ“ä½œã€‚å› æ­¤ï¼Œåªæœ‰ç­‰å¾…å…¶ä»–è¯»çº¿ç¨‹éƒ½é‡Šæ”¾äº†è¯»é”ï¼Œå†™é”æ‰èƒ½è¢«å½“å‰çº¿ç¨‹è·å–ï¼Œè€Œå†™é”ä¸€æ—¦è¢«è·å–ï¼Œåˆ™å…¶ä»–è¯»å†™çº¿ç¨‹çš„åç»­è®¿é—®å‡è¢«é˜»å¡ã€‚</p>
<p>å†™é”çš„é‡Šæ”¾ä¸ReentrantLockçš„é‡Šæ”¾è¿‡ç¨‹åŸºæœ¬ç±»ä¼¼ï¼Œæ¯æ¬¡é‡Šæ”¾å‡å‡å°‘å†™çŠ¶æ€ï¼Œå½“å†™çŠ¶æ€ä¸º0æ—¶è¡¨ç¤ºå†™é”å·²è¢«é‡Šæ”¾ï¼Œä»è€Œç­‰å¾…çš„è¯»å†™çº¿ç¨‹èƒ½å¤Ÿç»§ç»­è®¿é—®è¯»å†™é”ï¼ŒåŒæ—¶å‰æ¬¡å†™çº¿ç¨‹çš„ä¿®æ”¹å¯¹åç»­è¯»å†™çº¿ç¨‹å¯è§ã€‚</p>
<h5 id="3è¯»é”çš„è·å–ä¸é‡Šæ”¾">3.è¯»é”çš„è·å–ä¸é‡Šæ”¾</h5>
<p>è¯»é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„å…±äº«é”ï¼Œå®ƒèƒ½å¤Ÿè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–ï¼Œåœ¨æ²¡æœ‰å…¶ä»–å†™çº¿ç¨‹è®¿é—®ï¼ˆæˆ–è€…å†™çŠ¶æ€ä¸º0ï¼‰æ—¶ï¼Œè¯»é”æ€»ä¼šè¢«æˆåŠŸåœ°è·å–ï¼Œè€Œæ‰€åšçš„ä¹Ÿåªæ˜¯ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰å¢åŠ è¯»çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–äº†è¯»é”ï¼Œåˆ™å¢åŠ è¯»çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–è¯»é”æ—¶ï¼Œå†™é”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œåˆ™è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<blockquote>
<p>ReentrantReadWriteLockçš„tryAcquireSharedæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java"> protected final int tryAcquireShared(int unused) {
    Thread current = Thread.currentThread();
    int c = getState();
    if (exclusiveCount(c) != 0 &amp;&amp;
        getExclusiveOwnerThread() != current)
        return -1;
    int r = sharedCount(c);
    if (!readerShouldBlock() &amp;&amp;
        r &lt; MAX_COUNT &amp;&amp;
        compareAndSetState(c, c + SHARED_UNIT)) {
        if (r == 0) {
            firstReader = current;
            firstReaderHoldCount = 1;
        } else if (firstReader == current) {
            firstReaderHoldCount++;
        } else {
            HoldCounter rh = cachedHoldCounter;
            if (rh == null || rh.tid != getThreadId(current))
                cachedHoldCounter = rh = readHolds.get();
            else if (rh.count == 0)
                readHolds.set(rh);
            rh.count++;
        }
        return 1;
    }
    return fullTryAcquireShared(current);
}
</code></pre>
<p>åœ¨tryAcquireShared(int unused)æ–¹æ³•ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å½“å‰çº¿ç¨‹è·å–è¯»é”å¤±è´¥ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–äº†å†™é”æˆ–è€…å†™é”æœªè¢«è·å–ï¼Œåˆ™å½“å‰çº¿ç¨‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼Œä¾é CASä¿è¯ï¼‰å¢åŠ è¯»çŠ¶æ€ï¼ŒæˆåŠŸè·å–è¯»é”ã€‚</p>
<p>è¯»é”çš„æ¯æ¬¡é‡Šæ”¾ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶é‡Šæ”¾è¯»é”ï¼‰å‡å‡å°‘è¯»çŠ¶æ€ï¼Œå‡å°‘çš„å€¼æ˜¯ï¼ˆ1 &lt;&lt; 16ï¼‰ã€‚</p>
<h5 id="4é”é™çº§">4.é”é™çº§</h5>
<p>é”é™çº§æŒ‡çš„æ˜¯å†™é”é™çº§æˆä¸ºè¯»é”ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ‹¥æœ‰å†™é”ï¼Œç„¶åå°†å…¶é‡Šæ”¾ï¼Œæœ€åå†è·å–è¯»é”ï¼Œè¿™ç§åˆ†æ®µå®Œæˆçš„è¿‡ç¨‹ä¸èƒ½ç§°ä¹‹ä¸ºé”é™çº§ã€‚<strong>é”é™çº§æ˜¯æŒ‡æŠŠæŒä½ï¼ˆå½“å‰æ‹¥æœ‰çš„ï¼‰å†™é”ï¼Œå†è·å–åˆ°è¯»é”ï¼Œéšåé‡Šæ”¾ï¼ˆå…ˆå‰æ‹¥æœ‰çš„ï¼‰å†™é”çš„è¿‡ç¨‹ã€‚</strong></p>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸ªé”é™çº§çš„ç¤ºä¾‹ã€‚å› ä¸ºæ•°æ®ä¸å¸¸å˜åŒ–ï¼Œæ‰€ä»¥å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘åœ°è¿›è¡Œæ•°æ®å¤„ç†ï¼Œå½“æ•°æ®å˜æ›´åï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ„ŸçŸ¥åˆ°æ•°æ®å˜åŒ–ï¼Œåˆ™è¿›è¡Œæ•°æ®çš„å‡†å¤‡å·¥ä½œï¼ŒåŒæ—¶å…¶ä»–å¤„ç†çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹å®Œæˆæ•°æ®çš„å‡†å¤‡å·¥ä½œã€‚</p>
<pre><code class="language-java"> public void processData() {
        readLock.lock();
        if (!update) {
            // å¿…é¡»å…ˆé‡Šæ”¾è¯»é”
            readLock.unlock();
            // é”é™çº§ä»å†™é”è·å–åˆ°å¼€å§‹
            writeLock.lock();
            try {
                if (!update) {
                    // å‡†å¤‡æ•°æ®çš„æµç¨‹ï¼ˆç•¥ï¼‰
                    update = true;
                }
                readLock.lock();
            } finally {
                writeLock.unlock();
            }
            // é”é™çº§å®Œæˆï¼Œå†™é”é™çº§ä¸ºè¯»é”
        }
        try {
            // ä½¿ç”¨æ•°æ®çš„æµç¨‹ï¼ˆç•¥ï¼‰
        } finally {
            readLock.unlock();
        }
    }
</code></pre>
<p>ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œå½“æ•°æ®å‘ç”Ÿå˜æ›´åï¼Œupdateå˜é‡ï¼ˆå¸ƒå°”ç±»å‹ä¸”volatileä¿®é¥°ï¼‰è¢«è®¾ç½®ä¸ºfalseï¼Œæ­¤æ—¶æ‰€æœ‰è®¿é—®processData()æ–¹æ³•çš„çº¿ç¨‹éƒ½èƒ½å¤Ÿæ„ŸçŸ¥åˆ°å˜åŒ–ï¼Œä½†åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°å†™é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šè¢«é˜»å¡åœ¨è¯»é”å’Œå†™é”çš„lock()æ–¹æ³•ä¸Šã€‚å½“å‰çº¿ç¨‹è·å–å†™é”å®Œæˆæ•°æ®å‡†å¤‡ä¹‹åï¼Œå†è·å–è¯»é”ï¼Œéšåé‡Šæ”¾å†™é”ï¼Œå®Œæˆé”é™çº§ã€‚</p>
<p>RentrantReadWriteLockä¸æ”¯æŒé”å‡çº§ï¼ˆæŠŠæŒè¯»é”ã€è·å–å†™é”ï¼Œæœ€åé‡Šæ”¾è¯»é”çš„è¿‡ç¨‹ï¼‰ã€‚ç›®çš„ä¹Ÿæ˜¯ä¿è¯æ•°æ®å¯è§æ€§ï¼Œå¦‚æœè¯»é”å·²è¢«å¤šä¸ªçº¿ç¨‹è·å–ï¼Œå…¶ä¸­ä»»æ„çº¿ç¨‹æˆåŠŸè·å–äº†å†™é”å¹¶æ›´æ–°äº†æ•°æ®ï¼Œåˆ™å…¶æ›´æ–°å¯¹å…¶ä»–è·å–åˆ°è¯»é”çš„çº¿ç¨‹æ˜¯ä¸å¯è§çš„ã€‚</p>
<h2 id="45-locksupportå·¥å…·">4.5 LockSupportå·¥å…·</h2>
<p>å½“éœ€è¦é˜»å¡æˆ–å”¤é†’ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œéƒ½ä¼šä½¿ç”¨LockSupportå·¥å…·ç±»æ¥å®Œæˆç›¸åº”å·¥ä½œã€‚LockSupportå®šä¹‰äº†ä¸€ç»„çš„å…¬å…±é™æ€æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æä¾›äº†æœ€åŸºæœ¬çš„çº¿ç¨‹é˜»å¡å’Œå”¤é†’åŠŸèƒ½ï¼Œè€ŒLockSupportä¹Ÿæˆä¸ºæ„å»ºåŒæ­¥ç»„ä»¶çš„åŸºç¡€å·¥å…·ã€‚</p>
<p>LockSupportå®šä¹‰äº†ä¸€ç»„ä»¥parkå¼€å¤´çš„æ–¹æ³•ç”¨æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä»¥åŠunpark(Thread thread)æ–¹æ³•æ¥å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚</p>
<figure data-type="image" tabindex="10"><img src="https://q456qq520.github.io/post-images/1660616478713.png" alt="LockSupportæä¾›çš„é˜»å¡å’Œå”¤é†’æ–¹æ³•" loading="lazy"></figure>
<h2 id="46-conditionæ¥å£">4.6 Conditionæ¥å£</h2>
<p>ä»»æ„ä¸€ä¸ªJavaå¯¹è±¡ï¼Œéƒ½æ‹¥æœ‰ä¸€ç»„ç›‘è§†å™¨æ–¹æ³•ï¼ˆå®šä¹‰åœ¨java.lang.Objectä¸Šï¼‰ï¼Œä¸»è¦åŒ…æ‹¬wait()ã€wait(long timeout)ã€notify()ä»¥åŠnotifyAll()æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸synchronizedåŒæ­¥å…³é”®å­—é…åˆï¼Œå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ã€‚Conditionæ¥å£ä¹Ÿæä¾›äº†ç±»ä¼¼Objectçš„ç›‘è§†å™¨æ–¹æ³•ï¼Œä¸Locké…åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ï¼Œä½†æ˜¯è¿™ä¸¤è€…åœ¨ä½¿ç”¨æ–¹å¼ä»¥åŠåŠŸèƒ½ç‰¹æ€§ä¸Šè¿˜æ˜¯æœ‰å·®åˆ«çš„ã€‚</p>
<figure data-type="image" tabindex="11"><img src="https://q456qq520.github.io/post-images/1660616790444.png" alt="Objectçš„ç›‘è§†å™¨æ–¹æ³•ä¸Conditionæ¥å£çš„å¯¹æ¯”" loading="lazy"></figure>
<h3 id="461-conditionæ¥å£ä¸ç¤ºä¾‹">4.6.1 Conditionæ¥å£ä¸ç¤ºä¾‹</h3>
<p>Conditionå®šä¹‰äº†ç­‰å¾…/é€šçŸ¥ä¸¤ç§ç±»å‹çš„æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹è°ƒç”¨è¿™äº›æ–¹æ³•æ—¶ï¼Œéœ€è¦æå‰è·å–åˆ°Conditionå¯¹è±¡å…³è”çš„é”ã€‚Conditionå¯¹è±¡æ˜¯ç”±Lockå¯¹è±¡ï¼ˆè°ƒç”¨Lockå¯¹è±¡çš„newCondition()æ–¹æ³•ï¼‰åˆ›å»ºå‡ºæ¥çš„ï¼Œæ¢å¥è¯è¯´ï¼ŒConditionæ˜¯ä¾èµ–Lockå¯¹è±¡çš„ã€‚</p>
<p>Conditionçš„ä½¿ç”¨æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œéœ€è¦æ³¨æ„åœ¨è°ƒç”¨æ–¹æ³•å‰è·å–é”ã€‚</p>
<blockquote>
<p>ConditionUseCase</p>
</blockquote>
<pre><code class="language-java">Lock lock = new ReentrantLock();
    Condition condition = lock.newCondition();
    public void conditionWait() throws InterruptedException {
        lock.lock();
        try {
            condition.await();
        } finally {
            lock.unlock();
        }
    }
    public void conditionSignal() throws InterruptedException {
        lock.lock();
        try {
            condition.signal();
        } finally {
            lock.unlock();
        }
    }
</code></pre>
<p>ä¸€èˆ¬éƒ½ä¼šå°†Conditionå¯¹è±¡ä½œä¸ºæˆå‘˜å˜é‡ã€‚å½“è°ƒç”¨await()æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹ä¼šé‡Šæ”¾é”å¹¶åœ¨æ­¤ç­‰å¾…ï¼Œè€Œå…¶ä»–çº¿ç¨‹è°ƒç”¨Conditionå¯¹è±¡çš„signal()æ–¹æ³•ï¼Œé€šçŸ¥å½“å‰çº¿ç¨‹åï¼Œå½“å‰çº¿ç¨‹æ‰ä»await()æ–¹æ³•è¿”å›ï¼Œå¹¶ä¸”åœ¨è¿”å›å‰å·²ç»è·å–äº†é”ã€‚</p>
<h3 id="462-conditionçš„å®ç°åˆ†æ">4.6.2 Conditionçš„å®ç°åˆ†æ</h3>
<p>ConditionObjectæ˜¯åŒæ­¥å™¨AbstractQueuedSynchronizerçš„å†…éƒ¨ç±»ï¼Œå› ä¸ºConditionçš„æ“ä½œéœ€è¦è·å–ç›¸å…³è”çš„é”ï¼Œæ‰€ä»¥ä½œä¸ºåŒæ­¥å™¨çš„å†…éƒ¨ç±»ä¹Ÿè¾ƒä¸ºåˆç†ã€‚æ¯ä¸ªConditionå¯¹è±¡éƒ½åŒ…å«ç€ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆä»¥ä¸‹ç§°ä¸ºç­‰å¾…é˜Ÿåˆ—ï¼‰ï¼Œè¯¥é˜Ÿåˆ—æ˜¯Conditionå¯¹è±¡å®ç°ç­‰å¾…/é€šçŸ¥åŠŸèƒ½çš„å…³é”®ã€‚</p>
<h5 id="1ç­‰å¾…é˜Ÿåˆ—">1.ç­‰å¾…é˜Ÿåˆ—</h5>
<p>ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªFIFOçš„é˜Ÿåˆ—ï¼Œåœ¨é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†ä¸€ä¸ªçº¿ç¨‹å¼•ç”¨ï¼Œè¯¥çº¿ç¨‹å°±æ˜¯åœ¨Conditionå¯¹è±¡ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†Condition.await()æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†ä¼šé‡Šæ”¾é”ã€æ„é€ æˆèŠ‚ç‚¹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>ä¸€ä¸ªConditionåŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ŒConditionæ‹¥æœ‰é¦–èŠ‚ç‚¹ï¼ˆfirstWaiterï¼‰å’Œå°¾èŠ‚ç‚¹ï¼ˆlastWaiterï¼‰ã€‚å½“å‰çº¿ç¨‹è°ƒç”¨Condition.await()æ–¹æ³•ï¼Œå°†ä¼šä»¥å½“å‰çº¿ç¨‹æ„é€ èŠ‚ç‚¹ï¼Œå¹¶å°†èŠ‚ç‚¹ä»å°¾éƒ¨åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚</p>
<figure data-type="image" tabindex="12"><img src="https://q456qq520.github.io/post-images/1660617414829.png" alt="ç­‰å¾…é˜Ÿåˆ—çš„åŸºæœ¬ç»“æ„" loading="lazy"></figure>
<p>å¦‚å›¾æ‰€ç¤ºï¼ŒConditionæ‹¥æœ‰é¦–å°¾èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œè€Œæ–°å¢èŠ‚ç‚¹åªéœ€è¦å°†åŸæœ‰çš„å°¾èŠ‚ç‚¹nextWaiteræŒ‡å‘å®ƒï¼Œå¹¶ä¸”æ›´æ–°å°¾èŠ‚ç‚¹å³å¯ã€‚ä¸Šè¿°èŠ‚ç‚¹å¼•ç”¨æ›´æ–°çš„è¿‡ç¨‹å¹¶æ²¡æœ‰ä½¿ç”¨CASä¿è¯ï¼ŒåŸå› åœ¨äºè°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹å¿…å®šæ˜¯è·å–äº†é”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥è¿‡ç¨‹æ˜¯ç”±é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>åœ¨Objectçš„ç›‘è§†å™¨æ¨¡å‹ä¸Šï¼Œä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œå¹¶å‘åŒ…ä¸­çš„Lockï¼ˆæ›´ç¡®åˆ‡åœ°è¯´æ˜¯åŒæ­¥å™¨ï¼‰æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å’Œå¤šä¸ªç­‰å¾…é˜Ÿåˆ—ã€‚</p>
<figure data-type="image" tabindex="13"><img src="https://q456qq520.github.io/post-images/1660618808661.png" alt="åŒæ­¥é˜Ÿåˆ—ä¸ç­‰å¾…é˜Ÿåˆ—" loading="lazy"></figure>
<p>Conditionçš„å®ç°æ˜¯åŒæ­¥å™¨çš„å†…éƒ¨ç±»ï¼Œå› æ­¤æ¯ä¸ªConditionå®ä¾‹éƒ½èƒ½å¤Ÿè®¿é—®åŒæ­¥å™¨æä¾›çš„æ–¹æ³•ï¼Œç›¸å½“äºæ¯ä¸ªConditionéƒ½æ‹¥æœ‰æ‰€å±åŒæ­¥å™¨çš„å¼•ç”¨ã€‚</p>
<h5 id="2ç­‰å¾…">2.ç­‰å¾…</h5>
<p>è°ƒç”¨Conditionçš„await()æ–¹æ³•ï¼ˆæˆ–è€…ä»¥awaitå¼€å¤´çš„æ–¹æ³•ï¼‰ï¼Œä¼šä½¿å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶é‡Šæ”¾é”ï¼ŒåŒæ—¶çº¿ç¨‹çŠ¶æ€å˜ä¸ºç­‰å¾…çŠ¶æ€ã€‚å½“ä»await()æ–¹æ³•è¿”å›æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¸€å®šè·å–äº†Conditionç›¸å…³è”çš„é”ã€‚</p>
<p>å¦‚æœä»é˜Ÿåˆ—ï¼ˆåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ï¼‰çš„è§’åº¦çœ‹await()æ–¹æ³•ï¼Œå½“è°ƒç”¨await()æ–¹æ³•æ—¶ï¼Œç›¸å½“äºåŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼ˆè·å–äº†é”çš„èŠ‚ç‚¹ï¼‰ç§»åŠ¨åˆ°Conditionçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</p>
<blockquote>
<p>ConditionObjectçš„awaitæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">public final void await() throws InterruptedException {
    if (Thread.interrupted())
        throw new InterruptedException();
    // å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
    Node node = addConditionWaiter();
    // é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯é‡Šæ”¾é”
    long savedState = fullyRelease(node);
    int interruptMode = 0;
    while (!isOnSyncQueue(node)) {
        LockSupport.park(this);
        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)
            break;
    }
    if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)
        interruptMode = REINTERRUPT;
    if (node.nextWaiter != null) // clean up if cancelled
        unlinkCancelledWaiters();
    if (interruptMode != 0)
        reportInterruptAfterWait(interruptMode);
}
</code></pre>
<p>è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹æˆåŠŸè·å–äº†é”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯åŒæ­¥é˜Ÿåˆ—ä¸­çš„é¦–èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•ä¼šå°†å½“å‰çº¿ç¨‹æ„é€ æˆèŠ‚ç‚¹å¹¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹ï¼Œç„¶åå½“å‰çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>å½“ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹è¢«å”¤é†’ï¼Œåˆ™å”¤é†’èŠ‚ç‚¹çš„çº¿ç¨‹å¼€å§‹å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœä¸æ˜¯é€šè¿‡å…¶ä»–çº¿ç¨‹è°ƒç”¨Condition.signal()æ–¹æ³•å”¤é†’ï¼Œè€Œæ˜¯å¯¹ç­‰å¾…çº¿ç¨‹è¿›è¡Œä¸­æ–­ï¼Œåˆ™ä¼šæŠ›å‡ºInterruptedExceptionã€‚</p>
<p>å¦‚æœä»é˜Ÿåˆ—çš„è§’åº¦å»çœ‹ï¼Œå½“å‰çº¿ç¨‹åŠ å…¥Conditionçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œè¯¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<figure data-type="image" tabindex="14"><img src="https://q456qq520.github.io/post-images/1660619123259.png" alt="å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—" loading="lazy"></figure>
<p>åŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹å¹¶ä¸ä¼šç›´æ¥åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œæ˜¯é€šè¿‡addConditionWaiter()æ–¹æ³•æŠŠå½“å‰çº¿ç¨‹æ„é€ æˆä¸€ä¸ªæ–°çš„èŠ‚ç‚¹å¹¶å°†å…¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</p>
<h5 id="3é€šçŸ¥">3.é€šçŸ¥</h5>
<p>è°ƒç”¨Conditionçš„signal()æ–¹æ³•ï¼Œå°†ä¼šå”¤é†’åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼ˆé¦–èŠ‚ç‚¹ï¼‰ï¼Œåœ¨å”¤é†’èŠ‚ç‚¹ä¹‹å‰ï¼Œä¼šå°†èŠ‚ç‚¹ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</p>
<blockquote>
<p>ConditionObjectçš„signalæ–¹æ³•</p>
</blockquote>
<pre><code class="language-java">public final void signal() {
    if (!isHeldExclusively())
        throw new IllegalMonitorStateException();
    Node first = firstWaiter;
    if (first != null)
        doSignal(first);
}
</code></pre>
<p>è°ƒç”¨è¯¥æ–¹æ³•çš„å‰ç½®æ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹å¿…é¡»è·å–äº†é”ï¼Œå¯ä»¥çœ‹åˆ°signal()æ–¹æ³•è¿›è¡Œäº†isHeldExclusively()æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹å¿…é¡»æ˜¯è·å–äº†é”çš„çº¿ç¨‹ã€‚æ¥ç€è·å–ç­‰å¾…é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼Œå°†å…¶ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—å¹¶ä½¿ç”¨LockSupportå”¤é†’èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ã€‚</p>
<p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„enq(Node node)æ–¹æ³•ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹çº¿ç¨‹å®‰å…¨åœ°ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ã€‚å½“èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—åï¼Œå½“å‰çº¿ç¨‹å†ä½¿ç”¨LockSupportå”¤é†’è¯¥èŠ‚ç‚¹çš„çº¿ç¨‹ã€‚</p>
<p>è¢«å”¤é†’åçš„çº¿ç¨‹ï¼Œå°†ä»await()æ–¹æ³•ä¸­çš„whileå¾ªç¯ä¸­é€€å‡ºï¼ˆisOnSyncQueue(Node node)æ–¹æ³•è¿”å›trueï¼ŒèŠ‚ç‚¹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼‰ï¼Œè¿›è€Œè°ƒç”¨åŒæ­¥å™¨çš„acquireQueued()æ–¹æ³•åŠ å…¥åˆ°è·å–åŒæ­¥çŠ¶æ€çš„ç«äº‰ä¸­ã€‚</p>
<p>æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…è¯´é”ï¼‰ä¹‹åï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°†ä»å…ˆå‰è°ƒç”¨çš„await()æ–¹æ³•è¿”å›ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å·²ç»æˆåŠŸåœ°è·å–äº†é”ã€‚</p>
<p>Conditionçš„signalAll()æ–¹æ³•ï¼Œç›¸å½“äºå¯¹ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å‡æ‰§è¡Œä¸€æ¬¡signal()æ–¹æ³•ï¼Œæ•ˆæœå°±æ˜¯å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰èŠ‚ç‚¹å…¨éƒ¨ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶å”¤é†’æ¯ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹]]></title>
        <id>https://q456qq520.github.io/post/shu-ju-ku-lian-jie-chi-shi-li/</id>
        <link href="https://q456qq520.github.io/post/shu-ju-ku-lian-jie-chi-shi-li/">
        </link>
        <updated>2022-08-09T10:16:08.000Z</updated>
        <content type="html"><![CDATA[<p>æˆ‘ä»¬ä½¿ç”¨ç­‰å¾…è¶…æ—¶æ¨¡å¼æ¥æ„é€ ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ï¼Œåœ¨ç¤ºä¾‹ä¸­æ¨¡æ‹Ÿä»è¿æ¥æ± ä¸­è·å–ã€ä½¿ç”¨å’Œé‡Šæ”¾è¿æ¥çš„è¿‡ç¨‹ï¼Œè€Œå®¢æˆ·ç«¯è·å–è¿æ¥çš„è¿‡ç¨‹è¢«è®¾å®šä¸ºç­‰å¾…è¶…æ—¶çš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åœ¨1000æ¯«ç§’å†…å¦‚æœæ— æ³•è·å–åˆ°å¯ç”¨è¿æ¥ï¼Œå°†ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªnullã€‚è®¾å®šè¿æ¥æ± çš„å¤§å°ä¸º10ä¸ªï¼Œç„¶åé€šè¿‡è°ƒèŠ‚å®¢æˆ·ç«¯çš„çº¿ç¨‹æ•°æ¥æ¨¡æ‹Ÿæ— æ³•è·å–è¿æ¥çš„åœºæ™¯ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹è¿æ¥æ± çš„å®šä¹‰ã€‚å®ƒé€šè¿‡æ„é€ å‡½æ•°åˆå§‹åŒ–è¿æ¥çš„æœ€å¤§ä¸Šé™ï¼Œé€šè¿‡ä¸€ä¸ªåŒå‘é˜Ÿåˆ—æ¥ç»´æŠ¤è¿æ¥ï¼Œè°ƒç”¨æ–¹éœ€è¦å…ˆè°ƒç”¨fetchConnection(long)æ–¹æ³•æ¥æŒ‡å®šåœ¨å¤šå°‘æ¯«ç§’å†…è¶…æ—¶è·å–è¿æ¥ï¼Œå½“è¿æ¥ä½¿ç”¨å®Œæˆåï¼Œéœ€è¦è°ƒç”¨releaseConnection(Connection)æ–¹æ³•å°†è¿æ¥æ”¾å›çº¿ç¨‹æ± ï¼Œç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre><code class="language-java">package cm.connectpool;

import java.sql.Connection;
import java.util.LinkedList;

/**
 * è¿æ¥æ± 
 * @author likecat
 * @version 1.0
 * @date 2022/8/9 18:23
 */
public class ConnectionPool {
    private LinkedList&lt;Connection&gt; pool = new LinkedList&lt;Connection&gt;();
    public ConnectionPool(int initialSize) {
        if (initialSize &gt; 0) {
            for (int i = 0; i &lt; initialSize; i++) {
                pool.addLast(ConnectionDriver.createConnection());
            }
        }
    }
    public void releaseConnection(Connection connection) {
        if (connection != null) {
            synchronized (pool){
            // è¿æ¥é‡Šæ”¾åéœ€è¦è¿›è¡Œé€šçŸ¥ï¼Œè¿™æ ·å…¶ä»–æ¶ˆè´¹è€…èƒ½å¤Ÿæ„ŸçŸ¥åˆ°è¿æ¥æ± ä¸­å·²ç»å½’è¿˜äº†ä¸€ä¸ªè¿æ¥
                pool.addLast(connection);
                pool.notifyAll();
            }
        }
    }
    // åœ¨millså†…æ— æ³•è·å–åˆ°è¿æ¥ï¼Œå°†ä¼šè¿”å›null
    public Connection fetchConnection(long mills) throws InterruptedException {
        synchronized (pool) {
        // å®Œå…¨è¶…æ—¶
            if (mills &lt;= 0) {
                while (pool.isEmpty()) {
                    pool.wait();
                }
                return pool.removeFirst();
            } else{
                long future = System.currentTimeMillis() + mills;
                long remaining = mills;
                while (pool.isEmpty() &amp;&amp; remaining &gt; 0) {
                    pool.wait(remaining);
                    remaining = future - System.currentTimeMillis();
                }
                Connection result = null;
                if (!pool.isEmpty()) {
                    result = pool.removeFirst();
                }
                return result;
            }
        }
    }
}

</code></pre>
<p>ç”±äºjava.sql.Connectionæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ€ç»ˆçš„å®ç°æ˜¯ç”±æ•°æ®åº“é©±åŠ¨æä¾›æ–¹æ¥å®ç°çš„ï¼Œè€ƒè™‘åˆ°åªæ˜¯ä¸ªç¤ºä¾‹æˆ‘ä»¬é€šè¿‡åŠ¨æ€ä»£ç†æ„é€ äº†ä¸€ä¸ªConnectionï¼Œè¯¥Connectionçš„ä»£ç†å®ç°ä»…ä»…æ˜¯åœ¨commit()æ–¹æ³•è°ƒç”¨æ—¶ä¼‘çœ 100æ¯«ç§’ã€‚</p>
<pre><code class="language-java">package cm.connectpool;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.sql.Connection;
import java.util.concurrent.TimeUnit;

/**
 * é©±åŠ¨
 * @author likecat
 * @version 1.0
 * @date 2022/8/9 18:24
 */
public class ConnectionDriver {
    static class ConnectionHandler implements InvocationHandler {

        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable{
            if (method.getName().equals(&quot;commit&quot;)) {
                TimeUnit.MILLISECONDS.sleep(100);
            }
            return null;
         }
    }
    // åˆ›å»ºä¸€ä¸ªConnectionçš„ä»£ç†ï¼Œåœ¨commitæ—¶ä¼‘çœ 100æ¯«ç§’
    public static final Connection createConnection() {
        return (Connection) Proxy.newProxyInstance(ConnectionDriver.class.getClassLoader(), new Class&lt;?&gt;[] { Connection.class }, new ConnectionHandler());
    }
}
</code></pre>
<p>æ¨¡æ‹Ÿå®¢æˆ·ç«¯ConnectionRunnerè·å–ã€ä½¿ç”¨ã€æœ€åé‡Šæ”¾è¿æ¥çš„è¿‡ç¨‹ï¼Œå½“å®ƒä½¿ç”¨æ—¶è¿æ¥å°†ä¼šå¢åŠ è·å–åˆ°è¿æ¥çš„æ•°é‡ï¼Œåä¹‹ï¼Œå°†ä¼šå¢åŠ æœªè·å–åˆ°è¿æ¥çš„æ•°é‡ã€‚</p>
<pre><code class="language-java">package cm.connectpool;

import java.sql.Connection;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/9 18:40
 */
public class ConnectionPoolTest {
    static ConnectionPool pool = new ConnectionPool(10);
    // ä¿è¯æ‰€æœ‰ConnectionRunnerèƒ½å¤ŸåŒæ—¶å¼€å§‹
    static CountDownLatch start = new CountDownLatch(1);
    // mainçº¿ç¨‹å°†ä¼šç­‰å¾…æ‰€æœ‰ConnectionRunnerç»“æŸåæ‰èƒ½ç»§ç»­æ‰§è¡Œ
    static CountDownLatch end;
    public static void main(String[] args) throws Exception {
// çº¿ç¨‹æ•°é‡ï¼Œå¯ä»¥ä¿®æ”¹çº¿ç¨‹æ•°é‡è¿›è¡Œè§‚å¯Ÿ
        int threadCount = 10;
        end = new CountDownLatch(threadCount);
        int count = 20;
        AtomicInteger got = new AtomicInteger();
        AtomicInteger notGot = new AtomicInteger();
        for (int i = 0; i &lt; threadCount; i++) {
            Thread thread = new Thread(new ConnetionRunner(count, got, notGot),
                    &quot;ConnectionRunnerThread&quot;);
            thread.start();
        }
        start.countDown();
        end.await();
        System.out.println(&quot;total invoke: &quot; + (threadCount * count));
        System.out.println(&quot;got connection: &quot; + got);
        System.out.println(&quot;not got connection &quot; + notGot);
    }
    static class ConnetionRunner implements Runnable {
        int count;
        AtomicInteger got;
        AtomicInteger notGot;
        public ConnetionRunner(int count, AtomicInteger got, AtomicInteger notGot) {
            this.count = count;
            this.got = got;
            this.notGot = notGot;
        }
        public void run() {
            try {
                start.await();
            } catch (Exception ex) {
            }
            while (count &gt; 0) {
                try {
                    // ä»çº¿ç¨‹æ± ä¸­è·å–è¿æ¥ï¼Œå¦‚æœ1000mså†…æ— æ³•è·å–åˆ°ï¼Œå°†ä¼šè¿”å›null
                    // åˆ†åˆ«ç»Ÿè®¡è¿æ¥è·å–çš„æ•°é‡gotå’Œæœªè·å–åˆ°çš„æ•°é‡notGot
                    Connection connection = pool.fetchConnection(1000);
                    if (connection != null) {
                        try {
                            connection.createStatement();
                            connection.commit();
                        } finally {
                            pool.releaseConnection(connection);
                            got.incrementAndGet();
                        }
                    } else {
                        notGot.incrementAndGet();
                    }
                } catch (Exception ex) {
                } finally {
                    count--;
                }
            }
            end.countDown();
        }
    }
}

</code></pre>
<p>ä¸Šè¿°ç¤ºä¾‹ä¸­ä½¿ç”¨äº†CountDownLatchæ¥ç¡®ä¿ConnectionRunnerThreadèƒ½å¤ŸåŒæ—¶å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨å…¨éƒ¨ç»“æŸä¹‹åï¼Œæ‰ä½¿mainçº¿ç¨‹ä»ç­‰å¾…çŠ¶æ€ä¸­è¿”å›ã€‚</p>
<p>åœ¨èµ„æºä¸€å®šçš„æƒ…å†µä¸‹ï¼ˆè¿æ¥æ± ä¸­çš„10ä¸ªè¿æ¥ï¼‰ï¼Œéšç€å®¢æˆ·ç«¯çº¿ç¨‹çš„é€æ­¥å¢åŠ ï¼Œå®¢æˆ·ç«¯å‡ºç°è¶…æ—¶æ— æ³•è·å–è¿æ¥çš„æ¯”ç‡ä¸æ–­å‡é«˜ã€‚è™½ç„¶å®¢æˆ·ç«¯çº¿ç¨‹åœ¨è¿™ç§è¶…æ—¶è·å–çš„æ¨¡å¼ä¸‹ä¼šå‡ºç°è¿æ¥æ— æ³•è·å–çš„æƒ…å†µï¼Œä½†æ˜¯å®ƒèƒ½å¤Ÿä¿è¯å®¢æˆ·ç«¯çº¿ç¨‹ä¸ä¼šä¸€ç›´æŒ‚åœ¨è¿æ¥è·å–çš„æ“ä½œä¸Šï¼Œè€Œæ˜¯â€œæŒ‰æ—¶â€è¿”å›ï¼Œå¹¶å‘ŠçŸ¥å®¢æˆ·ç«¯è¿æ¥è·å–å‡ºç°é—®é¢˜ï¼Œæ˜¯ç³»ç»Ÿçš„ä¸€ç§è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚æ•°æ®åº“è¿æ¥æ± çš„è®¾è®¡ä¹Ÿå¯ä»¥å¤ç”¨åˆ°å…¶ä»–çš„èµ„æºè·å–çš„åœºæ™¯ï¼Œé’ˆå¯¹æ˜‚è´µèµ„æºï¼ˆæ¯”å¦‚æ•°æ®åº“è¿æ¥ï¼‰çš„è·å–éƒ½åº”è¯¥åŠ ä»¥è¶…æ—¶é™åˆ¶ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[JAVAå¹¶å‘ï¼ˆä¸€ï¼‰]]></title>
        <id>https://q456qq520.github.io/post/java-bing-fa/</id>
        <link href="https://q456qq520.github.io/post/java-bing-fa/">
        </link>
        <updated>2022-07-07T08:36:25.000Z</updated>
        <content type="html"><![CDATA[<h1 id="1-é”æœº">1ã€é”æœº</h1>
<h2 id="11-é”çš„å‡çº§ä¸å¯¹æ¯”">1.1 é”çš„å‡çº§ä¸å¯¹æ¯”</h2>
<p>ä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œå¼•å…¥äº†â€œåå‘é”â€å’Œâ€œè½»é‡çº§é”â€ï¼Œé”ä¸€å…±æœ‰4ç§çŠ¶æ€ï¼Œçº§åˆ«ä»ä½åˆ°é«˜ä¾æ¬¡æ˜¯:æ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶ æ€å’Œé‡é‡çº§é”çŠ¶æ€ï¼Œè¿™å‡ ä¸ªçŠ¶æ€ä¼šéšç€ç«äº‰æƒ…å†µé€æ¸å‡çº§ã€‚é”å¯ä»¥å‡çº§ä½†ä¸èƒ½é™çº§ï¼Œæ„å‘³ç€å å‘é”å‡çº§æˆè½»é‡çº§é”åä¸èƒ½é™çº§æˆåå‘é”ã€‚è¿™ç§é”å‡çº§å´ä¸èƒ½é™çº§çš„ç­–ç•¥ï¼Œç›®çš„æ˜¯ä¸ºäº†æé«˜ è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡</p>
<h3 id="111-åå‘é”">1.1.1 åå‘é”</h3>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒ ä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œä¸ºäº†è®©çº¿ç¨‹è·å¾—é”çš„ä»£ä»·æ›´ä½è€Œå¼•å…¥äº†åå‘é”ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—å¹¶ è·å–é”æ—¶ï¼Œä¼šåœ¨å¯¹è±¡å¤´å’Œæ ˆå¸§ä¸­çš„é”è®°å½•é‡Œå­˜å‚¨é”åå‘çš„çº¿ç¨‹IDï¼Œä»¥åè¯¥çº¿ç¨‹åœ¨è¿›å…¥å’Œé€€å‡º åŒæ­¥å—æ—¶ä¸éœ€è¦è¿›è¡ŒCASæ“ä½œæ¥åŠ é”å’Œè§£é”ï¼Œåªéœ€ç®€å•åœ°æµ‹è¯•ä¸€ä¸‹å¯¹è±¡å¤´çš„Mark Wordï¼ˆå­˜å‚¨å¯¹è±¡çš„hashcodeå’Œé”ä¿¡æ¯ï¼‰é‡Œæ˜¯å¦å­˜å‚¨ç€æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”ã€‚å¦‚æœæµ‹è¯•æˆåŠŸï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»è·å¾—äº†é”ã€‚å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œåˆ™éœ€ è¦å†æµ‹è¯•ä¸€ä¸‹Mark Wordä¸­åå‘é”çš„æ ‡è¯†æ˜¯å¦è®¾ç½®æˆ1(è¡¨ç¤ºå½“å‰æ˜¯åå‘é”):å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ ä½¿ç”¨CASç«äº‰é”;å¦‚æœè®¾ç½®äº†ï¼Œåˆ™å°è¯•ä½¿ç”¨CASå°†å¯¹è±¡å¤´çš„åå‘é”æŒ‡å‘å½“å‰çº¿ç¨‹ã€‚</p>
<pre><code>(1)åå‘é”çš„æ’¤é”€

åå‘é”ä½¿ç”¨äº†ä¸€ç§ç­‰åˆ°ç«äº‰å‡ºç°æ‰é‡Šæ”¾é”çš„æœºåˆ¶ï¼Œæ‰€ä»¥å½“å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰åå‘é”æ—¶ï¼Œ æŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ã€‚åå‘é”çš„æ’¤é”€ï¼Œéœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹(åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šæ²¡æœ‰æ­£ åœ¨æ‰§è¡Œçš„å­—èŠ‚ç )ã€‚å®ƒä¼šé¦–å…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œç„¶åæ£€æŸ¥æŒæœ‰åå‘é”çš„çº¿ç¨‹æ˜¯å¦æ´»ç€ï¼Œ å¦‚æœçº¿ç¨‹ä¸å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œåˆ™å°†å¯¹è±¡å¤´è®¾ç½®æˆæ— é”çŠ¶æ€;å¦‚æœçº¿ç¨‹ä»ç„¶æ´»ç€ï¼Œæ‹¥æœ‰åå‘é”çš„æ ˆ ä¼šè¢«æ‰§è¡Œï¼Œéå†åå‘å¯¹è±¡çš„é”è®°å½•ï¼Œæ ˆä¸­çš„é”è®°å½•å’Œå¯¹è±¡å¤´çš„Mark Wordè¦ä¹ˆé‡æ–°åå‘äºå…¶ä»– çº¿ç¨‹ï¼Œè¦ä¹ˆæ¢å¤åˆ°æ— é”æˆ–è€…æ ‡è®°å¯¹è±¡ä¸é€‚åˆä½œä¸ºåå‘é”ï¼Œæœ€åå”¤é†’æš‚åœçš„çº¿ç¨‹ã€‚
</code></pre>
<h3 id="112-è½»é‡çº§é”">1.1.2 è½»é‡çº§é”</h3>
<pre><code>(1)è½»é‡çº§é”åŠ é”

çº¿ç¨‹åœ¨æ‰§è¡ŒåŒæ­¥å—ä¹‹å‰ï¼ŒJVMä¼šå…ˆåœ¨å½“å‰çº¿ç¨‹çš„æ ˆæ¡¢ä¸­åˆ›å»ºç”¨äºå­˜å‚¨é”è®°å½•çš„ç©ºé—´ï¼Œå¹¶å°†å¯¹è±¡å¤´ä¸­çš„Mark Wordå¤åˆ¶åˆ°é”è®°å½•ä¸­ï¼Œå®˜æ–¹ç§°ä¸ºDisplaced Mark Wordã€‚ç„¶åçº¿ç¨‹å°è¯•ä½¿ç”¨ CASå°†å¯¹è±¡å¤´ä¸­çš„Mark Wordæ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚å¦‚æœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹è·å¾—é”ï¼Œå¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹ç«äº‰é”ï¼Œå½“å‰çº¿ç¨‹ä¾¿å°è¯•ä½¿ç”¨è‡ªæ—‹æ¥è·å–é”ã€‚

(2)è½»é‡çº§é”è§£é”

è½»é‡çº§è§£é”æ—¶ï¼Œä¼šä½¿ç”¨åŸå­çš„CASæ“ä½œå°†Displaced Mark Wordæ›¿æ¢å›åˆ°å¯¹è±¡å¤´ï¼Œå¦‚æœæˆ åŠŸï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰ç«äº‰å‘ç”Ÿã€‚å¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå½“å‰é”å­˜åœ¨ç«äº‰ï¼Œé”å°±ä¼šè†¨èƒ€æˆé‡é‡çº§é”ã€‚

å› ä¸ºè‡ªæ—‹ä¼šæ¶ˆè€—CPUï¼Œä¸ºäº†é¿å…æ— ç”¨çš„è‡ªæ—‹(æ¯”å¦‚è·å¾—é”çš„çº¿ç¨‹è¢«é˜»å¡ä½äº†)ï¼Œä¸€æ—¦é”å‡çº§ æˆé‡é‡çº§é”ï¼Œå°±ä¸ä¼šå†æ¢å¤åˆ°è½»é‡çº§é”çŠ¶æ€ã€‚å½“é”å¤„äºè¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œå…¶ä»–çº¿ç¨‹è¯•å›¾è·å–é”æ—¶ï¼Œ éƒ½ä¼šè¢«é˜»å¡ä½ï¼Œå½“æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åä¼šå”¤é†’è¿™äº›çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°±ä¼šè¿›è¡Œæ–°ä¸€è½® çš„å¤ºé”ä¹‹äº‰ã€‚
</code></pre>
<h3 id="113-é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”">1.1.3 é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”</h3>
<figure data-type="image" tabindex="1"><img src="https://q456qq520.github.io/post-images/1657184456814.png" alt="é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”" loading="lazy"></figure>
<h2 id="12-åŸå­æ“ä½œçš„å®ç°åŸç†">1.2 åŸå­æ“ä½œçš„å®ç°åŸç†</h2>
<p>åŸå­(atomic)æœ¬æ„æ˜¯â€œä¸èƒ½è¢«è¿›ä¸€æ­¥åˆ†å‰²çš„æœ€å°ç²’å­â€ï¼Œè€ŒåŸå­æ“ä½œ(atomic operation)æ„ ä¸ºâ€œä¸å¯è¢«ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œâ€ã€‚åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°åŸå­æ“ä½œå°±å˜å¾—æœ‰ç‚¹å¤æ‚ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://q456qq520.github.io/post-images/1657184549916.png" alt="CPUæœ¯è¯­å®šä¹‰" loading="lazy"></figure>
<h3 id="121-åœ¨javaä¸­å¯ä»¥é€šè¿‡é”å’Œå¾ªç¯casçš„æ–¹å¼æ¥å®ç°åŸå­æ“ä½œ">1.2.1 åœ¨Javaä¸­å¯ä»¥é€šè¿‡é”å’Œå¾ªç¯CASçš„æ–¹å¼æ¥å®ç°åŸå­æ“ä½œã€‚</h3>
<p>JVMä¸­çš„CASæ“ä½œæ­£æ˜¯åˆ©ç”¨äº†å¤„ç†å™¨æä¾›çš„CMPXCHGæŒ‡ä»¤å®ç°çš„ã€‚è‡ªæ—‹CASå®ç°çš„åŸºæœ¬ æ€è·¯å°±æ˜¯å¾ªç¯è¿›è¡ŒCASæ“ä½œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œä»¥ä¸‹ä»£ç å®ç°äº†ä¸€ä¸ªåŸºäºCASçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ æ–¹æ³•safeCountå’Œä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨countã€‚</p>
<pre><code class="language-java">package com.curr;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * å¹¶å‘è®¡æ•°å™¨demo
 * @author likecat
 * @version 1.0
 * @date 2022/7/7 17:08
 */
public class CurrDemo {


    private AtomicInteger atomicI = new AtomicInteger(0);


    private int i = 0;
    public static void main(String[] args) {
        final CurrDemo cas = new CurrDemo();
        List&lt;Thread&gt; ts = new ArrayList&lt;Thread&gt;(600);
        long start = System.currentTimeMillis();
        for (int j = 0; j &lt; 100; j++) {
            Thread t = new Thread(new Runnable() {
                @Override
                public void run() {
                    for (int i = 0; i &lt; 10000; i++) {
                        cas.count();
                        cas.safeCount();
                    }
                }
            });

            ts.add(t);
        }
        for (Thread t : ts) {
            t.start();
        }
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæˆ
        for (Thread t : ts) {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        System.out.println(cas.i);
        System.out.println(cas.atomicI.get());
        System.out.println(System.currentTimeMillis() - start);
    }

    /**
     * ä½¿ç”¨CASå®ç°çº¿ç¨‹å®‰å…¨è®¡æ•°å™¨
     *
     */
    private void safeCount() {
        for (;;) {
            int i = atomicI.get();
            boolean suc = atomicI.compareAndSet(i, ++i);
            if (suc) {
                break;
            }
        }
    }

    /**
     * éçº¿ç¨‹å®‰å…¨è®¡æ•°å™¨
     */
    private void count() {
        i++;
    }

}
</code></pre>
<p>ä»Java 1.5å¼€å§‹ï¼ŒJDKçš„å¹¶å‘åŒ…é‡Œæä¾›äº†ä¸€äº›ç±»æ¥æ”¯æŒåŸå­æ“ä½œï¼Œå¦‚AtomicBoolean(ç”¨åŸå­ æ–¹å¼æ›´æ–°çš„booleanå€¼)ã€AtomicInteger(ç”¨åŸå­æ–¹å¼æ›´æ–°çš„intå€¼)å’ŒAtomicLong(ç”¨åŸå­æ–¹å¼æ›´ æ–°çš„longå€¼)ã€‚è¿™äº›åŸå­åŒ…è£…ç±»è¿˜æä¾›äº†æœ‰ç”¨çš„å·¥å…·æ–¹æ³•ï¼Œæ¯”å¦‚ä»¥åŸå­çš„æ–¹å¼å°†å½“å‰å€¼è‡ªå¢1å’Œ è‡ªå‡1ã€‚</p>
<h3 id="122-caså®ç°åŸå­æ“ä½œçš„ä¸‰å¤§é—®é¢˜">1.2.2 CASå®ç°åŸå­æ“ä½œçš„ä¸‰å¤§é—®é¢˜</h3>
<p>åœ¨Javaå¹¶å‘åŒ…ä¸­æœ‰ä¸€äº›å¹¶å‘æ¡†æ¶ä¹Ÿä½¿ç”¨äº†è‡ªæ—‹CASçš„æ–¹å¼æ¥å®ç°åŸå­æ“ä½œï¼Œæ¯”å¦‚ LinkedTransferQueueç±»çš„Xferæ–¹æ³•ã€‚CASè™½ç„¶å¾ˆé«˜æ•ˆåœ°è§£å†³äº†åŸå­æ“ä½œï¼Œä½†æ˜¯CASä»ç„¶å­˜åœ¨ä¸‰ å¤§é—®é¢˜ã€‚ABAé—®é¢˜ï¼Œå¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§ï¼Œä»¥åŠåªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œã€‚</p>
<ol>
<li><strong>ABAé—®é¢˜</strong>ã€‚å› ä¸ºCASéœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™ï¼Œæ£€æŸ¥å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ– åˆ™æ›´æ–°ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œåˆå˜æˆäº†Aï¼Œé‚£ä¹ˆä½¿ç”¨CASè¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒ çš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šå´å˜åŒ–äº†ã€‚ABAé—®é¢˜çš„è§£å†³æ€è·¯å°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ã€‚åœ¨å˜é‡å‰é¢ è¿½åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·åŠ 1ï¼Œé‚£ä¹ˆAâ†’Bâ†’Aå°±ä¼šå˜æˆ1Aâ†’2Bâ†’3Aã€‚ä» Java 1.5å¼€å§‹ï¼ŒJDKçš„AtomicåŒ…é‡Œæä¾›äº†ä¸€ä¸ªç±»AtomicStampedReferenceæ¥è§£å†³ABAé—®é¢˜ã€‚è¿™ä¸ª ç±»çš„compareAndSetæ–¹æ³•çš„ä½œç”¨æ˜¯é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨æ˜¯å¦ç­‰äºé¢„æœŸå¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥å½“å‰æ ‡å¿—æ˜¯ å¦ç­‰äºé¢„æœŸæ ‡å¿—ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚</li>
<li><strong>å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§</strong>ã€‚è‡ªæ—‹CASå¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™CPUå¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚å¦‚æœJVMèƒ½æ”¯æŒå¤„ç†å™¨æä¾›çš„pauseæŒ‡ä»¤ï¼Œé‚£ä¹ˆæ•ˆç‡ä¼šæœ‰ä¸€å®šçš„æå‡ã€‚pauseæŒ‡ä»¤æœ‰ä¸¤ä¸ªä½œç”¨ï¼šç¬¬ä¸€ï¼Œå®ƒå¯ä»¥å»¶è¿Ÿæµæ°´çº¿æ‰§è¡ŒæŒ‡ä»¤ï¼ˆde-pipelineï¼‰ï¼Œä½¿CPUä¸ä¼šæ¶ˆè€—è¿‡å¤šçš„æ‰§è¡Œèµ„æºï¼Œå»¶è¿Ÿçš„æ—¶é—´å–å†³äºå…·ä½“å®ç°çš„ç‰ˆæœ¬ï¼Œåœ¨ä¸€äº›å¤„ç†å™¨ä¸Šå»¶è¿Ÿæ—¶é—´æ˜¯é›¶ï¼›ç¬¬äºŒï¼Œå®ƒå¯ä»¥é¿å…åœ¨é€€å‡ºå¾ªç¯çš„æ—¶å€™å› å†…å­˜é¡ºåºå†²çªï¼ˆMemory Order Violationï¼‰è€Œå¼•èµ·CPUæµæ°´çº¿è¢«æ¸…ç©ºï¼ˆCPU Pipeline Flushï¼‰ï¼Œä»è€Œæé«˜CPUçš„æ‰§è¡Œæ•ˆç‡ã€‚</li>
<li><strong>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ</strong>ã€‚å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯CASå°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚ã€‚è¿˜æœ‰ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œå°±æ˜¯æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚æ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªå…±äº«å˜é‡iï¼2ï¼Œj=aï¼Œåˆå¹¶ä¸€ä¸‹ij=2aï¼Œç„¶åç”¨CASæ¥æ“ä½œijã€‚ä»Java 1.5å¼€å§‹ï¼ŒJDKæä¾›äº†AtomicReferenceç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œå°±å¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡ŒCASæ“ä½œã€‚</li>
</ol>
<h3 id="123-ä½¿ç”¨é”æœºåˆ¶å®ç°åŸå­æ“ä½œ">1.2.3 ä½¿ç”¨é”æœºåˆ¶å®ç°åŸå­æ“ä½œ</h3>
<p>é”æœºåˆ¶ä¿è¯äº†åªæœ‰è·å¾—é”çš„çº¿ç¨‹æ‰èƒ½å¤Ÿæ“ä½œé”å®šçš„å†…å­˜åŒºåŸŸã€‚JVMå†…éƒ¨å®ç°äº†å¾ˆå¤šç§é”æœºåˆ¶ï¼Œæœ‰åå‘é”ã€è½»é‡çº§é”å’Œäº’æ–¥é”ã€‚æœ‰æ„æ€çš„æ˜¯é™¤äº†åå‘é”ï¼ŒJVMå®ç°é”çš„æ–¹å¼éƒ½ç”¨äº†å¾ªç¯CASï¼Œå³å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥è·å–é”ï¼Œå½“å®ƒé€€å‡ºåŒæ­¥å—çš„æ—¶å€™ä½¿ç”¨å¾ªç¯CASé‡Šæ”¾é”ã€‚</p>
<h1 id="2-javaå†…å­˜æ¨¡å‹">2 Javaå†…å­˜æ¨¡å‹</h1>
<h2 id="21-javaå†…å­˜æ¨¡å‹çš„åŸºç¡€">2.1 Javaå†…å­˜æ¨¡å‹çš„åŸºç¡€</h2>
<h3 id="211-å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„ä¸¤ä¸ªå…³é”®é—®é¢˜">2.1.1 å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„ä¸¤ä¸ªå…³é”®é—®é¢˜</h3>
<p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œéœ€è¦å¤„ç†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼šçº¿ç¨‹ä¹‹é—´å¦‚ä½•é€šä¿¡åŠçº¿ç¨‹ä¹‹é—´å¦‚ä½•åŒæ­¥ï¼ˆè¿™é‡Œçš„çº¿ç¨‹æ˜¯æŒ‡å¹¶å‘æ‰§è¡Œçš„æ´»åŠ¨å®ä½“ï¼‰ã€‚é€šä¿¡æ˜¯æŒ‡çº¿ç¨‹ä¹‹é—´ä»¥ä½•ç§æœºåˆ¶æ¥äº¤æ¢ä¿¡æ¯ã€‚åœ¨å‘½ä»¤å¼ç¼–ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æœºåˆ¶æœ‰ä¸¤ç§ï¼š<strong>å…±äº«å†…å­˜å’Œæ¶ˆæ¯ä¼ é€’</strong></p>
<p>åœ¨å…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å…¬å…±çŠ¶æ€ï¼Œé€šè¿‡å†™-è¯»å†…å­˜ä¸­çš„å…¬å…±çŠ¶æ€è¿›è¡Œéšå¼é€šä¿¡ã€‚åœ¨æ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œçº¿ç¨‹ä¹‹é—´æ²¡æœ‰å…¬å…±çŠ¶æ€ï¼Œçº¿ç¨‹ä¹‹é—´å¿…é¡»é€šè¿‡å‘é€æ¶ˆæ¯æ¥æ˜¾å¼è¿›è¡Œé€šä¿¡ã€‚</p>
<p><strong>åŒæ­¥æ˜¯æŒ‡ç¨‹åºä¸­ç”¨äºæ§åˆ¶ä¸åŒçº¿ç¨‹é—´æ“ä½œå‘ç”Ÿç›¸å¯¹é¡ºåºçš„æœºåˆ¶</strong>ã€‚åœ¨å…±äº«å†…å­˜å¹¶å‘æ¨¡å‹é‡Œï¼ŒåŒæ­¥æ˜¯æ˜¾å¼è¿›è¡Œçš„ã€‚ç¨‹åºå‘˜å¿…é¡»æ˜¾å¼æŒ‡å®šæŸä¸ªæ–¹æ³•æˆ–æŸæ®µä»£ç éœ€è¦åœ¨çº¿ç¨‹ä¹‹é—´äº’æ–¥æ‰§è¡Œã€‚åœ¨æ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œç”±äºæ¶ˆæ¯çš„å‘é€å¿…é¡»åœ¨æ¶ˆæ¯çš„æ¥æ”¶ä¹‹å‰ï¼Œå› æ­¤åŒæ­¥æ˜¯éšå¼è¿›è¡Œçš„ã€‚</p>
<p>Javaçš„å¹¶å‘é‡‡ç”¨çš„æ˜¯å…±äº«å†…å­˜æ¨¡å‹ï¼ŒJavaçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ€»æ˜¯éšå¼è¿›è¡Œï¼Œæ•´ä¸ªé€šä¿¡è¿‡ç¨‹å¯¹ç¨‹åºå‘˜å®Œå…¨é€æ˜ã€‚å¦‚æœç¼–å†™å¤šçº¿ç¨‹ç¨‹åºçš„Javaç¨‹åºå‘˜ä¸ç†è§£éšå¼è¿›è¡Œçš„çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„å·¥ä½œæœºåˆ¶ï¼Œå¾ˆå¯èƒ½ä¼šé‡åˆ°å„ç§å¥‡æ€ªçš„å†…å­˜å¯è§æ€§é—®é¢˜ã€‚</p>
<h3 id="212-javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡ç»“æ„">2.1.2 Javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡ç»“æ„</h3>
<p>åœ¨Javaä¸­ï¼Œæ‰€æœ‰å®ä¾‹åŸŸã€é™æ€åŸŸå’Œæ•°ç»„å…ƒç´ éƒ½å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œå †å†…å­˜åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«å±€éƒ¨å˜é‡ï¼ˆLocal Variablesï¼‰ï¼Œæ–¹æ³•å®šä¹‰å‚æ•°ï¼ˆJavaè¯­è¨€è§„èŒƒç§°ä¹‹ä¸ºFormal Method Parametersï¼‰å’Œå¼‚å¸¸å¤„ç†å™¨å‚æ•°ï¼ˆExceptionHandler Parametersï¼‰ä¸ä¼šåœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œå®ƒä»¬ä¸ä¼šæœ‰å†…å­˜å¯è§æ€§é—®é¢˜ï¼Œä¹Ÿä¸å—å†…å­˜æ¨¡å‹çš„å½±å“ã€‚</p>
<p>Javaçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç”±Javaå†…å­˜æ¨¡å‹ï¼ˆæœ¬æ–‡ç®€ç§°ä¸ºJMMï¼‰æ§åˆ¶ï¼ŒJMMå†³å®šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥ä½•æ—¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚ä»æŠ½è±¡çš„è§’åº¦æ¥çœ‹ï¼ŒJMMå®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½è±¡å…³ç³»ï¼šçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆLocal Memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯»/å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æœ¬åœ°å†…å­˜æ˜¯JMMçš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ã€‚å®ƒæ¶µç›–äº†ç¼“å­˜ã€å†™ç¼“å†²åŒºã€å¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://q456qq520.github.io/post-images/1658842307969.png" alt="Javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡ç»“æ„ç¤ºæ„å›¾" loading="lazy"></figure>
<p>ä»ä¸Šå›¾æ¥çœ‹ï¼Œå¦‚æœçº¿ç¨‹Aä¸çº¿ç¨‹Bä¹‹é—´è¦é€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»å†ä¸‹é¢2ä¸ªæ­¥éª¤ã€‚</p>
<p>1ï¼‰çº¿ç¨‹AæŠŠæœ¬åœ°å†…å­˜Aä¸­æ›´æ–°è¿‡çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚<br>
2ï¼‰çº¿ç¨‹Båˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹Aä¹‹å‰å·²æ›´æ–°è¿‡çš„å…±äº«å˜é‡ã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://q456qq520.github.io/post-images/1658842388422.png" alt="çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡å›¾" loading="lazy"></figure>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæœ¬åœ°å†…å­˜Aå’Œæœ¬åœ°å†…å­˜Bç”±ä¸»å†…å­˜ä¸­å…±äº«å˜é‡xçš„å‰¯æœ¬ã€‚å‡è®¾åˆå§‹æ—¶ï¼Œè¿™3ä¸ªå†…å­˜ä¸­çš„xå€¼éƒ½ä¸º0ã€‚çº¿ç¨‹Aåœ¨æ‰§è¡Œæ—¶ï¼ŒæŠŠæ›´æ–°åçš„xå€¼ï¼ˆå‡è®¾å€¼ä¸º1ï¼‰ä¸´æ—¶å­˜æ”¾åœ¨è‡ªå·±çš„æœ¬åœ°å†…å­˜Aä¸­ã€‚å½“çº¿ç¨‹Aå’Œçº¿ç¨‹Béœ€è¦é€šä¿¡æ—¶ï¼Œçº¿ç¨‹Aé¦–å…ˆä¼šæŠŠè‡ªå·±æœ¬åœ°å†…å­˜ä¸­ä¿®æ”¹åçš„xå€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œæ­¤æ—¶ä¸»å†…å­˜ä¸­çš„xå€¼å˜ä¸ºäº†1ã€‚éšåï¼Œçº¿ç¨‹Båˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹Aæ›´æ–°åçš„xå€¼ï¼Œæ­¤æ—¶çº¿ç¨‹Bçš„æœ¬åœ°å†…å­˜çš„xå€¼ä¹Ÿå˜ä¸ºäº†1ã€‚</p>
<p>ä»æ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤å®è´¨ä¸Šæ˜¯çº¿ç¨‹Aåœ¨å‘çº¿ç¨‹Bå‘é€æ¶ˆæ¯ï¼Œè€Œä¸”è¿™ä¸ªé€šä¿¡è¿‡ç¨‹å¿…é¡»è¦ç»è¿‡ä¸»å†…å­˜ã€‚JMMé€šè¿‡æ§åˆ¶ä¸»å†…å­˜ä¸æ¯ä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¹‹é—´çš„äº¤äº’ï¼Œæ¥ä¸ºJavaç¨‹åºå‘˜æä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<h3 id="213-ä»æºä»£ç åˆ°æŒ‡ä»¤åºåˆ—çš„é‡æ’åº">2.1.3 ä»æºä»£ç åˆ°æŒ‡ä»¤åºåˆ—çš„é‡æ’åº</h3>
<p>åœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚é‡æ’åºåˆ†3ç§ç±»å‹ã€‚</p>
<p>1ï¼‰ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>2ï¼‰æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-LevelParallelismï¼ŒILPï¼‰æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>3ï¼‰å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯»/å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚ä»Javaæºä»£ç åˆ°æœ€ç»ˆå®é™…æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢3ç§é‡æ’åºï¼Œ</p>
<pre><code>æºä»£ç  -&gt;  1:ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’åº -&gt; 2:æŒ‡ä»¤çº§å¹¶è¡Œé‡æ’åº -&gt; 3:å†…å­˜ç³»ç»Ÿé‡æ’åº -&gt; æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—
</code></pre>
<p>ä¸Šè¿°çš„1å±äºç¼–è¯‘å™¨é‡æ’åºï¼Œ2å’Œ3å±äºå¤„ç†å™¨é‡æ’åºã€‚è¿™äº›é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´å¤šçº¿ç¨‹ç¨‹åºå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚å¯¹äºç¼–è¯‘å™¨ï¼ŒJMMçš„ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™ä¼šç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„ç¼–è¯‘å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚å¯¹äºå¤„ç†å™¨é‡æ’åºï¼ŒJMMçš„å¤„ç†å™¨é‡æ’åºè§„åˆ™ä¼šè¦æ±‚Javaç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—æ—¶ï¼Œæ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœï¼ˆMemory Barriersï¼ŒIntelç§°ä¹‹ä¸ºMemory Fenceï¼‰æŒ‡ä»¤ï¼Œé€šè¿‡å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</p>
<p>JMMå±äºè¯­è¨€çº§çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒç¡®ä¿åœ¨ä¸åŒçš„ç¼–è¯‘å™¨å’Œä¸åŒçš„å¤„ç†å™¨å¹³å°ä¹‹ä¸Šï¼Œé€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼Œä¸ºç¨‹åºå‘˜æä¾›ä¸€è‡´çš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<h3 id="214-å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»">2.1.4 å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»</h3>
<p>ç°ä»£çš„å¤„ç†å™¨ä½¿ç”¨å†™ç¼“å†²åŒºä¸´æ—¶ä¿å­˜å‘å†…å­˜å†™å…¥çš„æ•°æ®ã€‚å†™ç¼“å†²åŒºå¯ä»¥ä¿è¯æŒ‡ä»¤æµæ°´çº¿æŒç»­è¿è¡Œï¼Œå®ƒå¯ä»¥é¿å…ç”±äºå¤„ç†å™¨åœé¡¿ä¸‹æ¥ç­‰å¾…å‘å†…å­˜å†™å…¥æ•°æ®è€Œäº§ç”Ÿçš„å»¶è¿Ÿã€‚åŒæ—¶ï¼Œé€šè¿‡ä»¥æ‰¹å¤„ç†çš„æ–¹å¼åˆ·æ–°å†™ç¼“å†²åŒºï¼Œä»¥åŠåˆå¹¶å†™ç¼“å†²åŒºä¸­å¯¹åŒä¸€å†…å­˜åœ°å€çš„å¤šæ¬¡å†™ï¼Œå‡å°‘å¯¹å†…å­˜æ€»çº¿çš„å ç”¨ã€‚è™½ç„¶å†™ç¼“å†²åŒºæœ‰è¿™ä¹ˆå¤šå¥½å¤„ï¼Œä½†æ¯ä¸ªå¤„ç†å™¨ä¸Šçš„å†™ç¼“å†²åŒºï¼Œä»…ä»…å¯¹å®ƒæ‰€åœ¨çš„å¤„ç†å™¨å¯è§ã€‚è¿™ä¸ªç‰¹æ€§ä¼šå¯¹å†…å­˜æ“ä½œçš„æ‰§è¡Œé¡ºåºäº§ç”Ÿé‡è¦çš„å½±å“ï¼šå¤„ç†å™¨å¯¹å†…å­˜çš„è¯»/å†™æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œä¸ä¸€å®šä¸å†…å­˜å®é™…å‘ç”Ÿçš„è¯»/å†™æ“ä½œé¡ºåºä¸€è‡´ï¼</p>
<h2 id="22-é‡æ’åº">2..2 é‡æ’åº</h2>
<p>é‡æ’åºæ˜¯æŒ‡ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†ä¼˜åŒ–ç¨‹åºæ€§èƒ½è€Œå¯¹æŒ‡ä»¤åºåˆ—è¿›è¡Œé‡æ–°æ’åºçš„ä¸€ç§æ‰‹æ®µã€‚</p>
<h3 id="221-æ•°æ®ä¾èµ–æ€§">2.2.1 æ•°æ®ä¾èµ–æ€§</h3>
<p>å¦‚æœä¸¤ä¸ªæ“ä½œè®¿é—®åŒä¸€ä¸ªå˜é‡ï¼Œä¸”è¿™ä¸¤ä¸ªæ“ä½œä¸­æœ‰ä¸€ä¸ªä¸ºå†™æ“ä½œï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å°±å­˜åœ¨æ•°æ®ä¾èµ–æ€§ã€‚æ•°æ®ä¾èµ–åˆ†ä¸ºä¸‹åˆ—3ç§ç±»å‹</p>
<figure data-type="image" tabindex="5"><img src="https://q456qq520.github.io/post-images/1658844674668.png" alt="æ•°æ®ä¾èµ–ç±»å‹è¡¨" loading="lazy"></figure>
<p>ä¸Šé¢3ç§æƒ…å†µï¼Œåªè¦é‡æ’åºä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœå°±ä¼šè¢«æ”¹å˜ã€‚</p>
<p>å‰é¢æåˆ°è¿‡ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹æ“ä½œåšé‡æ’åºã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨åœ¨é‡æ’åºæ—¶ï¼Œä¼šéµå®ˆæ•°æ®ä¾èµ–æ€§ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šæ”¹å˜å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„ä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>è¿™é‡Œæ‰€è¯´çš„æ•°æ®ä¾èµ–æ€§ä»…é’ˆå¯¹å•ä¸ªå¤„ç†å™¨ä¸­æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—å’Œå•ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œï¼Œä¸åŒå¤„ç†å™¨ä¹‹é—´å’Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§ä¸è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨è€ƒè™‘ã€‚</p>
<h3 id="222-as-if-serialè¯­ä¹‰">2.2.2 as-if-serialè¯­ä¹‰</h3>
<p>as-if-serialè¯­ä¹‰çš„æ„æ€æ˜¯ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼ˆç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æé«˜å¹¶è¡Œåº¦ï¼‰ï¼Œï¼ˆå•çº¿ç¨‹ï¼‰ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ã€‚ç¼–è¯‘å™¨ã€runtimeå’Œå¤„ç†å™¨éƒ½å¿…é¡»éµå®ˆas-if-serialè¯­ä¹‰ã€‚</p>
<p>ä¸ºäº†éµå®ˆas-if-serialè¯­ä¹‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼Œå› ä¸ºè¿™ç§é‡æ’åºä¼šæ”¹å˜æ‰§è¡Œç»“æœã€‚ä½†æ˜¯ï¼Œå¦‚æœæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œè¿™äº›æ“ä½œå°±å¯èƒ½è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºã€‚</p>
<p>ä¸ºäº†å…·ä½“è¯´æ˜ï¼Œè¯·çœ‹ä¸‹é¢è®¡ç®—åœ†é¢ç§¯çš„ä»£ç ç¤ºä¾‹ã€‚</p>
<pre><code class="language-java">double pi = 3.14; // A
double r = 1.0; // B
double area = pi * r * r; // C
</code></pre>
<p>Aå’ŒCä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶Bå’ŒCä¹‹é—´ä¹Ÿå­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ã€‚å› æ­¤åœ¨æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ä¸­ï¼ŒCä¸èƒ½è¢«é‡æ’åºåˆ°Aå’ŒBçš„å‰é¢ï¼ˆCæ’åˆ°Aå’ŒBçš„å‰é¢ï¼Œç¨‹åºçš„ç»“æœå°†ä¼šè¢«æ”¹å˜ï¼‰ã€‚ä½†Aå’ŒBä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯ä»¥é‡æ’åºAå’ŒBä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>as-if-serialè¯­ä¹‰æŠŠå•çº¿ç¨‹ç¨‹åºä¿æŠ¤äº†èµ·æ¥ï¼Œéµå®ˆas-if-serialè¯­ä¹‰çš„ç¼–è¯‘å™¨ã€runtimeå’Œå¤„ç†å™¨å…±åŒä¸ºç¼–å†™å•çº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜åˆ›å»ºäº†ä¸€ä¸ªå¹»è§‰ï¼šå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚asif-serialè¯­ä¹‰ä½¿å•ç¨‹ç¨‹åºå‘˜æ— éœ€æ‹…å¿ƒé‡æ’åºä¼šå¹²æ‰°ä»–ä»¬ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒå†…å­˜å¯è§æ€§é—®é¢˜ã€‚</p>
<h3 id="223-ç¨‹åºé¡ºåºè§„åˆ™">2.2.3 ç¨‹åºé¡ºåºè§„åˆ™</h3>
<p>æ ¹æ®happens-beforeçš„ç¨‹åºé¡ºåºè§„åˆ™ï¼Œä¸Šé¢è®¡ç®—åœ†çš„é¢ç§¯çš„ç¤ºä¾‹ä»£ç å­˜åœ¨3ä¸ªhappensbeforeå…³ç³»ã€‚</p>
<p>1ï¼‰A happens-before Bã€‚<br>
2ï¼‰B happens-before Cã€‚<br>
3ï¼‰A happens-before Cã€‚</p>
<p>è¿™é‡Œçš„ç¬¬3ä¸ªhappens-beforeå…³ç³»ï¼Œæ˜¯æ ¹æ®happens-beforeçš„ä¼ é€’æ€§æ¨å¯¼å‡ºæ¥çš„ã€‚</p>
<p>è¿™é‡ŒA happens-before Bï¼Œä½†å®é™…æ‰§è¡Œæ—¶Bå´å¯ä»¥æ’åœ¨Aä¹‹å‰æ‰§è¡Œï¼ˆçœ‹ä¸Šé¢çš„é‡æ’åºåçš„æ‰§è¡Œé¡ºåºï¼‰ã€‚å¦‚æœA happens-before Bï¼ŒJMMå¹¶ä¸è¦æ±‚Aä¸€å®šè¦åœ¨Bä¹‹å‰æ‰§è¡Œã€‚JMMä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œï¼ˆæ‰§è¡Œçš„ç»“æœï¼‰å¯¹åä¸€ä¸ªæ“ä½œå¯è§ï¼Œä¸”å‰ä¸€ä¸ªæ“ä½œæŒ‰é¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚è¿™é‡Œæ“ä½œAçš„æ‰§è¡Œç»“æœä¸éœ€è¦å¯¹æ“ä½œBå¯è§ï¼›è€Œä¸”é‡æ’åºæ“ä½œAå’Œæ“ä½œBåçš„æ‰§è¡Œç»“æœï¼Œä¸æ“ä½œAå’Œæ“ä½œBæŒ‰happens-beforeé¡ºåºæ‰§è¡Œçš„ç»“æœä¸€è‡´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJMMä¼šè®¤ä¸ºè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ï¼ˆnotillegalï¼‰ï¼ŒJMMå…è®¸è¿™ç§é‡æ’åºã€‚</p>
<p><strong>åœ¨ä¸æ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå°½å¯èƒ½æé«˜å¹¶è¡Œåº¦ã€‚</strong></p>
<h3 id="224-é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“">2.2.4 é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“</h3>
<p>é‡æ’åºæ˜¯å¦ä¼šæ”¹å˜å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ã€‚</p>
<pre><code class="language-java">class ReorderExample {
    int a = 0;
    boolean flag = false;

    public void writer() {
        a = 1; // 1
        flag = true; // 2
    }

    public void reader() {
        if (flag) { // 3
            int i = a * a; // 4
            â€¦â€¦
        }
    }
}
</code></pre>
<p>flagå˜é‡æ˜¯ä¸ªæ ‡è®°ï¼Œç”¨æ¥æ ‡è¯†å˜é‡aæ˜¯å¦å·²è¢«å†™å…¥ã€‚è¿™é‡Œå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBï¼ŒAé¦–å…ˆæ‰§è¡Œwriter()æ–¹æ³•ï¼ŒéšåBçº¿ç¨‹æ¥ç€æ‰§è¡Œreader()æ–¹æ³•ã€‚çº¿ç¨‹Båœ¨æ‰§è¡Œæ“ä½œ4æ—¶ï¼Œèƒ½å¦çœ‹åˆ°çº¿ç¨‹Aåœ¨æ“ä½œ1å¯¹å…±äº«å˜é‡açš„å†™å…¥å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼š<strong>ä¸ä¸€å®šèƒ½çœ‹åˆ°</strong>ã€‚</p>
<p>ç”±äºæ“ä½œ1å’Œæ“ä½œ2æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œé‡æ’åºï¼›åŒæ ·ï¼Œæ“ä½œ3å’Œæ“ä½œ4æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¹Ÿå¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œé‡æ’åºã€‚</p>
<p>æ“ä½œ1å’Œæ“ä½œ2åšäº†é‡æ’åºã€‚ç¨‹åºæ‰§è¡Œæ—¶ï¼Œçº¿ç¨‹Aé¦–å…ˆå†™æ ‡è®°å˜é‡flagï¼Œéšåçº¿ç¨‹Bè¯»è¿™ä¸ªå˜é‡ã€‚ç”±äºæ¡ä»¶åˆ¤æ–­ä¸ºçœŸï¼Œçº¿ç¨‹Bå°†è¯»å–å˜é‡aã€‚æ­¤æ—¶ï¼Œå˜é‡aè¿˜æ²¡æœ‰è¢«çº¿ç¨‹Aå†™å…¥ï¼Œåœ¨è¿™é‡Œå¤šçº¿ç¨‹ç¨‹åºçš„è¯­ä¹‰è¢«é‡æ’åºç ´åäº†ï¼</p>
<p>åœ¨ç¨‹åºä¸­ï¼Œæ“ä½œ3å’Œæ“ä½œ4å­˜åœ¨æ§åˆ¶ä¾èµ–å…³ç³»ã€‚å½“ä»£ç ä¸­å­˜åœ¨æ§åˆ¶ä¾èµ–æ€§æ—¶ï¼Œä¼šå½±å“æŒ‡ä»¤åºåˆ—æ‰§è¡Œçš„å¹¶è¡Œåº¦ã€‚ä¸ºæ­¤ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šé‡‡ç”¨<strong>çŒœæµ‹ï¼ˆSpeculationï¼‰æ‰§è¡Œ</strong>æ¥å…‹æœæ§åˆ¶ç›¸å…³æ€§å¯¹å¹¶è¡Œåº¦çš„å½±å“ã€‚ä»¥å¤„ç†å™¨çš„çŒœæµ‹æ‰§è¡Œä¸ºä¾‹ï¼Œæ‰§è¡Œçº¿ç¨‹Bçš„å¤„ç†å™¨å¯ä»¥æå‰è¯»å–å¹¶è®¡ç®—a*aï¼Œç„¶åæŠŠè®¡ç®—ç»“æœä¸´æ—¶ä¿å­˜åˆ°ä¸€ä¸ªåä¸ºé‡æ’åºç¼“å†²ï¼ˆReorder Bufferï¼ŒROBï¼‰çš„ç¡¬ä»¶ç¼“å­˜ä¸­ã€‚å½“æ“ä½œ3çš„æ¡ä»¶åˆ¤æ–­ä¸ºçœŸæ—¶ï¼Œå°±æŠŠè¯¥è®¡ç®—ç»“æœå†™å…¥å˜é‡iä¸­ã€‚</p>
<p>åœ¨å•çº¿ç¨‹ç¨‹åºä¸­ï¼Œå¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œé‡æ’åºï¼Œä¸ä¼šæ”¹å˜æ‰§è¡Œç»“æœï¼ˆè¿™ä¹Ÿæ˜¯as-if-serialè¯­ä¹‰å…è®¸å¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œåšé‡æ’åºçš„åŸå› ï¼‰ï¼›ä½†åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œå¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œé‡æ’åºï¼Œå¯èƒ½ä¼šæ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚</p>
<h2 id="23-é¡ºåºä¸€è‡´æ€§">2.3 é¡ºåºä¸€è‡´æ€§</h2>
<p>é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªç†è®ºå‚è€ƒæ¨¡å‹ï¼Œåœ¨è®¾è®¡çš„æ—¶å€™ï¼Œå¤„ç†å™¨çš„å†…å­˜æ¨¡å‹å’Œç¼–ç¨‹è¯­è¨€çš„å†…å­˜æ¨¡å‹éƒ½ä¼šä»¥é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä½œä¸ºå‚ç…§ã€‚</p>
<h3 id="231-æ•°æ®ç«äº‰ä¸é¡ºåºä¸€è‡´æ€§">2.3.1 æ•°æ®ç«äº‰ä¸é¡ºåºä¸€è‡´æ€§</h3>
<p>å½“ç¨‹åºæœªæ­£ç¡®åŒæ­¥æ—¶ï¼Œå°±å¯èƒ½ä¼šå­˜åœ¨æ•°æ®ç«äº‰ã€‚Javaå†…å­˜æ¨¡å‹è§„èŒƒå¯¹æ•°æ®ç«äº‰çš„å®šä¹‰å¦‚<br>
ä¸‹ã€‚</p>
<pre><code>åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å†™ä¸€ä¸ªå˜é‡ï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¯»åŒä¸€ä¸ªå˜é‡ï¼Œè€Œä¸”å†™å’Œè¯»æ²¡æœ‰é€šè¿‡åŒæ­¥æ¥æ’åºã€‚
</code></pre>
<p>å½“ä»£ç ä¸­åŒ…å«æ•°æ®ç«äº‰æ—¶ï¼Œç¨‹åºçš„æ‰§è¡Œå¾€å¾€äº§ç”Ÿè¿åç›´è§‰çš„ç»“æœã€‚å¦‚æœä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºèƒ½æ­£ç¡®åŒæ­¥ï¼Œè¿™ä¸ªç¨‹åºå°†æ˜¯ä¸€ä¸ªæ²¡æœ‰æ•°æ®ç«äº‰çš„ç¨‹åºã€‚JMMå¯¹æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„å†…å­˜ä¸€è‡´æ€§åšäº†å¦‚ä¸‹ä¿è¯ã€‚</p>
<p>å¦‚æœç¨‹åºæ˜¯æ­£ç¡®åŒæ­¥çš„ï¼Œç¨‹åºçš„æ‰§è¡Œå°†å…·æœ‰<strong>é¡ºåºä¸€è‡´æ€§ï¼ˆSequentially Consistentï¼‰</strong>â€”â€”å³ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒã€‚è¿™é‡Œçš„åŒæ­¥æ˜¯æŒ‡å¹¿ä¹‰ä¸Šçš„åŒæ­¥ï¼ŒåŒ…æ‹¬å¯¹å¸¸ç”¨åŒæ­¥åŸè¯­ï¼ˆsynchronizedã€volatileå’Œfinalï¼‰çš„æ­£ç¡®ä½¿ç”¨</p>
<h3 id="232-é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹">2.3.2 é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹</h3>
<p>é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªè¢«è®¡ç®—æœºç§‘å­¦å®¶ç†æƒ³åŒ–äº†çš„ç†è®ºå‚è€ƒæ¨¡å‹ï¼Œå®ƒä¸ºç¨‹åºå‘˜æä¾›äº†æå¼ºçš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æœ‰ä¸¤å¤§ç‰¹æ€§ã€‚</p>
<ul>
<li>1)ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œå¿…é¡»æŒ‰ç…§ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œã€‚</li>
<li>2)ï¼ˆä¸ç®¡ç¨‹åºæ˜¯å¦åŒæ­¥ï¼‰æ‰€æœ‰çº¿ç¨‹éƒ½åªèƒ½çœ‹åˆ°ä¸€ä¸ªå•ä¸€çš„æ“ä½œæ‰§è¡Œé¡ºåºã€‚åœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªæ“ä½œéƒ½å¿…é¡»åŸå­æ‰§è¡Œä¸”ç«‹åˆ»å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§ã€‚</li>
</ul>
<p>åœ¨æ¦‚å¿µä¸Šï¼Œé¡ºåºä¸€è‡´æ€§æ¨¡å‹æœ‰ä¸€ä¸ªå•ä¸€çš„å…¨å±€å†…å­˜ï¼Œè¿™ä¸ªå†…å­˜é€šè¿‡ä¸€ä¸ªå·¦å³æ‘†åŠ¨çš„å¼€å…³å¯ä»¥è¿æ¥åˆ°ä»»æ„ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶æ¯ä¸€ä¸ªçº¿ç¨‹å¿…é¡»æŒ‰ç…§ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œå†…å­˜è¯»/å†™æ“ä½œã€‚åœ¨ä»»æ„æ—¶é—´ç‚¹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿æ¥åˆ°å†…å­˜ã€‚å½“å¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œæ—¶ï¼Œå›¾ä¸­çš„å¼€å…³è£…ç½®èƒ½æŠŠæ‰€æœ‰çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜è¯»/å†™æ“ä½œä¸²è¡ŒåŒ–ï¼ˆå³åœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­ï¼Œæ‰€æœ‰æ“ä½œä¹‹é—´å…·æœ‰å…¨åºå…³ç³»ï¼‰ã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://q456qq520.github.io/post-images/1658990481932.png" alt="é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹çš„è§†å›¾" loading="lazy"></figure>
<p>ä¸ºäº†æ›´å¥½è¿›è¡Œç†è§£ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBå¹¶å‘æ‰§è¡Œã€‚å…¶ä¸­Açº¿ç¨‹æœ‰3ä¸ªæ“ä½œï¼Œå®ƒä»¬åœ¨ç¨‹åºä¸­çš„é¡ºåºæ˜¯ï¼š<br>
A1â†’A2â†’A3ã€‚Bçº¿ç¨‹ä¹Ÿæœ‰3ä¸ªæ“ä½œï¼Œå®ƒä»¬åœ¨ç¨‹åºä¸­çš„é¡ºåºæ˜¯ï¼šB1â†’B2â†’B3ã€‚</p>
<p>å‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨ç›‘è§†å™¨é”æ¥æ­£ç¡®åŒæ­¥ï¼šAçº¿ç¨‹çš„3ä¸ªæ“ä½œæ‰§è¡Œåé‡Šæ”¾ç›‘è§†å™¨é”ï¼ŒéšåB<br>
çº¿ç¨‹è·å–åŒä¸€ä¸ªç›‘è§†å™¨é”ã€‚é‚£ä¹ˆç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œæ•ˆæœå°†ä¼šæ˜¯ï¼š</p>
<pre><code>A1â†’A2â†’A3â†’B1â†’B2â†’B3
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å†å‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹æ²¡æœ‰åšåŒæ­¥ï¼Œé‚£è¿™ä¸ªæœªåŒæ­¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç¤ºæ„å›¾å¯èƒ½æ˜¯ï¼š</p>
<pre><code>B1â†’A1â†’A2â†’B2â†’A3â†’B3
</code></pre>
<p>æœªåŒæ­¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­è™½ç„¶æ•´ä½“æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ï¼Œä½†æ‰€æœ‰çº¿ç¨‹éƒ½åªèƒ½çœ‹åˆ°ä¸€ä¸ªä¸€è‡´çš„æ•´ä½“æ‰§è¡Œé¡ºåºã€‚çº¿ç¨‹Aå’ŒBçœ‹åˆ°çš„æ‰§è¡Œé¡ºåºå¯èƒ½éƒ½æ˜¯ï¼šB1â†’A1â†’A2â†’B2â†’A3â†’B3ã€‚ä¹‹æ‰€ä»¥èƒ½å¾—åˆ°è¿™ä¸ªä¿è¯æ˜¯å› ä¸ºé¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ¯ä¸ªæ“ä½œå¿…é¡»ç«‹å³å¯¹ä»»æ„çº¿ç¨‹å¯è§ã€‚</p>
<p>ä½†æ˜¯ï¼Œåœ¨JMMä¸­å°±æ²¡æœ‰è¿™ä¸ªä¿è¯ã€‚æœªåŒæ­¥ç¨‹åºåœ¨JMMä¸­ä¸ä½†æ•´ä½“çš„æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ï¼Œè€Œä¸”æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ“ä½œæ‰§è¡Œé¡ºåºä¹Ÿå¯èƒ½ä¸ä¸€è‡´ã€‚æ¯”å¦‚ï¼Œåœ¨å½“å‰çº¿ç¨‹æŠŠå†™è¿‡çš„æ•°æ®ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œåœ¨æ²¡æœ‰åˆ·æ–°åˆ°ä¸»å†…å­˜ä¹‹å‰ï¼Œè¿™ä¸ªå†™æ“ä½œä»…å¯¹å½“å‰çº¿ç¨‹å¯è§ï¼›ä»å…¶ä»–çº¿ç¨‹çš„è§’åº¦æ¥è§‚å¯Ÿï¼Œä¼šè®¤ä¸ºè¿™ä¸ªå†™æ“ä½œæ ¹æœ¬æ²¡æœ‰è¢«å½“å‰çº¿ç¨‹æ‰§è¡Œã€‚åªæœ‰å½“å‰çº¿ç¨‹æŠŠæœ¬åœ°å†…å­˜ä¸­å†™è¿‡çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¹‹åï¼Œè¿™ä¸ªå†™æ“ä½œæ‰èƒ½å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å‰çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹çœ‹åˆ°çš„æ“ä½œæ‰§è¡Œé¡ºåºå°†ä¸ä¸€è‡´ã€‚</p>
<h3 id="233-åŒæ­¥ç¨‹åºçš„é¡ºåºä¸€è‡´æ€§æ•ˆæœ">2.3.3 åŒæ­¥ç¨‹åºçš„é¡ºåºä¸€è‡´æ€§æ•ˆæœ</h3>
<p>ä¸‹é¢ï¼Œå¯¹å‰é¢çš„ç¤ºä¾‹ç¨‹åºReorderExampleç”¨é”æ¥åŒæ­¥ï¼Œçœ‹çœ‹æ­£ç¡®åŒæ­¥çš„ç¨‹åºå¦‚ä½•å…·æœ‰é¡ºåº<br>
ä¸€è‡´æ€§ã€‚</p>
<p>è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ã€‚</p>
<pre><code class="language-java">class ReorderExample {
    int a = 0;
    boolean flag = false;

    public synchronized void writer() {  // è·å–é”
        a = 1; // 1
        flag = true; // 2
    }                                               // é‡Šæ”¾é”

    public synchronized void reader() { // è·å–é”
        if (flag) { // 3
            int i = a * a; // 4
            â€¦â€¦
        }
    }                                                // é‡Šæ”¾é”
}
</code></pre>
<p>åœ¨ä¸Šé¢ç¤ºä¾‹ä»£ç ä¸­ï¼Œå‡è®¾Açº¿ç¨‹æ‰§è¡Œwriter()æ–¹æ³•åï¼ŒBçº¿ç¨‹æ‰§è¡Œreader()æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºã€‚æ ¹æ®JMMè§„èŒƒï¼Œè¯¥ç¨‹åºçš„æ‰§è¡Œç»“æœå°†ä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒã€‚</p>
<p>é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­ï¼Œæ‰€æœ‰æ“ä½œå®Œå…¨æŒ‰ç¨‹åºçš„é¡ºåºä¸²è¡Œæ‰§è¡Œã€‚è€Œåœ¨JMMä¸­ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯ä»¥é‡æ’åºï¼ˆä½†JMMä¸å…è®¸ä¸´ç•ŒåŒºå†…çš„ä»£ç â€œé€¸å‡ºâ€åˆ°ä¸´ç•ŒåŒºä¹‹å¤–ï¼Œé‚£æ ·ä¼šç ´åç›‘è§†å™¨çš„è¯­ä¹‰ï¼‰ã€‚JMMä¼šåœ¨é€€å‡ºä¸´ç•ŒåŒºå’Œè¿›å…¥ä¸´ç•ŒåŒºè¿™ä¸¤ä¸ªå…³é”®æ—¶é—´ç‚¹åšä¸€äº›ç‰¹åˆ«å¤„ç†ï¼Œä½¿å¾—çº¿ç¨‹åœ¨è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹å…·æœ‰ä¸é¡ºåºä¸€è‡´æ€§æ¨¡å‹ç›¸åŒçš„å†…å­˜è§†å›¾ã€‚è™½ç„¶çº¿ç¨‹Aåœ¨ä¸´ç•ŒåŒºå†…åšäº†é‡æ’åºï¼Œä½†ç”±äºç›‘è§†å™¨äº’æ–¥æ‰§è¡Œçš„ç‰¹æ€§ï¼Œè¿™é‡Œçš„çº¿ç¨‹Bæ ¹æœ¬æ— æ³•â€œè§‚å¯Ÿâ€åˆ°çº¿ç¨‹Aåœ¨ä¸´<br>
ç•ŒåŒºå†…çš„é‡æ’åºã€‚è¿™ç§é‡æ’åºæ—¢æé«˜äº†æ‰§è¡Œæ•ˆç‡ï¼Œåˆæ²¡æœ‰æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://q456qq520.github.io/post-images/1658991491289.png" alt="ä¸¤ä¸ªå†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œæ—¶åºå¯¹æ¯”å›¾" loading="lazy"></figure>
<p>JMMåœ¨å…·ä½“å®ç°ä¸Šçš„åŸºæœ¬æ–¹é’ˆä¸ºï¼š<strong>åœ¨ä¸æ”¹å˜ï¼ˆæ­£ç¡®åŒæ­¥çš„ï¼‰ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå°½å¯èƒ½åœ°ä¸ºç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„ä¼˜åŒ–æ‰“å¼€æ–¹ä¾¿ä¹‹é—¨ã€‚</strong></p>
<h3 id="234-æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç‰¹æ€§">2.3.4 æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç‰¹æ€§</h3>
<p>å¯¹äºæœªåŒæ­¥æˆ–æœªæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºï¼ŒJMMåªæä¾›æœ€å°å®‰å…¨æ€§ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶è¯»å–åˆ°çš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¹‹å‰æŸä¸ªçº¿ç¨‹å†™å…¥çš„å€¼ï¼Œè¦ä¹ˆæ˜¯é»˜è®¤å€¼ï¼ˆ0ï¼ŒNullï¼ŒFalseï¼‰ï¼ŒJMMä¿è¯çº¿ç¨‹è¯»æ“ä½œè¯»å–åˆ°çš„å€¼ä¸ä¼šæ— ä¸­ç”Ÿæœ‰ï¼ˆOut Of Thin Airï¼‰çš„å†’å‡ºæ¥ã€‚ä¸ºäº†å®ç°æœ€å°å®‰å…¨æ€§ï¼ŒJVMåœ¨å †ä¸Šåˆ†é…å¯¹è±¡æ—¶ï¼Œé¦–å…ˆä¼šå¯¹å†…å­˜ç©ºé—´è¿›è¡Œæ¸…é›¶ï¼Œç„¶åæ‰ä¼šåœ¨ä¸Šé¢åˆ†é…å¯¹è±¡ï¼ˆJVMå†…éƒ¨ä¼šåŒæ­¥è¿™ä¸¤ä¸ªæ“ä½œï¼‰ã€‚å› æ­¤ï¼Œåœ¨å·²æ¸…é›¶çš„å†…å­˜ç©ºé—´ï¼ˆPre-zeroed Memoryï¼‰åˆ†é…å¯¹è±¡æ—¶ï¼ŒåŸŸçš„é»˜è®¤åˆå§‹åŒ–å·²ç»å®Œæˆäº†ã€‚</p>
<p>JMMä¸ä¿è¯æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœä¸€è‡´ã€‚å› ä¸ºå¦‚æœæƒ³è¦ä¿è¯æ‰§è¡Œç»“æœä¸€è‡´ï¼ŒJMMéœ€è¦ç¦æ­¢å¤§é‡çš„å¤„ç†å™¨å’Œç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œè¿™å¯¹ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ä¼šäº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚è€Œä¸”æœªåŒæ­¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­æ‰§è¡Œæ—¶ï¼Œæ•´ä½“æ˜¯æ— åºçš„ï¼Œå…¶æ‰§è¡Œç»“æœå¾€å¾€æ— æ³•é¢„çŸ¥ã€‚è€Œä¸”ï¼Œä¿è¯æœªåŒæ­¥ç¨‹åºåœ¨è¿™ä¸¤ä¸ªæ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœä¸€è‡´æ²¡ä»€ä¹ˆæ„ä¹‰ã€‚</p>
<p>æœªåŒæ­¥ç¨‹åºåœ¨JMMä¸­çš„æ‰§è¡Œæ—¶ï¼Œæ•´ä½“ä¸Šæ˜¯æ— åºçš„ï¼Œå…¶æ‰§è¡Œç»“æœæ— æ³•é¢„çŸ¥ã€‚æœªåŒæ­¥ç¨‹åºåœ¨ä¸¤ä¸ªæ¨¡å‹ä¸­çš„æ‰§è¡Œç‰¹æ€§æœ‰å¦‚ä¸‹å‡ ä¸ªå·®å¼‚ã€‚</p>
<pre><code>1ï¼‰é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¿è¯å•çº¿ç¨‹å†…çš„æ“ä½œä¼šæŒ‰ç¨‹åºçš„é¡ºåºæ‰§è¡Œï¼Œè€ŒJMMä¸ä¿è¯å•çº¿ç¨‹å†…çš„æ“ä½œä¼šæŒ‰ç¨‹åºçš„é¡ºåºæ‰§è¡Œï¼ˆæ¯”å¦‚ä¸Šé¢æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºåœ¨ä¸´ç•ŒåŒºå†…çš„é‡æ’åºï¼‰ã€‚

2ï¼‰é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¿è¯æ‰€æœ‰çº¿ç¨‹åªèƒ½çœ‹åˆ°ä¸€è‡´çš„æ“ä½œæ‰§è¡Œé¡ºåºï¼Œè€ŒJMMä¸ä¿è¯æ‰€æœ‰çº¿ç¨‹èƒ½çœ‹åˆ°ä¸€è‡´çš„æ“ä½œæ‰§è¡Œé¡ºåºã€‚

3ï¼‰JMMä¸ä¿è¯å¯¹64ä½çš„longå‹å’Œdoubleå‹å˜é‡çš„å†™æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œè€Œé¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¿è¯å¯¹æ‰€æœ‰çš„å†…å­˜è¯»/å†™æ“ä½œéƒ½å…·æœ‰åŸå­æ€§ã€‚
</code></pre>
<p>ç¬¬3ä¸ªå·®å¼‚ä¸å¤„ç†å™¨æ€»çº¿çš„å·¥ä½œæœºåˆ¶å¯†åˆ‡ç›¸å…³ã€‚åœ¨è®¡ç®—æœºä¸­ï¼Œæ•°æ®é€šè¿‡æ€»çº¿åœ¨å¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´ä¼ é€’ã€‚æ¯æ¬¡å¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´çš„æ•°æ®ä¼ é€’éƒ½æ˜¯é€šè¿‡ä¸€ç³»åˆ—æ­¥éª¤æ¥å®Œæˆçš„ï¼Œè¿™ä¸€ç³»åˆ—æ­¥éª¤ç§°ä¹‹ä¸º<strong>æ€»çº¿äº‹åŠ¡ï¼ˆBus Transactionï¼‰</strong>ã€‚æ€»çº¿äº‹åŠ¡åŒ…æ‹¬è¯»äº‹åŠ¡ï¼ˆRead Transactionï¼‰å’Œå†™äº‹åŠ¡ï¼ˆWrite Transactionï¼‰ã€‚è¯»äº‹åŠ¡ä»å†…å­˜ä¼ é€æ•°æ®åˆ°å¤„ç†å™¨ï¼Œå†™äº‹åŠ¡ä»å¤„ç†å™¨ä¼ é€æ•°æ®åˆ°å†…å­˜ï¼Œæ¯ä¸ªäº‹åŠ¡ä¼šè¯»/å†™å†…å­˜ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªç‰©ç†ä¸Šè¿ç»­çš„å­—ã€‚åœ¨ä¸€ä¸ªå¤„ç†å™¨æ‰§è¡Œæ€»çº¿äº‹åŠ¡æœŸé—´ï¼Œæ€»çº¿ä¼šç¦æ­¢å…¶ä»–çš„å¤„ç†å™¨å’ŒI/Oè®¾å¤‡æ‰§è¡Œå†…å­˜çš„è¯»/å†™ã€‚</p>
<p>åœ¨ä¸€äº›32ä½çš„å¤„ç†å™¨ä¸Šï¼Œå¦‚æœè¦æ±‚å¯¹64ä½æ•°æ®çš„å†™æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œä¼šæœ‰æ¯”è¾ƒå¤§çš„å¼€é”€ã€‚ä¸ºäº†ç…§é¡¾è¿™ç§å¤„ç†å™¨ï¼ŒJavaè¯­è¨€è§„èŒƒé¼“åŠ±ä½†ä¸å¼ºæ±‚JVMå¯¹64ä½çš„longå‹å˜é‡å’Œdoubleå‹å˜é‡çš„å†™æ“ä½œå…·æœ‰åŸå­æ€§ã€‚å½“JVMåœ¨è¿™ç§å¤„ç†å™¨ä¸Šè¿è¡Œæ—¶ï¼Œå¯èƒ½ä¼šæŠŠä¸€ä¸ª64ä½long/doubleå‹å˜é‡çš„å†™æ“ä½œæ‹†åˆ†ä¸ºä¸¤ä¸ª32ä½çš„å†™æ“ä½œæ¥æ‰§è¡Œã€‚è¿™ä¸¤ä¸ª32ä½çš„å†™æ“ä½œå¯èƒ½ä¼šè¢«åˆ†é…åˆ°ä¸åŒçš„æ€»çº¿äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œæ­¤æ—¶å¯¹è¿™ä¸ª64ä½å˜é‡çš„å†™æ“ä½œå°†ä¸å…·æœ‰åŸå­æ€§ã€‚</p>
<h2 id="24-volatileçš„å†…å­˜è¯­ä¹‰">2.4 volatileçš„å†…å­˜è¯­ä¹‰</h2>
<p>å½“å£°æ˜å…±äº«å˜é‡ä¸ºvolatileåï¼Œå¯¹è¿™ä¸ªå˜é‡çš„è¯»/å†™å°†ä¼šå¾ˆç‰¹åˆ«ã€‚</p>
<h3 id="241-volatileçš„ç‰¹æ€§">2.4.1 volatileçš„ç‰¹æ€§</h3>
<p>ç†è§£volatileç‰¹æ€§çš„ä¸€ä¸ªå¥½æ–¹æ³•æ˜¯æŠŠå¯¹volatileå˜é‡çš„å•ä¸ªè¯»/å†™ï¼Œçœ‹æˆæ˜¯ä½¿ç”¨åŒä¸€ä¸ªé”å¯¹è¿™äº›å•ä¸ªè¯»/å†™æ“ä½œåšäº†åŒæ­¥ã€‚</p>
<pre><code class="language-java">   class VolatileFeaturesExample {
        volatile long vl = 0L; // ä½¿ç”¨volatileå£°æ˜64ä½çš„longå‹å˜é‡
        
        public void set(long l) {
            vl = l; // å•ä¸ªvolatileå˜é‡çš„å†™
        }
        
        public void getAndIncrement () {
            vl++; // å¤åˆï¼ˆå¤šä¸ªï¼‰volatileå˜é‡çš„è¯»/å†™
        }
        
        public long get() {
            return vl; // å•ä¸ªvolatileå˜é‡çš„è¯»
        }
    }
</code></pre>
<p>é”çš„happens-beforeè§„åˆ™ä¿è¯é‡Šæ”¾é”å’Œè·å–é”çš„ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ï¼Œè¿™æ„å‘³ç€å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ã€‚é”çš„è¯­ä¹‰å†³å®šäº†ä¸´ç•ŒåŒºä»£ç çš„æ‰§è¡Œå…·æœ‰åŸå­æ€§ã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿æ˜¯64ä½çš„longå‹å’Œdoubleå‹å˜é‡ï¼Œåªè¦å®ƒæ˜¯volatileå˜é‡ï¼Œå¯¹è¯¥å˜é‡çš„è¯»/å†™å°±å…·æœ‰åŸå­æ€§ã€‚å¦‚æœæ˜¯å¤šä¸ªvolatileæ“ä½œæˆ–ç±»ä¼¼äºvolatile++è¿™ç§å¤åˆæ“ä½œï¼Œè¿™äº›æ“ä½œæ•´ä½“ä¸Šä¸å…·æœ‰åŸå­æ€§ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œvolatileå˜é‡è‡ªèº«å…·æœ‰ä¸‹åˆ—ç‰¹æ€§ã€‚</p>
<ul>
<li>
<p><strong>å¯è§æ€§</strong>ã€‚å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ã€‚</p>
</li>
<li>
<p><strong>åŸå­æ€§</strong>ï¼šå¯¹ä»»æ„å•ä¸ªvolatileå˜é‡çš„è¯»/å†™å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äºvolatile++è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ã€‚</p>
</li>
</ul>
<h3 id="242-volatileå†™-è¯»å»ºç«‹çš„happens-beforeå…³ç³»">2.4.2 volatileå†™-è¯»å»ºç«‹çš„happens-beforeå…³ç³»</h3>
<p>volatileå¯¹çº¿ç¨‹çš„å†…å­˜å¯è§æ€§çš„å½±å“æ¯”volatileè‡ªèº«çš„ç‰¹æ€§æ›´ä¸ºé‡è¦</p>
<p>ä»JSR-133å¼€å§‹ï¼ˆå³ä»JDK5å¼€å§‹ï¼‰ï¼Œvolatileå˜é‡çš„å†™-è¯»å¯ä»¥å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p>ä»å†…å­˜è¯­ä¹‰çš„è§’åº¦æ¥è¯´ï¼Œvolatileçš„å†™-è¯»ä¸é”çš„é‡Šæ”¾-è·å–æœ‰ç›¸åŒçš„å†…å­˜æ•ˆæœï¼švolatileå†™å’Œé”çš„é‡Šæ”¾æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ï¼›volatileè¯»ä¸é”çš„è·å–æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚</p>
<pre><code class="language-java">   class VolatileExample {
        int a = 0;
        volatile boolean flag = false;
        public void writer() {
            a = 1; // 1
            flag = true; // 2
        }
        public void reader() {
            if (flag) { // 3
                int i = a; // 4
                â€¦â€¦
            }
        }
    }
</code></pre>
<p>å‡è®¾çº¿ç¨‹Aæ‰§è¡Œwriter()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹Bæ‰§è¡Œreader()æ–¹æ³•ã€‚æ ¹æ®happens-beforeè§„åˆ™ï¼Œè¿™ä¸ªè¿‡ç¨‹å»ºç«‹çš„happens-beforeå…³ç³»å¯ä»¥åˆ†ä¸º3ç±»ï¼š</p>
<pre><code>1ï¼‰æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼Œ1 happens-before 2;3 happens-before 4ã€‚
2ï¼‰æ ¹æ®volatileè§„åˆ™ï¼Œ2 happens-before 3ã€‚
3ï¼‰æ ¹æ®happens-beforeçš„ä¼ é€’æ€§è§„åˆ™ï¼Œ1 happens-before 4ã€‚
</code></pre>
<p>è¿™é‡ŒAçº¿ç¨‹å†™ä¸€ä¸ªvolatileå˜é‡åï¼ŒBçº¿ç¨‹è¯»åŒä¸€ä¸ªvolatileå˜é‡ã€‚Açº¿ç¨‹åœ¨å†™volatileå˜é‡ä¹‹å‰æ‰€æœ‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨Bçº¿ç¨‹è¯»åŒä¸€ä¸ªvolatileå˜é‡åï¼Œå°†ç«‹å³å˜å¾—å¯¹Bçº¿ç¨‹å¯è§ã€‚</p>
<h3 id="243-volatileå†™-è¯»çš„å†…å­˜è¯­ä¹‰">2.4.3 volatileå†™-è¯»çš„å†…å­˜è¯­ä¹‰</h3>
<p><strong>å½“å†™ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚</strong></p>
<p>ä»¥ä¸Šé¢ç¤ºä¾‹ç¨‹åºVolatileExampleä¸ºä¾‹ï¼Œå‡è®¾çº¿ç¨‹Aé¦–å…ˆæ‰§è¡Œwriter()æ–¹æ³•ï¼Œéšåçº¿ç¨‹Bæ‰§è¡Œreader()æ–¹æ³•ï¼Œåˆå§‹æ—¶ä¸¤ä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¸­çš„flagå’Œaéƒ½æ˜¯åˆå§‹çŠ¶æ€ã€‚çº¿ç¨‹Aåœ¨å†™flagå˜é‡åï¼Œæœ¬åœ°å†…å­˜Aä¸­è¢«çº¿ç¨‹Aæ›´æ–°è¿‡çš„ä¸¤ä¸ªå…±äº«å˜é‡çš„å€¼è¢«åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚æ­¤æ—¶ï¼Œæœ¬åœ°å†…å­˜Aå’Œä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p>
<p><strong>å½“è¯»ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ç½®ä¸ºæ— æ•ˆã€‚çº¿ç¨‹æ¥ä¸‹æ¥å°†ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚</strong></p>
<p>åœ¨è¯»flagå˜é‡åï¼Œæœ¬åœ°å†…å­˜BåŒ…å«çš„å€¼å·²ç»è¢«ç½®ä¸ºæ— æ•ˆã€‚æ­¤æ—¶ï¼Œçº¿ç¨‹Bå¿…é¡»ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚çº¿ç¨‹Bçš„è¯»å–æ“ä½œå°†å¯¼è‡´æœ¬åœ°å†…å­˜Bä¸ä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡çš„å€¼å˜æˆä¸€è‡´ã€‚</p>
<p>ä¸‹é¢å¯¹volatileå†™å’Œvolatileè¯»çš„å†…å­˜è¯­ä¹‰åšä¸ªæ€»ç»“ã€‚</p>
<ol>
<li>
<p>çº¿ç¨‹Aå†™ä¸€ä¸ªvolatileå˜é‡ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹Aå‘æ¥ä¸‹æ¥å°†è¦è¯»è¿™ä¸ªvolatileå˜é‡çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†ï¼ˆå…¶å¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>çº¿ç¨‹Bè¯»ä¸€ä¸ªvolatileå˜é‡ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹Bæ¥æ”¶äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„ï¼ˆåœ¨å†™è¿™ä¸ªvolatileå˜é‡ä¹‹å‰å¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>çº¿ç¨‹Aå†™ä¸€ä¸ªvolatileå˜é‡ï¼Œéšåçº¿ç¨‹Bè¯»è¿™ä¸ªvolatileå˜é‡ï¼Œè¿™ä¸ªè¿‡ç¨‹å®è´¨ä¸Šæ˜¯çº¿ç¨‹Aé€šè¿‡ä¸»å†…å­˜å‘çº¿ç¨‹Bå‘é€æ¶ˆæ¯ã€‚</p>
</li>
</ol>
<h3 id="244-volatileå†…å­˜è¯­ä¹‰çš„å®ç°">2.4.4 volatileå†…å­˜è¯­ä¹‰çš„å®ç°</h3>
<p>ä¸ºäº†å®ç°volatileå†…å­˜è¯­ä¹‰ï¼ŒJMMä¼šåˆ†åˆ«é™åˆ¶ç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºã€‚</p>
<figure data-type="image" tabindex="8"><img src="https://q456qq520.github.io/post-images/1658996497940.png" alt="volatileé‡æ’åºè§„åˆ™è¡¨" loading="lazy"></figure>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œç¬¬ä¸‰è¡Œæœ€åä¸€ä¸ªå•å…ƒæ ¼çš„æ„æ€æ˜¯ï¼šåœ¨ç¨‹åºä¸­ï¼Œå½“ç¬¬ä¸€ä¸ªæ“ä½œä¸ºæ™®é€šå˜é‡çš„è¯»æˆ–å†™æ—¶ï¼Œå¦‚æœç¬¬äºŒä¸ªæ“ä½œä¸ºvolatileå†™ï¼Œåˆ™ç¼–è¯‘å™¨ä¸èƒ½é‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä»ä¸Šå›¾çœ‹å‡ºã€‚</p>
<pre><code>å½“ç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileå†™æ—¶ï¼Œä¸ç®¡ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileå†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°volatileå†™ä¹‹åã€‚

å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileè¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°volatileè¯»ä¹‹å‰ã€‚

å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileå†™ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸èƒ½é‡æ’åºã€‚
</code></pre>
<p>ä¸ºäº†å®ç°volatileçš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥<strong>å†…å­˜å±éšœ</strong>æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå‘ç°ä¸€ä¸ªæœ€ä¼˜å¸ƒç½®æ¥æœ€å°åŒ–æ’å…¥å±éšœçš„æ€»æ•°å‡ ä¹ä¸å¯èƒ½ã€‚ä¸ºæ­¤ï¼ŒJMMé‡‡å–ä¿å®ˆç­–ç•¥ã€‚ä¸‹é¢æ˜¯åŸºäºä¿å®ˆç­–ç•¥çš„JMMå†…å­˜å±éšœæ’å…¥ç­–ç•¥ã€‚</p>
<pre><code>1ã€åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªStoreStoreå±éšœã€‚
2ã€åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœã€‚
3ã€åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœã€‚
4ã€åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadStoreå±éšœã€‚
</code></pre>
<p>ä¸Šè¿°å†…å­˜å±éšœæ’å…¥ç­–ç•¥éå¸¸ä¿å®ˆï¼Œä½†å®ƒå¯ä»¥ä¿è¯åœ¨ä»»æ„å¤„ç†å™¨å¹³å°ï¼Œä»»æ„çš„ç¨‹åºä¸­éƒ½èƒ½å¾—åˆ°æ­£ç¡®çš„volatileå†…å­˜è¯­ä¹‰ã€‚</p>
<p>ï¼ˆStoreStoreå±éšœå¯ä»¥ä¿è¯åœ¨volatileå†™ä¹‹å‰ï¼Œå…¶å‰é¢çš„æ‰€æœ‰æ™®é€šå†™æ“ä½œå·²ç»å¯¹ä»»æ„å¤„ç†å™¨å¯è§äº†ã€‚è¿™æ˜¯å› ä¸ºStoreStoreå±éšœå°†ä¿éšœä¸Šé¢æ‰€æœ‰çš„æ™®é€šå†™åœ¨volatileå†™ä¹‹å‰åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚StoreLoadå±éšœçš„ä½œç”¨æ˜¯é¿å…volatileå†™ä¸åé¢å¯èƒ½æœ‰çš„volatileè¯»/å†™æ“ä½œé‡æ’åºã€‚LoadLoadå±éšœç”¨æ¥ç¦æ­¢å¤„ç†å™¨æŠŠä¸Šé¢çš„volatileè¯»ä¸ä¸‹é¢çš„æ™®é€šè¯»é‡æ’åºã€‚LoadStoreå±éšœç”¨æ¥ç¦æ­¢å¤„ç†å™¨æŠŠä¸Šé¢çš„volatileè¯»ä¸ä¸‹é¢çš„æ™®é€šå†™é‡æ’åºã€‚ï¼‰</p>
<p>X86å¤„ç†å™¨ä»…ä¼šå¯¹å†™-è¯»æ“ä½œåšé‡æ’åºã€‚X86ä¸ä¼šå¯¹è¯»-è¯»ã€è¯»-å†™å’Œå†™-å†™æ“ä½œåšé‡æ’åºï¼Œå› æ­¤åœ¨X86å¤„ç†å™¨ä¸­ä¼šçœç•¥æ‰è¿™3ç§æ“ä½œç±»å‹å¯¹åº”çš„å†…å­˜å±éšœã€‚åœ¨X86ä¸­ï¼ŒJMMä»…éœ€åœ¨volatileå†™åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœå³å¯æ­£ç¡®å®ç°volatileå†™-è¯»çš„å†…å­˜è¯­ä¹‰ã€‚è¿™æ„å‘³ç€åœ¨X86å¤„ç†å™¨ä¸­ï¼Œvolatileå†™çš„å¼€é”€æ¯”volatileè¯»çš„å¼€é”€ä¼šå¤§å¾ˆå¤šï¼ˆå› ä¸ºæ‰§è¡ŒStoreLoadå±éšœå¼€é”€ä¼šæ¯”è¾ƒå¤§ï¼‰ã€‚</p>
<h3 id="245-jsr-133ä¸ºä»€ä¹ˆè¦å¢å¼ºvolatileçš„å†…å­˜è¯­ä¹‰">2.4.5 JSR-133ä¸ºä»€ä¹ˆè¦å¢å¼ºvolatileçš„å†…å­˜è¯­ä¹‰</h3>
<h2 id="25-é”çš„å†…å­˜è¯­ä¹‰">2.5 é”çš„å†…å­˜è¯­ä¹‰</h2>
<p><strong>é”å¯ä»¥è®©ä¸´ç•ŒåŒºäº’æ–¥æ‰§è¡Œ</strong></p>
<h3 id="251-é”çš„é‡Šæ”¾-è·å–å»ºç«‹çš„happens-beforeå…³ç³»">2.5.1 é”çš„é‡Šæ”¾-è·å–å»ºç«‹çš„happens-beforeå…³ç³»</h3>
<p>é”æ˜¯Javaå¹¶å‘ç¼–ç¨‹ä¸­æœ€é‡è¦çš„åŒæ­¥æœºåˆ¶ã€‚é”é™¤äº†è®©ä¸´ç•ŒåŒºäº’æ–¥æ‰§è¡Œå¤–ï¼Œè¿˜å¯ä»¥è®©é‡Šæ”¾é”çš„çº¿ç¨‹å‘è·å–åŒä¸€ä¸ªé”çš„çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚</p>
<pre><code class="language-java"> class MonitorExample {
        int a = 0;
        public synchronized void writer() { // 1
            a++; // 2
        } // 3
        public synchronized void reader() { // 4
            int i = a; // 5
            â€¦â€¦      
        } // 6
    }
</code></pre>
<p>å‡è®¾çº¿ç¨‹Aæ‰§è¡Œwriter()æ–¹æ³•ï¼Œéšåçº¿ç¨‹Bæ‰§è¡Œreader()æ–¹æ³•ã€‚æ ¹æ®happens-beforeè§„åˆ™ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…å«çš„happens-beforeå…³ç³»å¯ä»¥åˆ†ä¸º3ç±»ã€‚</p>
<pre><code>1ï¼‰æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼Œ1 happens-before 2,2 happens-before 3;4 happens-before 5,5 happensbefore 6ã€‚

2ï¼‰æ ¹æ®ç›‘è§†å™¨é”è§„åˆ™ï¼Œ3 happens-before 4ã€‚

3ï¼‰æ ¹æ®happens-beforeçš„ä¼ é€’æ€§ï¼Œ2 happens-before 5ã€‚
</code></pre>
<p>ç¤ºåœ¨çº¿ç¨‹Aé‡Šæ”¾äº†é”ä¹‹åï¼Œéšåçº¿ç¨‹Bè·å–åŒä¸€ä¸ªé”ã€‚2 happens-before5ã€‚å› æ­¤ï¼Œçº¿ç¨‹Aåœ¨é‡Šæ”¾é”ä¹‹å‰æ‰€æœ‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨çº¿ç¨‹Bè·å–åŒä¸€ä¸ªé”ä¹‹åï¼Œå°†ç«‹åˆ»å˜å¾—å¯¹Bçº¿ç¨‹å¯è§ã€‚</p>
<h3 id="252-é”çš„é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰">2.5.2 é”çš„é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰</h3>
<p><strong>å½“çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚</strong></p>
<p>å½“çº¿ç¨‹è·å–é”æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ç½®ä¸ºæ— æ•ˆã€‚ä»è€Œä½¿å¾—è¢«ç›‘è§†å™¨ä¿æŠ¤çš„ä¸´ç•ŒåŒºä»£ç å¿…é¡»ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚</p>
<p>å¯¹æ¯”é”é‡Šæ”¾-è·å–çš„å†…å­˜è¯­ä¹‰ä¸volatileå†™-è¯»çš„å†…å­˜è¯­ä¹‰å¯ä»¥çœ‹å‡ºï¼šé”é‡Šæ”¾ä¸volatileå†™æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ï¼›é”è·å–ä¸volatileè¯»æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>ä¸‹é¢å¯¹é”é‡Šæ”¾å’Œé”è·å–çš„å†…å­˜è¯­ä¹‰åšä¸ªæ€»ç»“ã€‚</p>
<ol>
<li>
<p>çº¿ç¨‹Aé‡Šæ”¾ä¸€ä¸ªé”ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹Aå‘æ¥ä¸‹æ¥å°†è¦è·å–è¿™ä¸ªé”çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†ï¼ˆçº¿ç¨‹A<br>
å¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>çº¿ç¨‹Bè·å–ä¸€ä¸ªé”ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹Bæ¥æ”¶äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„ï¼ˆåœ¨é‡Šæ”¾è¿™ä¸ªé”ä¹‹å‰å¯¹å…±<br>
äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>çº¿ç¨‹Aé‡Šæ”¾é”ï¼Œéšåçº¿ç¨‹Bè·å–è¿™ä¸ªé”ï¼Œè¿™ä¸ªè¿‡ç¨‹å®è´¨ä¸Šæ˜¯çº¿ç¨‹Aé€šè¿‡ä¸»å†…å­˜å‘çº¿ç¨‹Bå‘<br>
é€æ¶ˆæ¯ã€‚</p>
</li>
</ol>
<h3 id="253-é”å†…å­˜è¯­ä¹‰çš„å®ç°">2.5.3 é”å†…å­˜è¯­ä¹‰çš„å®ç°</h3>
<p>å€ŸåŠ©ReentrantLockçš„æºä»£ç ï¼Œæ¥åˆ†æé”å†…å­˜è¯­ä¹‰çš„å…·ä½“å®ç°æœºåˆ¶ã€‚</p>
<pre><code class="language-java">  class ReentrantLockExample {
        int a = 0;
        ReentrantLock lock = new ReentrantLock();
        public void writer() {
            lock.lock(); // è·å–é”
            try {
                a++;
            } f inally {
                lock.unlock(); // é‡Šæ”¾é”
            }
        }
        public void reader () {
            lock.lock(); // è·å–é”
            try {
                int i = a;
                â€¦â€¦
            } f inally {
                lock.unlock(); // é‡Šæ”¾é”
            }
        }
    }
</code></pre>
<p>åœ¨ReentrantLockä¸­ï¼Œè°ƒç”¨lock()æ–¹æ³•è·å–é”ï¼›è°ƒç”¨unlock()æ–¹æ³•é‡Šæ”¾é”ã€‚ReentrantLockçš„å®ç°ä¾èµ–äºJavaåŒæ­¥å™¨æ¡†æ¶AbstractQueuedSynchronizerï¼ˆç®€ç§°ä¹‹ä¸ºAQSï¼‰ã€‚AQSä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„volatileå˜é‡ï¼ˆå‘½åä¸ºstateï¼‰æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ã€‚</p>
<figure data-type="image" tabindex="9"><img src="https://q456qq520.github.io/post-images/1659063821657.png" alt="ReentrantLockçš„ç±»å›¾" loading="lazy"></figure>
<p>ReentrantLockåˆ†ä¸º<strong>å…¬å¹³é”</strong>å’Œ<strong>éå…¬å¹³é”</strong>ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æå…¬å¹³é”ã€‚</p>
<p>ä½¿ç”¨å…¬å¹³é”æ—¶ï¼ŒåŠ é”æ–¹æ³•lock()è°ƒç”¨è½¨è¿¹å¦‚ä¸‹ã€‚</p>
<p>1ï¼‰ReentrantLock:lock()ã€‚<br>
2ï¼‰FairSync:lock()ã€‚<br>
3ï¼‰AbstractQueuedSynchronizer:acquire(int arg)ã€‚<br>
4ï¼‰ReentrantLock:tryAcquire(int acquires)ã€‚</p>
<p>åœ¨ç¬¬4æ­¥çœŸæ­£å¼€å§‹åŠ é”ï¼Œä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„æºä»£ç ã€‚</p>
<pre><code class="language-java">        @ReservedStackAccess
        protected final boolean tryAcquire(int acquires) {
            final Thread current = Thread.currentThread(); //è·å–å½“å‰æ‰§è¡Œçº¿ç¨‹
            int c = getState();          // è·å–é”çš„å¼€å§‹ï¼Œé¦–å…ˆè¯»volatileå˜é‡state
            if (c == 0) {
                if (!hasQueuedPredecessors() &amp;&amp;
                    compareAndSetState(0, acquires)) {
                    setExclusiveOwnerThread(current);
                    return true;
                }
            }
            else if (current == getExclusiveOwnerThread()) {
                int nextc = c + acquires;
                if (nextc &lt; 0)
                    throw new Error(&quot;Maximum lock count exceeded&quot;);
                setState(nextc);
                return true;
            }
            return false;
        }
</code></pre>
<p>ä»ä¸Šé¢æºä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒåŠ é”æ–¹æ³•é¦–å…ˆè¯»volatileå˜é‡stateã€‚</p>
<p>åœ¨ä½¿ç”¨å…¬å¹³é”æ—¶ï¼Œè§£é”æ–¹æ³•unlock()è°ƒç”¨è½¨è¿¹å¦‚ä¸‹ã€‚</p>
<p>1ï¼‰ReentrantLock:unlock()ã€‚<br>
2ï¼‰AbstractQueuedSynchronizer:release(int arg)ã€‚<br>
3ï¼‰Sync:tryRelease(int releases)ã€‚</p>
<p>åœ¨ç¬¬3æ­¥çœŸæ­£å¼€å§‹é‡Šæ”¾é”ï¼Œä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„æºä»£ç ã€‚</p>
<pre><code class="language-java">@ReservedStackAccess
protected final boolean tryRelease(int releases) {
     int c = getState() - releases;
     if (Thread.currentThread() != getExclusiveOwnerThread())
         throw new IllegalMonitorStateException();
        boolean free = false;
        if (c == 0) {
            free = true;
            setExclusiveOwnerThread(null);
        }
        setState(c);    // é‡Šæ”¾é”çš„æœ€åï¼Œå†™volatileå˜é‡state
        return free;
}
</code></pre>
<p>å…¬å¹³é”åœ¨é‡Šæ”¾é”çš„æœ€åå†™volatileå˜é‡stateï¼Œåœ¨è·å–é”æ—¶é¦–å…ˆè¯»è¿™ä¸ªvolatileå˜é‡ã€‚æ ¹æ®volatileçš„happens-beforeè§„åˆ™ï¼Œé‡Šæ”¾é”çš„çº¿ç¨‹åœ¨å†™volatileå˜é‡ä¹‹å‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨è·å–é”çš„çº¿ç¨‹è¯»å–åŒä¸€ä¸ªvolatileå˜é‡åå°†ç«‹å³å˜å¾—å¯¹è·å–é”çš„çº¿ç¨‹å¯è§ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥åˆ†æéå…¬å¹³é”çš„å†…å­˜è¯­ä¹‰çš„å®ç°ã€‚éå…¬å¹³é”çš„é‡Šæ”¾å’Œå…¬å¹³é”å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥è¿™é‡Œä»…ä»…åˆ†æéå…¬å¹³é”çš„è·å–ã€‚ä½¿ç”¨éå…¬å¹³é”æ—¶ï¼ŒåŠ é”æ–¹æ³•lock()è°ƒç”¨è½¨è¿¹å¦‚ä¸‹ã€‚</p>
<p>1ï¼‰ReentrantLock:lock()ã€‚<br>
2ï¼‰NonfairSync:lock()ã€‚<br>
3ï¼‰AbstractQueuedSynchronizer:compareAndSetState(int expect,int update)ã€‚</p>
<p>åœ¨ç¬¬3æ­¥çœŸæ­£å¼€å§‹åŠ é”ï¼Œä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„æºä»£ç ã€‚</p>
<pre><code class="language-java">protected final boolean compareAndSetState(int expect, int update) {
     // See below for intrinsics setup to support this
     return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
 }
</code></pre>
<p>è¯¥æ–¹æ³•ä»¥åŸå­æ“ä½œçš„æ–¹å¼æ›´æ–°stateå˜é‡ï¼Œ</p>
<p><em>compareAndSet()(CAS)ï¼šå¦‚æœå½“å‰çŠ¶æ€å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†åŒæ­¥çŠ¶æ€è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚æ­¤æ“ä½œå…·æœ‰volatileè¯»å’Œå†™çš„å†…å­˜è¯­ä¹‰ã€‚</em></p>
<p>æˆ‘ä»¬åˆ†åˆ«ä»ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„è§’åº¦æ¥åˆ†æï¼ŒCASå¦‚ä½•åŒæ—¶å…·æœ‰volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>å‰æ–‡æˆ‘ä»¬æåˆ°è¿‡ï¼Œç¼–è¯‘å™¨ä¸ä¼šå¯¹volatileè¯»ä¸volatileè¯»åé¢çš„ä»»æ„å†…å­˜æ“ä½œé‡æ’åºï¼›ç¼–è¯‘å™¨ä¸ä¼šå¯¹volatileå†™ä¸volatileå†™å‰é¢çš„ä»»æ„å†…å­˜æ“ä½œé‡æ’åºã€‚ç»„åˆè¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œæ„å‘³ç€ä¸ºäº†åŒæ—¶å®ç°volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨ä¸èƒ½å¯¹CASä¸CASå‰é¢å’Œåé¢çš„ä»»æ„å†…å­˜æ“ä½œé‡æ’åºã€‚</p>
<p><em>sun.misc.Unsafeç±»çš„compareAndSwapInt()æ–¹æ³•çš„æºä»£ç ã€‚</em></p>
<pre><code class="language-java"> public final native boolean compareAndSwapInt(Object o, long offset,
                                                  int expected, int x);
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•è°ƒç”¨ã€‚ç¨‹åºä¼šæ ¹æ®å½“å‰å¤„ç†å™¨çš„ç±»å‹æ¥å†³å®šæ˜¯å¦ä¸ºcmpxchgæŒ‡ä»¤æ·»åŠ lockå‰<br>
ç¼€ã€‚å¦‚æœç¨‹åºæ˜¯åœ¨å¤šå¤„ç†å™¨ä¸Šè¿è¡Œï¼Œå°±ä¸ºcmpxchgæŒ‡ä»¤åŠ ä¸Šlockå‰ç¼€ï¼ˆLock Cmpxchgï¼‰ã€‚åä¹‹ï¼Œå¦‚<br>
æœç¨‹åºæ˜¯åœ¨å•å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œå°±çœç•¥lockå‰ç¼€ã€‚</p>
<p>å¯¹lockå‰ç¼€çš„è¯´æ˜å¦‚ä¸‹ã€‚</p>
<p>1ï¼‰ç¡®ä¿å¯¹å†…å­˜çš„è¯»-æ”¹-å†™æ“ä½œåŸå­æ‰§è¡Œã€‚åœ¨PentiumåŠPentiumä¹‹å‰çš„å¤„ç†å™¨ä¸­ï¼Œå¸¦æœ‰lockå‰ç¼€çš„æŒ‡ä»¤åœ¨æ‰§è¡ŒæœŸé—´ä¼šé”ä½æ€»çº¿ï¼Œä½¿å¾—å…¶ä»–å¤„ç†å™¨æš‚æ—¶æ— æ³•é€šè¿‡æ€»çº¿è®¿é—®å†…å­˜ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¼šå¸¦æ¥æ˜‚è´µçš„å¼€é”€ã€‚ä»Pentium 4ã€Intel XeonåŠP6å¤„ç†å™¨å¼€å§‹ï¼ŒIntelä½¿ç”¨ç¼“å­˜é”å®šï¼ˆCache Lockingï¼‰æ¥ä¿è¯æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§ã€‚ç¼“å­˜é”å®šå°†å¤§å¤§é™ä½lockå‰ç¼€æŒ‡ä»¤çš„æ‰§è¡Œå¼€é”€ã€‚</p>
<p>2ï¼‰ç¦æ­¢è¯¥æŒ‡ä»¤ï¼Œä¸ä¹‹å‰å’Œä¹‹åçš„è¯»å’Œå†™æŒ‡ä»¤é‡æ’åºã€‚</p>
<p>3ï¼‰æŠŠå†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰æ•°æ®åˆ·æ–°åˆ°å†…å­˜ä¸­ã€‚</p>
<p>ä¸Šé¢çš„ç¬¬2ç‚¹å’Œç¬¬3ç‚¹æ‰€å…·æœ‰çš„å†…å­˜å±éšœæ•ˆæœï¼Œè¶³ä»¥åŒæ—¶å®ç°volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>ç°åœ¨å¯¹å…¬å¹³é”å’Œéå…¬å¹³é”çš„å†…å­˜è¯­ä¹‰åšä¸ªæ€»ç»“ã€‚</p>
<ol>
<li>å…¬å¹³é”å’Œéå…¬å¹³é”é‡Šæ”¾æ—¶ï¼Œæœ€åéƒ½è¦å†™ä¸€ä¸ªvolatileå˜é‡stateã€‚</li>
<li>å…¬å¹³é”è·å–æ—¶ï¼Œé¦–å…ˆä¼šå»è¯»volatileå˜é‡ã€‚</li>
<li>éå…¬å¹³é”è·å–æ—¶ï¼Œé¦–å…ˆä¼šç”¨CASæ›´æ–°volatileå˜é‡ï¼Œè¿™ä¸ªæ“ä½œåŒæ—¶å…·æœ‰volatileè¯»å’Œvolatile<br>
å†™çš„å†…å­˜è¯­ä¹‰ã€‚</li>
</ol>
<p>ä»æœ¬æ–‡å¯¹ReentrantLockçš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œé”é‡Šæ”¾-è·å–çš„å†…å­˜è¯­ä¹‰çš„å®ç°è‡³å°‘æœ‰ä¸‹é¢ä¸¤ç§æ–¹å¼ã€‚</p>
<p>1ï¼‰åˆ©ç”¨volatileå˜é‡çš„å†™-è¯»æ‰€å…·æœ‰çš„å†…å­˜è¯­ä¹‰ã€‚<br>
2ï¼‰åˆ©ç”¨CASæ‰€é™„å¸¦çš„volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<h3 id="254-concurrentåŒ…çš„å®ç°">2.5.4 concurrentåŒ…çš„å®ç°</h3>
<p>ç”±äºJavaçš„CASåŒæ—¶å…·æœ‰volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰ï¼Œå› æ­¤Javaçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç°åœ¨æœ‰äº†ä¸‹é¢4ç§æ–¹å¼ã€‚</p>
<pre><code>1ï¼‰Açº¿ç¨‹å†™volatileå˜é‡ï¼ŒéšåBçº¿ç¨‹è¯»è¿™ä¸ªvolatileå˜é‡ã€‚
2ï¼‰Açº¿ç¨‹å†™volatileå˜é‡ï¼ŒéšåBçº¿ç¨‹ç”¨CASæ›´æ–°è¿™ä¸ªvolatileå˜é‡ã€‚
3ï¼‰Açº¿ç¨‹ç”¨CASæ›´æ–°ä¸€ä¸ªvolatileå˜é‡ï¼ŒéšåBçº¿ç¨‹ç”¨CASæ›´æ–°è¿™ä¸ªvolatileå˜é‡ã€‚
4ï¼‰Açº¿ç¨‹ç”¨CASæ›´æ–°ä¸€ä¸ªvolatileå˜é‡ï¼ŒéšåBçº¿ç¨‹è¯»è¿™ä¸ªvolatileå˜é‡ã€‚
</code></pre>
<p>ä»”ç»†åˆ†æconcurrentåŒ…çš„æºä»£ç å®ç°ï¼Œä¼šå‘ç°ä¸€ä¸ªé€šç”¨åŒ–çš„å®ç°æ¨¡å¼ã€‚</p>
<p>é¦–å…ˆï¼Œå£°æ˜å…±äº«å˜é‡ä¸ºvolatileã€‚</p>
<p>ç„¶åï¼Œä½¿ç”¨CASçš„åŸå­æ¡ä»¶æ›´æ–°æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚</p>
<p>åŒæ—¶ï¼Œé…åˆä»¥volatileçš„è¯»/å†™å’ŒCASæ‰€å…·æœ‰çš„volatileè¯»å’Œå†™çš„å†…å­˜è¯­ä¹‰æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p>AQSï¼Œéé˜»å¡æ•°æ®ç»“æ„å’ŒåŸå­å˜é‡ç±»ï¼ˆjava.util.concurrent.atomicåŒ…ä¸­çš„ç±»ï¼‰ï¼Œè¿™äº›concurrentåŒ…ä¸­çš„åŸºç¡€ç±»éƒ½æ˜¯ä½¿ç”¨è¿™ç§æ¨¡å¼æ¥å®ç°çš„ï¼Œè€ŒconcurrentåŒ…ä¸­çš„é«˜å±‚ç±»åˆæ˜¯ä¾èµ–äºè¿™äº›åŸºç¡€ç±»æ¥å®ç°çš„ã€‚</p>
<figure data-type="image" tabindex="10"><img src="https://q456qq520.github.io/post-images/1659076796126.png" alt="concurrentåŒ…çš„å®ç°ç¤ºæ„å›¾" loading="lazy"></figure>
<h2 id="26-finalåŸŸçš„å†…å­˜è¯­ä¹‰">2.6 finalåŸŸçš„å†…å­˜è¯­ä¹‰</h2>
<h3 id="361-finalåŸŸçš„é‡æ’åºè§„åˆ™">3.6.1 finalåŸŸçš„é‡æ’åºè§„åˆ™</h3>
<p>å¯¹äºfinalåŸŸï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨è¦éµå®ˆä¸¤ä¸ªé‡æ’åºè§„åˆ™ã€‚</p>
<p>1ï¼‰åœ¨æ„é€ å‡½æ•°å†…å¯¹ä¸€ä¸ªfinalåŸŸçš„å†™å…¥ï¼Œä¸éšåæŠŠè¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</p>
<p>2ï¼‰åˆæ¬¡è¯»ä¸€ä¸ªåŒ…å«finalåŸŸçš„å¯¹è±¡çš„å¼•ç”¨ï¼Œä¸éšååˆæ¬¡è¯»è¿™ä¸ªfinalåŸŸï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</p>
<p><em>ç¤ºä¾‹æ€§ä»£ç </em></p>
<pre><code class="language-java"> public class FinalExample {
        int i; // æ™®é€šå˜é‡
        final int j; // finalå˜é‡
        static FinalExample obj;
        public FinalExample () { // æ„é€ å‡½æ•°
            i = 1; // å†™æ™®é€šåŸŸ
            j = 2; // å†™finalåŸŸ
        }
        public static void writer () { // å†™çº¿ç¨‹Aæ‰§è¡Œ
            obj = new FinalExample ();
        }
        public static void reader () { // è¯»çº¿ç¨‹Bæ‰§è¡Œ
            FinalExample object = obj; // è¯»å¯¹è±¡å¼•ç”¨
            int a = object.i; // è¯»æ™®é€šåŸŸ
            int b = object.j; // è¯»finalåŸŸ
        }
    }
</code></pre>
<h3 id="262-å†™finalåŸŸçš„é‡æ’åºè§„åˆ™">2.6.2 å†™finalåŸŸçš„é‡æ’åºè§„åˆ™</h3>
<p>å†™finalåŸŸçš„é‡æ’åºè§„åˆ™ç¦æ­¢æŠŠfinalåŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚è¿™ä¸ªè§„åˆ™çš„å®ç°åŒ…å«ä¸‹é¢2ä¸ªæ–¹é¢ã€‚</p>
<p>1ï¼‰JMMç¦æ­¢ç¼–è¯‘å™¨æŠŠfinalåŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚</p>
<p>2ï¼‰ç¼–è¯‘å™¨ä¼šåœ¨finalåŸŸçš„å†™ä¹‹åï¼Œæ„é€ å‡½æ•°returnä¹‹å‰ï¼Œæ’å…¥ä¸€ä¸ªStoreStoreå±éšœã€‚è¿™ä¸ªå±éšœç¦æ­¢å¤„ç†å™¨æŠŠfinalåŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬åˆ†æwriter()æ–¹æ³•ã€‚writer()æ–¹æ³•åªåŒ…å«ä¸€è¡Œä»£ç ï¼šfinalExample=newFinalExample()ã€‚è¿™è¡Œä»£ç åŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹ã€‚</p>
<pre><code>1ï¼‰æ„é€ ä¸€ä¸ªFinalExampleç±»å‹çš„å¯¹è±¡ã€‚
2ï¼‰æŠŠè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™å¼•ç”¨å˜é‡objã€‚
</code></pre>
<p>å‡è®¾çº¿ç¨‹Bè¯»å¯¹è±¡å¼•ç”¨ä¸è¯»å¯¹è±¡çš„æˆå‘˜åŸŸä¹‹é—´æ²¡æœ‰é‡æ’åº</p>
<figure data-type="image" tabindex="11"><img src="https://q456qq520.github.io/post-images/1659078456654.png" alt="çº¿ç¨‹æ‰§è¡Œæ—¶åºå›¾" loading="lazy"></figure>
<p>å†™æ™®é€šåŸŸçš„æ“ä½œè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°äº†æ„é€ å‡½æ•°ä¹‹å¤–ï¼Œè¯»çº¿ç¨‹Bé”™è¯¯åœ°è¯»å–äº†æ™®é€šå˜é‡iåˆå§‹åŒ–ä¹‹å‰çš„å€¼ã€‚è€Œå†™finalåŸŸçš„æ“ä½œï¼Œè¢«å†™finalåŸŸçš„é‡æ’åºè§„åˆ™â€œé™å®šâ€åœ¨äº†æ„é€ å‡½æ•°ä¹‹å†…ï¼Œè¯»çº¿ç¨‹Bæ­£ç¡®åœ°è¯»å–äº†finalå˜é‡åˆå§‹åŒ–ä¹‹åçš„å€¼ã€‚</p>
<p>å†™finalåŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨å¯¹è±¡å¼•ç”¨ä¸ºä»»æ„çº¿ç¨‹å¯è§ä¹‹å‰ï¼Œå¯¹è±¡çš„finalåŸŸå·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–è¿‡äº†ï¼Œè€Œæ™®é€šåŸŸä¸å…·æœ‰è¿™ä¸ªä¿éšœã€‚</p>
<h3 id="263-è¯»finalåŸŸçš„é‡æ’åºè§„åˆ™">2.6.3 è¯»finalåŸŸçš„é‡æ’åºè§„åˆ™</h3>
<p>è¯»finalåŸŸçš„é‡æ’åºè§„åˆ™æ˜¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œåˆæ¬¡è¯»å¯¹è±¡å¼•ç”¨ä¸åˆæ¬¡è¯»è¯¥å¯¹è±¡åŒ…å«çš„finalåŸŸï¼ŒJMMç¦æ­¢å¤„ç†å™¨é‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚ç¼–è¯‘å™¨ä¼šåœ¨è¯»finalåŸŸæ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœã€‚</p>
<p>reader()æ–¹æ³•åŒ…å«3ä¸ªæ“ä½œã€‚</p>
<pre><code>1ï¼‰åˆæ¬¡è¯»å¼•ç”¨å˜é‡objã€‚
2ï¼‰åˆæ¬¡è¯»å¼•ç”¨å˜é‡objæŒ‡å‘å¯¹è±¡çš„æ™®é€šåŸŸjã€‚
3ï¼‰åˆæ¬¡è¯»å¼•ç”¨å˜é‡objæŒ‡å‘å¯¹è±¡çš„finalåŸŸiã€‚
</code></pre>
<p>è¯»finalåŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨è¯»ä¸€ä¸ªå¯¹è±¡çš„finalåŸŸä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆè¯»åŒ…å«è¿™ä¸ªfinalåŸŸçš„å¯¹è±¡çš„å¼•ç”¨ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ç¨‹åºä¸­ï¼Œå¦‚æœè¯¥å¼•ç”¨ä¸ä¸ºnullï¼Œé‚£ä¹ˆå¼•ç”¨å¯¹è±¡çš„finalåŸŸä¸€å®šå·²ç»è¢«Açº¿ç¨‹åˆå§‹åŒ–è¿‡äº†ã€‚</p>
<h3 id="264-finalåŸŸä¸ºå¼•ç”¨ç±»å‹">2.6.4 finalåŸŸä¸ºå¼•ç”¨ç±»å‹</h3>
<p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„finalåŸŸæ˜¯åŸºç¡€æ•°æ®ç±»å‹ï¼Œå¦‚æœfinalåŸŸæ˜¯å¼•ç”¨ç±»å‹ï¼Œå°†ä¼šæœ‰ä»€ä¹ˆæ•ˆæœï¼Ÿ</p>
<pre><code class="language-java"> public class FinalReferenceExample {
        final int[] intArray; // finalæ˜¯å¼•ç”¨ç±»å‹
        static FinalReferenceExample obj;
        public FinalReferenceExample () { // æ„é€ å‡½æ•°
            intArray = new int[1]; // 1
            intArray[0] = 1; // 2
        }
        public static void writerOne () { // å†™çº¿ç¨‹Aæ‰§è¡Œ
            obj = new FinalReferenceExample (); // 3
        }
        public static void writerTwo () { // å†™çº¿ç¨‹Bæ‰§è¡Œ
            obj.intArray[0] = 2; // 4
        }
        public static void reader () { // è¯»çº¿ç¨‹Cæ‰§è¡Œ
            if (obj != null) { // 5
                int temp1 = obj.intArray[0]; // 6
            }
        }
    }
</code></pre>
<p>æœ¬ä¾‹finalåŸŸä¸ºä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œå®ƒå¼•ç”¨ä¸€ä¸ªintå‹çš„æ•°ç»„å¯¹è±¡ã€‚å¯¹äºå¼•ç”¨ç±»å‹ï¼Œå†™finalåŸŸçš„é‡æ’åºè§„åˆ™å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¢åŠ äº†å¦‚ä¸‹çº¦æŸï¼š<strong>åœ¨æ„é€ å‡½æ•°å†…å¯¹ä¸€ä¸ªfinalå¼•ç”¨çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ï¼Œä¸éšååœ¨æ„é€ å‡½æ•°å¤–æŠŠè¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</strong></p>
<p>1æ˜¯å¯¹finalåŸŸçš„å†™å…¥ï¼Œ2æ˜¯å¯¹è¿™ä¸ªfinalåŸŸå¼•ç”¨çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ï¼Œ3æ˜¯æŠŠè¢«æ„é€ çš„å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™æŸä¸ªå¼•ç”¨å˜é‡ã€‚è¿™é‡Œé™¤äº†å‰é¢æåˆ°çš„1ä¸èƒ½å’Œ3é‡æ’åºå¤–ï¼Œ2å’Œ3ä¹Ÿä¸èƒ½é‡æ’åºã€‚</p>
<p>JMMå¯ä»¥ç¡®ä¿è¯»çº¿ç¨‹Cè‡³å°‘èƒ½çœ‹åˆ°å†™çº¿ç¨‹Aåœ¨æ„é€ å‡½æ•°ä¸­å¯¹finalå¼•ç”¨å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ã€‚å³Cè‡³å°‘èƒ½çœ‹åˆ°æ•°ç»„ä¸‹æ ‡0çš„å€¼ä¸º1ã€‚è€Œå†™çº¿ç¨‹Bå¯¹æ•°ç»„å…ƒç´ çš„å†™å…¥ï¼Œè¯»çº¿ç¨‹Cå¯èƒ½çœ‹å¾—åˆ°ï¼Œä¹Ÿå¯èƒ½çœ‹ä¸åˆ°ã€‚JMMä¸ä¿è¯çº¿ç¨‹Bçš„å†™å…¥å¯¹è¯»çº¿ç¨‹Cå¯è§ï¼Œå› ä¸ºå†™çº¿ç¨‹Bå’Œè¯»çº¿ç¨‹Cä¹‹é—´å­˜åœ¨æ•°æ®ç«äº‰ï¼Œæ­¤æ—¶çš„æ‰§è¡Œç»“æœä¸å¯é¢„çŸ¥ã€‚</p>
<h3 id="265-ä¸ºä»€ä¹ˆfinalå¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…æº¢å‡º">2.6.5 ä¸ºä»€ä¹ˆfinalå¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œæº¢å‡ºâ€</h3>
<p><strong>åœ¨æ„é€ å‡½æ•°å†…éƒ¨ï¼Œä¸èƒ½è®©è¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨ä¸ºå…¶ä»–çº¿ç¨‹æ‰€è§ï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡å¼•ç”¨ä¸èƒ½åœ¨æ„é€ å‡½æ•°ä¸­â€œæº¢å‡ºâ€ã€‚</strong></p>
<pre><code class="language-java"> public class FinalReferenceEscapeExample {
        final int i;
        static FinalReferenceEscapeExample obj;
        public FinalReferenceEscapeExample () {
            i = 1; // 1å†™finalåŸŸ
            obj = this; // 2 thiså¼•ç”¨åœ¨æ­¤&quot;é€¸å‡º&quot;
        }
        public static void writer() {
            new FinalReferenceEscapeExample ();
        }
        public static void reader() {
            if (obj != null) { // 3
                int temp = obj.i; // 4
            }
        }
    }
</code></pre>
<p>åœ¨æ„é€ å‡½æ•°è¿”å›å‰ï¼Œè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨ä¸èƒ½ä¸ºå…¶ä»–çº¿ç¨‹æ‰€è§ï¼Œå› ä¸ºæ­¤æ—¶çš„finalåŸŸå¯èƒ½è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ã€‚åœ¨æ„é€ å‡½æ•°è¿”å›åï¼Œä»»æ„çº¿ç¨‹éƒ½å°†ä¿è¯èƒ½çœ‹åˆ°finalåŸŸæ­£ç¡®åˆå§‹åŒ–ä¹‹åçš„å€¼ï¼Œå› ä¸º1å’Œ2æ“ä½œå¯èƒ½è¿›è¡Œé‡æ’åºï¼Œä½†æ˜¯2æ‰§è¡Œå®Œåˆ«çš„çº¿ç¨‹å¯è§ã€‚</p>
<h3 id="266-finalè¯­ä¹‰åœ¨å¤„ç†å™¨ä¸­çš„å®ç°">2.6.6 finalè¯­ä¹‰åœ¨å¤„ç†å™¨ä¸­çš„å®ç°</h3>
<p>å†™finalåŸŸçš„é‡æ’åºè§„åˆ™ä¼šè¦æ±‚ç¼–è¯‘å™¨åœ¨finalåŸŸçš„å†™ä¹‹åï¼Œæ„é€ å‡½æ•°returnä¹‹å‰æ’å…¥ä¸€ä¸ªStoreStoreéšœå±ã€‚è¯»finalåŸŸçš„é‡æ’åºè§„åˆ™è¦æ±‚ç¼–è¯‘å™¨åœ¨è¯»finalåŸŸçš„æ“ä½œå‰é¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœã€‚</p>
<h3 id="267-jsr-133ä¸ºä»€ä¹ˆè¦å¢å¼ºfinalçš„è¯­ä¹‰">2.6.7 JSR-133ä¸ºä»€ä¹ˆè¦å¢å¼ºfinalçš„è¯­ä¹‰</h3>
<h2 id="27-happens-before">2.7 happens-before</h2>
<h3 id="271-jmmçš„è®¾è®¡">2.7.1 JMMçš„è®¾è®¡</h3>
<pre><code>double pi = 3.14; // A
double r = 1.0; // B
double area = pi * r * r; // C
</code></pre>
<p>ä¸Šé¢è®¡ç®—åœ†çš„é¢ç§¯çš„ç¤ºä¾‹ä»£ç å­˜åœ¨3ä¸ªhappens-beforeå…³ç³»ï¼Œå¦‚ä¸‹ã€‚</p>
<ol>
<li>A happens-before Bã€‚</li>
<li>B happens-before Cã€‚</li>
<li>A happens-before Cã€‚</li>
</ol>
<p>åœ¨3ä¸ªhappens-beforeå…³ç³»ä¸­ï¼Œ2å’Œ3æ˜¯å¿…éœ€çš„ï¼Œä½†1æ˜¯ä¸å¿…è¦çš„ã€‚å› æ­¤ï¼ŒJMMæŠŠhappens-beforeè¦æ±‚ç¦æ­¢çš„é‡æ’åºåˆ†ä¸ºäº†ä¸‹é¢ä¸¤ç±»ã€‚</p>
<p>1ï¼‰ä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºï¼ŒJMMè¦æ±‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¿…é¡»ç¦æ­¢è¿™ç§é‡æ’åºã€‚ã€‚<br>
2ï¼‰ä¸ä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºï¼ŒJMMå¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸åšè¦æ±‚ï¼ˆJMMå…è®¸è¿™ç§é‡æ’åºï¼‰ã€‚</p>
<h3 id="272-happens-beforeçš„å®šä¹‰">2.7.2 happens-beforeçš„å®šä¹‰</h3>
<p>happens-beforeï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­äº‹ä»¶ä¹‹é—´çš„ååºå…³ç³»ï¼ˆpartial orderingï¼‰ã€‚JMMå¯ä»¥é€šè¿‡happens-beforeå…³ç³»å‘ç¨‹åºå‘˜æä¾›è·¨çº¿ç¨‹çš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<p>happens-beforeå…³ç³»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>1ï¼‰å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚</p>
<p>2ï¼‰ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœï¼Œä¸æŒ‰happens-beforeå…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ã€‚</p>
<h3 id="273-happens-beforeè§„åˆ™">2.7.3 happens-beforeè§„åˆ™</h3>
<p>1ï¼‰ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚</p>
<p>2ï¼‰ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚</p>
<p>3ï¼‰volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚</p>
<p>4ï¼‰ä¼ é€’æ€§ï¼šå¦‚æœA happens-before Bï¼Œä¸”B happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚</p>
<p>5ï¼‰start()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆAçº¿ç¨‹çš„ThreadB.start()æ“ä½œhappens-beforeäºçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œã€‚</p>
<p>6ï¼‰join()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸­çš„ä»»æ„æ“happens-beforeäºçº¿ç¨‹Aä»ThreadB.join()æ“ä½œæˆåŠŸè¿”å›ã€‚</p>
<p>*start()è§„åˆ™ï¼š*å‡è®¾çº¿ç¨‹Aåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡æ‰§è¡ŒThreadB.start()æ¥å¯åŠ¨çº¿ç¨‹Bï¼›åŒæ—¶ï¼Œå‡è®¾çº¿ç¨‹Aåœ¨æ‰§è¡ŒThreadB.start()ä¹‹å‰ä¿®æ”¹äº†ä¸€äº›å…±äº«å˜é‡ï¼Œçº¿ç¨‹Båœ¨å¼€å§‹æ‰§è¡Œåä¼šè¯»è¿™äº›å…±äº«å˜é‡ã€‚</p>
<p><em>join()è§„åˆ™ï¼š</em>ã€‚å‡è®¾çº¿ç¨‹Aåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡æ‰§è¡ŒThreadB.join()æ¥ç­‰å¾…çº¿ç¨‹Bç»ˆæ­¢ï¼›åŒæ—¶ï¼Œå‡è®¾çº¿ç¨‹Båœ¨ç»ˆæ­¢ä¹‹å‰ä¿®æ”¹äº†ä¸€äº›å…±äº«å˜é‡ï¼Œçº¿ç¨‹Aä»ThreadB.join()è¿”å›åä¼šè¯»è¿™äº›å…±äº«å˜é‡ã€‚</p>
<h2 id="28-åŒé‡æ£€æŸ¥é”å®šä¸å»¶è¿Ÿåˆå§‹åŒ–">2.8 åŒé‡æ£€æŸ¥é”å®šä¸å»¶è¿Ÿåˆå§‹åŒ–</h2>
<p>åœ¨Javaå¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦é‡‡ç”¨å»¶è¿Ÿåˆå§‹åŒ–æ¥é™ä½åˆå§‹åŒ–ç±»å’Œåˆ›å»ºå¯¹è±¡çš„å¼€é”€ã€‚åŒé‡æ£€æŸ¥é”å®šæ˜¯å¸¸è§çš„å»¶è¿Ÿåˆå§‹åŒ–æŠ€æœ¯ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªé”™è¯¯çš„ç”¨æ³•ã€‚</p>
<h3 id="281-åŒé‡æ£€æŸ¥é”å®šçš„ç”±æ¥">2.8.1 åŒé‡æ£€æŸ¥é”å®šçš„ç”±æ¥</h3>
<p>åœ¨Javaç¨‹åºä¸­ï¼Œæœ‰æ—¶å€™å¯èƒ½éœ€è¦æ¨è¿Ÿä¸€äº›é«˜å¼€é”€çš„å¯¹è±¡åˆå§‹åŒ–æ“ä½œï¼Œå¹¶ä¸”åªæœ‰åœ¨ä½¿ç”¨è¿™äº›å¯¹è±¡æ—¶æ‰è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<pre><code class="language-java">éçº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–å¯¹è±¡çš„ç¤ºä¾‹ä»£ç ã€‚
public class UnsafeLazyInitialization {
    private static Instance instance;
    public static Instance getInstance() {
        if (instance == null) // 1ï¼šAçº¿ç¨‹æ‰§è¡Œ
            instance = new Instance(); // 2ï¼šBçº¿ç¨‹æ‰§è¡Œ
        return instance;
    }
}
</code></pre>
<p>åœ¨UnsafeLazyInitializationç±»ä¸­ï¼Œå‡è®¾Açº¿ç¨‹æ‰§è¡Œä»£ç 1çš„åŒæ—¶ï¼ŒBçº¿ç¨‹æ‰§è¡Œä»£ç 2ã€‚æ­¤æ—¶ï¼Œçº¿ç¨‹Aå¯èƒ½ä¼šçœ‹åˆ°instanceå¼•ç”¨çš„å¯¹è±¡è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–</p>
<pre><code class="language-java">åšåŒæ­¥å¤„ç†æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–
public class SafeLazyInitialization {
    private static Instance instance;
    public synchronized static Instance getInstance() {
        if (instance == null)
            instance = new Instance();
        return instance;
    }
}
</code></pre>
<p>ç”±äºå¯¹getInstance()æ–¹æ³•åšäº†åŒæ­¥å¤„ç†ï¼Œsynchronizedå°†å¯¼è‡´æ€§èƒ½å¼€é”€ã€‚å¦‚æœgetInstance()æ–¹æ³•è¢«å¤šä¸ªçº¿ç¨‹é¢‘ç¹çš„è°ƒç”¨ï¼Œå°†ä¼šå¯¼è‡´ç¨‹åºæ‰§è¡Œæ€§èƒ½çš„ä¸‹é™ã€‚</p>
<pre><code class="language-java">é€šè¿‡åŒé‡æ£€æŸ¥é”å®šæ¥é™ä½åŒæ­¥çš„å¼€é”€
public class DoubleCheckedLocking { // 1
    private static Instance instance; // 2
    public static Instance getInstance() { // 3
        if (instance == null) { // 4:ç¬¬ä¸€æ¬¡æ£€æŸ¥
            synchronized (DoubleCheckedLocking.class) { // 5:åŠ é”
                if (instance == null) // 6:ç¬¬äºŒæ¬¡æ£€æŸ¥
                    instance = new Instance(); // 7:é—®é¢˜çš„æ ¹æºå‡ºåœ¨è¿™é‡Œ
            } // 8
        } // 9
        return instance; // 10
    } // 11
}
</code></pre>
<p>åŒé‡æ£€æŸ¥é”å®šçœ‹èµ·æ¥ä¼¼ä¹å¾ˆå®Œç¾ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé”™è¯¯çš„ä¼˜åŒ–ï¼åœ¨çº¿ç¨‹æ‰§è¡Œåˆ°ç¬¬4è¡Œï¼Œä»£ç è¯»å–åˆ°instanceä¸ä¸ºnullæ—¶ï¼Œinstanceå¼•ç”¨çš„å¯¹è±¡æœ‰å¯èƒ½è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚</p>
<h3 id="282-é—®é¢˜çš„æ ¹æº">2.8.2 é—®é¢˜çš„æ ¹æº</h3>
<p>å‰é¢çš„åŒé‡æ£€æŸ¥é”å®šç¤ºä¾‹ä»£ç çš„ç¬¬7è¡Œï¼ˆinstance=new Singleton();ï¼‰åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸€è¡Œä»£ç å¯ä»¥åˆ†è§£ä¸ºå¦‚ä¸‹çš„3æ­¥ã€‚</p>
<pre><code>1ï¼šåˆ†é…å¯¹è±¡çš„å†…å­˜ç©ºé—´
2ï¼šåˆå§‹åŒ–å¯¹è±¡
3ï¼šè®¾ç½®instanceæŒ‡å‘åˆšåˆ†é…çš„å†…å­˜åœ°å€
</code></pre>
<p>ä¸Šé¢3æ­¥ä¸­çš„2å’Œ3ä¹‹é—´ï¼Œå¯èƒ½ä¼šè¢«é‡æ’åºã€‚</p>
<p>åœ¨çŸ¥æ™“äº†é—®é¢˜å‘ç”Ÿçš„æ ¹æºä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æƒ³å‡ºä¸¤ä¸ªåŠæ³•æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ã€‚</p>
<pre><code>1ï¼‰ä¸å…è®¸2å’Œ3é‡æ’åºã€‚
2ï¼‰å…è®¸2å’Œ3é‡æ’åºï¼Œä½†ä¸å…è®¸å…¶ä»–çº¿ç¨‹â€œçœ‹åˆ°â€è¿™ä¸ªé‡æ’åºã€‚
</code></pre>
<h3 id="283-åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ">2.8.3 åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ</h3>
<pre><code class="language-java">public class SafeDoubleCheckedLocking {
    private volatile static Instance instance;

    public static Instance getInstance() {
        if (instance == null) {
            synchronized (SafeDoubleCheckedLocking.class) {
                if (instance == null){
                    instance = new Instance(); // instanceä¸ºvolatileï¼Œç°åœ¨æ²¡é—®é¢˜äº†
                }
            }
            return instance;
        }
    }

}
</code></pre>
<p>å½“å£°æ˜å¯¹è±¡çš„å¼•ç”¨ä¸ºvolatileåï¼Œé€šè¿‡ç¦æ­¢å›¾3-39ä¸­çš„2å’Œ3ä¹‹é—´çš„é‡æ’åºï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹<br>
åŒ–ã€‚</p>
<h3 id="284-åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ">2.8.4 åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ</h3>
<p>JVMåœ¨ç±»çš„åˆå§‹åŒ–é˜¶æ®µï¼ˆå³åœ¨Classè¢«åŠ è½½åï¼Œä¸”è¢«çº¿ç¨‹ä½¿ç”¨ä¹‹å‰ï¼‰ï¼Œä¼šæ‰§è¡Œç±»çš„åˆå§‹åŒ–ã€‚åœ¨æ‰§è¡Œç±»çš„åˆå§‹åŒ–æœŸé—´ï¼ŒJVMä¼šå»è·å–ä¸€ä¸ªé”ã€‚è¿™ä¸ªé”å¯ä»¥åŒæ­¥å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªç±»çš„åˆå§‹åŒ–ã€‚</p>
<pre><code class="language-java">public class InstanceFactory {
    private static class InstanceHolder {
        public static Instance instance = new Instance();
    }
    public static Instance getInstance() {
        return InstanceHolder.instance ; // è¿™é‡Œå°†å¯¼è‡´InstanceHolderç±»è¢«åˆå§‹åŒ–
    }
}
</code></pre>
<h1 id="3-javaå¹¶å‘ç¼–ç¨‹åŸºç¡€">3 Javaå¹¶å‘ç¼–ç¨‹åŸºç¡€</h1>
<h2 id="31-çº¿ç¨‹ç®€ä»‹">3.1 çº¿ç¨‹ç®€ä»‹</h2>
<h3 id="311-ä»€ä¹ˆæ˜¯çº¿ç¨‹">3.1.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹</h3>
<p>æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•å…ƒæ˜¯çº¿ç¨‹ï¼Œä¹Ÿå«è½»é‡çº§è¿›ç¨‹ï¼ˆLightWeight Processï¼‰ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œå¯ä»¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹éƒ½æ‹¥æœ‰å„è‡ªçš„è®¡æ•°å™¨ã€å †æ ˆå’Œå±€éƒ¨å˜é‡ç­‰å±æ€§ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¿é—®å…±äº«çš„å†…å­˜å˜é‡ã€‚</p>
<h3 id="312-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹">3.1.2 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹</h3>
<h3 id="313-çº¿ç¨‹ä¼˜å…ˆçº§">3.1.3 çº¿ç¨‹ä¼˜å…ˆçº§</h3>
<p>ç°ä»£æ“ä½œç³»ç»ŸåŸºæœ¬é‡‡ç”¨æ—¶åˆ†çš„å½¢å¼è°ƒåº¦è¿è¡Œçš„çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†å‡ºä¸€ä¸ªä¸ªæ—¶é—´ç‰‡ï¼Œçº¿ç¨‹ä¼šåˆ†é…åˆ°è‹¥å¹²æ—¶é—´ç‰‡ï¼Œå½“çº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œäº†å°±ä¼šå‘ç”Ÿçº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ç­‰å¾…ç€ä¸‹æ¬¡åˆ†é…ã€‚çº¿ç¨‹åˆ†é…åˆ°çš„æ—¶é—´ç‰‡å¤šå°‘ä¹Ÿå°±å†³å®šäº†çº¿ç¨‹ä½¿ç”¨å¤„ç†å™¨èµ„æºçš„å¤šå°‘ï¼Œè€Œ<strong>çº¿ç¨‹ä¼˜å…ˆçº§å°±æ˜¯å†³å®šçº¿ç¨‹éœ€è¦å¤šæˆ–è€…å°‘åˆ†é…ä¸€äº›å¤„ç†å™¨èµ„æºçš„çº¿ç¨‹å±æ€§</strong>ã€‚</p>
<p>åœ¨Javaçº¿ç¨‹ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªæ•´å‹æˆå‘˜å˜é‡<strong>priority</strong>æ¥æ§åˆ¶ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§çš„èŒƒå›´ä»1~10ï¼Œåœ¨çº¿ç¨‹æ„å»ºçš„æ—¶å€™å¯ä»¥é€šè¿‡setPriority(int)æ–¹æ³•æ¥ä¿®æ”¹ä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¼˜å…ˆçº§æ˜¯5ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡çš„æ•°é‡è¦å¤šäºä¼˜å…ˆçº§ä½çš„çº¿ç¨‹ã€‚è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§æ—¶ï¼Œé’ˆå¯¹é¢‘ç¹é˜»å¡ï¼ˆä¼‘çœ æˆ–è€…I/Oæ“ä½œï¼‰çš„çº¿ç¨‹éœ€è¦è®¾ç½®è¾ƒé«˜ä¼˜å…ˆçº§ï¼Œè€Œåé‡è®¡ç®—ï¼ˆéœ€è¦è¾ƒå¤šCPUæ—¶é—´æˆ–è€…åè¿ç®—ï¼‰çš„çº¿ç¨‹åˆ™è®¾ç½®è¾ƒä½çš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿å¤„ç†å™¨ä¸ä¼šè¢«ç‹¬å ã€‚</p>
<p><em>çº¿ç¨‹ä¼˜å…ˆçº§ä¸èƒ½ä½œä¸ºç¨‹åºæ­£ç¡®æ€§çš„ä¾èµ–ï¼Œåœ¨ä¸åŒçš„JVMä»¥åŠæ“ä½œç³»ç»Ÿä¸Šï¼Œçº¿ç¨‹è§„åˆ’ä¼šå­˜åœ¨å·®å¼‚ï¼Œæœ‰äº›æ“ä½œç³»ç»Ÿç”šè‡³ä¼šå¿½ç•¥å¯¹çº¿ç¨‹ä¼˜å…ˆçº§çš„è®¾å®šã€‚</em></p>
<h3 id="314-çº¿ç¨‹çš„çŠ¶æ€">3.1.4 çº¿ç¨‹çš„çŠ¶æ€</h3>
<p>Javaçº¿ç¨‹åœ¨è¿è¡Œçš„ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½6ç§ä¸åŒçš„çŠ¶æ€ï¼Œåœ¨ç»™å®šçš„ä¸€ä¸ªæ—¶åˆ»ï¼Œçº¿ç¨‹åªèƒ½å¤„äºå…¶ä¸­çš„ä¸€ä¸ªçŠ¶æ€ã€‚</p>
<figure data-type="image" tabindex="12"><img src="https://q456qq520.github.io/post-images/1659946257434.png" alt="Javaçº¿ç¨‹çš„çŠ¶æ€" loading="lazy"></figure>
<p>çº¿ç¨‹åœ¨è‡ªèº«çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¹¶ä¸æ˜¯å›ºå®šåœ°å¤„äºæŸä¸ªçŠ¶æ€ï¼Œè€Œæ˜¯éšç€ä»£ç çš„æ‰§è¡Œåœ¨ä¸åŒçš„çŠ¶æ€ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚</p>
<figure data-type="image" tabindex="13"><img src="https://q456qq520.github.io/post-images/1659946809181.png" alt="Javaçº¿ç¨‹çŠ¶æ€å˜è¿" loading="lazy"></figure>
<p>çº¿ç¨‹åˆ›å»ºä¹‹åï¼Œè°ƒç”¨start()æ–¹æ³•å¼€å§‹è¿è¡Œã€‚å½“çº¿ç¨‹æ‰§è¡Œwait()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹éœ€è¦ä¾é å…¶ä»–çº¿ç¨‹çš„é€šçŸ¥æ‰èƒ½å¤Ÿè¿”å›åˆ°è¿è¡ŒçŠ¶æ€ï¼Œè€Œè¶…æ—¶ç­‰å¾…çŠ¶æ€ç›¸å½“äºåœ¨ç­‰å¾…çŠ¶æ€çš„åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¶…æ—¶æ—¶é—´åˆ°è¾¾æ—¶å°†ä¼šè¿”å›åˆ°è¿è¡ŒçŠ¶æ€ã€‚å½“çº¿ç¨‹è°ƒç”¨åŒæ­¥æ–¹æ³•æ—¶ï¼Œåœ¨æ²¡æœ‰è·å–åˆ°é”çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹å°†ä¼šè¿›å…¥åˆ°é˜»å¡çŠ¶æ€ã€‚çº¿ç¨‹åœ¨æ‰§è¡ŒRunnableçš„run()æ–¹æ³•ä¹‹åå°†ä¼šè¿›å…¥åˆ°ç»ˆæ­¢çŠ¶æ€ã€‚</p>
<p><em>æ³¨æ„ Javaå°†æ“ä½œç³»ç»Ÿä¸­çš„è¿è¡Œå’Œå°±ç»ªä¸¤ä¸ªçŠ¶æ€åˆå¹¶ç§°ä¸ºè¿è¡ŒçŠ¶æ€ã€‚é˜»å¡çŠ¶æ€æ˜¯çº¿ç¨‹é˜»å¡åœ¨è¿›å…¥synchronizedå…³é”®å­—ä¿®é¥°çš„æ–¹æ³•æˆ–ä»£ç å—ï¼ˆè·å–é”ï¼‰æ—¶çš„çŠ¶æ€ï¼Œä½†æ˜¯é˜»å¡åœ¨java.concurrentåŒ…ä¸­Lockæ¥å£çš„çº¿ç¨‹çŠ¶æ€å´æ˜¯ç­‰å¾…çŠ¶æ€ï¼Œå› ä¸ºjava.concurrentåŒ…ä¸­Lockæ¥å£å¯¹äºé˜»å¡çš„å®ç°å‡ä½¿ç”¨äº†LockSupportç±»ä¸­çš„ç›¸å…³æ–¹æ³•ã€‚</em></p>
<h3 id="315-daemonçº¿ç¨‹å®ˆæŠ¤çº¿ç¨‹">3.1.5 Daemonçº¿ç¨‹ï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰</h3>
<p>Daemonçº¿ç¨‹æ˜¯ä¸€ç§æ”¯æŒå‹çº¿ç¨‹ï¼Œå› ä¸ºå®ƒä¸»è¦è¢«ç”¨ä½œç¨‹åºä¸­åå°è°ƒåº¦ä»¥åŠæ”¯æŒæ€§å·¥ä½œã€‚è¿™æ„å‘³ç€ï¼Œå½“ä¸€ä¸ªJavaè™šæ‹Ÿæœºä¸­ä¸å­˜åœ¨éDaemonçº¿ç¨‹çš„æ—¶å€™ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šé€€å‡ºã€‚å¯ä»¥é€šè¿‡è°ƒç”¨Thread.setDaemon(true)å°†çº¿ç¨‹è®¾ç½®ä¸ºDaemonçº¿ç¨‹ã€‚</p>
<p><strong>Daemonå±æ€§éœ€è¦åœ¨å¯åŠ¨çº¿ç¨‹ä¹‹å‰è®¾ç½®ï¼Œä¸èƒ½åœ¨å¯åŠ¨çº¿ç¨‹ä¹‹åè®¾ç½®ã€‚</strong></p>
<p>Daemonçº¿ç¨‹è¢«ç”¨ä½œå®Œæˆæ”¯æŒæ€§å·¥ä½œï¼Œä½†æ˜¯åœ¨Javaè™šæ‹Ÿæœºé€€å‡ºæ—¶Daemonçº¿ç¨‹ä¸­çš„finallyå—å¹¶ä¸ä¸€å®šä¼šæ‰§è¡Œã€‚</p>
<pre><code class="language-java">package cm;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/8 16:32
 */
public class DaemonThread {
    public static void main(String[] args) {
        Thread thread = new Thread(new DaemonRunner(), &quot;DaemonRunner&quot;);
        thread.setDaemon(true);
        thread.start();
    }
    
    static class DaemonRunner implements Runnable {
        @Override
        public void run() {
            try {
                SleepUtils.second(10);
            } finally {
                System.out.println(&quot;DaemonThread finally run.&quot;);
            }
        }
    }
}
</code></pre>
<p>è¿è¡ŒDaemonç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°åœ¨ç»ˆç«¯æˆ–è€…å‘½ä»¤æç¤ºç¬¦ä¸Šæ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚mainçº¿ç¨‹ï¼ˆéDaemonçº¿ç¨‹ï¼‰åœ¨å¯åŠ¨äº†çº¿ç¨‹DaemonRunnerä¹‹åéšç€mainæ–¹æ³•æ‰§è¡Œå®Œæ¯•è€Œç»ˆæ­¢ï¼Œè€Œæ­¤æ—¶Javaè™šæ‹Ÿæœºä¸­å·²ç»æ²¡æœ‰éDaemonçº¿ç¨‹ï¼Œè™šæ‹Ÿæœºéœ€è¦é€€å‡ºã€‚Javaè™šæ‹Ÿæœºä¸­çš„æ‰€æœ‰Daemonçº¿ç¨‹éƒ½éœ€è¦ç«‹å³ç»ˆæ­¢ï¼Œå› æ­¤DaemonRunnerç«‹å³ç»ˆæ­¢ï¼Œä½†æ˜¯DaemonRunnerä¸­çš„finallyå—å¹¶æ²¡æœ‰æ‰§è¡Œã€‚</p>
<p><em>æ³¨æ„ åœ¨æ„å»ºDaemonçº¿ç¨‹æ—¶ï¼Œä¸èƒ½ä¾é finallyå—ä¸­çš„å†…å®¹æ¥ç¡®ä¿æ‰§è¡Œå…³é—­æˆ–æ¸…ç†èµ„æºçš„é€»è¾‘ã€‚</em></p>
<h2 id="32-å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹">3.2 å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹</h2>
<h3 id="321-æ„é€ çº¿ç¨‹">3.2.1 æ„é€ çº¿ç¨‹</h3>
<p>åœ¨è¿è¡Œçº¿ç¨‹ä¹‹å‰é¦–å…ˆè¦æ„é€ ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œçº¿ç¨‹å¯¹è±¡åœ¨æ„é€ çš„æ—¶å€™éœ€è¦æä¾›çº¿ç¨‹æ‰€éœ€è¦çš„å±æ€§ï¼Œå¦‚çº¿ç¨‹æ‰€å±çš„çº¿ç¨‹ç»„ã€çº¿ç¨‹ä¼˜å…ˆçº§ã€æ˜¯å¦æ˜¯Daemonçº¿ç¨‹ç­‰ä¿¡æ¯ã€‚</p>
<p>ä¸‹é¢æ˜¯java.lang.Threadä¸­å¯¹çº¿ç¨‹è¿›è¡Œåˆå§‹åŒ–ï¼š</p>
<pre><code class="language-java">private void init(ThreadGroup g, Runnable target, String name,
                      long stackSize, AccessControlContext acc,
                      boolean inheritThreadLocals) {
        if (name == null) {
            throw new NullPointerException(&quot;name cannot be null&quot;);
        }

        this.name = name;
        //å½“å‰çº¿ç¨‹å°±æ˜¯è¯¥çº¿ç¨‹çš„çˆ¶çº¿ç¨‹
        Thread parent = currentThread();
        SecurityManager security = System.getSecurityManager();
        if (g == null) {
            /* Determine if it's an applet or not */

            /* If there is a security manager, ask the security manager
               what to do. */
            if (security != null) {
                g = security.getThreadGroup();
            }

            /* If the security doesn't have a strong opinion of the matter
               use the parent thread group. */
            if (g == null) {
                g = parent.getThreadGroup();
            }
        }

        /* checkAccess regardless of whether or not threadgroup is
           explicitly passed in. */
        g.checkAccess();

        /*
         * Do we have the required permissions?
         */
        if (security != null) {
            if (isCCLOverridden(getClass())) {
                security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);
            }
        }

        g.addUnstarted();

        this.group = g;
        // å°†daemonã€priorityå±æ€§è®¾ç½®ä¸ºçˆ¶çº¿ç¨‹çš„å¯¹åº”å±æ€§
        this.daemon = parent.isDaemon();
        this.priority = parent.getPriority();
        if (security == null || isCCLOverridden(parent.getClass()))
            this.contextClassLoader = parent.getContextClassLoader();
        else
            this.contextClassLoader = parent.contextClassLoader;
        this.inheritedAccessControlContext =
                acc != null ? acc : AccessController.getContext();
        this.target = target;
        setPriority(priority);
        // å°†çˆ¶çº¿ç¨‹çš„InheritableThreadLocalå¤åˆ¶è¿‡æ¥
        if (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != null)
            this.inheritableThreadLocals =
                ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);
        /* Stash the specified stack size in case the VM cares */
        this.stackSize = stackSize;

        /* Set thread ID åˆ†é…ä¸€ä¸ªçº¿ç¨‹ID */
        tid = nextThreadID();
    }
</code></pre>
<p>ä¸€ä¸ªæ–°æ„é€ çš„çº¿ç¨‹å¯¹è±¡æ˜¯ç”±å…¶parentçº¿ç¨‹æ¥è¿›è¡Œç©ºé—´åˆ†é…çš„ï¼Œè€Œchildçº¿ç¨‹ç»§æ‰¿äº†parentæ˜¯å¦ä¸ºDaemonã€ä¼˜å…ˆçº§å’ŒåŠ è½½èµ„æºçš„contextClassLoaderä»¥åŠå¯ç»§æ‰¿çš„ThreadLocalï¼ŒåŒæ—¶è¿˜ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„IDæ¥æ ‡è¯†è¿™ä¸ªchildçº¿ç¨‹ã€‚è‡³æ­¤ï¼Œä¸€ä¸ªèƒ½å¤Ÿè¿è¡Œçš„çº¿ç¨‹å¯¹è±¡å°±åˆå§‹åŒ–å¥½äº†ï¼Œåœ¨å †å†…å­˜ä¸­ç­‰å¾…ç€è¿è¡Œã€‚</p>
<h3 id="322-å¯åŠ¨çº¿ç¨‹">3.2.2 å¯åŠ¨çº¿ç¨‹</h3>
<p>çº¿ç¨‹å¯¹è±¡åœ¨åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œè°ƒç”¨start()æ–¹æ³•å°±å¯ä»¥å¯åŠ¨è¿™ä¸ªçº¿ç¨‹ã€‚çº¿ç¨‹start()æ–¹æ³•çš„å«ä¹‰æ˜¯ï¼šå½“å‰çº¿ç¨‹ï¼ˆå³parentçº¿ç¨‹ï¼‰åŒæ­¥å‘ŠçŸ¥Javaè™šæ‹Ÿæœºï¼Œåªè¦çº¿ç¨‹è§„åˆ’å™¨ç©ºé—²ï¼Œåº”ç«‹å³å¯åŠ¨è°ƒç”¨start()æ–¹æ³•çš„çº¿ç¨‹ã€‚</p>
<p><em>æ³¨æ„ å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å‰ï¼Œæœ€å¥½ä¸ºè¿™ä¸ªçº¿ç¨‹è®¾ç½®çº¿ç¨‹åç§°ï¼Œå› ä¸ºè¿™æ ·åœ¨ä½¿ç”¨jstackåˆ†æç¨‹åºæˆ–è€…è¿›è¡Œé—®é¢˜æ’æŸ¥æ—¶ï¼Œå°±ä¼šç»™å¼€å‘äººå‘˜æä¾›ä¸€äº›æç¤ºï¼Œè‡ªå®šä¹‰çš„çº¿ç¨‹æœ€å¥½èƒ½å¤Ÿèµ·ä¸ªåå­—ã€‚</em></p>
<h3 id="323-ç†è§£ä¸­æ–­">3.2.3 ç†è§£ä¸­æ–­</h3>
<p>ä¸­æ–­å¯ä»¥ç†è§£ä¸ºçº¿ç¨‹çš„ä¸€ä¸ªæ ‡è¯†ä½å±æ€§ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªè¿è¡Œä¸­çš„çº¿ç¨‹æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­æ“ä½œã€‚ä¸­æ–­å¥½æ¯”å…¶ä»–çº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æ‰“äº†ä¸ªæ‹›å‘¼ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡è°ƒç”¨è¯¥çº¿ç¨‹çš„**interrupt()**æ–¹æ³•å¯¹å…¶è¿›è¡Œä¸­æ–­æ“ä½œã€‚</p>
<p>çº¿ç¨‹é€šè¿‡æ£€æŸ¥è‡ªèº«æ˜¯å¦è¢«ä¸­æ–­æ¥è¿›è¡Œå“åº”ï¼Œçº¿ç¨‹é€šè¿‡æ–¹æ³•isInterrupted()æ¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨é™æ€æ–¹æ³•Thread.interrupted()å¯¹å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è¯†ä½è¿›è¡Œå¤ä½ã€‚å¦‚æœè¯¥çº¿ç¨‹å·²ç»å¤„äºç»ˆç»“çŠ¶æ€ï¼Œå³ä½¿è¯¥çº¿ç¨‹è¢«ä¸­æ–­è¿‡ï¼Œåœ¨è°ƒç”¨è¯¥çº¿ç¨‹å¯¹è±¡çš„isInterrupted()æ—¶ä¾æ—§ä¼šè¿”å›falseã€‚</p>
<p>ä»Javaçš„APIä¸­å¯ä»¥çœ‹åˆ°ï¼Œè®¸å¤šå£°æ˜æŠ›å‡ºInterruptedExceptionçš„æ–¹æ³•ï¼ˆä¾‹å¦‚Thread.sleep(long<br>
millis)æ–¹æ³•ï¼‰è¿™äº›æ–¹æ³•åœ¨æŠ›å‡ºInterruptedExceptionä¹‹å‰ï¼ŒJavaè™šæ‹Ÿæœºä¼šå…ˆå°†è¯¥çº¿ç¨‹çš„ä¸­æ–­æ ‡è¯†ä½æ¸…é™¤ï¼Œç„¶åæŠ›å‡ºInterruptedExceptionï¼Œæ­¤æ—¶è°ƒç”¨isInterrupted()æ–¹æ³•å°†ä¼šè¿”å›falseã€‚</p>
<p>åœ¨ä¸‹è¿°ä¾‹å­ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼ŒSleepThreadå’ŒBusyThreadï¼Œå‰è€…ä¸åœåœ°ç¡çœ ï¼Œåè€…ä¸€ç›´è¿è¡Œï¼Œç„¶åå¯¹è¿™ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡Œä¸­æ–­æ“ä½œï¼Œè§‚å¯ŸäºŒè€…çš„ä¸­æ–­æ ‡è¯†ä½ã€‚</p>
<pre><code class="language-java">package cm;

import java.util.concurrent.TimeUnit;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/8 18:08
 */
public class Interrupted {
    public static void main(String[] args) throws Exception {
        // sleepThreadä¸åœçš„å°è¯•ç¡çœ 
        Thread sleepThread = new Thread(new SleepRunner(), &quot;SleepThread&quot;);
        sleepThread.setDaemon(true);
        // busyThreadä¸åœçš„è¿è¡Œ
        Thread busyThread = new Thread(new BusyRunner(), &quot;BusyThread&quot;);
        busyThread.setDaemon(true);
        sleepThread.start();
        busyThread.start();
        // ä¼‘çœ 5ç§’ï¼Œè®©sleepThreadå’ŒbusyThreadå……åˆ†è¿è¡Œ
        TimeUnit.SECONDS.sleep(5);
        sleepThread.interrupt();
        busyThread.interrupt();
        System.out.println(&quot;SleepThread interrupted is &quot; + sleepThread.isInterrupted());
        System.out.println(&quot;BusyThread interrupted is &quot; + busyThread.isInterrupted());
        // é˜²æ­¢sleepThreadå’ŒbusyThreadç«‹åˆ»é€€å‡º
        SleepUtils.second(2);
    }
    static class SleepRunner implements Runnable {
        @Override
        public void run() {
            while (true) {
                SleepUtils.second(10);
            }
        }
    }
    static class BusyRunner implements Runnable {
        @Override
        public void run() {
            while (true) {
            }
        }
    }
}
</code></pre>
<pre><code>è¾“å‡ºï¼š
SleepThread interrupted is false
BusyThread interrupted is true
</code></pre>
<p>ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒæŠ›å‡ºInterruptedExceptionçš„çº¿ç¨‹SleepThreadï¼Œå…¶ä¸­æ–­æ ‡è¯†ä½è¢«æ¸…é™¤äº†ï¼Œè€Œä¸€ç›´å¿™ç¢Œè¿ä½œçš„çº¿ç¨‹BusyThreadï¼Œä¸­æ–­æ ‡è¯†ä½æ²¡æœ‰è¢«æ¸…é™¤ã€‚</p>
<h3 id="324-è¿‡æœŸçš„suspend-resumeå’Œstop">3.2.4 è¿‡æœŸçš„suspend()ã€resume()å’Œstop()</h3>
<p>åœ¨ä¸‹é¢æ‰€ç¤ºçš„ä¾‹å­ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹PrintThreadï¼Œå®ƒä»¥1ç§’çš„é¢‘ç‡è¿›è¡Œæ‰“å°ï¼Œè€Œä¸»çº¿ç¨‹å¯¹å…¶è¿›è¡Œæš‚åœã€æ¢å¤å’Œåœæ­¢æ“ä½œã€‚</p>
<pre><code class="language-java">package cm;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.concurrent.TimeUnit;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/9 11:14
 */
public class Deprecated {
    public static void main(String[] args) throws Exception {
        DateFormat format = new SimpleDateFormat(&quot;HH:mm:ss&quot;);
        Thread printThread = new Thread(new Runner(), &quot;PrintThread&quot;);
        printThread.setDaemon(true);
        printThread.start();
        TimeUnit.SECONDS.sleep(3);
        // å°†PrintThreadè¿›è¡Œæš‚åœï¼Œè¾“å‡ºå†…å®¹å·¥ä½œåœæ­¢
        printThread.suspend();
        System.out.println(&quot;main suspend PrintThread at &quot; + format.format(new Date());
        TimeUnit.SECONDS.sleep(3);
        // å°†PrintThreadè¿›è¡Œæ¢å¤ï¼Œè¾“å‡ºå†…å®¹ç»§ç»­
        printThread.resume();
        System.out.println(&quot;main resume PrintThread at &quot; + format.format(new Date()));
        TimeUnit.SECONDS.sleep(3);
        // å°†PrintThreadè¿›è¡Œç»ˆæ­¢ï¼Œè¾“å‡ºå†…å®¹åœæ­¢
        printThread.stop();
        System.out.println(&quot;main stop PrintThread at &quot; + format.format(new Date()));
        TimeUnit.SECONDS.sleep(3);
    }

    static class Runner implements Runnable {
        @Override
        public void run() {
            DateFormat format = new SimpleDateFormat(&quot;HH:mm:ss&quot;);
            while (true) {
                System.out.println(Thread.currentThread().getName() + &quot; Run at &quot; +
                        format.format(new Date()));
                SleepUtils.second(1);
            }
        }
    }
}
</code></pre>
<p>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒPrintThreadè¿è¡Œäº†3ç§’ï¼Œéšåè¢«æš‚åœï¼Œ3ç§’åæ¢å¤ï¼Œæœ€åç»è¿‡3ç§’è¢«ç»ˆæ­¢ã€‚é€šè¿‡ç¤ºä¾‹çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œsuspend()ã€resume()å’Œstop()æ–¹æ³•å®Œæˆäº†çº¿ç¨‹çš„æš‚åœã€æ¢å¤å’Œç»ˆæ­¢å·¥ä½œï¼Œè€Œä¸”éå¸¸â€œäººæ€§åŒ–â€ã€‚ä½†æ˜¯è¿™äº›APIæ˜¯è¿‡æœŸçš„ï¼Œä¹Ÿå°±æ˜¯ä¸å»ºè®®ä½¿ç”¨çš„ã€‚</p>
<p>ä¸å»ºè®®ä½¿ç”¨çš„åŸå› ä¸»è¦æœ‰ï¼šä»¥suspend()æ–¹æ³•ä¸ºä¾‹ï¼Œåœ¨è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šé‡Šæ”¾å·²ç»å æœ‰çš„èµ„æºï¼ˆæ¯”å¦‚é”ï¼‰ï¼Œè€Œæ˜¯å æœ‰ç€èµ„æºè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè¿™æ ·å®¹æ˜“å¼•å‘æ­»é”é—®é¢˜ã€‚åŒæ ·ï¼Œstop()æ–¹æ³•åœ¨ç»ˆç»“ä¸€ä¸ªçº¿ç¨‹æ—¶ä¸ä¼šä¿è¯çº¿ç¨‹çš„èµ„æºæ­£å¸¸é‡Šæ”¾ï¼Œé€šå¸¸æ˜¯æ²¡æœ‰ç»™äºˆçº¿ç¨‹å®Œæˆèµ„æºé‡Šæ”¾å·¥ä½œçš„æœºä¼šï¼Œå› æ­¤ä¼šå¯¼è‡´ç¨‹åºå¯èƒ½å·¥ä½œåœ¨ä¸ç¡®å®šçŠ¶æ€ä¸‹ã€‚</p>
<p><em>æš‚åœå’Œæ¢å¤æ“ä½œå¯ä»¥ç”¨åé¢æåˆ°çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶æ¥æ›¿ä»£ã€‚</em></p>
<h3 id="325-å®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹">3.2.5 å®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹</h3>
<p>ä¸­æ–­çŠ¶æ€æ˜¯çº¿ç¨‹çš„ä¸€ä¸ªæ ‡è¯†ä½ï¼Œè€Œä¸­æ–­æ“ä½œæ˜¯ä¸€ç§ç®€ä¾¿çš„çº¿ç¨‹é—´äº¤äº’æ–¹å¼ï¼Œè€Œè¿™ç§äº¤äº’æ–¹å¼æœ€é€‚åˆç”¨æ¥å–æ¶ˆæˆ–åœæ­¢ä»»åŠ¡ã€‚é™¤äº†ä¸­æ–­ä»¥å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨ä¸€ä¸ªbooleanå˜é‡æ¥æ§åˆ¶æ˜¯å¦éœ€è¦åœæ­¢ä»»åŠ¡å¹¶ç»ˆæ­¢è¯¥çº¿ç¨‹ã€‚</p>
<p>åœ¨ä¸‹é¢æ‰€ç¤ºçš„ä¾‹å­ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹CountThreadï¼Œå®ƒä¸æ–­åœ°è¿›è¡Œå˜é‡ç´¯åŠ ï¼Œè€Œä¸»çº¿ç¨‹å°è¯•å¯¹å…¶è¿›è¡Œä¸­æ–­æ“ä½œå’Œåœæ­¢æ“ä½œã€‚</p>
<pre><code class="language-java">package cm;

import java.util.concurrent.TimeUnit;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/9 11:21
 */
public class Shutdown {
    public static void main(String[] args) throws Exception {
        Runner one = new Runner();
        Thread countThread = new Thread(one, &quot;CountThread&quot;);
        countThread.start();
        // ç¡çœ 1ç§’ï¼Œmainçº¿ç¨‹å¯¹CountThreadè¿›è¡Œä¸­æ–­ï¼Œä½¿CountThreadèƒ½å¤Ÿæ„ŸçŸ¥ä¸­æ–­è€Œç»“æŸ
        TimeUnit.SECONDS.sleep(1);
        countThread.interrupt();
        Runner two = new Runner();
        countThread = new Thread(two, &quot;CountThread&quot;);
        countThread.start();
        // ç¡çœ 1ç§’ï¼Œmainçº¿ç¨‹å¯¹Runner twoè¿›è¡Œå–æ¶ˆï¼Œä½¿CountThreadèƒ½å¤Ÿæ„ŸçŸ¥onä¸ºfalseè€Œç»“æŸ
        TimeUnit.SECONDS.sleep(1);
        two.cancel();
    }
    private static class Runner implements Runnable {
        private long i;
        private volatile boolean on = true;
        @Override
        public void run() {
            while (on &amp;&amp; !Thread.currentThread().isInterrupted()){
                i++;
            }
            System.out.println(&quot;Count i = &quot; + i);
        }
        public void cancel() {
            on = false;
        }
    }
}
</code></pre>
<p>mainçº¿ç¨‹é€šè¿‡ä¸­æ–­æ“ä½œå’Œcancel()æ–¹æ³•å‡å¯ä½¿CountThreadå¾—ä»¥ç»ˆæ­¢ã€‚è¿™ç§é€šè¿‡æ ‡è¯†ä½æˆ–è€…ä¸­æ–­æ“ä½œçš„æ–¹å¼èƒ½å¤Ÿä½¿çº¿ç¨‹åœ¨ç»ˆæ­¢æ—¶æœ‰æœºä¼šå»æ¸…ç†èµ„æºï¼Œè€Œä¸æ˜¯æ­¦æ–­åœ°å°†çº¿ç¨‹åœæ­¢ï¼Œå› æ­¤è¿™ç§ç»ˆæ­¢çº¿ç¨‹çš„åšæ³•æ˜¾å¾—æ›´åŠ å®‰å…¨å’Œä¼˜é›…ã€‚</p>
<h2 id="33-çº¿ç¨‹é—´é€šä¿¡">3.3 çº¿ç¨‹é—´é€šä¿¡</h2>
<h3 id="331-volatileå’Œsynchronizedå…³é”®å­—">3.3.1 volatileå’Œsynchronizedå…³é”®å­—</h3>
<p>Javaæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªå¯¹è±¡æˆ–è€…å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œç”±äºæ¯ä¸ªçº¿ç¨‹å¯ä»¥æ‹¥æœ‰è¿™ä¸ªå˜é‡çš„æ‹·è´ï¼ˆè™½ç„¶å¯¹è±¡ä»¥åŠæˆå‘˜å˜é‡åˆ†é…çš„å†…å­˜æ˜¯åœ¨å…±äº«å†…å­˜ä¸­çš„ï¼Œä½†æ˜¯æ¯ä¸ªæ‰§è¡Œçš„çº¿ç¨‹è¿˜æ˜¯å¯ä»¥æ‹¥æœ‰ä¸€ä»½æ‹·è´ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯åŠ é€Ÿç¨‹åºçš„æ‰§è¡Œï¼‰ï¼Œæ‰€ä»¥ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹çœ‹åˆ°çš„å˜é‡å¹¶ä¸ä¸€å®šæ˜¯æœ€æ–°çš„ã€‚</p>
<p>å…³é”®å­—<strong>volatile</strong>å¯ä»¥ç”¨æ¥ä¿®é¥°å­—æ®µï¼ˆæˆå‘˜å˜é‡ï¼‰ï¼Œå°±æ˜¯å‘ŠçŸ¥ç¨‹åºä»»ä½•å¯¹è¯¥å˜é‡çš„è®¿é—®å‡éœ€è¦ä»å…±äº«å†…å­˜ä¸­è·å–ï¼Œè€Œå¯¹å®ƒçš„æ”¹å˜å¿…é¡»åŒæ­¥åˆ·æ–°å›å…±äº«å†…å­˜ï¼Œå®ƒèƒ½ä¿è¯æ‰€æœ‰çº¿ç¨‹å¯¹å˜é‡è®¿é—®çš„å¯è§æ€§ã€‚</p>
<p>å…³é”®å­—<strong>synchronized</strong>å¯ä»¥ä¿®é¥°æ–¹æ³•æˆ–è€…ä»¥åŒæ­¥å—çš„å½¢å¼æ¥è¿›è¡Œä½¿ç”¨ï¼Œå®ƒä¸»è¦ç¡®ä¿å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„äºæ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­ï¼Œå®ƒä¿è¯äº†çº¿ç¨‹å¯¹å˜é‡è®¿é—®çš„å¯è§æ€§å’Œæ’ä»–æ€§ã€‚</p>
<p>ä»»æ„ä¸€ä¸ªå¯¹è±¡éƒ½æ‹¥æœ‰è‡ªå·±çš„<strong>ç›‘è§†å™¨</strong>ï¼Œå½“è¿™ä¸ªå¯¹è±¡ç”±åŒæ­¥å—æˆ–è€…è¿™ä¸ªå¯¹è±¡çš„åŒæ­¥æ–¹æ³•è°ƒç”¨æ—¶ï¼Œæ‰§è¡Œæ–¹æ³•çš„çº¿ç¨‹å¿…é¡»å…ˆè·å–åˆ°è¯¥å¯¹è±¡çš„ç›‘è§†å™¨æ‰èƒ½è¿›å…¥åŒæ­¥å—æˆ–è€…åŒæ­¥æ–¹æ³•ï¼Œè€Œæ²¡æœ‰è·å–åˆ°ç›‘è§†å™¨ï¼ˆæ‰§è¡Œè¯¥æ–¹æ³•ï¼‰çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡åœ¨åŒæ­¥å—å’ŒåŒæ­¥æ–¹æ³•çš„å…¥å£å¤„ï¼Œè¿›å…¥BLOCKEDçŠ¶æ€ã€‚æ— è®ºé‡‡ç”¨å“ªç§æ–¹å¼ï¼Œå…¶æœ¬è´¨æ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡çš„ç›‘è§†å™¨ï¼ˆmonitorï¼‰è¿›è¡Œè·å–ï¼Œè€Œè¿™ä¸ªè·å–è¿‡ç¨‹æ˜¯æ’ä»–çš„ï¼Œä¹Ÿå°±æ˜¯åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°ç”±synchronizedæ‰€ä¿æŠ¤å¯¹è±¡çš„ç›‘è§†å™¨ã€‚</p>
<figure data-type="image" tabindex="14"><img src="https://q456qq520.github.io/post-images/1660025976820.png" alt="å¯¹è±¡ã€ç›‘è§†å™¨ã€åŒæ­¥é˜Ÿåˆ—å’Œæ‰§è¡Œçº¿ç¨‹ä¹‹é—´çš„å…³ç³»" loading="lazy"></figure>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä»»æ„çº¿ç¨‹å¯¹Objectï¼ˆObjectç”±synchronizedä¿æŠ¤ï¼‰çš„è®¿é—®ï¼Œé¦–å…ˆè¦è·å¾—Objectçš„ç›‘è§†å™¨ã€‚å¦‚æœè·å–å¤±è´¥ï¼Œçº¿ç¨‹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œçº¿ç¨‹çŠ¶æ€å˜ä¸ºBLOCKEDã€‚å½“è®¿é—®Objectçš„å‰é©±ï¼ˆè·å¾—äº†é”çš„çº¿ç¨‹ï¼‰é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥é‡Šæ”¾æ“ä½œå”¤é†’é˜»å¡åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œä½¿å…¶é‡æ–°å°è¯•å¯¹ç›‘è§†å™¨çš„è·å–ã€‚</p>
<h3 id="332-ç­‰å¾…é€šçŸ¥æœºåˆ¶">3.3.2 ç­‰å¾…/é€šçŸ¥æœºåˆ¶</h3>
<p>ç­‰å¾…/é€šçŸ¥çš„ç›¸å…³æ–¹æ³•æ˜¯ä»»æ„Javaå¯¹è±¡éƒ½å…·å¤‡çš„ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•è¢«å®šä¹‰åœ¨æ‰€æœ‰å¯¹è±¡çš„è¶…ç±»java.lang.Objectä¸Šã€‚</p>
<figure data-type="image" tabindex="15"><img src="https://q456qq520.github.io/post-images/1660026163692.png" alt="ç­‰å¾…/é€šçŸ¥çš„ç›¸å…³æ–¹æ³•" loading="lazy"></figure>
<p>ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œæ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨äº†å¯¹è±¡Oçš„wait()æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹Bè°ƒç”¨äº†å¯¹è±¡Oçš„notify()æˆ–è€…notifyAll()æ–¹æ³•ï¼Œçº¿ç¨‹Aæ”¶åˆ°é€šçŸ¥åä»å¯¹è±¡Oçš„wait()æ–¹æ³•è¿”å›ï¼Œè¿›è€Œæ‰§è¡Œåç»­æ“ä½œã€‚ä¸Šè¿°ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡å¯¹è±¡Oæ¥å®Œæˆäº¤äº’ï¼Œè€Œå¯¹è±¡ä¸Šçš„wait()å’Œnotify/notifyAll()çš„å…³ç³»å°±å¦‚åŒå¼€å…³ä¿¡å·ä¸€æ ·ï¼Œç”¨æ¥å®Œæˆç­‰å¾…æ–¹å’Œé€šçŸ¥æ–¹ä¹‹é—´çš„äº¤äº’å·¥ä½œã€‚</p>
<p>è°ƒç”¨wait()ã€notify()ä»¥åŠnotifyAll()æ—¶éœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼Œå¦‚ä¸‹ã€‚</p>
<pre><code>1ï¼‰ä½¿ç”¨wait()ã€notify()å’ŒnotifyAll()æ—¶éœ€è¦å…ˆå¯¹è°ƒç”¨å¯¹è±¡åŠ é”ã€‚
2ï¼‰è°ƒç”¨wait()æ–¹æ³•åï¼Œçº¿ç¨‹çŠ¶æ€ç”±RUNNINGå˜ä¸ºWAITINGï¼Œå¹¶å°†å½“å‰çº¿ç¨‹æ”¾ç½®åˆ°å¯¹è±¡çš„ç­‰å¾…é˜Ÿåˆ—ã€‚
3ï¼‰notify()æˆ–notifyAll()æ–¹æ³•è°ƒç”¨åï¼Œç­‰å¾…çº¿ç¨‹ä¾æ—§ä¸ä¼šä»wait()è¿”å›ï¼Œéœ€è¦è°ƒç”¨notify()æˆ–notifAll()çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œç­‰å¾…çº¿ç¨‹æ‰æœ‰æœºä¼šä»wait()è¿”å›ã€‚
4ï¼‰notify()æ–¹æ³•å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œè€ŒnotifyAll()æ–¹æ³•åˆ™æ˜¯å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„çº¿ç¨‹å…¨éƒ¨ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè¢«ç§»åŠ¨çš„çº¿ç¨‹çŠ¶æ€ç”±WAITINGå˜ä¸ºBLOCKEDã€‚
5ï¼‰ä»wait()æ–¹æ³•è¿”å›çš„å‰ææ˜¯è·å¾—äº†è°ƒç”¨å¯¹è±¡çš„é”ã€‚
</code></pre>
<p>ç­‰å¾…/é€šçŸ¥æœºåˆ¶ä¾æ‰˜äºåŒæ­¥æœºåˆ¶ï¼Œå…¶ç›®çš„å°±æ˜¯ç¡®ä¿ç­‰å¾…çº¿ç¨‹ä»wait()æ–¹æ³•è¿”å›æ—¶èƒ½å¤Ÿæ„ŸçŸ¥åˆ°é€šçŸ¥çº¿ç¨‹å¯¹å˜é‡åšå‡ºçš„ä¿®æ”¹ã€‚</p>
<h3 id="333-ç­‰å¾…é€šçŸ¥çš„ç»å…¸èŒƒå¼">3.3.3 ç­‰å¾…/é€šçŸ¥çš„ç»å…¸èŒƒå¼</h3>
<p>è¯¥èŒƒå¼åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«é’ˆå¯¹<strong>ç­‰å¾…æ–¹</strong>ï¼ˆæ¶ˆè´¹è€…ï¼‰å’Œ<strong>é€šçŸ¥æ–¹</strong>ï¼ˆç”Ÿäº§è€…ï¼‰ã€‚</p>
<p>ç­‰å¾…æ–¹éµå¾ªå¦‚ä¸‹åŸåˆ™ã€‚</p>
<pre><code>1ï¼‰è·å–å¯¹è±¡çš„é”ã€‚
2ï¼‰å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆè°ƒç”¨å¯¹è±¡çš„wait()æ–¹æ³•ï¼Œè¢«é€šçŸ¥åä»è¦æ£€æŸ¥æ¡ä»¶ã€‚
3ï¼‰æ¡ä»¶æ»¡è¶³åˆ™æ‰§è¡Œå¯¹åº”çš„é€»è¾‘ã€‚
</code></pre>
<pre><code class="language-java">synchronized(å¯¹è±¡) {
        while(æ¡ä»¶ä¸æ»¡è¶³) {
        å¯¹è±¡.wait();
        }
        å¯¹åº”çš„å¤„ç†é€»è¾‘
}
</code></pre>
<p>é€šçŸ¥æ–¹éµå¾ªå¦‚ä¸‹åŸåˆ™ã€‚</p>
<pre><code>1ï¼‰è·å¾—å¯¹è±¡çš„é”ã€‚
2ï¼‰æ”¹å˜æ¡ä»¶ã€‚
3ï¼‰é€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨å¯¹è±¡ä¸Šçš„çº¿ç¨‹ã€‚
</code></pre>
<pre><code class="language-java">synchronized(å¯¹è±¡) {
    æ”¹å˜æ¡ä»¶
    å¯¹è±¡.notifyAll();
}
</code></pre>
<h3 id="334-ç®¡é“è¾“å…¥è¾“å‡ºæµ">3.3.4 ç®¡é“è¾“å…¥/è¾“å‡ºæµ</h3>
<p>ç®¡é“è¾“å…¥/è¾“å‡ºæµå’Œæ™®é€šçš„æ–‡ä»¶è¾“å…¥/è¾“å‡ºæµæˆ–è€…ç½‘ç»œè¾“å…¥/è¾“å‡ºæµä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä¸»è¦ç”¨äºçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œè€Œä¼ è¾“çš„åª’ä»‹ä¸ºå†…å­˜ã€‚</p>
<p>ç®¡é“è¾“å…¥/è¾“å‡ºæµä¸»è¦åŒ…æ‹¬äº†å¦‚ä¸‹4ç§å…·ä½“å®ç°ï¼šPipedOutputStreamã€PipedInputStreamã€PipedReaderå’ŒPipedWriterï¼Œå‰ä¸¤ç§é¢å‘å­—èŠ‚ï¼Œè€Œåä¸¤ç§é¢å‘å­—ç¬¦ã€‚</p>
<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹,åˆ›å»ºäº†printThreadï¼Œå®ƒç”¨æ¥æ¥å—mainçº¿ç¨‹çš„è¾“å…¥ï¼Œä»»ä½•mainçº¿ç¨‹çš„è¾“å…¥å‡é€šè¿‡PipedWriterå†™å…¥ï¼Œè€ŒprintThreadåœ¨å¦ä¸€ç«¯é€šè¿‡PipedReaderå°†å†…å®¹è¯»å‡ºå¹¶æ‰“å°ã€‚</p>
<pre><code class="language-java">package cm;

import java.io.IOException;
import java.io.PipedReader;
import java.io.PipedWriter;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/9 15:25
 */
public class Piped {
    public static void main(String[] args) throws Exception {
        PipedWriter out = new PipedWriter();
        PipedReader in = new PipedReader();
        // å°†è¾“å‡ºæµå’Œè¾“å…¥æµè¿›è¡Œè¿æ¥ï¼Œå¦åˆ™åœ¨ä½¿ç”¨æ—¶ä¼šæŠ›å‡ºIOException
        out.connect(in);
        Thread printThread = new Thread(new Print(in), &quot;PrintThread&quot;);
        printThread.start();
        int receive = 0;
        try {
            while ((receive = System.in.read()) != -1) {
                out.write(receive);
            }
        } finally {
            out.close();
        }
    }
    static class Print implements Runnable {
        private PipedReader in;
        public Print(PipedReader in) {
            this.in = in;
        }
        public void run() {
            int receive = 0;
            try {
                while ((receive = in.read()) != -1) {
                    System.out.print((char) receive);
                }
            } catch (IOException ex) {
            }
        }
    }
}

</code></pre>
<p>å¯¹äºPipedç±»å‹çš„æµï¼Œå¿…é¡»å…ˆè¦è¿›è¡Œç»‘å®šï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨connect()æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å°†è¾“å…¥/è¾“å‡ºæµç»‘å®šèµ·æ¥ï¼Œå¯¹äºè¯¥æµçš„è®¿é—®å°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<h3 id="335-threadjoinçš„ä½¿ç”¨">3.3.5 Thread.join()çš„ä½¿ç”¨</h3>
<p>å¦‚æœä¸€ä¸ªçº¿ç¨‹Aæ‰§è¡Œäº†thread.join()è¯­å¥ï¼Œå…¶å«ä¹‰æ˜¯ï¼šå½“å‰çº¿ç¨‹Aç­‰å¾…threadçº¿ç¨‹ç»ˆæ­¢ä¹‹åæ‰ä»thread.join()è¿”å›ã€‚çº¿ç¨‹Threadé™¤äº†æä¾›join()æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æä¾›äº†join(long millis)å’Œjoin(long millis,int nanos)ä¸¤ä¸ªå…·å¤‡è¶…æ—¶ç‰¹æ€§çš„æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªè¶…æ—¶æ–¹æ³•è¡¨ç¤ºï¼Œå¦‚æœçº¿ç¨‹threadåœ¨ç»™å®šçš„è¶…æ—¶æ—¶é—´æ²¡æœ‰ç»ˆæ­¢ï¼Œé‚£ä¹ˆå°†ä¼šä»è¯¥è¶…æ—¶æ–¹æ³•ä¸­è¿”å›ã€‚</p>
<p>åœ¨ä¸‹é¢æ‰€ç¤ºçš„ä¾‹å­ä¸­ï¼Œåˆ›å»ºäº†10ä¸ªçº¿ç¨‹ï¼Œç¼–å·0~9ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨å‰ä¸€ä¸ªçº¿ç¨‹çš„join()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹0ç»“æŸäº†ï¼Œçº¿ç¨‹1æ‰èƒ½ä»join()æ–¹æ³•ä¸­è¿”å›ï¼Œè€Œçº¿ç¨‹0éœ€è¦ç­‰å¾…mainçº¿ç¨‹ç»“æŸã€‚</p>
<pre><code class="language-java">package cm;

import java.util.concurrent.TimeUnit;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/9 15:37
 */
public class Join {
    public static void main(String[] args) throws Exception {
        Thread previous = Thread.currentThread();
        for (int i = 0; i &lt; 10; i++) {
        // æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å‰ä¸€ä¸ªçº¿ç¨‹çš„å¼•ç”¨ï¼Œéœ€è¦ç­‰å¾…å‰ä¸€ä¸ªçº¿ç¨‹ç»ˆæ­¢ï¼Œæ‰èƒ½ä»ç­‰å¾…ä¸­è¿”å›
            Thread thread = new Thread(new Domino(previous), String.valueOf(i));
            thread.start();
            previous = thread;
        }
        TimeUnit.SECONDS.sleep(5);
        System.out.println(Thread.currentThread().getName() + &quot; terminate.&quot;);
    }

    static class Domino implements Runnable {
        private Thread thread;
        public Domino(Thread thread) {
            this.thread = thread;
        }
        public void run() {
            try {
                thread.join();
            } catch (InterruptedException e) {
            }
            System.out.println(Thread.currentThread().getName() + &quot; terminate.&quot;);
        }
    }
}
</code></pre>
<p>æ¯ä¸ªçº¿ç¨‹ç»ˆæ­¢çš„å‰ææ˜¯å‰é©±çº¿ç¨‹çš„ç»ˆæ­¢ï¼Œæ¯ä¸ªçº¿ç¨‹ç­‰å¾…å‰é©±çº¿ç¨‹ç»ˆæ­¢åï¼Œæ‰ä»join()æ–¹æ³•è¿”å›ï¼Œè¿™é‡Œæ¶‰åŠäº†ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ˆç­‰å¾…å‰é©±çº¿ç¨‹ç»“æŸï¼Œæ¥æ”¶å‰é©±çº¿ç¨‹ç»“æŸé€šçŸ¥ï¼‰ã€‚</p>
<p>å½“çº¿ç¨‹ç»ˆæ­¢æ—¶ï¼Œä¼šè°ƒç”¨çº¿ç¨‹è‡ªèº«çš„notifyAll()æ–¹æ³•ï¼Œä¼šé€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨è¯¥çº¿ç¨‹å¯¹è±¡ä¸Šçš„çº¿ç¨‹ã€‚å¯ä»¥çœ‹åˆ°join()æ–¹æ³•çš„é€»è¾‘ç»“æ„ï¼Œå³åŠ é”ã€å¾ªç¯å’Œå¤„ç†é€»è¾‘3ä¸ªæ­¥éª¤ã€‚</p>
<h3 id="336-threadlocalçš„ä½¿ç”¨">3.3.6 ThreadLocalçš„ä½¿ç”¨</h3>
<p>ThreadLocalï¼Œå³çº¿ç¨‹å˜é‡ï¼Œæ˜¯ä¸€ä¸ªä»¥ThreadLocalå¯¹è±¡ä¸ºé”®ã€ä»»æ„å¯¹è±¡ä¸ºå€¼çš„å­˜å‚¨ç»“æ„ã€‚è¿™ä¸ªç»“æ„è¢«é™„å¸¦åœ¨çº¿ç¨‹ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ ¹æ®ä¸€ä¸ªThreadLocalå¯¹è±¡æŸ¥è¯¢åˆ°ç»‘å®šåœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šçš„ä¸€ä¸ªå€¼ã€‚</p>
<p>å¯ä»¥é€šè¿‡set(T)æ–¹æ³•æ¥è®¾ç½®ä¸€ä¸ªå€¼ï¼Œåœ¨å½“å‰çº¿ç¨‹ä¸‹å†é€šè¿‡get()æ–¹æ³•è·å–åˆ°åŸå…ˆè®¾ç½®çš„å€¼ã€‚</p>
<p>åœ¨ä¸‹é¢æ‰€ç¤ºçš„ä¾‹å­ä¸­ï¼Œæ„å»ºäº†ä¸€ä¸ªå¸¸ç”¨çš„Profilerç±»ï¼Œå®ƒå…·æœ‰begin()å’Œend()ä¸¤ä¸ªæ–¹æ³•ï¼Œè€Œend()æ–¹æ³•è¿”å›ä»begin()æ–¹æ³•è°ƒç”¨å¼€å§‹åˆ°end()æ–¹æ³•è¢«è°ƒç”¨æ—¶çš„æ—¶é—´å·®ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</p>
<pre><code class="language-java">package cm;

import java.util.concurrent.TimeUnit;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/9 16:56
 */
public class Profiler {
    // ç¬¬ä¸€æ¬¡get()æ–¹æ³•è°ƒç”¨æ—¶ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼ˆå¦‚æœsetæ–¹æ³•æ²¡æœ‰è°ƒç”¨ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šè°ƒç”¨ä¸€æ¬¡
    private static final ThreadLocal&lt;Long&gt; TIME_THREADLOCAL = new ThreadLocal&lt;Long&gt;() {
        protected Long initialValue() {
            return System.currentTimeMillis();
        }
    };
    public static final void begin() {
        TIME_THREADLOCAL.set(System.currentTimeMillis());
    }
    public static final long end() {
        return System.currentTimeMillis() - TIME_THREADLOCAL.get();
    }
    public static void main(String[] args) throws Exception {
        Profiler.begin();
        TimeUnit.SECONDS.sleep(1);
        System.out.println(&quot;Cost: &quot; + Profiler.end() + &quot; mills&quot;);
    }
}
</code></pre>
<h2 id="34-çº¿ç¨‹åº”ç”¨å®ä¾‹">3.4 çº¿ç¨‹åº”ç”¨å®ä¾‹</h2>
<h3 id="341-ç­‰å¾…è¶…æ—¶æ¨¡å¼">3.4.1 ç­‰å¾…è¶…æ—¶æ¨¡å¼</h3>
<p>ç­‰å¾…è¶…æ—¶æ¨¡å¼çš„ä¼ªä»£ç å¦‚ä¸‹ã€‚</p>
<pre><code class="language-java">    // å¯¹å½“å‰å¯¹è±¡åŠ é”
    public synchronized Object get(long mills) throws InterruptedException {
        long future = System.currentTimeMillis() + mills;
        long remaining = mills;
// å½“è¶…æ—¶å¤§äº0å¹¶ä¸”resultè¿”å›å€¼ä¸æ»¡è¶³è¦æ±‚
        while ((result == null) &amp;&amp; remaining &gt; 0) {
            wait(remaining);
            remaining = future - System.currentTimeMillis();
        }
        return result;
    }
</code></pre>
<h3 id="342-ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹">3.4.2 ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹</h3>
<p>é“¾æ¥:<a href="/post/shu-ju-ku-lian-jie-chi-shi-li">æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹</a></p>
<h3 id="343-çº¿ç¨‹æ± æŠ€æœ¯åŠå…¶ç¤ºä¾‹">3.4.3 çº¿ç¨‹æ± æŠ€æœ¯åŠå…¶ç¤ºä¾‹</h3>
<p>é¢å¯¹æˆåƒä¸Šä¸‡çš„ä»»åŠ¡é€’äº¤è¿›æœåŠ¡å™¨æ—¶ï¼Œå¦‚æœè¿˜æ˜¯é‡‡ç”¨ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªçº¿ç¨‹çš„æ–¹å¼ï¼Œé‚£ä¹ˆå°†ä¼šåˆ›å»ºæ•°ä»¥ä¸‡è®°çš„çº¿ç¨‹ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚å› ä¸ºè¿™ä¼šä½¿æ“ä½œç³»ç»Ÿé¢‘ç¹çš„è¿›è¡Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ— æ•…å¢åŠ ç³»ç»Ÿçš„è´Ÿè½½ï¼Œè€Œçº¿ç¨‹çš„åˆ›å»ºå’Œæ¶ˆäº¡éƒ½æ˜¯éœ€è¦è€—è´¹ç³»ç»Ÿèµ„æºçš„ï¼Œä¹Ÿæ— ç–‘æµªè´¹äº†ç³»ç»Ÿèµ„æºã€‚</p>
<p>çº¿ç¨‹æ± æŠ€æœ¯èƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒé¢„å…ˆåˆ›å»ºäº†è‹¥å¹²æ•°é‡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”ä¸èƒ½ç”±ç”¨æˆ·ç›´æ¥å¯¹çº¿ç¨‹çš„åˆ›å»ºè¿›è¡Œæ§åˆ¶ï¼Œåœ¨è¿™ä¸ªå‰æä¸‹é‡å¤ä½¿ç”¨å›ºå®šæˆ–è¾ƒä¸ºå›ºå®šæ•°ç›®çš„çº¿ç¨‹æ¥å®Œæˆä»»åŠ¡çš„æ‰§è¡Œã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œä¸€æ–¹é¢ï¼Œæ¶ˆé™¤äº†é¢‘ç¹åˆ›å»ºå’Œæ¶ˆäº¡çº¿ç¨‹çš„ç³»ç»Ÿèµ„æºå¼€é”€ï¼Œå¦ä¸€æ–¹é¢ï¼Œé¢å¯¹è¿‡é‡ä»»åŠ¡çš„æäº¤èƒ½å¤Ÿå¹³ç¼“çš„åŠ£åŒ–ã€‚</p>
<p>ä¸‹é¢å…ˆçœ‹ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± æ¥å£å®šä¹‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">package cm;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/10 11:35
 */
public interface ThreadPool&lt;Job extends Runnable&gt; {
    // æ‰§è¡Œä¸€ä¸ªJobï¼Œè¿™ä¸ªJobéœ€è¦å®ç°Runnable
    void execute(Job job);
    // å…³é—­çº¿ç¨‹æ± 
    void shutdown();
    // å¢åŠ å·¥ä½œè€…çº¿ç¨‹
    void addWorkers(int num);
    // å‡å°‘å·¥ä½œè€…çº¿ç¨‹
    void removeWorker(int num);
    // å¾—åˆ°æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡
    int getJobSize();
}
</code></pre>
<p>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡execute(Job)æ–¹æ³•å°†Jobæäº¤å…¥çº¿ç¨‹æ± æ‰§è¡Œï¼Œè€Œå®¢æˆ·ç«¯è‡ªèº«ä¸ç”¨ç­‰å¾…Jobçš„æ‰§è¡Œå®Œæˆã€‚é™¤äº†execute(Job)æ–¹æ³•ä»¥å¤–ï¼Œçº¿ç¨‹æ± æ¥å£æä¾›äº†å¢å¤§/å‡å°‘å·¥ä½œè€…çº¿ç¨‹ä»¥åŠå…³é—­çº¿ç¨‹æ± çš„æ–¹æ³•ã€‚è¿™é‡Œå·¥ä½œè€…çº¿ç¨‹ä»£è¡¨ç€ä¸€ä¸ªé‡å¤æ‰§è¡ŒJobçš„çº¿ç¨‹ï¼Œè€Œæ¯ä¸ªç”±å®¢æˆ·ç«¯æäº¤çš„Jobéƒ½å°†è¿›å…¥åˆ°ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ä¸­ç­‰å¾…å·¥ä½œè€…çº¿ç¨‹çš„å¤„ç†ã€‚</p>
<pre><code class="language-java">package cm;

import java.util.ArrayList;
import java.util.Collections;
import java.util.LinkedList;
import java.util.List;
import java.util.concurrent.atomic.AtomicLong;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/8/10 11:38
 */
public class DefaultThreadPool&lt;Job extends Runnable&gt; implements ThreadPool&lt;Job&gt; {
    // çº¿ç¨‹æ± æœ€å¤§é™åˆ¶æ•°
    private static final int MAX_WORKER_NUMBERS = 10;
    // çº¿ç¨‹æ± é»˜è®¤çš„æ•°é‡
    private static final int DEFAULT_WORKER_NUMBERS = 5;
    // çº¿ç¨‹æ± æœ€å°çš„æ•°é‡
    private static final int MIN_WORKER_NUMBERS = 1;
    // è¿™æ˜¯ä¸€ä¸ªå·¥ä½œåˆ—è¡¨ï¼Œå°†ä¼šå‘é‡Œé¢æ’å…¥å·¥ä½œ
    private final LinkedList&lt;Job&gt; jobs = new LinkedList&lt;Job&gt;();
    // å·¥ä½œè€…åˆ—è¡¨
    private final List&lt;Worker&gt; workers = Collections.synchronizedList(new ArrayList&lt;Worker&gt;());
    // å·¥ä½œè€…çº¿ç¨‹çš„æ•°é‡
    private int workerNum = DEFAULT_WORKER_NUMBERS;
    // çº¿ç¨‹ç¼–å·ç”Ÿæˆ
    private AtomicLong threadNum = new AtomicLong();
    public DefaultThreadPool() {
        initializeWokers(DEFAULT_WORKER_NUMBERS);
    }
    public DefaultThreadPool(int num) {
        workerNum = num &gt; MAX_WORKER_NUMBERS ? MAX_WORKER_NUMBERS : num &lt; MIN_WORKER_NUMBERS ? MIN_WORKER_NUMBERS : num;
        initializeWokers(workerNum);
    }
    public void execute(Job job) {
        if (job != null) {
        // æ·»åŠ ä¸€ä¸ªå·¥ä½œï¼Œç„¶åè¿›è¡Œé€šçŸ¥
            synchronized (jobs) {
                jobs.addLast(job);
                jobs.notify();
            }
        }
    }
    public void shutdown() {
        for (Worker worker : workers) {
            worker.shutdown();
        }
    }
    public void addWorkers(int num) {
        synchronized (jobs) {
            // é™åˆ¶æ–°å¢çš„Workeræ•°é‡ä¸èƒ½è¶…è¿‡æœ€å¤§å€¼
            if (num + this.workerNum &gt; MAX_WORKER_NUMBERS) {
                num = MAX_WORKER_NUMBERS - this.workerNum;
            }
            initializeWokers(num);
            this.workerNum += num;
        }
    }
    public void removeWorker(int num) {
        synchronized (jobs) {
            if (num &gt;= this.workerNum) {
                throw new IllegalArgumentException(&quot;beyond workNum&quot;);
            }
            // æŒ‰ç…§ç»™å®šçš„æ•°é‡åœæ­¢Worker
            int count = 0;
            while (count &lt; num) {
                Worker worker = workers.get(count);
                if (workers.remove(worker)) {
                    worker.shutdown();
                    count++;
                }
            }
            this.workerNum -= count;
        }
    }
    public int getJobSize() {
        return jobs.size();
    }
    // åˆå§‹åŒ–çº¿ç¨‹å·¥ä½œè€…
    private void initializeWokers(int num) {
        for (int i = 0; i &lt; num; i++) {
            Worker worker = new Worker();
            workers.add(worker);
            Thread thread = new Thread(worker, &quot;ThreadPool-Worker-&quot; + threadNum.incrementAndGet());
            thread.start();
        }
    }
    // å·¥ä½œè€…ï¼Œè´Ÿè´£æ¶ˆè´¹ä»»åŠ¡
    class Worker implements Runnable {
        // æ˜¯å¦å·¥ä½œ
        private volatile boolean running = true;
        public void run() {
            while (running) {
                Job job = null;
                synchronized (jobs) {
             // å¦‚æœå·¥ä½œè€…åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±wait
                    while (jobs.isEmpty()) {
                        try {
                            jobs.wait();
                        } catch (InterruptedException ex) {
                            // æ„ŸçŸ¥åˆ°å¤–éƒ¨å¯¹WorkerThreadçš„ä¸­æ–­æ“ä½œï¼Œè¿”å›
                            Thread.currentThread().interrupt();
                            return;
                        }
                    }
                    // å–å‡ºä¸€ä¸ªJob
                    job = jobs.removeFirst();
                }
                if (job != null) {
                    try {
                        job.run();
                    } catch (Exception ex) {
                    // å¿½ç•¥Jobæ‰§è¡Œä¸­çš„Exception
                    }
                }
            }
        }
        public void shutdown() {
            running = false;
        }
    }
}
</code></pre>
<p>ä»çº¿ç¨‹æ± çš„å®ç°å¯ä»¥çœ‹åˆ°ï¼Œå½“å®¢æˆ·ç«¯è°ƒç”¨execute(Job)æ–¹æ³•æ—¶ï¼Œä¼šä¸æ–­åœ°å‘ä»»åŠ¡åˆ—è¡¨jobsä¸­æ·»åŠ Jobï¼Œè€Œæ¯ä¸ªå·¥ä½œè€…çº¿ç¨‹ä¼šä¸æ–­åœ°ä»jobsä¸Šå–å‡ºä¸€ä¸ªJobè¿›è¡Œæ‰§è¡Œï¼Œå½“jobsä¸ºç©ºæ—¶ï¼Œå·¥ä½œè€…çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>æ·»åŠ ä¸€ä¸ªJobåï¼Œå¯¹å·¥ä½œé˜Ÿåˆ—jobsè°ƒç”¨äº†å…¶notify()æ–¹æ³•ï¼Œè€Œä¸æ˜¯notifyAll()æ–¹æ³•ï¼Œå› ä¸ºèƒ½å¤Ÿç¡®å®šæœ‰å·¥ä½œè€…çº¿ç¨‹è¢«å”¤é†’ï¼Œè¿™æ—¶ä½¿ç”¨notify()æ–¹æ³•å°†ä¼šæ¯”notifyAll()æ–¹æ³•è·å¾—æ›´å°çš„å¼€é”€ï¼ˆé¿å…å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å…¨éƒ¨ç§»åŠ¨åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼‰ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œçº¿ç¨‹æ± çš„æœ¬è´¨å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å·¥ä½œé˜Ÿåˆ—è¿æ¥å·¥ä½œè€…çº¿ç¨‹å’Œå®¢æˆ·ç«¯çº¿ç¨‹ï¼Œå®¢æˆ·ç«¯çº¿ç¨‹å°†ä»»åŠ¡æ”¾å…¥å·¥ä½œé˜Ÿåˆ—åä¾¿è¿”å›ï¼Œè€Œå·¥ä½œè€…çº¿ç¨‹åˆ™ä¸æ–­åœ°ä»å·¥ä½œé˜Ÿåˆ—ä¸Šå–å‡ºå·¥ä½œå¹¶æ‰§è¡Œã€‚å½“å·¥ä½œé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ‰€æœ‰çš„å·¥ä½œè€…çº¿ç¨‹å‡ç­‰å¾…åœ¨å·¥ä½œé˜Ÿåˆ—ä¸Šï¼Œå½“æœ‰å®¢æˆ·ç«¯æäº¤äº†ä¸€ä¸ªä»»åŠ¡ä¹‹åä¼šé€šçŸ¥ä»»æ„ä¸€ä¸ªå·¥ä½œè€…çº¿ç¨‹ï¼Œéšç€å¤§é‡çš„ä»»åŠ¡è¢«æäº¤ï¼Œæ›´å¤šçš„å·¥ä½œè€…çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚</p>
<h3 id="344-ä¸€ä¸ªåŸºäºçº¿ç¨‹æ± æŠ€æœ¯çš„ç®€å•webæœåŠ¡å™¨">3.4.4 ä¸€ä¸ªåŸºäºçº¿ç¨‹æ± æŠ€æœ¯çš„ç®€å•WebæœåŠ¡å™¨</h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ElasticSearchå®æˆ˜]]></title>
        <id>https://q456qq520.github.io/post/er-wei-ma/</id>
        <link href="https://q456qq520.github.io/post/er-wei-ma/">
        </link>
        <updated>2022-07-03T01:58:06.000Z</updated>
        <content type="html"><![CDATA[<h1 id="1-æ•°æ®è®¾è®¡">1 æ•°æ®è®¾è®¡</h1>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[çŠ¶æ€æ¨¡å¼]]></title>
        <id>https://q456qq520.github.io/post/zhuang-tai-mo-shi/</id>
        <link href="https://q456qq520.github.io/post/zhuang-tai-mo-shi/">
        </link>
        <updated>2022-06-29T01:48:28.000Z</updated>
        <content type="html"><![CDATA[<h2 id="æ„å›¾">æ„å›¾</h2>
<p><strong>çŠ¶æ€æ¨¡å¼</strong>æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½åœ¨ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å˜åŒ–æ—¶æ”¹å˜å…¶è¡Œä¸ºï¼Œ ä½¿å…¶çœ‹ä¸Šå»å°±åƒæ”¹å˜äº†è‡ªèº«æ‰€å±çš„ç±»ä¸€æ ·ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://refactoringguru.cn/images/patterns/content/state/state-zh-2x.png" alt="likecat" loading="lazy"></figure>
<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>çŠ¶æ€æ¨¡å¼ä¸<strong>æœ‰é™çŠ¶æ€æœº</strong>çš„æ¦‚å¿µç´§å¯†ç›¸å…³</p>
<figure data-type="image" tabindex="2"><img src="https://refactoringguru.cn/images/patterns/diagrams/state/problem1-2x.png" alt="æœ‰é™çŠ¶æ€æœº" loading="lazy"></figure>
<p>å…¶ä¸»è¦æ€æƒ³æ˜¯ç¨‹åºåœ¨ä»»æ„æ—¶åˆ»ä»…å¯å¤„äºå‡ ç§æœ‰é™çš„çŠ¶æ€ä¸­ã€‚ åœ¨ä»»ä½•ä¸€ä¸ªç‰¹å®šçŠ¶æ€ä¸­ï¼Œ ç¨‹åºçš„è¡Œä¸ºéƒ½ä¸ç›¸åŒï¼Œ ä¸”å¯ç¬é—´ä»ä¸€ä¸ªçŠ¶æ€åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçŠ¶æ€ã€‚ ä¸è¿‡ï¼Œ æ ¹æ®å½“å‰çŠ¶æ€ï¼Œ ç¨‹åºå¯èƒ½ä¼šåˆ‡æ¢åˆ°å¦å¤–ä¸€ç§çŠ¶æ€ï¼Œ ä¹Ÿå¯èƒ½ä¼šä¿æŒå½“å‰çŠ¶æ€ä¸å˜ã€‚ è¿™äº›æ•°é‡æœ‰é™ä¸”é¢„å…ˆå®šä¹‰çš„çŠ¶æ€åˆ‡æ¢è§„åˆ™è¢«ç§°ä¸ºè½¬ç§»ã€‚</p>
<p>ä½ è¿˜å¯å°†è¯¥æ–¹æ³•åº”ç”¨åœ¨å¯¹è±¡ä¸Šã€‚ å‡å¦‚ä½ æœ‰ä¸€ä¸ª æ–‡æ¡£Documentç±»ã€‚ æ–‡æ¡£å¯èƒ½ä¼šå¤„äº è‰ç¨¿Draft ã€ â€‹ å®¡é˜…ä¸­Moderationå’Œ å·²å‘å¸ƒPublishedä¸‰ç§çŠ¶æ€ä¸­çš„ä¸€ç§ã€‚ æ–‡æ¡£çš„ publishå‘å¸ƒæ–¹æ³•åœ¨ä¸åŒçŠ¶æ€ä¸‹çš„è¡Œä¸ºç•¥æœ‰ä¸åŒï¼š</p>
<ul>
<li>å¤„äº è‰ç¨¿çŠ¶æ€æ—¶ï¼Œ å®ƒä¼šå°†æ–‡æ¡£è½¬ç§»åˆ°å®¡é˜…ä¸­çŠ¶æ€ã€‚</li>
<li>å¤„äº å®¡é˜…ä¸­çŠ¶æ€æ—¶ï¼Œ å¦‚æœå½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œ å®ƒä¼šå…¬å¼€å‘å¸ƒæ–‡æ¡£ã€‚</li>
<li>å¤„äº å·²å‘å¸ƒçŠ¶æ€æ—¶ï¼Œ å®ƒä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œã€‚</li>
</ul>
<figure data-type="image" tabindex="3"><img src="https://refactoringguru.cn/images/patterns/diagrams/state/problem2-zh-2x.png" alt="æ–‡æ¡£å¯¹è±¡çš„å…¨éƒ¨çŠ¶æ€å’Œè½¬ç§»" loading="lazy"></figure>
<p>æ–‡æ¡£å¯¹è±¡çš„å…¨éƒ¨çŠ¶æ€å’Œè½¬ç§»ã€‚</p>
<p>çŠ¶æ€æœºé€šå¸¸ç”±ä¼—å¤šæ¡ä»¶è¿ç®—ç¬¦ ï¼ˆ ifæˆ– switch ï¼‰ å®ç°ï¼Œ å¯æ ¹æ®å¯¹è±¡çš„å½“å‰çŠ¶æ€é€‰æ‹©ç›¸åº”çš„è¡Œä¸ºã€‚ â€‹ â€œçŠ¶æ€â€ é€šå¸¸åªæ˜¯å¯¹è±¡ä¸­çš„ä¸€ç»„æˆå‘˜å˜é‡å€¼ã€‚ å³ä½¿ä½ ä¹‹å‰ä»æœªå¬è¯´è¿‡æœ‰é™çŠ¶æ€æœºï¼Œ ä½ ä¹Ÿå¾ˆå¯èƒ½å·²ç»å®ç°è¿‡çŠ¶æ€æ¨¡å¼ã€‚</p>
<p>å½“æˆ‘ä»¬é€æ­¥åœ¨ æ–‡æ¡£ç±»ä¸­æ·»åŠ æ›´å¤šçŠ¶æ€å’Œä¾èµ–äºçŠ¶æ€çš„è¡Œä¸ºåï¼Œ åŸºäºæ¡ä»¶è¯­å¥çš„çŠ¶æ€æœºå°±ä¼šæš´éœ²å…¶æœ€å¤§çš„å¼±ç‚¹ã€‚ ä¸ºäº†èƒ½æ ¹æ®å½“å‰çŠ¶æ€é€‰æ‹©å®Œæˆç›¸åº”è¡Œä¸ºçš„æ–¹æ³•ï¼Œ ç»å¤§éƒ¨åˆ†æ–¹æ³•ä¸­ä¼šåŒ…å«å¤æ‚çš„æ¡ä»¶è¯­å¥ã€‚ ä¿®æ”¹å…¶è½¬æ¢é€»è¾‘å¯èƒ½ä¼šæ¶‰åŠåˆ°ä¿®æ”¹æ‰€æœ‰æ–¹æ³•ä¸­çš„çŠ¶æ€æ¡ä»¶è¯­å¥ï¼Œ å¯¼è‡´ä»£ç çš„ç»´æŠ¤å·¥ä½œéå¸¸è‰°éš¾ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜ä¼šéšç€é¡¹ç›®è¿›è¡Œå˜å¾—è¶Šå‘ä¸¥é‡ã€‚ æˆ‘ä»¬å¾ˆéš¾åœ¨è®¾è®¡é˜¶æ®µé¢„æµ‹åˆ°æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€å’Œè½¬æ¢ã€‚ éšç€æ—¶é—´æ¨ç§»ï¼Œ æœ€åˆä»…åŒ…å«æœ‰é™æ¡ä»¶è¯­å¥çš„ç®€æ´çŠ¶æ€æœºå¯èƒ½ä¼šå˜æˆè‡ƒè‚¿çš„ä¸€å›¢ä¹±éº»ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>çŠ¶æ€æ¨¡å¼å»ºè®®ä¸ºå¯¹è±¡çš„æ‰€æœ‰å¯èƒ½çŠ¶æ€æ–°å»ºä¸€ä¸ªç±»ï¼Œ ç„¶åå°†æ‰€æœ‰çŠ¶æ€çš„å¯¹åº”è¡Œä¸ºæŠ½å–åˆ°è¿™äº›ç±»ä¸­ã€‚</p>
<p>åŸå§‹å¯¹è±¡è¢«ç§°ä¸ºä¸Šä¸‹æ–‡ ï¼ˆcontextï¼‰ï¼Œ å®ƒå¹¶ä¸ä¼šè‡ªè¡Œå®ç°æ‰€æœ‰è¡Œä¸ºï¼Œ è€Œæ˜¯ä¼šä¿å­˜ä¸€ä¸ªæŒ‡å‘è¡¨ç¤ºå½“å‰çŠ¶æ€çš„çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ï¼Œ ä¸”å°†æ‰€æœ‰ä¸çŠ¶æ€ç›¸å…³çš„å·¥ä½œå§”æ´¾ç»™è¯¥å¯¹è±¡ã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://refactoringguru.cn/images/patterns/diagrams/state/solution-zh-2x.png" alt="likecat" loading="lazy"></figure>
<p>æ–‡æ¡£å°†å·¥ä½œå§”æ´¾ç»™ä¸€ä¸ªçŠ¶æ€å¯¹è±¡ã€‚</p>
<p>å¦‚éœ€å°†ä¸Šä¸‹æ–‡è½¬æ¢ä¸ºå¦å¤–ä¸€ç§çŠ¶æ€ï¼Œ åˆ™éœ€å°†å½“å‰æ´»åŠ¨çš„çŠ¶æ€å¯¹è±¡æ›¿æ¢ä¸ºå¦å¤–ä¸€ä¸ªä»£è¡¨æ–°çŠ¶æ€çš„å¯¹è±¡ã€‚ é‡‡ç”¨è¿™ç§æ–¹å¼æ˜¯æœ‰å‰æçš„ï¼š æ‰€æœ‰çŠ¶æ€ç±»éƒ½å¿…é¡»éµå¾ªåŒæ ·çš„æ¥å£ï¼Œ è€Œä¸”ä¸Šä¸‹æ–‡å¿…é¡»ä»…é€šè¿‡æ¥å£ä¸è¿™äº›å¯¹è±¡è¿›è¡Œäº¤äº’ã€‚</p>
<p>è¿™ä¸ªç»“æ„å¯èƒ½çœ‹ä¸Šå»ä¸ç­–ç•¥æ¨¡å¼ç›¸ä¼¼ï¼Œ ä½†æœ‰ä¸€ä¸ªå…³é”®æ€§çš„ä¸åŒâ€”â€”åœ¨çŠ¶æ€æ¨¡å¼ä¸­ï¼Œ ç‰¹å®šçŠ¶æ€çŸ¥é“å…¶ä»–æ‰€æœ‰çŠ¶æ€çš„å­˜åœ¨ï¼Œ ä¸”èƒ½è§¦å‘ä»ä¸€ä¸ªçŠ¶æ€åˆ°å¦ä¸€ä¸ªçŠ¶æ€çš„è½¬æ¢ï¼› ç­–ç•¥åˆ™å‡ ä¹å®Œå…¨ä¸çŸ¥é“å…¶ä»–ç­–ç•¥çš„å­˜åœ¨ã€‚</p>
<h2 id="çŠ¶æ€æ¨¡å¼æ¨¡å¼ç»“æ„">çŠ¶æ€æ¨¡å¼æ¨¡å¼ç»“æ„</h2>
<figure data-type="image" tabindex="5"><img src="https://refactoringguru.cn/images/patterns/diagrams/state/structure-zh-2x.png" alt="çŠ¶æ€æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<ol>
<li>
<p><strong>ä¸Šä¸‹æ–‡ ï¼ˆContextï¼‰</strong>  ä¿å­˜äº†å¯¹äºä¸€ä¸ªå…·ä½“çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ï¼Œ å¹¶ä¼šå°†æ‰€æœ‰ä¸è¯¥çŠ¶æ€ç›¸å…³çš„å·¥ä½œå§”æ´¾ç»™å®ƒã€‚ ä¸Šä¸‹æ–‡é€šè¿‡çŠ¶æ€æ¥å£ä¸çŠ¶æ€å¯¹è±¡äº¤äº’ï¼Œ ä¸”ä¼šæä¾›ä¸€ä¸ªè®¾ç½®å™¨ç”¨äºä¼ é€’æ–°çš„çŠ¶æ€å¯¹è±¡ã€‚</p>
</li>
<li>
<p>**çŠ¶æ€ ï¼ˆStateï¼‰  ** æ¥å£ä¼šå£°æ˜ç‰¹å®šäºçŠ¶æ€çš„æ–¹æ³•ã€‚ è¿™äº›æ–¹æ³•åº”èƒ½è¢«å…¶ä»–æ‰€æœ‰å…·ä½“çŠ¶æ€æ‰€ç†è§£ï¼Œ å› ä¸ºä½ ä¸å¸Œæœ›æŸäº›çŠ¶æ€æ‰€æ‹¥æœ‰çš„æ–¹æ³•æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ã€‚</p>
</li>
<li>
<p>**å…·ä½“çŠ¶æ€ ï¼ˆConcrete Statesï¼‰  ** ä¼šè‡ªè¡Œå®ç°ç‰¹å®šäºçŠ¶æ€çš„æ–¹æ³•ã€‚ ä¸ºäº†é¿å…å¤šä¸ªçŠ¶æ€ä¸­åŒ…å«ç›¸ä¼¼ä»£ç ï¼Œ ä½ å¯ä»¥æä¾›ä¸€ä¸ªå°è£…æœ‰éƒ¨åˆ†é€šç”¨è¡Œä¸ºçš„ä¸­é—´æŠ½è±¡ç±»ã€‚</p>
</li>
</ol>
<p>çŠ¶æ€å¯¹è±¡å¯å­˜å‚¨å¯¹äºä¸Šä¸‹æ–‡å¯¹è±¡çš„åå‘å¼•ç”¨ã€‚ çŠ¶æ€å¯ä»¥é€šè¿‡è¯¥å¼•ç”¨ä»ä¸Šä¸‹æ–‡å¤„è·å–æ‰€éœ€ä¿¡æ¯ï¼Œ å¹¶ä¸”èƒ½è§¦å‘çŠ¶æ€è½¬ç§»ã€‚</p>
<ol start="4">
<li>ä¸Šä¸‹æ–‡å’Œå…·ä½“çŠ¶æ€éƒ½å¯ä»¥è®¾ç½®ä¸Šä¸‹æ–‡çš„ä¸‹ä¸ªçŠ¶æ€ï¼Œ å¹¶å¯é€šè¿‡æ›¿æ¢è¿æ¥åˆ°ä¸Šä¸‹æ–‡çš„çŠ¶æ€å¯¹è±¡æ¥å®Œæˆå®é™…çš„çŠ¶æ€è½¬æ¢ã€‚</li>
</ol>
<h2 id="çŠ¶æ€æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯">çŠ¶æ€æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯</h2>
<ol>
<li>å¦‚æœå¯¹è±¡éœ€è¦æ ¹æ®è‡ªèº«å½“å‰çŠ¶æ€è¿›è¡Œä¸åŒè¡Œä¸ºï¼Œ åŒæ—¶çŠ¶æ€çš„æ•°é‡éå¸¸å¤šä¸”ä¸çŠ¶æ€ç›¸å…³çš„ä»£ç ä¼šé¢‘ç¹å˜æ›´çš„è¯ï¼Œ å¯ä½¿ç”¨çŠ¶æ€æ¨¡å¼ã€‚</li>
</ol>
<pre><code>æ¨¡å¼å»ºè®®ä½ å°†æ‰€æœ‰ç‰¹å®šäºçŠ¶æ€çš„ä»£ç æŠ½å–åˆ°ä¸€ç»„ç‹¬ç«‹çš„ç±»ä¸­ã€‚ è¿™æ ·ä¸€æ¥ï¼Œ ä½ å¯ä»¥åœ¨ç‹¬ç«‹äºå…¶ä»–çŠ¶æ€çš„æƒ…å†µä¸‹æ·»åŠ æ–°çŠ¶æ€æˆ–ä¿®æ”¹å·²æœ‰çŠ¶æ€ï¼Œ ä»è€Œå‡å°‘ç»´æŠ¤æˆæœ¬ã€‚
</code></pre>
<ol start="2">
<li>
<p>å¦‚æœæŸä¸ªç±»éœ€è¦æ ¹æ®æˆå‘˜å˜é‡çš„å½“å‰å€¼æ”¹å˜è‡ªèº«è¡Œä¸ºï¼Œ ä»è€Œéœ€è¦ä½¿ç”¨å¤§é‡çš„æ¡ä»¶è¯­å¥æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚</p>
<p>çŠ¶æ€æ¨¡å¼ä¼šå°†è¿™äº›æ¡ä»¶è¯­å¥çš„åˆ†æ”¯æŠ½å–åˆ°ç›¸åº”çŠ¶æ€ç±»çš„æ–¹æ³•ä¸­ã€‚ åŒæ—¶ï¼Œ ä½ è¿˜å¯ä»¥æ¸…é™¤ä¸»è¦ç±»ä¸­ä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„ä¸´æ—¶æˆå‘˜å˜é‡å’Œå¸®æ‰‹æ–¹æ³•ä»£ç ã€‚</p>
</li>
<li>
<p>å½“ç›¸ä¼¼çŠ¶æ€å’ŒåŸºäºæ¡ä»¶çš„çŠ¶æ€æœºè½¬æ¢ä¸­å­˜åœ¨è®¸å¤šé‡å¤ä»£ç æ—¶ï¼Œ å¯ä½¿ç”¨çŠ¶æ€æ¨¡å¼ã€‚</p>
<p>çŠ¶æ€æ¨¡å¼è®©ä½ èƒ½å¤Ÿç”ŸæˆçŠ¶æ€ç±»å±‚æ¬¡ç»“æ„ï¼Œ é€šè¿‡å°†å…¬ç”¨ä»£ç æŠ½å–åˆ°æŠ½è±¡åŸºç±»ä¸­æ¥å‡å°‘é‡å¤ã€‚</p>
</li>
</ol>
<h2 id="å®ç°æ–¹å¼">å®ç°æ–¹å¼</h2>
<ol>
<li>
<p>ç¡®å®šå“ªäº›ç±»æ˜¯ä¸Šä¸‹æ–‡ã€‚ å®ƒå¯èƒ½æ˜¯åŒ…å«ä¾èµ–äºçŠ¶æ€çš„ä»£ç çš„å·²æœ‰ç±»ï¼› å¦‚æœç‰¹å®šäºçŠ¶æ€çš„ä»£ç åˆ†æ•£åœ¨å¤šä¸ªç±»ä¸­ï¼Œ é‚£ä¹ˆå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªæ–°çš„ç±»ã€‚</p>
</li>
<li>
<p>å£°æ˜çŠ¶æ€æ¥å£ã€‚ è™½ç„¶ä½ å¯èƒ½ä¼šéœ€è¦å®Œå…¨å¤åˆ¶ä¸Šä¸‹æ–‡ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼Œ ä½†æœ€å¥½æ˜¯ä»…æŠŠå…³æ³¨ç‚¹æ”¾åœ¨é‚£äº›å¯èƒ½åŒ…å«ç‰¹å®šäºçŠ¶æ€çš„è¡Œä¸ºçš„æ–¹æ³•ä¸Šã€‚</p>
</li>
<li>
<p>ä¸ºæ¯ä¸ªå®é™…çŠ¶æ€åˆ›å»ºä¸€ä¸ªç»§æ‰¿äºçŠ¶æ€æ¥å£çš„ç±»ã€‚ ç„¶åæ£€æŸ¥ä¸Šä¸‹æ–‡ä¸­çš„æ–¹æ³•å¹¶å°†ä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„æ‰€æœ‰ä»£ç æŠ½å–åˆ°æ–°å»ºçš„ç±»ä¸­ã€‚</p>
<p>åœ¨å°†ä»£ç ç§»åŠ¨åˆ°çŠ¶æ€ç±»çš„è¿‡ç¨‹ä¸­ï¼Œ ä½ å¯èƒ½ä¼šå‘ç°å®ƒä¾èµ–äºä¸Šä¸‹æ–‡ä¸­çš„ä¸€äº›ç§æœ‰æˆå‘˜ã€‚ ä½ å¯ä»¥é‡‡ç”¨ä»¥ä¸‹å‡ ç§å˜é€šæ–¹å¼ï¼š</p>
<ul>
<li>å°†è¿™äº›æˆå‘˜å˜é‡æˆ–æ–¹æ³•è®¾ä¸ºå…¬æœ‰ã€‚</li>
<li>å°†éœ€è¦æŠ½å–çš„ä¸Šä¸‹æ–‡è¡Œä¸ºæ›´æ”¹ä¸ºä¸Šä¸‹æ–‡ä¸­çš„å…¬æœ‰æ–¹æ³•ï¼Œ ç„¶ååœ¨çŠ¶æ€ç±»ä¸­è°ƒç”¨ã€‚ è¿™ç§æ–¹å¼ç®€é™‹å´ä¾¿æ·ï¼Œ</li>
<li>ä½ å¯ä»¥ç¨åå†å¯¹å…¶è¿›è¡Œä¿®è¡¥ã€‚</li>
<li>å°†çŠ¶æ€ç±»åµŒå¥—åœ¨ä¸Šä¸‹æ–‡ç±»ä¸­ã€‚ è¿™ç§æ–¹å¼éœ€è¦ä½ æ‰€ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€æ”¯æŒåµŒå¥—ç±»ã€‚</li>
</ul>
</li>
<li>
<p>åœ¨ä¸Šä¸‹æ–‡ç±»ä¸­æ·»åŠ ä¸€ä¸ªçŠ¶æ€æ¥å£ç±»å‹çš„å¼•ç”¨æˆå‘˜å˜é‡ï¼Œ ä»¥åŠä¸€ä¸ªç”¨äºä¿®æ”¹è¯¥æˆå‘˜å˜é‡å€¼çš„å…¬æœ‰è®¾ç½®å™¨ã€‚</p>
</li>
<li>
<p>å†æ¬¡æ£€æŸ¥ä¸Šä¸‹æ–‡ä¸­çš„æ–¹æ³•ï¼Œ å°†ç©ºçš„æ¡ä»¶è¯­å¥æ›¿æ¢ä¸ºç›¸åº”çš„çŠ¶æ€å¯¹è±¡æ–¹æ³•ã€‚</p>
</li>
<li>
<p>ä¸ºåˆ‡æ¢ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œ ä½ éœ€è¦åˆ›å»ºæŸä¸ªçŠ¶æ€ç±»å®ä¾‹å¹¶å°†å…¶ä¼ é€’ç»™ä¸Šä¸‹æ–‡ã€‚ ä½ å¯ä»¥åœ¨ä¸Šä¸‹æ–‡ã€ å„ç§çŠ¶æ€æˆ–å®¢æˆ·ç«¯ä¸­å®Œæˆè¿™é¡¹å·¥ä½œã€‚ æ— è®ºåœ¨ä½•å¤„å®Œæˆè¿™é¡¹å·¥ä½œï¼Œ è¯¥ç±»éƒ½å°†ä¾èµ–äºå…¶æ‰€å®ä¾‹åŒ–çš„å…·ä½“ç±»ã€‚</p>
</li>
</ol>
<h2 id="çŠ¶æ€æ¨¡å¼ä¼˜ç¼ºç‚¹">çŠ¶æ€æ¨¡å¼ä¼˜ç¼ºç‚¹</h2>
<table>
<thead>
<tr>
<th>ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>å•ä¸€èŒè´£åŸåˆ™ã€‚ å°†ä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„ä»£ç æ”¾åœ¨å•ç‹¬çš„ç±»ä¸­ã€‚</td>
<td style="text-align:center">å¦‚æœçŠ¶æ€æœºåªæœ‰å¾ˆå°‘çš„å‡ ä¸ªçŠ¶æ€ï¼Œ æˆ–è€…å¾ˆå°‘å‘ç”Ÿæ”¹å˜ï¼Œ é‚£ä¹ˆåº”ç”¨è¯¥æ¨¡å¼å¯èƒ½ä¼šæ˜¾å¾—å°é¢˜å¤§ä½œã€‚</td>
</tr>
<tr>
<td>å¼€é—­åŸåˆ™ã€‚ æ— éœ€ä¿®æ”¹å·²æœ‰çŠ¶æ€ç±»å’Œä¸Šä¸‹æ–‡å°±èƒ½å¼•å…¥æ–°çŠ¶æ€ã€‚</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td>é€šè¿‡æ¶ˆé™¤è‡ƒè‚¿çš„çŠ¶æ€æœºæ¡ä»¶è¯­å¥ç®€åŒ–ä¸Šä¸‹æ–‡ä»£ç ã€‚</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<h2 id="ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»">ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»</h2>
<ol>
<li>
<p><strong>æ¡¥æ¥æ¨¡å¼</strong>ã€ <strong>çŠ¶æ€æ¨¡å¼</strong>å’Œ<strong>ç­–ç•¥æ¨¡å¼</strong> ï¼ˆåœ¨æŸç§ç¨‹åº¦ä¸ŠåŒ…æ‹¬é€‚é…å™¨æ¨¡å¼ï¼‰ æ¨¡å¼çš„æ¥å£éå¸¸ç›¸ä¼¼ã€‚ å®é™…ä¸Šï¼Œ å®ƒä»¬éƒ½åŸºäº<strong>ç»„åˆæ¨¡å¼</strong>â€”â€”å³å°†å·¥ä½œå§”æ´¾ç»™å…¶ä»–å¯¹è±¡ï¼Œ ä¸è¿‡ä¹Ÿå„è‡ªè§£å†³äº†ä¸åŒçš„é—®é¢˜ã€‚ æ¨¡å¼å¹¶ä¸åªæ˜¯ä»¥ç‰¹å®šæ–¹å¼ç»„ç»‡ä»£ç çš„é…æ–¹ï¼Œ ä½ è¿˜å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥å’Œå…¶ä»–å¼€å‘è€…è®¨è®ºæ¨¡å¼æ‰€è§£å†³çš„é—®é¢˜ã€‚</p>
</li>
<li>
<p><strong>çŠ¶æ€</strong>å¯è¢«è§†ä¸º<strong>ç­–ç•¥</strong>çš„æ‰©å±•ã€‚ ä¸¤è€…éƒ½åŸºäºç»„åˆæœºåˆ¶ï¼š å®ƒä»¬éƒ½é€šè¿‡å°†éƒ¨åˆ†å·¥ä½œå§”æ´¾ç»™ â€œå¸®æ‰‹â€ å¯¹è±¡æ¥æ”¹å˜å…¶åœ¨ä¸åŒæƒ…æ™¯ä¸‹çš„è¡Œä¸ºã€‚ ç­–ç•¥ä½¿å¾—è¿™äº›å¯¹è±¡ç›¸äº’ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œ å®ƒä»¬ä¸çŸ¥é“å…¶ä»–å¯¹è±¡çš„å­˜åœ¨ã€‚ ä½†çŠ¶æ€æ¨¡å¼æ²¡æœ‰é™åˆ¶å…·ä½“çŠ¶æ€ä¹‹é—´çš„ä¾èµ–ï¼Œ ä¸”å…è®¸å®ƒä»¬è‡ªè¡Œæ”¹å˜åœ¨ä¸åŒæƒ…æ™¯ä¸‹çš„çŠ¶æ€ã€‚</p>
</li>
</ol>
<h2 id="ä¼ªä»£ç ">ä¼ªä»£ç </h2>
<h4 id="åª’ä½“æ’­æ”¾å™¨çš„æ¥å£">åª’ä½“æ’­æ”¾å™¨çš„æ¥å£</h4>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œ çŠ¶æ€æ¨¡å¼å…è®¸åª’ä½“æ’­æ”¾å™¨æ ¹æ®å½“å‰çš„å›æ”¾çŠ¶æ€è¿›è¡Œä¸åŒçš„æ§åˆ¶è¡Œä¸ºã€‚ æ’­æ”¾å™¨ä¸»ç±»åŒ…å«ä¸€ä¸ªæŒ‡å‘çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ï¼Œ å®ƒå°†å®Œæˆæ’­æ”¾å™¨çš„ç»å¤§éƒ¨åˆ†å·¥ä½œã€‚ æŸäº›è¡Œä¸ºå¯èƒ½ä¼šç”¨ä¸€ä¸ªçŠ¶æ€å¯¹è±¡æ›¿æ¢å¦ä¸€ä¸ªçŠ¶æ€å¯¹è±¡ï¼Œ æ”¹å˜æ’­æ”¾å™¨å¯¹ç”¨æˆ·äº¤äº’çš„å›åº”æ–¹å¼</p>
<p>1ã€é€šç”¨çŠ¶æ€æ¥å£</p>
<pre><code>package com.states;

/**
 * é€šç”¨çŠ¶æ€æ¥å£
 * @author likecat
 * @version 1.0
 * @date 2022/7/1 17:05
 */
public abstract class State {
    Player player;

    /**
     * Context passes itself through the state constructor. This may help a
     * state to fetch some useful context data if needed.
     */
    State(Player player) {
        this.player = player;
    }

    public abstract String onLock();
    public abstract String onPlay();
    public abstract String onNext();
    public abstract String onPrevious();
}

</code></pre>
<p>2ã€ä½¿ç”¨ PayPal æ”¯ä»˜</p>
<pre><code>package com.strategies;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.Map;

/**
 * ä½¿ç”¨ PayPal æ”¯ä»˜
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:43
 */
public class PayByPayPal implements PayStrategy {
    private static final Map&lt;String, String&gt; DATA_BASE = new HashMap&lt;&gt;();
    private final BufferedReader READER = new BufferedReader(new InputStreamReader(System.in));
    private String email;
    private String password;
    private boolean signedIn;

    static {
        DATA_BASE.put(&quot;amanda1985&quot;, &quot;amanda@ya.com&quot;);
        DATA_BASE.put(&quot;qwerty&quot;, &quot;john@amazon.eu&quot;);
    }

    /**
     * Collect customer's data.
     */
    @Override
    public void collectPaymentDetails() {
        try {
            while (!signedIn) {
                System.out.print(&quot;Enter the user's email: &quot;);
                email = READER.readLine();
                System.out.print(&quot;Enter the password: &quot;);
                password = READER.readLine();
                if (verify()) {
                    System.out.println(&quot;Data verification has been successful.&quot;);
                } else {
                    System.out.println(&quot;Wrong email or password!&quot;);
                }
            }
        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }

    private boolean verify() {
        setSignedIn(email.equals(DATA_BASE.get(password)));
        return signedIn;
    }

    /**
     * Save customer data for future shopping attempts.
     */
    @Override
    public boolean pay(int paymentAmount) {
        if (signedIn) {
            System.out.println(&quot;Paying &quot; + paymentAmount + &quot; using PayPal.&quot;);
            return true;
        } else {
            return false;
        }
    }

    private void setSignedIn(boolean signedIn) {
        this.signedIn = signedIn;
    }
}

</code></pre>
<p>3ã€ä½¿ç”¨ä¿¡ç”¨å¡æ”¯ä»˜</p>
<pre><code>package com.strategies;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;

/**
 * ä½¿ç”¨ä¿¡ç”¨å¡æ”¯ä»˜
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:46
 */
public class PayByCreditCard implements PayStrategy {
    private final BufferedReader READER = new BufferedReader(new InputStreamReader(System.in));

    private CreditCard card;

    /**
     * Collect credit card data.
     */
    @Override
    public void collectPaymentDetails() {
        try {
            System.out.print(&quot;Enter the card number: &quot;);
            String number = READER.readLine();
            System.out.print(&quot;Enter the card expiration date 'mm/yy': &quot;);
            String date = READER.readLine();
            System.out.print(&quot;Enter the CVV code: &quot;);
            String cvv = READER.readLine();
            card = new CreditCard(number, date, cvv);

            // Validate credit card number...

        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }

    /**
     * After card validation we can charge customer's credit card.
     */
    @Override
    public boolean pay(int paymentAmount) {
        if (cardIsPresent()) {
            System.out.println(&quot;Paying &quot; + paymentAmount + &quot; using Credit Card.&quot;);
            card.setAmount(card.getAmount() - paymentAmount);
            return true;
        } else {
            return false;
        }
    }

    private boolean cardIsPresent() {
        return card != null;
    }
}

</code></pre>
<p>4ã€ä¿¡ç”¨å¡ç±»</p>
<pre><code>package com.strategies;

/**
 * ä¿¡ç”¨å¡ç±»
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:47
 */
public class CreditCard {
    private int amount;
    private String number;
    private String date;
    private String cvv;

    CreditCard(String number, String date, String cvv) {
        this.amount = 100_000;
        this.number = number;
        this.date = date;
        this.cvv = cvv;
    }

    public void setAmount(int amount) {
        this.amount = amount;
    }

    public int getAmount() {
        return amount;
    }
}

</code></pre>
<p>5ã€è®¢å•ç±»</p>
<pre><code>package com.strategies;

/**
 * è®¢å•ç±»
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:48
 */
public class Order {
    private int totalCost = 0;
    private boolean isClosed = false;

    public void processOrder(PayStrategy strategy) {
        strategy.collectPaymentDetails();
        // Here we could collect and store payment data from the strategy.
    }

    public void setTotalCost(int cost) {
        this.totalCost += cost;
    }

    public int getTotalCost() {
        return totalCost;
    }

    public boolean isClosed() {
        return isClosed;
    }

    public void setClosed() {
        isClosed = true;
    }
}

</code></pre>
<p>6ã€å®¢æˆ·ç«¯ä»£ç </p>
<pre><code>package com.strategies;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.Map;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:49
 */
public class Demo {
    private static Map&lt;Integer, Integer&gt; priceOnProducts = new HashMap&lt;&gt;();
    private static BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));
    private static Order order = new Order();
    private static PayStrategy strategy;

    static {
        priceOnProducts.put(1, 2200);
        priceOnProducts.put(2, 1850);
        priceOnProducts.put(3, 1100);
        priceOnProducts.put(4, 890);
    }

    public static void main(String[] args) throws IOException {
        while (!order.isClosed()) {
            int cost;

            String continueChoice;
            do {
                System.out.print(&quot;Please, select a product:&quot; + &quot;\n&quot; +
                        &quot;1 - Mother board&quot; + &quot;\n&quot; +
                        &quot;2 - CPU&quot; + &quot;\n&quot; +
                        &quot;3 - HDD&quot; + &quot;\n&quot; +
                        &quot;4 - Memory&quot; + &quot;\n&quot;);
                int choice = Integer.parseInt(reader.readLine());
                cost = priceOnProducts.get(choice);
                System.out.print(&quot;Count: &quot;);
                int count = Integer.parseInt(reader.readLine());
                order.setTotalCost(cost * count);
                System.out.print(&quot;Do you wish to continue selecting products? Y/N: &quot;);
                continueChoice = reader.readLine();
            } while (continueChoice.equalsIgnoreCase(&quot;Y&quot;));

            if (strategy == null) {
                System.out.println(&quot;Please, select a payment method:&quot; + &quot;\n&quot; +
                        &quot;1 - PalPay&quot; + &quot;\n&quot; +
                        &quot;2 - Credit Card&quot;);
                String paymentMethod = reader.readLine();

                // Client creates different strategies based on input from user,
                // application configuration, etc.
                if (paymentMethod.equals(&quot;1&quot;)) {
                    strategy = new PayByPayPal();
                } else {
                    strategy = new PayByCreditCard();
                }
            }

            // Order object delegates gathering payment data to strategy object,
            // since only strategies know what data they need to process a
            // payment.
            order.processOrder(strategy);

            System.out.print(&quot;Pay &quot; + order.getTotalCost() + &quot; units or Continue shopping? P/C: &quot;);
            String proceed = reader.readLine();
            if (proceed.equalsIgnoreCase(&quot;P&quot;)) {
                // Finally, strategy handles the payment.
                if (strategy.pay(order.getTotalCost())) {
                    System.out.println(&quot;Payment has been successful.&quot;);
                } else {
                    System.out.println(&quot;FAIL! Please, check your data.&quot;);
                }
                order.setClosed();
            }
        }
    }
}

</code></pre>
<p>7ã€æ‰§è¡Œç»“æœ</p>
<pre><code>Please, select a product:
1 - Mother board
2 - CPU
3 - HDD
4 - Memory
1
Count: 2
Do you wish to continue selecting products? Y/N: y
Please, select a product:
1 - Mother board
2 - CPU
3 - HDD
4 - Memory
2
Count: 1
Do you wish to continue selecting products? Y/N: n
Please, select a payment method:
1 - PalPay
2 - Credit Card
1
Enter the user's email: user@example.com
Enter the password: qwerty
Wrong email or password!
Enter user email: amanda@ya.com
Enter password: amanda1985
Data verification has been successful.
Pay 6250 units or Continue shopping?  P/C: p
Paying 6250 using PayPal.
Payment has been successful.
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç­–ç•¥æ¨¡å¼]]></title>
        <id>https://q456qq520.github.io/post/ce-lue-mo-shi/</id>
        <link href="https://q456qq520.github.io/post/ce-lue-mo-shi/">
        </link>
        <updated>2022-06-24T03:26:41.000Z</updated>
        <content type="html"><![CDATA[<h2 id="æ„å›¾">æ„å›¾</h2>
<p><strong>ç­–ç•¥æ¨¡å¼</strong>æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½è®©ä½ å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œ å¹¶å°†æ¯ç§ç®—æ³•åˆ†åˆ«æ”¾å…¥ç‹¬ç«‹çš„ç±»ä¸­ï¼Œ ä»¥ä½¿ç®—æ³•çš„å¯¹è±¡èƒ½å¤Ÿç›¸äº’æ›¿æ¢ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://refactoringguru.cn/images/patterns/content/strategy/strategy-2x.png" alt="likecat" loading="lazy"></figure>
<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>ä¸€å¤©ï¼Œ ä½ æ‰“ç®—ä¸ºæ¸¸å®¢ä»¬åˆ›å»ºä¸€æ¬¾å¯¼æ¸¸ç¨‹åºã€‚ è¯¥ç¨‹åºçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æä¾›ç¾è§‚çš„åœ°å›¾ï¼Œ ä»¥å¸®åŠ©ç”¨æˆ·åœ¨ä»»ä½•åŸå¸‚ä¸­å¿«é€Ÿå®šä½ã€‚</p>
<p>ç”¨æˆ·æœŸå¾…çš„ç¨‹åºæ–°åŠŸèƒ½æ˜¯è‡ªåŠ¨è·¯çº¿è§„åˆ’ï¼š ä»–ä»¬å¸Œæœ›è¾“å…¥åœ°å€åå°±èƒ½åœ¨åœ°å›¾ä¸Šçœ‹åˆ°å‰å¾€ç›®çš„åœ°çš„æœ€å¿«è·¯çº¿ã€‚</p>
<p>ç¨‹åºçš„é¦–ä¸ªç‰ˆæœ¬åªèƒ½è§„åˆ’å…¬è·¯è·¯çº¿ã€‚ é©¾è½¦æ—…è¡Œçš„äººä»¬å¯¹æ­¤éå¸¸æ»¡æ„ã€‚ ä½†å¾ˆæ˜¾ç„¶ï¼Œ å¹¶éæ‰€æœ‰äººéƒ½ä¼šåœ¨åº¦å‡æ—¶å¼€è½¦ã€‚ å› æ­¤ä½ åœ¨ä¸‹æ¬¡æ›´æ–°æ—¶æ·»åŠ äº†è§„åˆ’æ­¥è¡Œè·¯çº¿çš„åŠŸèƒ½ã€‚ æ­¤åï¼Œ ä½ åˆæ·»åŠ äº†è§„åˆ’å…¬å…±äº¤é€šè·¯çº¿çš„åŠŸèƒ½ã€‚</p>
<p>è€Œè¿™åªæ˜¯ä¸ªå¼€å§‹ã€‚ ä¸ä¹…åï¼Œ ä½ åˆè¦ä¸ºéª‘è¡Œè€…è§„åˆ’è·¯çº¿ã€‚ åˆè¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œ ä½ åˆè¦ä¸ºæ¸¸è§ˆåŸå¸‚ä¸­çš„æ‰€æœ‰æ™¯ç‚¹è§„åˆ’è·¯çº¿ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://refactoringguru.cn/images/patterns/diagrams/strategy/problem-2x.png" alt="likecat" loading="lazy"></figure>
<p>å¯¼æ¸¸ä»£ç å°†å˜å¾—éå¸¸è‡ƒè‚¿ã€‚</p>
<p>å°½ç®¡ä»å•†ä¸šè§’åº¦æ¥çœ‹ï¼Œ è¿™æ¬¾åº”ç”¨éå¸¸æˆåŠŸï¼Œ ä½†å…¶æŠ€æœ¯éƒ¨åˆ†å´è®©ä½ éå¸¸å¤´ç–¼ï¼š æ¯æ¬¡æ·»åŠ æ–°çš„è·¯çº¿è§„åˆ’ç®—æ³•åï¼Œ å¯¼æ¸¸åº”ç”¨ä¸­ä¸»è¦ç±»çš„ä½“ç§¯å°±ä¼šå¢åŠ ä¸€å€ã€‚ ç»ˆäºåœ¨æŸä¸ªæ—¶å€™ï¼Œ ä½ è§‰å¾—è‡ªå·±æ²¡æ³•ç»§ç»­ç»´æŠ¤è¿™å †ä»£ç äº†ã€‚</p>
<p>æ— è®ºæ˜¯ä¿®å¤ç®€å•ç¼ºé™·è¿˜æ˜¯å¾®è°ƒè¡—é“æƒé‡ï¼Œ å¯¹æŸä¸ªç®—æ³•è¿›è¡Œä»»ä½•ä¿®æ”¹éƒ½ä¼šå½±å“æ•´ä¸ªç±»ï¼Œ ä»è€Œå¢åŠ åœ¨å·²æœ‰æ­£å¸¸è¿è¡Œä»£ç ä¸­å¼•å…¥é”™è¯¯çš„é£é™©ã€‚</p>
<p>æ­¤å¤–ï¼Œ å›¢é˜Ÿåˆä½œå°†å˜å¾—ä½æ•ˆã€‚ å¦‚æœä½ åœ¨åº”ç”¨æˆåŠŸå‘å¸ƒåæ‹›å‹Ÿäº†å›¢é˜Ÿæˆå‘˜ï¼Œ ä»–ä»¬ä¼šæŠ±æ€¨åœ¨åˆå¹¶å†²çªçš„å·¥ä½œä¸ŠèŠ±è´¹äº†å¤ªå¤šæ—¶é—´ã€‚ åœ¨å®ç°æ–°åŠŸèƒ½çš„è¿‡ç¨‹ä¸­ï¼Œ ä½ çš„å›¢é˜Ÿéœ€è¦ä¿®æ”¹åŒä¸€ä¸ªå·¨å¤§çš„ç±»ï¼Œ è¿™æ ·ä»–ä»¬æ‰€ç¼–å†™çš„ä»£ç ç›¸äº’ä¹‹é—´å°±å¯èƒ½ä¼šå‡ºç°å†²çªã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>ç­–ç•¥æ¨¡å¼å»ºè®®æ‰¾å‡ºè´Ÿè´£ç”¨è®¸å¤šä¸åŒæ–¹å¼å®Œæˆç‰¹å®šä»»åŠ¡çš„ç±»ï¼Œ ç„¶åå°†å…¶ä¸­çš„ç®—æ³•æŠ½å–åˆ°ä¸€ç»„è¢«ç§°ä¸ºç­–ç•¥çš„ç‹¬ç«‹ç±»ä¸­ã€‚</p>
<p>åä¸ºä¸Šä¸‹æ–‡çš„åŸå§‹ç±»å¿…é¡»åŒ…å«ä¸€ä¸ªæˆå‘˜å˜é‡æ¥å­˜å‚¨å¯¹äºæ¯ç§ç­–ç•¥çš„å¼•ç”¨ã€‚ ä¸Šä¸‹æ–‡å¹¶ä¸æ‰§è¡Œä»»åŠ¡ï¼Œ è€Œæ˜¯å°†å·¥ä½œå§”æ´¾ç»™å·²è¿æ¥çš„ç­–ç•¥å¯¹è±¡ã€‚</p>
<p>ä¸Šä¸‹æ–‡ä¸è´Ÿè´£é€‰æ‹©ç¬¦åˆä»»åŠ¡éœ€è¦çš„ç®—æ³•â€”â€”å®¢æˆ·ç«¯ä¼šå°†æ‰€éœ€ç­–ç•¥ä¼ é€’ç»™ä¸Šä¸‹æ–‡ã€‚ å®é™…ä¸Šï¼Œ ä¸Šä¸‹æ–‡å¹¶ä¸ååˆ†äº†è§£ç­–ç•¥ï¼Œ å®ƒä¼šé€šè¿‡åŒæ ·çš„é€šç”¨æ¥å£ä¸æ‰€æœ‰ç­–ç•¥è¿›è¡Œäº¤äº’ï¼Œ è€Œè¯¥æ¥å£åªéœ€æš´éœ²ä¸€ä¸ªæ–¹æ³•æ¥è§¦å‘æ‰€é€‰ç­–ç•¥ä¸­å°è£…çš„ç®—æ³•å³å¯ã€‚</p>
<p>å› æ­¤ï¼Œ ä¸Šä¸‹æ–‡å¯ç‹¬ç«‹äºå…·ä½“ç­–ç•¥ã€‚ è¿™æ ·ä½ å°±å¯åœ¨ä¸ä¿®æ”¹ä¸Šä¸‹æ–‡ä»£ç æˆ–å…¶ä»–ç­–ç•¥çš„æƒ…å†µä¸‹æ·»åŠ æ–°ç®—æ³•æˆ–ä¿®æ”¹å·²æœ‰ç®—æ³•äº†ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://refactoringguru.cn/images/patterns/diagrams/strategy/solution-2x.png" alt="likecat" loading="lazy"></figure>
<p>åœ¨å¯¼æ¸¸åº”ç”¨ä¸­ï¼Œ æ¯ä¸ªè·¯çº¿è§„åˆ’ç®—æ³•éƒ½å¯è¢«æŠ½å–åˆ°åªæœ‰ä¸€ä¸ª buildÂ­Routeç”Ÿæˆè·¯çº¿æ–¹æ³•çš„ç‹¬ç«‹ç±»ä¸­ã€‚ è¯¥æ–¹æ³•æ¥æ”¶èµ·ç‚¹å’Œç»ˆç‚¹ä½œä¸ºå‚æ•°ï¼Œ å¹¶è¿”å›è·¯çº¿ä¸­é€”ç‚¹çš„é›†åˆã€‚</p>
<p>å³ä½¿ä¼ é€’ç»™æ¯ä¸ªè·¯å¾„è§„åˆ’ç±»çš„å‚æ•°ä¸€æ¨¡ä¸€æ ·ï¼Œ å…¶æ‰€åˆ›å»ºçš„è·¯çº¿ä¹Ÿå¯èƒ½å®Œå…¨ä¸åŒã€‚ ä¸»è¦å¯¼æ¸¸ç±»çš„ä¸»è¦å·¥ä½œæ˜¯åœ¨åœ°å›¾ä¸Šæ¸²æŸ“ä¸€ç³»åˆ—ä¸­é€”ç‚¹ï¼Œ ä¸ä¼šåœ¨æ„å¦‚ä½•é€‰æ‹©ç®—æ³•ã€‚ è¯¥ç±»ä¸­è¿˜æœ‰ä¸€ä¸ªç”¨äºåˆ‡æ¢å½“å‰è·¯å¾„è§„åˆ’ç­–ç•¥çš„æ–¹æ³•ï¼Œ å› æ­¤å®¢æˆ·ç«¯ ï¼ˆä¾‹å¦‚ç”¨æˆ·ç•Œé¢ä¸­çš„æŒ‰é’®ï¼‰ å¯ç”¨å…¶ä»–ç­–ç•¥æ›¿æ¢å½“å‰é€‰æ‹©çš„è·¯å¾„è§„åˆ’è¡Œä¸ºã€‚</p>
<h2 id="ç­–ç•¥æ¨¡å¼æ¨¡å¼ç»“æ„">ç­–ç•¥æ¨¡å¼æ¨¡å¼ç»“æ„</h2>
<figure data-type="image" tabindex="4"><img src="https://refactoringguru.cn/images/patterns/diagrams/strategy/structure-2x.png" alt="ç­–ç•¥æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<ol>
<li>
<p>**ä¸Šä¸‹æ–‡ ï¼ˆContextï¼‰ ** ç»´æŠ¤æŒ‡å‘å…·ä½“ç­–ç•¥çš„å¼•ç”¨ï¼Œ ä¸”ä»…é€šè¿‡ç­–ç•¥æ¥å£ä¸è¯¥å¯¹è±¡è¿›è¡Œäº¤æµã€‚</p>
</li>
<li>
<p>**ç­–ç•¥ ï¼ˆStrategyï¼‰ ** æ¥å£æ˜¯æ‰€æœ‰å…·ä½“ç­–ç•¥çš„é€šç”¨æ¥å£ï¼Œ å®ƒå£°æ˜äº†ä¸€ä¸ªä¸Šä¸‹æ–‡ç”¨äºæ‰§è¡Œç­–ç•¥çš„æ–¹æ³•ã€‚</p>
</li>
<li>
<p>**å…·ä½“ç­–ç•¥ ï¼ˆConcrete Strategiesï¼‰ ** å®ç°äº†ä¸Šä¸‹æ–‡æ‰€ç”¨ç®—æ³•çš„å„ç§ä¸åŒå˜ä½“ã€‚</p>
</li>
<li>
<p>å½“ä¸Šä¸‹æ–‡éœ€è¦è¿è¡Œç®—æ³•æ—¶ï¼Œ å®ƒä¼šåœ¨å…¶å·²è¿æ¥çš„ç­–ç•¥å¯¹è±¡ä¸Šè°ƒç”¨æ‰§è¡Œæ–¹æ³•ã€‚ ä¸Šä¸‹æ–‡ä¸æ¸…æ¥šå…¶æ‰€æ¶‰åŠçš„ç­–ç•¥ç±»å‹ä¸ç®—æ³•çš„æ‰§è¡Œæ–¹å¼ã€‚</p>
</li>
<li>
<p>**å®¢æˆ·ç«¯ ï¼ˆClientï¼‰ **ä¼šåˆ›å»ºä¸€ä¸ªç‰¹å®šç­–ç•¥å¯¹è±¡å¹¶å°†å…¶ä¼ é€’ç»™ä¸Šä¸‹æ–‡ã€‚ ä¸Šä¸‹æ–‡åˆ™ä¼šæä¾›ä¸€ä¸ªè®¾ç½®å™¨ä»¥ä¾¿å®¢æˆ·ç«¯åœ¨è¿è¡Œæ—¶æ›¿æ¢ç›¸å…³è”çš„ç­–ç•¥ã€‚</p>
</li>
</ol>
<h2 id="ç­–ç•¥æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯">ç­–ç•¥æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯</h2>
<ol>
<li>
<p>å½“ä½ æƒ³ä½¿ç”¨å¯¹è±¡ä¸­å„ç§ä¸åŒçš„ç®—æ³•å˜ä½“ï¼Œ å¹¶å¸Œæœ›èƒ½åœ¨è¿è¡Œæ—¶åˆ‡æ¢ç®—æ³•æ—¶ï¼Œ å¯ä½¿ç”¨ç­–ç•¥æ¨¡å¼ã€‚</p>
<p>ç­–ç•¥æ¨¡å¼è®©ä½ èƒ½å¤Ÿå°†å¯¹è±¡å…³è”è‡³å¯ä»¥ä¸åŒæ–¹å¼æ‰§è¡Œç‰¹å®šå­ä»»åŠ¡çš„ä¸åŒå­å¯¹è±¡ï¼Œ ä»è€Œä»¥é—´æ¥æ–¹å¼åœ¨è¿è¡Œæ—¶æ›´æ”¹å¯¹è±¡è¡Œä¸ºã€‚</p>
</li>
<li>
<p>å½“ä½ æœ‰è®¸å¤šä»…åœ¨æ‰§è¡ŒæŸäº›è¡Œä¸ºæ—¶ç•¥æœ‰ä¸åŒçš„ç›¸ä¼¼ç±»æ—¶ï¼Œ å¯ä½¿ç”¨ç­–ç•¥æ¨¡å¼ã€‚</p>
<p>ç­–ç•¥æ¨¡å¼è®©ä½ èƒ½å°†ä¸åŒè¡Œä¸ºæŠ½å–åˆ°ä¸€ä¸ªç‹¬ç«‹ç±»å±‚æ¬¡ç»“æ„ä¸­ï¼Œ å¹¶å°†åŸå§‹ç±»ç»„åˆæˆåŒä¸€ä¸ªï¼Œ ä»è€Œå‡å°‘é‡å¤ä»£ç ã€‚</p>
</li>
<li>
<p>å¦‚æœç®—æ³•åœ¨ä¸Šä¸‹æ–‡çš„é€»è¾‘ä¸­ä¸æ˜¯ç‰¹åˆ«é‡è¦ï¼Œ ä½¿ç”¨è¯¥æ¨¡å¼èƒ½å°†ç±»çš„ä¸šåŠ¡é€»è¾‘ä¸å…¶ç®—æ³•å®ç°ç»†èŠ‚éš”ç¦»å¼€æ¥ã€‚</p>
<p>ç­–ç•¥æ¨¡å¼è®©ä½ èƒ½å°†å„ç§ç®—æ³•çš„ä»£ç ã€ å†…éƒ¨æ•°æ®å’Œä¾èµ–å…³ç³»ä¸å…¶ä»–ä»£ç éš”ç¦»å¼€æ¥ã€‚ ä¸åŒå®¢æˆ·ç«¯å¯é€šè¿‡ä¸€ä¸ªç®€å•æ¥å£æ‰§è¡Œç®—æ³•ï¼Œ å¹¶èƒ½åœ¨è¿è¡Œæ—¶è¿›è¡Œåˆ‡æ¢ã€‚</p>
</li>
<li>
<p>å½“ç±»ä¸­ä½¿ç”¨äº†å¤æ‚æ¡ä»¶è¿ç®—ç¬¦ä»¥åœ¨åŒä¸€ç®—æ³•çš„ä¸åŒå˜ä½“ä¸­åˆ‡æ¢æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚</p>
<p>ç­–ç•¥æ¨¡å¼å°†æ‰€æœ‰ç»§æ‰¿è‡ªåŒæ ·æ¥å£çš„ç®—æ³•æŠ½å–åˆ°ç‹¬ç«‹ç±»ä¸­ï¼Œ å› æ­¤ä¸å†éœ€è¦æ¡ä»¶è¯­å¥ã€‚ åŸå§‹å¯¹è±¡å¹¶ä¸å®ç°æ‰€æœ‰ç®—æ³•çš„å˜ä½“ï¼Œ è€Œæ˜¯å°†æ‰§è¡Œå·¥ä½œå§”æ´¾ç»™å…¶ä¸­çš„ä¸€ä¸ªç‹¬ç«‹ç®—æ³•å¯¹è±¡ã€‚</p>
</li>
</ol>
<h2 id="å®ç°æ–¹å¼">å®ç°æ–¹å¼</h2>
<ol>
<li>
<p>ä»ä¸Šä¸‹æ–‡ç±»ä¸­æ‰¾å‡ºä¿®æ”¹é¢‘ç‡è¾ƒé«˜çš„ç®—æ³• ï¼ˆä¹Ÿå¯èƒ½æ˜¯ç”¨äºåœ¨è¿è¡Œæ—¶é€‰æ‹©æŸä¸ªç®—æ³•å˜ä½“çš„å¤æ‚æ¡ä»¶è¿ç®—ç¬¦ï¼‰ã€‚</p>
</li>
<li>
<p>å£°æ˜è¯¥ç®—æ³•æ‰€æœ‰å˜ä½“çš„é€šç”¨ç­–ç•¥æ¥å£ã€‚</p>
</li>
<li>
<p>å°†ç®—æ³•é€ä¸€æŠ½å–åˆ°å„è‡ªçš„ç±»ä¸­ï¼Œ å®ƒä»¬éƒ½å¿…é¡»å®ç°ç­–ç•¥æ¥å£ã€‚</p>
</li>
<li>
<p>åœ¨ä¸Šä¸‹æ–‡ç±»ä¸­æ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡ç”¨äºä¿å­˜å¯¹äºç­–ç•¥å¯¹è±¡çš„å¼•ç”¨ã€‚ ç„¶åæä¾›è®¾ç½®å™¨ä»¥ä¿®æ”¹è¯¥æˆå‘˜å˜é‡ã€‚ ä¸Šä¸‹æ–‡ä»…å¯é€šè¿‡ç­–ç•¥æ¥å£åŒç­–ç•¥å¯¹è±¡è¿›è¡Œäº¤äº’ï¼Œ å¦‚æœ‰éœ€è¦è¿˜å¯å®šä¹‰ä¸€ä¸ªæ¥å£æ¥è®©ç­–ç•¥è®¿é—®å…¶æ•°æ®ã€‚</p>
</li>
<li>
<p>å®¢æˆ·ç«¯å¿…é¡»å°†ä¸Šä¸‹æ–‡ç±»ä¸ç›¸åº”ç­–ç•¥è¿›è¡Œå…³è”ï¼Œ ä½¿ä¸Šä¸‹æ–‡å¯ä»¥é¢„æœŸçš„æ–¹å¼å®Œæˆå…¶ä¸»è¦å·¥ä½œã€‚</p>
</li>
</ol>
<h2 id="ç­–ç•¥æ¨¡å¼ä¼˜ç¼ºç‚¹">ç­–ç•¥æ¨¡å¼ä¼˜ç¼ºç‚¹</h2>
<table>
<thead>
<tr>
<th>ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½ å¯ä»¥åœ¨è¿è¡Œæ—¶åˆ‡æ¢å¯¹è±¡å†…çš„ç®—æ³•ã€‚</td>
<td style="text-align:center">å¦‚æœä½ çš„ç®—æ³•æå°‘å‘ç”Ÿæ”¹å˜ï¼Œ é‚£ä¹ˆæ²¡æœ‰ä»»ä½•ç†ç”±å¼•å…¥æ–°çš„ç±»å’Œæ¥å£ã€‚ ä½¿ç”¨è¯¥æ¨¡å¼åªä¼šè®©ç¨‹åºè¿‡äºå¤æ‚ã€‚</td>
</tr>
<tr>
<td>ä½ å¯ä»¥å°†ç®—æ³•çš„å®ç°å’Œä½¿ç”¨ç®—æ³•çš„ä»£ç éš”ç¦»å¼€æ¥ã€‚</td>
<td style="text-align:center">å®¢æˆ·ç«¯å¿…é¡»çŸ¥æ™“ç­–ç•¥é—´çš„ä¸åŒâ€”â€”å®ƒéœ€è¦é€‰æ‹©åˆé€‚çš„ç­–ç•¥ã€‚</td>
</tr>
<tr>
<td>ä½ å¯ä»¥ä½¿ç”¨ç»„åˆæ¥ä»£æ›¿ç»§æ‰¿ã€‚</td>
<td style="text-align:center">è®¸å¤šç°ä»£ç¼–ç¨‹è¯­è¨€æ”¯æŒå‡½æ•°ç±»å‹åŠŸèƒ½ï¼Œ å…è®¸ä½ åœ¨ä¸€ç»„åŒ¿åå‡½æ•°ä¸­å®ç°ä¸åŒç‰ˆæœ¬çš„ç®—æ³•ã€‚ è¿™æ ·ï¼Œ ä½ ä½¿ç”¨è¿™äº›å‡½æ•°çš„æ–¹å¼å°±å’Œä½¿ç”¨ç­–ç•¥å¯¹è±¡æ—¶å®Œå…¨ç›¸åŒï¼Œ æ— éœ€å€ŸåŠ©é¢å¤–çš„ç±»å’Œæ¥å£æ¥ä¿æŒä»£ç ç®€æ´ã€‚</td>
</tr>
<tr>
<td>å¼€é—­åŸåˆ™ã€‚ ä½ æ— éœ€å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œä¿®æ”¹å°±èƒ½å¤Ÿå¼•å…¥æ–°çš„ç­–ç•¥ã€‚</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<h2 id="ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»">ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»</h2>
<ol>
<li>
<p><strong>æ¡¥æ¥æ¨¡å¼</strong>ã€ <strong>çŠ¶æ€æ¨¡å¼</strong>å’Œ<strong>ç­–ç•¥æ¨¡å¼ <strong>ï¼ˆåœ¨æŸç§ç¨‹åº¦ä¸ŠåŒ…æ‹¬é€‚é…å™¨æ¨¡å¼ï¼‰ æ¨¡å¼çš„æ¥å£éå¸¸ç›¸ä¼¼ã€‚ å®é™…ä¸Šï¼Œ å®ƒä»¬éƒ½åŸºäº</strong>ç»„åˆæ¨¡å¼</strong>â€”â€”å³å°†å·¥ä½œå§”æ´¾ç»™å…¶ä»–å¯¹è±¡ï¼Œ ä¸è¿‡ä¹Ÿå„è‡ªè§£å†³äº†ä¸åŒçš„é—®é¢˜ã€‚ æ¨¡å¼å¹¶ä¸åªæ˜¯ä»¥ç‰¹å®šæ–¹å¼ç»„ç»‡ä»£ç çš„é…æ–¹ï¼Œ ä½ è¿˜å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥å’Œå…¶ä»–å¼€å‘è€…è®¨è®ºæ¨¡å¼æ‰€è§£å†³çš„é—®é¢˜ã€‚</p>
</li>
<li>
<p><strong>å‘½ä»¤æ¨¡å¼</strong>å’Œ<strong>ç­–ç•¥</strong>çœ‹ä¸Šå»å¾ˆåƒï¼Œ å› ä¸ºä¸¤è€…éƒ½èƒ½é€šè¿‡æŸäº›è¡Œä¸ºæ¥å‚æ•°åŒ–å¯¹è±¡ã€‚ ä½†æ˜¯ï¼Œ å®ƒä»¬çš„æ„å›¾æœ‰éå¸¸å¤§çš„ä¸åŒã€‚</p>
<p>ä½ å¯ä»¥ä½¿ç”¨å‘½ä»¤æ¥å°†ä»»ä½•æ“ä½œè½¬æ¢ä¸ºå¯¹è±¡ã€‚ æ“ä½œçš„å‚æ•°å°†æˆä¸ºå¯¹è±¡çš„æˆå‘˜å˜é‡ã€‚ ä½ å¯ä»¥é€šè¿‡è½¬æ¢æ¥å»¶è¿Ÿæ“ä½œçš„æ‰§è¡Œã€ å°†æ“ä½œæ”¾å…¥é˜Ÿåˆ—ã€ ä¿å­˜å†å²å‘½ä»¤æˆ–è€…å‘è¿œç¨‹æœåŠ¡å‘é€å‘½ä»¤ç­‰ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œ ç­–ç•¥é€šå¸¸å¯ç”¨äºæè¿°å®ŒæˆæŸä»¶äº‹çš„ä¸åŒæ–¹å¼ï¼Œ è®©ä½ èƒ½å¤Ÿåœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ç±»ä¸­åˆ‡æ¢ç®—æ³•ã€‚</p>
</li>
<li>
<p><strong>è£…é¥°æ¨¡å¼</strong>å¯è®©ä½ æ›´æ”¹å¯¹è±¡çš„å¤–è¡¨ï¼Œ ç­–ç•¥åˆ™è®©ä½ èƒ½å¤Ÿæ”¹å˜å…¶æœ¬è´¨ã€‚</p>
</li>
<li>
<p><strong>æ¨¡æ¿æ–¹æ³•</strong>æ¨¡å¼åŸºäºç»§æ‰¿æœºåˆ¶ï¼š å®ƒå…è®¸ä½ é€šè¿‡æ‰©å±•å­ç±»ä¸­çš„éƒ¨åˆ†å†…å®¹æ¥æ”¹å˜éƒ¨åˆ†ç®—æ³•ã€‚ ç­–ç•¥åŸºäºç»„åˆæœºåˆ¶ï¼š ä½ å¯ä»¥é€šè¿‡å¯¹ç›¸åº”è¡Œä¸ºæä¾›ä¸åŒçš„ç­–ç•¥æ¥æ”¹å˜å¯¹è±¡çš„éƒ¨åˆ†è¡Œä¸ºã€‚ æ¨¡æ¿æ–¹æ³•åœ¨ç±»å±‚æ¬¡ä¸Šè¿ä½œï¼Œ å› æ­¤å®ƒæ˜¯é™æ€çš„ã€‚ ç­–ç•¥åœ¨å¯¹è±¡å±‚æ¬¡ä¸Šè¿ä½œï¼Œ å› æ­¤å…è®¸åœ¨è¿è¡Œæ—¶åˆ‡æ¢è¡Œä¸ºã€‚</p>
</li>
<li>
<p>çŠ¶æ€å¯è¢«è§†ä¸ºç­–ç•¥çš„æ‰©å±•ã€‚ ä¸¤è€…éƒ½åŸºäºç»„åˆæœºåˆ¶ï¼š å®ƒä»¬éƒ½é€šè¿‡å°†éƒ¨åˆ†å·¥ä½œå§”æ´¾ç»™ â€œå¸®æ‰‹â€ å¯¹è±¡æ¥æ”¹å˜å…¶åœ¨ä¸åŒæƒ…æ™¯ä¸‹çš„è¡Œä¸ºã€‚ ç­–ç•¥ä½¿å¾—è¿™äº›å¯¹è±¡ç›¸äº’ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œ å®ƒä»¬ä¸çŸ¥é“å…¶ä»–å¯¹è±¡çš„å­˜åœ¨ã€‚ ä½†çŠ¶æ€æ¨¡å¼æ²¡æœ‰é™åˆ¶å…·ä½“çŠ¶æ€ä¹‹é—´çš„ä¾èµ–ï¼Œ ä¸”å…è®¸å®ƒä»¬è‡ªè¡Œæ”¹å˜åœ¨ä¸åŒæƒ…æ™¯ä¸‹çš„çŠ¶æ€ã€‚</p>
</li>
</ol>
<h2 id="ä¼ªä»£ç ">ä¼ªä»£ç </h2>
<h4 id="ç”µå­å•†åŠ¡åº”ç”¨ä¸­çš„æ”¯ä»˜æ–¹æ³•">ç”µå­å•†åŠ¡åº”ç”¨ä¸­çš„æ”¯ä»˜æ–¹æ³•</h4>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œ ç­–ç•¥æ¨¡å¼è¢«ç”¨äºåœ¨ç”µå­å•†åŠ¡åº”ç”¨ä¸­å®ç°å„ç§æ”¯ä»˜æ–¹æ³•ã€‚ å®¢æˆ·é€‰ä¸­å¸Œæœ›è´­ä¹°çš„å•†å“åéœ€è¦é€‰æ‹©ä¸€ç§æ”¯ä»˜æ–¹å¼ï¼š Paypal æˆ–è€…ä¿¡ç”¨å¡ã€‚</p>
<p>å…·ä½“ç­–ç•¥ä¸ä»…ä¼šå®Œæˆå®é™…çš„æ”¯ä»˜å·¥ä½œï¼Œ è¿˜ä¼šæ”¹å˜æ”¯ä»˜è¡¨å•çš„è¡Œä¸ºï¼Œ å¹¶åœ¨è¡¨å•ä¸­æä¾›ç›¸åº”çš„å­—æ®µæ¥è®°å½•æ”¯ä»˜ä¿¡æ¯ã€‚</p>
<p>1ã€é€šç”¨çš„æ”¯ä»˜æ–¹æ³•æ¥å£</p>
<pre><code>package com.strategies;

/**
 * é€šç”¨çš„æ”¯ä»˜æ–¹æ³•æ¥å£
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:42
 */
public interface PayStrategy {
    boolean pay(int paymentAmount);

    void collectPaymentDetails();
}

</code></pre>
<p>2ã€ä½¿ç”¨ PayPal æ”¯ä»˜</p>
<pre><code>package com.strategies;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.Map;

/**
 * ä½¿ç”¨ PayPal æ”¯ä»˜
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:43
 */
public class PayByPayPal implements PayStrategy {
    private static final Map&lt;String, String&gt; DATA_BASE = new HashMap&lt;&gt;();
    private final BufferedReader READER = new BufferedReader(new InputStreamReader(System.in));
    private String email;
    private String password;
    private boolean signedIn;

    static {
        DATA_BASE.put(&quot;amanda1985&quot;, &quot;amanda@ya.com&quot;);
        DATA_BASE.put(&quot;qwerty&quot;, &quot;john@amazon.eu&quot;);
    }

    /**
     * Collect customer's data.
     */
    @Override
    public void collectPaymentDetails() {
        try {
            while (!signedIn) {
                System.out.print(&quot;Enter the user's email: &quot;);
                email = READER.readLine();
                System.out.print(&quot;Enter the password: &quot;);
                password = READER.readLine();
                if (verify()) {
                    System.out.println(&quot;Data verification has been successful.&quot;);
                } else {
                    System.out.println(&quot;Wrong email or password!&quot;);
                }
            }
        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }

    private boolean verify() {
        setSignedIn(email.equals(DATA_BASE.get(password)));
        return signedIn;
    }

    /**
     * Save customer data for future shopping attempts.
     */
    @Override
    public boolean pay(int paymentAmount) {
        if (signedIn) {
            System.out.println(&quot;Paying &quot; + paymentAmount + &quot; using PayPal.&quot;);
            return true;
        } else {
            return false;
        }
    }

    private void setSignedIn(boolean signedIn) {
        this.signedIn = signedIn;
    }
}

</code></pre>
<p>3ã€ä½¿ç”¨ä¿¡ç”¨å¡æ”¯ä»˜</p>
<pre><code>package com.strategies;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;

/**
 * ä½¿ç”¨ä¿¡ç”¨å¡æ”¯ä»˜
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:46
 */
public class PayByCreditCard implements PayStrategy {
    private final BufferedReader READER = new BufferedReader(new InputStreamReader(System.in));

    private CreditCard card;

    /**
     * Collect credit card data.
     */
    @Override
    public void collectPaymentDetails() {
        try {
            System.out.print(&quot;Enter the card number: &quot;);
            String number = READER.readLine();
            System.out.print(&quot;Enter the card expiration date 'mm/yy': &quot;);
            String date = READER.readLine();
            System.out.print(&quot;Enter the CVV code: &quot;);
            String cvv = READER.readLine();
            card = new CreditCard(number, date, cvv);

            // Validate credit card number...

        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }

    /**
     * After card validation we can charge customer's credit card.
     */
    @Override
    public boolean pay(int paymentAmount) {
        if (cardIsPresent()) {
            System.out.println(&quot;Paying &quot; + paymentAmount + &quot; using Credit Card.&quot;);
            card.setAmount(card.getAmount() - paymentAmount);
            return true;
        } else {
            return false;
        }
    }

    private boolean cardIsPresent() {
        return card != null;
    }
}

</code></pre>
<p>4ã€ä¿¡ç”¨å¡ç±»</p>
<pre><code>package com.strategies;

/**
 * ä¿¡ç”¨å¡ç±»
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:47
 */
public class CreditCard {
    private int amount;
    private String number;
    private String date;
    private String cvv;

    CreditCard(String number, String date, String cvv) {
        this.amount = 100_000;
        this.number = number;
        this.date = date;
        this.cvv = cvv;
    }

    public void setAmount(int amount) {
        this.amount = amount;
    }

    public int getAmount() {
        return amount;
    }
}

</code></pre>
<p>5ã€è®¢å•ç±»</p>
<pre><code>package com.strategies;

/**
 * è®¢å•ç±»
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:48
 */
public class Order {
    private int totalCost = 0;
    private boolean isClosed = false;

    public void processOrder(PayStrategy strategy) {
        strategy.collectPaymentDetails();
        // Here we could collect and store payment data from the strategy.
    }

    public void setTotalCost(int cost) {
        this.totalCost += cost;
    }

    public int getTotalCost() {
        return totalCost;
    }

    public boolean isClosed() {
        return isClosed;
    }

    public void setClosed() {
        isClosed = true;
    }
}

</code></pre>
<p>6ã€å®¢æˆ·ç«¯ä»£ç </p>
<pre><code>package com.strategies;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.Map;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/6/27 10:49
 */
public class Demo {
    private static Map&lt;Integer, Integer&gt; priceOnProducts = new HashMap&lt;&gt;();
    private static BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));
    private static Order order = new Order();
    private static PayStrategy strategy;

    static {
        priceOnProducts.put(1, 2200);
        priceOnProducts.put(2, 1850);
        priceOnProducts.put(3, 1100);
        priceOnProducts.put(4, 890);
    }

    public static void main(String[] args) throws IOException {
        while (!order.isClosed()) {
            int cost;

            String continueChoice;
            do {
                System.out.print(&quot;Please, select a product:&quot; + &quot;\n&quot; +
                        &quot;1 - Mother board&quot; + &quot;\n&quot; +
                        &quot;2 - CPU&quot; + &quot;\n&quot; +
                        &quot;3 - HDD&quot; + &quot;\n&quot; +
                        &quot;4 - Memory&quot; + &quot;\n&quot;);
                int choice = Integer.parseInt(reader.readLine());
                cost = priceOnProducts.get(choice);
                System.out.print(&quot;Count: &quot;);
                int count = Integer.parseInt(reader.readLine());
                order.setTotalCost(cost * count);
                System.out.print(&quot;Do you wish to continue selecting products? Y/N: &quot;);
                continueChoice = reader.readLine();
            } while (continueChoice.equalsIgnoreCase(&quot;Y&quot;));

            if (strategy == null) {
                System.out.println(&quot;Please, select a payment method:&quot; + &quot;\n&quot; +
                        &quot;1 - PalPay&quot; + &quot;\n&quot; +
                        &quot;2 - Credit Card&quot;);
                String paymentMethod = reader.readLine();

                // Client creates different strategies based on input from user,
                // application configuration, etc.
                if (paymentMethod.equals(&quot;1&quot;)) {
                    strategy = new PayByPayPal();
                } else {
                    strategy = new PayByCreditCard();
                }
            }

            // Order object delegates gathering payment data to strategy object,
            // since only strategies know what data they need to process a
            // payment.
            order.processOrder(strategy);

            System.out.print(&quot;Pay &quot; + order.getTotalCost() + &quot; units or Continue shopping? P/C: &quot;);
            String proceed = reader.readLine();
            if (proceed.equalsIgnoreCase(&quot;P&quot;)) {
                // Finally, strategy handles the payment.
                if (strategy.pay(order.getTotalCost())) {
                    System.out.println(&quot;Payment has been successful.&quot;);
                } else {
                    System.out.println(&quot;FAIL! Please, check your data.&quot;);
                }
                order.setClosed();
            }
        }
    }
}

</code></pre>
<p>7ã€æ‰§è¡Œç»“æœ</p>
<pre><code>Please, select a product:
1 - Mother board
2 - CPU
3 - HDD
4 - Memory
1
Count: 2
Do you wish to continue selecting products? Y/N: y
Please, select a product:
1 - Mother board
2 - CPU
3 - HDD
4 - Memory
2
Count: 1
Do you wish to continue selecting products? Y/N: n
Please, select a payment method:
1 - PalPay
2 - Credit Card
1
Enter the user's email: user@example.com
Enter the password: qwerty
Wrong email or password!
Enter user email: amanda@ya.com
Enter password: amanda1985
Data verification has been successful.
Pay 6250 units or Continue shopping?  P/C: p
Paying 6250 using PayPal.
Payment has been successful.
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¤‡å¿˜å½•æ¨¡å¼]]></title>
        <id>https://q456qq520.github.io/post/bei-wang-lu-mo-shi/</id>
        <link href="https://q456qq520.github.io/post/bei-wang-lu-mo-shi/">
        </link>
        <updated>2022-06-17T08:37:14.000Z</updated>
        <content type="html"><![CDATA[<h2 id="æ„å›¾">æ„å›¾</h2>
<p><strong>å¤‡å¿˜å½•æ¨¡å¼</strong>æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸åœ¨ä¸æš´éœ²å¯¹è±¡å®ç°ç»†èŠ‚çš„æƒ…å†µä¸‹ä¿å­˜å’Œæ¢å¤å¯¹è±¡ä¹‹å‰çš„çŠ¶æ€ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://refactoringguru.cn/images/patterns/content/memento/memento-zh-2x.png" alt="likecat" loading="lazy"></figure>
<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>å‡å¦‚ä½ æ­£åœ¨å¼€å‘ä¸€æ¬¾æ–‡å­—ç¼–è¾‘å™¨åº”ç”¨ç¨‹åºã€‚ é™¤äº†ç®€å•çš„æ–‡å­—ç¼–è¾‘åŠŸèƒ½å¤–ï¼Œ ç¼–è¾‘å™¨ä¸­è¿˜è¦æœ‰è®¾ç½®æ–‡æœ¬æ ¼å¼å’Œæ’å…¥å†…åµŒå›¾ç‰‡ç­‰åŠŸèƒ½ã€‚</p>
<p>åæ¥ï¼Œ ä½ å†³å®šè®©ç”¨æˆ·èƒ½æ’¤é”€æ–½åŠ åœ¨æ–‡æœ¬ä¸Šçš„ä»»ä½•æ“ä½œã€‚ è¿™é¡¹åŠŸèƒ½åœ¨è¿‡å»å‡ å¹´é‡Œå˜å¾—ååˆ†æ™®éï¼Œ å› æ­¤ç”¨æˆ·æœŸå¾…ä»»ä½•ç¨‹åºéƒ½æœ‰è¿™é¡¹åŠŸèƒ½ã€‚ ä½ é€‰æ‹©é‡‡ç”¨ç›´æ¥çš„æ–¹å¼æ¥å®ç°è¯¥åŠŸèƒ½ï¼š ç¨‹åºåœ¨æ‰§è¡Œä»»ä½•æ“ä½œå‰ä¼šè®°å½•æ‰€æœ‰çš„å¯¹è±¡çŠ¶æ€ï¼Œ å¹¶å°†å…¶ä¿å­˜ä¸‹æ¥ã€‚ å½“ç”¨æˆ·æ­¤åéœ€è¦æ’¤é”€æŸä¸ªæ“ä½œæ—¶ï¼Œ ç¨‹åºå°†ä»å†å²è®°å½•ä¸­è·å–æœ€è¿‘çš„å¿«ç…§ï¼Œ ç„¶åä½¿ç”¨å®ƒæ¥æ¢å¤æ‰€æœ‰å¯¹è±¡çš„çŠ¶æ€ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://refactoringguru.cn/images/patterns/diagrams/memento/problem1-zh-2x.png" alt="likecat" loading="lazy"></figure>
<p>ç¨‹åºåœ¨æ‰§è¡Œæ“ä½œå‰ä¿å­˜æ‰€æœ‰å¯¹è±¡çš„çŠ¶æ€å¿«ç…§ï¼Œ ç¨åå¯é€šè¿‡å¿«ç…§å°†å¯¹è±¡æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹è¿™äº›çŠ¶æ€å¿«ç…§ã€‚ é¦–å…ˆï¼Œ åˆ°åº•è¯¥å¦‚ä½•ç”Ÿæˆä¸€ä¸ªå¿«ç…§å‘¢ï¼Ÿ å¾ˆå¯èƒ½ä½ ä¼šéœ€è¦éå†å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜å˜é‡å¹¶å°†å…¶æ•°å€¼å¤åˆ¶ä¿å­˜ã€‚ ä½†åªæœ‰å½“å¯¹è±¡å¯¹å…¶å†…å®¹æ²¡æœ‰ä¸¥æ ¼è®¿é—®æƒé™é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œ ä½ æ‰èƒ½ä½¿ç”¨è¯¥æ–¹å¼ã€‚ ä¸è¿‡å¾ˆé—æ†¾ï¼Œ ç»å¤§éƒ¨åˆ†å¯¹è±¡ä¼šä½¿ç”¨ç§æœ‰æˆå‘˜å˜é‡æ¥å­˜å‚¨é‡è¦æ•°æ®ï¼Œ è¿™æ ·åˆ«äººå°±æ— æ³•è½»æ˜“æŸ¥çœ‹å…¶ä¸­çš„å†…å®¹ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æš‚æ—¶å¿½ç•¥è¿™ä¸ªé—®é¢˜ï¼Œ å‡è®¾å¯¹è±¡éƒ½åƒå¬‰çš®å£«ä¸€æ ·ï¼š å–œæ¬¢å¼€æ”¾å¼çš„å…³ç³»å¹¶ä¼šå…¬å¼€å…¶æ‰€æœ‰çŠ¶æ€ã€‚ å°½ç®¡è¿™ç§æ–¹å¼èƒ½å¤Ÿè§£å†³å½“å‰é—®é¢˜ï¼Œ è®©ä½ å¯éšæ—¶ç”Ÿæˆå¯¹è±¡çš„çŠ¶æ€å¿«ç…§ï¼Œ ä½†è¿™ç§æ–¹å¼ä»å­˜åœ¨ä¸€äº›ä¸¥é‡é—®é¢˜ã€‚ æœªæ¥ä½ å¯èƒ½ä¼šæ·»åŠ æˆ–åˆ é™¤ä¸€äº›æˆå‘˜å˜é‡ã€‚ è¿™å¬ä¸Šå»å¾ˆç®€å•ï¼Œ ä½†éœ€è¦å¯¹è´Ÿè´£å¤åˆ¶å—å½±å“å¯¹è±¡çŠ¶æ€çš„ç±»è¿›è¡Œæ›´æ”¹ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://refactoringguru.cn/images/patterns/diagrams/memento/problem2-zh-2x.png" alt="likecat" loading="lazy"></figure>
<p>å¦‚ä½•å¤åˆ¶å¯¹è±¡çš„ç§æœ‰çŠ¶æ€ï¼Ÿ</p>
<p>è¿˜æœ‰æ›´å¤šé—®é¢˜ã€‚ è®©æˆ‘ä»¬æ¥è€ƒè™‘ç¼–è¾‘å™¨ ï¼ˆEditorï¼‰ çŠ¶æ€çš„å®é™… â€œå¿«ç…§â€ï¼Œ å®ƒéœ€è¦åŒ…å«å“ªäº›æ•°æ®ï¼Ÿ è‡³å°‘å¿…é¡»åŒ…å«å®é™…çš„æ–‡æœ¬ã€ å…‰æ ‡åæ ‡å’Œå½“å‰æ»šåŠ¨æ¡ä½ç½®ç­‰ã€‚ ä½ éœ€è¦æ”¶é›†è¿™äº›æ•°æ®å¹¶å°†å…¶æ”¾å…¥ç‰¹å®šå®¹å™¨ä¸­ï¼Œ æ‰èƒ½ç”Ÿæˆå¿«ç…§ã€‚</p>
<p>ä½ å¾ˆå¯èƒ½ä¼šå°†å¤§é‡çš„å®¹å™¨å¯¹è±¡å­˜å‚¨åœ¨å†å²è®°å½•åˆ—è¡¨ä¸­ã€‚ è¿™æ ·ä¸€æ¥ï¼Œ å®¹å™¨æœ€ç»ˆå¤§æ¦‚ç‡ä¼šæˆä¸ºåŒä¸€ä¸ªç±»çš„å¯¹è±¡ã€‚ è¿™ä¸ªç±»ä¸­å‡ ä¹æ²¡æœ‰ä»»ä½•æ–¹æ³•ï¼Œ ä½†æœ‰è®¸å¤šä¸ç¼–è¾‘å™¨çŠ¶æ€ä¸€ä¸€å¯¹åº”çš„æˆå‘˜å˜é‡ã€‚ ä¸ºäº†è®©å…¶ä»–å¯¹è±¡èƒ½ä¿å­˜æˆ–è¯»å–å¿«ç…§ï¼Œ ä½ å¾ˆå¯èƒ½éœ€è¦å°†å¿«ç…§çš„æˆå‘˜å˜é‡è®¾ä¸ºå…¬æœ‰ã€‚ æ— è®ºè¿™äº›çŠ¶æ€æ˜¯å¦ç§æœ‰ï¼Œ å…¶éƒ½å°†æš´éœ²ä¸€åˆ‡ç¼–è¾‘å™¨çŠ¶æ€ã€‚ å…¶ä»–ç±»ä¼šå¯¹å¿«ç…§ç±»çš„æ¯ä¸ªå°æ”¹åŠ¨äº§ç”Ÿä¾èµ–ï¼Œ é™¤éè¿™äº›æ”¹åŠ¨ä»…å­˜åœ¨äºç§æœ‰æˆå‘˜å˜é‡æˆ–æ–¹æ³•ä¸­ï¼Œ è€Œä¸ä¼šå½±å“å¤–éƒ¨ç±»ã€‚</p>
<p>æˆ‘ä»¬ä¼¼ä¹èµ°è¿›äº†ä¸€æ¡æ­»èƒ¡åŒï¼š è¦ä¹ˆä¼šæš´éœ²ç±»çš„æ‰€æœ‰å†…éƒ¨ç»†èŠ‚è€Œä½¿å…¶è¿‡äºè„†å¼±ï¼› è¦ä¹ˆä¼šé™åˆ¶å¯¹å…¶çŠ¶æ€çš„è®¿é—®æƒé™è€Œæ— æ³•ç”Ÿæˆå¿«ç…§ã€‚ é‚£ä¹ˆï¼Œ æˆ‘ä»¬è¿˜æœ‰å…¶ä»–æ–¹å¼æ¥å®ç° â€œæ’¤é”€â€ åŠŸèƒ½å—ï¼Ÿ</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>æˆ‘ä»¬åˆšæ‰é‡åˆ°çš„æ‰€æœ‰é—®é¢˜éƒ½æ˜¯å°è£… â€œç ´æŸâ€ é€ æˆçš„ã€‚ ä¸€äº›å¯¹è±¡è¯•å›¾è¶…å‡ºå…¶èŒè´£èŒƒå›´çš„å·¥ä½œã€‚ ç”±äºåœ¨æ‰§è¡ŒæŸäº›è¡Œä¸ºæ—¶éœ€è¦è·å–æ•°æ®ï¼Œ æ‰€ä»¥å®ƒä»¬ä¾µå…¥äº†å…¶ä»–å¯¹è±¡çš„ç§æœ‰ç©ºé—´ï¼Œ è€Œä¸æ˜¯è®©è¿™äº›å¯¹è±¡æ¥å®Œæˆå®é™…çš„å·¥ä½œã€‚</p>
<p>å¤‡å¿˜å½•æ¨¡å¼å°†åˆ›å»ºçŠ¶æ€å¿«ç…§ ï¼ˆSnapshotï¼‰ çš„å·¥ä½œå§”æ´¾ç»™å®é™…çŠ¶æ€çš„æ‹¥æœ‰è€…åŸå‘å™¨ ï¼ˆOriginatorï¼‰ å¯¹è±¡ã€‚ è¿™æ ·å…¶ä»–å¯¹è±¡å°±ä¸å†éœ€è¦ä» â€œå¤–éƒ¨â€ å¤åˆ¶ç¼–è¾‘å™¨çŠ¶æ€äº†ï¼Œ ç¼–è¾‘å™¨ç±»æ‹¥æœ‰å…¶çŠ¶æ€çš„å®Œå…¨è®¿é—®æƒï¼Œ å› æ­¤å¯ä»¥è‡ªè¡Œç”Ÿæˆå¿«ç…§ã€‚</p>
<p>æ¨¡å¼å»ºè®®å°†å¯¹è±¡çŠ¶æ€çš„å‰¯æœ¬å­˜å‚¨åœ¨ä¸€ä¸ªåä¸ºå¤‡å¿˜å½• ï¼ˆMementoï¼‰ çš„ç‰¹æ®Šå¯¹è±¡ä¸­ã€‚ é™¤äº†åˆ›å»ºå¤‡å¿˜å½•çš„å¯¹è±¡å¤–ï¼Œ ä»»ä½•å¯¹è±¡éƒ½ä¸èƒ½è®¿é—®å¤‡å¿˜å½•çš„å†…å®¹ã€‚ å…¶ä»–å¯¹è±¡å¿…é¡»ä½¿ç”¨å—é™æ¥å£ä¸å¤‡å¿˜å½•è¿›è¡Œäº¤äº’ï¼Œ å®ƒä»¬å¯ä»¥è·å–å¿«ç…§çš„å…ƒæ•°æ® ï¼ˆåˆ›å»ºæ—¶é—´å’Œæ“ä½œåç§°ç­‰ï¼‰ï¼Œ ä½†ä¸èƒ½è·å–å¿«ç…§ä¸­åŸå§‹å¯¹è±¡çš„çŠ¶æ€ã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://refactoringguru.cn/images/patterns/diagrams/memento/solution-zh-2x.png" alt="likecat" loading="lazy"></figure>
<p>åŸå‘å™¨æ‹¥æœ‰å¯¹å¤‡å¿˜å½•çš„å®Œå…¨è®¿é—®æƒé™ï¼Œ è´Ÿè´£äººåˆ™åªèƒ½è®¿é—®å…ƒæ•°æ®ã€‚</p>
<p>è¿™ç§é™åˆ¶ç­–ç•¥å…è®¸ä½ å°†å¤‡å¿˜å½•ä¿å­˜åœ¨é€šå¸¸è¢«ç§°ä¸ºè´Ÿè´£äºº ï¼ˆCaretakersï¼‰ çš„å¯¹è±¡ä¸­ã€‚ ç”±äºè´Ÿè´£äººä»…é€šè¿‡å—é™æ¥å£ä¸å¤‡å¿˜å½•äº’åŠ¨ï¼Œ æ•…å…¶æ— æ³•ä¿®æ”¹å­˜å‚¨åœ¨å¤‡å¿˜å½•å†…éƒ¨çš„çŠ¶æ€ã€‚ åŒæ—¶ï¼Œ åŸå‘å™¨æ‹¥æœ‰å¯¹å¤‡å¿˜å½•æ‰€æœ‰æˆå‘˜çš„è®¿é—®æƒé™ï¼Œ ä»è€Œèƒ½éšæ—¶æ¢å¤å…¶ä»¥å‰çš„çŠ¶æ€ã€‚</p>
<p>åœ¨æ–‡å­—ç¼–è¾‘å™¨çš„ç¤ºä¾‹ä¸­ï¼Œ æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å†å² ï¼ˆHistoryï¼‰ ç±»ä½œä¸ºè´Ÿè´£äººã€‚ ç¼–è¾‘å™¨æ¯æ¬¡æ‰§è¡Œæ“ä½œå‰ï¼Œ å­˜å‚¨åœ¨è´Ÿè´£äººä¸­çš„å¤‡å¿˜å½•æ ˆéƒ½ä¼šç”Ÿé•¿ã€‚ ä½ ç”šè‡³å¯ä»¥åœ¨åº”ç”¨çš„ UI ä¸­æ¸²æŸ“è¯¥æ ˆï¼Œ ä¸ºç”¨æˆ·æ˜¾ç¤ºä¹‹å‰çš„æ“ä½œå†å²ã€‚</p>
<p>å½“ç”¨æˆ·è§¦å‘æ’¤é”€æ“ä½œæ—¶ï¼Œ å†å²ç±»å°†ä»æ ˆä¸­å–å›æœ€è¿‘çš„å¤‡å¿˜å½•ï¼Œ å¹¶å°†å…¶ä¼ é€’ç»™ç¼–è¾‘å™¨ä»¥è¯·æ±‚è¿›è¡Œå›æ»šã€‚ ç”±äºç¼–è¾‘å™¨æ‹¥æœ‰å¯¹å¤‡å¿˜å½•çš„å®Œå…¨è®¿é—®æƒé™ï¼Œ å› æ­¤å®ƒå¯ä»¥ä½¿ç”¨ä»å¤‡å¿˜å½•ä¸­è·å–çš„æ•°å€¼æ¥æ›¿æ¢è‡ªèº«çš„çŠ¶æ€ã€‚</p>
<h2 id="å¤‡å¿˜å½•æ¨¡å¼ç»“æ„">å¤‡å¿˜å½•æ¨¡å¼ç»“æ„</h2>
<h3 id="åŸºäºåµŒå¥—ç±»çš„å®ç°">åŸºäºåµŒå¥—ç±»çš„å®ç°</h3>
<figure data-type="image" tabindex="5"><img src="https://refactoringguru.cn/images/patterns/diagrams/memento/structure1-2x.png" alt="åŸºäºåµŒå¥—ç±»çš„å®ç°" loading="lazy"></figure>
<ol>
<li>
<p><strong>åŸå‘å™¨ ï¼ˆOriginatorï¼‰</strong> ç±»å¯ä»¥ç”Ÿæˆè‡ªèº«çŠ¶æ€çš„å¿«ç…§ï¼Œ ä¹Ÿå¯ä»¥åœ¨éœ€è¦æ—¶é€šè¿‡å¿«ç…§æ¢å¤è‡ªèº«çŠ¶æ€ã€‚</p>
</li>
<li>
<p><strong>å¤‡å¿˜å½• ï¼ˆMementoï¼‰</strong> æ˜¯åŸå‘å™¨çŠ¶æ€å¿«ç…§çš„å€¼å¯¹è±¡ ï¼ˆvalue objectï¼‰ã€‚ é€šå¸¸åšæ³•æ˜¯å°†å¤‡å¿˜å½•è®¾ä¸ºä¸å¯å˜çš„ï¼Œ å¹¶é€šè¿‡æ„é€ å‡½æ•°ä¸€æ¬¡æ€§ä¼ é€’æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>è´Ÿè´£äºº ï¼ˆCaretakerï¼‰</strong> ä»…çŸ¥é“ â€œä½•æ—¶â€ å’Œ â€œä¸ºä½•â€ æ•æ‰åŸå‘å™¨çš„çŠ¶æ€ï¼Œ ä»¥åŠä½•æ—¶æ¢å¤çŠ¶æ€ã€‚</p>
</li>
<li>
<p>åœ¨è¯¥å®ç°æ–¹æ³•ä¸­ï¼Œ å¤‡å¿˜å½•ç±»å°†è¢«åµŒå¥—åœ¨åŸå‘å™¨ä¸­ã€‚ è¿™æ ·åŸå‘å™¨å°±å¯è®¿é—®å¤‡å¿˜å½•çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•ï¼Œ å³ä½¿è¿™äº›æ–¹æ³•è¢«å£°æ˜ä¸ºç§æœ‰ã€‚ å¦ä¸€æ–¹é¢ï¼Œ è´Ÿè´£äººå¯¹äºå¤‡å¿˜å½•çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•çš„è®¿é—®æƒé™éå¸¸æœ‰é™ï¼š å®ƒä»¬åªèƒ½åœ¨æ ˆä¸­ä¿å­˜å¤‡å¿˜å½•ï¼Œ è€Œä¸èƒ½ä¿®æ”¹å…¶çŠ¶æ€ã€‚</p>
</li>
</ol>
<h3 id="å°è£…æ›´åŠ ä¸¥æ ¼çš„å®ç°">å°è£…æ›´åŠ ä¸¥æ ¼çš„å®ç°</h3>
<figure data-type="image" tabindex="6"><img src="https://refactoringguru.cn/images/patterns/diagrams/memento/structure3-2x.png" alt="å°è£…æ›´åŠ ä¸¥æ ¼çš„å®ç°" loading="lazy"></figure>
<ol>
<li>
<p>è¿™ç§å®ç°æ–¹å¼å…è®¸å­˜åœ¨å¤šç§ä¸åŒç±»å‹çš„åŸå‘å™¨å’Œå¤‡å¿˜å½•ã€‚ æ¯ç§åŸå‘å™¨éƒ½å’Œå…¶ç›¸åº”çš„å¤‡å¿˜å½•ç±»è¿›è¡Œäº¤äº’ã€‚ åŸå‘å™¨å’Œå¤‡å¿˜å½•éƒ½ä¸ä¼šå°†å…¶çŠ¶æ€æš´éœ²ç»™å…¶ä»–ç±»ã€‚</p>
</li>
<li>
<p>è´Ÿè´£äººæ­¤æ—¶è¢«æ˜ç¡®ç¦æ­¢ä¿®æ”¹å­˜å‚¨åœ¨å¤‡å¿˜å½•ä¸­çš„çŠ¶æ€ã€‚ ä½†è´Ÿè´£äººç±»å°†ç‹¬ç«‹äºåŸå‘å™¨ï¼Œ å› ä¸ºæ­¤æ—¶æ¢å¤æ–¹æ³•è¢«å®šä¹‰åœ¨äº†å¤‡å¿˜å½•ç±»ä¸­ã€‚</p>
</li>
<li>
<p>æ¯ä¸ªå¤‡å¿˜å½•å°†ä¸åˆ›å»ºäº†è‡ªèº«çš„åŸå‘å™¨è¿æ¥ã€‚ åŸå‘å™¨ä¼šå°†è‡ªå·±åŠçŠ¶æ€ä¼ é€’ç»™å¤‡å¿˜å½•çš„æ„é€ å‡½æ•°ã€‚ ç”±äºè¿™äº›ç±»ä¹‹é—´çš„ç´§å¯†è”ç³»ï¼Œ åªè¦åŸå‘å™¨å®šä¹‰äº†åˆé€‚çš„è®¾ç½®å™¨ ï¼ˆsetterï¼‰ï¼Œ å¤‡å¿˜å½•å°±èƒ½æ¢å¤å…¶çŠ¶æ€ã€‚</p>
</li>
</ol>
<h2 id="å¤‡å¿˜å½•æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯">å¤‡å¿˜å½•æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯</h2>
<ol>
<li>
<p>å½“ä½ éœ€è¦åˆ›å»ºå¯¹è±¡çŠ¶æ€å¿«ç…§æ¥æ¢å¤å…¶ä¹‹å‰çš„çŠ¶æ€æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨å¤‡å¿˜å½•æ¨¡å¼ã€‚</p>
<p>å¤‡å¿˜å½•æ¨¡å¼å…è®¸ä½ å¤åˆ¶å¯¹è±¡ä¸­çš„å…¨éƒ¨çŠ¶æ€ ï¼ˆåŒ…æ‹¬ç§æœ‰æˆå‘˜å˜é‡ï¼‰ï¼Œ å¹¶å°†å…¶ç‹¬ç«‹äºå¯¹è±¡è¿›è¡Œä¿å­˜ã€‚ å°½ç®¡å¤§éƒ¨åˆ†äººå› ä¸º â€œæ’¤é”€â€ è¿™ä¸ªç”¨ä¾‹æ‰è®°å¾—è¯¥æ¨¡å¼ï¼Œ ä½†å…¶å®å®ƒåœ¨å¤„ç†äº‹åŠ¡ ï¼ˆæ¯”å¦‚éœ€è¦åœ¨å‡ºç°é”™è¯¯æ—¶å›æ»šä¸€ä¸ªæ“ä½œï¼‰ çš„è¿‡ç¨‹ä¸­ä¹Ÿå¿…ä¸å¯å°‘ã€‚</p>
</li>
<li>
<p>å½“ç›´æ¥è®¿é—®å¯¹è±¡çš„æˆå‘˜å˜é‡ã€ è·å–å™¨æˆ–è®¾ç½®å™¨å°†å¯¼è‡´å°è£…è¢«çªç ´æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨è¯¥æ¨¡å¼ã€‚</p>
<p>å¤‡å¿˜å½•è®©å¯¹è±¡è‡ªè¡Œè´Ÿè´£åˆ›å»ºå…¶çŠ¶æ€çš„å¿«ç…§ã€‚ ä»»ä½•å…¶ä»–å¯¹è±¡éƒ½ä¸èƒ½è¯»å–å¿«ç…§ï¼Œ è¿™æœ‰æ•ˆåœ°ä¿éšœäº†æ•°æ®çš„å®‰å…¨æ€§ã€‚</p>
</li>
</ol>
<h2 id="å®ç°æ–¹å¼">å®ç°æ–¹å¼</h2>
<ol>
<li>
<p>ç¡®å®šæ‹…ä»»åŸå‘å™¨è§’è‰²çš„ç±»ã€‚ é‡è¦çš„æ˜¯æ˜ç¡®ç¨‹åºä½¿ç”¨çš„ä¸€ä¸ªåŸå‘å™¨ä¸­å¿ƒå¯¹è±¡ï¼Œ è¿˜æ˜¯å¤šä¸ªè¾ƒå°çš„å¯¹è±¡ã€‚</p>
</li>
<li>
<p>åˆ›å»ºå¤‡å¿˜å½•ç±»ã€‚ é€ä¸€å£°æ˜å¯¹åº”æ¯ä¸ªåŸå‘å™¨æˆå‘˜å˜é‡çš„å¤‡å¿˜å½•æˆå‘˜å˜é‡ã€‚</p>
</li>
<li>
<p>å°†å¤‡å¿˜å½•ç±»è®¾ä¸ºä¸å¯å˜ã€‚ å¤‡å¿˜å½•åªèƒ½é€šè¿‡æ„é€ å‡½æ•°ä¸€æ¬¡æ€§æ¥æ”¶æ•°æ®ã€‚ è¯¥ç±»ä¸­ä¸èƒ½åŒ…å«è®¾ç½®å™¨ã€‚</p>
</li>
<li>
<p>å¦‚æœä½ æ‰€ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€æ”¯æŒåµŒå¥—ç±»ï¼Œ åˆ™å¯å°†å¤‡å¿˜å½•åµŒå¥—åœ¨åŸå‘å™¨ä¸­ï¼› å¦‚æœä¸æ”¯æŒï¼Œ é‚£ä¹ˆä½ å¯ä»å¤‡å¿˜å½•ç±»ä¸­æŠ½å–ä¸€ä¸ªç©ºæ¥å£ï¼Œ ç„¶åè®©å…¶ä»–æ‰€æœ‰å¯¹è±¡é€šè¿‡æ¥å£æ¥å¼•ç”¨å¤‡å¿˜å½•ã€‚ ä½ å¯åœ¨è¯¥æ¥å£ä¸­æ·»åŠ ä¸€äº›å…ƒæ•°æ®æ“ä½œï¼Œ ä½†ä¸èƒ½æš´éœ²åŸå‘å™¨çš„çŠ¶æ€ã€‚</p>
</li>
<li>
<p>åœ¨åŸå‘å™¨ä¸­æ·»åŠ ä¸€ä¸ªåˆ›å»ºå¤‡å¿˜å½•çš„æ–¹æ³•ã€‚ åŸå‘å™¨å¿…é¡»é€šè¿‡å¤‡å¿˜å½•æ„é€ å‡½æ•°çš„ä¸€ä¸ªæˆ–å¤šä¸ªå®é™…å‚æ•°æ¥å°†è‡ªèº«çŠ¶æ€ä¼ é€’ç»™å¤‡å¿˜å½•ã€‚</p>
<p>è¯¥æ–¹æ³•è¿”å›ç»“æœçš„ç±»å‹å¿…é¡»æ˜¯ä½ åœ¨ä¸Šä¸€æ­¥ä¸­æŠ½å–çš„æ¥å£ ï¼ˆå¦‚æœä½ å·²ç»æŠ½å–äº†ï¼‰ã€‚ å®é™…ä¸Šï¼Œ åˆ›å»ºå¤‡å¿˜å½•çš„æ–¹æ³•å¿…é¡»ç›´æ¥ä¸å¤‡å¿˜å½•ç±»è¿›è¡Œäº¤äº’ã€‚</p>
</li>
<li>
<p>åœ¨åŸå‘å™¨ç±»ä¸­æ·»åŠ ä¸€ä¸ªç”¨äºæ¢å¤è‡ªèº«çŠ¶æ€çš„æ–¹æ³•ã€‚ è¯¥æ–¹æ³•æ¥å—å¤‡å¿˜å½•å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚ å¦‚æœä½ åœ¨ä¹‹å‰çš„æ­¥éª¤ä¸­æŠ½å–äº†æ¥å£ï¼Œ é‚£ä¹ˆå¯å°†æ¥å£ä½œä¸ºå‚æ•°çš„ç±»å‹ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ ä½ éœ€è¦å°†è¾“å…¥å¯¹è±¡å¼ºåˆ¶è½¬æ¢ä¸ºå¤‡å¿˜å½•ï¼Œ å› ä¸ºåŸå‘å™¨éœ€è¦æ‹¥æœ‰å¯¹è¯¥å¯¹è±¡çš„å®Œå…¨è®¿é—®æƒé™ã€‚</p>
</li>
<li>
<p>æ— è®ºè´Ÿè´£äººæ˜¯å‘½ä»¤å¯¹è±¡ã€ å†å²è®°å½•æˆ–å…¶ä»–å®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼Œ å®ƒéƒ½å¿…é¡»è¦çŸ¥é“ä½•æ—¶å‘åŸå‘å™¨è¯·æ±‚æ–°çš„å¤‡å¿˜å½•ã€ å¦‚ä½•å­˜å‚¨å¤‡å¿˜å½•ä»¥åŠä½•æ—¶ä½¿ç”¨ç‰¹å®šå¤‡å¿˜å½•æ¥å¯¹åŸå‘å™¨è¿›è¡Œæ¢å¤ã€‚</p>
</li>
<li>
<p>è´Ÿè´£äººä¸åŸå‘å™¨ä¹‹é—´çš„è¿æ¥å¯ä»¥ç§»åŠ¨åˆ°å¤‡å¿˜å½•ç±»ä¸­ã€‚ åœ¨æœ¬ä¾‹ä¸­ï¼Œ æ¯ä¸ªå¤‡å¿˜å½•éƒ½å¿…é¡»ä¸åˆ›å»ºè‡ªå·±çš„åŸå‘å™¨ç›¸è¿æ¥ã€‚ æ¢å¤æ–¹æ³•ä¹Ÿå¯ä»¥ç§»åŠ¨åˆ°å¤‡å¿˜å½•ç±»ä¸­ï¼Œ ä½†åªæœ‰å½“å¤‡å¿˜å½•ç±»åµŒå¥—åœ¨åŸå‘å™¨ä¸­ï¼Œ æˆ–è€…åŸå‘å™¨ç±»æä¾›äº†è¶³å¤Ÿå¤šçš„è®¾ç½®å™¨å¹¶å¯å¯¹å…¶çŠ¶æ€è¿›è¡Œé‡å†™æ—¶ï¼Œ è¿™ç§æ–¹å¼æ‰èƒ½å®ç°ã€‚</p>
</li>
</ol>
<h2 id="å¤‡å¿˜å½•æ¨¡å¼ä¼˜ç¼ºç‚¹">å¤‡å¿˜å½•æ¨¡å¼ä¼˜ç¼ºç‚¹</h2>
<table>
<thead>
<tr>
<th>ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½ å¯ä»¥åœ¨ä¸ç ´åå¯¹è±¡å°è£…æƒ…å†µçš„å‰æä¸‹åˆ›å»ºå¯¹è±¡çŠ¶æ€å¿«ç…§ã€‚</td>
<td style="text-align:center">å¦‚æœå®¢æˆ·ç«¯è¿‡äºé¢‘ç¹åœ°åˆ›å»ºå¤‡å¿˜å½•ï¼Œ ç¨‹åºå°†æ¶ˆè€—å¤§é‡å†…å­˜ã€‚</td>
</tr>
<tr>
<td>ä½ å¯ä»¥é€šè¿‡è®©è´Ÿè´£äººç»´æŠ¤åŸå‘å™¨çŠ¶æ€å†å²è®°å½•æ¥ç®€åŒ–åŸå‘å™¨ä»£ç ã€‚</td>
<td style="text-align:center">è´Ÿè´£äººå¿…é¡»å®Œæ•´è·Ÿè¸ªåŸå‘å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œ è¿™æ ·æ‰èƒ½é”€æ¯å¼ƒç”¨çš„å¤‡å¿˜å½•ã€‚</td>
</tr>
<tr>
<td>-</td>
<td style="text-align:center">ç»å¤§éƒ¨åˆ†åŠ¨æ€ç¼–ç¨‹è¯­è¨€ ï¼ˆä¾‹å¦‚ PHPã€ Python å’Œ JavaScriptï¼‰ ä¸èƒ½ç¡®ä¿å¤‡å¿˜å½•ä¸­çš„çŠ¶æ€ä¸è¢«ä¿®æ”¹ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»">ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»</h2>
<ol>
<li>
<p>ä½ å¯ä»¥åŒæ—¶ä½¿ç”¨<strong>å‘½ä»¤æ¨¡å¼</strong>å’Œ<strong>å¤‡å¿˜å½•æ¨¡å¼</strong>æ¥å®ç° â€œæ’¤é”€â€ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ å‘½ä»¤ç”¨äºå¯¹ç›®æ ‡å¯¹è±¡æ‰§è¡Œå„ç§ä¸åŒçš„æ“ä½œï¼Œ å¤‡å¿˜å½•ç”¨æ¥ä¿å­˜ä¸€æ¡å‘½ä»¤æ‰§è¡Œå‰è¯¥å¯¹è±¡çš„çŠ¶æ€ã€‚</p>
</li>
<li>
<p>ä½ å¯ä»¥åŒæ—¶ä½¿ç”¨<strong>å¤‡å¿˜å½•</strong>å’Œ<strong>è¿­ä»£å™¨æ¨¡å¼</strong>æ¥è·å–å½“å‰è¿­ä»£å™¨çš„çŠ¶æ€ï¼Œ å¹¶ä¸”åœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œå›æ»šã€‚</p>
</li>
<li>
<p>æœ‰æ—¶å€™<strong>åŸå‹æ¨¡å¼</strong>å¯ä»¥ä½œä¸º<strong>å¤‡å¿˜å½•</strong>çš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œ å…¶æ¡ä»¶æ˜¯ä½ éœ€è¦åœ¨å†å²è®°å½•ä¸­å­˜å‚¨çš„å¯¹è±¡çš„çŠ¶æ€æ¯”è¾ƒç®€å•ï¼Œ ä¸éœ€è¦é“¾æ¥å…¶ä»–å¤–éƒ¨èµ„æºï¼Œ æˆ–è€…é“¾æ¥å¯ä»¥æ–¹ä¾¿åœ°é‡å»ºã€‚</p>
</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä¸­ä»‹è€…æ¨¡å¼]]></title>
        <id>https://q456qq520.github.io/post/ming-ling-mo-shi/</id>
        <link href="https://q456qq520.github.io/post/ming-ling-mo-shi/">
        </link>
        <updated>2022-06-17T07:29:17.000Z</updated>
        <content type="html"><![CDATA[<h1 id="æ„å›¾">æ„å›¾</h1>
<p><strong>ä¸­ä»‹è€…æ¨¡å¼</strong>æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ èƒ½è®©ä½ å‡å°‘å¯¹è±¡ä¹‹é—´æ··ä¹±æ— åºçš„ä¾èµ–å…³ç³»ã€‚ è¯¥æ¨¡å¼ä¼šé™åˆ¶å¯¹è±¡ä¹‹é—´çš„ç›´æ¥äº¤äº’ï¼Œ è¿«ä½¿å®ƒä»¬é€šè¿‡ä¸€ä¸ªä¸­ä»‹è€…å¯¹è±¡è¿›è¡Œåˆä½œã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://refactoringguru.cn/images/patterns/content/mediator/mediator-2x.png" alt="likecat" loading="lazy"></figure>
<h1 id="é—®é¢˜">é—®é¢˜</h1>
<p>å‡å¦‚ä½ æœ‰ä¸€ä¸ªåˆ›å»ºå’Œä¿®æ”¹å®¢æˆ·èµ„æ–™çš„å¯¹è¯æ¡†ï¼Œ å®ƒç”±å„ç§æ§ä»¶ç»„æˆï¼Œ ä¾‹å¦‚æ–‡æœ¬æ¡† ï¼ˆTextÂ­Fieldï¼‰ã€ å¤é€‰æ¡† ï¼ˆCheckboxï¼‰ å’ŒæŒ‰é’® ï¼ˆButtonï¼‰ ç­‰ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://refactoringguru.cn/images/patterns/diagrams/mediator/problem1-zh-2x.png" alt="ç”¨æˆ·ç•Œé¢ä¸­å„å…ƒç´ é—´çš„å…³ç³»ä¼šéšç¨‹åºå‘å±•è€Œå˜å¾—æ··ä¹±ã€‚" loading="lazy"></figure>
<p>ç”¨æˆ·ç•Œé¢ä¸­å„å…ƒç´ é—´çš„å…³ç³»ä¼šéšç¨‹åºå‘å±•è€Œå˜å¾—æ··ä¹±ã€‚</p>
<p>æŸäº›è¡¨å•å…ƒç´ å¯èƒ½ä¼šç›´æ¥è¿›è¡Œäº’åŠ¨ã€‚ ä¾‹å¦‚ï¼Œ é€‰ä¸­ â€œæˆ‘æœ‰ä¸€åªç‹—â€ å¤é€‰æ¡†åå¯èƒ½ä¼šæ˜¾ç¤ºä¸€ä¸ªéšè—æ–‡æœ¬æ¡†ç”¨äºè¾“å…¥ç‹—ç‹—çš„åå­—ã€‚ å¦ä¸€ä¸ªä¾‹å­æ˜¯æäº¤æŒ‰é’®å¿…é¡»åœ¨ä¿å­˜æ•°æ®å‰æ ¡éªŒæ‰€æœ‰è¾“å…¥å†…å®¹ã€‚</p>
<p>å…ƒç´ é—´å­˜åœ¨è®¸å¤šå…³è”ã€‚ å› æ­¤ï¼Œ å¯¹æŸäº›å…ƒç´ è¿›è¡Œä¿®æ”¹å¯èƒ½ä¼šå½±å“å…¶ä»–å…ƒç´ ã€‚</p>
<p>å¦‚æœç›´æ¥åœ¨è¡¨å•å…ƒç´ ä»£ç ä¸­å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œ ä½ å°†å¾ˆéš¾åœ¨ç¨‹åºå…¶ä»–è¡¨å•ä¸­å¤ç”¨è¿™äº›å…ƒç´ ç±»ã€‚ ä¾‹å¦‚ï¼Œ ç”±äºå¤é€‰æ¡†ç±»ä¸ç‹—ç‹—çš„æ–‡æœ¬æ¡†ç›¸è€¦åˆï¼Œ æ‰€ä»¥å°†æ— æ³•åœ¨å…¶ä»–è¡¨å•ä¸­ä½¿ç”¨å®ƒã€‚ ä½ è¦ä¹ˆä½¿ç”¨æ¸²æŸ“èµ„æ–™è¡¨å•æ—¶ç”¨åˆ°çš„æ‰€æœ‰ç±»ï¼Œ è¦ä¹ˆä¸€ä¸ªéƒ½ä¸ç”¨ã€‚</p>
<h1 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h1>
<p>ä¸­ä»‹è€…æ¨¡å¼å»ºè®®ä½ åœæ­¢ç»„ä»¶ä¹‹é—´çš„ç›´æ¥äº¤æµå¹¶ä½¿å…¶ç›¸äº’ç‹¬ç«‹ã€‚ è¿™äº›ç»„ä»¶å¿…é¡»è°ƒç”¨ç‰¹æ®Šçš„ä¸­ä»‹è€…å¯¹è±¡ï¼Œ é€šè¿‡ä¸­ä»‹è€…å¯¹è±¡é‡å®šå‘è°ƒç”¨è¡Œä¸ºï¼Œ ä»¥é—´æ¥çš„æ–¹å¼è¿›è¡Œåˆä½œã€‚ æœ€ç»ˆï¼Œ ç»„ä»¶ä»…ä¾èµ–äºä¸€ä¸ªä¸­ä»‹è€…ç±»ï¼Œ æ— éœ€ä¸å¤šä¸ªå…¶ä»–ç»„ä»¶ç›¸è€¦åˆã€‚</p>
<p>åœ¨èµ„æ–™ç¼–è¾‘è¡¨å•çš„ä¾‹å­ä¸­ï¼Œ å¯¹è¯æ¡† ï¼ˆDialogï¼‰ ç±»æœ¬èº«å°†ä½œä¸ºä¸­ä»‹è€…ï¼Œ å…¶å¾ˆå¯èƒ½å·²çŸ¥è‡ªå·±æ‰€æœ‰çš„å­å…ƒç´ ï¼Œ å› æ­¤ä½ ç”šè‡³æ— éœ€åœ¨è¯¥ç±»ä¸­å¼•å…¥æ–°çš„ä¾èµ–å…³ç³»ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://refactoringguru.cn/images/patterns/diagrams/mediator/solution1-zh-2x.png" alt="UI å…ƒç´ å¿…é¡»é€šè¿‡ä¸­ä»‹è€…å¯¹è±¡è¿›è¡Œé—´æ¥æ²Ÿé€š" loading="lazy"></figure>
<p>UI å…ƒç´ å¿…é¡»é€šè¿‡ä¸­ä»‹è€…å¯¹è±¡è¿›è¡Œé—´æ¥æ²Ÿé€šã€‚</p>
<p>ç»å¤§éƒ¨åˆ†é‡è¦çš„ä¿®æ”¹éƒ½åœ¨å®é™…è¡¨å•å…ƒç´ ä¸­è¿›è¡Œã€‚ è®©æˆ‘ä»¬æƒ³æƒ³æäº¤æŒ‰é’®ã€‚ ä¹‹å‰ï¼Œ å½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œ å®ƒå¿…é¡»å¯¹æ‰€æœ‰è¡¨å•å…ƒç´ æ•°å€¼è¿›è¡Œæ ¡éªŒã€‚ è€Œç°åœ¨å®ƒçš„å”¯ä¸€å·¥ä½œæ˜¯å°†ç‚¹å‡»äº‹ä»¶é€šçŸ¥ç»™å¯¹è¯æ¡†ã€‚ æ”¶åˆ°é€šçŸ¥åï¼Œ å¯¹è¯æ¡†å¯ä»¥è‡ªè¡Œæ ¡éªŒæ•°å€¼æˆ–å°†ä»»åŠ¡å§”æ´¾ç»™å„å…ƒç´ ã€‚ è¿™æ ·ä¸€æ¥ï¼Œ æŒ‰é’®ä¸å†ä¸å¤šä¸ªè¡¨å•å…ƒç´ ç›¸å…³è”ï¼Œ è€Œä»…ä¾èµ–äºå¯¹è¯æ¡†ç±»ã€‚</p>
<p>ä½ è¿˜å¯ä»¥ä¸ºæ‰€æœ‰ç±»å‹çš„å¯¹è¯æ¡†æŠ½å–é€šç”¨æ¥å£ï¼Œ è¿›ä¸€æ­¥å‰Šå¼±å…¶ä¾èµ–æ€§ã€‚ æ¥å£ä¸­å°†å£°æ˜ä¸€ä¸ªæ‰€æœ‰è¡¨å•å…ƒç´ éƒ½èƒ½ä½¿ç”¨çš„é€šçŸ¥æ–¹æ³•ï¼Œ å¯ç”¨äºå°†å…ƒç´ ä¸­å‘ç”Ÿçš„äº‹ä»¶é€šçŸ¥ç»™å¯¹è¯æ¡†ã€‚ è¿™æ ·ä¸€æ¥ï¼Œ æ‰€æœ‰å®ç°äº†è¯¥æ¥å£çš„å¯¹è¯æ¡†éƒ½èƒ½ä½¿ç”¨è¿™ä¸ªæäº¤æŒ‰é’®äº†ã€‚</p>
<p>é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œ ä¸­ä»‹è€…æ¨¡å¼è®©ä½ èƒ½åœ¨å•ä¸ªä¸­ä»‹è€…å¯¹è±¡ä¸­å°è£…å¤šä¸ªå¯¹è±¡é—´çš„å¤æ‚å…³ç³»ç½‘ã€‚ ç±»æ‰€æ‹¥æœ‰çš„ä¾èµ–å…³ç³»è¶Šå°‘ï¼Œ å°±è¶Šæ˜“äºä¿®æ”¹ã€ æ‰©å±•æˆ–å¤ç”¨ã€‚</p>
<h1 id="çœŸå®ä¸–ç•Œç±»æ¯”">çœŸå®ä¸–ç•Œç±»æ¯”</h1>
<figure data-type="image" tabindex="4"><img src="https://refactoringguru.cn/images/patterns/diagrams/mediator/live-example-2x.png" alt="likecat" loading="lazy"></figure>
<p>é£è¡Œå™¨é©¾é©¶å‘˜ä¹‹é—´ä¸ä¼šé€šè¿‡ç›¸äº’æ²Ÿé€šæ¥å†³å®šä¸‹ä¸€æ¶é™è½çš„é£æœºã€‚ æ‰€æœ‰æ²Ÿé€šéƒ½é€šè¿‡æ§åˆ¶å¡”å°è¿›è¡Œã€‚</p>
<p>é£è¡Œå™¨é©¾é©¶å‘˜ä»¬åœ¨é è¿‘æˆ–ç¦»å¼€ç©ºä¸­ç®¡åˆ¶åŒºåŸŸæ—¶ä¸ä¼šç›´æ¥ç›¸äº’äº¤æµã€‚ ä½†ä»–ä»¬ä¼šä¸é£æœºè·‘é“é™„è¿‘ï¼Œ å¡”å°ä¸­çš„ç©ºç®¡å‘˜é€šè¯ã€‚ å¦‚æœæ²¡æœ‰ç©ºç®¡å‘˜ï¼Œ é©¾é©¶å‘˜å°±éœ€è¦ç•™æ„æœºåœºé™„è¿‘çš„æ‰€æœ‰é£æœºï¼Œ å¹¶ä¸æ•°åä½é£è¡Œå‘˜ç»„æˆçš„å§”å‘˜ä¼šè®¨è®ºé™è½é¡ºåºã€‚ é‚£ææ€•ä¼šè®©é£æœºå æ¯çš„ç»Ÿè®¡æ•°æ®ä¸€é£å†²å¤©å§ã€‚</p>
<p>å¡”å°æ— éœ€ç®¡åˆ¶é£è¡Œå…¨ç¨‹ï¼Œ åªéœ€åœ¨èˆªç«™åŒºåŠ å¼ºç®¡æ§å³å¯ï¼Œ å› ä¸ºè¯¥åŒºåŸŸçš„å†³ç­–å‚ä¸è€…æ•°é‡å¯¹äºé£è¡Œå‘˜æ¥è¯´å®åœ¨å¤ªå¤šäº†ã€‚</p>
<h1 id="ä¸­ä»‹è€…æ¨¡å¼ç»“æ„">ä¸­ä»‹è€…æ¨¡å¼ç»“æ„</h1>
<figure data-type="image" tabindex="5"><img src="https://refactoringguru.cn/images/patterns/diagrams/mediator/structure-2x.png" alt="likecat" loading="lazy"></figure>
<ol>
<li>
<p><strong>ç»„ä»¶ ï¼ˆComponentï¼‰</strong> æ˜¯å„ç§åŒ…å«ä¸šåŠ¡é€»è¾‘çš„ç±»ã€‚ æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘ä¸­ä»‹è€…çš„å¼•ç”¨ï¼Œ è¯¥å¼•ç”¨è¢«å£°æ˜ä¸ºä¸­ä»‹è€…æ¥å£ç±»å‹ã€‚ ç»„ä»¶ä¸çŸ¥é“ä¸­ä»‹è€…å®é™…æ‰€å±çš„ç±»ï¼Œ å› æ­¤ä½ å¯é€šè¿‡å°†å…¶è¿æ¥åˆ°ä¸åŒçš„ä¸­ä»‹è€…ä»¥ä½¿å…¶èƒ½åœ¨å…¶ä»–ç¨‹åºä¸­å¤ç”¨ã€‚</p>
</li>
<li>
<p>**ä¸­ä»‹è€… ï¼ˆMediatorï¼‰ ** æ¥å£å£°æ˜äº†ä¸ç»„ä»¶äº¤æµçš„æ–¹æ³•ï¼Œ ä½†é€šå¸¸ä»…åŒ…æ‹¬ä¸€ä¸ªé€šçŸ¥æ–¹æ³•ã€‚ ç»„ä»¶å¯å°†ä»»æ„ä¸Šä¸‹æ–‡ ï¼ˆåŒ…æ‹¬è‡ªå·±çš„å¯¹è±¡ï¼‰ ä½œä¸ºè¯¥æ–¹æ³•çš„å‚æ•°ï¼Œ åªæœ‰è¿™æ ·æ¥æ”¶ç»„ä»¶å’Œå‘é€è€…ç±»ä¹‹é—´æ‰ä¸ä¼šè€¦åˆã€‚</p>
</li>
<li>
<p><strong>å…·ä½“ä¸­ä»‹è€… ï¼ˆConcrete Mediatorï¼‰</strong> å°è£…äº†å¤šç§ç»„ä»¶é—´çš„å…³ç³»ã€‚ å…·ä½“ä¸­ä»‹è€…é€šå¸¸ä¼šä¿å­˜æ‰€æœ‰ç»„ä»¶çš„å¼•ç”¨å¹¶å¯¹å…¶è¿›è¡Œç®¡ç†ï¼Œ ç”šè‡³æœ‰æ—¶ä¼šå¯¹å…¶ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ã€‚</p>
</li>
<li>
<p>ç»„ä»¶å¹¶ä¸çŸ¥é“å…¶ä»–ç»„ä»¶çš„æƒ…å†µã€‚ å¦‚æœç»„ä»¶å†…å‘ç”Ÿäº†é‡è¦äº‹ä»¶ï¼Œ å®ƒåªèƒ½é€šçŸ¥ä¸­ä»‹è€…ã€‚ ä¸­ä»‹è€…æ”¶åˆ°é€šçŸ¥åèƒ½è½»æ˜“åœ°ç¡®å®šå‘é€è€…ï¼Œ è¿™æˆ–è®¸å·²è¶³ä»¥åˆ¤æ–­æ¥ä¸‹æ¥éœ€è¦è§¦å‘çš„ç»„ä»¶äº†ã€‚</p>
</li>
</ol>
<p>å¯¹äºç»„ä»¶æ¥è¯´ï¼Œ ä¸­ä»‹è€…çœ‹ä¸Šå»å®Œå…¨å°±æ˜¯ä¸€ä¸ªé»‘ç®±ã€‚ å‘é€è€…ä¸çŸ¥é“æœ€ç»ˆä¼šç”±è°æ¥å¤„ç†è‡ªå·±çš„è¯·æ±‚ï¼Œ æ¥æ”¶è€…ä¹Ÿä¸çŸ¥é“æœ€åˆæ˜¯è°å‘å‡ºäº†è¯·æ±‚ã€‚</p>
<h2 id="ä¸­ä»‹è€…æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯">ä¸­ä»‹è€…æ¨¡å¼é€‚åˆåº”ç”¨åœºæ™¯</h2>
<ol>
<li>
<p>å½“ä¸€äº›å¯¹è±¡å’Œå…¶ä»–å¯¹è±¡ç´§å¯†è€¦åˆä»¥è‡´éš¾ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹æ—¶ï¼Œ å¯ä½¿ç”¨ä¸­ä»‹è€…æ¨¡å¼ã€‚</p>
<p>è¯¥æ¨¡å¼è®©ä½ å°†å¯¹è±¡é—´çš„æ‰€æœ‰å…³ç³»æŠ½å–æˆä¸ºä¸€ä¸ªå•ç‹¬çš„ç±»ï¼Œ ä»¥ä½¿å¯¹äºç‰¹å®šç»„ä»¶çš„ä¿®æ”¹å·¥ä½œç‹¬ç«‹äºå…¶ä»–ç»„ä»¶ã€‚</p>
</li>
<li>
<p>å½“ç»„ä»¶å› è¿‡äºä¾èµ–å…¶ä»–ç»„ä»¶è€Œæ— æ³•åœ¨ä¸åŒåº”ç”¨ä¸­å¤ç”¨æ—¶ï¼Œ å¯ä½¿ç”¨ä¸­ä»‹è€…æ¨¡å¼ã€‚</p>
<p>åº”ç”¨ä¸­ä»‹è€…æ¨¡å¼åï¼Œ æ¯ä¸ªç»„ä»¶ä¸å†çŸ¥æ™“å…¶ä»–ç»„ä»¶çš„æƒ…å†µã€‚ å°½ç®¡è¿™äº›ç»„ä»¶æ— æ³•ç›´æ¥äº¤æµï¼Œ ä½†å®ƒä»¬ä»å¯é€šè¿‡ä¸­ä»‹è€…å¯¹è±¡è¿›è¡Œé—´æ¥äº¤æµã€‚ å¦‚æœä½ å¸Œæœ›åœ¨ä¸åŒåº”ç”¨ä¸­å¤ç”¨ä¸€ä¸ªç»„ä»¶ï¼Œ åˆ™éœ€è¦ä¸ºå…¶æä¾›ä¸€ä¸ªæ–°çš„ä¸­ä»‹è€…ç±»ã€‚</p>
</li>
<li>
<p>å¦‚æœä¸ºäº†èƒ½åœ¨ä¸åŒæƒ…æ™¯ä¸‹å¤ç”¨ä¸€äº›åŸºæœ¬è¡Œä¸ºï¼Œ å¯¼è‡´ä½ éœ€è¦è¢«è¿«åˆ›å»ºå¤§é‡ç»„ä»¶å­ç±»æ—¶ï¼Œ å¯ä½¿ç”¨ä¸­ä»‹è€…æ¨¡å¼ã€‚</p>
<p>ç”±äºæ‰€æœ‰ç»„ä»¶é—´å…³ç³»éƒ½è¢«åŒ…å«åœ¨ä¸­ä»‹è€…ä¸­ï¼Œ å› æ­¤ä½ æ— éœ€ä¿®æ”¹ç»„ä»¶å°±èƒ½æ–¹ä¾¿åœ°æ–°å»ºä¸­ä»‹è€…ç±»ä»¥å®šä¹‰æ–°çš„ç»„ä»¶åˆä½œæ–¹å¼ã€‚</p>
</li>
</ol>
<h1 id="å®ç°æ–¹å¼">å®ç°æ–¹å¼</h1>
<ol>
<li>
<p>æ‰¾åˆ°ä¸€ç»„å½“å‰ç´§å¯†è€¦åˆï¼Œ ä¸”æä¾›å…¶ç‹¬ç«‹æ€§èƒ½å¸¦æ¥æ›´å¤§å¥½å¤„çš„ç±» ï¼ˆä¾‹å¦‚æ›´æ˜“äºç»´æŠ¤æˆ–æ›´æ–¹ä¾¿å¤ç”¨ï¼‰ã€‚</p>
</li>
<li>
<p>å£°æ˜ä¸­ä»‹è€…æ¥å£å¹¶æè¿°ä¸­ä»‹è€…å’Œå„ç§ç»„ä»¶ä¹‹é—´æ‰€éœ€çš„äº¤æµæ¥å£ã€‚ åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ ä¸€ä¸ªæ¥æ”¶ç»„ä»¶é€šçŸ¥çš„æ–¹æ³•å°±è¶³å¤Ÿäº†ã€‚</p>
</li>
</ol>
<p>å¦‚æœä½ å¸Œæœ›åœ¨ä¸åŒæƒ…æ™¯ä¸‹å¤ç”¨ç»„ä»¶ç±»ï¼Œ é‚£ä¹ˆè¯¥æ¥å£å°†éå¸¸é‡è¦ã€‚ åªè¦ç»„ä»¶ä½¿ç”¨é€šç”¨æ¥å£ä¸å…¶ä¸­ä»‹è€…åˆä½œï¼Œ ä½ å°±èƒ½å°†è¯¥ç»„ä»¶ä¸ä¸åŒå®ç°ä¸­çš„ä¸­ä»‹è€…è¿›è¡Œè¿æ¥ã€‚</p>
<ol start="3">
<li>
<p>å®ç°å…·ä½“ä¸­ä»‹è€…ç±»ã€‚ è¯¥ç±»å¯ä»è‡ªè¡Œä¿å­˜å…¶ä¸‹æ‰€æœ‰ç»„ä»¶çš„å¼•ç”¨ä¸­å—ç›Šã€‚</p>
</li>
<li>
<p>ä½ å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œ è®©ä¸­ä»‹è€…è´Ÿè´£ç»„ä»¶å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ã€‚ æ­¤åï¼Œ ä¸­ä»‹è€…å¯èƒ½ä¼šä¸å·¥å‚æˆ–å¤–è§‚ç±»ä¼¼ã€‚</p>
</li>
<li>
<p>ç»„ä»¶å¿…é¡»ä¿å­˜å¯¹äºä¸­ä»‹è€…å¯¹è±¡çš„å¼•ç”¨ã€‚ è¯¥è¿æ¥é€šå¸¸åœ¨ç»„ä»¶çš„æ„é€ å‡½æ•°ä¸­å»ºç«‹ï¼Œ è¯¥å‡½æ•°ä¼šå°†ä¸­ä»‹è€…å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ã€‚</p>
</li>
<li>
<p>ä¿®æ”¹ç»„ä»¶ä»£ç ï¼Œ ä½¿å…¶å¯è°ƒç”¨ä¸­ä»‹è€…çš„é€šçŸ¥æ–¹æ³•ï¼Œ è€Œéå…¶ä»–ç»„ä»¶çš„æ–¹æ³•ã€‚ ç„¶åå°†è°ƒç”¨å…¶ä»–ç»„ä»¶çš„ä»£ç æŠ½å–åˆ°ä¸­ä»‹è€…ç±»ä¸­ï¼Œ å¹¶åœ¨ä¸­ä»‹è€…æ¥æ”¶åˆ°è¯¥ç»„ä»¶é€šçŸ¥æ—¶æ‰§è¡Œè¿™äº›ä»£ç ã€‚</p>
</li>
</ol>
<h1 id="ä¸­ä»‹è€…æ¨¡å¼ä¼˜ç¼ºç‚¹">ä¸­ä»‹è€…æ¨¡å¼ä¼˜ç¼ºç‚¹</h1>
<table>
<thead>
<tr>
<th>ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>å•ä¸€èŒè´£åŸåˆ™ã€‚ ä½ å¯ä»¥å°†å¤šä¸ªç»„ä»¶é—´çš„äº¤æµæŠ½å–åˆ°åŒä¸€ä½ç½®ï¼Œ ä½¿å…¶æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚</td>
<td style="text-align:center">ä¸€æ®µæ—¶é—´åï¼Œ ä¸­ä»‹è€…å¯èƒ½ä¼šæ¼”åŒ–æˆä¸ºä¸Šå¸å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>å¼€é—­åŸåˆ™ã€‚ ä½ æ— éœ€ä¿®æ”¹å®é™…ç»„ä»¶å°±èƒ½å¢åŠ æ–°çš„ä¸­ä»‹è€…ã€‚</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td>ä½ å¯ä»¥å‡è½»åº”ç”¨ä¸­å¤šä¸ªç»„ä»¶é—´çš„è€¦åˆæƒ…å†µã€‚</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td>ä½ å¯ä»¥æ›´æ–¹ä¾¿åœ°å¤ç”¨å„ä¸ªç»„ä»¶ã€‚</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<h1 id="ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»">ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»</h1>
<ol>
<li>
<p><strong>è´£ä»»é“¾æ¨¡å¼</strong>ã€ <strong>å‘½ä»¤æ¨¡å¼</strong>ã€ <strong>ä¸­ä»‹è€…æ¨¡å¼</strong>å’Œ<strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>ç”¨äºå¤„ç†è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„ä¸åŒè¿æ¥æ–¹å¼ï¼š</p>
<ul>
<li>è´£ä»»é“¾æŒ‰ç…§é¡ºåºå°†è¯·æ±‚åŠ¨æ€ä¼ é€’ç»™ä¸€ç³»åˆ—çš„æ½œåœ¨æ¥æ”¶è€…ï¼Œ ç›´è‡³å…¶ä¸­ä¸€åæ¥æ”¶è€…å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚</li>
<li>å‘½ä»¤åœ¨å‘é€è€…å’Œè¯·æ±‚è€…ä¹‹é—´å»ºç«‹å•å‘è¿æ¥ã€‚</li>
<li>ä¸­ä»‹è€…æ¸…é™¤äº†å‘é€è€…å’Œè¯·æ±‚è€…ä¹‹é—´çš„ç›´æ¥è¿æ¥ï¼Œ å¼ºåˆ¶å®ƒä»¬é€šè¿‡ä¸€ä¸ªä¸­ä»‹å¯¹è±¡è¿›è¡Œé—´æ¥æ²Ÿé€šã€‚</li>
<li>è§‚å¯Ÿè€…å…è®¸æ¥æ”¶è€…åŠ¨æ€åœ°è®¢é˜…æˆ–å–æ¶ˆæ¥æ”¶è¯·æ±‚ã€‚</li>
</ul>
</li>
<li>
<p><strong>å¤–è§‚æ¨¡å¼</strong>å’Œ<strong>ä¸­ä»‹è€…</strong>çš„èŒè´£ç±»ä¼¼ï¼š å®ƒä»¬éƒ½å°è¯•åœ¨å¤§é‡ç´§å¯†è€¦åˆçš„ç±»ä¸­ç»„ç»‡èµ·åˆä½œã€‚</p>
<p>å¤–è§‚ä¸ºå­ç³»ç»Ÿä¸­çš„æ‰€æœ‰å¯¹è±¡å®šä¹‰äº†ä¸€ä¸ªç®€å•æ¥å£ï¼Œ ä½†æ˜¯å®ƒä¸æä¾›ä»»ä½•æ–°åŠŸèƒ½ã€‚ å­ç³»ç»Ÿæœ¬èº«ä¸ä¼šæ„è¯†åˆ°å¤–è§‚çš„å­˜åœ¨ã€‚ å­ç³»ç»Ÿä¸­çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›è¡Œäº¤æµã€‚</p>
<p>ä¸­ä»‹è€…å°†ç³»ç»Ÿä¸­ç»„ä»¶çš„æ²Ÿé€šè¡Œä¸ºä¸­å¿ƒåŒ–ã€‚ å„ç»„ä»¶åªçŸ¥é“ä¸­ä»‹è€…å¯¹è±¡ï¼Œ æ— æ³•ç›´æ¥ç›¸äº’äº¤æµã€‚</p>
</li>
<li>
<p><strong>ä¸­ä»‹è€…</strong>å’Œ<strong>è§‚å¯Ÿè€…</strong>ä¹‹é—´çš„åŒºåˆ«å¾€å¾€å¾ˆéš¾è®°ä½ã€‚ åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ ä½ å¯ä»¥ä½¿ç”¨å…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œ è€Œæœ‰æ—¶å¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚ è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p>ä¸­ä»‹è€…çš„ä¸»è¦ç›®æ ‡æ˜¯æ¶ˆé™¤ä¸€ç³»åˆ—ç³»ç»Ÿç»„ä»¶ä¹‹é—´çš„ç›¸äº’ä¾èµ–ã€‚ è¿™äº›ç»„ä»¶å°†ä¾èµ–äºåŒä¸€ä¸ªä¸­ä»‹è€…å¯¹è±¡ã€‚ è§‚å¯Ÿè€…çš„ç›®æ ‡æ˜¯åœ¨å¯¹è±¡ä¹‹é—´å»ºç«‹åŠ¨æ€çš„å•å‘è¿æ¥ï¼Œ ä½¿å¾—éƒ¨åˆ†å¯¹è±¡å¯ä½œä¸ºå…¶ä»–å¯¹è±¡çš„é™„å±å‘æŒ¥ä½œç”¨ã€‚</p>
<p>æœ‰ä¸€ç§æµè¡Œçš„ä¸­ä»‹è€…æ¨¡å¼å®ç°æ–¹å¼ä¾èµ–äºè§‚å¯Ÿè€…ã€‚ ä¸­ä»‹è€…å¯¹è±¡æ‹…å½“å‘å¸ƒè€…çš„è§’è‰²ï¼Œ å…¶ä»–ç»„ä»¶åˆ™ä½œä¸ºè®¢é˜…è€…ï¼Œ å¯ä»¥è®¢é˜…ä¸­ä»‹è€…çš„äº‹ä»¶æˆ–å–æ¶ˆè®¢é˜…ã€‚ å½“ä¸­ä»‹è€…ä»¥è¿™ç§æ–¹å¼å®ç°æ—¶ï¼Œ å®ƒå¯èƒ½çœ‹ä¸Šå»ä¸è§‚å¯Ÿè€…éå¸¸ç›¸ä¼¼ã€‚</p>
<p>å½“ä½ æ„Ÿåˆ°ç–‘æƒ‘æ—¶ï¼Œ è®°ä½å¯ä»¥é‡‡ç”¨å…¶ä»–æ–¹å¼æ¥å®ç°ä¸­ä»‹è€…ã€‚ ä¾‹å¦‚ï¼Œ ä½ å¯æ°¸ä¹…æ€§åœ°å°†æ‰€æœ‰ç»„ä»¶é“¾æ¥åˆ°åŒä¸€ä¸ªä¸­ä»‹è€…å¯¹è±¡ã€‚ è¿™ç§å®ç°æ–¹å¼å’Œè§‚å¯Ÿè€…å¹¶ä¸ç›¸åŒï¼Œ ä½†è¿™ä»æ˜¯ä¸€ç§ä¸­ä»‹è€…æ¨¡å¼ã€‚</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªç¨‹åºï¼Œ å…¶æ‰€æœ‰çš„ç»„ä»¶éƒ½å˜æˆäº†å‘å¸ƒè€…ï¼Œ å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’å»ºç«‹åŠ¨æ€è¿æ¥ã€‚ è¿™æ ·ç¨‹åºä¸­å°±æ²¡æœ‰ä¸­å¿ƒåŒ–çš„ä¸­ä»‹è€…å¯¹è±¡ï¼Œ è€Œåªæœ‰ä¸€äº›åˆ†å¸ƒå¼çš„è§‚å¯Ÿè€…ã€‚</p>
</li>
</ol>
<h1 id="ä¼ªä»£ç ">ä¼ªä»£ç </h1>
<h2 id="ç¬”è®°ç¨‹åº">ç¬”è®°ç¨‹åº</h2>
<p>ä¸­ä»‹è€…æ¨¡å¼åœ¨ Java ä»£ç ä¸­æœ€å¸¸ç”¨äºå¸®åŠ©ç¨‹åº GUI ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ã€‚ åœ¨ MVC æ¨¡å¼ä¸­ï¼Œ æ§åˆ¶å™¨æ˜¯ä¸­ä»‹è€…çš„åŒä¹‰è¯ã€‚</p>
<p>æœ¬ä¾‹å±•ç¤ºäº†å¦‚ä½•å°†è®¸å¤š GUI å…ƒç´ ç»„ç»‡èµ·æ¥ï¼Œ ä½¿å…¶åœ¨ä¸­ä»‹è€…çš„å¸®åŠ©ä¸‹æ— éœ€ç›¸äº’ä¾èµ–å°±èƒ½åˆä½œã€‚</p>
<h3 id="å…¬å…±ç»„ä»¶æ¥å£">å…¬å…±ç»„ä»¶æ¥å£</h3>
<pre><code>package com.components;

/**
 * å…¬å…±ç»„ä»¶æ¥å£
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:10
 */
public interface Component {
    void setMediator(Mediator mediator);
    String getName();
}


</code></pre>
<h3 id="æ–°å¢æŒ‰é’®">æ–°å¢æŒ‰é’®</h3>
<pre><code>package com.components;

import javax.swing.*;
import java.awt.event.ActionEvent;

/**
 * æ–°å¢æŒ‰é’®
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:14
 */
public class AddButton extends JButton implements Component {
    private Mediator mediator;

    public AddButton() {
        super(&quot;Add&quot;);
    }

    @Override
    public void setMediator(Mediator mediator) {
        this.mediator = mediator;
    }

    @Override
    protected void fireActionPerformed(ActionEvent actionEvent) {
        mediator.addNewNote(new Note());
    }

    @Override
    public String getName() {
        return &quot;AddButton&quot;;
    }
}

</code></pre>
<h3 id="åˆ é™¤æŒ‰é’®">åˆ é™¤æŒ‰é’®</h3>
<pre><code>package com.components;

import javax.swing.*;
import java.awt.event.ActionEvent;

/**
 * åˆ é™¤æŒ‰é’®
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:15
 */
public class DeleteButton extends JButton implements Component {
    private Mediator mediator;

    public DeleteButton() {
        super(&quot;Del&quot;);
    }

    @Override
    public void setMediator(Mediator mediator) {
        this.mediator = mediator;
    }

    @Override
    protected void fireActionPerformed(ActionEvent actionEvent) {
        mediator.deleteNote();
    }

    @Override
    public String getName() {
        return &quot;DelButton&quot;;
    }
}

</code></pre>
<h3 id="filter">Filter</h3>
<pre><code>package com.components;

import javax.swing.*;
import java.awt.event.KeyEvent;
import java.util.ArrayList;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:16
 */
public class Filter extends JTextField implements Component {
    private Mediator mediator;
    private ListModel listModel;

    public Filter() {}

    @Override
    public void setMediator(Mediator mediator) {
        this.mediator = mediator;
    }

    @Override
    protected void processComponentKeyEvent(KeyEvent keyEvent) {
        String start = getText();
        searchElements(start);
    }

    public void setList(ListModel listModel) {
        this.listModel = listModel;
    }

    private void searchElements(String s) {
        if (listModel == null) {
            return;
        }

        if (s.equals(&quot;&quot;)) {
            mediator.setElementsList(listModel);
            return;
        }

        ArrayList&lt;Note&gt; notes = new ArrayList&lt;&gt;();
        for (int i = 0; i &lt; listModel.getSize(); i++) {
            notes.add((Note) listModel.getElementAt(i));
        }
        DefaultListModel&lt;Note&gt; listModel = new DefaultListModel&lt;&gt;();
        for (Note note : notes) {
            if (note.getName().contains(s)) {
                listModel.addElement(note);
            }
        }
        mediator.setElementsList(listModel);
    }

    @Override
    public String getName() {
        return &quot;Filter&quot;;
    }
}

</code></pre>
<h3 id="list">List</h3>
<pre><code>package com.components;

import javax.swing.*;

/**
 * Concrete components don't talk with each other. They have only one
 * communication channelâ€“sending requests to the mediator.
 */
@SuppressWarnings(&quot;unchecked&quot;)
public class List extends JList implements Component {
    private Mediator mediator;
    private final DefaultListModel LIST_MODEL;

    public List(DefaultListModel listModel) {
        super(listModel);
        this.LIST_MODEL = listModel;
        setModel(listModel);
        this.setLayoutOrientation(JList.VERTICAL);
        Thread thread = new Thread(new Hide(this));
        thread.start();
    }

    @Override
    public void setMediator(Mediator mediator) {
        this.mediator = mediator;
    }

    public void addElement(Note note) {
        LIST_MODEL.addElement(note);
        int index = LIST_MODEL.size() - 1;
        setSelectedIndex(index);
        ensureIndexIsVisible(index);
        mediator.sendToFilter(LIST_MODEL);
    }

    public void deleteElement() {
        int index = this.getSelectedIndex();
        try {
            LIST_MODEL.remove(index);
            mediator.sendToFilter(LIST_MODEL);
        } catch (ArrayIndexOutOfBoundsException ignored) {}
    }

    public Note getCurrentElement() {
        return (Note)getSelectedValue();
    }

    @Override
    public String getName() {
        return &quot;List&quot;;
    }

    private class Hide implements Runnable {
        private List list;

        Hide(List list) {
            this.list = list;
        }

        @Override
        public void run() {
            while (true) {
                try {
                    Thread.sleep(300);
                } catch (InterruptedException ex) {
                    ex.printStackTrace();
                }
                if (list.isSelectionEmpty()) {
                    mediator.hideElements(true);
                } else {
                    mediator.hideElements(false);
                }
            }
        }
    }
}
</code></pre>
<h3 id="ä¿å­˜æŒ‰é’®">ä¿å­˜æŒ‰é’®</h3>
<pre><code>package com.components;

import javax.swing.*;
import java.awt.event.ActionEvent;

/**
 * ä¿å­˜æŒ‰é’®
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:19
 */
public class SaveButton extends JButton implements Component {
    private Mediator mediator;

    public SaveButton() {
        super(&quot;Save&quot;);
    }

    @Override
    public void setMediator(Mediator mediator) {
        this.mediator = mediator;
    }

    @Override
    protected void fireActionPerformed(ActionEvent actionEvent) {
        mediator.saveChanges();
    }

    @Override
    public String getName() {
        return &quot;SaveButton&quot;;
    }
}

</code></pre>
<h3 id="æ–‡æœ¬æ¡†">æ–‡æœ¬æ¡†</h3>
<pre><code>package com.components;

import javax.swing.*;
import java.awt.event.KeyEvent;

/**
 * æ–‡æœ¬æ¡†
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:20
 */
public class TextBox  extends JTextArea implements Component {
    private Mediator mediator;

    @Override
    public void setMediator(Mediator mediator) {
        this.mediator = mediator;
    }

    @Override
    protected void processComponentKeyEvent(KeyEvent keyEvent) {
        mediator.markNote();
    }

    @Override
    public String getName() {
        return &quot;TextBox&quot;;
    }
}

</code></pre>
<h3 id="æ ‡é¢˜">æ ‡é¢˜</h3>
<pre><code>package com.components;

import javax.swing.*;
import java.awt.event.KeyEvent;

/**
 * æ ‡é¢˜
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:21
 */
public class Title extends JTextField implements Component {
    private Mediator mediator;

    @Override
    public void setMediator(Mediator mediator) {
        this.mediator = mediator;
    }

    @Override
    protected void processComponentKeyEvent(KeyEvent keyEvent) {
        mediator.markNote();
    }

    @Override
    public String getName() {
        return &quot;Title&quot;;
    }
}

</code></pre>
<h3 id="å®šä¹‰é€šç”¨çš„ä¸­ä»‹è€…æ¥å£">å®šä¹‰é€šç”¨çš„ä¸­ä»‹è€…æ¥å£</h3>
<pre><code>package com.components;

import javax.swing.*;

/**
 * å®šä¹‰é€šç”¨çš„ä¸­ä»‹è€…æ¥å£
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:11
 */
public interface Mediator {

    void addNewNote(Note note);
    void deleteNote();
    void getInfoFromList(Note note);
    void saveChanges();
    void markNote();
    void clear();
    void sendToFilter(ListModel listModel);
    void setElementsList(ListModel list);
    void registerComponent(Component component);
    void hideElements(boolean flag);
    void createGUI();
}

</code></pre>
<h3 id="å…·ä½“ä¸­ä»‹è€…">å…·ä½“ä¸­ä»‹è€…</h3>
<pre><code>package com.components;

import javax.swing.*;
import javax.swing.border.LineBorder;
import java.awt.*;

/**
 * å…·ä½“ä¸­ä»‹è€…
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:24
 */
public class Editor implements Mediator {
    private Title title;
    private TextBox textBox;
    private AddButton add;
    private DeleteButton del;
    private SaveButton save;
    private List list;
    private Filter filter;

    private JLabel titleLabel = new JLabel(&quot;Title:&quot;);
    private JLabel textLabel = new JLabel(&quot;Text:&quot;);
    private JLabel label = new JLabel(&quot;Add or select existing note to proceed...&quot;);

    /**
     * Here the registration of components by the mediator.
     */
    @Override
    public void registerComponent(Component component) {
        component.setMediator(this);
        switch (component.getName()) {
            case &quot;AddButton&quot;:
                add = (AddButton)component;
                break;
            case &quot;DelButton&quot;:
                del = (DeleteButton)component;
                break;
            case &quot;Filter&quot;:
                filter = (Filter)component;
                break;
            case &quot;List&quot;:
                list = (List)component;
                this.list.addListSelectionListener(listSelectionEvent -&gt; {
                    Note note = (Note)list.getSelectedValue();
                    if (note != null) {
                        getInfoFromList(note);
                    } else {
                        clear();
                    }
                });
                break;
            case &quot;SaveButton&quot;:
                save = (SaveButton)component;
                break;
            case &quot;TextBox&quot;:
                textBox = (TextBox)component;
                break;
            case &quot;Title&quot;:
                title = (Title)component;
                break;
        }
    }

    /**
     * Various methods to handle requests from particular components.
     */
    @Override
    public void addNewNote(Note note) {
        title.setText(&quot;&quot;);
        textBox.setText(&quot;&quot;);
        list.addElement(note);
    }

    @Override
    public void deleteNote() {
        list.deleteElement();
    }

    @Override
    public void getInfoFromList(Note note) {
        title.setText(note.getName().replace('*', ' '));
        textBox.setText(note.getText());
    }

    @Override
    public void saveChanges() {
        try {
            Note note = (Note) list.getSelectedValue();
            note.setName(title.getText());
            note.setText(textBox.getText());
            list.repaint();
        } catch (NullPointerException ignored) {}
    }

    @Override
    public void markNote() {
        try {
            Note note = list.getCurrentElement();
            String name = note.getName();
            if (!name.endsWith(&quot;*&quot;)) {
                note.setName(note.getName() + &quot;*&quot;);
            }
            list.repaint();
        } catch (NullPointerException ignored) {}
    }

    @Override
    public void clear() {
        title.setText(&quot;&quot;);
        textBox.setText(&quot;&quot;);
    }

    @Override
    public void sendToFilter(ListModel listModel) {
        filter.setList(listModel);
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public void setElementsList(ListModel list) {
        this.list.setModel(list);
        this.list.repaint();
    }

    @Override
    public void hideElements(boolean flag) {
        titleLabel.setVisible(!flag);
        textLabel.setVisible(!flag);
        title.setVisible(!flag);
        textBox.setVisible(!flag);
        save.setVisible(!flag);
        label.setVisible(flag);
    }

    @Override
    public void createGUI() {
        JFrame notes = new JFrame(&quot;Notes&quot;);
        notes.setSize(960, 600);
        notes.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);
        JPanel left = new JPanel();
        left.setBorder(new LineBorder(Color.BLACK));
        left.setSize(320, 600);
        left.setLayout(new BoxLayout(left, BoxLayout.Y_AXIS));
        JPanel filterPanel = new JPanel();
        filterPanel.add(new JLabel(&quot;Filter:&quot;));
        filter.setColumns(20);
        filterPanel.add(filter);
        filterPanel.setPreferredSize(new Dimension(280, 40));
        JPanel listPanel = new JPanel();
        list.setFixedCellWidth(260);
        listPanel.setSize(320, 470);
        JScrollPane scrollPane = new JScrollPane(list);
        scrollPane.setPreferredSize(new Dimension(275, 410));
        listPanel.add(scrollPane);
        JPanel buttonPanel = new JPanel();
        add.setPreferredSize(new Dimension(85, 25));
        buttonPanel.add(add);
        del.setPreferredSize(new Dimension(85, 25));
        buttonPanel.add(del);
        buttonPanel.setLayout(new FlowLayout());
        left.add(filterPanel);
        left.add(listPanel);
        left.add(buttonPanel);
        JPanel right = new JPanel();
        right.setLayout(null);
        right.setSize(640, 600);
        right.setLocation(320, 0);
        right.setBorder(new LineBorder(Color.BLACK));
        titleLabel.setBounds(20, 4, 50, 20);
        title.setBounds(60, 5, 555, 20);
        textLabel.setBounds(20, 4, 50, 130);
        textBox.setBorder(new LineBorder(Color.DARK_GRAY));
        textBox.setBounds(20, 80, 595, 410);
        save.setBounds(270, 535, 80, 25);
        label.setFont(new Font(&quot;Verdana&quot;, Font.PLAIN, 22));
        label.setBounds(100, 240, 500, 100);
        right.add(label);
        right.add(titleLabel);
        right.add(title);
        right.add(textLabel);
        right.add(textBox);
        right.add(save);
        notes.setLayout(null);
        notes.getContentPane().add(left);
        notes.getContentPane().add(right);
        notes.setResizable(false);
        notes.setLocationRelativeTo(null);
        notes.setVisible(true);
    }
}

</code></pre>
<h3 id="ç¬”è®°ç±»">ç¬”è®°ç±»</h3>
<pre><code>package com.components;

/**
 * ç¬”è®°ç±»
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:12
 */
public class Note {
    private String name;
    private String text;

    public Note() {
        name = &quot;New note&quot;;
    }

    public void setName(String name) {
        this.name = name;
    }

    public void setText(String text) {
        this.text = text;
    }

    public String getName() {
        return name;
    }

    public String getText() {
        return text;
    }

    @Override
    public String toString() {
        return name;
    }
}

</code></pre>
<h3 id="å®¢æˆ·ç«¯ä»£ç ">å®¢æˆ·ç«¯ä»£ç </h3>
<pre><code>package com.components;

import javax.swing.*;

/**
 * @author likecat
 * @version 1.0
 * @date 2022/6/17 16:26
 */
public class Demo {
    public static void main(String[] args) {
        Mediator mediator = new Editor();

        mediator.registerComponent(new Title());
        mediator.registerComponent(new TextBox());
        mediator.registerComponent(new AddButton());
        mediator.registerComponent(new DeleteButton());
        mediator.registerComponent(new SaveButton());
        mediator.registerComponent(new List(new DefaultListModel()));
        mediator.registerComponent(new Filter());

        mediator.createGUI();
    }
}

</code></pre>
<h3 id="æ‰§è¡Œç»“æœ">æ‰§è¡Œç»“æœ</h3>
]]></content>
    </entry>
</feed>